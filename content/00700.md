---
title: Tanzu Application Platform 1.1ã§Tektonã®Pipelineã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã†
tags: ["Kubernetes", "Cartographer", "kind", "Tanzu", "TAP", "Tekton"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP"]
---

> â„¹ï¸ 2022-08-15 TAP 1.2ã§ã‚‚åŒã˜ã§ã™ã€‚

[ã“ã¡ã‚‰ã®è¨˜äº‹](/entries/699)ã§TAP 1.1ã®Out of the Box Supply Chain with Testingã‚’è©¦ã—ã¾ã—ãŸã€‚<br>
OOTBã®Supply Chainã§ã¯Tektonã®ãƒ†ã‚¹ãƒˆæ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„ãŸã‚ã€æ¯å›ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ä»Šå›ã¯Supply Chainã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã€Tektonã®Pipelineã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

Tektonã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã¯æ¬¡ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚<br>
https://developers.redhat.com/blog/2020/02/26/speed-up-maven-builds-in-tekton-pipelines#run_a_maven_pipeline

**ç›®æ¬¡**
<!-- toc -->

### ClusterRunTemplateã®æ›´æ–°

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯Tektonã®Pipelineã€PipelineRunãƒªã‚½ãƒ¼ã‚¹ãã‚Œãã‚Œã«workspaceã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚

PipelineRunã¯ootb-templateã®tekton-source-pipelinerunã¨ã„ã†åå‰ã®ClusterRunTemplateã§templateåŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
ã“ã“ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã«ã¯yttã®overlayã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

æ¬¡ã®overlayãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚1 Workloadã«ã¤ãã€1 PVã‚’ä½¿ç”¨ã™ã‚‹æƒ³å®šã§ã™ã€‚PVCã®åå‰ã¯`<workload name>-pipeline-cache`ã«å›ºå®šã—ã¾ã™ã€‚

```yaml
cat <<'EOF' > ootb-templates-cache-workspace.yml 
#@ load("@ytt:overlay", "overlay")
#@overlay/match by=overlay.subset({"metadata":{"name":"tekton-source-pipelinerun"}, "kind": "ClusterRunTemplate"})
---
spec:
  template:
    spec:
      #@overlay/match missing_ok=True
      workspaces:
      - name: cache
        persistentVolumeClaim:
          claimName: $(runnable.metadata.name)$-pipeline-cache
EOF
```

> ğŸ“ Namespaceã«ã¤ã1 PVã‚’ä½œã‚ŠãŸã„å ´åˆã¯`claimName`ã‚’`$(runnable.metadata.namespace)$-pipeline-cache`ã«ã™ã‚Œã°è‰¯ã„ã§ã™ã€‚<br>
> ãŸã ã—ã€ã“ã®å ´åˆã¯ReadWriteManyã«å¯¾å¿œã—ãŸPVã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br>
> kindã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ReadWriteManyã®PVã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚

overlayã‚’Secretã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚

```
kubectl -n tap-install create secret generic ootb-templates-cache-workspace \
  -o yaml \
  --dry-run=client \
  --from-file=ootb-templates-cache-workspace.yml \
  | kubectl apply -f-
```

ä½œæˆã—ãŸoverlayã®Secretåã‚’`tap-values.yml`ã®`package_overlays`ã¸æ¬¡ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```yaml
package_overlays:
# ...
- name: ootb-templates
  secrets:
  - name: ootb-templates-cache-workspace
  # ...
```

å¤‰æ›´ã—ãŸ`tap-values.yml`ã‚’æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§åæ˜ ã—ã¾ã™ã€‚

```
tanzu package installed update -n tap-install tap -f tap-values.yml
```

æ›´æ–°ãŒå®Œäº†ã—ãŸã‚‰æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ClusterRunTemplateãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```yaml
$ kubectl get clusterruntemplate tekton-source-pipelinerun -oyaml
apiVersion: carto.run/v1alpha1
kind: ClusterRunTemplate
metadata:
  annotations:
    kapp.k14s.io/identity: v1;/carto.run/ClusterRunTemplate/tekton-source-pipelinerun;carto.run/v1alpha1
    kapp.k14s.io/original: '{"apiVersion":"carto.run/v1alpha1","kind":"ClusterRunTemplate","metadata":{"labels":{"kapp.k14s.io/app":"1656510239955370900","kapp.k14s.io/association":"v1.72b4cf08dac7ed1e3cac533f6a62ff76"},"name":"tekton-source-pipelinerun"},"spec":{"outputs":{"revision":"spec.params[?(@.name==\"source-revision\")].value","url":"spec.params[?(@.name==\"source-url\")].value"},"template":{"apiVersion":"tekton.dev/v1beta1","kind":"PipelineRun","metadata":{"generateName":"$(runnable.metadata.name)$-","labels":"$(runnable.metadata.labels)$"},"spec":{"params":[{"name":"source-url","value":"$(runnable.spec.inputs.source-url)$"},{"name":"source-revision","value":"$(runnable.spec.inputs.source-revision)$"}],"pipelineRef":{"name":"$(selected.metadata.name)$"},"workspaces":[{"name":"cache","persistentVolumeClaim":{"claimName":"$(runnable.metadata.name)$-pipeline-cache"}}]}}}}'
    kapp.k14s.io/original-diff-md5: c6e94dc94aed3401b5d0f26ed6c0bff3
  creationTimestamp: "2022-06-29T13:44:00Z"
  generation: 2
  labels:
    kapp.k14s.io/app: "1656510239955370900"
    kapp.k14s.io/association: v1.72b4cf08dac7ed1e3cac533f6a62ff76
  name: tekton-source-pipelinerun
  resourceVersion: "329502"
  uid: 54c10f86-3d28-463f-a310-f9262d2825b0
spec:
  outputs:
    revision: spec.params[?(@.name=="source-revision")].value
    url: spec.params[?(@.name=="source-url")].value
  template:
    apiVersion: tekton.dev/v1beta1
    kind: PipelineRun
    metadata:
      generateName: $(runnable.metadata.name)$-
      labels: $(runnable.metadata.labels)$
    spec:
      params:
      - name: source-url
        value: $(runnable.spec.inputs.source-url)$
      - name: source-revision
        value: $(runnable.spec.inputs.source-revision)$
      pipelineRef:
        name: $(selected.metadata.name)$
      workspaces: # <---------------------- Added
      - name: cache
        persistentVolumeClaim:
          claimName: $(runnable.metadata.name)$-pipeline-cache
```

PipelineRunãŒæ›´æ–°ã•ã‚Œã‚‹ã¨ã€ãƒ†ã‚¹ãƒˆãŒè‡ªå‹•ã§å†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
ã¾ã Pipelineã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ãªã„ã®ã§ã€ã“ã®æ®µéšã§ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ãªã„ãƒ†ã‚¹ãƒˆãŒå†ã³å®Ÿæ–½ã•ã‚Œã¾ã™ã€‚

### Pipelineã®æ›´æ–°

æ¬¡ã«[å‰ã®è¨˜äº‹](/entries/699)ã§ä½œæˆã—ãŸhello-servlet workloadã®ãƒ†ã‚¹ãƒˆã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¿½åŠ ã—ã¾ã™ã€‚
æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ã®PVCã‚’ä½œæˆã—ã¾ã™ã€‚PVCã®åå‰ã¯`hello-servlet-pipeline-cache`ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```yaml
cat <<EOF > hello-servlet-pipeline-cache-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: hello-servlet-pipeline-cache
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: "1Gi"
EOF

kubectl apply -f hello-servlet-pipeline-cache-pvc.yaml -n demo
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€Pipelineã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```yaml
cat <<'EOF' > pipeline-maven.yaml
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: maven-test-pipeline
  labels:
    apps.tanzu.vmware.com/pipeline: test
spec:
  params:
  - name: source-url
  - name: source-revision
  workspaces:
  - name: cache
  tasks:
  - name: test
    params:
    - name: source-url
      value: $(params.source-url)
    - name: source-revision
      value: $(params.source-revision)
    workspaces:
    - name: cache
      workspace: cache
    taskSpec:
      params:
      - name: source-url
      - name: source-revision
      workspaces:
      - name: cache
      steps:
      - name: test
        image: eclipse-temurin:17
        script: |-
          set -ex
          rm -rf ~/.m2
          mkdir -p $(workspaces.cache.path)/.m2
          ln -fs $(workspaces.cache.path)/.m2 ~/.m2
          cd `mktemp -d`
          curl -s $(params.source-url) | tar -m -xzvf -
          ./mvnw clean test -V --no-transfer-progress
EOF

kubectl apply -f pipeline-maven.yaml -n demo
```

Pipelineãƒªã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°ã—ã¦ã‚‚ãƒ†ã‚¹ãƒˆã¯å†å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆã‚’å¼·åˆ¶å†å®Ÿè¡Œã™ã‚‹ã«ã¯ã€Pipelineãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

```
kubectl delete pipelinerun -l app.kubernetes.io/part-of=hello-servlet -n demo
```

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¨­å®šã—ãŸç›´å¾Œã®ãƒ†ã‚¹ãƒˆã§ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€ãƒ“ãƒ«ãƒ‰ã«è¦ã™ã‚‹æ™‚é–“ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ã®å ´åˆã¨åŒã˜ã§ã™ã€‚
æ¬¡ã®ä¾‹ã§ã¯ãƒ“ãƒ«ãƒ‰ã«51sã‹ã‹ã£ã¦ã„ã¾ã™ã€‚

```
$ kubectl logs -n demo -l app.kubernetes.io/component=test,app.kubernetes.io/part-of=hello-servlet --tail=-1
...

-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running com.example.hello.HelloServletTest
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.108 sec

Results :

Tests run: 1, Failures: 0, Errors: 0, Skipped: 0

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  51.056 s
[INFO] Finished at: 2022-06-29T17:26:21Z
[INFO] ------------------------------------------------------------------------
```

ã‚‚ã†ä¸€åº¦Pipelineãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã€ãƒ†ã‚¹ãƒˆã‚’å†å®Ÿè¡Œã—ã¾ã™ã€‚

```
kubectl delete pipelinerun -l app.kubernetes.io/part-of=hello-servlet -n demo
```

ä»Šåº¦ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¸Šã«ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã‚‹ãŸã‚ã€ãƒ“ãƒ«ãƒ‰ã¯é€Ÿã„ã§ã™ã€‚
æ¬¡ã®ä¾‹ã§ã¯ãƒ“ãƒ«ãƒ‰ã«3.6sã—ã‹ã‹ã‹ã£ã¦ã„ã¾ã›ã‚“ã€‚

```
$ kubectl logs -n demo -l app.kubernetes.io/component=test,app.kubernetes.io/part-of=hello-servlet --tail=-1
...
-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running com.example.hello.HelloServletTest
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.144 sec

Results :

Tests run: 1, Failures: 0, Errors: 0, Skipped: 0

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  3.652 s
[INFO] Finished at: 2022-06-29T17:27:45Z
[INFO] ------------------------------------------------------------------------
```

Gradleã®å ´åˆã¯æ¬¡ã®Pipelineã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

```yaml
cat <<'EOF' > pipeline-gradle.yaml
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: gradle-test-pipeline
  labels:
    apps.tanzu.vmware.com/pipeline: test
spec:
  params:
  - name: source-url
  - name: source-revision
  workspaces:
  - name: cache
  tasks:
  - name: test
    params:
    - name: source-url
      value: $(params.source-url)
    - name: source-revision
      value: $(params.source-revision)
    workspaces:
    - name: cache
      workspace: cache
    taskSpec:
      params:
      - name: source-url
      - name: source-revision
      workspaces:
      - name: cache
      steps:
      - name: test
        image: eclipse-temurin:17
        script: |-
          set -ex
          rm -rf ~/.gradle
          mkdir -p $(workspaces.cache.path)/.gradle
          ln -fs $(workspaces.cache.path)/.gradle ~/.gradle
          cd `mktemp -d`
          curl -s $(params.source-url) | tar -m -xzvf -
          ./gradlew --no-daemon test
EOF
```

---

TAP 1.1ã®Out of the Box Supply Chain with Testingã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã—ãŸã€‚ã“ã®è¨­å®šã¯workspaceãªã—ã§PVã‚’ä½¿ã‚ãšã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã®ã§ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¿…è¦ãªãƒ†ã‚¹ãƒˆã«ã®ã¿PVã‚’ç”¨æ„ã™ã‚Œã°è‰¯ã„ã§ã™ã€‚
ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå¿…è¦ã§ã™ãŒã€ãƒ†ã‚¹ãƒˆã‚’å¿«é©ã«å®Ÿè¡Œã™ã‚‹ã«ã¯å¿…è¦ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
