---
title: Cloud Foundry on Azureã«Meta Azure Service Brokerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
tags: ["Azure", "BOSH", "Cloud Foundry", "Azure Storage", "Azure Redis Cache", "Azure DocumentDB", "Azure Service Bus", "Azure SQL Database"]
categories: ["Dev", "PaaS", "CloudFoundry"]
---

[å‰ã®è¨˜äº‹](https://blog.ik.am/entries/390)ã«ç¶šã„ã¦ã€Cloud Foundry on Azureã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã€‚
ä»Šåº¦ã¯[Meta Azure Service Broker](https://github.com/Azure/meta-azure-service-broker)ã€‚
ã“ã‚Œã¯æ¬¡ã®Azureã‚µãƒ¼ãƒ“ã‚¹ç¾¤ã«å¯¾ã™ã‚‹Cloud Foundryã®Service Brokerã§ã‚ã‚‹ã€‚

* Azure Storage
* Azure Redis Cache
* Azure DocumentDB
* Azure Service Bus
* Azure SQL Database

ã“ã‚Œã‚‚[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/Azure/meta-azure-service-broker/blob/master/docs/how-admin-deploy-the-broker.md)é€šã‚Šãªã®ã ãŒã€å°‘ã—æ°—åˆãŒå¿…è¦ã€‚ã¾ãšã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—ã€‚ã“ã®è¨˜äº‹åŸ·ç­†æ®µéšã§ã¯[`3916aac`](https://github.com/Azure/meta-azure-service-broker/tree/3916aacec4e6186d2e59730cf8f808feeda576b4)ã€‚

```
git clone https://github.com/Azure/meta-azure-service-broker
cd meta-azure-service-broker
```

### SQL Serveræº–å‚™

Service Brokerã®ãƒ¡ã‚¿æƒ…å ±ä¿å­˜å…ˆã¨ã—ã¦SQL ServerãŒå¿…è¦ã§ã‚ã‚‹ã€‚


https://azure.microsoft.com/ja-jp/documentation/articles/sql-database-get-started/

ã«ã—ãŸãŒã£ã¦ä½œæˆã€‚æ¬¡ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãƒ¡ãƒ¢ã£ã¦ãŠãã€‚

* ã‚µãƒ¼ãƒãƒ¼å
* ãƒ¦ãƒ¼ã‚¶ãƒ¼å
* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

<img width="80%" src="https://qiita-image-store.s3.amazonaws.com/0/1852/148ac4c8-debd-d2fe-c90b-5a79af18969f.png">


`mssql`ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚

```
sudo apt-get install npm nodejs-legacy
sudo npm install -g sql-cli
```

æ¥ç¶šã—ã¦ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«å«ã¾ã‚Œã‚‹`scripts/schema.sql`å®Ÿè¡Œã€‚

``` console
$ mssql --server "xxxx.database.windows.net" --database azure-cf-service-broker --user making@azure-cf-service-broker --pass xxxx --encrypt
sql-cli version 0.4.6
Enter ".help" for usage hints.
mssql> .run scripts/schema.sql
```

### Azure Serviceã®æœ‰åŠ¹åŒ–

`azure provider list`ã§`Registered`ã«ãªã£ã¦ã„ãªã„ã‚µãƒ¼ãƒ“ã‚¹ã‚’æœ‰åŠ¹åŒ–ã€‚

```
azure provider register Microsoft.DocumentDB
azure provider register Microsoft.Cache
azure provider register Microsoft.ServiceBus
azure provider register Microsoft.Sql
azure provider register Microsoft.Storage
```

### DocumentDBã®æº–å‚™

DocumentDBã ã‘ã¯Service Brokerã«ã‚ˆã£ã¦Dynamic Provisionã§ããªã„ã®ã§ã€äº‹å‰ã«ä½œæˆã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹(DocumentDBã®Service Brokerã‚’ä½¿ã„ãŸã„æ™‚ã ã‘)ã€‚

https://azure.microsoft.com/en-us/documentation/articles/documentdb-automation-resource-manager-cli/

ã«ã—ãŸãŒã£ã¦ã€CLIã§ä½œæˆã€‚

```
azure resource create -g azure-cf -n azure-cf-documentdb -r "Microsoft.DocumentDB/databaseAccounts" -o 2015-04-08  -l japaneast -p "{\"databaseAccountOfferType\":\"Standard\"}"
```

æ¥ç¶šæƒ…å ±ã‚’ãƒ¡ãƒ¢ã‚‹ã€‚

<img width="80%" src="https://qiita-image-store.s3.amazonaws.com/0/1852/acbcc880-b14b-c323-7bd7-b62a76713637.png">


### Service Brokerã®ãƒ‡ãƒ—ãƒ­ã‚¤

æ¬¡ã®2ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã€‚

`manifest.yml `

``` yaml
---
applications:
- name: meta-azure-service-broker
  buildpack: https://github.com/cloudfoundry/nodejs-buildpack
  instances: 1
  env:
    ENVIRONMENT: AzureCloud
    SUBSCRIPTION_ID: aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa
    TENANT_ID: bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb
    CLIENT_ID: cccccccc-cccc-cccc-cccc-cccccccccccc
    CLIENT_SECRET: changeme
    DOCDB_HOSTENDPOINT: https://azure-cf-documentdb.documents.azure.com:443/
    DOCDB_MASTERKEY: xxxxxx
```

`config/default.json`

``` json
{
  "apiVersion": "2.8.0",
  "authUser": "admin",
  "authPassword": "password",
  "name": "Meta Azure Service Broker",
  "port": 5001,
  "database": {
    "server": "azure-cf-service-broker.database.windows.net",
    "user": "making@azure-cf-service-broker",
    "password": "xxxx",
    "database": "azure-cf-service-broker"
  }
}
```

Azureã®Service Brokerç”¨ã«`services` Organizationã€`azure` Spaceã‚’ä½œæˆã—ã€`cf push`ã€‚

``` console
cf create-org services
cf target -o services -s azure
cf push
```

Service Brokerã‚’ç™»éŒ²ã€‚

```
cf create-service-broker azure-service-broker admin password  https://meta-azure-service-broker.azurecf.ik.am
```

5ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒç™»éŒ²ã•ã‚Œã€æ§˜ã€…ãªãƒ—ãƒ©ãƒ³ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚

``` console
$ cf service-access
Getting service access as admin...
broker: p-mysql
   service   plan    access   orgs   
   p-mysql   100mb   all         
   p-mysql   1gb     all         

broker: azure-service-broker
   service             plan         access   orgs   
   azure-documentdb    standard     none        
   azure-rediscache    basic        none        
   azure-rediscache    standard     none        
   azure-rediscache    premium      none        
   azure-servicebus    standard     none        
   azure-sqldb         basic        none        
   azure-sqldb         StandardS0   none        
   azure-sqldb         StandardS1   none        
   azure-sqldb         StandardS2   none        
   azure-sqldb         StandardS3   none        
   azure-sqldb         PremiumP1    none        
   azure-sqldb         PremiumP2    none        
   azure-sqldb         PremiumP4    none        
   azure-sqldb         PremiumP6    none        
   azure-sqldb         PremiumP11   none        
   azure-storageblob   standard     none    
```

å…¨éƒ¨æœ‰åŠ¹ã«ã™ã‚‹ã€‚

```
cf enable-service-access azure-documentdb
cf enable-service-access azure-rediscache
cf enable-service-access azure-servicebus
cf enable-service-access azure-sqldb
cf enable-service-access azure-storageblob
```

ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ãƒ¼ã‚¹ã«ç™»éŒ²ã•ã‚ŒãŸğŸ™Œ

``` console
$ cf marketplace
Getting services from marketplace in org services / space azure as admin...
OK

service             plans                                                                                                                     description   
azure-documentdb    standard*                                                                                                                 Azure DocumentDb Service   
azure-rediscache    basic*, standard*, premium*                                                                                               Azure Redis Cache Service   
azure-servicebus    standard*                                                                                                                 Azure Service Bus Service   
azure-sqldb         basic*, StandardS0*, StandardS1*, StandardS2*, StandardS3*, PremiumP1*, PremiumP2*, PremiumP4*, PremiumP6*, PremiumP11*   Azure SQL Database Service   
azure-storageblob   standard*                                                                                                                 Azure Storage Blob Service   
p-mysql             100mb, 1gb                                                                                                                MySQL databases on demand   

* These service plans have an associated cost. Creating a service instance will incur this cost.

TIP:  Use 'cf marketplace -s SERVICE' to view descriptions of individual plans of a given service.
```

### ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ

#### Azure DocumentDB

https://github.com/Azure/meta-azure-service-broker/blob/3916aacec4e6186d2e59730cf8f808feeda576b4/docs/azure-document-db.md

`cf create-service`ã‚’å®Ÿè¡Œæ™‚ã«ã€æ§˜ã€…ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿JSONã§æ¸¡ã™å¿…è¦ãŒã‚ã‚‹ã€‚æ¬¡ã®`azure-documentdb-config.json`ã‚’ä½œæˆã€‚

``` json
{
  "resourceGroup": "my-resource-group-name",
  "docDbName": "mrs",
  "parameters": {
    "location": "japaneast"
  }
}
```

```
cf create-service azure-documentdb standard demo-doc -c azure-documentdb-config.json
```

ã™ã§ã«ä½œæˆæ¸ˆã¿ã®DocumentDBã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¿ãƒ³ã‚¹ã®ä½œæˆã¯æ—©ã„ã€‚

``` console
$ cf services
admin ã¨ã—ã¦çµ„ç¹” default_organization / ã‚¹ãƒšãƒ¼ã‚¹ demo å†…ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’å–å¾—ã—ã¦ã„ã¾ã™...
OK

åå‰        ã‚µãƒ¼ãƒ“ã‚¹           ãƒ—ãƒ©ãƒ³     ãƒã‚¤ãƒ³ãƒ‰æ¸ˆã¿ã‚¢ãƒ—ãƒª   æœ€å¾Œã®æ“ä½œ
demo-doc    azure-documentdb   standard                        create ã¯æˆåŠŸã—ã¾ã—ãŸ
demo-db     p-mysql            100mb      demo-app             create ã¯æˆåŠŸã—ã¾ã—ãŸ
```

ã‚¢ãƒ—ãƒªã«ãƒã‚¤ãƒ³ãƒ‰

```
cf bind-service demo-app demo-db
```


ç’°å¢ƒå¤‰æ•°ã‚’è¦‹ã‚‹ã¨æ¬¡ã®ã‚ˆã†ãª`credentials`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚

``` console
$ cf env demo-app
admin ã¨ã—ã¦çµ„ç¹” default_organization / ã‚¹ãƒšãƒ¼ã‚¹ demo å†…ã®ã‚¢ãƒ—ãƒª demo-app ã®ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—ã—ã¦ã„ã¾ã™...
OK

ã‚·ã‚¹ãƒ†ãƒ æä¾›:
{
 "VCAP_SERVICES": {
  "azure-documentdb": [
   {
    "credentials": {
     "documentdb_database": "demo-app",
     "documentdb_host": "https://azure-cf-documentdb.documents.azure.com:443/",
     "documentdb_key": "xxxx",
     "documentdb_resource_id": "xxxx"
    },
    "label": "azure-documentdb",
    "name": "demo-doc",
    "plan": "standard",
    "provider": null,
    "syslog_drain_url": null,
    "tags": [],
    "volume_mounts": []
   }
  ],
  "p-mysql": [
   {
    "credentials": {
     "hostname": "10.0.50.5",
     "jdbcUrl": "jdbc:mysql://10.0.50.5:3306/xxxx,
     "name": "xxxx",
     "password": "xxxx",
     "port": 3306,
     "uri": "mysql://xxxx:xxxx@10.0.50.5:3306/xxxx",
     "username": "xxxx"
    },
    "label": "p-mysql",
    "name": "demo-db",
    "plan": "100mb",
    "provider": null,
    "syslog_drain_url": null,
    "tags": [
     "mysql"
    ],
    "volume_mounts": []
   }
  ]
 }
}

{
 "VCAP_APPLICATION": {
  "application_id": "cdbdc286-9173-49cb-8ce4-b7baef81b17b",
  "application_name": "demo-app",
  "application_uris": [
   "demo-app.azurecf.ik.am"
  ],
  "application_version": "b0d2da70-be02-4c94-aac5-c334961fa7a7",
  "limits": {
   "disk": 1024,
   "fds": 16384,
   "mem": 512
  },
  "name": "demo-app",
  "space_id": "f7798e39-7ac0-4295-98ee-a66c96e63baf",
  "space_name": "demo",
  "uris": [
   "demo-app.azurecf.ik.am"
  ],
  "users": null,
  "version": "b0d2da70-be02-4c94-aac5-c334961fa7a7"
 }
}

ãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›:
SPRING_DATASOURCE_INITIALIZE: false

å®Ÿè¡Œç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“

ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ä¸­ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“

```

#### Azure Redis Cache

https://github.com/Azure/meta-azure-service-broker/blob/master/docs/azure-redis-cache.md

`cf create-service`ã‚’å®Ÿè¡Œæ™‚ã«ã€æ§˜ã€…ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿JSONã§æ¸¡ã™å¿…è¦ãŒã‚ã‚‹ã€‚æ¬¡ã®`azure-redis-config.json`ã‚’ä½œæˆã€‚

``` json
{
  "resourceGroup": "redisResourceGroup",
  "cacheName": "mrs",
  "parameters": {
    "location": "japaneast",
    "enableNonSslPort": true,
    "sku": {
      "name": "Basic",
      "family": "C",
      "capacity": 0
    }
  }
}
```

`enableNonSslPort`ã«ã—ãªã„ã¨Jedisã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã€‚


```
cf create-service azure-rediscache basic demo-redis -c azure-redis-config.json
```

ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¿ãƒ³ã‚¹ä½œæˆã¯éåŒæœŸã§è¡Œã‚ã‚Œã€å‹•çš„ã«Redisã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã‚‹ã€‚`cf services`ã‚’è¦‹ã¦ã‚‚çŠ¶æ…‹ã¯`create ã¯é€²è¡Œä¸­ã§ã™`ã¨ãªã£ã¦ã„ã‚‹ã€‚

```
$ cf services
admin ã¨ã—ã¦çµ„ç¹” default_organization / ã‚¹ãƒšãƒ¼ã‚¹ demo å†…ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’å–å¾—ã—ã¦ã„ã¾ã™...
OK

åå‰        ã‚µãƒ¼ãƒ“ã‚¹           ãƒ—ãƒ©ãƒ³     ãƒã‚¤ãƒ³ãƒ‰æ¸ˆã¿ã‚¢ãƒ—ãƒª   æœ€å¾Œã®æ“ä½œ
demo-db     p-mysql            100mb      demo-app          create ã¯æˆåŠŸã—ã¾ã—ãŸ
demo-redis  azure-rediscache   basic      demo-app          create ã¯é€²è¡Œä¸­ã§ã™

```

æ¬¡ã®å›³ã§ã‚‚ã€çŠ¶æ…‹ãŒ"ä½œæˆä¸­..."ã«ãªã£ã¦ã„ã‚‹ã€‚

<img width="80%" src="https://qiita-image-store.s3.amazonaws.com/0/1852/d611d9cc-44d5-10ed-8606-bae2465a569b.png">


ã—ã°ã‚‰ãã™ã‚‹ã¨`create ã¯æˆåŠŸã—ã¾ã—ãŸ`ã«ãªã‚‹ã€‚

ã ã‘ã©ã€è‡ªåˆ†ãŒè©¦ã—ãŸæ™‚ã¯20åˆ†ãã‚‰ã„ã‹ã‹ã£ãŸãƒ»ãƒ»ãƒ»è«¦ã‚ãšã«å¾…ã¤ã¨è‰¯ã„ã€‚

ã§ããŸã‚‰ã€ã‚¢ãƒ—ãƒªã«ãƒã‚¤ãƒ³ãƒ‰ã€‚

```
cf bind-service demo-app demo-redis
```

ç’°å¢ƒå¤‰æ•°ã‚’è¦‹ã‚‹ã¨æ¬¡ã®ã‚ˆã†ãª`credentials`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚

``` console
$ cf env demo-app
admin ã¨ã—ã¦çµ„ç¹” default_organization / ã‚¹ãƒšãƒ¼ã‚¹ demo å†…ã®ã‚¢ãƒ—ãƒª demo-app ã®ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—ã—ã¦ã„ã¾ã™...
OK

ã‚·ã‚¹ãƒ†ãƒ æä¾›:
{
 "VCAP_SERVICES": {
  "azure-rediscache": [
   {
    "credentials": {
     "hostname": "mrs.redis.cache.windows.net",
     "name": "mrs",
     "port": 6379,
     "primaryKey": "xxxx",
     "secondaryKey": "xxxx",
     "sslPort": 6380
    },
    "label": "azure-rediscache",
    "name": "demo-redis",
    "plan": "basic",
    "provider": null,
    "syslog_drain_url": null,
    "tags": [],
    "volume_mounts": []
   }
  ],
  "p-mysql": [
   {
    "credentials": {
     "hostname": "10.0.50.5",
     "jdbcUrl": "jdbc:mysql://10.0.50.5:3306/xxxx,
     "name": "xxxx",
     "password": "xxxx",
     "port": 3306,
     "uri": "mysql://xxxx:xxxx@10.0.50.5:3306/xxxx",
     "username": "xxxx"
    },
    "label": "p-mysql",
    "name": "demo-db",
    "plan": "100mb",
    "provider": null,
    "syslog_drain_url": null,
    "tags": [
     "mysql"
    ],
    "volume_mounts": []
   }
  ]
 }
}

{
 "VCAP_APPLICATION": {
  "application_id": "cdbdc286-9173-49cb-8ce4-b7baef81b17b",
  "application_name": "demo-app",
  "application_uris": [
   "demo-app.azurecf.ik.am"
  ],
  "application_version": "b0d2da70-be02-4c94-aac5-c334961fa7a7",
  "limits": {
   "disk": 1024,
   "fds": 16384,
   "mem": 512
  },
  "name": "demo-app",
  "space_id": "f7798e39-7ac0-4295-98ee-a66c96e63baf",
  "space_name": "demo",
  "uris": [
   "demo-app.azurecf.ik.am"
  ],
  "users": null,
  "version": "b0d2da70-be02-4c94-aac5-c334961fa7a7"
 }
}
```

Spring Bootã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã¯æ¬¡ã®ã‚ˆã†ãª`RedisProperties`ã‚¯ãƒ©ã‚¹ã‚’ä½œã£ã¦ãŠã‘ã°è‰¯ã„ã€‚

``` java

	@Profile("cloud")
	@Bean
	public RedisProperties redisProperties(ObjectMapper objectMapper) throws IOException {
		JsonNode credentials = objectMapper.readTree(System.getenv("VCAP_SERVICES"))
				.get("azure-rediscache").get(0).get("credentials");
		RedisProperties prop = new RedisProperties();
		prop.setHost(credentials.get("hostname").asText());
		prop.setPort(credentials.get("port").asInt());
		prop.setPassword(credentials.get("primaryKey").asText());
		return prop;
	}
```

#### ãã®ä»–

æ°—ãŒå‘ã„ãŸã‚‰è©¦ã™ã€‚
