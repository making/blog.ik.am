---
title: Tanzu Application Platformã§CronJobã®Workloadã‚’ä½œæˆã™ã‚‹
tags: ["Kubernetes", "Cartographer", "kind", "Tanzu", "TAP"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP"]
---

Tanzu Application Platform (1.4æ™‚ç‚¹)ã§ã¯ã€[ã“ã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/workloads-workload-types.html)ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€Out of the Box (OOTB) Supply Chainsã«ã¦ä»¥ä¸‹ã®Workload TypeãŒã‚µãƒãƒ¼ãƒˆã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚

* `type=web` ... ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æƒ³å®šã—ãŸã‚‚ã®ã€‚Knativeã®Serviceãƒªã‚½ãƒ¼ã‚¹ã‚’ãŒä½œæˆã•ã‚Œã‚‹ã€‚Scale to Zeroã€Zero to NãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹ã€‚
* `type=server` ... ãƒˆãƒ©ãƒ‡ã‚£ã‚·ãƒ§ãƒŠãƒ«ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æƒ³å®šã—ãŸã‚‚ã®ã€‚K8sæ¨™æº–ã®Deploymentã€Serviceãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã‚‹ã€‚
* `type=worker` ... ã‚­ãƒ¥ãƒ¼ã‚’å‡¦ç†ã™ã‚‹ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æƒ³å®šã—ãŸã‚‚ã®ã€‚K8sæ¨™æº–ã®DeploymentãŒä½œæˆã•ã‚Œã‚‹ã€‚


ä»Šå›ã¯ã“ã“ã«`type=cronjob`ã‚’è¿½åŠ ã—ã¦ã€K8sæ¨™æº–ã®CronJobãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚


TAPã®Workloadã¯[Cartographer](https://cartographer.sh/)ã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚
Workloadã«ã‚ˆã£ã¦ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã¯ã€é€šå¸¸ã¯ClusterSupplyChainãƒªã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§è¡Œãˆã¾ã™ã€‚
ãŸã ã—ã€1ã‹ã‚‰Supply Chainã‚’ä½œã‚‹å ´åˆã¯ã€

* ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å–å¾—
* ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
* ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆ
* ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®å–å¾—
* ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
* ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ä½œæˆ
* ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°

ãªã©ãªã©ã€Supply Chainã‚’æ§‹æˆã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®šç¾©ã—ã¦ã„ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚(ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯[ã“ã¡ã‚‰](https://cartographer.sh/docs/v0.7.0/tutorials/first-supply-chain/))
TAPã®OOTB Supply Chainã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’å†åº¦å®šç¾©ã™ã‚‹ã®ã¯é¢å€’ãã•ã„ã§ã™ã­ã€‚

TAPã§ã¯OOTB Supply Chainã®ã†ã¡ã€"ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ä½œæˆ"ã®éƒ¨åˆ†ã ã‘ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯[ã“ã¡ã‚‰](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/workloads-server.html#define-a-workload-type-that-exposes-server-workloads-outside-the-cluster-5)ã§ã™ã€‚
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯`type=server`ã®ãƒªã‚½ãƒ¼ã‚¹ã«åŠ ãˆã¦Ingressãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œã‚‹ä¾‹ã‚’èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚
Supply Chainã«ã‚ˆã£ã¦ç”Ÿæˆã•ã›ãŸã„ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’Cartographerã®ClusterConfigTemplateã§å®šç¾©ã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

[ã“ã¡ã‚‰ã®è¨˜äº‹](https://ik.am/entries/733)ã§ä½œæˆã—ãŸç’°å¢ƒã§è©¦ã—ã¾ã™ã€‚

**ç›®æ¬¡**
<!-- toc -->

### ClusterConfigTemplateã®å®šç¾©

CronJobã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¬¡ã®ã‚ˆã†ã«ClusterConfigTemplateã«å®šç¾©ã—ã¾ã™ã€‚

```yaml
cat <<EOF > cronjob-template.yaml
apiVersion: carto.run/v1alpha1
kind: ClusterConfigTemplate
metadata:
  name: cronjob-template
spec:
  configPath: .data
  lifecycle: mutable
  ytt: |
    #@ load("@ytt:data", "data")
    #@ load("@ytt:yaml", "yaml")
    
    #@ def merge_labels(fixed_values):
    #@   labels = {}
    #@   if hasattr(data.values.workload.metadata, "labels"):
    #@     labels.update(data.values.workload.metadata.labels)
    #@   end
    #@   labels.update(fixed_values)
    #@   return labels
    #@ end

    #@ def update_config(config):
    #@   values = {}
    #@   values.update(config)
    #@   spec = dict(values["spec"])
    #@   spec.update({"restartPolicy": data.values.params.restartPolicy if hasattr(data.values.params, "restartPolicy") else "Never"})
    #@   workload = dict(spec["containers"][0])
    #@   if hasattr(data.values.params, "command"):
    #@     workload.update({"command": data.values.params.command})
    #@   end
    #@   if hasattr(data.values.params, "args"):
    #@     workload.update({"args": data.values.params.args})
    #@   end
    #@   spec["containers"][0] = workload
    #@   values["spec"] = spec
    #@   return values
    #@ end
    
    #@ def delivery():
    apiVersion: batch/v1
    kind: CronJob
    metadata:
      name: #@ data.values.workload.metadata.name
      annotations:
        kapp.k14s.io/update-strategy: "fallback-on-replace"
        ootb.apps.tanzu.vmware.com/servicebinding-workload: "true"
        kapp.k14s.io/change-rule: "upsert after upserting servicebinding.io/ServiceBindings"
      labels: #@ merge_labels({ "app.kubernetes.io/component": "run", "carto.run/workload-name": data.values.workload.metadata.name })
    spec:
      schedule: #@ data.values.params.schedule if hasattr(data.values.params, "schedule") else "0 15 * * *"
      successfulJobsHistoryLimit: 1
      failedJobsHistoryLimit: 3
      concurrencyPolicy: Forbid
      jobTemplate:
        metadata:
          labels: #@ data.values.config.metadata.labels
        spec:
          backoffLimit: 0
          template: #@ update_config(data.values.config)
    #@ end
    
    ---
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: #@ data.values.workload.metadata.name + "-cronjob"
      labels: #@ merge_labels({ "app.kubernetes.io/component": "config" })
    data:
      delivery.yml: #@ yaml.encode(delivery())
EOF
```

> K8sæ¨™æº–ã®CronJobã§ã¯ãªãã€[Furiko](https://furiko.io/docs/execution/jobconfig/sample-configuration)ã®ã‚ˆã†ãªæ‹¡å¼µã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚’ä½¿ã„ãŸã„å ´åˆã‚‚ã“ã®ClusterConfigTemplateã‚’å¤‰æ›´ã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

ã“ã®CronJobã®manifestã¯æœ€çµ‚çš„ã«Deliverableã«ã‚ˆã£ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã®ã§ã€Deliverableã‚’ç®¡ç†ã™ã‚‹Service AccountãŒCronJobã‚’ä½œæˆã™ã‚‹æ¨©é™ã‚’æŒã¤å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
`apps.tanzu.vmware.com/aggregate-to-deliverable: "true"`ã¨ã„ã†ãƒ©ãƒ™ãƒ«ã‚’ClusterRoleã«ã¤ã‘ã‚Œã°ã€Deliverableã‚’ç®¡ç†ã™ã‚‹Service Accountã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¾ã™ã€‚


```yaml
cat <<EOF > deliverable-with-cronjob.yml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: deliverable-with-cronjob
  labels:
    apps.tanzu.vmware.com/aggregate-to-deliverable: "true"
rules:
- apiGroups:
  - batch
  resources:
  - cronjobs
  verbs:
  - get
  - list
  - watch
  - create
  - patch
  - update
  - delete
  - deletecollection
EOF
```

ã“ã‚Œã‚‰ã‚’applyã—ã¾ã™ã€‚

```
# Muti Clusteræ§‹æˆã®å ´åˆã¯Build Clusterã«ã¦
kubectl apply -f cronjob-template.yaml
```
```
# Muti Clusteræ§‹æˆã®å ´åˆã¯Run Clusterã«ã¦
kubectl apply -f deliverable-with-cronjob.yml
```

æœ€å¾Œã«Workload Typeã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’`tap-values.yaml`ã«è¿½åŠ ã—ã¾ã™ã€‚

```yaml
ootb_supply_chain_basic: # supply_chainã®å€¤ãŒbasicã®å ´åˆ
# or ootb_supply_chain_testing: supply_chainã®å€¤ãŒtestingã®å ´åˆ
# or ootb_supply_chain_testing_scanning: supply_chainã®å€¤ãŒtesting_scanningã®å ´åˆ
  supported_workloads:
  - type: web
    cluster_config_template_name: config-template
  - type: server
    cluster_config_template_name: server-template
  - type: worker
    cluster_config_template_name: worker-template
  - type: cronjob
    cluster_config_template_name: cronjob-template # <---
```

`tap-values.yaml`ã®å¤‰æ›´ã‚’åæ˜ ã•ã›ã¾ã™ã€‚

```
tanzu package installed update -n tap-install tap --values-file tap-values.yaml
```

æ›´æ–°ãŒå®Œäº†ã™ã‚‹ã¨ã€source-to-url Supply Chainã«`type=cronjob`ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
$ tanzu apps cluster-supply-chain get source-to-url 
---
# source-to-url: Ready
---
Supply Chain Selectors
   TYPE          KEY                                   OPERATOR   VALUE
   expressions   apps.tanzu.vmware.com/workload-type   In         web
   expressions   apps.tanzu.vmware.com/workload-type   In         server
   expressions   apps.tanzu.vmware.com/workload-type   In         worker
   expressions   apps.tanzu.vmware.com/workload-type   In         cronjob
```

ç¾çŠ¶ã¯Service Bindingã®æ©Ÿèƒ½ãŒä½¿ãˆã¾ã›ã‚“ã€‚CronJobã¸ã®Bindã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚

### (Optional) Overlaysã«ã‚ˆã‚‹è¨­å®šå¤‰æ›´

TAPã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸå¾Œã«

```
kubectl apply -f cronjob-template.yaml
kubectl apply -f deliverable-with-cronjob.yml
```

ã‚’å®Ÿè¡Œã—ã¦TAPã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ã¨ã„ã†æ‰‹é †ãŒã€å®£è¨€çš„ã§ãªãã¦å¥½ã¿ã§ãªã„å ´åˆã¯ã€overlay fileã¨ã—ã¦ClusterConfigTemplateã¨ClusterRoleã‚’è¿½åŠ ã™ã‚Œã°ã€
`tanzu package install`ã‚ã‚‹ã„ã¯`tanzu package installed update`ã§TAPã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/æ›´æ–°ã™ã‚‹éš›ã«åŒæ™‚ã«ClusterConfigTemplateã¨ClusterRoleã‚‚ä½œæˆã•ã‚Œã¾ã™ã€‚


ã“ã®å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«overlayã¨ã—ã¦ClusterConfigTemplateã¨ClusterRoleã‚’ä½œæˆã—ã¾ã™ã€‚

```
# Muti Clusteræ§‹æˆã®å ´åˆã¯Build Clusterã«ã¦

kubectl -n tap-install create secret generic ootb-templates-cronjob-template \
  -o yaml \
  --dry-run=client \
  --from-file=cronjob-template.yaml \
  | kubectl apply -f-
```

```
# Muti Clusteræ§‹æˆã®å ´åˆã¯Run Clusterã«ã¦

kubectl -n tap-install create secret generic tap-auth-deliverable-with-cronjob \
  -o yaml \
  --dry-run=client \
  --from-file=deliverable-with-cronjob.yml \
  | kubectl apply -f-
```

```yaml
package_overlays:
- name: ootb-templates
  secrets:
  - name: ootb-templates-cronjob-template # Muti Clusteræ§‹æˆã®å ´åˆã¯Build Clusterã«ã¦
- name: tap-auth
  secrets:
  - name: tap-auth-deliverable-with-cronjob # Muti Clusteræ§‹æˆã®å ´åˆã¯Run Clusterã«ã¦
```

åˆå›ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆã€

```
tanzu package install tap -p tap.tanzu.vmware.com -v 1.4.2 --values-file tap-values.yaml -n tap-install
```

æ›´æ–°ã®å ´åˆ

```
tanzu package installed update -n tap-install tap --values-file tap-values.yaml
```

ã§`type=cronjob`ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### CronJob Workloadã®ä½œæˆ

ã„ã‚ã„ã‚ãªCronJobã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

#### ã‚·ãƒ³ãƒ—ãƒ«ãªCronJob

[Kubernetesã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/)ã«è¼‰ã£ã¦ã„ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆã—ã„ã¦ã¿ã¾ã™ã€‚

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§CronJobã‚’ä½œã‚‹ãŸã‚ã®Workloadã‚’ä½œæˆã—ã¾ã™ã€‚ä»Šå›ã¯ `--image` ã§CronJobã§å®Ÿè¡Œã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```
tanzu apps workload apply \
  -n demo \
  --type cronjob \
  --image ghcr.io/making/busybox \
  --param-yaml 'command=["/bin/sh", "-c", "date; echo Hello from TAP"]' \
  --param schedule="* * * * *" \
  --app cronjob-demo \
  cronjob-demo
```


> å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨åŒã˜ã‚ˆã†ã«`--image busybox:1.28`ã§å®Ÿè¡Œã™ã‚‹ã¨ImageRepositoryãƒªã‚½ãƒ¼ã‚¹ã§æ¬¡ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
> `unable to pull image "busybox:1.28": Expected an Image but got: application/vnd.docker.distribution.manifest.list.v2+json`
> æ¬¡ã®ã‚ˆã†ãªRelocationãŒå¿…è¦ã§ã—ãŸã€‚
> ```
> docker pull busybox 
> docker tag busybox ghcr.io/making/busybox
> docker push busybox
> ```

ã—ã°ã‚‰ãã™ã‚‹ã¨CronJobãŒä½œæˆã•ã‚Œã€ã•ã‚‰ã«JobãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```
$ tanzu apps workload get cronjob-demo --namespace demo
ğŸ“¡ Overview
   name:        cronjob-demo
   type:        cronjob
   namespace:   demo

ğŸ’¾ Source
   type:    image
   image:   ghcr.io/making/busybox

ğŸ“¦ Supply Chain
   name:   basic-image-to-url

   NAME               READY   HEALTHY   UPDATED   RESOURCE
   image-provider     True    True      10m       imagerepositories.source.apps.tanzu.vmware.com/cronjob-demo
   config-provider    True    True      10m       podintents.conventions.carto.run/cronjob-demo
   app-config         True    True      10m       configmaps/cronjob-demo-cronjob
   service-bindings   True    True      10m       configmaps/cronjob-demo-with-claims
   api-descriptors    True    True      10m       configmaps/cronjob-demo-with-api-descriptors
   config-writer      True    True      10m       runnables.carto.run/cronjob-demo-config-writer

ğŸšš Delivery
   name:   delivery-basic

   NAME              READY   HEALTHY   UPDATED   RESOURCE
   source-provider   True    True      9m34s     imagerepositories.source.apps.tanzu.vmware.com/cronjob-demo-delivery
   deployer          True    True      60s       apps.kappctrl.k14s.io/cronjob-demo

ğŸ’¬ Messages
   No messages found.

ğŸ›¶ Pods
   NAME                                   READY   STATUS      RESTARTS   AGE
   cronjob-demo-28018560-zdp85            0/1     Completed   0          4s
   cronjob-demo-config-writer-l68rw-pod   0/1     Completed   0          10m

To see logs: "tanzu apps workload tail cronjob-demo --namespace demo --timestamp --since 1h"
```

ä½œæˆã•ã‚ŒãŸCronJobã¨Jobã‚’ç¢ºèªã—ã¾ã™ã€‚


```
$ kubectl get cronjob,job -n demo 
NAME                         SCHEDULE    SUSPEND   ACTIVE   LAST SCHEDULE   AGE
cronjob.batch/cronjob-demo   * * * * *   False     0        23s             81s

NAME                              COMPLETIONS   DURATION   AGE
job.batch/cronjob-demo-28018560   1/1           7s         23s
```

ãƒ­ã‚°ã‚’ç¢ºèªã—ã¾ã™ã€‚æ™‚åˆ»ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

```
$ kubectl logs -n demo cronjob-demo-28018560-zdp85 
Mon Apr 10 08:00:04 UTC 2023
Hello from TAP
```

`schedule`ãŒ`* * * * *`ãªã®ã§ã€ã“ã®Jobã¯æ¯åˆ†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ç¢ºèªã§ããŸã‚‰workloadã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```
tanzu apps workload delete -n demo cronjob-demo
```

#### curlã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã®CronJob

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§CronJobã‚’ä½œã‚‹ãŸã‚ã®Workloadã‚’ä½œæˆã—ã¾ã™ã€‚

```
tanzu apps workload apply \
  -n demo \
  --type cronjob \
  --image ghcr.io/making/curl \
  --param-yaml 'command=["curl"]' \
  --param-yaml 'args=["-s", "https://httpbin.org/get"]' \
  --param schedule="* * * * *" \
  --app hello-curl \
  hello-curl
```

ã—ã°ã‚‰ãã™ã‚‹ã¨CronJobãŒä½œæˆã•ã‚Œã€ã•ã‚‰ã«JobãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```
$ tanzu apps workload get hello-curl --namespace demo
ğŸ“¡ Overview
   name:        hello-curl
   type:        cronjob
   namespace:   demo

ğŸ’¾ Source
   type:    image
   image:   ghcr.io/making/curl

ğŸ“¦ Supply Chain
   name:   basic-image-to-url

   NAME               READY   HEALTHY   UPDATED   RESOURCE
   image-provider     True    True      106s      imagerepositories.source.apps.tanzu.vmware.com/hello-curl
   config-provider    True    True      102s      podintents.conventions.carto.run/hello-curl
   app-config         True    True      102s      configmaps/hello-curl-cronjob
   service-bindings   True    True      102s      configmaps/hello-curl-with-claims
   api-descriptors    True    True      102s      configmaps/hello-curl-with-api-descriptors
   config-writer      True    True      91s       runnables.carto.run/hello-curl-config-writer

ğŸšš Delivery
   name:   delivery-basic

   NAME              READY   HEALTHY   UPDATED   RESOURCE
   source-provider   True    True      44s       imagerepositories.source.apps.tanzu.vmware.com/hello-curl-delivery
   deployer          True    True      42s       apps.kappctrl.k14s.io/hello-curl

ğŸ’¬ Messages
   No messages found.

ğŸ›¶ Pods
   NAME                                 READY   STATUS      RESTARTS   AGE
   hello-curl-28018564-2rlgc            0/1     Completed   0          11s
   hello-curl-config-writer-k76bd-pod   0/1     Completed   0          101s

To see logs: "tanzu apps workload tail hello-curl --namespace demo --timestamp --since 1h"
```

ä½œæˆã•ã‚ŒãŸCronJobã¨Jobã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ kubectl get cronjob,job -n demo 
NAME                       SCHEDULE    SUSPEND   ACTIVE   LAST SCHEDULE   AGE
cronjob.batch/hello-curl   * * * * *   False     0        42s             76s

NAME                            COMPLETIONS   DURATION   AGE
job.batch/hello-curl-28018564   1/1           8s         42s
```

ãƒ­ã‚°ã‚’ç¢ºèªã—ã¾ã™ã€‚curlã®å®Ÿè¡ŒçµæœãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚

```
$ kubectl logs -n demo hello-curl-28018564-2rlgc 
{
  "args": {}, 
  "headers": {
    "Accept": "*/*", 
    "Host": "httpbin.org", 
    "User-Agent": "curl/8.0.1-DEV", 
    "X-Amzn-Trace-Id": "Root=1-6433c2f5-5f649b191de9f1ea4e83fb8f"
  }, 
  "origin": "220.242.176.124", 
  "url": "https://httpbin.org/get"
}
```

ç¢ºèªã§ããŸã‚‰workloadã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```
tanzu apps workload delete -n demo hello-curl
```

#### Pythonã®Scriptã‚’å®Ÿè¡Œã™ã‚‹CronJob

æ¬¡ã¯CronJobã§å®Ÿè¡Œã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ä½œæˆã—ã¾ã™ã€‚
https://github.com/making/hello-python ã®Pythonã‚³ãƒ¼ãƒ‰ã‚’Cloud Native Buildpacksã§ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸åŒ–ã—ã¦CronJobå®Ÿè¡Œã—ã¾ã™ã€‚


æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§CronJobã‚’ä½œã‚‹ãŸã‚ã®Workloadã‚’ä½œæˆã—ã¾ã™ã€‚ä»Šå›ã¯`--git-repo`ã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®URLã‚’æŒ‡å®šã—ã¾ã™ã€‚

```
tanzu apps workload apply \
  -n demo \
  --type cronjob \
  --git-repo https://github.com/making/hello-python \
  --git-branch main \
  --param schedule="* * * * *" \
  --app hello-python \
  --label apps.tanzu.vmware.com/has-tests=true \
  hello-python
```

ã—ã°ã‚‰ãã™ã‚‹ã¨CronJobãŒä½œæˆã•ã‚Œã€ã•ã‚‰ã«JobãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```
$ tanzu apps workload get hello-python --namespace demo 
ğŸ“¡ Overview
   name:        hello-python
   type:        cronjob
   namespace:   demo

ğŸ’¾ Source
   type:     git
   url:      https://github.com/making/hello-python
   branch:   main

ğŸ“¦ Supply Chain
   name:   source-to-url

   NAME               READY   HEALTHY   UPDATED   RESOURCE
   source-provider    True    True      4m58s     gitrepositories.source.toolkit.fluxcd.io/hello-python
   image-provider     True    True      3m58s     images.kpack.io/hello-python
   config-provider    True    True      3m52s     podintents.conventions.carto.run/hello-python
   app-config         True    True      3m52s     configmaps/hello-python-cronjob
   service-bindings   True    True      3m52s     configmaps/hello-python-with-claims
   api-descriptors    True    True      3m52s     configmaps/hello-python-with-api-descriptors
   config-writer      True    True      3m38s     runnables.carto.run/hello-python-config-writer

ğŸšš Delivery
   name:   delivery-basic

   NAME              READY   HEALTHY   UPDATED   RESOURCE
   source-provider   True    True      2m54s     imagerepositories.source.apps.tanzu.vmware.com/hello-python-delivery
   deployer          True    True      2m52s     apps.kappctrl.k14s.io/hello-python

ğŸ’¬ Messages
   No messages found.

ğŸ›¶ Pods
   NAME                                   READY   STATUS      RESTARTS   AGE
   hello-python-28018837-25db8            0/1     Completed   0          32s
   hello-python-build-1-build-pod         0/1     Completed   0          4m57s
   hello-python-config-writer-ch8z4-pod   0/1     Completed   0          3m50s
```

ä½œæˆã•ã‚ŒãŸCronJobã¨Jobã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ kubectl get cronjob,job -n demo 
NAME                         SCHEDULE    SUSPEND   ACTIVE   LAST SCHEDULE   AGE
cronjob.batch/hello-python   * * * * *   False     0        45s             3m6s

NAME                              COMPLETIONS   DURATION   AGE
job.batch/hello-python-28018837   1/1           5s         45s
```

ãƒ­ã‚°ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ kubectl logs -n demo hello-python-28018837-25db8 
{
  "args": {}, 
  "headers": {
    "Accept": "*/*", 
    "Accept-Encoding": "gzip, deflate", 
    "Host": "httpbin.org", 
    "User-Agent": "python-requests/2.28.2", 
    "X-Amzn-Trace-Id": "Root=1-643402ed-0e6ea59220b36d3636bd2a41"
  }, 
  "origin": "220.242.176.124", 
  "url": "https://httpbin.org/get"
}
```

ç¢ºèªã§ããŸã‚‰workloadã‚’å‰Šé™¤ã—ã¾ã™ã€‚


```
tanzu apps workload delete -n demo hello-python
```

#### Spring Batchã®Jobã‚’å®Ÿè¡Œã™ã‚‹CronJob

ä»Šå¾Œã¯Spring Batchã§å®Ÿè£…ã•ã‚ŒãŸãƒãƒƒãƒå‡¦ç†ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ https://github.com/making/billing-job ã‚’Cloud Native Buildpacksã§ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸åŒ–ã—ã¦CronJobå®Ÿè¡Œã—ã¾ã™ã€‚

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§CronJobã‚’ä½œã‚‹ãŸã‚ã®Workloadã‚’ä½œæˆã—ã¾ã™ã€‚


```
tanzu apps workload apply \
  -n demo \
  --type cronjob \
  --git-repo https://github.com/making/billing-job \
  --git-branch master \
  --param schedule="0 15 * * *" \
  --app billing-job \
  --label apps.tanzu.vmware.com/has-tests=true \
  --build-env BP_JVM_VERSION=17 \
  --env BPL_JVM_THREAD_COUNT=8 \
  --env JAVA_TOOL_OPTIONS=-Dmanagement.health.probes.enabled=false \
  billing-job
```

ã—ã°ã‚‰ãã™ã‚‹ã¨CronJobãŒä½œæˆã•ã‚Œã¾ã™ã€‚00:00 JSTã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«Scheduleã—ãŸã®ã§ã¾ã Jobã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã€‚

```
 $ tanzu apps workload get billing-job --namespace demo
ğŸ“¡ Overview
   name:        billing-job
   type:        cronjob
   namespace:   demo

ğŸ’¾ Source
   type:     git
   url:      https://github.com/making/billing-job
   branch:   master

ğŸ“¦ Supply Chain
   name:   source-to-url

   NAME               READY   HEALTHY   UPDATED   RESOURCE
   source-provider    True    True      4m51s     gitrepositories.source.toolkit.fluxcd.io/billing-job
   image-provider     True    True      3m39s     images.kpack.io/billing-job
   config-provider    True    True      3m34s     podintents.conventions.carto.run/billing-job
   app-config         True    True      3m34s     configmaps/billing-job-cronjob
   service-bindings   True    True      3m33s     configmaps/billing-job-with-claims
   api-descriptors    True    True      3m33s     configmaps/billing-job-with-api-descriptors
   config-writer      True    True      3m17s     runnables.carto.run/billing-job-config-writer

ğŸšš Delivery
   name:   delivery-basic

   NAME              READY   HEALTHY   UPDATED   RESOURCE
   source-provider   True    True      2m48s     imagerepositories.source.apps.tanzu.vmware.com/billing-job-delivery
   deployer          True    True      2m46s     apps.kappctrl.k14s.io/billing-job

ğŸ’¬ Messages
   No messages found.

ğŸ›¶ Pods
   NAME                                  READY   STATUS      RESTARTS   AGE
   billing-job-build-1-build-pod         0/1     Completed   0          4m52s
   billing-job-config-writer-mlhff-pod   0/1     Completed   0          3m33s

To see logs: "tanzu apps workload tail billing-job --namespace demo --timestamp --since 1h"
```

ä½œæˆã•ã‚ŒãŸCronJobã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ kubectl get cronjob,job -n demo 
NAME                        SCHEDULE     SUSPEND   ACTIVE   LAST SCHEDULE   AGE
cronjob.batch/billing-job   0 15 * * *   False     0        <none>          3m48s
```

æ‰‹å‹•ã§Jobã‚’ä½œæˆã—ã¾ã™ã€‚

```
kubectl create job -n demo --from cronjob/billing-job test-run
```

ä½œæˆã•ã‚ŒãŸCronJobã¨Jobã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ kubectl get cronjob,job -n demo 
NAME                        SCHEDULE     SUSPEND   ACTIVE   LAST SCHEDULE   AGE
cronjob.batch/billing-job   0 15 * * *   False     0        <none>          5m12s

NAME                 COMPLETIONS   DURATION   AGE
job.batch/test-run   1/1           13s        26s
```

ãƒ­ã‚°ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ kubectl logs -n demo test-run-c9r5d 
Setting Active Processor Count to 8
Calculating JVM memory based on 4528180K available memory
For more information on this calculation, see https://paketo.io/docs/reference/java-reference/#memory-calculator
Calculated JVM Memory Configuration: -XX:MaxDirectMemorySize=10M -Xmx4191438K -XX:MaxMetaspaceSize=72549K -XX:ReservedCodeCacheSize=240M -Xss1M (Total Memory: 4528180K, Thread Count: 8, Loaded Class Count: 10395, Headroom: 0%)
Enabling Java Native Memory Tracking
Adding 124 container CA certificates to JVM truststore
Spring Cloud Bindings Enabled
Picked up JAVA_TOOL_OPTIONS: -Dmanagement.health.probes.enabled="false" -Djava.security.properties=/layers/paketo-buildpacks_bellsoft-liberica/java-security-properties/java-security.properties -XX:+ExitOnOutOfMemoryError -XX:ActiveProcessorCount=8 -XX:MaxDirectMemorySize=10M -Xmx4191438K -XX:MaxMetaspaceSize=72549K -XX:ReservedCodeCacheSize=240M -Xss1M -XX:+UnlockDiagnosticVMOptions -XX:NativeMemoryTracking=summary -XX:+PrintNMTStatistics -Dorg.springframework.cloud.bindings.boot.enable=true

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v3.0.5)

2023-04-10T16:38:45.371Z  INFO 1 --- [           main] lol.maki.billing.BillingJobApplication   : Starting BillingJobApplication v0.0.1-SNAPSHOT using Java 17.0.6 with PID 1 (/workspace/BOOT-INF/classes started by cnb in /workspace)
2023-04-10T16:38:45.376Z  INFO 1 --- [           main] lol.maki.billing.BillingJobApplication   : No active profile set, falling back to 1 default profile: "default"
2023-04-10T16:38:46.207Z  INFO 1 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...
2023-04-10T16:38:46.436Z  INFO 1 --- [           main] com.zaxxer.hikari.pool.HikariPool        : HikariPool-1 - Added connection conn0: url=jdbc:h2:mem:b918459b-19ff-41d4-8f50-d482bba0dee8 user=SA
2023-04-10T16:38:46.440Z  INFO 1 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
2023-04-10T16:38:46.829Z  INFO 1 --- [           main] lol.maki.billing.BillingJobApplication   : Started BillingJobApplication in 1.968 seconds (process running for 2.419)
2023-04-10T16:38:46.832Z  INFO 1 --- [           main] o.s.b.a.b.JobLauncherApplicationRunner   : Running default command line with: []
2023-04-10T16:38:46.844Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:46.845Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT JOB_INSTANCE_ID, JOB_NAME from BATCH_JOB_INSTANCE where JOB_NAME = ? and JOB_KEY = ?]
2023-04-10T16:38:46.860Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:46.860Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT JOB_INSTANCE_ID, JOB_NAME from BATCH_JOB_INSTANCE I1 where I1.JOB_NAME = ? and I1.JOB_INSTANCE_ID in (SELECT max(I2.JOB_INSTANCE_ID) from BATCH_JOB_INSTANCE I2 where I2.JOB_NAME = ?)]
2023-04-10T16:38:46.868Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:46.869Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT JOB_INSTANCE_ID, JOB_NAME from BATCH_JOB_INSTANCE where JOB_NAME = ? and JOB_KEY = ?]
2023-04-10T16:38:46.871Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:46.871Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT JOB_INSTANCE_ID, JOB_NAME from BATCH_JOB_INSTANCE where JOB_NAME = ? and JOB_KEY = ?]
2023-04-10T16:38:46.872Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:46.872Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT JOB_INSTANCE_ID, JOB_NAME from BATCH_JOB_INSTANCE where JOB_NAME = ? and JOB_KEY = ?]
2023-04-10T16:38:46.878Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:46.879Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [INSERT into BATCH_JOB_INSTANCE(JOB_INSTANCE_ID, JOB_NAME, JOB_KEY, VERSION) values (?, ?, ?, ?)]
2023-04-10T16:38:46.889Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:46.889Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [INSERT into BATCH_JOB_EXECUTION(JOB_EXECUTION_ID, JOB_INSTANCE_ID, START_TIME, END_TIME, STATUS, EXIT_CODE, EXIT_MESSAGE, VERSION, CREATE_TIME, LAST_UPDATED) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
2023-04-10T16:38:46.892Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing SQL batch update [INSERT into BATCH_JOB_EXECUTION_PARAMS(JOB_EXECUTION_ID, PARAMETER_NAME, PARAMETER_TYPE, PARAMETER_VALUE, IDENTIFYING) values (?, ?, ?, ?, ?)] with a batch size of 100
2023-04-10T16:38:46.893Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [INSERT into BATCH_JOB_EXECUTION_PARAMS(JOB_EXECUTION_ID, PARAMETER_NAME, PARAMETER_TYPE, PARAMETER_VALUE, IDENTIFYING) values (?, ?, ?, ?, ?)]
2023-04-10T16:38:46.901Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:46.902Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [INSERT INTO BATCH_JOB_EXECUTION_CONTEXT (SHORT_CONTEXT, SERIALIZED_CONTEXT, JOB_EXECUTION_ID) VALUES(?, ?, ?)]
2023-04-10T16:38:46.904Z  INFO 1 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=BillingJob]] launched with the following parameters: [{'run.id':'{value=1, type=class java.lang.Long, identifying=true}'}]
2023-04-10T16:38:46.922Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:46.923Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT VERSION FROM BATCH_JOB_EXECUTION WHERE JOB_EXECUTION_ID=?]
2023-04-10T16:38:46.928Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:46.928Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT COUNT(*) FROM BATCH_JOB_EXECUTION WHERE JOB_EXECUTION_ID = ?]
2023-04-10T16:38:46.932Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:46.932Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [UPDATE BATCH_JOB_EXECUTION set START_TIME = ?, END_TIME = ?,  STATUS = ?, EXIT_CODE = ?, EXIT_MESSAGE = ?, VERSION = ?, CREATE_TIME = ?, LAST_UPDATED = ? where JOB_EXECUTION_ID = ? and VERSION = ?]
2023-04-10T16:38:46.936Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:46.936Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT  SE.STEP_EXECUTION_ID, SE.STEP_NAME, SE.START_TIME, SE.END_TIME, SE.STATUS, SE.COMMIT_COUNT, SE.READ_COUNT, SE.FILTER_COUNT, SE.WRITE_COUNT, SE.EXIT_CODE, SE.EXIT_MESSAGE, SE.READ_SKIP_COUNT, SE.WRITE_SKIP_COUNT, SE.PROCESS_SKIP_COUNT, SE.ROLLBACK_COUNT, SE.LAST_UPDATED, SE.VERSION, SE.CREATE_TIME, JE.JOB_EXECUTION_ID, JE.START_TIME, JE.END_TIME, JE.STATUS, JE.EXIT_CODE, JE.EXIT_MESSAGE, JE.CREATE_TIME, JE.LAST_UPDATED, JE.VERSION from BATCH_JOB_EXECUTION JE join BATCH_STEP_EXECUTION SE      on SE.JOB_EXECUTION_ID = JE.JOB_EXECUTION_ID where JE.JOB_INSTANCE_ID = ?      and SE.STEP_NAME = ? order by SE.CREATE_TIME desc, SE.STEP_EXECUTION_ID desc]
2023-04-10T16:38:46.940Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:46.940Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT COUNT(*)  from BATCH_JOB_EXECUTION JE JOIN BATCH_STEP_EXECUTION SE       on SE.JOB_EXECUTION_ID = JE.JOB_EXECUTION_ID where JE.JOB_INSTANCE_ID = ?      and SE.STEP_NAME = ?]
2023-04-10T16:38:46.942Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:46.942Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [INSERT into BATCH_STEP_EXECUTION(STEP_EXECUTION_ID, VERSION, STEP_NAME, JOB_EXECUTION_ID, START_TIME, END_TIME, STATUS, COMMIT_COUNT, READ_COUNT, FILTER_COUNT, WRITE_COUNT, EXIT_CODE, EXIT_MESSAGE, READ_SKIP_COUNT, WRITE_SKIP_COUNT, PROCESS_SKIP_COUNT, ROLLBACK_COUNT, LAST_UPDATED, CREATE_TIME) values(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
2023-04-10T16:38:46.943Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:46.943Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [INSERT INTO BATCH_STEP_EXECUTION_CONTEXT (SHORT_CONTEXT, SERIALIZED_CONTEXT, STEP_EXECUTION_ID) VALUES(?, ?, ?)]
2023-04-10T16:38:46.945Z  INFO 1 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [BilliProcessing]
2023-04-10T16:38:46.946Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:46.947Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [UPDATE BATCH_STEP_EXECUTION set START_TIME = ?, END_TIME = ?, STATUS = ?, COMMIT_COUNT = ?, READ_COUNT = ?, FILTER_COUNT = ?, WRITE_COUNT = ?, EXIT_CODE = ?, EXIT_MESSAGE = ?, VERSION = ?, READ_SKIP_COUNT = ?, PROCESS_SKIP_COUNT = ?, WRITE_SKIP_COUNT = ?, ROLLBACK_COUNT = ?, LAST_UPDATED = ? where STEP_EXECUTION_ID = ? and VERSION = ?]
2023-04-10T16:38:46.948Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:46.948Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT VERSION FROM BATCH_JOB_EXECUTION WHERE JOB_EXECUTION_ID=?]
2023-04-10T16:38:46.955Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:46.955Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [UPDATE BATCH_STEP_EXECUTION_CONTEXT SET SHORT_CONTEXT = ?, SERIALIZED_CONTEXT = ? WHERE STEP_EXECUTION_ID = ?]
2023-04-10T16:38:47.023Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing SQL batch update [INSERT INTO BILL_STATEMENTS (id, first_name, last_name, minutes, data_usage,bill_amount) VALUES (?, ?, ?, ?, ?, ?)]
2023-04-10T16:38:47.023Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [INSERT INTO BILL_STATEMENTS (id, first_name, last_name, minutes, data_usage,bill_amount) VALUES (?, ?, ?, ?, ?, ?)]
2023-04-10T16:38:47.027Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:47.028Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [UPDATE BATCH_STEP_EXECUTION_CONTEXT SET SHORT_CONTEXT = ?, SERIALIZED_CONTEXT = ? WHERE STEP_EXECUTION_ID = ?]
2023-04-10T16:38:47.029Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:47.029Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [UPDATE BATCH_STEP_EXECUTION set START_TIME = ?, END_TIME = ?, STATUS = ?, COMMIT_COUNT = ?, READ_COUNT = ?, FILTER_COUNT = ?, WRITE_COUNT = ?, EXIT_CODE = ?, EXIT_MESSAGE = ?, VERSION = ?, READ_SKIP_COUNT = ?, PROCESS_SKIP_COUNT = ?, WRITE_SKIP_COUNT = ?, ROLLBACK_COUNT = ?, LAST_UPDATED = ? where STEP_EXECUTION_ID = ? and VERSION = ?]
2023-04-10T16:38:47.030Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:47.030Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT VERSION FROM BATCH_JOB_EXECUTION WHERE JOB_EXECUTION_ID=?]
2023-04-10T16:38:47.034Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing SQL batch update [INSERT INTO BILL_STATEMENTS (id, first_name, last_name, minutes, data_usage,bill_amount) VALUES (?, ?, ?, ?, ?, ?)]
2023-04-10T16:38:47.035Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [INSERT INTO BILL_STATEMENTS (id, first_name, last_name, minutes, data_usage,bill_amount) VALUES (?, ?, ?, ?, ?, ?)]
2023-04-10T16:38:47.037Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:47.038Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [UPDATE BATCH_STEP_EXECUTION_CONTEXT SET SHORT_CONTEXT = ?, SERIALIZED_CONTEXT = ? WHERE STEP_EXECUTION_ID = ?]
2023-04-10T16:38:47.039Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:47.039Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [UPDATE BATCH_STEP_EXECUTION set START_TIME = ?, END_TIME = ?, STATUS = ?, COMMIT_COUNT = ?, READ_COUNT = ?, FILTER_COUNT = ?, WRITE_COUNT = ?, EXIT_CODE = ?, EXIT_MESSAGE = ?, VERSION = ?, READ_SKIP_COUNT = ?, PROCESS_SKIP_COUNT = ?, WRITE_SKIP_COUNT = ?, ROLLBACK_COUNT = ?, LAST_UPDATED = ? where STEP_EXECUTION_ID = ? and VERSION = ?]
2023-04-10T16:38:47.040Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:47.040Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT VERSION FROM BATCH_JOB_EXECUTION WHERE JOB_EXECUTION_ID=?]
2023-04-10T16:38:47.042Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:47.042Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [UPDATE BATCH_STEP_EXECUTION_CONTEXT SET SHORT_CONTEXT = ?, SERIALIZED_CONTEXT = ? WHERE STEP_EXECUTION_ID = ?]
2023-04-10T16:38:47.045Z  INFO 1 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [BilliProcessing] executed in 99ms
2023-04-10T16:38:47.045Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:47.045Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [UPDATE BATCH_STEP_EXECUTION set START_TIME = ?, END_TIME = ?, STATUS = ?, COMMIT_COUNT = ?, READ_COUNT = ?, FILTER_COUNT = ?, WRITE_COUNT = ?, EXIT_CODE = ?, EXIT_MESSAGE = ?, VERSION = ?, READ_SKIP_COUNT = ?, PROCESS_SKIP_COUNT = ?, WRITE_SKIP_COUNT = ?, ROLLBACK_COUNT = ?, LAST_UPDATED = ? where STEP_EXECUTION_ID = ? and VERSION = ?]
2023-04-10T16:38:47.046Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:47.046Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT VERSION FROM BATCH_JOB_EXECUTION WHERE JOB_EXECUTION_ID=?]
2023-04-10T16:38:47.048Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:47.048Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [UPDATE BATCH_JOB_EXECUTION_CONTEXT SET SHORT_CONTEXT = ?, SERIALIZED_CONTEXT = ? WHERE JOB_EXECUTION_ID = ?]
2023-04-10T16:38:47.051Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:47.052Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT VERSION FROM BATCH_JOB_EXECUTION WHERE JOB_EXECUTION_ID=?]
2023-04-10T16:38:47.055Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-04-10T16:38:47.056Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT COUNT(*) FROM BATCH_JOB_EXECUTION WHERE JOB_EXECUTION_ID = ?]
2023-04-10T16:38:47.057Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-04-10T16:38:47.057Z DEBUG 1 --- [           main] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [UPDATE BATCH_JOB_EXECUTION set START_TIME = ?, END_TIME = ?,  STATUS = ?, EXIT_CODE = ?, EXIT_MESSAGE = ?, VERSION = ?, CREATE_TIME = ?, LAST_UPDATED = ? where JOB_EXECUTION_ID = ? and VERSION = ?]
2023-04-10T16:38:47.069Z  INFO 1 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=BillingJob]] completed with the following parameters: [{'run.id':'{value=1, type=class java.lang.Long, identifying=true}'}] and the following status: [COMPLETED] in 129ms
2023-04-10T16:38:47.082Z  INFO 1 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown initiated...
2023-04-10T16:38:47.088Z  INFO 1 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown completed.

Native Memory Tracking:
...
```

ç¢ºèªã§ããŸã‚‰workloadã‚’å‰Šé™¤ã—ã¾ã™ã€‚


```
tanzu apps workload delete -n demo billing-job
```

---

TAPã‹ã‚‰CronJobã‚’ä½œæˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚TAPã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ã§å¯èƒ½æ€§ãŒåºƒãŒã‚Šã¾ã™ã­ã€‚

ã¡ãªã¿ã«ã€ã“ã®ãƒ–ãƒ­ã‚°ã‚’backupã—ã¦S3ã«ä¿å­˜ã™ã‚‹ãŸã‚ã®Workloadã¯[ã“ã¡ã‚‰](https://github.com/categolj/k8s-manifests/blob/main/lime-build/config/app/blog-api/backup-db.yaml)ã§ã™ã€‚