---
title: Tanzu Application Platform 1.1 (Full Profile) ã‚’minikubeã«Local Registryã‚’ä½¿ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒ¡ãƒ¢
tags: ["Kubernetes", "Cartographer", "minukube", "Tanzu", "TAP", "Knative"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP"]
---

[Tanzu Application Platform 1.1](https://docs.vmware.com/en/Tanzu-Application-Platform/1.1/tap//GUID-overview.html) ã‚’minikubeã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯TAPã‚’minikubeã«Local Registryã‚’ä½¿ã£ã¦Installã—ã€"Hello World"ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ†ã‚¹ãƒˆã¨ã‚¹ã‚­ãƒ£ãƒ³ã‚’çµŒã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ©Ÿèƒ½("Source Test Scan to URL")ã‚’è©¦ã—ã¾ã™ã€‚
ã€‚

**ç›®æ¬¡**
<!-- toc -->

### minikubeã‚¯ãƒ©ã‚¹ã‚¿ã®ä½œæˆ

CPUã¯8ã€ãƒ¡ãƒ¢ãƒªã¯16GBã§minikubeã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚

```
minikube start --memory=16384 --cpus=8 --disk-size=70GB  --kubernetes-version='1.22.10' --driver='hyperkit' --addons=metrics-server
```

### Local Registryã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

minikubeã®[registry addon](https://minikube.sigs.k8s.io/docs/handbook/registry/)ã ã¨Persistent VolumeãŒattachã•ã‚Œã¦ãŠã‚‰ãšã€`minikube stop`ã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã‚‹ã®ã§ã€
ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸæ¬¡ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ä½¿ã„ã¾ã™ã€‚

```yaml
cat <<EOF | kubectl apply -f-
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: kube-registry
  namespace: kube-system
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 30Gi 
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    kubernetes.io/minikube-addons: registry
  name: registry
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      actual-registry: "true"
  strategy:
    type: Recreate
  template:    
    metadata:
      labels:
        actual-registry: "true"
        kubernetes.io/minikube-addons: registry
    spec:
      containers:
      - image: registry:2.7.1@sha256:d5459fcb27aecc752520df4b492b08358a1912fcdfa454f7d2101d4b09991daa
        imagePullPolicy: IfNotPresent
        name: registry
        ports:
        - containerPort: 5000
          protocol: TCP
        env:
        - name: REGISTRY_STORAGE_DELETE_ENABLED
          value: "true"
        - name: REGISTRY_VALIDATION_DISABLED
          value: "true"
        - name: REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY
          value: /var/lib/registry
        volumeMounts:
        - name: image-store
          mountPath: /var/lib/registry        
      volumes:
      - name: image-store
        persistentVolumeClaim:
          claimName: kube-registry      
---
apiVersion: v1
kind: Service
metadata:
  labels:
    kubernetes.io/minikube-addons: registry
  name: registry
  namespace: kube-system
spec:
  type: ClusterIP
  ports:
  - port: 80
    name: http
    targetPort: 5000
  - port: 443
    name: https
    targetPort: 443
  selector:
    actual-registry: "true"
    kubernetes.io/minikube-addons: registry
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: registry-proxy
  namespace: kube-system
spec:
  selector:
    matchLabels:
      registry-proxy: "true"
  template:
    metadata:
      labels:
        registry-proxy: "true"
        kubernetes.io/minikube-addons: registry
    spec:
      containers:
      - image: gcr.io/google_containers/kube-registry-proxy:0.4@sha256:1040f25a5273de0d72c54865a8efd47e3292de9fb8e5353e3fa76736b854f2da
        imagePullPolicy: IfNotPresent
        name: registry-proxy
        ports:
        - name: registry
          containerPort: 80
          hostPort: 5000
        env:
        - name: REGISTRY_HOST
          value: registry.kube-system.svc.cluster.local
        - name: REGISTRY_PORT
          value: "80"
EOF
```

minikubeã®dockerãŒregistry serviceã®DNSåã‚’è§£æ±ºã§ãã‚‹ã‚ˆã†ã«ã€Nodeä¸Šã®`/etc/hosts`ã«registry serviceã®ClusterIPã‚’æ˜ç¤ºã—ã¾ã™ã€‚

```
echo "$(kubectl get svc -n kube-system registry -ojsonpath='{.spec.clusterIP}')\tregistry.kube-system.svc.cluster.local" | minikube ssh --native-ssh=false "sudo tee -a /etc/hosts"
```

### Cluster Essentials for VMware Tanzuã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

TAPã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¿…è¦ãªKapp Controllerã¨Secretgen Controllerã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã« [Cluster Essentials for VMware Tanzu](https://network.tanzu.vmware.com/products/tanzu-cluster-essentials/#/releases/1077299) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
# Mac
pivnet download-product-files --product-slug='tanzu-cluster-essentials' --release-version='1.1.0' --product-file-id=1191985
# Linux
pivnet download-product-files --product-slug='tanzu-cluster-essentials' --release-version='1.1.0' --product-file-id=1191987
# Windows
pivnet download-product-files --product-slug='tanzu-cluster-essentials' --release-version='1.1.0' --product-file-id=1191983
```

Cluster Essentialsã®imgpkg bundleã‚’local registryã«relocateã—ã¾ã™ã€‚

ã¾ãšã¯TanzuNet Registryã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

```yaml
TANZUNET_USERNAME=...
TANZUNET_PASSWORD=...

docker login registry.tanzu.vmware.com -u ${TANZUNET_USERNAME} -p ${TANZUNET_PASSWORD}
```

Cluster Essentialsã®imgpkg bundleã‚’tarãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚

```
imgpkg copy -b registry.tanzu.vmware.com/tanzu-cluster-essentials/cluster-essentials-bundle:1.1.0 --to-tar ~/cluster-essentials-bundle-1.1.0.tar
```

localhost:5000ã§registryã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«port-forwardã—ã¾ã™ã€‚

```
kubectl port-forward --namespace kube-system service/registry 5000:80
```

tarãƒ•ã‚¡ã‚¤ãƒ«ã®imgpkg bundleã‚’localhost:5000ã«relocateã—ã¾ã™ã€‚

```
imgpkg copy --tar ~/cluster-essentials-bundle-1.1.0.tar --to-repo localhost:5000/tanzu-cluster-essentials/cluster-essentials-bundle
```

relocateã—ãŸimgpkg bundleã‚’ä½¿ã£ã¦Cluster Essentialsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
mkdir tanzu-cluster-essentials
tar xzvf tanzu-cluster-essentials-*-amd64-1.1.0.tgz -C tanzu-cluster-essentials

cd tanzu-cluster-essentials

export INSTALL_REGISTRY_HOSTNAME=localhost:5000
export INSTALL_REGISTRY_USERNAME=admin
export INSTALL_REGISTRY_PASSWORD=admin
export INSTALL_BUNDLE=${INSTALL_REGISTRY_HOSTNAME}/tanzu-cluster-essentials/cluster-essentials-bundle:1.1.0

./install.sh --yes
cd ..
```

Podä¸€è¦§ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ kubectl get pod -A
NAMESPACE              NAME                                    READY   STATUS    RESTARTS   AGE
kapp-controller        kapp-controller-77f5f4c9bc-m8cgj       1/1     Running   0          39s
kube-system            coredns-78fcd69978-7mpv4               1/1     Running   0          3m11s
kube-system            etcd-minikube                          1/1     Running   0          3m24s
kube-system            kube-apiserver-minikube                1/1     Running   0          3m23s
kube-system            kube-controller-manager-minikube       1/1     Running   0          3m23s
kube-system            kube-proxy-rfdlm                       1/1     Running   0          3m11s
kube-system            kube-scheduler-minikube                1/1     Running   0          3m23s
kube-system            metrics-server-77c99ccb96-gsth7        1/1     Running   0          3m11s
kube-system            registry-657bcfbc99-sm8q9              1/1     Running   0          3m4s
kube-system            registry-proxy-pg28r                   1/1     Running   0          3m4s
kube-system            storage-provisioner                    1/1     Running   0          3m22s
secretgen-controller   secretgen-controller-78ff4f45c-7jhdk   1/1     Running   0          18s

$ kubectl top node
NAME       CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   
minikube   151m         1%     1510Mi          9%  
```



### Tanzu Application Platformã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«


#### TAPç”¨Package Repositoryã®ç™»éŒ²

TAPã®imgpkg bundleã‚’tarãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚ ç´„16GBã‚ã‚‹ã®ã§ã‹ãªã‚Šæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚

> ğŸ‘† tarãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµŒç”±ã›ãšã«ç›´æ¥registryã«copyã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€<br>å¤±æ•—ã—ãŸã¨ãã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‹ã‚‰ã‚„ã‚Šç›´ã—ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€<br>è©¦è¡ŒéŒ¯èª¤ã‚’è¦‹è¶Šã—ã¦tarã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠã„ãŸæ–¹ãŒåŠ¹ç‡çš„ã§ã™ã€‚

```
TAP_VERSION=1.1.1
imgpkg copy -b registry.tanzu.vmware.com/tanzu-application-platform/tap-packages:${TAP_VERSION} --to-tar ~/tap-${TAP_VERSION}.tar
```

tarãƒ•ã‚¡ã‚¤ãƒ«ã®imgpkg bundleã‚’localhost:5000ã«relocateã—ã¾ã™ã€‚

```
imgpkg copy --tar ~/tap-${TAP_VERSION}.tar --to-repo localhost:5000/tanzu-application-platform/tap-packages
```

Package Repositoryã®è¨­å®šã‚’ã—ã¾ã™ã€‚kapp controllerãŒlocalhost:5000ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã‹ã£ãŸã®ã§ã€ãƒ›ã‚¹ãƒˆåã«ã¯registry.kube-system.svc.cluster.localã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
kubectl create ns tap-install

tanzu secret registry add tap-registry \
  --username "${INSTALL_REGISTRY_USERNAME}" \
  --password "${INSTALL_REGISTRY_PASSWORD}" \
  --server registry.kube-system.svc.cluster.local \
  --export-to-all-namespaces \
  --yes \
  --namespace tap-install

tanzu package repository add tanzu-tap-repository \
  --url registry.kube-system.svc.cluster.local/tanzu-application-platform/tap-packages:${TAP_VERSION} \
  --namespace tap-install
```

åˆ©ç”¨å¯èƒ½ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ tanzu package available list --namespace tap-install
  NAME                                                 DISPLAY-NAME                                                              SHORT-DESCRIPTION                                                                                                                                              LATEST-VERSION  
  accelerator.apps.tanzu.vmware.com                    Application Accelerator for VMware Tanzu                                  Used to create new projects and configurations.                                                                                                                1.1.2           
  api-portal.tanzu.vmware.com                          API portal                                                                A unified user interface to enable search, discovery and try-out of API endpoints at ease.                                                                     1.0.15          
  backend.appliveview.tanzu.vmware.com                 Application Live View for VMware Tanzu                                    App for monitoring and troubleshooting running apps                                                                                                            1.1.1           
  build.appliveview.tanzu.vmware.com                   Application Live View Conventions for VMware Tanzu                        Application Live View convention server                                                                                                                        1.0.2           
  buildservice.tanzu.vmware.com                        Tanzu Build Service                                                       Tanzu Build Service enables the building and automation of containerized software workflows securely and at scale.                                             1.5.1           
  cartographer.tanzu.vmware.com                        Cartographer                                                              Kubernetes native Supply Chain Choreographer.                                                                                                                  0.3.0           
  cnrs.tanzu.vmware.com                                Cloud Native Runtimes                                                     Cloud Native Runtimes is a serverless runtime based on Knative                                                                                                 1.2.0           
  connector.appliveview.tanzu.vmware.com               Application Live View Connector for VMware Tanzu                          App for discovering and registering running apps                                                                                                               1.1.1           
  controller.conventions.apps.tanzu.vmware.com         Convention Service for VMware Tanzu                                       Convention Service enables app operators to consistently apply desired runtime configurations to fleets of workloads.                                          0.6.3           
  controller.source.apps.tanzu.vmware.com              Tanzu Source Controller                                                   Tanzu Source Controller enables workload create/update from source code.                                                                                       0.3.3           
  conventions.appliveview.tanzu.vmware.com             Application Live View Conventions for VMware Tanzu                        Application Live View convention server                                                                                                                        1.1.1           
  developer-conventions.tanzu.vmware.com               Tanzu App Platform Developer Conventions                                  Developer Conventions                                                                                                                                          0.6.0           
  fluxcd.source.controller.tanzu.vmware.com            Flux Source Controller                                                    The source-controller is a Kubernetes operator, specialised in artifacts acquisition from external sources such as Git, Helm repositories and S3 buckets.      0.16.4          
  grype.scanning.apps.tanzu.vmware.com                 Grype for Supply Chain Security Tools - Scan                              Default scan templates using Anchore Grype                                                                                                                     1.1.1           
  image-policy-webhook.signing.apps.tanzu.vmware.com   Image Policy Webhook                                                      Image Policy Webhook enables defining of a policy to restrict unsigned container images.                                                                       1.1.2           
  learningcenter.tanzu.vmware.com                      Learning Center for Tanzu Application Platform                            Guided technical workshops                                                                                                                                     0.2.0           
  metadata-store.apps.tanzu.vmware.com                 Supply Chain Security Tools - Store                                       Post SBoMs and query for image, package, and vulnerability metadata.                                                                                           1.1.3           
  ootb-delivery-basic.tanzu.vmware.com                 Tanzu App Platform Out of The Box Delivery Basic                          Out of The Box Delivery Basic.                                                                                                                                 0.7.1           
  ootb-supply-chain-basic.tanzu.vmware.com             Tanzu App Platform Out of The Box Supply Chain Basic                      Out of The Box Supply Chain Basic.                                                                                                                             0.7.1           
  ootb-supply-chain-testing-scanning.tanzu.vmware.com  Tanzu App Platform Out of The Box Supply Chain with Testing and Scanning  Out of The Box Supply Chain with Testing and Scanning.                                                                                                         0.7.1           
  ootb-supply-chain-testing.tanzu.vmware.com           Tanzu App Platform Out of The Box Supply Chain with Testing               Out of The Box Supply Chain with Testing.                                                                                                                      0.7.1           
  ootb-templates.tanzu.vmware.com                      Tanzu App Platform Out of The Box Templates                               Out of The Box Templates.                                                                                                                                      0.7.1           
  run.appliveview.tanzu.vmware.com                     Application Live View for VMware Tanzu                                    App for monitoring and troubleshooting running apps                                                                                                            1.0.3           
  scanning.apps.tanzu.vmware.com                       Supply Chain Security Tools - Scan                                        Scan for vulnerabilities and enforce policies directly within Kubernetes native Supply Chains.                                                                 1.1.1           
  service-bindings.labs.vmware.com                     Service Bindings for Kubernetes                                           Service Bindings for Kubernetes implements the Service Binding Specification.                                                                                  0.7.1           
  services-toolkit.tanzu.vmware.com                    Services Toolkit                                                          The Services Toolkit enables the management, lifecycle, discoverability and connectivity of Service Resources (databases, message queues, DNS records, etc.).  0.6.0           
  spring-boot-conventions.tanzu.vmware.com             Tanzu Spring Boot Conventions Server                                      Default Spring Boot convention server.                                                                                                                         0.4.0           
  tap-auth.tanzu.vmware.com                            Default roles for Tanzu Application Platform                              Default roles for Tanzu Application Platform                                                                                                                   1.0.1           
  tap-gui.tanzu.vmware.com                             Tanzu Application Platform GUI                                            web app graphical user interface for Tanzu Application Platform                                                                                                1.1.1           
  tap-telemetry.tanzu.vmware.com                       Telemetry Collector for Tanzu Application Platform                        Tanzu Application Plaform Telemetry                                                                                                                            0.1.4           
  tap.tanzu.vmware.com                                 Tanzu Application Platform                                                Package to install a set of TAP components to get you started based on your use case.                                                                          1.1.1           
  tekton.tanzu.vmware.com                              Tekton Pipelines                                                          Tekton Pipelines is a framework for creating CI/CD systems.                                                                                                    0.33.5          
  workshops.learningcenter.tanzu.vmware.com            Workshop Building Tutorial                                                Workshop Building Tutorial                                                                                                                                     0.2.0
```

#### Full Profileã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

TAPã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã®`tap-values.yml`ã‚’ä½œæˆã—ã¾ã™ã€‚
`cnrs.domain_name`ã«ã¯ä»®ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã‚ã¨ã§envoyã®External IPãŒè¨­å®šã•ã‚Œã¦ã‹ã‚‰å¤‰æ›´ã—ã¾ã™ã€‚

> â„¹ï¸ grype packageã¯ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã›ãšã€`excluded_packages`ã«åŠ ãˆã¦é™¤å¤–ã—ã¾ã™ã€‚<br>
> TAP 1.1ã§ã¯grype packageã¯namespaceã”ã¨ã«å¿…è¦ã§ã™ã€‚<br>
> profileã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã¯ã€1ã¤ã®namespaceã«ã—ã‹grype packageãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œãšä¸­é€”åŠç«¯ãªã®ã§ã€ãã‚Œã‚’é™¤å¤–ã—ã¦å¾Œã«å€‹åˆ¥ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```yaml
cat <<EOF > tap-values.yml
profile: full

ceip_policy_disclosed: true

cnrs:
  domain_name: tap.example.com
  domain_template: "{{.Name}}-{{.Namespace}}.{{.Domain}}"
  default_tls_secret: tanzu-system-ingress/cnrs-default-tls
  provider: local

buildservice:
  kp_default_repository: registry.kube-system.svc.cluster.local/build-service
  kp_default_repository_username: admin
  kp_default_repository_password: admin
  tanzunet_username: ${TANZUNET_USERNAME}
  tanzunet_password: ${TANZUNET_PASSWORD}
  enable_automatic_dependency_updates: true

supply_chain: testing_scanning

ootb_supply_chain_testing_scanning:
  registry:
    server: registry.kube-system.svc.cluster.local
    repository: supplychain

contour:
  envoy:
    service:
      type: LoadBalancer
      externalTrafficPolicy: Local

learningcenter:
  ingressDomain: learningcenter.tap.example.com
  ingressSecret:
    secretName: learningcenter-tls

tap_gui:
  ingressEnabled: true
  ingressDomain: tap.example.com
  service_type: ClusterIP
  tls:
    secretName: cnrs-default-tls
    namespace: tanzu-system-ingress
  app_config:
    app:
      baseUrl: https://tap-gui.tap.example.com
    backend:
      baseUrl: https://tap-gui.tap.example.com
      cors:
        origin: https://tap-gui.tap.example.com
    catalog:
      locations:
      - type: url
        target: https://github.com/sample-accelerators/tanzu-java-web-app/blob/main/catalog/catalog-info.yaml
      - type: url
        target: https://github.com/sample-accelerators/spring-petclinic/blob/accelerator/catalog/catalog-info.yaml
      - type: url
        target: https://github.com/tanzu-japan/spring-music/blob/tanzu/catalog/catalog-info.yaml

accelerator:
  domain: tap.example.com
  ingress:
    include: true
    enable_tls: true
  tls:
    secret_name: cnrs-default-tls
    namespace: tanzu-system-ingress
  server:
    service_type: ClusterIP

metadata_store:
  app_service_type: ClusterIP
  ingress_enabled: "true"
  ingress_domain: tap.example.com

package_overlays:
- name: cnrs
  secrets:
  - name: cnrs-default-tls
- name: learningcenter
  secrets:
  - name: learningcenter-certificate
- name: metadata-store
  secrets:
  - name: metadata-store-ingress-tls
excluded_packages:
- grype.scanning.apps.tanzu.vmware.com    
EOF
```

Cloud Native Runtimesã§ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®TLSè¨¼æ˜æ›¸ã‚’ç”¨æ„ã™ã‚‹ãŸã‚ã®æ¬¡ã®å®šç¾©ã‚’overlayã§ä½œæˆã—ã¾ã™ã€‚ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

* https://docs.vmware.com/en/Cloud-Native-Runtimes-for-VMware-Tanzu/1.1/tanzu-cloud-native-runtimes-1-1/GUID-external_dns.html
* https://knative.dev/docs/serving/using-a-tls-cert/#manually-adding-a-tls-certificate

```yaml
cat <<EOF > cnrs-default-tls.yml
#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")
#@ namespace = data.values.ingress.external.namespace
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: cnrs-selfsigned-issuer
  namespace: #@ namespace
spec:
  selfSigned: { }
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: cnrs-ca
  namespace: #@ namespace
spec:
  commonName: cnrs-ca
  isCA: true
  issuerRef:
    kind: Issuer
    name: cnrs-selfsigned-issuer
  secretName: cnrs-ca
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: cnrs-ca-issuer
  namespace: #@ namespace
spec:
  ca:
    secretName: cnrs-ca
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: cnrs-default-tls
  namespace: #@ namespace
spec:
  dnsNames:
  - #@ "*.{}".format(data.values.domain_name)
  issuerRef:
    kind: Issuer
    name: cnrs-ca-issuer
  secretName: cnrs-default-tls
---
apiVersion: projectcontour.io/v1
kind: TLSCertificateDelegation
metadata:
  name: contour-delegation
  namespace: #@ namespace
spec:
  delegations:
  - secretName: cnrs-default-tls
    targetNamespaces:
    - "*"
#@overlay/match by=overlay.subset({"metadata":{"name":"config-network"}, "kind": "ConfigMap"})
---
data:
  #@overlay/match missing_ok=True
  default-external-scheme: https
EOF
```

Cloud Native Runtimesã‹ã‚‰Knative Servingä»¥å¤–ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹overlayã‚’ä½œæˆã—ã¾ã™ã€‚
Learning Centerã«TLSè¨¼æ˜æ›¸ã®

```yaml
cat <<EOF > learningcenter-certificate.yml
#@ load("@ytt:data", "data")
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: learningcenter-selfsigned-issuer
  namespace: #@ data.values.namespace
spec:
  selfSigned: { }
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: learningcenter-ca
  namespace: #@ data.values.namespace
spec:
  commonName: learningcenter-ca
  isCA: true
  issuerRef:
    kind: Issuer
    name: learningcenter-selfsigned-issuer
  secretName: learningcenter-ca
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: learningcenter-ca-issuer
  namespace: #@ data.values.namespace
spec:
  ca:
    secretName: learningcenter-ca
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: learningcenter-tls
  namespace: #@ data.values.namespace
spec:
  dnsNames:
  - #@ data.values.ingressDomain
  - #@ "*.{}".format(data.values.ingressDomain)    
  issuerRef:
    kind: Issuer
    name: learningcenter-ca-issuer
  secretName: learningcenter-tls
EOF
```

Metadata Storeã«Cloud Native Runtimesã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®TLSè¨¼æ˜æ›¸ã‚’ä½¿ã†overlayã‚’ä½œæˆã—ã¾ã™ã€‚

> â„¹ï¸ Learning Centerã¨é•ã£ã¦Metadata Storeã¯Contourã®HTTPProxyã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€<br>
> [TLSCertificateDelegation](https://projectcontour.io/docs/v1.18.2/config/tls-delegation/)ã§Cloud Native Runtimesç”¨ã®TLSè¨¼æ˜æ›¸ã‚’ä½¿ãˆã¾ã™ã€‚<br>
> Learning Centerã¯Ingressã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã€TAP 1.1ã«å«ã¾ã‚Œã‚‹Contour 1.18.2ã§ã¯TLSCertificateDelegationã¯ä½¿ãˆã¾ã›ã‚“ã€‚<br>
> [Contour 1.20](https://projectcontour.io/docs/v1.20.0/config/tls-delegation/)ã‹ã‚‰Ingresã§ã‚‚TLSCertificateDelegationãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```yaml
cat <<EOF > metadata-store-ingress-tls.yml
#@ load("@ytt:overlay", "overlay")
#@overlay/match by=overlay.subset({"metadata":{"name":"metadata-store-ingress"}, "kind": "HTTPProxy"})
---
spec:
  virtualhost:
    tls:
      secretName: tanzu-system-ingress/cnrs-default-tls
#@overlay/match by=overlay.subset({"metadata":{"name":"ingress-cert"}, "kind": "Certificate"})
#@overlay/remove
---
EOF
```

overlayãƒ•ã‚¡ã‚¤ãƒ«ã‚’Secretã¨ã—ã¦ä½œæˆã—ã¾ã™ã€‚

```
kubectl -n tap-install create secret generic cnrs-default-tls \
  -o yaml \
  --dry-run=client \
  --from-file=cnrs-default-tls.yml \
  | kubectl apply -f-

kubectl -n tap-install create secret generic learningcenter-certificate \
  -o yaml \
  --dry-run=client \
  --from-file=learningcenter-certificate.yml \
  | kubectl apply -f-

kubectl -n tap-install create secret generic metadata-store-ingress-tls \
  -o yaml \
  --dry-run=client \
  --from-file=metadata-store-ingress-tls.yml \
  | kubectl apply -f-
```

LoadBalancer Serviceã‚’ä½œæˆã§ãã‚‹ã‚ˆã†ã«åˆ¥ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§`minikube tunnel`ã‚’å®Ÿè¡Œã—ã¦ãŠãã¾ã™ã€‚

```
minikube tunnel
```

TAPã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
tanzu package install tap -p tap.tanzu.vmware.com -v ${TAP_VERSION} --values-file tap-values.yml -n tap-install
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®é€²æ—ã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã—ã¾ã™ã€‚

```
watch kubectl get app -n tap-install
```

å…¨ã¦ã®appãŒ `Reconcile succeeded` ã«ãªã‚‹ã¾ã§å¾…ã¡ã¾ã™ã€‚

```
$ kubectl get app -n tap-install 
NAME                       DESCRIPTION           SINCE-DEPLOY   AGE
appliveview-conventions    Reconcile succeeded   10m            11m
buildservice               Reconcile succeeded   17m            17m
cartographer               Reconcile succeeded   19s            12m
cert-manager               Reconcile succeeded   68s            17m
cnrs                       Reconcile succeeded   10m            11m
contour                    Reconcile succeeded   3m9s           12m
conventions-controller     Reconcile succeeded   12m            12m
developer-conventions      Reconcile succeeded   10m            11m
fluxcd-source-controller   Reconcile succeeded   18s            17m
ootb-delivery-basic        Reconcile succeeded   4s             10m
ootb-supply-chain-basic    Reconcile succeeded   2s             10m
ootb-templates             Reconcile succeeded   18s            11m
service-bindings           Reconcile succeeded   10m            17m
services-toolkit           Reconcile succeeded   19s            17m
source-controller          Reconcile succeeded   28s            17m
spring-boot-conventions    Reconcile succeeded   10m            11m
tap                        Reconcile succeeded   3m3s           18m
tap-auth                   Reconcile succeeded   7m50s          17m
tap-telemetry              Reconcile succeeded   25s            17m
tekton-pipelines           Reconcile succeeded   25s            17m
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

````
$ kubectl get packageinstall -n tap-install 
NAME                                 PACKAGE NAME                                          PACKAGE VERSION   DESCRIPTION           AGE
accelerator                          accelerator.apps.tanzu.vmware.com                     1.1.2             Reconcile succeeded   15m
api-portal                           api-portal.tanzu.vmware.com                           1.0.15            Reconcile succeeded   17m
appliveview                          backend.appliveview.tanzu.vmware.com                  1.1.1             Reconcile succeeded   15m
appliveview-connector                connector.appliveview.tanzu.vmware.com                1.1.1             Reconcile succeeded   17m
appliveview-conventions              conventions.appliveview.tanzu.vmware.com              1.1.1             Reconcile succeeded   15m
buildservice                         buildservice.tanzu.vmware.com                         1.5.1             Reconcile succeeded   17m
cartographer                         cartographer.tanzu.vmware.com                         0.3.0             Reconcile succeeded   16m
cert-manager                         cert-manager.tanzu.vmware.com                         1.5.3+tap.2       Reconcile succeeded   17m
cnrs                                 cnrs.tanzu.vmware.com                                 1.2.0             Reconcile succeeded   15m
contour                              contour.tanzu.vmware.com                              1.18.2+tap.2      Reconcile succeeded   16m
conventions-controller               controller.conventions.apps.tanzu.vmware.com          0.6.3             Reconcile succeeded   16m
developer-conventions                developer-conventions.tanzu.vmware.com                0.6.0             Reconcile succeeded   15m
fluxcd-source-controller             fluxcd.source.controller.tanzu.vmware.com             0.16.4            Reconcile succeeded   17m
image-policy-webhook                 image-policy-webhook.signing.apps.tanzu.vmware.com    1.1.2             Reconcile succeeded   16m
learningcenter                       learningcenter.tanzu.vmware.com                       0.2.0             Reconcile succeeded   15m
learningcenter-workshops             workshops.learningcenter.tanzu.vmware.com             0.2.0             Reconcile succeeded   12m
metadata-store                       metadata-store.apps.tanzu.vmware.com                  1.1.3             Reconcile succeeded   16m
ootb-delivery-basic                  ootb-delivery-basic.tanzu.vmware.com                  0.7.1             Reconcile succeeded   15m
ootb-supply-chain-testing-scanning   ootb-supply-chain-testing-scanning.tanzu.vmware.com   0.7.1             Reconcile succeeded   15m
ootb-templates                       ootb-templates.tanzu.vmware.com                       0.7.1             Reconcile succeeded   15m
scanning                             scanning.apps.tanzu.vmware.com                        1.1.1             Reconcile succeeded   17m
service-bindings                     service-bindings.labs.vmware.com                      0.7.1             Reconcile succeeded   17m
services-toolkit                     services-toolkit.tanzu.vmware.com                     0.6.0             Reconcile succeeded   17m
source-controller                    controller.source.apps.tanzu.vmware.com               0.3.3             Reconcile succeeded   17m
spring-boot-conventions              spring-boot-conventions.tanzu.vmware.com              0.4.0             Reconcile succeeded   15m
tap                                  tap.tanzu.vmware.com                                  1.1.1             Reconcile succeeded   17m
tap-auth                             tap-auth.tanzu.vmware.com                             1.0.1             Reconcile succeeded   17m
tap-gui                              tap-gui.tanzu.vmware.com                              1.1.1             Reconcile succeeded   15m
tap-telemetry                        tap-telemetry.tanzu.vmware.com                        0.1.4             Reconcile succeeded   17m
tekton-pipelines                     tekton.tanzu.vmware.com                               0.33.5            Reconcile succeeded   17m
````

ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸPodã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

```
$ kubectl get pod -A
NAMESPACE                   NAME                                                   READY   STATUS    RESTARTS        AGE
accelerator-system          acc-engine-78f769485-59968                             1/1     Running   0               9m47s
accelerator-system          acc-server-7f9d97b8c5-bg7z9                            1/1     Running   0               9m47s
accelerator-system          accelerator-controller-manager-86888b7d46-vhfdm        1/1     Running   0               9m47s
api-portal                  api-portal-server-8648d5fb89-ctb2b                     1/1     Running   0               12m
app-live-view-connector     application-live-view-connector-c5psm                  1/1     Running   0               10m
app-live-view-conventions   appliveview-webhook-866c899f9-d6w2d                    1/1     Running   0               9m50s
app-live-view               application-live-view-server-6dfd6dd66d-2lbpw          1/1     Running   0               9m43s
build-service               build-pod-image-fetcher-jcvvb                          5/5     Running   1               12m
build-service               dependency-updater-controller-5475b8965d-lshcr         1/1     Running   0               12m
build-service               secret-syncer-controller-5d8cf9c946-6gqfl              1/1     Running   0               12m
build-service               smart-warmer-image-fetcher-x7lhh                       2/2     Running   0               3m54s
build-service               warmer-controller-fc5cb9f4f-pwvlc                      1/1     Running   0               12m
cartographer-system         cartographer-controller-6bcb897958-47p6x               1/1     Running   1 (10m ago)     10m
cert-injection-webhook      cert-injection-webhook-7787b9986f-gf5pj                1/1     Running   0               12m
cert-manager                cert-manager-64b8df8577-794dc                          1/1     Running   0               12m
cert-manager                cert-manager-cainjector-fc7b97d8f-kxs2s                1/1     Running   0               12m
cert-manager                cert-manager-webhook-6bd5fd655d-jbqjz                  1/1     Running   0               12m
conventions-system          conventions-controller-manager-7b465b66dc-4659k        1/1     Running   0               10m
developer-conventions       webhook-ddb9c4458-z7w2h                                1/1     Running   0               9m46s
flux-system                 source-controller-99685b6-2ltb8                        1/1     Running   0               12m
image-policy-system         image-policy-controller-manager-7f4c49c69-lp5gp        2/2     Running   0               10m
kapp-controller             kapp-controller-77f5f4c9bc-m8cgj                       1/1     Running   0               20m
knative-eventing            eventing-controller-6fbfcc5bb8-lvc6p                   1/1     Running   0               7m20s
knative-eventing            eventing-webhook-644fb648db-46bcw                      1/1     Running   0               7m19s
knative-eventing            imc-controller-68f8bdb587-fcx82                        1/1     Running   0               7m19s
knative-eventing            imc-dispatcher-55b9f59b68-5r7ln                        1/1     Running   0               7m19s
knative-eventing            mt-broker-controller-5985645df6-qv6x7                  1/1     Running   0               7m18s
knative-eventing            mt-broker-filter-699bcb6855-bx6kn                      1/1     Running   0               7m19s
knative-eventing            mt-broker-ingress-5cd6b7fd77-mqhqt                     1/1     Running   0               7m19s
knative-eventing            rabbitmq-broker-controller-5d57b4d7-ctnsl              1/1     Running   0               7m18s
knative-eventing            rabbitmq-broker-webhook-bcd447fc8-cfw2z                1/1     Running   0               7m18s
knative-eventing            sugar-controller-57c6d7c57f-8ghfb                      1/1     Running   0               7m17s
knative-serving             activator-65cb9484b8-xh7sh                             1/1     Running   0               7m22s
knative-serving             autoscaler-774576b74d-67zg5                            1/1     Running   0               7m22s
knative-serving             autoscaler-hpa-6d95467b49-x54ck                        1/1     Running   0               7m20s
knative-serving             controller-5c799cb8b6-pnvlr                            1/1     Running   0               7m22s
knative-serving             domain-mapping-6d654bb469-wcrmg                        1/1     Running   0               7m22s
knative-serving             domainmapping-webhook-59697b8c57-d4cnm                 1/1     Running   0               7m22s
knative-serving             net-certmanager-controller-57b5dc4976-zll24            1/1     Running   0               7m17s
knative-serving             net-certmanager-webhook-7c45474bb-ts5f7                1/1     Running   0               7m17s
knative-serving             net-contour-controller-85655dcc8c-vgbw4                1/1     Running   0               7m20s
knative-serving             webhook-7c6bbf8c46-75zxl                               1/1     Running   0               7m20s
knative-sources             rabbitmq-controller-manager-6945c46764-b7vww           1/1     Running   0               7m18s
knative-sources             rabbitmq-webhook-79c4bfd9c7-wv8qb                      1/1     Running   0               7m18s
kpack                       kpack-controller-7866c49666-t4b28                      1/1     Running   0               12m
kpack                       kpack-webhook-8bb9d7bff-2dvg7                          1/1     Running   0               12m
kube-system                 coredns-78fcd69978-7mpv4                               1/1     Running   0               23m
kube-system                 etcd-minikube                                          1/1     Running   0               23m
kube-system                 kube-apiserver-minikube                                1/1     Running   0               23m
kube-system                 kube-controller-manager-minikube                       1/1     Running   0               23m
kube-system                 kube-proxy-rfdlm                                       1/1     Running   0               23m
kube-system                 kube-scheduler-minikube                                1/1     Running   0               23m
kube-system                 metrics-server-77c99ccb96-gsth7                        1/1     Running   0               23m
kube-system                 registry-657bcfbc99-sm8q9                              1/1     Running   0               23m
kube-system                 registry-proxy-pg28r                                   1/1     Running   0               23m
kube-system                 storage-provisioner                                    1/1     Running   0               23m
learning-center-guided-ui   learningcenter-portal-75b498f58f-4pq2j                 1/1     Running   0               4m47s
learningcenter              learningcenter-operator-55dddcbd7b-tstft               1/1     Running   0               9m41s
learningcenter              learningcenter-prepull-wlk26                           1/1     Running   0               9m41s
metadata-store              metadata-store-app-76d67dfc44-dpdw6                    2/2     Running   1 (9m56s ago)   10m
metadata-store              metadata-store-db-0                                    1/1     Running   0               10m
scan-link-system            scan-link-controller-manager-7bc5b8786-5mpgb           2/2     Running   1 (11m ago)     12m
secretgen-controller        secretgen-controller-78ff4f45c-7jhdk                   1/1     Running   0               20m
service-bindings            manager-6587d7895f-6hvxs                               1/1     Running   0               12m
services-toolkit            services-toolkit-controller-manager-844b6857cd-xqnpc   1/1     Running   0               12m
source-system               source-controller-manager-bf7db8d86-w5zpd              1/1     Running   0               12m
spring-boot-convention      spring-boot-webhook-fccd959cd-mfrbm                    1/1     Running   0               9m41s
stacks-operator-system      controller-manager-df9d7cf7b-xpqq8                     1/1     Running   0               12m
tanzu-system-ingress        contour-75865b87c6-764bz                               1/1     Running   0               10m
tanzu-system-ingress        contour-75865b87c6-z2c95                               1/1     Running   0               10m
tanzu-system-ingress        envoy-7gjgh                                            2/2     Running   0               10m
tap-gui                     server-8469c69dbc-6xcqw                                1/1     Running   0               9m25s
tap-telemetry               tap-telemetry-controller-66db7875bb-ltf2b              1/1     Running   0               11m
tekton-pipelines            tekton-pipelines-controller-8c9f7fb95-srjz7            1/1     Running   0               12m
tekton-pipelines            tekton-pipelines-webhook-648bffcdcb-rwjsv              1/1     Running   0               12m
triggermesh                 aws-event-sources-controller-6bf4c8479c-x4gbq          1/1     Running   0               7m16s
vmware-sources              webhook-54b6b77f4b-9vgxc                               1/1     Running   0               7m17s

$ kubectl top node
NAME       CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   
minikube   2044m        25%    6590Mi          41%   
```

Envoyã«è¨­å®šã•ã‚ŒãŸExternal IPã‚’ä½¿ã£ã¦ã€`cnrs.domain_name`ã‚’å¤‰æ›´ã—ã¾ã™ã€‚ãƒ‰ãƒ¡ã‚¤ãƒ³åã«ã¯[sslip.io](https://sslip.io)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
ä¾‹ãˆã°ã€External IPãŒ10.105.146.158ã®å ´åˆã«ã€`cnrs.domain_name`ã«*.10-105-146-158.sslip.ioã‚’æŒ‡å®šã—ã¾ã™ã€‚

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§`tap-values.yml`ã‚’æ›´æ–°ã—ã¾ã™ã€‚

```
sed -i.bak "s|tap.example.com|$(kubectl get -n tanzu-system-ingress svc envoy -ojsonpath='{.status.loadBalancer.ingress[0].ip}' | sed 's/\./-/g').sslip.io|g" tap-values.yml
```

TAPã‚’æ›´æ–°ã—ã¾ã™ã€‚

```
tanzu package installed update tap -n tap-install -v ${TAP_VERSION} -f tap-values.yml 
```

Default TLSã®Certificateã®DNSåãŒæ›´æ–°ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ kubectl get certificate -n tanzu-system-ingress cnrs-default-tls -ojsonpath='{.spec.dnsNames[0]}'
*.10-105-146-158.sslip.io

$ kubectl get certificate -n learningcenter learningcenter-tls -ojsonpath='{.spec.dnsNames[0]}'
learningcenter.10-105-146-158.sslip.io
```

> ğŸ‘† sslip.ioã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ç’°å¢ƒã®å ´åˆã¯ã€<br>
> ãƒ©ãƒƒãƒ—ãƒˆãƒƒãƒ—ä¸Šã®`/etc/hosts`ã«ä»Šå¾Œä½¿ç”¨ã™ã‚‹`127.0.0.1 <...>.tap.example.com`ã‚’ä¸€ã¤ãšã¤è¨­å®šã—ã¦ãã ã•ã„ã€‚

### Workloadã®ãƒ‡ãƒ—ãƒ­ã‚¤

#### Workloadã‚’ä½œæˆã™ã‚‹ãŸã‚ã®äº‹å‰æº–å‚™

##### RBACã®è¨­å®š

https://docs.vmware.com/en/Tanzu-Application-Platform/1.1/tap/GUID-install-components.html#setup
(ä¸€éƒ¨å¤‰æ›´ã—ã¦ã„ã¾ã™)

```
kubectl create ns demo
tanzu secret registry add registry-credentials --server registry.kube-system.svc.cluster.local --username admin --password admin --namespace demo
```

```yaml
cat <<EOF | kubectl -n demo apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: tap-registry
  annotations:
    secretgen.carvel.dev/image-pull-secret: ""
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: e30K
---
apiVersion: v1
kind: Secret
metadata:
  name: git-ssh
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: default
secrets:
  - name: registry-credentials
  - name: git-ssh
imagePullSecrets:
  - name: registry-credentials
  - name: tap-registry
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: default-permit-deliverable
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: deliverable
subjects:
  - kind: ServiceAccount
    name: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: default-permit-workload
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: workload
subjects:
  - kind: ServiceAccount
    name: default
EOF
```

##### Tekton Pipelineã®ä½œæˆ

https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.1/tap/GUID-scc-ootb-supply-chain-testing.html

ä»Šå›ã¯ãƒ†ã‚¹ãƒˆã¯ç©ºå®Ÿè£…ã«ã—ã¾ã™ã€‚

```yaml
cat <<'EOF' | kubectl -n demo apply -f -
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: developer-defined-tekton-pipeline
  labels:
    apps.tanzu.vmware.com/pipeline: test
spec:
  params:
  - name: source-url
  - name: source-revision
  tasks:
    - name: test
      params:
      - name: source-url
        value: $(params.source-url)
      - name: source-revision
        value: $(params.source-revision)
      taskSpec:
        params:
        - name: source-url
        - name: source-revision
        steps:
        - name: test
          image: alpine
          script: |-
            echo "Skip Test :)"
EOF
```

##### ScanTemplateã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.1/tap/GUID-scc-ootb-supply-chain-testing-scanning.html#updates-to-the-developer-namespace-2

ScanTemplateã‚’demo namespaceã«ä½œæˆã™ã‚‹ãŸã‚ã«ã€grype packageã‚’ã“ã“ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```yaml
cat <<EOF > grype-demo.yaml
namespace: demo
targetImagePullSecret: registry-credentials
EOF
```

```
tanzu package install grype-demo -p grype.scanning.apps.tanzu.vmware.com -v 1.1.1 -n tap-install -f grype-demo.yaml
```

```
$ kubectl get scantemplate -n demo
NAME                          AGE
blob-source-scan-template     27s
private-image-scan-template   27s
public-image-scan-template    27s
public-source-scan-template   27s
```

##### ScanPolicyã®ä½œæˆ

https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.1/tap/GUID-scc-ootb-supply-chain-testing-scanning.html#updates-to-the-developer-namespace-2

ScanPolicyã¯ã‚µãƒ³ãƒ—ãƒ«ã¨åŒã˜ã‚‚ã®ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```yaml
cat <<'EOF' | kubectl -n demo apply -f -
apiVersion: scanning.apps.tanzu.vmware.com/v1beta1
kind: ScanPolicy
metadata:
  name: scan-policy
spec:
  regoFile: |
    package policies

    default isCompliant = false

    # Accepted Values: "Critical", "High", "Medium", "Low", "Negligible", "UnknownSeverity"
    violatingSeverities := ["Critical","High","UnknownSeverity"]
    ignoreCVEs := []

    contains(array, elem) = true {
      array[_] = elem
    } else = false { true }

    isSafe(match) {
      fails := contains(violatingSeverities, match.Ratings.Rating[_].Severity)
      not fails
    }

    isSafe(match) {
      ignore := contains(ignoreCVEs, match.Id)
      ignore
    }

    isCompliant = isSafe(input.currentVulnerability)
EOF
```

ã“ã“ã¾ã§namespaceå˜ä½ã§è¡Œã†å¿…è¦ã®ã‚ã‚‹è¨­å®šã§ã—ãŸã€‚

#### Node.jsã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤

https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.1/tap/GUID-scc-ootb-supply-chain-testing-scanning.html#developer-workload-3

```
tanzu apps workload apply hello \
  --app hello \
  --git-repo https://github.com/making/hello-nodejs \
  --git-branch master \
  --type web \
  --label apps.tanzu.vmware.com/has-tests=true \
  --annotation autoscaling.knative.dev/minScale=1 \
  -n demo \
  -y
tanzu apps workload tail hello -n demo   
```

ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã—ãŸã‘ã‚Œã°æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’watchã—ã¦ãã ã•ã„ã€‚

```
watch kubectl get pod,gitrepo,pipelinerun,sourcescan,imgs,build,imagescan,podintent,taskrun,imagerepository,app,ksvc,certificate,httpproxy -n demo -owide
```

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ã§"Failed"ã«ãªã‚Šã¾ã™ã€‚

```
$ kubectl get sourcescans -n demo hello                  
NAME    PHASE    SCANNEDREVISION                            SCANNEDREPOSITORY                                                                                                                  AGE     CRITICAL   HIGH   MEDIUM   LOW   UNKNOWN   CVETOTAL
hello   Failed   19610d1789fb30d571e0b27a65ed03a7bdec2922   http://source-controller.flux-system.svc.cluster.local./gitrepository/demo/hello/19610d1789fb30d571e0b27a65ed03a7bdec2922.tar.gz   3m15s   0          1      0        1     0         2
```

ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«`tanzu insight`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.1/tap/GUID-scst-store-create-service-account-access-token.html
(ä¸€éƒ¨å¤‰æ›´ã—ã¦ã„ã¾ã™)

read-onlyãªã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«æ¬¡ã®Secretã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml
cat <<EOF | kubectl apply -f-
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: metadata-store-ready-only
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: metadata-store-read-only
subjects:
- kind: ServiceAccount
  name: metadata-store-read-client
  namespace: metadata-store
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: metadata-store-read-client
  namespace: metadata-store
automountServiceAccountToken: false
---
apiVersion: v1
kind: Secret
metadata:
  name: metadata-store-read-only-token
  namespace: metadata-store  
  annotations:
    kubernetes.io/service-account.name: metadata-store-read-client
type: kubernetes.io/service-account-token
EOF
```

ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¦ã€Metadata Storeã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚
https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.1/tap/GUID-scst-store-using-encryption-and-connection.html

```
kubectl get secret -n tanzu-system-ingress cnrs-default-tls -otemplate='{{(index .data "ca.crt") | base64decode}}' > cnrs-default-tls.ca
METADATA_STORE_DOMAIN=$(kubectl get httpproxy -n metadata-store metadata-store-ingress -ojsonpath='{.spec.virtualhost.fqdn}')
AUTH_TOKEN=$(kubectl get secret -n metadata-store metadata-store-read-only-token -otemplate='{{.data.token | base64decode}}')
tanzu insight config set-target https://${METADATA_STORE_DOMAIN} --ca-cert cnrs-default-tls.ca --access-token=${AUTH_TOKEN}
```

ä»¥ä¸‹ã®ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```
â„¹  Using config file: /Users/toshiaki/.config/tanzu/insight/config.yaml 
â„¹  Setting trustedcacert in config 
â„¹  Setting accesstoken in config 
â„¹  Setting endpoint in config to: https://metadata-store.10-105-146-158.sslip.io 
âœ”  Success: Set Metadata Store endpoint 
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ç–é€šãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

```
$ tanzu insight health
Success: Reached Metadata Store!
```

`tanzu insight`ã‚³ãƒãƒ³ãƒ‰ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
`tanzu insight source`ã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ã®çµæœã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ tanzu insight source get --org making --repo hello-nodejs --commit 19610d1789fb30d571e0b27a65ed03a7bdec2922 
1. 	ID:       	1
	Repository:  	hello-nodejs
	Commit:      	19610d1789fb30d571e0b27a65ed03a7bdec2922
	Organization:	making
	Packages:
	1. accepts@1.3.8
	...
	8. cookie@0.5.0
	CVEs:
		1. CVE-2017-18589 (High)
		1. CVE-2017-18589 (Unknown)
		1. CVE-2017-18589 (Unknown)
	9. cookie-signature@1.0.6
	...
	20. fresh@0.5.2
	CVEs:
		1. CVE-2013-1779 (Low)
		1. CVE-2013-1779 (Unknown)
	21. function-bind@1.1.1
	...
	56. vary@1.1.2
```

CVE-2017-18589ãŒHigh Severityã§å ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã€‚

> â„¹ï¸ SBOMã®å‡ºåŠ›çµæœã¯scanã—ãŸPodã®ãƒ­ã‚°ã§ç¢ºèªã§ãã¾ã™ã€‚
> ```xml
> $ kubectl logs -n demo scan-hello-<...>
> 
> <?xml version="1.0" encoding="UTF-8"?>
> <bom xmlns="http://cyclonedx.org/schema/bom/1.2" xmlns:v="http://cyclonedx.org/schema/ext/vulnerability/1.0" version="1" serialNumber="urn:uuid:916fdfd5-2c29-4bc4-9dbf-a11c9731c5f1">
>   <metadata>
>     <timestamp>2022-06-21T17:07:18Z</timestamp>
>     <tools>
>       <tool>
>         <vendor>anchore</vendor>
>         <name>grype</name>
>         <version>v0.33.1</version>
>       </tool>
>     </tools>
>     <component type="file">
>       <name>https://github.com/making/hello-nodejs</name>
>       <version>19610d1789fb30d571e0b27a65ed03a7bdec2922</version>
>     </component>
>   </metadata>
>   <components>
>     <component type="library">
>       <name>accepts</name>
>       <version>1.3.8</version>
>     </component>
>     <!-- ... -->
>     <component type="library">
>       <name>content-type</name>
>       <version>1.0.4</version>
>     </component>
>     <component type="library">
>       <name>cookie</name>
>       <version>0.5.0</version>
>       <v:vulnerabilities>
>         <v:vulnerability ref="urn:uuid:a13b50a9-6348-4f67-b703-87fa33b7017d">
>           <v:id>CVE-2017-18589</v:id>
>           <v:source name="nvd">
>             <v:url>http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-18589</v:url>
>           </v:source>
>           <v:ratings>
>             <v:rating>
>               <v:severity>High</v:severity>
>             </v:rating>
>             <v:rating>
>               <v:score>
>                 <v:base>5</v:base>
>                 <v:impact>2.9</v:impact>
>                 <v:exploitability>10</v:exploitability>
>               </v:score>
>               <v:method>CVSSv2</v:method>
>               <v:vector>AV:N/AC:L/Au:N/C:N/I:N/A:P</v:vector>
>             </v:rating>
>             <v:rating>
>               <v:score>
>                 <v:base>7.5</v:base>
>                 <v:impact>3.6</v:impact>
>                 <v:exploitability>3.9</v:exploitability>
>               </v:score>
>               <v:method>CVSSv3</v:method>
>               <v:vector>CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H</v:vector>
>             </v:rating>
>           </v:ratings>
>           <v:description>An issue was discovered in the cookie crate before 0.7.6 for Rust. Large integers in the Max-Age of a cookie cause a panic.</v:description>
>           <v:advisories>
>             <v:advisory>https://rustsec.org/advisories/RUSTSEC-2017-0005.html</v:advisory>
>           </v:advisories>
>         </v:vulnerability>
>       </v:vulnerabilities>
>     </component>
>     <component type="library">
>       <name>cookie-signature</name>
>       <version>1.0.6</version>
>     </component>
>     <!-- ... -->
>     <component type="library">
>       <name>forwarded</name>
>       <version>0.2.0</version>
>     </component>
>     <component type="library">
>       <name>fresh</name>
>       <version>0.5.2</version>
>       <v:vulnerabilities>
>         <v:vulnerability ref="urn:uuid:17c0acd2-cb25-4dce-af74-3a15c416c3fd">
>           <v:id>CVE-2013-1779</v:id>
>           <v:source name="nvd">
>             <v:url>http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-1779</v:url>
>           </v:source>
>           <v:ratings>
>             <v:rating>
>               <v:severity>Low</v:severity>
>             </v:rating>
>             <v:rating>
>               <v:score>
>                 <v:base>2.1</v:base>
>                 <v:impact>2.9</v:impact>
>                 <v:exploitability>3.9</v:exploitability>
>               </v:score>
>               <v:method>CVSSv2</v:method>
>               <v:vector>AV:N/AC:H/Au:S/C:N/I:P/A:N</v:vector>
>             </v:rating>
>           </v:ratings>
>           <v:description>Cross-site scripting (XSS) vulnerability in the 3 slide gallery in the Fresh theme before 7.x-1.4 for Drupal allows remote authenticated users with the administer themes permission to inject arbitrary web script or HTML via unspecified vectors.</v:description>
>           <v:advisories>
>             <v:advisory>http://drupalcode.org/project/fresh.git/commitdiff/08a3ccb</v:advisory>
>             <v:advisory>http://www.openwall.com/lists/oss-security/2013/02/28/3</v:advisory>
>             <v:advisory>http://drupal.org/node/1929482</v:advisory>
>             <v:advisory>http://drupal.org/node/1723316</v:advisory>
>           </v:advisories>
>         </v:vulnerability>
>       </v:vulnerabilities>
>     </component>
>     <component type="library">
>       <name>function-bind</name>
>       <version>1.1.1</version>
>     </component>
>     <!-- ... -->
>     <component type="library">
>       <name>vary</name>
>       <version>1.1.2</version>
>     </component>
>   </components>
> </bom>
> ```

https://github.com/anchore/anchore-engine/issues/304 ã‚’è¦‹ã‚‹é™ã‚Šã€ã“ã®è„†å¼±æ€§ã¯Rustã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«é–¢ã™ã‚‹ã‚‚ã®ã§ã‚ã‚Šã€
ä»Šå›ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã¯Node.jsã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã®ã§ã€ã“ã‚Œã¯èª¤æ¤œå‡ºã§ã™ã€‚
`ignoreCVEs`ã«CVE-2017-18589ã‚’è¿½åŠ ã—ã¦ã€ScanPolicyã‚’æ›´æ–°ã—ã¾ã™ã€‚

```yaml
cat <<'EOF' | kubectl -n demo apply -f -
apiVersion: scanning.apps.tanzu.vmware.com/v1beta1
kind: ScanPolicy
metadata:
  name: scan-policy
spec:
  regoFile: |
    package policies

    default isCompliant = false

    # Accepted Values: "Critical", "High", "Medium", "Low", "Negligible", "UnknownSeverity"
    violatingSeverities := ["Critical","High","UnknownSeverity"]
    # https://github.com/anchore/anchore-engine/issues/304
    ignoreCVEs := ["CVE-2017-18589"]

    contains(array, elem) = true {
      array[_] = elem
    } else = false { true }

    isSafe(match) {
      fails := contains(violatingSeverities, match.Ratings.Rating[_].Severity)
      not fails
    }

    isSafe(match) {
      ignore := contains(ignoreCVEs, match.Id)
      ignore
    }

    isCompliant = isSafe(input.currentVulnerability)
EOF
```

ScanãŒå†åº¦èµ°ã‚Šã¾ã™ã€‚ä»Šåº¦ã¯"Completed"ã«ãªã‚Šã¾ã™ã€‚

```
$ kubectl get sourcescans -n demo hello
NAME    PHASE       SCANNEDREVISION                            SCANNEDREPOSITORY                                                                                                                  AGE   CRITICAL   HIGH   MEDIUM   LOW   UNKNOWN   CVETOTAL
hello   Completed   19610d1789fb30d571e0b27a65ed03a7bdec2922   http://source-controller.flux-system.svc.cluster.local./gitrepository/demo/hello/19610d1789fb30d571e0b27a65ed03a7bdec2922.tar.gz   13m   0          1      0        1     0         2
```

ã¡ãªã¿ã«Ignoreã—ãŸCVEã‚‚MetaData Storeã«æ®‹ã‚Šã€CVEæƒ…å ±ã§ã‚½ãƒ¼ã‚¹ã‚’æ¤œç´¢ã™ã‚‹ã¨hello-nodejsãŒãƒ’ãƒƒãƒˆã—ã¾ã™ã€‚

```
$ tanzu insight vulnerabilities sources --cveid CVE-2017-18589
1. 	ID:       	1
	Repository:  	hello-nodejs
	Commit:      	19610d1789fb30d571e0b27a65ed03a7bdec2922
	Organization:	making
	Packages:
	1. cookie@0.5.0
	CVEs:
		1. CVE-2017-18589 (High)
		1. CVE-2017-18589 (Unknown)
		1. CVE-2017-18589 (Unknown)
```

ã•ã¦ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ãŒæˆåŠŸã—ãŸå¾Œã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ãŒè¡Œã‚ã‚Œã€æ¬¡ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã®è„†å¼±æ€§ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™ã€‚

ã‚¤ãƒ¡ãƒ¼ã‚¸ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ã§"Failed"ã«ãªã‚Šã¾ã™ã€‚

```
$ kubectl get imagescan -n demo hello 
NAME    PHASE    SCANNEDIMAGE                                                                                                                            AGE   CRITICAL   HIGH   MEDIUM   LOW   UNKNOWN   CVETOTAL
hello   Failed   registry.kube-system.svc.cluster.local/supplychain/hello-demo@sha256:a1a401c25e787cb380eec4433b9ba1de4b7742352e8c80ce57c60110d6e69b5b   79s   0          7      3        12    0         22
```

`tanzu insight image`ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³ã®çµæœã‚’ç¢ºèªã—ã¾ã™ã€‚


```
$ tanzu insight image get --digest sha256:a1a401c25e787cb380eec4433b9ba1de4b7742352e8c80ce57c60110d6e69b5b
ID:       	1
Registry:  	registry.kube-system.svc.cluster.local
Image Name:	supplychain/hello-demo
Digest:    	sha256:a1a401c25e787cb380eec4433b9ba1de4b7742352e8c80ce57c60110d6e69b5b
Packages:
	1. accepts@1.3.8
	...
	8. cookie@0.5.0
	CVEs:
		1. CVE-2017-18589 (High)
		1. CVE-2017-18589 (Unknown)
		1. CVE-2017-18589 (Unknown)
	9. cookie-signature@1.0.6
	...
	20. fresh@0.5.2
	CVEs:
		1. CVE-2013-1779 (Low)
		1. CVE-2013-1779 (Unknown)
	21. function-bind@1.1.1
	...
	67. coreutils@8.28-1ubuntu1
	CVEs:
		1. CVE-2016-2781 (Low)
	68. dash@0.5.8-2.10
	...
	76. gcc-8-base@8.4.0-1ubuntu1~18.04
	CVEs:
		1. CVE-2020-13844 (Medium)
	77. gpgv@2.2.4-1ubuntu1.5
	...
	89. libc-bin@2.27-3ubuntu1.6
	CVEs:
		1. CVE-2009-5155 (Low)
		2. CVE-2015-8985 (Low)
		3. CVE-2016-20013 (Low)
	90. libc6@2.27-3ubuntu1.6
	CVEs:
		1. CVE-2009-5155 (Low)
		2. CVE-2015-8985 (Low)
		3. CVE-2016-20013 (Low)
	91. libcap-ng0@0.7.7-3.1
	...
	98. libgcc1@1:8.4.0-1ubuntu1~18.04
	CVEs:
		1. CVE-2020-13844 (Medium)
	99. libgcrypt20@1.8.1-4ubuntu1.3
	100. libgmp10@2:6.1.2+dfsg-2
	101. libgnutls30@3.5.18-1ubuntu1.5
	CVEs:
		1. CVE-2018-16868 (Low)
	102. libgpg-error0@1.27-6
	...
	108. libncurses5@6.1-1ubuntu1.18.04
	CVEs:
		1. CVE-2019-17594 (Low)
		2. CVE-2019-17595 (Low)
		3. CVE-2021-39537 (Low)
		4. CVE-2022-29458 (Low)
	109. libncursesw5@6.1-1ubuntu1.18.04
	CVEs:
		1. CVE-2019-17594 (Low)
		2. CVE-2019-17595 (Low)
		3. CVE-2021-39537 (Low)
		4. CVE-2022-29458 (Low)
	110. libnettle6@3.4.1-0ubuntu0.18.04.1
	...
	116. libpcre3@2:8.39-9ubuntu0.1
	CVEs:
		1. CVE-2017-11164 (Low)
	117. libprocps6@2:3.3.12-3ubuntu1.2
	...
	126. libstdc++6@8.4.0-1ubuntu1~18.04
	CVEs:
		1. CVE-2020-13844 (Medium)
	127. libsystemd0@237-3ubuntu10.53
	128. libtasn1-6@4.13-2
	129. libtinfo5@6.1-1ubuntu1.18.04
	CVEs:
		1. CVE-2019-17594 (Low)
		2. CVE-2019-17595 (Low)
		3. CVE-2021-39537 (Low)
		4. CVE-2022-29458 (Low)
	130. libudev1@237-3ubuntu10.53
	...
	135. locales@2.27-3ubuntu1.6
	CVEs:
		1. CVE-2009-5155 (Low)
		2. CVE-2015-8985 (Low)
		3. CVE-2016-20013 (Low)
	136. login@1:4.5-1ubuntu2.2
	CVEs:
		1. CVE-2013-4235 (Low)
	137. lsb-base@9.20170808ubuntu1
	...
	140. ncurses-base@6.1-1ubuntu1.18.04
	CVEs:
		1. CVE-2019-17594 (Low)
		2. CVE-2019-17595 (Low)
		3. CVE-2021-39537 (Low)
		4. CVE-2022-29458 (Low)
	141. ncurses-bin@6.1-1ubuntu1.18.04
	CVEs:
		1. CVE-2019-17594 (Low)
		2. CVE-2019-17595 (Low)
		3. CVE-2021-39537 (Low)
		4. CVE-2022-29458 (Low)
	142. netbase@5.4
	143. openssl@1.1.1-1ubuntu2.1~18.04.17
	144. passwd@1:4.5-1ubuntu2.2
	CVEs:
		1. CVE-2013-4235 (Low)
	145. perl-base@5.26.1-6ubuntu0.5
	CVEs:
		1. CVE-2020-16156 (Medium)
	146. procps@2:3.3.12-3ubuntu1.2
	...
	179. ansi-regex@3.0.0
	CVEs:
		1. CVE-2021-3807 (High)
		1. CVE-2021-3807 (Unknown)
		1. CVE-2021-3807 (Unknown)
		2. GHSA-93q8-gq69-wqmw (High)
	180. ansi-regex@5.0.0
	CVEs:
		1. CVE-2021-3807 (High)
		1. CVE-2021-3807 (Unknown)
		1. CVE-2021-3807 (Unknown)
		2. GHSA-93q8-gq69-wqmw (High)
	181. ansi-regex@5.0.1
	...
	324. once@1.4.0
	325. opener@1.5.2
	CVEs:
		1. CVE-2021-27478 (High)
		1. CVE-2021-27478 (Unknown)
		1. CVE-2021-27478 (Unknown)
		2. CVE-2021-27482 (High)
		2. CVE-2021-27482 (Unknown)
		2. CVE-2021-27482 (Unknown)
		3. CVE-2021-27498 (High)
		3. CVE-2021-27498 (Unknown)
		3. CVE-2021-27498 (Unknown)
		4. CVE-2021-27500 (High)
		4. CVE-2021-27500 (Unknown)
		4. CVE-2021-27500 (Unknown)
	326. p-map@4.0.0
	...
	382. yallist@4.0.0
```

ãŸãã•ã‚“æ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚

Metadata Storeã«ã¯SBOMã®æƒ…å ±ãŒä¿å­˜ã•ã‚Œã¾ã™ãŒã€CVEã¨Severityã®æƒ…å ±ã—ã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã€
`grype` CLIã‚’ç›´æ¥ä½¿ã£ã¦Fixedã•ã‚ŒãŸCVEã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚

```
SCAN_IMAGE=$(kubectl get scantemplate -n demo private-image-scan-template -ojsonpath='{.spec.template.containers[0].image}')
TARGET_IMAGE=$(kubectl get imgs -n demo hello -ojsonpath='{.status.latestImage}')
kubectl run grype -n demo --restart=Never -ti --image=${SCAN_IMAGE} --timeout=10m --rm --command -- grype -v ${TARGET_IMAGE} --only-fixed
```

```
If you don't see a command prompt, try pressing enter.
[0000]  INFO New version of grype is available: 0.40.0
[0001]  INFO downloading new vulnerability DB
[0015]  INFO identified distro: Ubuntu 18.04.6 LTS from-lib=syft
[0015]  INFO cataloging image from-lib=syft
[0119]  INFO updated vulnerability DB to version=3 built="2022-06-23 08:15:59 +0000 UTC"
[0120]  INFO ignoring 46 matches due to user-provided ignore rules
NAME        INSTALLED  FIXED-IN  VULNERABILITY        SEVERITY 
ansi-regex  3.0.0      3.0.1     GHSA-93q8-gq69-wqmw  High      
ansi-regex  5.0.0      5.0.1     GHSA-93q8-gq69-wqmw  High      
npm         8.5.0      8.11.0    GHSA-hj9c-8jmm-8c52  Medium       
```

Fixedã§SeverityãŒHighä»¥ä¸Šãªã‚‚ã®ã ã‘ã‚’è¦‹ã‚‹ã¨[GHSA-93q8-gq69-wqmw](https://github.com/advisories/GHSA-93q8-gq69-wqmw)ãŒè©²å½“ã—ã¾ã™ã€‚
ã©ã“ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ã®ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å±•é–‹ã—ã€`ansi-regex`ã‚’æ¤œç´¢ã—ã¾ã™ã€‚

```
$ imgpkg pull -i $(kubectl get imgs -n demo hello -ojsonpath='{.status.latestImage}' | sed 's/registry.kube-system.svc.cluster.local/localhost:5000/g') -o /tmp/hello
$ cd /tmp/hello
$ grep -irI ansi-regex  ./
./layers/tanzu-buildpacks_node-engine-lite/node/lib/node_modules/npm/docs/content/commands/npm-install.md:    npm install ansi-regex --save-bundle
./layers/tanzu-buildpacks_node-engine-lite/node/lib/node_modules/npm/docs/output/commands/npm-install.html:npm install ansi-regex --save-bundle
./layers/tanzu-buildpacks_node-engine-lite/node/lib/node_modules/npm/node_modules/strip-ansi/index.js:var ansiRegex = require('ansi-regex')();
./layers/tanzu-buildpacks_node-engine-lite/node/lib/node_modules/npm/node_modules/strip-ansi/readme.md:- [ansi-regex](https://github.com/chalk/ansi-regex) - Regular expression for matching ANSI escape codes
./layers/tanzu-buildpacks_node-engine-lite/node/lib/node_modules/npm/node_modules/strip-ansi/package.json:    "ansi-regex": "^2.0.0"
...
./layers/tanzu-buildpacks_node-engine-lite/node/lib/node_modules/npm/node_modules/ansi-regex/package.json:  "name": "ansi-regex",
./layers/tanzu-buildpacks_node-engine-lite/node/lib/node_modules/npm/node_modules/ansi-regex/package.json:  "repository": "chalk/ansi-regex",
```

ã©ã†ã‚„ã‚‰ã€nodeè‡ªèº«ã«ãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚ˆã†ã§ã™ã€‚ã“ã®è„†å¼±æ€§ã‚’Fixã™ã‚‹ã«ã¯[node-engine buildpack](https://github.com/paketo-buildpacks/node-engine)ãŒæ›´æ–°ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã¨ã¯ã„ãˆã€[è„†å¼±æ€§ã®PoC](https://github.com/chalk/ansi-regex/pull/37#issuecomment-916580764)ã‚’è¦‹ã‚‹ã¨ã‚¢ãƒ—ãƒªãŒansi-regexã‚’ä½¿ã£ã¦ã‚‹`ansiRegex().test(...)`ã§æ‚ªæ„ã®ã‚ã‚‹æ–‡å­—åˆ—ã‚’å—ã‘å–ã‚‰ãªã„å•é¡Œãªã•ãã†ã€‚
ã‚¢ãƒ—ãƒªã§ã¯ansi-regexã¯ä½¿ç”¨ã—ã¦ã„ãªã„ã®ã§ã“ã‚Œã¯ignoreã—ã¾ã™ã€‚
UnfixedãªCVEã‚‚ã„ã£ãŸã‚“ignoreã—ã¾ã™ã€‚

ã¨ã„ã†ã‚ã‘ã§
* CVE-2021-3807
* GHSA-93q8-gq69-wqmw
* CVE-2021-27478
* CVE-2021-27482
* CVE-2021-27498
* CVE-2021-27500
ã‚’`ignoreCVEs`ã«è¿½åŠ ã—ã¦ã€ScanPolicyã‚’æ›´æ–°ã—ã¾ã™ã€‚

```yaml
cat <<'EOF' | kubectl -n demo apply -f -
apiVersion: scanning.apps.tanzu.vmware.com/v1beta1
kind: ScanPolicy
metadata:
  name: scan-policy
spec:
  regoFile: |
    package policies

    default isCompliant = false

    # Accepted Values: "Critical", "High", "Medium", "Low", "Negligible", "UnknownSeverity"
    violatingSeverities := ["Critical","High","UnknownSeverity"]
    # https://github.com/anchore/anchore-engine/issues/304
    ignoreCVEs := ["CVE-2017-18589", "CVE-2021-3807", "GHSA-93q8-gq69-wqmw", "CVE-2021-27478", "CVE-2021-27482", "CVE-2021-27498", "CVE-2021-27500"]

    contains(array, elem) = true {
      array[_] = elem
    } else = false { true }

    isSafe(match) {
      fails := contains(violatingSeverities, match.Ratings.Rating[_].Severity)
      not fails
    }

    isSafe(match) {
      ignore := contains(ignoreCVEs, match.Id)
      ignore
    }

    isCompliant = isSafe(input.currentVulnerability)
EOF
```

ScanãŒå†åº¦èµ°ã‚Šã¾ã™ã€‚ä»Šåº¦ã¯"Completed"ã«ãªã‚Šã¾ã™ã€‚

```
$ kubectl get imagescan -n demo hello
NAME    PHASE       SCANNEDIMAGE                                                                                                                            AGE     CRITICAL   HIGH   MEDIUM   LOW   UNKNOWN   CVETOTAL
hello   Completed   registry.kube-system.svc.cluster.local/supplychain/hello-demo@sha256:a1a401c25e787cb380eec4433b9ba1de4b7742352e8c80ce57c60110d6e69b5b   7m55s   0          7      3        12    0         22
```

ç„¡è¦–ã—ãŸCVEã‚‚MetaData Storeã«è¦å‰‡ã•ã‚Œã€æ¬¡ã®ã‚ˆã†ã«æŒ‡å®šã—ãŸè„†å¼±æ€§ã‚’æŒã¤ã‚¤ãƒ¡ãƒ¼ã‚¸ã®æ¤œç´¢çµæœã«å«ã¾ã‚Œã¾ã™ã€‚

```
$ tanzu insight vulnerabilities images --cveid CVE-2021-3807
1. 	ID:       	1
	Registry:  	registry.kube-system.svc.cluster.local
	Image Name:	supplychain/hello-demo
	Digest:    	sha256:a1a401c25e787cb380eec4433b9ba1de4b7742352e8c80ce57c60110d6e69b5b
	Packages:
	1. ansi-regex@3.0.0
	CVEs:
		1. CVE-2021-3807 (High)
		1. CVE-2021-3807 (Unknown)
		1. CVE-2021-3807 (Unknown)
		2. GHSA-93q8-gq69-wqmw (High)
	2. ansi-regex@5.0.0
	CVEs:
		1. CVE-2021-3807 (High)
		1. CVE-2021-3807 (Unknown)
		1. CVE-2021-3807 (Unknown)
		2. GHSA-93q8-gq69-wqmw (High)
```

Scanã‚’ãƒ‘ã‚¹ã—ãŸã®ã§ã€ã‚ˆã†ã‚„ãã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

```
$ tanzu apps workload get -n demo hello
# hello: Ready
---
lastTransitionTime: "2022-06-22T18:07:27Z"
message: ""
reason: Ready
status: "True"
type: Ready

Pods
NAME                                     STATUS      RESTARTS   AGE
hello-00001-deployment-994f5755f-f2rjc   Running     0          37s
hello-build-1-build-pod                  Succeeded   0          9m52s
hello-config-writer-v4v9w-pod            Succeeded   0          96s
hello-sq9wx-test-pod                     Succeeded   0          13m
scan-hello-24ggg-8wp7h                   Succeeded   0          10m
scan-hello-72g2f-hmf2g                   Succeeded   0          9m16s
scan-hello-j5pfr-pm4hj                   Succeeded   0          13m
scan-hello-q9ctb-hqbfg                   Succeeded   0          2m45s
scan-hello-w8svx-m7tx5                   Succeeded   0          2m45s

Knative Services
NAME    READY   URL
hello   Ready   https://hello-demo.10-105-146-158.sslip.io
```

```
$ curl -k https://hello-demo.10-105-146-158.sslip.io
Hello Tanzu!!
```

ç¢ºèªãŒçµ‚ã‚ã‚Œã°Workloadã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```
tanzu apps workload delete -n demo hello -y
```
