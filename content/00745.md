---
title: Spring Integrationã§Pollingãƒ™ãƒ¼ã‚¹ã®Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã™ã‚‹

tags: ["Spring Boot", "Spring Integration", "Java", "Outbox"]
categories: ["Programming", "Java", "org", "springframework", "integration", "jdbc"]
---

ã“ã®è¨˜äº‹ã§ã¯Spring Integrationã§Pollingãƒ™ãƒ¼ã‚¹ã®Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

**ç›®æ¬¡**
<!-- toc -->

### Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã¯

[Outboxãƒ‘ã‚¿ãƒ¼ãƒ³](https://microservices.io/patterns/data/transactional-outbox.html) (æ­£ç¢ºã«ã¯ "Transactional outbox" )ã¯Chris RichardsonãŒã¾ã¨ã‚ãŸ[ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³](https://microservices.io/patterns/index.html)ã®ä¸€ã¤ã§ã™ã€‚

> ä»¥ä¸‹ã®æ›¸ç±ã§è©³ã—ãèª¬æ˜ã•ã‚Œã¦ã„ã¾ã™<br>
> [![ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³](https://ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=4295008583&Format=_SL160_&ID=AsinImage&MarketPlace=JP&ServiceVersion=20070822&WS=1&tag=ikam-22&language=ja_JP)](https://www.amazon.co.jp/dp/4295008583?&linkCode=ll1&tag=ikam-22&linkId=fc242fe990b15216c9bbc30f6258f62e&language=ja_JP&ref_=as_li_ss_tl)
> [ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ å®Ÿè·µçš„ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãŸã‚ã®ã‚³ãƒ¼ãƒ‰è§£èª¬](https://www.amazon.co.jp/dp/4295008583?&linkCode=ll1&tag=ikam-22&linkId=fc242fe990b15216c9bbc30f6258f62e&language=ja_JP&ref_=as_li_ss_tl)

ã‚ã‚‹å‡¦ç†ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°**ã¨**Message Broker(RabbitMQ, Kafkaãªã©)ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚’è¡Œã†å ´åˆã«ã€"Atomicity"(åŸå­æ€§)ã‚’ä¿ã¤ãŸã‚ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚2 Phase Commitã‚’è¡Œã‚ãªã„å‰æã§ã™ã€‚


Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã‚ãšã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°ã¨Message Brokerã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚’è¡Œã†ã¨ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ã€‚ä»¥ä¸‹ã®2ã¤ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ã‹ã‚‰Message Brokerã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
1. Message Brokerã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã—ã¦ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒŸãƒƒãƒˆ

å…ˆã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒŸãƒƒãƒˆã‚’è¡Œã†å ´åˆã€æ¬¡ã®å›³ã®ã‚ˆã†ã«ã€ã‚³ãƒŸãƒƒãƒˆå¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ãŒå¤±æ•—ã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°ã ã‘ãŒç¢ºå®šã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

<img width="725" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/839d1304-0031-412c-804a-1b6e745830aa">

ã¾ãŸã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡Œã†å ´åˆã€æ¬¡ã®å›³ã®ã‚ˆã†ã«ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¾Œã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚³ãƒŸãƒƒãƒˆã«å¤±æ•—ã™ã‚‹ã¨ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ãŒé€ä¿¡ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

<img width="725" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/094b962c-70d0-4aa8-bbe0-3cd5d1b8a197">

ã“ã®ã‚ˆã†ãªå•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°ã—ãŸãªã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å¿…ãš(å°‘ãªãã¨ã‚‚)ä¸€å›é€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã§ãã‚‹ã‚ˆã†æ¬¡ã®å›³ã®ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã®ãŒOutboxãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

<img width="745" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/28622d4b-f0b0-43f5-9675-f9eb0dc66e95">

Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›¸ãè¾¼ã¿æ™‚ã«ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã¯è¡Œã‚ãšã€ä»£ã‚ã‚Šã«åŒã˜ãƒ‡ãƒ¼ã‚¿ãƒ¼ãƒ™ãƒ¼ã‚¹å†…ã®"outbox"ã¨å‘¼ã°ã‚Œã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã—ãŸã„å†…å®¹ã‚’INSERTã—ã¾ã™ã€‚
outboxãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®æ›¸ãè¾¼ã¿ã¯ä¸»å‡¦ç†ã¨åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§è¡Œã‚ã‚Œã‚‹ã®ã§ã€åŸå­æ€§ã¯æ‹…ä¿ã•ã‚Œã¾ã™ã€‚

outboxã«æ›¸ãè¾¼ã¾ã‚ŒãŸæƒ…å ±ã¯"Message Relay"ã¨å‘¼ã°ã‚Œã‚‹å‡¦ç†ã§èª­ã¿å–ã‚‰ã‚Œã€Message Brokerã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã•ã‚Œã¾ã™ã€‚
èª­ã¿å–ã£ãŸæƒ…å ±ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¾Œã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã‚Œã°ã€outboxã«ãƒ‡ãƒ¼ã‚¿ãŒæ›¸ãè¾¼ã¾ã‚Œã‚Œã°ã€å°‘ãªãã¨ã‚‚ä¸€å›ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã‚‹ã“ã¨ã‚’ä¿è¨¼ã§ãã¾ã™ã€‚
ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚³ãƒŸãƒƒãƒˆã«å¤±æ•—ã™ã‚‹å ´åˆã¯ã€outboxã«ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã‚‹ãŸã‚ã€å†ã³Message Relayã«ã‚ˆã‚‹å‡¦ç†ãŒè¡Œã‚ã‚Œã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå†é€ä¿¡ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
ã—ãŸãŒã£ã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡å´ã¯1å›ä»¥ä¸Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã™ã‚‹ã“ã¨ã‚’å¿µé ­ã«å†ªç­‰æ€§ã‚’æ„è­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


outboxãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿å–ã‚‹æ–¹æ³•ã§Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¢ãƒ¼ã‚¯ãƒ†ã‚¯ãƒãƒ£ãƒ¼ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚
[ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³](https://microservices.io/patterns/data/transactional-outbox.html)ã§ã¯èª­ã¿å–ã‚Šæ–¹æ³•ã¨ã—ã¦

* [Transaction logãƒ™ãƒ¼ã‚¹ (Transaction log tailing)](https://microservices.io/patterns/data/transaction-log-tailing.html)
* [Pollingãƒ™ãƒ¼ã‚¹ (Polling publisher)](https://microservices.io/patterns/data/polling-publisher.html)

ã®2ç¨®é¡ãŒèª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

Transaction logãƒ™ãƒ¼ã‚¹ã®æ‰‹æ³•ã¯ã€PostgreSQLã®WAL (Write Ahead Log)ã‚„MySQLã®binlogã€ã‚ã‚‹ã„ã¯AWS DynamoDB table streamsãªã©ã‚’åˆ©ç”¨ã—ã¦ã€outboxã®å¤‰æ›´ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã§æ¤œçŸ¥ã—ã¾ã™ã€‚
ã“ã®æ‰‹æ³•ã‚’ä½¿ã£ãŸæœ‰åãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦[Debezium](https://debezium.io/)ãŒã‚ˆãçŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®æ‰‹æ³•ã¯ã€å¾Œè¿°ã®Pollingãƒ™ãƒ¼ã‚¹ã®æ‰‹æ³•ã‚ˆã‚Šã‚‚è‰¯ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæœŸå¾…ã§ãã¾ã™ã€‚ä¸€æ–¹ã§ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è£½å“æ¯ã«ç•°ãªã‚‹ç‰¹åˆ¥ãªè¨­å®šãŒå¿…è¦ï¼ˆã‚ã‚‹ã„ã¯ç‰¹åˆ¥ãªæ©Ÿèƒ½ã‚’æŒã¤ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå¿…è¦ï¼‰ã ã£ãŸã‚Šã€Debeziumã®ã‚ˆã†ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªå°å…¥ã®ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚Šã¾ã™ã€‚

Pollingãƒ™ãƒ¼ã‚¹ã®æ‰‹æ³•ã¯ã€æ¬¡ã®å›³ã®ã‚ˆã†ã«ã‚·ãƒ³ãƒ—ãƒ«ã«outboxãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®šæœŸçš„ã«select (for update)ã—ã¦æ–°ã—ã„ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¿½åŠ ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¾ã™ã€‚å‡¦ç†æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã¯deleteã—ã¾ã™ã€‚
SQLã ã‘ã§å®Ÿè£…ã§ãã‚‹ã®ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç‰¹åˆ¥ãªè¨­å®šãŒä¸è¦ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ã«å®Ÿè£…ã§ãã¾ã™ã€‚ä¸€æ–¹ã€å®šæœŸçš„ã«outboxãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦selectã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®è² è·ãŒå¤§ããã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å½±éŸ¿ã‚’åŠã¼ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚


<img width="745" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/d08dd1a5-f11e-4ec4-916b-a7df5afb0583">

æœ¬è¨˜äº‹ã§ã¯å¾Œè€…ã®Pollingãƒ™ãƒ¼ã‚¹ã«ã‚ˆã‚‹Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### Spring Integrationã«ã‚ˆã‚‹Outboxãƒ‘ã‚¿ãƒ¼ãƒ³
Spring Integrationã®ãƒªãƒ¼ãƒ‰ã§ã‚ã‚‹[Artem Bilan](https://spring.io/team/artembilan)ã«ã‚ˆã‚‹Blog Post "[Introducing Microservices Patterns with Spring Integration](https://spring.io/blog/2023/01/25/introducing-microservices-patterns-with-spring-integration)" ã«ã¦ã€Spring Integrationã§Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ãŒç´¹ä»‹ã•ã‚Œã¾ã—ãŸã€‚

ã‚µãƒ³ãƒ—ãƒ«ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã§ã™ã€‚Spring Integrationã ã‘ã§ã‚·ãƒ³ãƒ—ãƒ«ã«Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå®Ÿè£…ã§ãã¦ã„ã¾ã™ã€‚<br>
https://github.com/artembilan/microservices-patterns-spring-integration/tree/main/outbox


Spring Integrationã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã®æŠ½è±¡åŒ–ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚Endpointã‚’MessageChannelã§ç¹‹ã„ã§ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã—ã€Messageã‚’é€å—ä¿¡ã§ãã¾ã™ã€‚
Inboundã¨ãªã‚‹Endpointã‹ã‚‰é€ã‚‰ã‚ŒãŸMessageãŒMessageChannelã¸é€ã‚‰ã‚Œã€Endpointã§å‡¦ç†ã•ã‚Œã€ã¾ãŸMessageChanelã«æ¸¡ã•ã‚Œã€Outboundã®Endpointã§é€ä¿¡ã•ã‚Œã¾ã™ã€‚

Spring Integrationã§æ¬¡ã®ã‚ˆã†ãªãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã™ã‚Œã°Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚å›³ã®å››è§’ãŒEndpointã€ç­’ãŒMessageChannelã§ã™ï¼ˆä¸Šã®å›³ã§ã¯ç­’ãŒMessage Brokerã‚’è¡¨ç¾ã—ã¦ã„ãŸã®ã§ç´›ã‚‰ã‚ã—ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“...ï¼‰ã€‚
![image](https://github.com/making/blog.ik.am/assets/106908/5302441f-7530-422b-8055-4af348fd36e3)

ã“ã“ã§ãƒã‚¤ãƒ³ãƒˆã¨ãªã‚‹ã®ãŒ"outbox"ã¨åä»˜ã‘ã‚‰ã‚ŒãŸMessageChannelã§ã™ã€‚

[MessageChannel](https://docs.spring.io/spring-integration/docs/current/reference/html/core.html#channel)ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã§Messageã‚’ä¼é€ã—ã¾ã™ãŒã€[JdbcChannelMessageStore](https://docs.spring.io/spring-integration/docs/current/reference/html/jdbc.html#jdbc-message-store-channels)ã‚’ä½¿ã£ã¦MessageChannelã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«JDBCã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ã“ã®MessageChannelã¯Pollableãª[QueueChannel](https://docs.spring.io/spring-integration/docs/current/reference/html/core.html#channel-implementations-queuechannel)å®Ÿè£…ã§ã™ã€‚

ã“ã®MessageChannelãŒã¾ã•ã«"outbox"ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¦åˆ©ç”¨å¯èƒ½ã§ã™ã€‚å®Ÿä½“ã¨ã—ã¦ã¯[`INT_CHANNEL_MESSAGE`](https://github.com/spring-projects/spring-integration/blob/main/spring-integration-jdbc/src/main/resources/org/springframework/integration/jdbc/schema-postgresql.sql#L39-L48)ãƒ†ãƒ¼ãƒ–ãƒ«ãŒ[ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³](https://microservices.io/patterns/data/transactional-outbox.html)"outbox"ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç›¸å½“ã—ã¾ã™ã€‚
Spring Integrationã‚’ä½¿ç”¨ã™ã‚Œã°ã€Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãŠã‘ã‚‹outboxã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ›¸ãè¾¼ã¿ã¨outboxã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®pollingã¯MessageChannelã§éš è”½ã•ã‚Œã¦ãŠã‚Šã€å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
ã‚ã¨ã¯ä¸‹ã®å›³ã®ã‚ˆã†ã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨outboxã¸ã®æ›¸ãè¾¼ã¿ã€ãŠã‚ˆã³ã€outboxã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–ã‚Šå‡ºã—ã¨Message Brokerã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†(Message Relay)ã‚’ãã‚Œãã‚ŒåŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§è¡Œã‚ã‚Œã‚‹ã‚ˆã†ã«Spring Integrationã®ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã™ã‚Œã°Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå®Ÿè£…ã§ãã¾ã™ã€‚

![image](https://github.com/making/blog.ik.am/assets/106908/de7933a1-8ca0-4f7a-b072-4ab8f9815129)


### ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®å®Ÿè£…

ä¸Šè¨˜ã®ãƒ•ãƒ­ãƒ¼ã‚’åˆ©ç”¨ã—ãŸã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚ä¸‹ã®å›³ã®ã‚ˆã†ã«Order Serviceã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã‚’çµŒç”±ã—ã¦Shipment Serviceã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™ã€‚ãã‚Œã¨åŒæ™‚ã«Order DBã¸ã®æ›´æ–°ã‚‚è¡Œã„ã¾ã™ã€‚ã“ã®äºŒã¤ã®æ›´æ–°ã‚’Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã§å®Ÿè£…åˆã„ã¾ã™ã€‚

ä»Šå›ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã«ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®¹æ˜“ãªRabbitMQã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚

> â„¹ï¸ å¾Œè¿°ã™ã‚‹ã‚ˆã†ã«ã€ä»Šå›ã®ãƒ‡ãƒ¢ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒ‹ãƒ³ã‚°ã«å¯¾å¿œã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã‚’ä½¿ç”¨ã—ãŸæ–¹ãŒé©åˆ‡ã§ã€[RabbitMQ Streams](https://www.rabbitmq.com/streams.html)ã®[Super Streams](https://www.rabbitmq.com/streams.html#super-streams)(ã‚ã‚‹ã„ã¯Kafka)ã‚’ä½¿ã£ãŸæ–¹ãŒè‰¯ã‹ã£ãŸã®ã§ã™ãŒã€<br>
> è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã§ã¯spring-rabbitmq-streamã¯ObservailityãŒ[æœªå¯¾å¿œ](https://github.com/spring-projects/spring-amqp/issues/2467)ã ã£ãŸã®ã§ã€Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã§ãã‚‹ã‚ˆã†ã«æ™®é€šã®RabbitMQã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚

<img width="745" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/f654bf75-fa67-48dc-b5fa-fdafe1b50da6">

ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ https://github.com/making/outbox-pattern-demo ã§ã™ã€‚Debeziumã®[outboxã‚µãƒ³ãƒ—ãƒ«](https://github.com/debezium/debezium-examples/tree/main/outbox)ã‚‚å‚è€ƒã«ã—ã¾ã—ãŸã€‚(Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…ãŒãƒ¡ã‚¤ãƒ³ã§ã‚ã‚‹ãŸã‚ã€Order Serviceã¨Shipment Serviceè‡ªä½“ã®å®Ÿè£…ã¯ãƒ€ãƒŸãƒ¼ã§ã™ã€‚)
<br>


ãƒ•ãƒ­ãƒ¼ã®å…¥ã‚Šå£ã¨ãªã‚‹Gatewayã¨ã—ã¦ã€æ¬¡ã®ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚æ³¨æ–‡å‡¦ç†ã‚’è¡Œã†`placeOrder`ãƒ¡ã‚½ãƒƒãƒ‰ã¨æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹`cancelOrder`ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚

`placeOrder`ã¯åŒæ–¹å‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã§å…¥åŠ›ãŒ`order.create`ãƒãƒ£ãƒãƒ«ã«é€ã‚‰ã‚Œã€å‡ºåŠ›ãŒ`order.create.reply`ã‹ã‚‰è¿”ã‚Šã¾ã™ã€‚`cancelOrder`ã¯ä¸€æ–¹å‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã§ã€å…¥åŠ›ãŒ`order.cancel`ãƒãƒ£ãƒãƒ«ã«é€ã‚‰ã‚Œã€å‡ºåŠ›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚


```java
@MessagingGateway
public interface OrderGateway {

	@Gateway(requestChannel = "order.create", replyChannel = "order.create.reply")
	Order placeOrder(Order order);

	@Gateway(requestChannel = "order.cancel")
	void cancelOrder(Long orderId);

}
```

Gatewayã¸ã®å…¥åŠ›ã¯æ¬¡ã®ã‚ˆã†ã«ã‚·ãƒ³ãƒ—ãƒ«ã«`@RestController`ã§å®Ÿè£…ã—ã¾ã™ã€‚

```java
@RestController
public class OrderController {

	private final OrderGateway orderGateway;

	private final Clock clock;

	private final Logger log = LoggerFactory.getLogger(OrderController.class);

	public OrderController(OrderGateway orderGateway, Clock clock) {
		this.orderGateway = orderGateway;
		this.clock = clock;
	}

	@PostMapping(path = "/orders")
	public Order placeOrder(@RequestBody OrderRequest orderRequest) {
		final Order newOrder = orderRequest.newOrder(this.clock);
		final Order order = this.orderGateway.placeOrder(newOrder);
		log.info("Created {}", order);
		return order;
	}

	@DeleteMapping(path = "/orders/{orderId}")
	public void cancelOrder(@PathVariable Long orderId) {
		this.orderGateway.cancelOrder(orderId);
		log.info("Cancelled {}", orderId);
	}

}
```

Orderã‚’Order DBã«ä¿å­˜ã—ãŸã‚Šã€æ›´æ–°ã—ãŸã‚Šã™ã‚‹å‡¦ç†ã¯æ¬¡ã®`OrderService`ã¨`OrderRepository`ã§è¡Œã„ã¾ã™ã€‚

```java
@Service
@Transactional
@Observed
public class OrderService {

	private final OrderRepository orderRepository;

	public OrderService(OrderRepository orderRepository) {
		this.orderRepository = orderRepository;
	}

	public Order create(Order order) {
		return this.orderRepository.save(order);
	}

	public int cancel(Long orderId) {
		return this.orderRepository.updateStatus(orderId, OrderStatus.CANCELLED);
	}

}
```

```java
public interface OrderRepository extends ListCrudRepository<Order, Long> {

	@Modifying
	@Query("UPDATE Order SET status=:status WHERE orderId=:orderId AND status <> :status")
	int updateStatus(Long orderId, OrderStatus status);

}
```


`order.create`ãƒãƒ£ãƒãƒ«ã‹ã‚‰ã®`outbox`ã¾ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã®ãƒ•ãƒ­ãƒ¼ã‚’æ¬¡ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã™ã€‚

```java
@Bean
public IntegrationFlow orderCreateFlow(OrderService orderService) {
	return IntegrationFlow.from("order.create")
		.routeToRecipients(routes -> routes.transactional() // (1)
			.recipientFlow(f -> f.<Order>handle((order, headers) -> orderService.create(order)) // (2)
				.channel(c -> c.publishSubscribe("order.create.reply")) // (3)
				.transform(OrderEvents.Created::from) // (4)
				.enrichHeaders(h -> h.header("eventType", "order_created")) // (5)
				.channel("outbox"))) // (6)
		.get();
}
```

| ç•ªå· | èª¬æ˜ |
| -- | -- |
| (1) | [Artemã®ã‚µãƒ³ãƒ—ãƒ«](https://github.com/artembilan/microservices-patterns-spring-integration/tree/main/outbox)ã®ã‚ˆã†ã«[Recipient List Router](https://docs.spring.io/spring-integration/docs/current/reference/html/message-routing.html#router-implementations-recipientlistrouter)ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã‚’ä½¿ç”¨ã—ã¦ã€`order.create`ãƒãƒ£ãƒãƒ«ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã¦ã€`outbox`ãƒãƒ£ãƒãƒ«ã«é€ä¿¡ã™ã‚‹ã¾ã§ã®å‡¦ç†ãŒåŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¸Šã§è¡Œã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ |
| (2) | `OrderService#create` ã‚’å‘¼ã³å‡ºã™ã ã‘ã®MesageHandlerã‚’ä½œæˆã—ã¾ã™ã€‚ |
| (3) | (2)ã®Endpointã®å‡ºåŠ›ãƒãƒ£ãƒãƒ«ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’Gatewayã®replyã¨ãƒ•ãƒ­ãƒ¼ã®æ¬¡ã®Endpoint(`transform`)ã¸åŒæ™‚ã«é€ã‚Œã‚‹ã‚ˆã†ã«Pub/Subå‹ã®MessageChannelã‚’å®šç¾©ã—ã€`order.create.reply`ã¨åä»˜ã‘ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®MessageChannelå®Ÿè£…ã§ã‚ã‚‹`DirectChannel`ã¯åŒæ™‚ã«1ã¤ã®Subscriberã—ã‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œãªã„(round-robbinã•ã‚Œã‚‹)ã®ã§ã€è¤‡æ•°ã®Subscriberã«å¯¾å¿œã—ãŸ`PublishSubscribeChannel`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ |
| (4) | (2)ã®Endpointã®çµæœã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®Payloadã‚’`Order`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰Shipment Serviceã«é€ã‚‹`OrderEvents.Created`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å¤‰æ›ã—ã¾ã™ã€‚ |
| (5) | eventTypeã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¨­å®šã—ã¾ã™ã€‚ |
| (6) | (5)ã®Endpointã®å‡ºåŠ›ãƒãƒ£ãƒãƒ«ã‚’`outbox`(å¾Œã«å®šç¾©)ã«ã—ã¾ã™ã€‚ |

`outbox`ãƒãƒ£ãƒãƒ«ã‹ã‚‰AMQP(RabbitMQ)ã¸é€ä¿¡ã™ã‚‹ã¾ã§ã®ãƒ•ãƒ­ãƒ¼ã‚’æ¬¡ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã™ã€‚ã“ã®ãƒ•ãƒ­ãƒ¼ãŒOutboxãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãŠã‘ã‚‹ã€Message Relayã«ç›¸å½“ã—ã¾ã™ã€‚

```java
@Bean
public IntegrationFlow messageRelayFlow(MessageHandler amqpHandler) {
	return IntegrationFlow.from("outbox")
		.handle(amqpHandler, e -> e.poller(poller -> poller.fixedDelay(3_000, 3_000).transactional())) // (1)
		.get();
}

@Bean
public MessageHandler amqpHandler(AmqpTemplate amqpTemplate, ObjectMapper objectMapper) {
	final MessageHandler messageHandler = Amqp.outboundAdapter(amqpTemplate)
		.exchangeName("order")
		.routingKey("event")
		.getObject(); // (2)
	final Logger log = LoggerFactory.getLogger("amqpHandler");
	return message -> { // (3)
		final JsonNode payload = objectMapper.convertValue(message.getPayload(), JsonNode.class);
		log.info("Send {}", payload);
		messageHandler.handleMessage(MessageBuilder.createMessage(payload, message.getHeaders()));
	};
}
```

| ç•ªå· | èª¬æ˜ |
| -- | -- |
| (1) | `outbox`ãƒãƒ£ãƒãƒ«ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã¦`amqpHandler`ã§å‡¦ç†ã—ã¾ã™ã€‚`outbox`ã‹ã‚‰ã®å—ä¿¡ã¯Pollingã§è¡Œã„ã€Pollingé–“éš”ã¯3000msã§ã™ã€‚`transactional()`ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€`outbox`ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®selectãŠã‚ˆã³deleteã¨MeeageHandlerã®å‡¦ç†ã¯åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¸Šã§è¡Œã‚ã‚Œã¾ã™ã€‚ |
| (2) | AMQP(RabbitMQ)ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹MessageHandelerã‚’å®šç¾©ã—ã¾ã™ã€‚ |
| (3) | (2)ã®MessageHandelerã«å¯¾ã—ã¦ã€å—ä¿¡å´ãŒæ‰±ã„ã‚„ã™ã„ã‚ˆã†ã«`JsonNode`å‹ã«Payloadã‚’å¤‰æ›ã™ã‚‹å‡¦ç†ã‚’ãƒ©ãƒƒãƒ—ã—ã¦è¿”ã—ã¾ã™ã€‚ |


[JdbcChannelMessageStore](https://docs.spring.io/spring-integration/docs/current/reference/html/jdbc.html#jdbc-message-store-channels)ã‚’ä½¿ã£ãŸ`outbox`ãƒãƒ£ãƒãƒ«ã®å®šç¾©ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```java
@Bean
public JdbcChannelMessageStore jdbcChannelMessageStore(DataSource dataSource) {
	final JdbcChannelMessageStore jdbcChannelMessageStore = new JdbcChannelMessageStore(dataSource);
	jdbcChannelMessageStore.setChannelMessageStoreQueryProvider(new PostgresChannelMessageStoreQueryProvider());
	return jdbcChannelMessageStore;
}

@Bean
public QueueChannel outbox(JdbcChannelMessageStore jdbcChannelMessageStore) {
	return MessageChannels.queue(jdbcChannelMessageStore, "outbox").getObject();
}
```

Similarly, we can define the flow of messaging from the `order.cancel` channel to `outbox` as follows: This flow corresponds to the Message Relay in the Outbox pattern.

```java
@Bean
public IntegrationFlow orderCancelFlow(OrderService orderService, Clock clock) {
	return IntegrationFlow.from("order.cancel")
		.routeToRecipients(
				routes -> routes.transactional().recipientFlow(f -> f.<Long>handle((orderId, headers) -> {
					final int updated = orderService.cancel(orderId);
					return updated > 0 ? orderId : null; // (1)
				}).<Long, OrderEvents
						.Cancelled>transform(
								orderId -> new OrderEvents.Cancelled(orderId,
										clock.instant().atOffset(ZoneOffset.UTC))) // (2)
					.enrichHeaders(h -> h.header("eventType", "order_cancelled"))
					.channel("outbox")))
		.get();
}
```

| ç•ªå· | èª¬æ˜ |
| -- | -- |
| (1) | `OrderService#cancel` ã‚’å‘¼ã³å‡ºã™ã®MesageHandlerã‚’ä½œæˆã—ã¾ã™ã€‚æ›´æ–°ä»¶æ•°ãŒ0ã€ã¤ã¾ã‚Šæ›´æ–°å¯¾è±¡ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç ´æ£„ã—ã¾ã™ã€‚ |
| (2) | (2)ã®Endpointã®çµæœã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®Payloadã‚’`Order`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰Shipment Serviceã«é€ã‚‹`OrderEvents.Cancelled`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å¤‰æ›ã—ã¾ã™ã€‚ |


ã“ã“ã¾ã§ã®ãƒ•ãƒ­ãƒ¼ã‚’å›³ç¤ºã™ã‚‹ã¨ã€æ¬¡ã®å›³ã®ã‚ˆã†ã«ãªã‚Šã¾ã™(`enrichHeaders`ã®Endpointã¯çœç•¥ã—ã¦ã‚ã‚Šã¾ã™)ã€‚

![image](https://github.com/making/blog.ik.am/assets/106908/58f4fb75-24db-4869-a024-4e7c68ef77eb)


å—ä¿¡å´ã¯æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

```java
@Component
@Observed
public class OrderListener {

	private final ShipmentService shipmentService;

	private final ObjectMapper objectMapper;

	private final Logger log = LoggerFactory.getLogger(OrderListener.class);

	public OrderListener(ShipmentService shipmentService, ObjectMapper objectMapper) {
		this.shipmentService = shipmentService;
		this.objectMapper = objectMapper;
	}

	@RabbitListener(queues = "order.event")
	public void handleOrderEvent(JsonNode payload, @Header("eventType") String eventType) {
		switch (eventType) {
			case "order_created" -> {
				final OrderEvents.Created event = this.objectMapper.convertValue(payload, OrderEvents.Created.class);
				this.shipmentService.orderCreated(event);
			}
			case "order_cancelled" -> {
				final OrderEvents.Cancelled event = this.objectMapper.convertValue(payload,
						OrderEvents.Cancelled.class);
				this.shipmentService.orderCancelled(event);
			}
			default -> log.warn("Unknown Event Type: {}", eventType);
		}
	}

}
```


### ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®èµ·å‹•

ã§ã¯ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ã€OrderControllerã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚Java 17+ã¨DockerãŠã‚ˆã³Docker ComposeãŒå¿…è¦ã§ã™ã€‚

```
git clone https://github.com/making/outbox-pattern-demo
cd outbox-pattern-demo
```

ã¾ãšã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Order Serviceã‚’èµ·å‹•ã—ã¾ã™ã€‚

```
./mvnw clean spring-boot:run -f order-service -Dspring-boot.run.arguments=--spring.docker.compose.file=$(pwd)/docker-compose.yaml
```

Spring Boot 3.1ã§å°å…¥ã•ã‚ŒãŸ[Docker Composeã‚µãƒãƒ¼ãƒˆ](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.docker-compose)ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€è‡ªå‹•ã§Docker ComposeãŒèµ·å‹•ã—ã€PostgresSQL * 2ã€RabbitMQã€ZipkinãŒç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚

<br>

ã‚¢ãƒ—ãƒªãŒèµ·å‹•ã™ã‚‹ã¨ã€3ç§’ã”ã¨ã«æ¬¡ã®ã‚ˆã†ãªDEBUGãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯Message Relayå´ã§"outbox"ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹éš›ã®SQLãƒ­ã‚°ã§ã™ã€‚`INT_CHANNEL_MESSAGE`ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦`SELECT ... FOR UPDATE`ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚


```
2023-05-30T19:39:34.648+09:00 DEBUG [order-service,,] 15244 --- [   scheduling-1] o.s.orm.jpa.JpaTransactionManager        : Creating new transaction with name [org.springframework.integration.endpoint.AbstractPollingEndpoint$$Lambda$1931/0x0000000801799a30.call]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
2023-05-30T19:39:34.649+09:00 DEBUG [order-service,,] 15244 --- [   scheduling-1] o.s.orm.jpa.JpaTransactionManager        : Opened new EntityManager [SessionImpl(665386702<open>)] for JPA transaction
2023-05-30T19:39:34.651+09:00 DEBUG [order-service,6475d266281a7d296e14099b15056603,6e14099b15056603] 15244 --- [   scheduling-1] o.s.orm.jpa.JpaTransactionManager        : Exposing JPA transaction as JDBC [org.springframework.orm.jpa.vendor.HibernateJpaDialect$HibernateConnectionHandle@719fa2ea]
2023-05-30T19:39:34.652+09:00 DEBUG [order-service,6475d266281a7d296e14099b15056603,6e14099b15056603] 15244 --- [   scheduling-1] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-05-30T19:39:34.652+09:00 DEBUG [order-service,6475d266281a7d296e14099b15056603,6e14099b15056603] 15244 --- [   scheduling-1] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT INT_CHANNEL_MESSAGE.MESSAGE_ID, INT_CHANNEL_MESSAGE.MESSAGE_BYTES from INT_CHANNEL_MESSAGE where INT_CHANNEL_MESSAGE.GROUP_KEY = ? and INT_CHANNEL_MESSAGE.REGION = ? order by CREATED_DATE, MESSAGE_SEQUENCE LIMIT 1 FOR UPDATE]
2023-05-30T19:39:35.655+09:00 DEBUG [order-service,6475d266281a7d296e14099b15056603,6e14099b15056603] 15244 --- [   scheduling-1] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-05-30T19:39:35.655+09:00 DEBUG [order-service,6475d266281a7d296e14099b15056603,6e14099b15056603] 15244 --- [   scheduling-1] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT INT_CHANNEL_MESSAGE.MESSAGE_ID, INT_CHANNEL_MESSAGE.MESSAGE_BYTES from INT_CHANNEL_MESSAGE where INT_CHANNEL_MESSAGE.GROUP_KEY = ? and INT_CHANNEL_MESSAGE.REGION = ? order by CREATED_DATE, MESSAGE_SEQUENCE LIMIT 1 FOR UPDATE]
2023-05-30T19:39:35.658+09:00 DEBUG [order-service,6475d266281a7d296e14099b15056603,6e14099b15056603] 15244 --- [   scheduling-1] o.s.orm.jpa.JpaTransactionManager        : Initiating transaction commit
2023-05-30T19:39:35.658+09:00 DEBUG [order-service,6475d266281a7d296e14099b15056603,6e14099b15056603] 15244 --- [   scheduling-1] o.s.orm.jpa.JpaTransactionManager        : Committing JPA transaction on EntityManager [SessionImpl(665386702<open>)]
2023-05-30T19:39:35.660+09:00 DEBUG [order-service,6475d266281a7d296e14099b15056603,6e14099b15056603] 15244 --- [   scheduling-1] o.s.orm.jpa.JpaTransactionManager        : Closing JPA EntityManager [SessionImpl(665386702<open>)] after transaction
```

æ¬¡ã«ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Shipment Serviceã‚’èµ·å‹•ã—ã¾ã™ã€‚

```
./mvnw clean spring-boot:run -f shipment-service -Dspring-boot.run.arguments=--spring.docker.compose.file=$(pwd)/docker-compose.yaml
```

Order Serviceã«æ³¨æ–‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã™ã€‚

```
curl -s localhost:8080/orders -d "{\"amount\":50}" -H "content-type:application/json"
```

Order Serviceå´ã«æ¬¡ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```
2023-05-30T19:40:05.034+09:00 DEBUG [order-service,6475d2851c60c07b94f48ba27be40330,5e0461918b9baeab] 15244 --- [nio-8080-exec-1] o.s.orm.jpa.JpaTransactionManager        : Found thread-bound EntityManager [SessionImpl(621471343<open>)] for JPA transaction
2023-05-30T19:40:05.034+09:00 DEBUG [order-service,6475d2851c60c07b94f48ba27be40330,5e0461918b9baeab] 15244 --- [nio-8080-exec-1] o.s.orm.jpa.JpaTransactionManager        : Creating new transaction with name [org.springframework.integration.router.RecipientListRouter.handleMessage]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
2023-05-30T19:40:05.037+09:00 DEBUG [order-service,6475d2851c60c07b94f48ba27be40330,749b60ad16fa0f18] 15244 --- [nio-8080-exec-1] o.s.orm.jpa.JpaTransactionManager        : Exposing JPA transaction as JDBC [org.springframework.orm.jpa.vendor.HibernateJpaDialect$HibernateConnectionHandle@76bd8f3]
2023-05-30T19:40:05.038+09:00 DEBUG [order-service,6475d2851c60c07b94f48ba27be40330,749b60ad16fa0f18] 15244 --- [nio-8080-exec-1] o.s.orm.jpa.JpaTransactionManager        : Found thread-bound EntityManager [SessionImpl(621471343<open>)] for JPA transaction
2023-05-30T19:40:05.038+09:00 DEBUG [order-service,6475d2851c60c07b94f48ba27be40330,749b60ad16fa0f18] 15244 --- [nio-8080-exec-1] o.s.orm.jpa.JpaTransactionManager        : Participating in existing transaction
2023-05-30T19:40:05.046+09:00 DEBUG [order-service,6475d2851c60c07b94f48ba27be40330,797bb7fc586708fc] 15244 --- [nio-8080-exec-1] o.s.orm.jpa.JpaTransactionManager        : Found thread-bound EntityManager [SessionImpl(621471343<open>)] for JPA transaction
2023-05-30T19:40:05.046+09:00 DEBUG [order-service,6475d2851c60c07b94f48ba27be40330,797bb7fc586708fc] 15244 --- [nio-8080-exec-1] o.s.orm.jpa.JpaTransactionManager        : Participating in existing transaction
2023-05-30T19:40:05.061+09:00 DEBUG [order-service,6475d2851c60c07b94f48ba27be40330,797bb7fc586708fc] 15244 --- [nio-8080-exec-1] org.hibernate.SQL                        : insert into "order" (amount,order_date,status) values (?,?,?)
2023-05-30T19:40:05.077+09:00 DEBUG [order-service,6475d2851c60c07b94f48ba27be40330,33749e49f54ae50b] 15244 --- [nio-8080-exec-1] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-05-30T19:40:05.077+09:00 DEBUG [order-service,6475d2851c60c07b94f48ba27be40330,33749e49f54ae50b] 15244 --- [nio-8080-exec-1] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [INSERT into INT_CHANNEL_MESSAGE(MESSAGE_ID, GROUP_KEY, REGION, CREATED_DATE, MESSAGE_PRIORITY, MESSAGE_BYTES) values (?, ?, ?, ?, ?, ?)]
2023-05-30T19:40:05.090+09:00 DEBUG [order-service,6475d2851c60c07b94f48ba27be40330,749b60ad16fa0f18] 15244 --- [nio-8080-exec-1] o.s.orm.jpa.JpaTransactionManager        : Initiating transaction commit
2023-05-30T19:40:05.091+09:00 DEBUG [order-service,6475d2851c60c07b94f48ba27be40330,749b60ad16fa0f18] 15244 --- [nio-8080-exec-1] o.s.orm.jpa.JpaTransactionManager        : Committing JPA transaction on EntityManager [SessionImpl(621471343<open>)]
2023-05-30T19:40:05.097+09:00 DEBUG [order-service,6475d2851c60c07b94f48ba27be40330,749b60ad16fa0f18] 15244 --- [nio-8080-exec-1] o.s.orm.jpa.JpaTransactionManager        : Not closing pre-bound JPA EntityManager after transaction
2023-05-30T19:40:05.097+09:00  INFO [order-service,6475d2851c60c07b94f48ba27be40330,94f48ba27be40330] 15244 --- [nio-8080-exec-1] c.e.outbox.order.web.OrderController     : Created Order{orderId=1, amount=50, status=CREATED, orderDate=2023-05-30T10:40:05.027954Z}
2023-05-30T19:40:05.125+09:00  INFO [order-service,6475d2851c60c07b94f48ba27be40330,5e0461918b9baeab] 15244 --- [nio-8080-exec-1] accesslog                                : remote=127.0.0.1 ts="2023-05-30T10:40:05.004566Z" method=POST url="http://localhost:8080/orders" status=200 ua="curl/7.87.0" response_time=120
```

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚ŒãŸå¾Œã€`insert into "order" ...`ã¨`INSERT into INT_CHANNEL_MESSAGE ...`ãŒå®Ÿè¡Œã•ã‚Œã¦ã€ãã®å¾Œã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã®ä¸€é€£ã®å‡¦ç†ã¯Trace ID `6475d2851c60c07b94f48ba27be40330` ã§ãƒˆãƒ¬ãƒ¼ã‚¹ã•ã‚Œã¦ã„ã¾ã™ã€‚

Zipkinã§`6475d2851c60c07b94f48ba27be40330`ã®Traceã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

HTTPã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ãŒãƒˆãƒ¬ãƒ¼ã‚¹ã•ã‚Œã¦ã„ã¾ã™ã€‚

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/721c0f3b-cfec-46d9-91c5-f0f685506b77">
<!-- <img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/36a9e36f-c6df-4df1-8c92-5814de654654"> -->

Span NameãŒ`connection`ã«ãªã£ã¦ã„ã‚‹ã®ãŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã‚’è¡Œã£ã¦ã„ã‚‹Spanã§ã™ã€‚

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/dd1a1231-cd72-4f4d-a73f-f8e3158d097b">
<!-- <img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/0fea3bad-6b64-49ce-b92a-b3d9af02a831"> -->

ã“ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã€`insert into "order" ...`ã¨ã€

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/4aafe15b-2877-45ac-a627-e618d62987e9">
<!-- <img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/6ccc552f-9b98-4078-8cc6-d8d802af0145"> -->

`INSERT into INT_CHANNEL_MESSAGE ...`ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒTraceã‹ã‚‰ã‚‚ã‚ã‹ã‚Šã¾ã™ã€‚

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/495b2bff-2bfb-43f4-84b1-12c5f4550e84">
<!-- <img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/69a588a1-260c-4b84-a144-29252fba9a6d"> -->

ã—ã°ã‚‰ãã—ã¦Order Serviceã®Message Relayå´ã®å‡¦ç†ã®ãƒ­ã‚°ã‚‚å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```
2023-05-30T19:40:06.755+09:00 DEBUG [order-service,6475d28681fab3a59d13cb361f68e48d,9d13cb361f68e48d] 15244 --- [   scheduling-1] o.s.orm.jpa.JpaTransactionManager        : Exposing JPA transaction as JDBC [org.springframework.orm.jpa.vendor.HibernateJpaDialect$HibernateConnectionHandle@bf6fa00]
2023-05-30T19:40:06.755+09:00 DEBUG [order-service,6475d28681fab3a59d13cb361f68e48d,9d13cb361f68e48d] 15244 --- [   scheduling-1] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL query
2023-05-30T19:40:06.755+09:00 DEBUG [order-service,6475d28681fab3a59d13cb361f68e48d,9d13cb361f68e48d] 15244 --- [   scheduling-1] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [SELECT INT_CHANNEL_MESSAGE.MESSAGE_ID, INT_CHANNEL_MESSAGE.MESSAGE_BYTES from INT_CHANNEL_MESSAGE where INT_CHANNEL_MESSAGE.GROUP_KEY = ? and INT_CHANNEL_MESSAGE.REGION = ? order by CREATED_DATE, MESSAGE_SEQUENCE LIMIT 1 FOR UPDATE]
2023-05-30T19:40:06.763+09:00 DEBUG [order-service,6475d28681fab3a59d13cb361f68e48d,9d13cb361f68e48d] 15244 --- [   scheduling-1] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL update
2023-05-30T19:40:06.763+09:00 DEBUG [order-service,6475d28681fab3a59d13cb361f68e48d,9d13cb361f68e48d] 15244 --- [   scheduling-1] o.s.jdbc.core.JdbcTemplate               : Executing prepared SQL statement [DELETE from INT_CHANNEL_MESSAGE where MESSAGE_ID=? and GROUP_KEY=? and REGION=?]
2023-05-30T19:40:06.769+09:00  INFO [order-service,6475d28681fab3a59d13cb361f68e48d,9d13cb361f68e48d] 15244 --- [   scheduling-1] amqpHandler                              : Send {"orderId":1,"amount":5E+1,"orderDate":"2023-05-30T10:40:05.027954Z"}
2023-05-30T19:40:06.778+09:00  INFO [order-service,6475d28681fab3a59d13cb361f68e48d,9d13cb361f68e48d] 15244 --- [   scheduling-1] o.s.a.r.c.CachingConnectionFactory       : Attempting to connect to: [127.0.0.1:5672]
2023-05-30T19:40:06.809+09:00  INFO [order-service,6475d28681fab3a59d13cb361f68e48d,9d13cb361f68e48d] 15244 --- [   scheduling-1] o.s.a.r.c.CachingConnectionFactory       : Created new connection: rabbitConnectionFactory#5b115d71:0/SimpleConnection@19e406fa [delegate=amqp://guest@127.0.0.1:5672/, localPort=54381]
2023-05-30T19:40:06.831+09:00 DEBUG [order-service,6475d28681fab3a59d13cb361f68e48d,9d13cb361f68e48d] 15244 --- [   scheduling-1] o.s.orm.jpa.JpaTransactionManager        : Initiating transaction commit
2023-05-30T19:40:06.831+09:00 DEBUG [order-service,6475d28681fab3a59d13cb361f68e48d,9d13cb361f68e48d] 15244 --- [   scheduling-1] o.s.orm.jpa.JpaTransactionManager        : Committing JPA transaction on EntityManager [SessionImpl(1566708299<open>)]
2023-05-30T19:40:06.834+09:00 DEBUG [order-service,6475d28681fab3a59d13cb361f68e48d,9d13cb361f68e48d] 15244 --- [   scheduling-1] o.s.orm.jpa.JpaTransactionManager        : Closing JPA EntityManager [SessionImpl(1566708299<open>)] after transaction
```

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚ŒãŸå¾Œã€`SELECT ... from INT_CHANNEL_MESSAGE ... FOR UPDATE`ã¨`DELETE from INT_CHANNEL_MESSAGE ...`ãŒå®Ÿè¡Œã•ã‚Œã€RabbitMQã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚ŒãŸå¾Œã«ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

Message Relayå´ã®å‡¦ç†ã¯POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã¨ã¯åˆ¥ã®Trace ID (`6475d28681fab3a59d13cb361f68e48d`)ã§ãƒˆãƒ¬ãƒ¼ã‚¹ã•ã‚Œã¦ã„ã¾ã™ã€‚

Shipment Serviceå´ã«ã¯æ¬¡ã®ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã¡ã‚‰ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã¨åŒã˜Trace ID (`6475d28681fab3a59d13cb361f68e48d`) ã§ãƒˆãƒ¬ãƒ¼ã‚¹ã•ã‚Œã¦ã„ã¾ã™ã€‚

```
2023-05-30T19:40:06.864+09:00  INFO [shipment-service,6475d28681fab3a59d13cb361f68e48d,2c76e61f1852629c] 15275 --- [ntContainer#0-1] c.e.outbox.shipment.ShipmentService      : Created order: Created[orderId=1, amount=50.0, orderDate=2023-05-30T10:40:05.027954Z]
2023-05-30T19:40:06.882+09:00 DEBUG [shipment-service,6475d28681fab3a59d13cb361f68e48d,2c76e61f1852629c] 15275 --- [ntContainer#0-1] org.hibernate.SQL                        : insert into shipment (order_date,order_id) values (?,?)
2023-05-30T19:40:06.900+09:00  INFO [shipment-service,6475d28681fab3a59d13cb361f68e48d,2c76e61f1852629c] 15275 --- [ntContainer#0-1] c.e.outbox.shipment.ShipmentService      : Create shipment: Shipment{shipmentId=1, orderId=1, orderDate=2023-05-30T10:40:05.027954Z}
```

Zipkinã§`6475d28681fab3a59d13cb361f68e48d`ã®Traceã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

Order Serviceã®Message Relayå´ã®å‡¦ç†ã¨Shipment Serviceã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡å‡¦ç†ãŒãƒˆãƒ¬ãƒ¼ã‚¹ã•ã‚Œã¦ã„ã¾ã™ã€‚

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/232530d4-03ee-4eb4-8cc2-d2c3d4964f87">
<!-- <img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/9d74b0ee-5260-454e-8435-f2a8e2f8b7c1"> -->

Message Relayå´ã®å‡¦ç†ã®`connection` Span (=ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³)ã®ä¸­ã§ã€`SELECT ... from INT_CHANNEL_MESSAGE ... FOR UPDATE`ã¨

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/dd220809-b2aa-4f87-bafb-75898575f325">
<!-- <img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/14d75982-d228-4334-82e9-a290a116842a"> -->

`DELETE from INT_CHANNEL_MESSAGE ...`ãŒå®Ÿè¡Œã•ã‚Œã€

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/40f67ea8-3c18-436e-bd17-ca6bd07a2e54">
<!-- <img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/10a16b3b-9888-4785-8a70-c6e3f90bac95">-->

ã¾ãŸã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã‚‚åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒTraceã‹ã‚‰ã‚‚ã‚ã‹ã‚Šã¾ã™ã€‚

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/cb2c0a5b-9c29-496b-b146-57941b2ce538">
<!-- <img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/3332c12c-6e6b-4179-bd00-042482ca7046"> -->

---

Spring Integrationã ã‘ã§Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå®Ÿè£…ã§ãã¾ã—ãŸã€‚<br>
ä»Šå›ã®æ–¹æ³•ã¯ã€ä»–ã®æ‰‹æ³•ã«æ¯”ã¹ã¦ã€Spring Integrationã®çŸ¥è­˜ãŒã‚ã‚Œã°ã€æ—¢å­˜ã®ä»•çµ„ã¿ã ã‘ã§ã‚·ãƒ³ãƒ—ãƒ«ã«Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå®Ÿè£…ã§ãã‚‹ã®ãŒãƒ¡ãƒªãƒƒãƒˆã§ã™ã€‚<br>
Pollingã«ã‹ã‹ã‚‹è² è·ãŒæ°—ã«ãªã‚‹ã¨ã“ã‚ã§ã™ãŒã€PostgreSQLé™å®šã«ã¯ãªã‚Šã¾ã™ãŒã€outboxã®MessageChannelå®Ÿè£…ã¨ã—ã¦ã€"[PostgreSQL: Receiving Push Notifications](https://docs.spring.io/spring-integration/docs/current/reference/html/jdbc.html#postgresql-push)" ã®`PostgresSubscribableChannel`ã‚’ä½¿ç”¨ã™ã‚Œã°Pollingã®è² è·ã‚’ãªãã›ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

> ä»¥å‰ã«`PostgresSubscribableChannel`ã‚’è©¦ã—ãŸã¨ãã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã—ã¦ã„ãªã‹ã£ãŸã®ã§ã€ä»Šå›ã®å®Ÿè£…ã§æ¡ç”¨ã—ã¾ã›ã‚“ã§ã—ãŸãŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹ã¨6.0.5ã‹ã‚‰ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã—ãŸã‚ˆã†ãªã®ã§ã€å†åº¦è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

### (ä½™è«‡) Partitionã®å¯¾å¿œ

Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã®è©±ã¨ã¯ç›´æ¥é–¢ä¿‚ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€Eventã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã—ãŸã„å ´åˆã«ã€Partitionã‚µãƒãƒ¼ãƒˆãŒæ¬²ã—ã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡å´ãŒã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã—ãŸéš›ã«ã€å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†ãŒä¸¦åˆ—ã«è¡Œã‚ã‚Œã¾ã™ã€‚ä»Šå›ã®å®Ÿè£…ã§ã¯ã©ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§å‡¦ç†ã•ã‚Œã‚‹ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚

ä¾‹ãˆã°ã€åŒã˜æ³¨æ–‡IDã‚„åŒã˜é¡§å®¢IDã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§é †ç•ªã«å‡¦ç†ã•ã›ãŸã„å ´åˆã«ã¯ã€IDã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å¯¾å¿œã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
é€šå¸¸ã®RabbitMQã§å®Ÿè£…ã™ã‚‹å ´åˆã¯ã€è¤‡æ•°ã®ã‚­ãƒ¥ãƒ¼ã‚’å®šç¾©ã—ã¦ã€routing keyã§IDã¨ã‚­ãƒ¥ãƒ¼ã‚’é–¢é€£ä»˜ã‘ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

[Spring Cloud Stream](https://spring.io/projects/spring-cloud-stream)ã‚’ä½¿ç”¨ã—ãŸå ´åˆã¯ã“ã®ä½œæ¥­ã¯[Partitionã‚µãƒãƒ¼ãƒˆ](https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#spring-cloud-stream-overview-partitioning)ã«ã‚ˆã£ã¦é€éçš„ã«è¡Œã‚ã‚Œã¾ã™ã€‚

[RabbitMQ Streams](https://www.rabbitmq.com/streams.html)ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€RabbitMQ 3.11ã§ã‚µãƒãƒ¼ãƒˆã•ã‚ŒãŸ[Single Active Consumer](https://www.rabbitmq.com/streams.html#single-active-consumer)ã¨[Super Streams](https://www.rabbitmq.com/streams.html#super-streams)ã§å¯¾å¿œã§ãã¾ã™ã€‚
https://github.com/acogoluegnes/rabbitmq-stream-single-active-consumer ã®ã‚µãƒ³ãƒ—ãƒ«ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚Spring AMQPã‚„Spring Integationã‚‚Super Streamsã«å¯¾å¿œã—ã¦ã„ã‚‹ã®ã§ã€ä»Šåº¦è©¦ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

ã‚ã‚‹ã„ã¯Apache Kafkaã‚’ä½¿ã£ãŸå ´åˆã¯nativeã«Patitionã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã®ã§ã€RabbitMQã®ä»£ã‚ã‚Šã«Kafkaã‚’ä½¿ç”¨ã—ã¦ã‚‚è‰¯ã„ã§ã—ã‚‡ã†ã€‚([Artemã®ã‚µãƒ³ãƒ—ãƒ«](https://github.com/artembilan/microservices-patterns-spring-integration/tree/main/outbox)ã§ã¯KafkaãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚)

---

**P.S.**

[PartitinonedChannel](https://docs.spring.io/spring-integration/docs/6.1.0/reference/html/channel.html#partitioned-channel)ãŒSpring Integration 6.1ã§å°å…¥ã•ã‚Œã¦ã„ã¾ã—ãŸ!

ã¾ãŸã€Artemã«ã‚ˆã‚‹ã¨[Debeziumã®ã‚µãƒãƒ¼ãƒˆ](https://github.com/spring-projects/spring-integration/commit/8b004e9ec2be349cd112c84ba7075e84f1eaa232)ã‚‚å°å…¥ã•ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">With <a href="https://twitter.com/christzolov?ref_src=twsrc%5Etfw">@christzolov</a> we look into a Debezium variant of this pattern implementation . Spring Integration 6.1 also provides a PartitionedChannel implementation . <a href="https://t.co/0VAGwOLaKN">https://t.co/0VAGwOLaKN</a></p>&mdash; Artem Bilan ğŸ‡ºğŸ‡¦ (@artem_bilan) <a href="https://twitter.com/artem_bilan/status/1663864998769094656?ref_src=twsrc%5Etfw">May 31, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
