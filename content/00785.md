---
title: Tanzu Application PlatformのContourをOpenTelemetryでTracingするメモ
tags: ["Kubernetes", "Tanzu", "TAP", "Grafana", "Tempo", "Tracing", "Contour", "OpenTelemetry"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP", "Tracing"]
---


<img width="910" src="https://github.com/making/blog.ik.am/assets/106908/4f102edf-2e5c-485b-a39d-d77288c3a18c">


```
helm repo add grafana https://grafana.github.io/helm-charts
```

```
helm upgrade tempo \
  -n tempo \
  grafana/tempo \
  --set tempo.receivers.zipkin=null \
  --create-namespace \
  --install \
  --wait
```

```
$ kubectl get pod -n tempo
NAME      READY   STATUS    RESTARTS   AGE
tempo-0   1/1     Running   0          9s
```

```yaml
cat <<EOF > helm-values.yaml
---
adminUser: grafana
adminPassword: grafana
testFramework:
  enabled: false
ingress:
  enabled: true
  hosts:
  - grafana.tapv-huge-hornet.tapsandbox.com
  tls:
  - hosts:
    - grafana.tapv-huge-hornet.tapsandbox.com
    secretName: grafana-tls
  annotations:
    cert-manager.io/cluster-issuer: gcloud-public-ca
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
    - name: Tempo
      uid: grafana-traces
      type: tempo
      access: proxy
      orgId: 1
      url: http://tempo.tempo.svc.cluster.local:3100
      editable: true
---
EOF
```

```
helm upgrade grafana \
  -n grafana \
  grafana/grafana \
  -f helm-values.yaml \
  --create-namespace \
  --install \
  --wait
```


```
$ kubectl get pod,ing -n grafana
NAME                           READY   STATUS    RESTARTS   AGE
pod/grafana-7cb85d6cfc-qp2j8   1/1     Running   0          2m36s

NAME                                CLASS    HOSTS                                     ADDRESS         PORTS     AGE
ingress.networking.k8s.io/grafana   <none>   grafana.tapv-huge-hornet.tapsandbox.com   35.238.162.93   80, 443   2m36s
```

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/fdfe8065-8d65-420f-af13-7a86387ce8c7">

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/34de8239-9dd5-4957-bb26-2bb93ba8158c">

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/cf3848bd-7819-4d3e-8f3a-4536e3f8760b">

https://projectcontour.io/docs/1.27/config/tracing/

```yaml
cat <<EOF > tempo-extension.yaml
---
apiVersion: projectcontour.io/v1alpha1
kind: ExtensionService
metadata:
  name: tempo
  namespace: tempo
spec:
  protocol: h2c
  services:
  - name: tempo
    port: 4317
---
EOF

kubectl apply -f tempo-extension.yaml
```

```yaml
contour:
  contour:
    configFileContents:
      tracing:
        includePodDetail: true
        extensionService: tempo/tempo
        serviceName: contour
      accesslog-format: json
      json-fields:
      - "@timestamp"
      - "authority"
      - "bytes_received"
      - "bytes_sent"
      - "traceparent=%REQ(TRACEPARENT)%" # <--
      - "duration"
      - "method"
      - "path"
      - "protocol"
      - "referer=%REQ(REFERER)%"
      - "request_id"
      - "requested_server_name"
      - "response_code"
      - "upstream_cluster"
      - "user_agent"
      - "x_forwarded_for"
```

```
tanzu package installed update tap -n tap-install --values-file tap-values.yaml 
```

```
kubectl delete pod -n tanzu-system-ingress -l app=contour --force
```

```
kubectl logs -n tanzu-system-ingress -l app=envoy -c envoy -f
```

```
{"referer":null,"duration":38,"upstream_cluster":"apps_rest-service-00004_80","user_agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","bytes_sent":60,"protocol":"HTTP/2","x_forwarded_for":"192.168.3.1","requested_server_name":"rest-service-apps.tapv-huge-hornet.tapsandbox.com","path":"/greeting","traceparent":"00-7a352f8ac8b545bce79e439cbe595687-dbd8a641798bfa4d-01","@timestamp":"2024-01-25T09:34:43.018Z","method":"GET","request_id":"aeff3400-fed7-9e1f-bf39-de29ee7b7078","authority":"rest-service-apps.tapv-huge-hornet.tapsandbox.com","bytes_received":0,"response_code":200}
```

`00-7a352f8ac8b545bce79e439cbe595687-dbd8a641798bfa4d-01`

`7a352f8ac8b545bce79e439cbe595687`

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/6d198a32-3a2b-4863-b379-9b978af4e974">

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/83ef2250-9fa2-425d-8fc6-0064f72c1f3b">


<img width="802" src="https://github.com/making/blog.ik.am/assets/106908/a6cbd19e-e166-41e0-9f62-da61308faeaa">

```
tanzu apps workload apply blog-api \
  --app blog-api \
  --git-repo https://github.com/categolj/blog-api \
  --git-branch main \
  --type web \
  --annotation autoscaling.knative.dev/minScale=1 \
  --label apps.tanzu.vmware.com/has-tests=true \
  --service-ref blog-db=services.apps.tanzu.vmware.com/v1alpha1:ClassClaim:blog-db \
  --build-env BP_JVM_VERSION=17 \
  --env MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://tempo.tempo.svc.cluster.local:9411 \
  -n apps
```


```
curl -s https://blog-api-apps.tapv-huge-hornet.tapsandbox.com/entries/template.md > template.md
curl -s -u admin:changeme -XPUT https://blog-api-apps.tapv-huge-hornet.tapsandbox.com/entries/2 -H "Content-Type: text/markdown" -d "$(cat template.md)"
curl -s https://blog-api-apps.tapv-huge-hornet.tapsandbox.com/entries/2 | jq .
```

```
{"@timestamp":"2024-01-25T10:06:37.820Z","authority":"blog-api-apps.tapv-huge-hornet.tapsandbox.com","bytes_received":197,"requested_server_name":"blog-api-apps.tapv-huge-hornet.tapsandbox.com","path":"/entries/2","user_agent":"curl/8.1.2","upstream_cluster":"apps_blog-api-00002_80","response_code":200,"traceparent":"00-98a0891be5a08d923da6feebb2aab04f-8ef8b9f68a8ee1b2-01","bytes_sent":412,"x_forwarded_for":"10.0.1.8","method":"PUT","referer":null,"duration":967,"request_id":"2c9cc4c5-e2c7-90f6-8680-8eeab7fbdaf2","protocol":"HTTP/2"}
```

`98a0891be5a08d923da6feebb2aab04f`

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/2d6f3d7f-3c2e-4d3c-a940-ffebf365b6ef">

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/7233c8e7-f022-4252-9495-29165ef715df">

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/e6b8e51f-396c-472f-a82c-2f13e1575023">

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/6a53b7ac-967f-4a04-9023-4354901198eb">

https://github.com/open-telemetry/opentelemetry-operator

<img width="1017" src="https://github.com/making/blog.ik.am/assets/106908/6135fcbd-8f67-446e-9e9c-080daef65aac">


```
kubectl apply -f https://github.com/open-telemetry/opentelemetry-operator/releases/latest/download/opentelemetry-operator.yaml
```

```
kubectl apply -f https://github.com/open-telemetry/opentelemetry-operator/releases/download/v0.92.1/opentelemetry-operator.yaml
```

```
$ kubectl get pod -n opentelemetry-operator-system
NAME                                                         READY   STATUS    RESTARTS   AGE
opentelemetry-operator-controller-manager-5fb8cbf79b-8xlkl   2/2     Running   0          104m
```

```yaml
cat <<'EOF' > otelcol.yaml
---
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: otel
  namespace: opentelemetry
spec:
  config: |
    receivers:
      otlp:
        protocols:
          grpc: {}
          http: {}
    processors:
      filter:
        # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/filterprocessor
        error_mode: ignore
        traces:
          span:
          - IsMatch(attributes["upstream_cluster"], "grafana/.*")
          - IsMatch(attributes["upstream_cluster"], "tap-gui/.*")
          - IsMatch(attributes["upstream_cluster"], "appsso/.*")
          - IsMatch(attributes["http.url"], "https://grafana.*")
      batch:
        send_batch_size: 10000
        timeout: 10s
    exporters: 
      otlp/tempo:
        endpoint: http://tempo.tempo.svc.cluster.local:4317
        tls:
          insecure: true
    service:
      pipelines:
        traces:
          receivers:
          - otlp
          processors:
          - filter
          - batch
          exporters:
          - otlp/tempo
---
EOF

kubectl create namespace opentelemetry
kubectl apply -f otelcol.yaml
```

```
$ kubectl get otelcol,pod,svc -n opentelemetry
NAME                                           MODE         VERSION   READY   AGE   IMAGE                                                                                    MANAGEMENT
opentelemetrycollector.opentelemetry.io/otel   deployment   0.92.0    1/1     6s    ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector:0.92.0   managed

NAME                                  READY   STATUS    RESTARTS   AGE
pod/otel-collector-75fb5c8dc5-kssmp   1/1     Running   0          5s

NAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/otel-collector              ClusterIP   192.168.73.127   <none>        4317/TCP,4318/TCP   7s
service/otel-collector-headless     ClusterIP   None             <none>        4317/TCP,4318/TCP   7s
service/otel-collector-monitoring   ClusterIP   192.168.68.138   <none>        8888/TCP            7s
```

```yaml
cat <<EOF > otelcol-extension.yaml
---
apiVersion: projectcontour.io/v1alpha1
kind: ExtensionService
metadata:
  name: otel-collector
  namespace: opentelemetry
spec:
  protocol: h2c
  services:
  - name: otel-collector
    port: 4317
---
EOF

kubectl apply -f otelcol-extension.yaml
```

```yaml
contour:
  contour:
    configFileContents:
      tracing:
        includePodDetail: true
        extensionService: opentelemetry/otel-collector #! <---
        serviceName: contour
```

```
tanzu package installed update tap -n tap-install --values-file tap-values.yaml 
```

```
kubectl delete pod -n tanzu-system-ingress -l app=contour --force
```

<img width="996" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/d9423169-b90e-4af9-86bc-353b17f6db48">

```yaml
cat <<EOF > instrumentation.yaml
---
apiVersion: opentelemetry.io/v1alpha1
kind: Instrumentation
metadata:
  name: default
  namespace: opentelemetry
spec:
  exporter:
    endpoint: http://otel-collector.opentelemetry.svc.cluster.local:4317
  propagators:
  - tracecontext
  - baggage
  sampler:
   type: parentbased_traceidratio
   argument: "1.0"
---
EOF

kubectl apply -f instrumentation.yaml
```

```
$ kubectl get instrumentation -n opentelemetry
NAME      AGE   ENDPOINT                                                     SAMPLER                    SAMPLER ARG
default   8s    http://otel-collector.opentelemetry.svc.cluster.local:4317   parentbased_traceidratio   1.0
```

```
tanzu apps workload apply rest-service \
  --app rest-service \
  --git-repo https://github.com/making/rest-service \
  --git-branch main \
  --type web \
  --label apps.tanzu.vmware.com/has-tests=true \
  --annotation autoscaling.knative.dev/minScale=1 \
  --annotation instrumentation.opentelemetry.io/inject-java=opentelemetry/default \
  --build-env BP_JVM_VERSION=17 \
  -n apps
```

```
tanzu apps workload tail rest-service --namespace apps --timestamp --since 10m --component run
```

```
rest-service-00005-deployment-757f998ddc-gvp64[workload] 2024-01-26T16:36:38.131807287+09:00 Picked up JAVA_TOOL_OPTIONS: -Dmanagement.endpoint.health.probes.add-additional-paths="true" -Dmanagement.health.probes.enabled="true" -Dserver.port="8080" -Dserver.shutdown.grace-period="24s" -javaagent:/otel-auto-instrumentation-java/javaagent.jar -Djava.security.properties=/layers/tanzu-buildpacks_bellsoft-liberica/java-security-properties/java-security.properties -XX:+ExitOnOutOfMemoryError -XX:ActiveProcessorCount=2 -XX:MaxDirectMemorySize=10M -Xmx6414426K -XX:MaxMetaspaceSize=103345K -XX:ReservedCodeCacheSize=240M -Xss1M -XX:+UnlockDiagnosticVMOptions -XX:NativeMemoryTracking=summary -XX:+PrintNMTStatistics -Dorg.springframework.cloud.bindings.boot.enable=true
rest-service-00005-deployment-757f998ddc-gvp64[workload] 2024-01-26T16:36:38.329771913+09:00 OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
rest-service-00005-deployment-757f998ddc-gvp64[workload] 2024-01-26T16:36:38.588003672+09:00 [otel.javaagent 2024-01-26 07:36:38:586 +0000] [main] INFO io.opentelemetry.javaagent.tooling.VersionLogger - opentelemetry-javaagent - version: 1.32.0
```

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/71fda4ea-b70d-44d0-bb1b-1e4bd06e31f1">

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/03fb8eec-e6ab-4943-b6ad-b8f8c0458e7f">

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/f61f5533-b529-42a1-a38f-7457b71a70a5">

```yaml
        traces:
          span:
          # ...
          - attributes["http.route"] == "/livez"
          - attributes["http.route"] == "/readyz"
          - attributes["user_agent.original"] == "kube-probe//"
          - attributes["user_agent"] == "Knative-Ingress-Probe"
          - name == "OperationHandler.handle"
```

```
kubectl apply -f otelcol.yaml
```

```yaml
    processors:
      # ...
      attributes:
        actions:
        - key: cluster
          value: tap-sandbox
          action: upsert
    # ...
    service:
      pipelines:
        traces:
          receivers:
          - otlp
          processors:
          - filter
          - attributes # <--
          - batch
          exporters:
          - otlp/tempo
```

<img width="1790" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/511afde3-270b-49e0-8d86-c0bb68c6fa30">

<img width="1788" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/0682c2ac-20a5-457f-b56a-7746730a8a47">


```
tanzu apps workload apply hello-nodejs \
  --app hello-nodejs \
  --git-repo https://github.com/making/hello-nodejs \
  --git-branch master \
  --type web \
  --label apps.tanzu.vmware.com/has-tests=true \
  --annotation autoscaling.knative.dev/minScale=1 \
  --annotation instrumentation.opentelemetry.io/inject-nodejs=opentelemetry/default \
  -n apps
```

<img width="1800" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/d540f343-420b-42a4-9404-9818fc2468bb">
