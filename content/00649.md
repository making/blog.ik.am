---
title: Carvel kwtã§k8sã‚¯ãƒ©ã‚¹ã‚¿å¤–ã‹ã‚‰å†…éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³åã§Service / Podã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
tags: ["kwt", "Kubernetes", "Carvle"]
categories: ["Dev", "Carvel", "kwt"]
---

Kuberneteså‘ã‘ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«ç¾¤ã® [Carvel](https://carvel.dev/) ã®ä¸€ã¤ã§ã‚ã‚‹ [`kwt`](https://github.com/vmware-tanzu/carvel-kwt) ã‚’ä½¿ã†ã¨k8sã‚¯ãƒ©ã‚¹ã‚¿å¤–ã‹ã‚‰å†…éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³åã§Service / Podã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„å†…éƒ¨APIãªã©ã®å¤–éƒ¨ã«å…¬é–‹ã—ã¦ã„ãªã„Serviceã«å¯¾ã—ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ä¸Šã®é–‹ç™ºç’°å¢ƒã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆã‚„ã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ç–é€šã‚’ç¢ºèªã—ãŸã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚

é€šå¸¸ã¯`kubectl proxy`ã‚„`kubectl port-foward`ã‚’ä½¿ã£ã¦Podã‚„Serviceã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒå¤šã„ã¨æ€ã„ã¾ã™ãŒã€
`kwt`ã‚’ä½¿ã†ã¨å†…éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’ä½¿ç”¨ã§ãã‚‹ã®ã§ã‚ˆã‚Šk8så†…ã®ç’°å¢ƒã«è¿‘ã„å½¢ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã—ã€å€‹ã€…ã«port forwardã®è¨­å®šã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

> åŒæ§˜ãªãƒ„ãƒ¼ãƒ«ã« [Telepresence](https://www.telepresence.io/) ãŒã‚ã‚Šã¾ã™ã€‚Telepresenceã‚’ä½¿ã£ãŸã“ã¨ã¯ãªã„ã§ã™ãŒã€ã±ã£ã¨è¦‹`kwt`ã®æ–¹ãŒã‚·ãƒ³ãƒ—ãƒ«ã§æ‰‹è»½ã«ä½¿ãˆãã†ã«è¦‹ãˆã¾ã™ã€‚

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ [ã“ã¡ã‚‰](https://github.com/vmware-tanzu/carvel-kwt/blob/develop/docs/network.md) ã€‚


### kwtã‚’è©¦ã™ãŸã‚ã®ä¸‹æº–å‚™

#### kwtã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

`kwt`ã¯Brewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

```
$ brew tap vmware-tanzu/carvel
$ brew install kwt
```

ã‚ã‚‹ã„ã¯
https://github.com/vmware-tanzu/carvel-kwt/releases
ã‹ã‚‰ãƒã‚¤ãƒŠãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚OS Xã¨Linuxã®ã¿ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚

#### k8sã‚¯ãƒ©ã‚¹ã‚¿ã®ä½œæˆ

ã¾ãšã¯`kind`ã§k8sã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚

```
$ kind create cluster
Creating cluster "kind" ...
 âœ“ Ensuring node image (kindest/node:v1.21.1) ğŸ–¼ 
 âœ“ Preparing nodes ğŸ“¦  
 âœ“ Writing configuration ğŸ“œ 
 âœ“ Starting control-plane ğŸ•¹ï¸ 
 âœ“ Installing CNI ğŸ”Œ 
 âœ“ Installing StorageClass ğŸ’¾ 
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Thanks for using kind! ğŸ˜Š
```

#### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤

ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦[Guestbook](https://github.com/kubernetes/examples/tree/master/guestbook)ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

```
kubectl apply -f https://github.com/kubernetes/examples/raw/master/guestbook/all-in-one/guestbook-all-in-one.yaml
```

ä½œæˆã•ã‚Œã‚‹Podã¨Serviceã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```
$ kubectl get pod,svc
NAME                               READY   STATUS    RESTARTS   AGE
pod/frontend-6c6d6dfd4d-c5jzr      1/1     Running   0          90s
pod/frontend-6c6d6dfd4d-dc77g      1/1     Running   0          90s
pod/frontend-6c6d6dfd4d-rknb6      1/1     Running   0          90s
pod/redis-master-f46ff57fd-2dmpv   1/1     Running   0          90s
pod/redis-slave-7979cfdfb8-7wgcd   1/1     Running   0          90s
pod/redis-slave-7979cfdfb8-h227s   1/1     Running   0          90s

NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
service/frontend       NodePort    10.96.51.181    <none>        80:32472/TCP   90s
service/kubernetes     ClusterIP   10.96.0.1       <none>        443/TCP        35m
service/redis-master   ClusterIP   10.96.66.101    <none>        6379/TCP       90s
service/redis-slave    ClusterIP   10.96.250.255   <none>        6379/TCP       90s
```

ãªãŠã€`kwt net svc`ã¨`kwt net pod`ã‚³ãƒãƒ³ãƒ‰ã§ã€Serviceã¨Podã®å†…éƒ¨DNSåä¸€è¦§ã‚’å–å¾—ã§ãã¾ã™ã€‚

```
$ kwt net svc
Services in namespace 'default'

Name          Internal DNS                            Cluster IP     Ports  
frontend      frontend.default.svc.cluster.local      10.96.51.181   80/tcp  
kubernetes    kubernetes.default.svc.cluster.local    10.96.0.1      443/tcp  
redis-master  redis-master.default.svc.cluster.local  10.96.66.101   6379/tcp  
redis-slave   redis-slave.default.svc.cluster.local   10.96.250.255  6379/tcp

4 services

Succeeded

$ kwt net pod
Pods in namespace 'default'

Name                          Internal DNS                           IP           Ports  
frontend-6c6d6dfd4d-c5jzr     10-244-0-5.default.pod.cluster.local   10.244.0.5   80/tcp  
frontend-6c6d6dfd4d-dc77g     10-244-0-9.default.pod.cluster.local   10.244.0.9   80/tcp  
frontend-6c6d6dfd4d-rknb6     10-244-0-10.default.pod.cluster.local  10.244.0.10  80/tcp  
redis-master-f46ff57fd-2dmpv  10-244-0-6.default.pod.cluster.local   10.244.0.6   6379/tcp  
redis-slave-7979cfdfb8-7wgcd  10-244-0-8.default.pod.cluster.local   10.244.0.8   6379/tcp  
redis-slave-7979cfdfb8-h227s  10-244-0-7.default.pod.cluster.local   10.244.0.7   6379/tcp

6 pods

Succeeded
```

### kwtã‚’ä½¿ã£ã¦k8så†…éƒ¨ã«ã‚¢ã‚¯ã‚»ã‚¹

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã¨k8sã‚¯ãƒ©ã‚¹ã‚¿ã‚’ç¹‹ãã¾ã™ã€‚

```
sudo -E kwt net start
```

æ¬¡ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã€30ç§’ã»ã©ã§Readyã«ãªã‚Šã¾ã™ã€‚

```
12:56:17PM: info: KubeEntryPoint: Creating networking client secret 'kwt-net-ssh-key' in namespace 'default'...
12:56:17PM: info: KubeEntryPoint: Creating networking host secret 'kwt-net-host-key' in namespace 'default'...
12:56:20PM: info: KubeEntryPoint: Creating networking pod 'kwt-net' in namespace 'default'
12:56:20PM: info: KubeEntryPoint: Waiting for networking pod 'kwt-net' in namespace 'default' to start...
12:56:36PM: info: dns.FailoverRecursorPool: Starting with '8.8.8.8:53'
12:56:36PM: info: dns.DomainsMux: Registering cluster.local.->kube-dns
12:56:36PM: info: mdns.Server: Started mDNS resolver on 0.0.0.0:5353
12:56:36PM: info: TCPProxy: Started proxy on 127.0.0.1:51001
12:56:36PM: info: UDPProxy: Started proxy on 127.0.0.1:61048
12:56:36PM: info: dns.Server: Started DNS server on 127.0.0.1:51000 (TCP) and 127.0.0.1:57986 (UDP)
12:56:36PM: info: ForwardingProxy: Forwarding subnets: 10.244.0.5/14, 172.22.0.2/14, 10.96.51.181/14
12:56:36PM: info: ForwardingProxy: Ready!
```

`kwt-net`ã¨ã„ã†åå‰ã®PodãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚

```
$ kubectl get pod
NAME                           READY   STATUS    RESTARTS   AGE
frontend-6c6d6dfd4d-c5jzr      1/1     Running   0          7m36s
frontend-6c6d6dfd4d-dc77g      1/1     Running   0          7m36s
frontend-6c6d6dfd4d-rknb6      1/1     Running   0          7m36s
kwt-net                        1/1     Running   0          21s
redis-master-f46ff57fd-2dmpv   1/1     Running   0          7m36s
redis-slave-7979cfdfb8-7wgcd   1/1     Running   0          7m36s
redis-slave-7979cfdfb8-h227s   1/1     Running   0          7m36s
```

`kwt-net`ã®configã‚’ç¢ºèªã™ã‚‹ã¨ã€å®Ÿä½“ãŒsshdã®SOCKSã‚µãƒ¼ãƒãƒ¼ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
$ kubectl get pod kwt-net -oyaml | kubectl neat
apiVersion: v1
kind: Pod
metadata:
  annotations:
    sidecar.istio.io/inject: "false"
  labels:
    kwt.cppforlife.com/net: "true"
  name: kwt-net
  namespace: default
spec:
  containers:
  - args:
    - -c
    - echo "$KWT_CLIENT_PUB_KEY" > /home/tom/.ssh/authorized_keys && echo "$KWT_HOST_PRIV_KEY"
      > /etc/ssh/ssh_host_rsa_key && echo "$KWT_HOST_PUB_KEY" > /etc/ssh/ssh_host_rsa_key.pub
      && echo "GatewayPorts clientspecified" >> /etc/ssh/sshd_config && exec /usr/sbin/sshd
      -D -p 2048
    command:
    - /bin/bash
    env:
    - name: KWT_CLIENT_PUB_KEY
      valueFrom:
        secretKeyRef:
          key: ssh-publickey
          name: kwt-net-ssh-key
    - name: KWT_HOST_PRIV_KEY
      valueFrom:
        secretKeyRef:
          key: ssh-privatekey
          name: kwt-net-host-key
    - name: KWT_HOST_PUB_KEY
      valueFrom:
        secretKeyRef:
          key: ssh-publickey
          name: kwt-net-host-key
    image: index.docker.io/cppforlife/sshd@sha256:6c3170c4d97f2926ec034fc237554db237076bd9014469aac91610d89a9991d1
    name: kwt-net
    ports:
    - containerPort: 2048
      name: ssh
    # ...
```


Guestbookã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã—ã‚‡ã†ã€‚

ãƒ­ãƒ¼ã‚«ãƒ«ç«¯æœ«ä¸Šã§`dig`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦`frontend.default.svc.cluster.local`åå‰è§£æ±ºã™ã‚‹ã¨Cluster IPãŒè¿”ã‚Šã¾ã™ã€‚

```
$ dig frontend.default.svc.cluster.local

; <<>> DiG 9.10.6 <<>> frontend.default.svc.cluster.local
;; global options: +cmd
;; Got answer:
;; WARNING: .local is reserved for Multicast DNS
;; You are currently testing what happens when an mDNS query is leaked to DNS
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 18574
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;frontend.default.svc.cluster.local. IN	A

;; ANSWER SECTION:
frontend.default.svc.cluster.local. 0 IN A	10.96.51.181

;; Query time: 4 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Wed Jun 16 13:14:33 JST 2021
;; MSG SIZE  rcvd: 102
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§[http://frontend.default.svc.cluster.local](http://frontend.default.svc.cluster.local)ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

![image](https://user-images.githubusercontent.com/106908/122156281-a5b49b00-cea3-11eb-96ca-6caa26c8b77e.png)

æ™®é€šã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã—ãŸã€‚

"Messages"ã«"Hello"ã‚’å…¥åŠ›ã—ã¦ã€Submitãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ã°ã€"Hello"ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

![image](https://user-images.githubusercontent.com/106908/122156366-c7ae1d80-cea3-11eb-8f9d-35935b22faec.png)

Podã®ã†ã¡ã®ã²ã¨ã¤(ä¾‹: [http://10-244-0-5.default.pod.cluster.local](http://10-244-0-5.default.pod.cluster.local))ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

![image](https://user-images.githubusercontent.com/106908/122156529-1d82c580-cea4-11eb-802b-5b5f463dde4e.png)


æ¬¡ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®Redisã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚

```
$ redis-cli -h redis-master.default.svc.cluster.local -p 6379
redis-master.default.svc.cluster.local:6379> get messages
",Hello"
```

ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‹ã‚‰ç›´æ¥`redis-cli`ã§k8sä¸Šã®Redisã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã—ãŸã€‚

### kwtã®åœæ­¢

`kwt net svc`ã‚³ãƒãƒ³ãƒ‰ã‚’çµ‚äº†ã™ã‚Œã°k8sã‚¯ãƒ©ã‚¹ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã§ããªããªã‚Šã¾ã™ã€‚

`kwt net svc`ã‚³ãƒãƒ³ãƒ‰ã§ä½œæˆã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§å‰Šé™¤ã§ãã¾ã™ã€‚

```
kwt net clean-up
```

Guestbookã‚‚å‰Šé™¤ã—ã¾ã—ã‚‡ã†ã€‚
```
kubectl delete -f https://github.com/kubernetes/examples/raw/master/guestbook/all-in-one/guestbook-all-in-one.yaml
```

---
kwtã§k8sã‚¯ãƒ©ã‚¹ã‚¿å¤–ã‹ã‚‰å†…éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³åã§Service / Podã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®é–‹ç™ºã‚„ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«ä¾¿åˆ©ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

æ¬¡ã¯"[Carvel kwtã§k8sã‚¯ãƒ©ã‚¹ã‚¿å†…ã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹](/entries/650)"æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

> æ‡¸å¿µã¯æœ€å¾Œã®ãƒªãƒªãƒ¼ã‚¹(0.0.6)ãŒ2019å¹´12æœˆã§ã‚ã‚‹ã“ã¨...
