---
title: kind初期設定メモ 
tags: ["kind", "Carvle", "Kubernetes"]
categories: ["Dev", "CaaS", "Kubernetes", "kind"]
---

よくやる初期設定をメモしておく。

**目次**
<!-- toc -->

### Kindクラスタの作成

```yaml
cat <<EOF > kind-expose-port.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
 - role: control-plane
   extraPortMappings:
   - containerPort: 31443 # expose port 31443 of the node to port 80 on the host for use later by Contour ingress (envoy)
     hostPort: 443
   - containerPort: 31080 # expose port 31080 of the node to port 80 on the host for use later by Contour ingress (envoy)
     hostPort: 80
EOF
kind create cluster --config kind-expose-port.yaml
```

### kapp controllerのインストール

```
kubectl apply -f https://github.com/vmware-tanzu/carvel-kapp-controller/releases/download/v0.32.0/release.yml
```

### Tanzu Package Repositoryの追加

```
kubectl create namespace kapp
kubectl create -n kapp sa kapp
kubectl create clusterrolebinding kapp-cluster-admin --clusterrole cluster-admin --serviceaccount=kapp:kapp
```

```yaml
cat <<EOF | kubectl apply -f-
apiVersion: packaging.carvel.dev/v1alpha1
kind: PackageRepository
metadata:
  name: tanzu-standard
  namespace: kapp
spec:
  fetch:
    imgpkgBundle:
      image: projects.registry.vmware.com/tkg/packages/standard/repo:v1.5.0
EOF
```

```
$ kubectl get package -A
NAMESPACE   NAME                                                  PACKAGEMETADATA NAME            VERSION                 AGE
kapp        cert-manager.tanzu.vmware.com.1.1.0+vmware.1-tkg.2    cert-manager.tanzu.vmware.com   1.1.0+vmware.1-tkg.2    19s
kapp        cert-manager.tanzu.vmware.com.1.1.0+vmware.2-tkg.1    cert-manager.tanzu.vmware.com   1.1.0+vmware.2-tkg.1    19s
kapp        cert-manager.tanzu.vmware.com.1.5.3+vmware.2-tkg.1    cert-manager.tanzu.vmware.com   1.5.3+vmware.2-tkg.1    19s
kapp        contour.tanzu.vmware.com.1.17.1+vmware.1-tkg.1        contour.tanzu.vmware.com        1.17.1+vmware.1-tkg.1   19s
kapp        contour.tanzu.vmware.com.1.17.2+vmware.1-tkg.2        contour.tanzu.vmware.com        1.17.2+vmware.1-tkg.2   19s
kapp        contour.tanzu.vmware.com.1.17.2+vmware.1-tkg.3        contour.tanzu.vmware.com        1.17.2+vmware.1-tkg.3   19s
kapp        contour.tanzu.vmware.com.1.18.2+vmware.1-tkg.1        contour.tanzu.vmware.com        1.18.2+vmware.1-tkg.1   19s
kapp        external-dns.tanzu.vmware.com.0.10.0+vmware.1-tkg.1   external-dns.tanzu.vmware.com   0.10.0+vmware.1-tkg.1   19s
kapp        external-dns.tanzu.vmware.com.0.8.0+vmware.1-tkg.1    external-dns.tanzu.vmware.com   0.8.0+vmware.1-tkg.1    19s
kapp        fluent-bit.tanzu.vmware.com.1.7.5+vmware.1-tkg.1      fluent-bit.tanzu.vmware.com     1.7.5+vmware.1-tkg.1    19s
kapp        fluent-bit.tanzu.vmware.com.1.7.5+vmware.2-tkg.1      fluent-bit.tanzu.vmware.com     1.7.5+vmware.2-tkg.1    19s
kapp        grafana.tanzu.vmware.com.7.5.7+vmware.1-tkg.1         grafana.tanzu.vmware.com        7.5.7+vmware.1-tkg.1    19s
kapp        grafana.tanzu.vmware.com.7.5.7+vmware.2-tkg.1         grafana.tanzu.vmware.com        7.5.7+vmware.2-tkg.1    19s
kapp        harbor.tanzu.vmware.com.2.2.3+vmware.1-tkg.1          harbor.tanzu.vmware.com         2.2.3+vmware.1-tkg.1    19s
kapp        harbor.tanzu.vmware.com.2.2.3+vmware.1-tkg.2          harbor.tanzu.vmware.com         2.2.3+vmware.1-tkg.2    19s
kapp        harbor.tanzu.vmware.com.2.3.3+vmware.1-tkg.1          harbor.tanzu.vmware.com         2.3.3+vmware.1-tkg.1    19s
kapp        multus-cni.tanzu.vmware.com.3.7.1+vmware.1-tkg.1      multus-cni.tanzu.vmware.com     3.7.1+vmware.1-tkg.1    19s
kapp        multus-cni.tanzu.vmware.com.3.7.1+vmware.2-tkg.1      multus-cni.tanzu.vmware.com     3.7.1+vmware.2-tkg.1    19s
kapp        multus-cni.tanzu.vmware.com.3.7.1+vmware.2-tkg.2      multus-cni.tanzu.vmware.com     3.7.1+vmware.2-tkg.2    19s
kapp        prometheus.tanzu.vmware.com.2.27.0+vmware.1-tkg.1     prometheus.tanzu.vmware.com     2.27.0+vmware.1-tkg.1   19s
kapp        prometheus.tanzu.vmware.com.2.27.0+vmware.2-tkg.1     prometheus.tanzu.vmware.com     2.27.0+vmware.2-tkg.1   19s
```

### cert-manager packageのインストール

```yaml
cat <<EOF | kubectl apply -f-
apiVersion: packaging.carvel.dev/v1alpha1
kind: PackageInstall
metadata:
  name: cert-manager
  namespace: kapp
spec:
  serviceAccountName: kapp
  packageRef:
    refName: cert-manager.tanzu.vmware.com
    versionSelection:
      constraints: 1.5.3+vmware.2-tkg.1
EOF
```

### contour packageのインストール

```yaml
cat <<EOF | kubectl apply -f-
apiVersion: packaging.carvel.dev/v1alpha1
kind: PackageInstall
metadata:
  name: contour
  namespace: kapp
spec:
  serviceAccountName: kapp
  packageRef:
    refName: contour.tanzu.vmware.com
    versionSelection:
      constraints: 1.18.2+vmware.1-tkg.1
  values:
  - secretRef:
      name: contour-data-values
---
apiVersion: v1
kind: Secret
metadata:
  name: contour-data-values
  namespace: kapp
type: Opaque
stringData:
  values.yml: |
    ---
    infrastructure_provider: "vsphere"
    namespace: tanzu-system-ingress
    contour:
      replicas: 1
    envoy:
      service:
        type: NodePort
        externalTrafficPolicy: Local
        nodePorts:
          http: 31080
          https: 31443    
EOF
```

### secretgen-controllerのインストール

```yaml
cat <<EOF | kubectl apply -f-
apiVersion: kappctrl.k14s.io/v1alpha1
kind: App
metadata:
  name: secretgen-controller
  namespace: kapp
spec:
  serviceAccountName: kapp
  fetch:
  - http:
      url: https://github.com/vmware-tanzu/carvel-secretgen-controller/releases/download/v0.7.1/release.yml
  syncPeriod: 12h
  template:
  - ytt:
      ignoreUnknownComments: true
      paths:
      - release.yml
  deploy:
  - kapp:
      rawOptions:
      - --wait-timeout=5m
      - --diff-changes=true
      - --diff-mask=true
      inspect:
        rawOptions:
        - --tree=true
EOF
```

---

ここまで入る。

```
$ kubectl get pod -A
NAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE
cert-manager           cert-manager-84778594ff-f68lx                1/1     Running   0          55m
cert-manager           cert-manager-cainjector-5fc46988b9-p92fv     1/1     Running   0          55m
cert-manager           cert-manager-webhook-85cf4bc-v4k72           1/1     Running   0          55m
kapp-controller        kapp-controller-77845f8d64-wmkdv             1/1     Running   0          64m
kube-system            coredns-558bd4d5db-5pbqx                     1/1     Running   0          65m
kube-system            coredns-558bd4d5db-ghjhz                     1/1     Running   0          65m
kube-system            etcd-kind-control-plane                      1/1     Running   0          65m
kube-system            kindnet-l6hht                                1/1     Running   0          65m
kube-system            kube-apiserver-kind-control-plane            1/1     Running   0          65m
kube-system            kube-controller-manager-kind-control-plane   1/1     Running   0          65m
kube-system            kube-proxy-qjhqs                             1/1     Running   0          65m
kube-system            kube-scheduler-kind-control-plane            1/1     Running   0          65m
local-path-storage     local-path-provisioner-547f784dff-b69kl      1/1     Running   0          65m
secretgen-controller   secretgen-controller-77cd4dbb7b-s5qtc        1/1     Running   0          5m27s
tanzu-system-ingress   contour-5bb84767c8-8kkzg                     1/1     Running   0          50m
tanzu-system-ingress   envoy-ljn5l                                  2/2     Running   0          50m
```