---
title: Spring WebFlux.fnãƒãƒ³ã‚ºã‚ªãƒ³ - 2. ç°¡æ˜“å®¶è¨ˆç°¿Moneygerãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
tags: ["Spring WebFlux.fn Handson", "Reactor", "Reactor Netty", "Netty", "Spring 5", "Spring WebFlux", "Java", "Cloud Foundry", "Pivotal Web Services", "Pivotal Cloud Foundry"]
categories: ["Programming", "Java", "org", "springframework", "web", "reactive"]
updated: 1970-01-01T09:00:00+09:00
---

æœ¬ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã€æ¬¡ã®å›³ã®ã‚ˆã†ãªç°¡æ˜“å®¶è¨ˆç°¿ã®APIã‚µãƒ¼ãƒãƒ¼ã‚’Spring WebFlux.fnã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¾ã™ã€‚
ã‚ãˆã¦Spring Bootã‚‚Dependency Injectionã‚‚ä½¿ã‚ãªã„ã‚·ãƒ³ãƒ—ãƒ«ãªWebã‚¢ãƒ—ãƒªã¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚

**ãƒãƒ³ã‚ºã‚ªãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„**

1. [ã¯ã˜ã‚ã«](/entries/500)
1. [ç°¡æ˜“å®¶è¨ˆç°¿Moneygerãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ](/entries/501) ğŸ‘ˆ
1. [YAVIã«ã‚ˆã‚‹Validationã®å®Ÿè£…](/entries/502)
1. [R2DBCã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹](/entries/503)
1. [Web UIã®è¿½åŠ ](/entries/504)
1. [ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„](/entries/505)
1. [åå…¥APIã®å®Ÿè£…](/entries/506)


**ç›®æ¬¡**
<!-- toc -->

### ç°¡æ˜“å®¶è¨ˆç°¿Moneygerãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

ç°¡æ˜“å®¶è¨ˆç°¿Moneygerã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é››å½¢ã¯Maven Archetypeã®[vanilla-spring-webflux-fn-blank](https://github.com/making/vanilla-spring-webflux-fn-blank)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚


æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§é››å½¢ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚Windowsã®å ´åˆã¯Git Bashãªã©ã®Bashå®Ÿè¡Œç’°å¢ƒã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

```
mvn archetype:generate\
 -DarchetypeGroupId=am.ik.archetype\
 -DarchetypeArtifactId=vanilla-spring-webflux-fn-blank-archetype\
 -DarchetypeVersion=0.2.7\
 -DgroupId=com.example\
 -DartifactId=moneyger\
 -Dversion=1.0.0-SNAPSHOT\
 -B
```

2019-08-26æ™‚ç‚¹ã§ã€Spring Frameworkã®æœ€æ–°ã®å¤‰æ›´ã‚’å–ã‚Šè¾¼ã‚€ãŸã‚ã€`pom.xml`ã®`<properties>`ã‚¿ã‚°å†…ã®æ¬¡ã®å€¤ã‚’

```xml
        <spring-boot.version>2.2.0.M5</spring-boot.version>
        <r2dbc-releasetrain.version>Arabba-M8</r2dbc-releasetrain.version>
```

æ¬¡ã®å€¤ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```xml
        <spring-boot.version>2.2.0.BUILD-SNAPSHOT</spring-boot.version>
        <r2dbc-releasetrain.version>Arabba-BUILD-SNAPSHOT</r2dbc-releasetrain.version>
```

åŒæ¢±ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®å‹•ä½œã‚’ç¢ºèªã—ã¾ã™ã€‚

```
cd moneyger
chmod +x mvnw
./mvnw clean package

java -jar target/moneyger-1.0.0-SNAPSHOT.jar
```

```
$ curl localhost:8080
Hello World!

$ curl localhost:8080/messages -d "{\"text\":\"Hello\"}" -H "Content-Type: application/json"
{"text":"Hello"}

$ curl localhost:8080/messages
[{"text":"Hello"}]
```

#### Expenditureãƒ¢ãƒ‡ãƒ«ã®ä½œæˆ

å®¶è¨ˆç°¿ã®Expenditure(æ”¯å‡º)ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

`com.example.expenditure`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œã£ã¦ä»¥ä¸‹ã®`Expenditure.java`ã¨`ExpenditureBuilder.java`ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```java
package com.example.expenditure;

import com.fasterxml.jackson.databind.annotation.JsonDeserialize;

import java.time.LocalDate;

@JsonDeserialize(builder = ExpenditureBuilder.class)
public class Expenditure {

    private final Integer expenditureId;

    private final String expenditureName;

    private final int unitPrice;

    private final int quantity;

    private final LocalDate expenditureDate;

    Expenditure(Integer expenditureId, String expenditureName, int unitPrice, int quantity, LocalDate expenditureDate) {
        this.expenditureId = expenditureId;
        this.expenditureName = expenditureName;
        this.unitPrice = unitPrice;
        this.quantity = quantity;
        this.expenditureDate = expenditureDate;
    }

    public Integer getExpenditureId() {
        return expenditureId;
    }


    public String getExpenditureName() {
        return expenditureName;
    }


    public int getUnitPrice() {
        return unitPrice;
    }


    public int getQuantity() {
        return quantity;
    }


    public LocalDate getExpenditureDate() {
        return expenditureDate;
    }


    @Override
    public String toString() {
        return "Expenditure{" +
            "expenditureId=" + expenditureId +
            ", expenditureName='" + expenditureName + '\'' +
            ", unitPrice=" + unitPrice +
            ", quantity=" + quantity +
            ", expenditureDate=" + expenditureDate +
            '}';
    }
}
```


```java
package com.example.expenditure;

import com.fasterxml.jackson.databind.annotation.JsonPOJOBuilder;

import java.time.LocalDate;

@JsonPOJOBuilder
public class ExpenditureBuilder {

    private int unitPrice;

    private LocalDate expenditureDate;

    private Integer expenditureId;

    private String expenditureName;

    private int quantity;

    public ExpenditureBuilder() {
    }

    public ExpenditureBuilder(Expenditure expenditure) {
        this.unitPrice = expenditure.getUnitPrice();
        this.expenditureDate = expenditure.getExpenditureDate();
        this.expenditureId = expenditure.getExpenditureId();
        this.expenditureName = expenditure.getExpenditureName();
        this.quantity = expenditure.getQuantity();
    }

    public Expenditure build() {
        return new Expenditure(expenditureId, expenditureName, unitPrice, quantity, expenditureDate);
    }

    public ExpenditureBuilder withUnitPrice(int unitPrice) {
        this.unitPrice = unitPrice;
        return this;
    }

    public ExpenditureBuilder withExpenditureDate(LocalDate expenditureDate) {
        this.expenditureDate = expenditureDate;
        return this;
    }

    public ExpenditureBuilder withExpenditureId(Integer expenditureId) {
        this.expenditureId = expenditureId;
        return this;
    }

    public ExpenditureBuilder withExpenditureName(String expenditureName) {
        this.expenditureName = expenditureName;
        return this;
    }

    public ExpenditureBuilder withQuantity(int quantity) {
        this.quantity = quantity;
        return this;
    }
}
```

#### ExpenditureRepositoryã®ä½œæˆ

`com.example.expenditure`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«`ExpenditureRepository`ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```java
package com.example.expenditure;

import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

public interface ExpenditureRepository {

    Flux<Expenditure> findAll();

    Mono<Expenditure> findById(Integer expenditureId);

    Mono<Expenditure> save(Expenditure expenditure);

    Mono<Void> deleteById(Integer expenditureId);
}
```

ã¾ãšã¯`ExpenditureRepository`ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªå®Ÿè£…ã§ã‚ã‚‹`InMemoryExpenditureRepository`ã‚’ä½œæˆã—ã¾ã™ã€‚

```java
package com.example.expenditure;

import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.List;
import java.util.Objects;
import java.util.concurrent.CopyOnWriteArrayList;
import java.util.concurrent.atomic.AtomicInteger;

public class InMemoryExpenditureRepository implements ExpenditureRepository {

    final List<Expenditure> expenditures = new CopyOnWriteArrayList<>();

    final AtomicInteger counter = new AtomicInteger(1);

    @Override
    public Flux<Expenditure> findAll() {
        return Flux.fromIterable(this.expenditures);
    }

    @Override
    public Mono<Expenditure> findById(Integer expenditureId) {
        return Mono.justOrEmpty(this.expenditures.stream()
            .filter(x -> Objects.equals(x.getExpenditureId(), expenditureId))
            .findFirst());
    }

    @Override
    public Mono<Expenditure> save(Expenditure expenditure) {
        return Mono.fromCallable(() -> {
            Expenditure created = new ExpenditureBuilder(expenditure)
                .withExpenditureId(this.counter.getAndIncrement())
                .build();
            this.expenditures.add(created);
            return created;
        });
    }

    @Override
    public Mono<Void> deleteById(Integer expenditureId) {
        return Mono.defer(() -> {
            this.expenditures.removeIf(x -> Objects.equals(x.getExpenditureId(), expenditureId));
            return Mono.empty();
        });
    }
}
```

> `this.expenditures.add(created);`ã‚’`Mono.fromCallable`ã®å¤–ã§è¡Œã†å ´åˆã¨ä¸­ã§è¡Œã†å ´åˆã®é•ã„ã‚’è€ƒãˆã¦è¦‹ã¦ãã ã•ã„ã€‚

#### ExpenditureHandlerã®ä½œæˆ

æ¬¡ã«`com.example.expenditure`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«`ExpenditureHandler`ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã€WebFlux.fnã®`RouterFunction`ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

æ¬¡ã®**TODO(3ç®‡æ‰€)ã¯å®Ÿè£…ã—ãªã„ã¨ã„ã‘ãªã„éƒ¨åˆ†ã§ã™**ã€‚å‹•ä½œã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã«ç¶šãã¾ã™ã€‚TODOã‚’å®Ÿè£…ã™ã‚‹å‰ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã„ã€‚

* [å‚è€ƒè³‡æ–™](https://docs.spring.io/spring/docs/5.2.0.M2/spring-framework-reference/web-reactive.html#webflux-fn)

```java
package com.example.expenditure;

import org.springframework.web.reactive.function.server.RouterFunction;
import org.springframework.web.reactive.function.server.RouterFunctions;
import org.springframework.web.reactive.function.server.ServerRequest;
import org.springframework.web.reactive.function.server.ServerResponse;
import org.springframework.web.util.UriComponentsBuilder;
import reactor.core.publisher.Mono;

import java.util.LinkedHashMap;

import static org.springframework.http.HttpStatus.NOT_FOUND;

public class ExpenditureHandler {

    private final ExpenditureRepository expenditureRepository;

    public ExpenditureHandler(ExpenditureRepository expenditureRepository) {
        this.expenditureRepository = expenditureRepository;
    }

    public RouterFunction<ServerResponse> routes() {
        return RouterFunctions.route()
            // TODO Routingã®å®šç¾©
            // GET /expenditures
            // POST /expenditures
            // GET /expenditures/{expenditureId}
            .DELETE("/expenditures/{expenditureId}", this::delete)
            .build();
    }

    Mono<ServerResponse> list(ServerRequest req) {
        return ServerResponse.ok().body(this.expenditureRepository.findAll(), Expenditure.class);
    }

    Mono<ServerResponse> post(ServerRequest req) {
        return req.bodyToMono(Expenditure.class)
            // TODO
            // ExpenditureRepositoryã§Expenditureã‚’ä¿å­˜
            // Hint: ExpenditureRepository.saveã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
            .flatMap(created -> ServerResponse
                .created(UriComponentsBuilder.fromUri(req.uri()).path("/{expenditureId}").build(created.getExpenditureId()))
                .bodyValue(created));
    }

    Mono<ServerResponse> get(ServerRequest req) {
        return this.expenditureRepository.findById(Integer.valueOf(req.pathVariable("expenditureId")))
            .flatMap(expenditure -> ServerResponse.ok().bodyValue(expenditure))
            // TODO
            // expenditureãŒå­˜åœ¨ã—ãªã„å ´åˆã¯404ã‚’è¿”ã™ã€‚ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯{"status":404,"error":"Not Found","message":"The given expenditure is not found."}
            // Hint: switchIfEmptyãŠã‚ˆã³ServerResponse.statusã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
            ;
    }

    Mono<ServerResponse> delete(ServerRequest req) {
        return ServerResponse.noContent()
            .build(this.expenditureRepository.deleteById(Integer.valueOf(req.pathVariable("expenditureId"))));
    }
}
```

`src/main/java/com/example/App.java`ã®`routes`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```java
    static RouterFunction<ServerResponse> routes() {
        return new ExpenditureHandler(new InMemoryExpenditureRepository()).routes();
    }
```

`src/test/java/com/example/expenditure`ã«`ExpenditureHandlerTest`ã‚’ä½œæˆã—ã¦ã€æ¬¡ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚TODOéƒ¨åˆ†ã¯ãã®ã¾ã¾ã«ã—ã¦ãã ã•ã„ã€‚

```java
package com.example.expenditure;

import com.fasterxml.jackson.databind.JsonNode;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.test.web.reactive.server.WebTestClient;

import java.net.URI;
import java.time.LocalDate;
import java.util.Arrays;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

class ExpenditureHandlerTest {

    private WebTestClient testClient;

    private InMemoryExpenditureRepository expenditureRepository = new InMemoryExpenditureRepository();

    private ExpenditureHandler expenditureHandler = new ExpenditureHandler(this.expenditureRepository);

    private List<Expenditure> fixtures = Arrays.asList(
        new ExpenditureBuilder()
            .withExpenditureId(1)
            .withExpenditureName("æœ¬")
            .withUnitPrice(2000)
            .withQuantity(1)
            .withExpenditureDate(LocalDate.of(2019, 4, 1))
            .build(),
        new ExpenditureBuilder()
            .withExpenditureId(2)
            .withExpenditureName("ã‚³ãƒ¼ãƒ’ãƒ¼")
            .withUnitPrice(300)
            .withQuantity(2)
            .withExpenditureDate(LocalDate.of(2019, 4, 2))
            .build());

    @BeforeAll
    void before() {
        this.testClient = WebTestClient.bindToRouterFunction(this.expenditureHandler.routes())
            .build();
    }

    @BeforeEach
    void reset() {
        this.expenditureRepository.expenditures.clear();
        this.expenditureRepository.expenditures.addAll(this.fixtures);
        this.expenditureRepository.counter.set(100);
    }

    @Test
    void list() {
        this.testClient.get()
            .uri("/expenditures")
            .exchange()
            .expectStatus().isOk()
            .expectBody(JsonNode.class)
            .consumeWith(result -> {
                JsonNode body = result.getResponseBody();
                assertThat(body).isNotNull();
                assertThat(body.size()).isEqualTo(2);

                assertThat(body.get(0).get("expenditureId").asInt()).isEqualTo(1);
                assertThat(body.get(0).get("expenditureName").asText()).isEqualTo("æœ¬");
                assertThat(body.get(0).get("unitPrice").asInt()).isEqualTo(2000);
                assertThat(body.get(0).get("quantity").asInt()).isEqualTo(1);
                // TODO å¾Œã§å®Ÿè£…ã—ã¾ã™
                //assertThat(body.get(0).get("expenditureDate").asText()).isEqualTo("2019-04-01");

                assertThat(body.get(1).get("expenditureId").asInt()).isEqualTo(2);
                assertThat(body.get(1).get("expenditureName").asText()).isEqualTo("ã‚³ãƒ¼ãƒ’ãƒ¼");
                assertThat(body.get(1).get("unitPrice").asInt()).isEqualTo(300);
                assertThat(body.get(1).get("quantity").asInt()).isEqualTo(2);
                // TODO å¾Œã§å®Ÿè£…ã—ã¾ã™
                //assertThat(body.get(1).get("expenditureDate").asText()).isEqualTo("2019-04-02");
            });
    }

    @Test
    void get_200() {
        this.testClient.get()
            .uri("/expenditures/{expenditureId}", 1)
            .exchange()
            .expectStatus().isOk()
            .expectBody(JsonNode.class)
            .consumeWith(result -> {
                JsonNode body = result.getResponseBody();
                assertThat(body).isNotNull();

                assertThat(body.get("expenditureId").asInt()).isEqualTo(1);
                assertThat(body.get("expenditureName").asText()).isEqualTo("æœ¬");
                assertThat(body.get("unitPrice").asInt()).isEqualTo(2000);
                assertThat(body.get("quantity").asInt()).isEqualTo(1);
                // TODO å¾Œã§å®Ÿè£…ã—ã¾ã™
                //assertThat(body.get("expenditureDate").asText()).isEqualTo("2019-04-01");
            });
    }

    @Test
    void get_404() {
        this.testClient.get()
            .uri("/expenditures/{expenditureId}", 10000)
            .exchange()
            .expectStatus().isNotFound()
            .expectBody(JsonNode.class)
            .consumeWith(result -> {
                JsonNode body = result.getResponseBody();
                assertThat(body).isNotNull();

                assertThat(body.get("status").asInt()).isEqualTo(404);
                assertThat(body.get("error").asText()).isEqualTo("Not Found");
                assertThat(body.get("message").asText()).isEqualTo("The given expenditure is not found.");
            });
    }

    @Test
    void post_201() {
        Map<String, Object> expenditure = new LinkedHashMap<String, Object>() {

            {
                put("expenditureName", "ãƒ“ãƒ¼ãƒ«");
                put("unitPrice", 250);
                put("quantity", 1);
                put("expenditureDate", "2019-04-03");
            }
        };

        this.testClient.post()
            .uri("/expenditures")
            .bodyValue(expenditure)
            .exchange()
            .expectStatus().isCreated()
            .expectBody(JsonNode.class)
            .consumeWith(result -> {
                URI location = result.getResponseHeaders().getLocation();
                assertThat(location.toString()).isEqualTo("/expenditures/100");
                JsonNode body = result.getResponseBody();
                assertThat(body).isNotNull();

                assertThat(body.get("expenditureId").asInt()).isEqualTo(100);
                assertThat(body.get("expenditureName").asText()).isEqualTo("ãƒ“ãƒ¼ãƒ«");
                assertThat(body.get("unitPrice").asInt()).isEqualTo(250);
                assertThat(body.get("quantity").asInt()).isEqualTo(1);
                // TODO å¾Œã§å®Ÿè£…ã—ã¾ã™
                //assertThat(body.get("expenditureDate").asText()).isEqualTo("2019-04-03");
            });

        this.testClient.get()
            .uri("/expenditures/{expenditureId}", 100)
            .exchange()
            .expectStatus().isOk()
            .expectBody(JsonNode.class)
            .consumeWith(result -> {
                JsonNode body = result.getResponseBody();
                assertThat(body).isNotNull();

                assertThat(body.get("expenditureId").asInt()).isEqualTo(100);
                assertThat(body.get("expenditureName").asText()).isEqualTo("ãƒ“ãƒ¼ãƒ«");
                assertThat(body.get("unitPrice").asInt()).isEqualTo(250);
                assertThat(body.get("quantity").asInt()).isEqualTo(1);
                // TODO å¾Œã§å®Ÿè£…ã—ã¾ã™
                //assertThat(body.get("expenditureDate").asText()).isEqualTo("2019-04-03");
            });
    }

    // TODO å¾Œã§å®Ÿè£…ã—ã¾ã™
    //@Test
    void post_400() {
        Map<String, Object> expenditure = new LinkedHashMap<String, Object>() {

            {
                put("expenditureId", 1000);
                put("expenditureName", "");
                put("unitPrice", -1);
                put("quantity", -1);
            }
        };

        this.testClient.post()
            .uri("/expenditures")
            .bodyValue(expenditure)
            .exchange()
            .expectStatus().isBadRequest()
            .expectBody(JsonNode.class)
            .consumeWith(result -> {
                JsonNode body = result.getResponseBody();
                assertThat(body).isNotNull();

                assertThat(body.get("status").asInt()).isEqualTo(400);
                assertThat(body.get("error").asText()).isEqualTo("Bad Request");
                assertThat(body.get("details").size()).isEqualTo(5);
                assertThat(body.get("details").get("expenditureId").get(0).asText()).isEqualTo("\"expenditureId\" must be null");
                assertThat(body.get("details").get("expenditureName").get(0).asText()).isEqualTo("\"expenditureName\" must not be empty");
                assertThat(body.get("details").get("unitPrice").get(0).asText()).isEqualTo("\"unitPrice\" must be greater than 0");
                assertThat(body.get("details").get("quantity").get(0).asText()).isEqualTo("\"quantity\" must be greater than 0");
                assertThat(body.get("details").get("expenditureDate").get(0).asText()).isEqualTo("\"expenditureDate\" must not be null");
            });
    }

    @Test
    void delete() {
        this.testClient.delete()
            .uri("/expenditures/{expenditureId}", 1)
            .exchange()
            .expectStatus().isNoContent();

        this.testClient.get()
            .uri("/expenditures/{expenditureId}", 1)
            .exchange()
            .expectStatus().isNotFound();
    }
}
```

TODOã‚’å®Ÿè£…ã—ãªã„ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«`delete`ä»¥å¤–ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã™ã€‚

![image](https://user-images.githubusercontent.com/106908/58398135-e8be2e80-808e-11e9-900d-744ad0961a6a.png)


TODOã‚’å®Ÿè£…ã—ã¦ã€å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸã‚‰ã€`App`ã‚¯ãƒ©ã‚¹ã®`main`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã€æ­£ã—ããƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ curl localhost:8080/expenditures -d "{\"expenditureName\":\"ã‚³ãƒ¼ãƒ’ãƒ¼\",\"unitPrice\":300,\"quantity\":1,\"expenditureDate\":[2019,6,3]}" -H "Content-Type: application/json"
{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":[2019,6,3]}
```

```
$ curl localhost:8080/expenditures
[{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":[2019,6,3]}]
```

```
$ curl localhost:8080/expenditures/1
{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":[2019,6,3]}
```

```
$ curl -XDELETE localhost:8080/expenditures/1
```

```
$ curl localhost:8080/expenditures
[]
```

TODOã®å®Ÿè£…ä¾‹ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

<details>
  <summary><code>ExpenditureHandler</code>ã®æ­£è§£ä¾‹</summary>

```java
package com.example.expenditure;

import org.springframework.web.reactive.function.server.RouterFunction;
import org.springframework.web.reactive.function.server.RouterFunctions;
import org.springframework.web.reactive.function.server.ServerRequest;
import org.springframework.web.reactive.function.server.ServerResponse;
import org.springframework.web.util.UriComponentsBuilder;
import reactor.core.publisher.Mono;

import java.util.LinkedHashMap;

import static org.springframework.http.HttpStatus.NOT_FOUND;

public class ExpenditureHandler {

    private final ExpenditureRepository expenditureRepository;

    public ExpenditureHandler(ExpenditureRepository expenditureRepository) {
        this.expenditureRepository = expenditureRepository;
    }

    public RouterFunction<ServerResponse> routes() {
        return RouterFunctions.route()
            .GET("/expenditures", this::list)
            .POST("/expenditures", this::post)
            .GET("/expenditures/{expenditureId}", this::get)
            .DELETE("/expenditures/{expenditureId}", this::delete)
            .build();
    }

    Mono<ServerResponse> list(ServerRequest req) {
        return ServerResponse.ok().body(this.expenditureRepository.findAll(), Expenditure.class);
    }

    Mono<ServerResponse> post(ServerRequest req) {
        return req.bodyToMono(Expenditure.class)
            .flatMap(this.expenditureRepository::save)
            .flatMap(created -> ServerResponse
                .created(UriComponentsBuilder.fromUri(req.uri()).path("/{expenditureId}").build(created.getExpenditureId()))
                .bodyValue(created));
    }

    Mono<ServerResponse> get(ServerRequest req) {
        return this.expenditureRepository.findById(Integer.valueOf(req.pathVariable("expenditureId")))
            .flatMap(expenditure -> ServerResponse.ok().bodyValue(expenditure))
            .switchIfEmpty(Mono.defer(() -> ServerResponse.status(NOT_FOUND).bodyValue(new LinkedHashMap<String, Object>() {

                {
                    put("status", 404);
                    put("error", "Not Found");
                    put("message", "The given expenditure is not found.");
                }
            })));
    }

    Mono<ServerResponse> delete(ServerRequest req) {
        return ServerResponse.noContent()
            .build(this.expenditureRepository.deleteById(Integer.valueOf(req.pathVariable("expenditureId"))));
    }
}
```

</details>

#### æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´

`expenditureDate`ãŒ`[year, month, day]`ã®ãƒªã‚¹ãƒˆå½¢å¼ã§è¿”å´ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€`"year-month-day"`ã®æ–‡å­—åˆ—å½¢å¼ã«å¤‰æ›´ã—ã¾ã—ã‚‡ã†ã€‚

`App.java`ã«ä»¥ä¸‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¦ã€

```java
    public static HandlerStrategies handlerStrategies() {
        return HandlerStrategies.empty()
            .codecs(configure -> {
                configure.registerDefaults(true);
                ServerCodecConfigurer.ServerDefaultCodecs defaults = configure
                    .defaultCodecs();
                ObjectMapper objectMapper = Jackson2ObjectMapperBuilder.json()
                    .dateFormat(new StdDateFormat())
                    .build();
                defaults.jackson2JsonEncoder(new Jackson2JsonEncoder(objectMapper));
                defaults.jackson2JsonDecoder(new Jackson2JsonDecoder(objectMapper));
            })
            .build();
    }
```

`main`ãƒ¡ã‚½ãƒƒãƒ‰ä¸­ã®æ¬¡ã®ã‚³ãƒ¼ãƒ‰

```java
        HttpHandler httpHandler = RouterFunctions.toHttpHandler(App.routes(),
            HandlerStrategies.builder().build());
```
ã‚’
```java
        HttpHandler httpHandler = RouterFunctions.toHttpHandler(App.routes(),
            App.handlerStrategies());
```
ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚


ã“ã‚Œã«åˆã‚ã›ã¦`ExpenditureHandlerTest`ã®`before`ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

```java
    @BeforeAll
    void before() {
        this.testClient = WebTestClient.bindToRouterFunction(this.expenditureHandler.routes())
            .handlerStrategies(App.handlerStrategies()) // è¿½åŠ 
            .build();
    }
```


`ExpenditureHandlerTest`ã‚³ãƒ¼ãƒ‰å†…ã®TODOéƒ¨åˆ†ã€æ¬¡ã®ã‚ˆã†ãªç®‡æ‰€ã«å¯¾ã—ã¦

```java
                // TODO å¾Œã§å®Ÿè£…ã—ã¾ã™
                //assertThat(body.get(0).get("expenditureDate").asText()).isEqualTo("2019-04-01");
```

æ¬¡ã®ã‚ˆã†ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

```java
                assertThat(body.get(0).get("expenditureDate").asText()).isEqualTo("2019-04-01");
```

5ç®‡æ‰€ã‚ã‚Šã¾ã™ã€‚

å¤‰æ›´å¾Œã®å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸã‚‰ã€`App`ã‚¯ãƒ©ã‚¹ã®`main`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã€æ­£ã—ããƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ curl localhost:8080/expenditures -d "{\"expenditureName\":\"ã‚³ãƒ¼ãƒ’ãƒ¼\",\"unitPrice\":300,\"quantity\":1,\"expenditureDate\":\"2019-06-03\"}" -H "Content-Type: application/json"
{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":"2019-06-03"}
```

```
$ curl localhost:8080/expenditures
[{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":"2019-06-03"}]
```

```
$ curl localhost:8080/expenditures/1
{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":"2019-06-03"}
```

```
$ curl -XDELETE localhost:8080/expenditures/1
```

```
$ curl localhost:8080/expenditures
[]
```

#### Cloud Foundryã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Cloud Foundry([Pivotal Web Services](https://run.pivotal.io))ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

`cf login`ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

```
cf login -a api.run.pivotal.io
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã§`manifest.yml`ã‚’ä½œæˆã—ã€æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

```yaml
applications:
- name: moneyger
  path: target/moneyger-1.0.0-SNAPSHOT.jar
  memory: 128m
  env:
    JAVA_OPTS: '-XX:ReservedCodeCacheSize=22M -XX:MaxDirectMemorySize=22M -XX:MaxMetaspaceSize=54M -Xss512K'
    JBP_CONFIG_OPEN_JDK_JRE: '[memory_calculator: {stack_threads: 30}]'
```

> `manifest.yml`ã¯ã‹ãªã‚Šå°ã•ãªãƒ¡ãƒ¢ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¡ãƒ¢ãƒªã‚µã‚¤ã‚ºã¯128MBã§ã€ãã®ã†ã¡
> ReservedCodeCacheSizeãŒ22MBã€MaxDirectMemorySizeãŒ22MBã€MaxMetaspaceSizeãŒ54MBã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¹ã‚¿ãƒƒã‚¯ãŒ512KB * 30 = 15MB
> æ®‹ã‚‹15MBãŒãƒ’ãƒ¼ãƒ—ã‚µã‚¤ã‚ºã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
> ã“ã®ãƒ¡ãƒ¢ãƒªã‚µã‚¤ã‚ºã‚’ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
>
> ```sh
> JAVA_OPTS="-Xmx15m -XX:ReservedCodeCacheSize=22M -XX:MaxDirectMemorySize=22M -XX:MaxMetaspaceSize=54M -Xss512K"
> java $JAVA_OPTS -jar target/moneyger-1.0.0-SNAPSHOT.jar
> ```

ãƒ“ãƒ«ãƒ‰ã—ã¦ã€`cf push`ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

```
$ ./mvnw clean package -DskipTests=true
$ cf push --random-route
```

æ¬¡ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¦ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã™ã€‚

```
demo@example.com ã¨ã—ã¦ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‹ã‚‰çµ„ç¹” APJ / ã‚¹ãƒšãƒ¼ã‚¹ production ã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ã„ã¾ã™...
ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ»ãƒ•ã‚¡ã‚¤ãƒ« /tmp/moneyger/manifest.yml ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™
ã‚¢ãƒ—ãƒªæƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...
ã“ã‚Œã‚‰ã®å±æ€§ã§ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ã„ã¾ã™...
+ åå‰:       moneyger
  ãƒ‘ã‚¹:       /private/tmp/moneyger/target/moneyger-1.0.0-SNAPSHOT.jar
+ ãƒ¡ãƒ¢ãƒªãƒ¼:   128M
  ç’°å¢ƒ:
+   JAVA_OPTS
+   JBP_CONFIG_OPEN_JDK_JRE
  çµŒè·¯:
+   moneyger-chatty-zebra.cfapps.io

ã‚¢ãƒ—ãƒª moneyger ã‚’ä½œæˆã—ã¦ã„ã¾ã™...
çµŒè·¯ã‚’ãƒãƒƒãƒ—ã—ã¦ã„ã¾ã™...
ãƒ­ãƒ¼ã‚«ãƒ«ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒ¢ãƒ¼ãƒˆãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨æ¯”è¼ƒã—ã¦ã„ã¾ã™...
Packaging files to upload...
ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™...
 248.00 KiB / 248.00 KiB [=======================================================================================================================================================================================================================================] 100.00% 1s

API ãŒãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ã‚’å®Œäº†ã™ã‚‹ã®ã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™...

ã‚¢ãƒ—ãƒªã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã—ã€ãƒ­ã‚°ã‚’ãƒˆãƒ¬ãƒ¼ã‚¹ã—ã¦ã„ã¾ã™...
   Downloading dotnet_core_buildpack_beta...
   Downloading staticfile_buildpack...
   Downloading nodejs_buildpack...
   Downloading dotnet_core_buildpack...
   Downloading java_buildpack...
   Downloaded staticfile_buildpack
   Downloading ruby_buildpack...
   Downloaded nodejs_buildpack
   Downloading php_buildpack...
   Downloaded dotnet_core_buildpack_beta
   Downloading go_buildpack...
   Downloaded dotnet_core_buildpack
   Downloading python_buildpack...
   Downloaded java_buildpack
   Downloading binary_buildpack...
   Downloaded ruby_buildpack
   Downloaded php_buildpack
   Downloaded go_buildpack
   Downloaded python_buildpack
   Downloaded binary_buildpack
   Cell f237c36d-0a62-4579-a51b-b11ee1d58145 creating container for instance b1036536-3a31-4d47-8039-83952134de33
   Cell f237c36d-0a62-4579-a51b-b11ee1d58145 successfully created container for instance b1036536-3a31-4d47-8039-83952134de33
   Downloading app package...
   Downloaded app package (12.4M)
   -----> Java Buildpack v4.19 (offline) | https://github.com/cloudfoundry/java-buildpack.git#3f4eee2
   -----> Downloading Jvmkill Agent 1.16.0_RELEASE from https://java-buildpack.cloudfoundry.org/jvmkill/bionic/x86_64/jvmkill-1.16.0_RELEASE.so (found in cache)
   -----> Downloading Open Jdk JRE 1.8.0_202 from https://java-buildpack.cloudfoundry.org/openjdk/bionic/x86_64/openjdk-jre-1.8.0_202-bionic.tar.gz (found in cache)
          Expanding Open Jdk JRE to .java-buildpack/open_jdk_jre (1.8s)
          JVM DNS caching disabled in lieu of BOSH DNS caching
   -----> Downloading Open JDK Like Memory Calculator 3.13.0_RELEASE from https://java-buildpack.cloudfoundry.org/memory-calculator/bionic/x86_64/memory-calculator-3.13.0_RELEASE.tar.gz (found in cache)
          Loaded Classes: 11266, Threads: 30
   -----> Downloading Client Certificate Mapper 1.8.0_RELEASE from https://java-buildpack.cloudfoundry.org/client-certificate-mapper/client-certificate-mapper-1.8.0_RELEASE.jar (found in cache)
   -----> Downloading Container Security Provider 1.16.0_RELEASE from https://java-buildpack.cloudfoundry.org/container-security-provider/container-security-provider-1.16.0_RELEASE.jar (found in cache)
   -----> Downloading Spring Auto Reconfiguration 2.7.0_RELEASE from https://java-buildpack.cloudfoundry.org/auto-reconfiguration/auto-reconfiguration-2.7.0_RELEASE.jar (found in cache)
   Exit status 0
   Uploading droplet, build artifacts cache...
   Uploading droplet...
   Uploading build artifacts cache...
   Uploaded build artifacts cache (128B)
   Uploaded droplet (55.9M)
   Uploading complete
   Cell f237c36d-0a62-4579-a51b-b11ee1d58145 stopping instance b1036536-3a31-4d47-8039-83952134de33
   Cell f237c36d-0a62-4579-a51b-b11ee1d58145 destroying container for instance b1036536-3a31-4d47-8039-83952134de33

ã‚¢ãƒ—ãƒªãŒé–‹å§‹ã™ã‚‹ã®ã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™...

åå‰:                   moneyger
è¦æ±‚ã•ã‚ŒãŸçŠ¶æ…‹:         started
çµŒè·¯:                   moneyger-chatty-zebra.cfapps.io
æœ€çµ‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚:   Mon 27 May 16:16:10 JST 2019
ã‚¹ã‚¿ãƒƒã‚¯:               cflinuxfs3
ãƒ“ãƒ«ãƒ‰ãƒ‘ãƒƒã‚¯:           client-certificate-mapper=1.8.0_RELEASE container-security-provider=1.16.0_RELEASE java-buildpack=v4.19-offline-https://github.com/cloudfoundry/java-buildpack.git#3f4eee2 java-main java-opts java-security jvmkill-agent=1.16.0_RELEASE
                        open-jdk-...

ã‚¿ã‚¤ãƒ—:           web
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹:     1/1
ãƒ¡ãƒ¢ãƒªãƒ¼ä½¿ç”¨é‡:   128M
é–‹å§‹ã‚³ãƒãƒ³ãƒ‰:     JAVA_OPTS="-agentpath:$PWD/.java-buildpack/open_jdk_jre/bin/jvmkill-1.16.0_RELEASE=printHeapHistogram=1 -Djava.io.tmpdir=$TMPDIR -XX:ActiveProcessorCount=$(nproc)
                  -Djava.ext.dirs=$PWD/.java-buildpack/container_security_provider:$PWD/.java-buildpack/open_jdk_jre/lib/ext -Djava.security.properties=$PWD/.java-buildpack/java_security/java.security $JAVA_OPTS" &&
                  CALCULATED_MEMORY=$($PWD/.java-buildpack/open_jdk_jre/bin/java-buildpack-memory-calculator-3.13.0_RELEASE -totMemory=$MEMORY_LIMIT -loadedClasses=12567 -poolType=metaspace -stackThreads=30 -vmOptions="$JAVA_OPTS") && echo JVM Memory Configuration:
                  $CALCULATED_MEMORY && JAVA_OPTS="$JAVA_OPTS $CALCULATED_MEMORY" && MALLOC_ARENA_MAX=2 SERVER_PORT=$PORT eval exec $PWD/.java-buildpack/open_jdk_jre/bin/java $JAVA_OPTS -cp $PWD/. org.springframework.boot.loader.JarLauncher
     çŠ¶æ…‹   é–‹å§‹æ—¥æ™‚               cpu    ãƒ¡ãƒ¢ãƒªãƒ¼            ãƒ‡ã‚£ã‚¹ã‚¯         è©³ç´°
#0   å®Ÿè¡Œ   2019-05-27T07:16:32Z   0.0%   128M ã®ä¸­ã® 12.3M   1G ã®ä¸­ã® 124M  
```

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®URLã¯`https://moneyger-<ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—>.cfapps.io`ã§ã™ã€‚

æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã€æ­£ã—ããƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ curl https://moneyger-<CHANGE ME>.cfapps.io/expenditures -d "{\"expenditureName\":\"ã‚³ãƒ¼ãƒ’ãƒ¼\",\"unitPrice\":300,\"quantity\":1,\"expenditureDate\":\"2019-06-03\"}" -H "Content-Type: application/json"
{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":"2019-06-03"}
```

```
$ curl https://moneyger-<CHANGE ME>.cfapps.io/expenditures
[{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":"2019-06-03"}]
```

```
$ curl https://moneyger-<CHANGE ME>.cfapps.io/expenditures/1
{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":"2019-06-03"}
```

```
$ curl -XDELETE https://moneyger-<CHANGE ME>.cfapps.io/expenditures/1
```

```
$ curl https://moneyger-<CHANGE ME>.cfapps.io/expenditures
[]
```

> Pivotal Web Servicesã¯ãƒ¡ãƒ¢ãƒªèª²é‡‘ã§ã‚ã‚Šã€128MBä½¿ç”¨ã®å ´åˆã«ã‹ã‹ã‚‹è²»ç”¨ã¯å¸¸æ™‚èµ·å‹•ã—ãŸçŠ¶æ…‹ã§ã€$2.70 (ç´„300å††) /æœˆã§ã™ã€‚

#### Kubernetesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

æ¬¡ã«Kubernetesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚Cloud Foundryã‚’ä½¿ã†äººã¯ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚

##### Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä½œæˆ

ã¾ãšã¯Spring Bootã‚¢ãƒ—ãƒªã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã€[`pack`](https://buildpacks.io/)ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
`pack`ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã¯[ã“ã¡ã‚‰](https://buildpacks.io/docs/install-pack/)ã‚’å‚ç…§ã«ã—ã¦ãã ã•ã„ã€‚

`pack`ã§Javaã‚¢ãƒ—ãƒªã‹ã‚‰Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«å¤‰æ›ã™ã‚‹ã«ã¯ãƒ“ãƒ«ãƒ‰ã‹ã‚‰`pack`ã§è¡Œã†æ–¹æ³•ã¨ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®jarã‹ã‚‰è¡Œã†æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚
ãã‚Œãã‚Œã‚„ã‚Šæ–¹ã‚’ç¤ºã™ã®ã§å¥½ããªæ–¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚

`pack`ã‚³ãƒãƒ³ãƒ‰ã§Docker Registryã¸ã®pushã¾ã§è¡Œã†ã®ã§ã€äº‹å‰ã«`docker login`ã‚’æ¸ˆã¾ã›ã¦ãŠã„ã¦ãã ã•ã„ã€‚

**ã‚½ãƒ¼ã‚¹ã®ãƒ“ãƒ«ãƒ‰ã‹ã‚‰è¡Œã†æ–¹æ³•**

```
$ pack build <image-name> --builder cloudfoundry/cnb:bionic --publish

# ä¾‹: pack build making/moneyger --builder cloudfoundry/cnb:bionic --publish
```

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†å ´åˆã€åˆå›ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„ãŸã‚Maven Buildã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚

ã„ãšã‚Œã®å ´åˆã§ã‚‚äºŒå›ç›®ä»¥é™ã¯`--no-pull`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã©ãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’çŸ­ç¸®ã§ãã¾ã™ã€‚

äºŒå›ç›®ä»¥é™ã¯æ¬¡ã®ã‚ˆã†ãªãƒ­ã‚°ã«ãªã‚Šã¾ã™ã€‚

```
$ pack build making/moneyger --builder cloudfoundry/cnb:bionic --publish --no-pull
Selected run image cloudfoundry/run:base-cnb
Using build cache volume pack-cache-37598e8529a1.build
Executing lifecycle version 0.3.0
===> DETECTING  
[detector] Trying group 1 out of 6 with 14 buildpacks...
[detector] ======== Results ========
[detector] skip: Cloud Foundry Archive Expanding Buildpack
[detector] pass: Cloud Foundry OpenJDK Buildpack
[detector] pass: Cloud Foundry Build System Buildpack
[detector] pass: Cloud Foundry JVM Application Buildpack
[detector] pass: Cloud Foundry Apache Tomcat Buildpack
[detector] pass: Cloud Foundry Spring Boot Buildpack
[detector] pass: Cloud Foundry DistZip Buildpack
[detector] skip: Cloud Foundry Procfile Buildpack
[detector] skip: Cloud Foundry Azure Application Insights Buildpack
[detector] skip: Cloud Foundry Debug Buildpack
[detector] skip: Cloud Foundry Google Stackdriver Buildpack
[detector] skip: Cloud Foundry JDBC Buildpack
[detector] skip: Cloud Foundry JMX Buildpack
[detector] pass: Cloud Foundry Spring Auto-reconfiguration Buildpack
===> RESTORING  
[restorer] Restoring cached layer 'org.cloudfoundry.openjdk:23cded2b43261016f0f246c85c8948d4a9b7f2d44988f75dad69723a7a526094'
[restorer] Restoring cached layer 'org.cloudfoundry.openjdk:d2df8bc799b09c8375f79bf646747afac3d933bb1f65de71d6c78e7466ff8fe4'
[restorer] Restoring cached layer 'org.cloudfoundry.openjdk:openjdk-jdk'
[restorer] Restoring cached layer 'org.cloudfoundry.buildsystem:build-system-cache'
[restorer] Restoring cached layer 'org.cloudfoundry.jvmapplication:executable-jar'
[restorer] Restoring cached layer 'org.cloudfoundry.springboot:spring-boot'
[restorer] Restoring cached layer 'org.cloudfoundry.springautoreconfiguration:0d524877db7344ec34620f7e46254053568292f5ce514f74e3a0e9b2dbfc338b'
===> ANALYZING  
[analyzer] Analyzing image 'index.docker.io/making/moneyger@sha256:9491786594cdda87cacd89b2ca8dce641236b1f3b18cea26c14410eb71f9c23f'
[analyzer] Using cached layer 'org.cloudfoundry.openjdk:23cded2b43261016f0f246c85c8948d4a9b7f2d44988f75dad69723a7a526094'
[analyzer] Using cached layer 'org.cloudfoundry.openjdk:d2df8bc799b09c8375f79bf646747afac3d933bb1f65de71d6c78e7466ff8fe4'
[analyzer] Using cached layer 'org.cloudfoundry.openjdk:openjdk-jdk'
[analyzer] Writing metadata for uncached layer 'org.cloudfoundry.openjdk:openjdk-jre'
[analyzer] Using cached layer 'org.cloudfoundry.buildsystem:build-system-cache'
[analyzer] Using cached launch layer 'org.cloudfoundry.jvmapplication:executable-jar'
[analyzer] Rewriting metadata for layer 'org.cloudfoundry.jvmapplication:executable-jar'
[analyzer] Using cached launch layer 'org.cloudfoundry.springboot:spring-boot'
[analyzer] Rewriting metadata for layer 'org.cloudfoundry.springboot:spring-boot'
[analyzer] Using cached layer 'org.cloudfoundry.springautoreconfiguration:0d524877db7344ec34620f7e46254053568292f5ce514f74e3a0e9b2dbfc338b'
[analyzer] Writing metadata for uncached layer 'org.cloudfoundry.springautoreconfiguration:auto-reconfiguration'
===> BUILDING   
[builder] 
[builder] Cloud Foundry OpenJDK Buildpack 1.0.0-M9
[builder]   OpenJDK JDK 11.0.3: Reusing cached layer
[builder]   OpenJDK JRE 11.0.3: Reusing cached layer
[builder] 
[builder] Cloud Foundry Build System Buildpack 1.0.0-M9
[builder]     Using wrapper
[builder]     Linking Cache to /home/cnb/.m2
[builder]   Compiled Application: Contributing to layer
[builder] /workspace
[builder] [INFO] Scanning for projects...
[builder] [INFO] 
[builder] [INFO] ------------------------< com.example:moneyger >------------------------
[builder] [INFO] Building moneyger 1.0.0-SNAPSHOT
[builder] [INFO] --------------------------------[ jar ]---------------------------------
[builder] [INFO] 
[builder] [INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ moneyger ---
[builder] [INFO] Using 'UTF-8' encoding to copy filtered resources.
[builder] [INFO] Copying 6 resources
[builder] [INFO] 
[builder] [INFO] --- maven-compiler-plugin:3.1:compile (default-compile) @ moneyger ---
[builder] [INFO] Changes detected - recompiling the module!
[builder] [INFO] Compiling 9 source files to /workspace/target/classes
[builder] [WARNING] /workspace/src/main/java/com/example/MessageHandler.java: /workspace/src/main/java/com/example/MessageHandler.java uses or overrides a deprecated API.
[builder] [WARNING] /workspace/src/main/java/com/example/MessageHandler.java: Recompile with -Xlint:deprecation for details.
[builder] [INFO] 
[builder] [INFO] --- maven-resources-plugin:2.6:testResources (default-testResources) @ moneyger ---
[builder] [INFO] Not copying test resources
[builder] [INFO] 
[builder] [INFO] --- maven-compiler-plugin:3.1:testCompile (default-testCompile) @ moneyger ---
[builder] [INFO] Not compiling test sources
[builder] [INFO] 
[builder] [INFO] --- maven-surefire-plugin:2.22.0:test (default-test) @ moneyger ---
[builder] [INFO] Tests are skipped.
[builder] [INFO] 
[builder] [INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ moneyger ---
[builder] [INFO] Building jar: /workspace/target/moneyger-1.0.0-SNAPSHOT.jar
[builder] [INFO] 
[builder] [INFO] --- spring-boot-maven-plugin:2.2.0.BUILD-SNAPSHOT:repackage (default) @ moneyger ---
[builder] [INFO] Replacing main artifact with repackaged archive
[builder] [INFO] ------------------------------------------------------------------------
[builder] [INFO] BUILD SUCCESS
[builder] [INFO] ------------------------------------------------------------------------
[builder] [INFO] Total time:  3.504 s
[builder] [INFO] Finished at: 2019-08-26T07:38:51Z
[builder] [INFO] ------------------------------------------------------------------------
[builder]   Removing source code
[builder] 
[builder] Cloud Foundry JVM Application Buildpack 1.0.0-M9
[builder]   Executable JAR: Reusing cached layer
[builder]   Process types:
[builder]     executable-jar: java -cp $CLASSPATH $JAVA_OPTS org.springframework.boot.loader.JarLauncher
[builder]     task:           java -cp $CLASSPATH $JAVA_OPTS org.springframework.boot.loader.JarLauncher
[builder]     web:            java -cp $CLASSPATH $JAVA_OPTS org.springframework.boot.loader.JarLauncher
[builder] 
[builder] Cloud Foundry Spring Boot Buildpack 1.0.0-M9
[builder]   Spring Boot 2.2.0.BUILD-SNAPSHOT: Reusing cached layer
[builder]   Process types:
[builder]     spring-boot: java -cp $CLASSPATH $JAVA_OPTS com.example.App
[builder]     task:        java -cp $CLASSPATH $JAVA_OPTS com.example.App
[builder]     web:         java -cp $CLASSPATH $JAVA_OPTS com.example.App
[builder] 
[builder] Cloud Foundry Spring Auto-reconfiguration Buildpack 1.0.0-M9
[builder]   Spring Auto-reconfiguration 2.7.0: Reusing cached layer
===> EXPORTING  
[exporter] Reusing layers from image 'index.docker.io/making/moneyger@sha256:9491786594cdda87cacd89b2ca8dce641236b1f3b18cea26c14410eb71f9c23f'
[exporter] Exporting layer 'app' with SHA sha256:c95d6559b8658f56939bcbe6d4c41150a363210a6810e4eb31bf7cee45f3aed3
[exporter] Reusing layer 'config' with SHA sha256:e26b93feb778917d0b68ee79a499d45ecd4a49ea52042192200c77df580c4169
[exporter] Reusing layer 'launcher' with SHA sha256:2187c4179a3ddaae0e4ad2612c576b3b594927ba15dd610bbf720197209ceaa6
[exporter] Reusing layer 'org.cloudfoundry.openjdk:openjdk-jre' with SHA sha256:9c84525dcbc758ce1754cce9b8f4d59f5ea6cf103a6c47043d900cad838052da
[exporter] Reusing layer 'org.cloudfoundry.jvmapplication:executable-jar' with SHA sha256:3d9310c8403c8710b6adcd40999547d6dc790513c64bba6abc7a338b429c35d2
[exporter] Reusing layer 'org.cloudfoundry.springboot:spring-boot' with SHA sha256:d776470042bc5bbb0270dcf1678f4eea7900f1a76caa15f35f9d4b25dbf7021e
[exporter] Reusing layer 'org.cloudfoundry.springautoreconfiguration:auto-reconfiguration' with SHA sha256:f61d2b65c75f9f5f2f2185fccb0be37ec39535bf89975c1632291f5116720479
[exporter] *** Images:
[exporter]       index.docker.io/making/moneyger:latest - succeeded
[exporter] 
[exporter] *** Digest: sha256:2d1025e87b7e8036c0bf6a7f9b357e2031d0932c03f56f9a595a1a62c710d02f
===> CACHING    
[cacher] Reusing layer 'org.cloudfoundry.openjdk:23cded2b43261016f0f246c85c8948d4a9b7f2d44988f75dad69723a7a526094' with SHA sha256:f0d412ec133fe252e7e1218ba97fc8a275bed7a65e931ed083c2c9b5bf63607b
[cacher] Reusing layer 'org.cloudfoundry.openjdk:d2df8bc799b09c8375f79bf646747afac3d933bb1f65de71d6c78e7466ff8fe4' with SHA sha256:636cde73aeca34a1e8730cdb74c4566fbf6ac7646fbbb2370b137ace1b4facf2
[cacher] Reusing layer 'org.cloudfoundry.openjdk:openjdk-jdk' with SHA sha256:d0551ffa6a58d07f92201ebcd6ff649fe9afb266f580fcd6eb67acf5bb8fc8c3
[cacher] Reusing layer 'org.cloudfoundry.buildsystem:build-system-cache' with SHA sha256:fe2ac9cb542d9dfa296a55c67136786dd18a47615dc27d57a9d68d9625f06c64
[cacher] Reusing layer 'org.cloudfoundry.jvmapplication:executable-jar' with SHA sha256:3d9310c8403c8710b6adcd40999547d6dc790513c64bba6abc7a338b429c35d2
[cacher] Reusing layer 'org.cloudfoundry.springboot:spring-boot' with SHA sha256:d776470042bc5bbb0270dcf1678f4eea7900f1a76caa15f35f9d4b25dbf7021e
[cacher] Reusing layer 'org.cloudfoundry.springautoreconfiguration:0d524877db7344ec34620f7e46254053568292f5ce514f74e3a0e9b2dbfc338b' with SHA sha256:8768e331517cabc14ab245a654e48e01a0a46922955704ad80b1385d3f033c28
Successfully built image making/moneyger
```

> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯Java 11ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚Java 8ã§ä½¿ç”¨ã—ãŸã„å ´åˆã¯`--env BP_JAVA_VERSION=8.*`ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚

**ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®jarã‹ã‚‰è¡Œã†æ–¹æ³•**

```
$ ./mvnw clean package -DskipTests=true
$ pack build <image-name> -p target/moneyger-1.0.0-SNAPSHOT.jar --builder cloudfoundry/cnb:bionic --publish

# ä¾‹: pack build making/moneyger -p jar --builder cloudfoundry/cnb:bionic --publish
```

Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã—ã¦å‹•ä½œç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```
docker run --rm -p 8080:8080 <image-name>
# ä¾‹: docker run --rm -p 8080:8080 making/moneyger
```

##### Kubernetesã¸ãƒ‡ãƒ—ãƒ­ã‚¤

`moneyger.yml`ã‚’ä½œæˆã—ã¦æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: moneyger
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: moneyger
  namespace: moneyger
spec:
  replicas: 1
  selector:
    matchLabels:
      app: moneyger
  template:
    metadata:
      labels:
        app: moneyger
    spec:
      containers:
      - image: <image-name>:latest
        # ä¾‹: 
        # image: making/moneyger:latest
        name: moneyger
        ports:
        - containerPort: 8080
        env:
        - name: _JAVA_OPTIONS
          value: "-Xmx15m -XX:ReservedCodeCacheSize=22M -XX:MaxDirectMemorySize=22M -XX:MaxMetaspaceSize=54M -Xss512K"
        resources:
          limits:
            memory: "128Mi"
          requests:
            memory: "128Mi"
        readinessProbe:
          httpGet:
            path: /expenditures
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /expenditures
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 10
          timeoutSeconds: 1
          periodSeconds: 10
          failureThreshold: 1
---
kind: Service
apiVersion: v1
metadata:
  name: moneyger
  namespace: moneyger
spec:
  type: LoadBalancer
  # ç’°å¢ƒã«ã‚ˆã£ã¦ã¯NodePort
  selector:
    app: moneyger
  ports:
  - protocol: TCP
    port: 8080
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ã€‚

```
kubectl apply -f moneyger.yml
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Podã®`STATUS`ãŒ`Running`ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
ã¾ãŸServiceã®`EXTERNAL-IP`ã«DNSåã¾ãŸã¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ kubectl get all -n moneyger
NAME                            READY   STATUS    RESTARTS   AGE
pod/moneyger-7d75db74cb-wv2fh   1/1     Running   0          35s

NAME               TYPE           CLUSTER-IP     EXTERNAL-IP                                                                    PORT(S)          AGE
service/moneyger   LoadBalancer   10.100.200.6   a6f010cd7c7d911e99cb7066f53a5a1a-1422899677.ap-northeast-1.elb.amazonaws.com   8080:32340/TCP   35s

NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/moneyger   1/1     1            1           35s

NAME                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/moneyger-7d75db74cb   1         1         1       35s
```

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®URLã¯`http://<EXTERNAL-IP>:8080`ã§ã™ã€‚

æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã€æ­£ã—ããƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ curl http://<EXTERNAL-IP>:8080/expenditures -d "{\"expenditureName\":\"ã‚³ãƒ¼ãƒ’ãƒ¼\",\"unitPrice\":300,\"quantity\":1,\"expenditureDate\":\"2019-06-03\"}" -H "Content-Type: application/json"
{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":"2019-06-03"}
```

```
$ curl http://<EXTERNAL-IP>:8080/expenditures
[{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":"2019-06-03"}]
```

```
$ curl http://<EXTERNAL-IP>:8080/expenditures/1
{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":"2019-06-03"}
```

```
$ curl -XDELETE http://<EXTERNAL-IP>:8080/expenditures/1
```

```
$ curl http://<EXTERNAL-IP>:8080/expenditures
[]
```

#### è£œè¶³

`routes()`ã®å®šç¾©ã¯æ¬¡ã®ã‚ˆã†ã«ãƒã‚¹ãƒˆã—ã¦è¨˜è¿°ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```java
    public RouterFunction<ServerResponse> routes() {
        return RouterFunctions.route()
            .path("/expenditures", b -> b
                .GET("/", this::list)
                .POST("/", this::post)
                .GET("/{expenditureId}", this::get)
                .DELETE("/{expenditureId}", this::delete))
            .build();
    }
```
