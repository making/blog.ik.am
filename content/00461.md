---
title: Javaç”¨Validatorãƒ©ã‚¤ãƒ–ãƒ©ãƒªYAVIã‚’ä½œã£ãŸ
tags: ["Java", "YAVI"]
categories: ["Programming", "Java", "am", "ik", "yavi"]
---

[YAVI](https://github.com/making/yavi)ã¨ã„ã†Javaç”¨Validatorãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®YAVIã‚’ä½œã£ã¦ã„ã¾ã™ã€‚
*Y*et *A*nother *V*al*i*dation for Javaã®ç•¥ã§"ãƒ¤ãƒ´ã‚¡ã‚¤"ã¨å‘¼ã³ã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ä½•ã§ä½œã£ã¦ã„ã‚‹ã®ã‹ã€ä½•ãŒé¢ç™½ã„ã®ã‹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

**ç›®æ¬¡**

<!-- toc -->

### å‹•æ©Ÿ

Javaã«ã¯ä¸€å¿œã€æ¨™æº–ã®[Bean Validation](https://beanvalidation.org/)ãŒã‚ã‚Šã€
å®Ÿè£…ã¨ã—ã¦ã¯[Hibernate Validator](https://hibernate.org/validator/)ãŒä¸€èˆ¬çš„ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚
Spring Bootã§ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å«ã¾ã‚Œã‚‹ã®ã§ã€å¤šãã®äººã¯ã“ã‚Œã‚’ä½¿ã£ã¦ã„ã¾ã™ã—ã€ã“ã‚Œã§äº‹è¶³ã‚Šã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚

YAVIã‚’ä½œã£ãŸã®ã¯Bean ValidationãŒå«Œã„ã ã‹ã‚‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãªã®ã§ã€Bean Validationã‚’æ‰¹åˆ¤ã™ã‚‹è¨³ã§ã¯ãªã„ã§ã™ã—ã€
Bean Validationã§å•é¡Œã‚’æ„Ÿã˜ã¦ã„ãªã‘ã‚Œã°ãã®ã¾ã¾ä½¿ãˆã°è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

ä½œã£ãŸãã£ã‹ã‘ã¯ã€"[Spring WebFlux.fn](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-fn)ã§ä½¿ãˆã‚‹ValidatorãŒæ¬²ã—ã‹ã£ãŸ"ã¨ã„ã†ç‚¹ã§ã™ã€‚
ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®Spring MVCã‚„Spring WebFluxã¨ã¯ç•°ãªã‚Šã€Functionãƒ™ãƒ¼ã‚¹ã®Spring WebFlux.fnã«ã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
å¥½ããªValidationãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æŒã¡è¾¼ã‚“ã§ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‘¼ã³å‡ºã›ã°è‰¯ã„ã¨è¨€ã†å‰²ã‚Šåˆ‡ã‚Šã«ãªã£ã¦ã„ã¾ã™ã€‚

Spring WebFlux.fnã¯ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³(ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³)ã‚’ä½¿ã‚ãªã„ãƒ©ãƒ ãƒ€ãƒ™ãƒ¼ã‚¹ã®Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚Šã€
ã“ã“ã§ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒªãƒãƒªã®Bean Validationã‚’ä½¿ã†ã®ã¯åˆã‚ãªã„ã‹ãªã¨æ„Ÿã˜ã€WebFlux.fnã§ã®ä½¿ç”¨ãƒ•ã‚£ãƒƒãƒˆã™ã‚‹ValiadtorãŒæ¬²ã—ã„ã¨è¨€ã†ã®ãŒYAVIã‚’ä½œã‚Šå§‹ã‚ãŸå‹•æ©Ÿã§ã™ã€‚

### ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

YAVIã‚’ä½œã‚‹ã«å½“ãŸã£ã¦ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨ã—ã¦ã¯ã€Functionãƒ™ãƒ¼ã‚¹ã®Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ãƒ•ã‚£ãƒƒãƒˆã™ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã‚‹ãŸã‚ã€

* ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯ä½¿ã‚ãªã„
* ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¯ä½¿ã‚ãªã„
* Java Beansã‚’å‰æã¨ã—ãªã„

ãã—ã¦ã€WebFlux.fnä»¥å¤–ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«

* 3rd partyãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¾å­˜ã—ãªã„

ã‚’æ²ã’ã¦ã„ã¾ã™ã€‚

ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä»£ã‚ã‚Šã«ãƒ©ãƒ ãƒ€å¼ã€ãƒ¡ã‚½ãƒƒãƒ‰å‚ç…§ã‚’å¤šç”¨ã—ã¾ã™ã€‚
[Spark Java](http://sparkjava.com/)ã‚„[javalin](https://javalin.io/)ãªã©ã€
Micro Frameworkã¨è¬³ã£ã¦ã„ã‚‹(ã‘ã©ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„)ã‚‚ã®ã¨ã‚‚ä½µã›ã¦ä½¿ãˆã¾ã™ã€‚


ã“ã‚Œã‚‰ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’åŸºã«ã€

* ä½¿ã„ã‚„ã™ã„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã®æä¾›
* ãƒãƒªãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ¬ãƒ‡ã‚£ãªæ©Ÿèƒ½ã®æä¾›

ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚Coolã•ã¨æ³¥è‡­ã•ã‚’ä¸¡ç«‹ã•ã›ãŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚
æ³¥è‡­ã•ã®æä¾›ã«ã¯SIeræ™‚ä»£ã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãŒæ´»ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

### åŸºæœ¬çš„ãªä½¿ã„æ–¹

Mavenã®å ´åˆã¯`pom.xml`ã«

```xml
<dependency>
  <groupId>am.ik.yavi</groupId>
  <artifactId>yavi</artifactId>
  <version>x.y.z</version>
</dependency>
```

Gradleã®å ´åˆã¯`build.gradle`ã«

```
compile('am.ik.yavi:yavi:x.y.z')
```

ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³(`x.y.z`)ã¯[GitHub](https://github.com/making/yavi/releases)ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„ã€‚


æ¬¡ã®`User`ã‚¯ãƒ©ã‚¹ã‚’ä¾‹ã«ã‚ã’ã¾ã™ã€‚

```java
public class User {
  private final String name;

  private final String email;

  private final Integer age;

  public User(String name, String email, Integer age) {
    this.name = name;
    this.email = email;
    this.age = age;
  }

  public String name() {
    return this.name;
  }

  public String email() {
    return this.email;
  }

  public Integer age() {
    return this.age;
  }
}
```

`User`ã‚¯ãƒ©ã‚¹ã«å¯¾ã—ã¦ã€ã¾ãšã¯YAVIã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã—ã¾ã™ã€‚å®šç¾©å ´æ‰€ã¯ã©ã“ã§ã‚‚è‰¯ã„ã§ã™ã€‚

```java
import am.ik.yavi.core.Validator;

static final Validator<User> validator = Validator.<User> builder() // builder(User.class)ã§ã‚‚å¯
        .constraint(User::name, "name", c -> c.notNull() //
            .greaterThanOrEqual(1) //
            .lessThanOrEqual(20)) //
        .constraint(User::email, "email", c -> c.notNull() //
            .greaterThanOrEqual(5) //
            .lessThanOrEqual(50) //
            .email()) //
        .constraint(User::age, "age", c -> c.notNull() //
            .greaterThanOrEqual(0) //
            .lessThanOrEqual(200))
        .build();
```

`constraint`ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒ©ãƒ ãƒ€å¼/ãƒ¡ã‚½ãƒƒãƒ‰å‚ç…§ã«å¯¾ã—ã¦ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã§åˆ¶ç´„ã‚’è¿½åŠ ã™ã‚‹å½¢å¼ã§ã™ã€‚
ç¬¬ä¸€å¼•æ•°ã®ãƒ©ãƒ ãƒ€å¼ã®å‹ã‹ã‚‰ã€è¨­å®šã§ãã‚‹åˆ¶ç´„ãŒæ±ºã¾ã‚Šã¾ã™ã€‚ä¾‹ãˆã°`email()`ã¯æ–‡å­—åˆ—ã‚’è¿”ã™ãƒ©ãƒ ãƒ€ã«å¯¾ã—ã¦ã—ã‹è¨­å®šã§ãã¾ã›ã‚“ã€‚
Bean Validationã§ã¯å‹ã®é•ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¸ã®åˆ¶ç´„ã¯å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€ã“ã“ã¯YAVIã®ãƒ¡ãƒªãƒƒãƒˆã¨è¨€ãˆã¾ã™ã€‚

> **ä½™è«‡**
> 
> ç¬¬äºŒå¼•æ•°ã¯åˆ¶ç´„å¯¾è±¡ã®åå‰ã§ã€ã“ã“ã ã‘æ–‡å­—åˆ—ã§æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒªã‚¯ãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ãªã„ãŸã‚ã€ã“ã“ã¯å¦¥å”ãƒã‚¤ãƒ³ãƒˆã§ã—ãŸã€‚
> Annotation Processorã‚’ä½¿ãˆã°ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ãƒ¡ã‚¿æƒ…å ±ã‚’ç”Ÿæˆã—ã¦ãã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§æ–‡å­—åˆ—ã¯æŒ‡å®šã—ãªãã¦ã‚‚ã‚ˆããªã‚Šã¾ã™ãŒã€
> ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ãªã„ã¨è¨€ã†ã‚³ãƒ³ã‚»ãƒ—ãƒˆã«åã—ã¾ã™ã€‚ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ã¨ã—ã¦ã¯æ–‡å­—åˆ—ä»¥å¤–ã«ã‚‚å¯¾è±¡åã‚’è¿”ã™ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã¨ãã‚Œã¨å—ã‘å–ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã ã‘ã‚’ä½œã‚Šã€
> ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ãŸã‚¯ãƒ©ã‚¹ã¯åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã—ã¦ã€ãã¡ã‚‰ã§Annotation Processorã‹ã‚‰ç”Ÿæˆã™ã‚‹ã¨è¨€ã†ã®ã‚‚è€ƒãˆã¦ã„ã¾ã™ã€‚

ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿæ–½æ–¹æ³•ã¯

```java
User user = new User("making", "making@example.com", 20);
ConstraintViolations violations = validator.validate(user);
```

ã§ã™ã€‚`ConstraintViolations`ã¯åˆ¶ç´„é•åé …ç›®ã‚’è¡¨ç¾ã™ã‚‹`ConstraintViolation`ã®`List`ã§ã™ã€‚

```java
violations.isValid(); // true or false 
```

ã§æ¤œè¨¼çµæœãŒã‚ã‹ã‚Šã¾ã™ã€‚
é•åé …ç›®ã®è©³ç´°ã¯`ConstraintViolations`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¤ãƒ†ãƒ¬ãƒ¼ãƒˆã™ã‚Œã°è‰¯ã„ã§ã™ã€‚
ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ¬¡ã®ã‚ˆã†ã«å‡ºåŠ›ã§ãã¾ã™ã€‚

```java
violations.forEach(x -> System.out.println(x.message()));
```

JSONã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã¨ãã«å¿…è¦ã§ã‚ã‚ã†é …ç›®ã ã‘ã‚’ã¾ã¨ã‚ãŸä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦ã€`details()`ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚

```java
List<ViolationDetail> details = violations.details();
```

REST APIå®Ÿè£…æ™‚ã¯ã€ã“ã‚Œã‚’ãã®ã¾ã¾è¿”ã™ã‹ã€ã“ã‚Œã‚’ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚‚ã¤ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚Œã°è‰¯ã„ã§ã—ã‚‡ã†ã€‚


Bean Validationã¨æ¯”è¼ƒã—ã¦ã€

* å„ç¨®åˆ¶ç´„ã‚’å®Ÿç¾ã™ã‚‹æ–¹æ³•ã¯[ã“ã¡ã‚‰](https://github.com/making/yavi/blob/develop/docs/FromBeanValidationToYAVI.md#from-bean-validation-to-yavi)
* ãƒã‚¹ãƒˆã—ãŸBeanã‚„ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾ã™ã‚‹åˆ¶ç´„ã®è¨­å®šæ–¹æ³•ã¯[ã“ã¡ã‚‰](https://github.com/making/yavi/blob/develop/docs/FromBeanValidationToYAVI.md#valid)
* ç‹¬è‡ªåˆ¶ç´„ã®å®Ÿè£…æ–¹æ³•ã¯[ã“ã¡ã‚‰](https://github.com/making/yavi/blob/develop/docs/FromBeanValidationToYAVI.md#custom-constraint)

ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚Bean Validationã‹ã‚‰ã®from-toå½¢å¼ã§ã‚µãƒ³ãƒ—ãƒ«ã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

### Either APIã®å°å…¥

ã“ã“ã¾ã§å®Ÿè£…ã—ã¦0.0.1ã‚’ãƒªãƒªãƒ¼ã‚¹ã—ã€å®Ÿéš›ã«å½“åˆã®ç›®çš„ã§ã‚ã£ãŸSpring WebFlux.fnã§ä½¿ç”¨ã—ã¦ã¿ã¾ã—ãŸã€‚

```java
static RouterFunction<ServerResponse> routes() {
  return route(POST("/"), req -> req.bodyToMono(User.class) //
      .flatMap(body -> {
        ConstraintViolations violations = validator.validate(body);
        if (violations.isValid(())) {
          return ok().syncBody(body);
        } else {
          Map<String, Object> res = new LinkedHashMap<>();
          res.put("message", "Invalid request body");
          res.put("details", violations.details());
          return badRequest().syncBody(res);
        }
      }));
}
```

ã†ãƒ¼ã‚“ã€æ‚ªããªã„ã‚“ã ã‘ã©ã€å°‘ã—æ®‹å¿µæ„ŸãŒã‚ã‚Šã¾ã™ã€‚
å…·ä½“çš„ã«ã„ã†ã¨`violations`ã®ifæ–‡ã§å‡¦ç†ã®æµã‚ŒãŒã›ãæ­¢ã‚ã‚‰ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ãŒæ®‹å¿µã§ã™ã€‚
ã›ã£ã‹ããƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒé–¢æ•°å‹ã‚¹ã‚¿ã‚¤ãƒ«ã§æ›¸ã‘ã‚‹ã®ã§ã€ã‚‚ã†å°‘ã—é–¢æ•°å‹ã«ãƒ•ã‚£ãƒƒãƒˆã—ãŸæ›¸ãæ–¹ãŒã—ãŸã„ã§ã™ã€‚

ã“ã‚Œã®èª²é¡Œã«å¯¾ã—ã¦ã€"Either"ã¨ã„ã†è€ƒãˆæ–¹ãŒã‚ã‚‹ã“ã¨ã‚’ã‚ã‹ã‚Šã¾ã—ãŸã€‚
ãƒ’ãƒ³ãƒˆã¨ãªã£ãŸã®ã¯[@gakuzzzz](https://twitter.com/gakuzzzz)ã•ã‚“ãŒæ›¸ã‹ã‚ŒãŸ[ã“ã®è¨˜äº‹](https://gist.github.com/gakuzzzz/0c779d5335f4b2bff596)ã§ã€ã±ã£ã¨è¦‹"ã†ã‚€ã€ã‚ã‹ã‚‰ã‚“"ã¨ã„ã†æ„Ÿã˜ã§ã—ãŸãŒã€
[Vavr](https://www.vavr.io/vavr-docs/#_either)ã¨ã„ã†Javaã«é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®è¦ç´ ã‚’å°å…¥ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‚è€ƒã«ã—ã€`Either`ã‚’ä½¿ãˆã°ã“ã®èª²é¡Œã‚’è§£æ±ºã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

`Optional`ã«å°‘ã—è¿‘ã„ã§ã™ãŒã€`Either`ã¯äºŒã¤(left, right)ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã©ã¡ã‚‰ã‹ã‚’è¡¨ç¾ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

```java
Either<String, Integer> either = Either.left("Hello");
```
ã‚ã‚‹ã„ã¯
```java
Either<String, Integer> either = Either.right(100);
```
ã¨ã„ã†è¡¨ç¾ãŒã§ãã¾ã™ã€‚
`Either`ã«å¯¾ã—ã¦`fold`ãƒ¡ã‚½ãƒƒãƒ‰ã§åŒã˜å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å°„å½±ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```java
String ret = either.fold(s -> s.toUpperCase(), i -> i.toString());
```

`Either`ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…ã¯éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ãªã®ã§ã€ä»–ã®APIã¯[ã‚½ãƒ¼ã‚¹](https://github.com/making/yavi/blob/develop/src/main/java/am/ik/yavi/fn/Either.java)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

ã“ã‚Œã‚’ä½¿ã£ã¦Validationã®çµæœã‚’è¡¨ç¾ã™ã‚Œã°ã€é–¢æ•°å‹ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã«ãƒ•ã‚£ãƒƒãƒˆã—ã¾ã™ã€‚Validationã®æ–‡è„ˆã§ã¯å³ã¨æ­£è§£ã‚’æ›ã‘ã¦ã€rightã«æ¤œè¨¼çµæœãŒOKã ã£ãŸå ´åˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’leftã‚’é•åå†…å®¹ã‚’å«ã‚ã‚‹ã®ãŒæ…£ä¾‹ã®ã‚ˆã†ã§ã™ã€‚

å…ˆã®ä¾‹ã‚’Eitehrã‚’ä½¿ã£ã¦æ›¸ãæ›ãˆã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```java
static RouterFunction<ServerResponse> routes() {
  return route(POST("/"), req -> req.bodyToMono(User.class) //
      .flatMap(body -> validator.validateToEither(body) //
          .fold(violations -> {
            Map<String, Object> res = new LinkedHashMap<>();
            res.put("message", "Invalid request body");
            res.put("details", violations.details());
            return badRequest().syncBody(res);
          }, user -> ok().syncBody(user))));
}
```

ifæ–‡ãŒæ¶ˆãˆã¦ã€ãƒ©ãƒ ãƒ€å¼ã ã‘ã§è¡¨ç¾ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã§Spring WebFlux.fnã«åˆã£ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿç¾ã§ãã¾ã™ã€‚


<blockquote class="twitter-tweet" data-lang="en"><p lang="ja" dir="ltr">ãƒ¢ãƒŠãƒ‰ã¯æŠ½è±¡åº¦ãŒé«˜ãã¦ç†è§£ãŒé›£ã—ã„ã¨ã„ã†ã®ã¯ã¾ã‚ã‚ã‹ã‚‹ãŒã€Eitherã‚„Validationã®ã‚ˆã†ãªå…·è±¡æ¦‚å¿µã¯ãã‚Œãªã‚Šã«ä½¿ã„ã‚„ã™ã„ã®ã§ã¯ãªã‹ã‚ã†ã‹ã€‚ã¿ã‚“ãªListãŒãƒ¢ãƒŠãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å®šç¾©ã§ãã‚‹ã¨çŸ¥ã‚‰ãªãã¦ã‚‚Listä¾¿åˆ©ã«ä½¿ã£ã¦ã‚‹ã—</p>&mdash; ãŒãã (@gakuzzzz) <a href="https://twitter.com/gakuzzzz/status/1031770151870332928?ref_src=twsrc%5Etfw">August 21, 2018</a></blockquote>

ç¢ºã‹ã«`Either`ã‚’å®Ÿéš›ã«è§£æ±ºã—ãŸã„å•é¡Œã«å¯¾ã—ã¦é©ç”¨ã™ã‚‹ã¨ã€ã¨ã¦ã¤ã‚‚ãªãå¼·åŠ›ã ã¨è¨€ã†ã“ã¨ãŒå®Ÿæ„Ÿã§ãã¾ã—ãŸã€‚

WebFlux.fnã«é™ã‚‰ãš`Either`ã‚’ä½¿ã†ã¨ä¾¿åˆ©ã§ã™ã€‚
ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã‚’Formã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§å—ã‘å–ã‚Šã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒé€šã£ãŸå¾Œã«Domainã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã™ã‚‹ã¨ã„ã†å‡¦ç†ã¯æ¬¡ã®ã‚ˆã†ã«ç°¡æ½”ã«è¡¨ç¾ã§ãã¾ã™ã€‚

```java
validator.validateToEither(form)
  .fold(violations -> "NG",
    f -> {
      Foo foo = f.toDomainObject();
      foo.doSomething();
      return "OK";
    }
  );
```

### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è£œé–“

ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è§£æ±ºã¯Validatorãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®1ã¤ã®å¤§ããªãƒ†ãƒ¼ãƒã§ã™ã€‚
YAVIã§ã¯ã“ã“ã¯æœ¬æ ¼çš„ã«ã¯å–ã‚Šçµ„ã‚“ã§ãŠã‚‰ãšã€ç¾æ™‚ç‚¹ã§ã¯"Bring Your Own MessageInterpolator"ã®ã‚¹ã‚¿ãƒ³ã‚¹ã§ã™ã€‚
`MessageFormatter`ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã ã‘ã‚’ç”¨æ„ã—ã¦ãŠã‚Šã€
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`java.text.MessageFormatter`ã‚’ä½¿ã£ãŸæ¥µã‚ã¦ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚­ãƒ¼ã®ä¸€è¦§ã¯[Enum](https://github.com/making/yavi/blob/develop/src/main/java/am/ik/yavi/constraint/ViolationMessage.java)ã§å®šç¾©ã—ã¦ã‚ã‚‹ã®ã§ã€

ã“ã“ã‹ã‚‰ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ã€ãã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«(`messages.properties`)ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®šç¾©ã—ãŸã„å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ãªå®Ÿè£…ã‚’ã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

```java
import java.text.MessageFormat;
import java.util.Locale;
import java.util.MissingResourceException;
import java.util.ResourceBundle;

import am.ik.yavi.constraint.ViolationMessage;
import am.ik.yavi.message.MessageFormatter;

public enum ResourceBundleMessageFormatter implements MessageFormatter {
    SINGLETON;

    @Override
    public String format(String messageKey, String defaultMessageFormat, Object[] args,
            Locale locale) {
        ResourceBundle resourceBundle = ResourceBundle.getBundle("messages", locale);
        String format;
        try {
            format = resourceBundle.getString(messageKey);
        }
        catch (MissingResourceException e) {
            format = defaultMessageFormat;
        }
        try {
            String target = resourceBundle.getString((String) args[0]);
            args[0] = target;
        }
        catch (MissingResourceException e) {
        }
        return new MessageFormat(format, locale).format(args);
    }
}
```

`MessageFormatter`ã‚’å·®ã—æ›¿ãˆãŸã„å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«è¨­å®šã§ãã¾ã™ã€‚

```java
static final Validator<User> validator = Validator
            .builder(User.class)
            .messageFormatter(ResourceBundleMessageFormatter.SINGLETON)
            // ...
            .build()
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…±é€šã§ä½¿ã„ãŸã„å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ãªãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚Œã°è‰¯ã„ã§ã—ã‚‡ã†ã€‚


```java
public static ValidatorBuilder<T> validator(Class<T> clazz) {
  return Validator.builder(clazz).messageFormatter(ResourceBundleMessageFormatter.SINGLETON);
}
```

ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã“ã ã‚ã‚Šã¨ã—ã¦ã€Bean Validationã¨æ¯”è¼ƒã—ã¦ã€

* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é …ç›®åã‚’å«ã‚ã‚‹
* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«é•åã—ãŸå†…å®¹ã‚’å«ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

ãŒå¯¾å¿œã•ã‚Œã¦ã„ã¾ã™ã€‚
ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¬¬ä¸€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€`{0}`ã«ã¯é …ç›®åã€æœ€å¾Œã®é …ç›®ã«ã¯é•åå€¤ãŒå…¥ã‚Šã¾ã™ã€‚

ç‰¹ã«2ã¤ã‚ã«é–¢ã—ã¦ã¯ã€ä¸€èˆ¬çš„ãªValidationãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯å¯¾å¿œã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ä¾‹ãˆã°ã€"xxxxxã¯100æ–‡å­—ä»¥ä¸‹ã«ã—ã¦ãã ã•ã„"ã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã£ã¦æ¥ã¦ã‚‚ã€
å®Ÿéš›ã«ä»Šå…¥åŠ›ã—ãŸå†…å®¹ãŒä½•æ–‡å­—ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹ã®ã‹ãŒã‚ã‹ã‚‰ãªã„ãŸã‚ã€å°‘ã—ãšã¤æ–‡å­—ã‚’å‰Šã£ã¦ãƒˆãƒ©ã‚¤ã™ã‚‹ã¨ã„ã†ã“ã¨ãŒãŸã¾ã«ã‚ã‚Šã¾ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã†ã„ã†ç„¡é§„ãªã“ã¨ã‚’ã—ãªãã¦ã‚‚è‰¯ã„ã‚ˆã†ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ¬¡ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![image](https://user-images.githubusercontent.com/106908/44784067-4b010600-abc7-11e8-8878-930d017405bb.png)


### æ–‡å­—é•·ãƒã‚§ãƒƒã‚¯

YAVIã®ç‰¹å¾´ã¨ã¦æ–‡å­—é•·ãƒã‚§ãƒƒã‚¯ã«å¯¾ã™ã‚‹ã‚µãƒãƒ¼ãƒˆãŒåšã„ã§ã™ã€‚

æ–‡å­—æ•°ã®åˆ¶ç´„ã¨ã—ã¦ã€å…¥åŠ›ã•ã‚ŒãŸæ–‡å­—ã‚’ã§ãã‚‹ã ã‘è¦‹ãŸç›®é€šã‚Šã®æ–‡å­—æ•°ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚
æ˜¨ä»Šã€Unicodeä¸Šã®æ–‡å­—ã®å®šç¾©ã®ä¹±ç«‹(?)ã§ã€è¦‹ãŸç›®ã®ã‚µã‚¤ã‚ºã¨`String#length`ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿”ã‚Šå€¤ãŒå¤§ããä¹–é›¢ã—ã¦ã„ã¾ã™ã€‚

* ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢
* çµåˆæ–‡å­—
* SVS (Standardized Variation Sequence)
* IVS (Ideographic Variation Sequence)
* FVS (Mongolian Free Variation Selector)
* Emoji

ãã‚Œãã‚Œã®èª¬æ˜ã¯å‰²æ„›ã—ã¾ã™ãŒã€å…¨ã¦è¦‹ãŸç›®é€šã‚Šã®æ–‡å­—æ•°ã§åˆ¶ç´„ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã¾ã™ã€‚
(Emojiã«é–¢ã—ã¦ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯è¦‹ãŸç›®é€šã‚Šã‚µã‚¤ã‚ºã®ãƒã‚§ãƒƒã‚¯ã«ã¯ãªã‚Šã¾ã›ã‚“ã€‚)

ä»£è¡¨çš„ãªä¾‹ã‚’è¦‹ã¾ã—ã‚‡ã†ã€‚

#### ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢

åºã®å£ã§ã™ã€‚

```java
"ğ ®·é‡å±‹".length() // 4
```

YAVIã§ã¯ã“ã®æ–‡å­—åˆ—ã‚’3æ–‡å­—ã¨ã¿ãªã—ã¾ã™ã€‚

```java
static final Validator<Message> validator = Validator
            .builder(Message.class)
            .constraint(Message::text, "text", c -> c.lessThanOrEqual(3))
            .build();

validator.validate(new Message("ğ ®·é‡å±‹")).isValid(); // true
```

#### çµåˆæ–‡å­—

```java
"ãƒ¢ã‚·ã‚™".length() // 3
```

è¦‹ãŸç›®ä¸Šã¯2æ–‡å­—ã§ã™ãŒã€"ã‚·"ã¨æ¿ç‚¹ãŒçµåˆã—ã¦ãŠã‚Šã€`length()`ã®çµæœã¯3ã§ã™ã€‚

YAVIã§ã¯ã“æ–‡å­—åˆ—ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§2æ–‡å­—ã¨ã¿ãªã—ã¾ã™ã€‚

```java
static final Validator<Message> validator = Validator
            .builder(Message.class)
            .constraint(Message::text, "text", c -> c.lessThanOrEqual(2))
            .build();

validator.validate(new Message("ãƒ¢ã‚·ã‚™")).isValid(); // true
```

`java.text.Normalizer`ã‚’ä½¿ã£ã¦ãŠã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`java.text.Normalizer.Form#NFC`ã§æ­£è¦åŒ–ã—ã¾ã™ã€‚
ã“ã®æŒ™å‹•ã¯æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã§ãã¾ã™ã€‚(`null`ã‚’è¨­å®šã™ã‚‹ã¨æ­£è¦åŒ–ã—ãªã„)

```java
static final Validator<Message> validator = Validator
            .builder(Message.class)
            .constraint(Message::text, "text", c -> c.normalizer(normalizerForm).lessThanOrEqual(2))
            .build();
```

#### IVS
ç•°å­—ä½“ã‚»ãƒ¬ã‚¯ã‚¿ã¯`Normalizer`ã§ã¯æ­£è¦åŒ–ã§ãã¾ã›ã‚“ã€‚

```java
"ğ ®Ÿó „€".length() // 4
```

è¦‹ãŸç›®ä¸Šã¯1æ–‡å­—ã§ã™ãŒã€UTF-16ã§è¡¨ç¾ã™ã‚‹ã¨"D842 DF9F DB40 DD00"ãªã®ã§`length()`ã®çµæœã¯4ã§ã™ã€‚

YAVIã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã“ã®æ–‡å­—ã‚’1æ–‡å­—ã¨ã¿ãªã—ã¾ã™ã€‚
YAVIã¯å¯¾è±¡ã®æ–‡å­—åˆ—ã‹ã‚‰IVSã®ç¯„å›²ã§ã‚ã‚‹0xE0100-0xE01EFã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç„¡è¦–(å‰Šé™¤)ã—ã¾ã™ã€‚ã“ã†ã™ã‚Œã°ãŸã ã®ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ã§ã™ã€‚


```java
static final Validator<Message> validator = Validator
            .builder(Message.class)
            .constraint(Message::text, "text", c -> c.lessThanOrEqual(1))
            .build();

validator.validate(new Message("ğ ®Ÿó „€")).isValid(); // true
```

åŒæ§˜ã«SVSã‚„FVSã‚‚å¯¾å¿œã—ã¾ã™ã€‚
ã“ã‚Œã‚‰ã®å‡¦ç†ã¯æ­£è¦è¡¨ç¾ã‚’ä½¿ã£ã¦è¡Œãªã£ã¦ã„ã‚‹ãŸã‚ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å½±éŸ¿ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®å‡¦ç†ã‚’ç„¡åŠ¹(ç„¡è¦–ã—ãªã„)ã«ã—ãŸã„å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«è¨­å®šã§ãã¾ã™ã€‚

```java
static final Validator<Message> validator = Validator
            .builder(Message.class)
            .constraint(Message::text, "text", c -> c.variant(ops -> ops.ivs(IdeographicVariationSequence.NOT_IGNORE)).lessThanOrEqual(2))
            .build();
```   

#### Emoji

Unicodeç•Œæœ€ç‹‚ã«ã—ã¦ã€å‰å‡ºã®æ–‡å­—ã«æ¯”ã¹ã¦åˆ©ç”¨é »åº¦ãŒæ¥µã‚ã¦é«˜ã„æ–‡å­—ç¨®ãŒ"Emoji"ã§ã™ã€‚
ã‚‚ã†ãƒ¡ãƒãƒ£ã‚¯ãƒãƒ£ã§ã™ã€‚

```java
"â¤ï¸".length() // 2
"ğŸ§ğŸ¼".length() // 4
"ğŸ‘¨â€ğŸ‘§".length() // 5
"ğŸ‘©â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦".length() // 11
"ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿".length() // 14 (!!!!!)
```

å„ç¨®Emojiã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒã©ã†æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã‹ã¯[ã“ã¡ã‚‰](https://unicode.org/Public/emoji/11.0/emoji-test.txt)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
YAVIã¯ã“ã‚‰ã‚‰ã®Emojiã‚’é ‘å¼µã£ã¦1æ–‡å­—ã¨ã¿ãªã—ã¾ã™ã€‚ç¢ºå®Ÿã«ä¿è¨¼ã¯ã§ãã¾ã›ã‚“ãŒã€Emoji 11.0ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¯å…¨éƒ¨ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ãŸã€‚

ã“ã®å‡¦ç†ã¯ã‚³ã‚¹ãƒˆãŒå¤§ãã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚`emoji()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```java

static final Validator<Message> validator = Validator
            .builder(Message.class)
            .constraint(Message::text, "text", c -> c.emoji().lessThanOrEqual(1))
            .build();

validator.validate(new Message("â¤ï¸")).isValid(); // true
validator.validate(new Message("ğŸ§ğŸ¼")).isValid(); // true
validator.validate(new Message("ğŸ‘¨â€ğŸ‘§")).isValid(); // true
validator.validate(new Message("ğŸ‘©â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦")).isValid(); // true
validator.validate(new Message("ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿")).isValid(); // true
```

ã“ã“ã¾ã§è¦‹ãŸç›®ã®æ–‡å­—é•·ã¨å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆé•·ã«ä¹–é›¢ãŒã‚ã‚‹ã¨ã€
è¦‹ãŸç›®ã®åˆ¶ç´„ã¯OKã ã‘ã‚Œã©ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ã‚µã‚¤ã‚ºã‚’ã‚ªãƒ¼ãƒãƒ¼ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
YAVIã§ã¯è¦‹ãŸç›®ã®ã‚µã‚¤ã‚ºã«åŠ ãˆã€ãƒã‚¤ãƒˆé•·ã®ãƒã‚§ãƒƒã‚¯ã‚‚ã§ãã¾ã™ã€‚

```java
Validator<Message> validator = Validator.<Message> builder() //
            .constraint(Message::getText, "text", c -> c.emoji().lessThanOrEqual(3).asByteArray().lessThanOrEqual(16)) //
            .build(); //
validator.validate(new Message("Iâ¤ï¸â˜•ï¸")).isValid(); // true
validator.validate(new Message("â¤ï¸ï¸â¤ï¸ï¸â¤ï¸ï¸")).isValid(); // false
```

### ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆé›†åˆ

æ–‡å­—é•·ã¨ã¯ç•°ãªã‚Šã€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã§ã¯ã‚·ã‚¹ãƒ†ãƒ è¨±å¯æ–‡å­—ã‚’å®šã‚ã¦ã„ã‚‹ã‚·ã‚¹ãƒ†ãƒ ãŒå¤šã„ã§ã™ã€‚
ä¾‹ãˆã°ã€åå‰ã«ã¯"ã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã€JISç¬¬1-2æ°´æº–æ¼¢å­—"ã®ã¿è¨±å¯ã™ã‚‹ã€‚ãªã©ã€‚
ã“ã®åˆ¶ç´„ãŒè‰¯ã„ã‹ã©ã†ã‹ã¯åˆ¥ã«ã—ã¦ã€YAVIã§ã¯ã‚·ã‚¹ãƒ†ãƒ ã§è¨±å¯ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆé›†åˆã‚’ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã‚ã‚‹ã„ã¯ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆå½¢å¼ã§æŒ‡å®šã§ãã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®é›†åˆã¯`am.ik.yavi.constraint.charsequence.CodePoints`ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã§è¡¨ç¾ã•ã‚Œã€
`java.util.Set`ã‚’ä½¿ã£ã¦é›†åˆã‚’è¡¨ç¾ã™ã‚‹`CodePointsSet`ã¨ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¯„å›²ã®ãƒªã‚¹ãƒˆã§è¡¨ç¾ã™ã‚‹`CodePointsRanges`ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

ä¾‹ãˆã°"A,B,C,D,a,b,c,d"ã‹ã‚‰æˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆé›†åˆã¯

```java
CodePointsSet<String> codePoints = () -> new HashSet<>(
        Arrays.asList(0x0041 /* A */, 0x0042 /* B */, 0x0043 /* C */, 0x0044 /* D */,
                      0x0061 /* a */, 0x0062 /* b */, 0x0063 /* c */, 0x0064 /* d */));
```

ã¾ãŸã¯

```java
CodePointsRanges<String> codePoints = () -> Arrays.asList(
        Range.of(0x0041/* A */, 0x0044 /* D */),
        Range.of(0x0061/* a */, 0x0064 /* d */));
```

ã§è¡¨ç¾ã§ãã¾ã™ã€‚é€£ç¶šã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å ´åˆã¯å¾Œè€…ã®æ–¹ãŒãƒ¡ãƒ¢ãƒªåŠ¹ç‡ãŒåœ§å€’çš„ã«è‰¯ã„ã§ã™ã€‚

ã“ã“ã§å®šç¾©ã—ãŸ`CodePoints`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’`Validator`ã«æŒ‡å®šã§ãã¾ã™ã€‚

ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ(è¨±å¯æ–‡å­—)ã¨ã—ã¦æ‰±ã„ãŸã„ã¨ãã¯æ¬¡ã®ã‚ˆã†ã«æŒ‡å®šã—ã¾ã™ã€‚

```java
Validator<Message> validator = Validator.<Message> builder() //
            .constraint(Message::getText, "text", c -> c.codePoints(codePoints).allIncluded()) //
            .build(); //
validator.validate(new Message("aBCd")).isValid(); // true
validator.validate(new Message("aBCe")).isValid(); // false
```

ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ(ç¦æ­¢æ–‡å­—)ã¨ã—ã¦æ‰±ã„ãŸã„ã¨ãã¯æ¬¡ã®ã‚ˆã†ã«æŒ‡å®šã—ã¾ã™ã€‚


```java
Validator<Message> validator = Validator.<Message> builder() //
            .constraint(Message::getText, "text", c -> c.codePoints(codePoints).notIncluded()) //
            .build(); //
validator.validate(new Message("hello")).isValid(); // true
validator.validate(new Message("hallo")).isValid(); // false
```

ãƒ—ãƒªã‚»ãƒƒãƒˆã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆé›†åˆã¨ã—ã¦ã¯

* `AsciiCodePoints#ASCII_PRINTABLE_CHARS` ... ASCIIå°å­—å¯èƒ½æ–‡å­—
* `AsciiCodePoints#ASCII_CONTROL_CHARS` ... ASCIIåˆ¶å¾¡æ–‡å­—
* `UnicodeCodePoints#HIRAGANA` ... Unicodeã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹[Hiragana](https://www.unicode.org/charts/nameslist/c_3040.html) (JIS X 0208ã®å®šç¾©ã¨ã¯ç•°ãªã‚Šã¾ã™)
* `UnicodeCodePoints#KATAKANA` ... Unicodeã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹[Katakana](https://www.unicode.org/charts/nameslist/c_30A0.html)ãŠã‚ˆã³[Katakana Phonetic Extensions](https://www.unicode.org/charts/nameslist/c_31F0.html) (JIS X 0208ã®å®šç¾©ã¨ã¯ç•°ãªã‚Šã¾ã™)


ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

`CompositeCodePoints`ã‚¯ãƒ©ã‚¹ã§è¤‡æ•°ã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆé›†åˆã®å’Œé›†åˆã‚’è¡¨ç¾ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚


### 3rd Partyãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã®é€£æº

æœ€å¾Œã®èª¬æ˜ã«ãªã‚Šã¾ã™ã€‚
YAVIã¨ã—ã¦ã¯ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æŒãŸãªã„ã¨ã„ã†ã‚³ãƒ³ã‚»ãƒ—ãƒˆãŒã‚ã‚Šã¾ã™ãŒã€
å®Ÿéš›ã«ä½¿ã†éš›ã«ã¯ã‚„ã¯ã‚Š3rd Partyã¨ã®é€£æºãŒå‡ºã¦ãã¾ã™ã€‚

ä¾‹ãˆã°ã€Spring MVCã¨YAVIã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ã†å ´åˆã¯ã€åˆ¶ç´„é•åçµæœã‚’`BindingResult`ã«è©°ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
æ¬¡ã®ã‚ˆã†ãªå‡¦ç†ã§ã™ã€‚

```java
@PostMapping("users")
public String createUser(Model model, UserForm userForm, BindingResult bindingResult) {
    return validator.validateToEither(userForm)
        .fold(violations -> {
            violations.forEach(v -> {
                bindingResult.rejectValue(v.name(), v.messageKey(), v.args(), v.message()); // Here!!
            });
            return "userForm";
        }, form -> {
            // ...
            return "redirect:/";
        });
}
```

ã“ã‚Œã«å¯¾ã—ã¦å˜ç´”ã«æ¬¡ã®ã‚ˆã†ãªãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’æä¾›ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```java
public static void rejectValue(BindingResult bindingResult, ConstraintViolation v) {
  bindingResult.rejectValue(v.name(), v.messageKey(), v.args(), v.message()); 
}
```

ã—ã‹ã—ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã™ã‚‹ã¨ã„ã†ã“ã¨ã¯YAVIãŒ`org.springframework.validation.BindingResult`ã¸ã®ä¾å­˜ã‚’æŒã¤ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
ä¾å­˜ã‚’æŒã¤ã“ã¨ãªãã€3rd Partyãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨é€£æºã—ã‚„ã™ã‚ˆã†ã«ã€Functional Interfaceã¨ãƒ¡ã‚½ãƒƒãƒ‰å‚ç…§ã‚’æ´»ç”¨ã—ã¦ã„ã¾ã™ã€‚

YAVIå´ã§`BindingResult#rejectValue`ã¨åŒã˜å¼•æ•°ã‚’ã‚‚ã¤Functional Interfaceã‚’ã‚‚ã¡ã€ãã‚Œã‚’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã¨ã—ã¦å—ã‘å–ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’
ä½œæˆã™ã‚‹ã¨ã€`BindingResult`ã¸ã®ä¾å­˜ã‚’æŒã¤ã“ã¨ãªãã€æ¬¡ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```java
@PostMapping("users")
public String createUser(Model model, UserForm userForm, BindingResult bindingResult) {
    return validator.validateToEither(userForm)
        .fold(violations -> {
            violations.apply(bindingResult::rejectValue);
            return "userForm";
        }, form -> {
            // ...
            return "redirect:/";
        });
}
```

ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’æä¾›ã™ã‚‹ã‚ˆã‚Šã€Coolã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

ã‚‚ã†1ä¾‹ã‚ã‚Šã¾ã™ã€å‰å‡ºã®`CodePoints`é›†åˆã¨ã—ã¦NTT DATAã®TERASOLUNAãŒJIS X 201, JIS X 208ãŠã‚ˆã³JIS X 0213ã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆé›†åˆã‚¯ãƒ©ã‚¹ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

* [ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://terasolunaorg.github.io/guideline/5.4.1.RELEASE/ja/ArchitectureInDetail/GeneralFuncDetail/StringProcessing.html#stringprocessinghowtousecodepoints)ã€
* [ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰](https://github.com/terasolunaorg/terasoluna-gfw/tree/master/terasoluna-gfw-common-libraries/terasoluna-gfw-codepoints/catalog)

ç¬¬1,2,3,4æ°´æº–æ¼¢å­—ã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆé›†åˆãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚ä¾å­˜ãªã—ã§ä½¿ãˆã‚‹ã®ã§ã™ãŒã€YAVIã‹ã‚‰ã¯ä¾å­˜ã—ãŸãã‚ã‚Šã¾ã›ã‚“ã€‚

ã“ã“ã§ã‚‚TERASOLUNAã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆé›†åˆã‚’YAVIã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆé›†åˆã«å¤‰æ›ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½œã‚‹ã®ã§ã¯ãªãã€
ãƒ¡ã‚½ãƒƒãƒ‰å‚ç…§ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€ã‚«ã‚¿ã‚«ãƒŠã€ã²ã‚‰ãŒãªã€ç¬¬1,2,3,4æ°´æº–æ¼¢å­—ã‚’å«ã‚€ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆé›†åˆã‚’ä½œã‚ŠãŸã„å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«è¨˜è¿°ã§ãã¾ã™ã€‚

```java
import org.terasoluna.gfw.common.codepoints.catalog.JIS_X_0213_Kanji;
import am.ik.yavi.constraint.charsequence.CodePoints;
import static am.ik.yavi.constraint.charsequence.codepoints.UnicodeCodePoints.KATAKANA;
import static am.ik.yavi.constraint.charsequence.codepoints.UnicodeCodePoints.HIRAGANA;

static final CodePoints<String> SUPPORTED = new CompositeCodePoints<>(KATAKANA, 
                                                                      HIRAGANA, 
                                                                      new JIS_X_0213_Kanji()::allExcludedCodePoints);

static final Validator<Message> validator = Validator.<Message> builder() //
            .constraint(Message::getText, "text", c -> c.codePoints(codePoints).allIncluded()) //
            .build(); //
```


---

YAVIã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨é¢ç™½ã•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ã“ã®è¨˜äº‹ã‚’è¦‹ã¦"ãƒ¤ãƒ´ã‚¡ã‚¤"ã¨ã„ã†æ„Ÿæƒ³ã‚’æŒã£ã¦ã„ãŸã ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

YAVIã¯ã¾ã ã¾ã é–‹ç™ºé€”ä¸Šã§ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚
èˆˆå‘³ã‚’æŒã£ã¦ã„ãŸã ã„ãŸæ–¹ã¯æ˜¯éä½¿ã£ã¦è¦‹ã¦ã€å•é¡Œã‚„æ”¹å–„ç‚¹ãŒã‚ã‚Œã°[GitHub](https://github.com/making/yavi)ã§å ±å‘Šã—ã¦ãã ã•ã„ã€‚
Starã‚‚ãã ã•ã„ã€‚ 

