---
title: HashiCorp VaultのAuto UnsealをAzure Key Vaultで行うメモ
tags: ["Vault", "Auto Unseal", "Azure Key Vault", "Azure"]
categories: ["Dev", "SecretManagement", "Vault"]
date: 2026-02-24T04:02:11.651251132Z
updated: 2026-02-24T04:02:11.651251132Z
---

### 環境変数設定

```bash
export RESOURCE_GROUP="rg-vault"
export LOCATION="japaneast"
export KEYVAULT_NAME="kv-vault-unseal"
export KEY_NAME="vault-unseal-key"
export SP_NAME="sp-vault-unseal"
```

### リソースグループ作成

```bash
az group create --name $RESOURCE_GROUP --location $LOCATION
```

### Key Vault作成

```bash
az keyvault create \
  --name $KEYVAULT_NAME \
  --resource-group $RESOURCE_GROUP \
  --location $LOCATION \
  --sku standard
```

### 自分自身にキー操作権限を付与

```bash
export MY_OBJECT_ID=$(az ad signed-in-user show --query id --output tsv)

export KEYVAULT_ID=$(az keyvault show \
  --name $KEYVAULT_NAME \
  --resource-group $RESOURCE_GROUP \
  --query id --output tsv)

az role assignment create \
  --role "Key Vault Crypto Officer" \
  --assignee $MY_OBJECT_ID \
  --scope $KEYVAULT_ID
```

### キー作成

```bash
az keyvault key create \
  --vault-name $KEYVAULT_NAME \
  --name $KEY_NAME \
  --kty RSA \
  --size 2048
```

### Service Principal の作成

```bash
export SP_APP_ID=$(az ad sp create-for-rbac \
  --name $SP_NAME \
  --years 99 \
  --query appId \
  --output tsv)

az role assignment create \
  --role "Key Vault Crypto Service Encryption User" \
  --assignee $SP_APP_ID \
  --scope $KEYVAULT_ID
```

### vault.hclに必要な設定値を出力

```bash
export AZURE_CLIENT_ID=$SP_APP_ID
export AZURE_TENANT_ID=$(az ad sp show \
  --id $SP_APP_ID \
  --query appOwnerOrganizationId \
  --output tsv)
# passwordはリセットして再取得
export AZURE_CLIENT_SECRET=$(az ad sp credential reset \
  --id $SP_APP_ID \
  --query password \
  --output tsv)

cat << EOF
seal "azurekeyvault" {
  tenant_id      = "$AZURE_TENANT_ID"
  client_id      = "$AZURE_CLIENT_ID"
  client_secret  = "$AZURE_CLIENT_SECRET"
  vault_name     = "$KEYVAULT_NAME"
  key_name       = "$KEY_NAME"
}
EOF
```
