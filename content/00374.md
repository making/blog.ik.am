---
title: Azureã«Cloud Foundry (Diegoã‚ªãƒ³ãƒªãƒ¼æ§‹æˆ)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
tags: ["Azure", "BOSH", "Diego", "Cloud Foundry"]
categories: ["Dev", "PaaS", "CloudFoundry"]
---

Azureã«Cloud Foundryã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚æƒ…å ±ãŒå°‘ãªã„ã®ã§ãƒ¡ãƒ¢ã£ã¦ãŠãã€‚

åŸºæœ¬çš„ã«ã¯[https://github.com/cloudfoundry-incubator/bosh-azure-cpi-release/blob/master/docs/guidance.md](https://github.com/cloudfoundry-incubator/bosh-azure-cpi-release/blob/master/docs/guidance.md)ã®å†…å®¹ã®é€šã‚Šã€‚

### Azureã®è¨­å®š

#### Azure CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

``` console
$ brew cask install azure-cli
```

#### Service Principalã®ä½œæˆ

``` console
$ azure config mode arm
$ azure login
info:    Executing command login
/info:    To sign in, use a web browser to open the page http://aka.ms/devicelogin. Enter the code ****** to authenticate. If you're signing in as an Azure AD application, use the --username and --password parameters.
```

http://aka.ms/devicelogin ã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã€‚

``` console
$ azure account list --json
[
  {
    "id": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",
    "name": "....",
    "user": {
      "name": "...",
      "type": "..."
    },
    "tenantId": "bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb",
    "state": "...",
    "isDefault": true,
    "registeredProviders": [],
    "environmentName": "..."
  }
]
```

`id`ã®å€¤(Subscription ID)ã‚’`azure account set`ã«æ¸¡ã™ã€‚`tenantId`ã¯å¾Œã§ä½¿ç”¨ã™ã‚‹ã®ã§ãƒ¡ãƒ¢ã™ã‚‹ã“ã¨ã€‚

``` console
$ azure account set aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa
```

Azure Active Directory (AAD) ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã€‚

``` console
$ azure ad app create --name "Service Principal for BOSH" --password "changeme" --home-page "http://BOSHAzureCPI" --identifier-uris "http://BOSHAzureCPI"
info:    Executing command ad app create
+ Creating application Service Principal for BOSH                              
data:    Application Id:          cccccccc-cccc-cccc-cccc-cccccccccccc
data:    Application Object Id:   dddddddd-dddd-dddd-dddd-dddddddddddd
data:    Application Permissions:  
data:                             claimValue:  user_impersonation
data:                             description:  Allow the application to access Service Principal for BOSH on behalf of the signed-in user.
data:                             directAccessGrantTypes: 
data:                             displayName:  Access Service Principal for BOSH
data:                             impersonationAccessGrantTypes:  impersonated=User, impersonator=Application
data:                             isDisabled: 
data:                             origin:  Application
data:                             permissionId:  eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee
data:                             resourceScopeType:  Personal
data:                             userConsentDescription:  Allow the application to access Service Principal for BOSH on your behalf.
data:                             userConsentDisplayName:  Access Service Principal for BOSH
data:                             lang: 
info:    ad app create command OK
```

`Application Id`ã‚’`azure ad sp create`ã«æ¸¡ã—ã¦Service Principalã‚’ä½œæˆã™ã‚‹ã€‚`Application Id`ã¯`clientId`ã¨ã—ã¦ã€å¾Œã§ä½¿ç”¨ã™ã‚‹ã®ã§ãƒ¡ãƒ¢ã™ã‚‹ã“ã¨ã€‚

``` console
$ azure ad sp create cccccccc-cccc-cccc-cccc-cccccccccccc
info:    Executing command ad sp create
+ Creating service principal for application cccccccc-cccc-cccc-cccc-cccccccccccc
data:    Object Id:               ffffffff-ffff-ffff-ffff-ffffffffffff
data:    Display Name:            Service Principal for BOSH
data:    Service Principal Names:
data:                             cccccccc-cccc-cccc-cccc-cccccccccccc
data:                             http://BOSHAzureCPI
info:    ad sp create command OK
```

Subscription IDã‚’æŒ‡å®šã—ã¦Roleã‚’ã‚¢ã‚µã‚¤ãƒ³ã™ã‚‹ã€‚

``` console
$ azure role assignment create --spn "http://BOSHAzureCPI" -o "Contributor" --subscription aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa
info:    Executing command role assignment create
+ Finding role with specified name                                             
|data:    RoleAssignmentId     : /subscriptions/aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa/providers/Microsoft.Authorization/roleAssignments/00000000-0000-0000-0000-000000000000
data:    RoleDefinitionName   : Contributor
data:    RoleDefinitionId     : 11111111-1111-1111-1111-111111111111
data:    Scope                : /subscriptions/aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa
data:    Display Name         : Service Principal for BOSH
data:    SignInName           :
data:    ObjectId             : ffffffff-ffff-ffff-ffff-ffffffffffff
data:    ObjectType           : ServicePrincipal
data:    
+
info:    role assignment create command OK
```

### BOSHã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€ã¾ãšã¯BOSH Directorã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã®è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œæˆã—ã€ãã“ã‹ã‚‰BOSH Directorã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¾ã§è‡ªå‹•ã§ã‚„ã£ã¦ã‚‚ã‚‰ã†ã€‚

**âš ï¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ–¹æ³•ã¯ã—ã°ã—ã°æ›´æ–°ã•ã‚Œã¦ã„ãã®ã§ã€ã“ã®è¨˜äº‹ã®å†…å®¹é€šã‚Šã«è¡Œãã¨ã¯é™ã‚Šã¾ã›ã‚“âš ï¸**


<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2Fbosh-setup%2Fazuredeploy.json" target="_blank">
    <img src="http://azuredeploy.net/deploybutton.png"/>
</a>

ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ¬¡ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«ã¯ä»¥ä¸‹ã‚’è¨­ç½®ã™ã‚‹ã€‚ä¸‹è¨˜ã®å€¤ã¯ä¾‹ã€‚

``` console
VMNAME (string) bosh
ADMINUSERNAME (string) making
SSHKEYDATA (string) ~/.ssh/id_rsa.pubã®å†…å®¹
TENANTID (string) bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb
CLIENTID (string) cccccccc-cccc-cccc-cccc-cccccccccccc
CLIENTSECRET (securestring) changeme
AUTODEPLOYBOSH (string) true
```

ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—`azure-cf`(æ±æ—¥æœ¬)ã‚’ä½œæˆã—ã¦è¨­å®šã€‚

ã—ã°ã‚‰ãå¾…ã¤ï¼ˆ1æ™‚é–“ãã‚‰ã„ï¼‰ã€‚

<img src="https://qiita-image-store.s3.amazonaws.com/0/1852/ac7ba6ec-c84f-6a16-99fe-e3d3f244c583.png">


bosh (director)ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§å®Œäº†ã§ã‚ã‚‹ã€‚1æ™‚é–“ãã‚‰ã„ã‹ã‹ã‚‹ã€‚

<img src="https://qiita-image-store.s3.amazonaws.com/0/1852/62674c6c-076e-e3ff-6a5e-3df2beab6760.png">


ã“ã®æ™‚ç‚¹ã§2ã¤ã®VMãŒã§ãã¦ã„ã‚‹ã€‚`VMNAME`ã§å…¥åŠ›ã—ãŸåå‰ã®VMãŒè¸ã¿å°ã‚µãƒ¼ãƒãƒ¼ã§ã€ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã®æ–¹ãŒBosh Directorã§ã‚ã‚‹ã€‚

[BOSH Components](http://bosh.io/docs/bosh-components.html)ã®å›³ã§è¨€ã†ã¨ã€æ¬¡ã®å›³ã®2ã¤ã®èµ¤æ ã«ç›¸å½“ã™ã‚‹VMãŒã§ãã¦ã„ã‚‹ã€‚

![bosh-architecture.png](https://qiita-image-store.s3.amazonaws.com/0/1852/d4fa7f8e-8988-e8d6-1bfa-93a3bc3b2c58.png)

è¸ã¿å°ã®æ–¹ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦BOSH Directorã‚’BOSH CLIã§æ“ä½œã—ã¦ã€å³å´ã®VMç¾¤(ã“ã“ã§ã¯Cloud Foundryã®Runtime)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã«ãªã‚‹ã€‚

ã§ã¯è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼ã«sshã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨`~/.ssh/id_rsa.pub`ã¨å¯¾ã®ç§˜å¯†éµ(`~/.ssh/id_rsa`)ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã€‚IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å‚ç…§ã€‚

<img src="https://qiita-image-store.s3.amazonaws.com/0/1852/dee7c52b-6f6b-73e0-bed7-16b37aa45cbb.png">



ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚[`deploy_bosh.sh`](https://github.com/Azure/azure-quickstart-templates/blob/master/bosh-setup/scripts/deploy_bosh.sh)ã§Bosh Directorã¯ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ãªã®ã§ã€æ®‹ã‚‹ã¯CLIã‚’ä½¿ã£ã¦Cloud Foundryã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã®ã¿ã€‚[`deploy_cloudfoundry.sh`](https://github.com/Azure/azure-quickstart-templates/blob/master/bosh-setup/scripts/deploy_cloudfoundry.sh)ã‚‚ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã€‚

``` console
making@bosh:~$ ll
total 6908
drwxr-xr-x 6 making making    4096 Sep 14 11:37 ./
drwxr-xr-x 3 root   root      4096 Sep 14 10:00 ../
-rw-r--r-- 1 making making     220 Apr  9  2014 .bash_logout
-rw-r--r-- 1 making making    3637 Apr  9  2014 .bashrc
-r-------- 1 making root      1675 Sep 14 10:04 bosh
-rw------- 1 making making     350 Sep 14 10:43 .bosh_config
-rw-r--r-- 1 making root        23 Sep 14 10:04 BOSH_DIRECTOR_ADMIN_PASSWORD
drwxrwxr-x 4 making making    4096 Sep 14 10:07 .bosh_init/
-rw-r--r-- 1 making root       382 Sep 14 10:04 bosh.pub
-rw-rw-r-- 1 making making    1386 Sep 14 10:43 bosh-state.json
-rw-r--r-- 1 making root      4385 Sep 14 10:04 bosh.yml
drwx------ 2 making making    4096 Sep 14 11:37 .cache/
-rw-r--r-- 1 making root   4009884 Sep 14 10:04 cf-cli-installer_6.14.1_x86-64.deb
-rwxr-xr-x 1 making root       427 Sep 14 10:04 deploy_bosh.sh*
-rwxr-xr-x 1 making root      1445 Sep 14 10:04 deploy_cloudfoundry.sh*
drwxr-xr-x 2 making root      4096 Sep 14 10:43 example_manifests/
-rw-r--r-- 1 making root     88794 Sep 14 10:43 install.log
-rw-r--r-- 1 making making     675 Apr  9  2014 .profile
-rw-rw-r-- 1 making making 2887560 Sep 14 10:43 run.log
-rw-r--r-- 1 making root      2452 Sep 14 10:04 settings
drwx------ 2 making making    4096 Sep 14 10:00 .ssh/
```

### Cloud Foundryã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

Bosh CLIã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã€Bosh Directorã«ã‚‚ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã«ãªã£ã¦ã„ã‚‹ã€‚

``` console
making@bosh:~$ bosh target
Current target is https://10.0.0.4:25555 (bosh)
```

[`deploy_cloudfoundry.sh`](https://github.com/Azure/azure-quickstart-templates/blob/master/bosh-setup/scripts/deploy_cloudfoundry.sh)ã®ä¸­ã§Cloud Foundryã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦ãªã“ã¨ã‚’ã‚„ã£ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ã€å®Ÿè¡Œã™ã‚‹ã ã‘ã€‚å®Ÿè¡Œæ™‚ã«manifestãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€ã“ã‚Œã‚‚`example_manifests`ãƒ•ã‚©ãƒ«ãƒ€å†…ã«ã‚·ãƒ³ã‚°ãƒ«VMç”¨ã¨ãƒãƒ«ãƒVMç”¨ãã‚Œãã‚Œç”¨æ„ã—ã¦ã‚ã‚‹ã€‚


ã“ã“ã§ã¯ç·´ç¿’ç”¨ã«ã§ãã‚‹ã ã‘æœ¬ç•ªã«è¿‘ã„ãƒãƒ«ãƒVMç”¨ã®manifestã‚’åˆ©ç”¨ã™ã‚‹ã€‚

``` console
$ ./deploy_cloudfoundry.sh example_manifests/multiple-vm-cf.yml 
```

å¯ç”¨æ€§ã¯ä¸è¦ã§1 VMã§ã¨ã«ã‹ãCloud Foundry on Azureã‚’è©¦ã—ãŸã„å ´åˆã¯ã€ã‚·ãƒ³ã‚°ãƒ«VMç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ã†ã¨è‰¯ã„ã€‚ãã®å ´åˆã¯æ¬¡

``` console
$ ./deploy_cloudfoundry.sh example_manifests/single-vm-cf.yml
```

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹å«ã‚ã‚‹ã¨ã«20å€‹ã»ã©VMã‚’ã¤ãã‚‹ã“ã¨ã«ãªã‚‹ãŸã‚ã€ã‚µãƒãƒ¼ãƒˆã«å•ã„åˆã‚ã›ã¦åˆ¶é™ã‚’30-50å€‹ãã‚‰ã„ã«ä¸Šã’ã¦ã‚‚ã‚‰ã†ã®ãŒã‚ˆã„ã€‚
ãƒãƒ¼ã‚¿ãƒ«ã‹ã‚‰ã€Œãƒ˜ãƒ«ãƒ—ã¨ã‚µãƒãƒ¼ãƒˆã€â†’ã€Œæ–°ã—ã„ã‚µãƒãƒ¼ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã€‚è‡ªåˆ†ã®å ´åˆã¯1æ—¥ãã‚‰ã„ã‹ã‹ã£ãŸã®ã§ã€æ—©ã‚ã«ã‚„ã£ã¦ãŠãã¨è‰¯ã„ã€‚

![image](https://qiita-image-store.s3.amazonaws.com/0/1852/1f23c0e8-b87a-be50-b6ef-9be78fc6bc05.png)



ãƒ‡ãƒ—ãƒ­ã‚¤ãŒçµ‚ã‚ã£ãŸã‚‰(1æ™‚é–“ãã‚‰ã„)ã€`bosh vms`ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸVMã‚’ç¢ºèªã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ãªçµæœã«ãªã‚‹ã¯ãšã€‚cellãªã©Diegoã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å«ã‚€17VMsã€‚ãƒ­ã‚°ã¯[ã“ã¡ã‚‰](https://gist.github.com/making/0ce7a46d0e9fa1bdcacec6ea624f3084)ã€‚

``` console
$ bosh vms
Acting as user 'admin' on 'bosh'
Deployment `multiple-cf-on-azure'

Director task 14

Task 14 done

+---------------------------------------------------------------------------+---------+-----+-------------+---------------+
| VM                                                                        | State   | AZ  | VM Type     | IPs           |
+---------------------------------------------------------------------------+---------+-----+-------------+---------------+
| access_z1/0 (74a1ab9d-32c9-46aa-9903-1430ed474249)                        | running | n/a | resource_z1 | 10.0.16.109   |
| api_z1/0 (47cffc4f-e68f-450f-ad55-e016b3ec7e01)                           | running | n/a | resource_z1 | 10.0.16.102   |
| brain_z1/0 (6a0ed991-b9ad-4743-b5c6-60eef37c1a51)                         | running | n/a | resource_z1 | 10.0.16.106   |
| cc_bridge_z1/0 (7001782d-97d4-48e0-a288-b49fe99e907e)                     | running | n/a | resource_z1 | 10.0.16.108   |
| cell_z1/0 (46f83357-a890-463d-9f34-ff6e37082a32)                          | running | n/a | resource_z1 | 10.0.16.107   |
| consul_z1/0 (eb86b16c-aee0-4711-8a4d-c1046e666d43)                        | running | n/a | resource_z1 | 10.0.16.16    |
| database_z1/0 (e42d51b8-2509-4aa6-a5de-c26ff161746c)                      | running | n/a | resource_z1 | 10.0.16.105   |
| doppler_z1/0 (facd13de-9e7e-4919-a21f-f8c25dcb76e0)                       | running | n/a | resource_z1 | 10.0.16.103   |
| etcd_z1/0 (0b0d0610-35e9-4a18-8861-3e5bd6c2bbb8)                          | running | n/a | resource_z1 | 10.0.16.14    |
| ha_proxy_z1/0 (b0e54bf1-20e8-4861-8ec6-3897a5e04177)                      | running | n/a | resource_z1 | 10.0.16.4     |
|                                                                           |         |     |             | 13.78.121.100 |
| loggregator_trafficcontroller_z1/0 (89e9789a-cf8d-481c-b4bd-e71de58947a3) | running | n/a | resource_z1 | 10.0.16.104   |
| nats_z1/0 (f7bfc395-4168-41ac-b40c-61810927baff)                          | running | n/a | resource_z1 | 10.0.16.13    |
| nfs_z1/0 (ab811af8-9e12-4f03-bede-cb6488ab13be)                           | running | n/a | resource_z1 | 10.0.16.15    |
| postgres_z1/0 (e0da4072-bff1-42a5-b6db-2d4e6876810a)                      | running | n/a | resource_z1 | 10.0.16.11    |
| route_emitter_z1/0 (dff8bc35-5020-4c62-a3b9-387d719e2546)                 | running | n/a | resource_z1 | 10.0.16.110   |
| router_z1/0 (50ec2d18-6971-49d2-bd14-d2b6946b18f0)                        | running | n/a | resource_z1 | 10.0.16.12    |
| uaa_z1/0 (f04a9a3d-3b70-4fbc-b52d-979f9064d905)                           | running | n/a | resource_z1 | 10.0.16.101   |
+---------------------------------------------------------------------------+---------+-----+-------------+---------------+

VMs total: 17
```

<img src="https://qiita-image-store.s3.amazonaws.com/0/1852/171df962-30bc-bded-5e99-a1c0cf1b8cd9.png" width="80%">

ã“ã®ã¾ã¾ã ã¨ã©ã‚ŒãŒã©ã®VMã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã€åˆ—ã®é¸æŠã§æ¬¡ã®é …ç›®ã‚’é¸æŠã™ã‚‹ã¨è‰¯ã„ã€‚

<img src="https://qiita-image-store.s3.amazonaws.com/0/1852/c6c6de44-b773-f454-10c3-2b6c71a69f59.png">

JOBåˆ—ãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®åå‰ã€‚

<img src="https://qiita-image-store.s3.amazonaws.com/0/1852/9c9df9df-778c-6368-e3ee-9a629785b68d.png" width="80%">


HA Proxyã«ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã€‚manifestãƒ•ã‚¡ã‚¤ãƒ«ã‚’grepã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«API URLã¨adminãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‹ã‚‹ã€‚

``` bash
$ grep api example_manifests/multiple-vm-cf.yml 
- name: api_z1
      - name: api
        - "api.13.78.121.100.xip.io"
      api: api.13.78.121.100.xip.io
      api: api.13.78.121.100.xip.io
      api: api.13.78.121.100.xip.io
    bulk_api_password: c1oudc0w
    internal_api_password: c1oudc0w
    srv_api_uri: https://api.13.78.121.100.xip.io
    external_host: api
      02aN4KfOuGUiC3ivjaY3RrhcvybWGNhp8PK+hUYWnN8e6lyPDTo6kSgtapiSfCa3
  capi:
        base_url: https://api.13.78.121.100.xip.io
        base_url: https://api.13.78.121.100.xip.io
        base_url: https://api.13.78.121.100.xip.io
        base_url: https://api.13.78.121.100.xip.io
```

å¾Œã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã§`cf login`ã§ãã‚‹ ğŸ™Œ

``` bash
$ cf login -a https://api.13.78.121.100.xip.io --skip-ssl-validation -u admin -p c1oudc0w
$ cf create-space demo
$ cf target -s demo
$ cd /tmp
$ git clone https://github.com/making/hacker-tackle-demo.git
$ cd hacker-tackle-demo/hacker-tackle
$ cf push
$ curl -i hacker-tackle.13.78.121.100.xip.io
HTTP/1.1 200 OK
Content-Length: 1234
Content-Type: text/plain; charset=utf-8
Date: Wed, 14 Sep 2016 13:56:15 GMT
X-Vcap-Request-Id: 804a5469-de4d-4c2d-7e91-e850acf04926

0ï¸âƒ£   0ï¸âƒ£   0ï¸âƒ£ 0ï¸âƒ£     0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£  0ï¸âƒ£    0ï¸âƒ£  0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£   0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£   
0ï¸âƒ£   0ï¸âƒ£  0ï¸âƒ£   0ï¸âƒ£   0ï¸âƒ£       0ï¸âƒ£   0ï¸âƒ£   0ï¸âƒ£       0ï¸âƒ£    0ï¸âƒ£  
0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£  0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£   0ï¸âƒ£       0ï¸âƒ£ 0ï¸âƒ£     0ï¸âƒ£ 0ï¸âƒ£     0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£  
0ï¸âƒ£   0ï¸âƒ£  0ï¸âƒ£    0ï¸âƒ£  0ï¸âƒ£       0ï¸âƒ£   0ï¸âƒ£   0ï¸âƒ£       0ï¸âƒ£    0ï¸âƒ£  
0ï¸âƒ£   0ï¸âƒ£  0ï¸âƒ£    0ï¸âƒ£   0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£  0ï¸âƒ£    0ï¸âƒ£  0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£   0ï¸âƒ£    0ï¸âƒ£  
                                                 
0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£   0ï¸âƒ£ 0ï¸âƒ£     0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£  0ï¸âƒ£    0ï¸âƒ£  0ï¸âƒ£       0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£  
   0ï¸âƒ£     0ï¸âƒ£   0ï¸âƒ£   0ï¸âƒ£       0ï¸âƒ£   0ï¸âƒ£   0ï¸âƒ£       0ï¸âƒ£ 
   0ï¸âƒ£     0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£   0ï¸âƒ£       0ï¸âƒ£ 0ï¸âƒ£     0ï¸âƒ£       0ï¸âƒ£ 0ï¸âƒ£    
   0ï¸âƒ£     0ï¸âƒ£    0ï¸âƒ£  0ï¸âƒ£       0ï¸âƒ£   0ï¸âƒ£   0ï¸âƒ£       0ï¸âƒ£  
   0ï¸âƒ£     0ï¸âƒ£    0ï¸âƒ£   0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£  0ï¸âƒ£    0ï¸âƒ£  0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£   0ï¸âƒ£ 0ï¸âƒ£ 0ï¸âƒ£  
```

xip.ioã¯ã‚ˆããƒ€ã‚¦ãƒ³ã™ã‚‹ãŸã‚`curl: (6) Could not resolve host: xxx.13.78.121.100.xip.io`ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰ã€ä½•åº¦ã‹ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹ã¨è‰¯ã„ã€‚

è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã§cf-release [v238](https://github.com/cloudfoundry/cf-release/releases/tag/v238) (API version: 2.57.0)ãŒä½¿ãˆã‚‹ã€‚

ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯[ã“ã®è¨˜äº‹](/entries/361)ã¨åŒã˜è¦é ˜ã§OKã€‚


ã¡ãªã¿ã«ã‚·ãƒ³ã‚°ãƒ«VMã®manifestã‚’ä½¿ã£ãŸå ´åˆã¯ã“ã‚“ãªæ„Ÿã˜

``` console
$ bosh vms
Acting as user 'admin' on 'bosh'
Deployment `single-vm-cf-on-azure'

Director task 72

Task 72 done

+------------------------------------------------+---------+-----+-------------+---------------+
| VM                                             | State   | AZ  | VM Type     | IPs           |
+------------------------------------------------+---------+-----+-------------+---------------+
| cf_z1/0 (5662378e-b48c-4ee9-9ac0-f68dfea9d04a) | running | n/a | resource_z1 | 10.0.16.4     |
|                                                |         |     |             | 13.78.121.100 |
+------------------------------------------------+---------+-----+-------------+---------------+

VMs total: 1
```

<img src="https://qiita-image-store.s3.amazonaws.com/0/1852/60b18eac-1662-d390-0515-8667c0758651.png" width="80%" />


### ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ã†

xip.ioã¯æµçŸ³ã«ãªã„ã®ã§ã€ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ã†æ–¹æ³•ã‚‚ç´¹ä»‹ã™ã‚‹ã€‚åŸºæœ¬çš„ã«ã¯`*.ãƒ‰ãƒ¡ã‚¤ãƒ³å`ã‚’ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã«å‘ã‘ã‚Œã°è‰¯ã„ã€‚

æ¬¡ã®å›³ã¯CloudFlareã®DNSã«`*.azurecf.ik.am`ã‚’è¨­å®šã™ã‚‹ä¾‹ã€‚

<img width="80%" src="https://qiita-image-store.s3.amazonaws.com/0/1852/8d3a5cbf-5e9f-e2d4-4bf6-1d64467a1db3.png">

`~/example_manifests/multiple-vm-cf.yml `ä¸­ã®`13.78.121.100.xip.io`ã‚’`azurecf.ik.am`ã«ç½®æ›ã—ã¦`bosh -n deploy`ã€‚

ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒå®Œäº†ã—ãŸã‚‰`cf login -a https://api.azurecf.ik.am --skip-ssl-validation -u admin -p c1oudc0w`ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

----

ãã®ä»–ã€.NETã‚’ä½¿ã†æ–¹æ³•ã‚„MySQLã€MongoDBã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã‚’ä½¿ã†æ–¹æ³•ã€Azureã®ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã¨é€£æºã™ã‚‹æ–¹æ³•ãªã©ã¯[ã“ã¡ã‚‰](https://github.com/cloudfoundry-incubator/bosh-azure-cpi-release/tree/master/docs#3-advanced-configurations-and-deployments)ã‚’å‚ç…§ã€‚

ä»Šå›ã¯å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒ1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãšã¤ã¨ã€å†—é•·æ§‹æˆã«ãªã£ã¦ã„ãªã„ã®ã§æ³¨æ„ã€‚Hi-Availabilityã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ¯ã«[ã“ã®ãã‚‰ã„](http://docs.pivotal.io/pivotalcf/concepts/high-availability.html)ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ãŒå¿…è¦ã€‚cellã¯3ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€routerã¯2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã»ã—ã„ã€‚

ã¾ãŸã“ã®æ§‹æˆã ã¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼(HA Proxy)ãŒãƒãƒƒã‚¯ã€‚Azure Load Balancerã¯L7ã«å¯¾å¿œã—ã¦ã„ãªã„ã®ã§ã€ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã‚’å†—é•·åŒ–ã™ã‚‹ã«ã¯
[Azure Load Balancer + multiple HA Proxy](https://github.com/cloudfoundry-incubator/bosh-azure-cpi-release/blob/master/docs/advanced/deploy-multiple-haproxy)ã«ã—ãªã„ã¨ã„ã‘ãªã„æ¨¡æ§˜ã€‚

