---
title: llama.cppを使いOpenAI APIでPLaMo翻訳モデルを使う
tags: ["llama.cpp", "OpenAI", "PLaMo"]
categories: ["AI", "LLM", "llama.cpp"]
---


llama.cppで[PLaMo翻訳モデル](https://huggingface.co/pfnet/plamo-2-translate)を使うメモ。

### llama-cppのインストール

```
brew install llama.cpp
```

次のバージョンで試します。

```bash
$ llama-server --version
ggml_metal_device_init: tensor API disabled for pre-M5 and pre-A19 devices
ggml_metal_library_init: using embedded metal library
ggml_metal_library_init: loaded in 0.007 sec
ggml_metal_rsets_init: creating a residency set collection (keep_alive = 180 s)
ggml_metal_device_init: GPU name:   Apple M4 Max
ggml_metal_device_init: GPU family: MTLGPUFamilyApple9  (1009)
ggml_metal_device_init: GPU family: MTLGPUFamilyCommon3 (3003)
ggml_metal_device_init: GPU family: MTLGPUFamilyMetal3  (5001)
ggml_metal_device_init: simdgroup reduction   = true
ggml_metal_device_init: simdgroup matrix mul. = true
ggml_metal_device_init: has unified memory    = true
ggml_metal_device_init: has bfloat            = true
ggml_metal_device_init: has tensor            = false
ggml_metal_device_init: use residency sets    = true
ggml_metal_device_init: use shared buffers    = true
ggml_metal_device_init: recommendedMaxWorkingSetSize  = 103079.22 MB
version: 7490 (5182dd64c)
built with AppleClang 17.0.0.17000404 for Darwin arm64
```


### OpenAI API Serverの起動

[GGUF形式のPLaMo翻訳モデル](https://huggingface.co/mmnga/plamo-2-translate-gguf)を使ってllama.cppでOpenAI API Serverを起動します。

```bash
llama-server -hf mmnga/plamo-2-translate-gguf --alias plamo2-translate --port 8000
```


```
<|plamo:op|>dataset
translation
<|plamo:op|>input lang=Japanese

ここに翻訳対象のテキストを書きます

<|plamo:op|>output lang=English
```


```bash
curl -X POST http://127.0.0.1:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "plamo2-translate",
    "messages": [
      {
        "role": "user",
        "content": "<|plamo:op|>dataset\ntranslation\n<|plamo:op|>input lang=Japanese\n家計は火の車だ。毎月の支払いに追われ、貯金を切り崩す日々が続いている。\n<|plamo:op|>output lang=English"
      }
    ]
  }'
```


```json
{
  "choices": [
    {
      "finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Our household finances are in a mess. We're constantly being chased by monthly bills and have to keep dipping into our savings.\n"
      }
    }
  ],
  "created": 1766412843,
  "model": "plamo2-translate",
  "system_fingerprint": "b7490-5182dd64c",
  "object": "chat.completion",
  "usage": {
    "completion_tokens": 23,
    "prompt_tokens": 41,
    "total_tokens": 64
  },
  "id": "chatcmpl-IksvG1y16PKmmILVu1IFECqIk6pQJkgf",
  "timings": {
    "cache_n": 0,
    "prompt_n": 41,
    "prompt_ms": 15.982,
    "prompt_per_token_ms": 0.38980487804878045,
    "prompt_per_second": 2565.3860593167315,
    "predicted_n": 23,
    "predicted_ms": 563.22,
    "predicted_per_token_ms": 24.487826086956524,
    "predicted_per_second": 40.83661801782607
  }
}
```


```bash
curl -X POST http://127.0.0.1:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "plamo2-translate",
    "messages": [
      {
        "role": "user",
        "content": "<|plamo:op|>dataset\ntranslation\n<|plamo:op|>input lang=English\nOur household finances are in a mess. We''re constantly being chased by monthly bills and have to keep dipping into our savings.\n<|plamo:op|>output lang=Japanese"
      }
    ]
  }'
```


```json
{
  "choices": [
    {
      "finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "私たちの家計はめちゃくちゃだ。毎月の支払いに追われてばかりで、貯金を切り崩さなければならない状態が続いている。\n"
      }
    }
  ],
  "created": 1766412917,
  "model": "plamo2-translate",
  "system_fingerprint": "b7490-5182dd64c",
  "object": "chat.completion",
  "usage": {
    "completion_tokens": 20,
    "prompt_tokens": 46,
    "total_tokens": 66
  },
  "id": "chatcmpl-SZQLJKG4azv7woIIYzUTWyjc1DaUnbgZ",
  "timings": {
    "cache_n": 0,
    "prompt_n": 46,
    "prompt_ms": 10.012,
    "prompt_per_token_ms": 0.21765217391304348,
    "prompt_per_second": 4594.486616060727,
    "predicted_n": 20,
    "predicted_ms": 495.466,
    "predicted_per_token_ms": 24.7733,
    "predicted_per_second": 40.36603924386335
  }
}
```

`/tmp/ja2en.jinja `

```jinja
<|plamo:op|>dataset translation
<|plamo:op|>input lang=Japanese
{% for message in messages %}
{% if message.role == 'user' %}{{ message.content }}{% endif %}
{% endfor %}
<|plamo:op|>output lang=English
```

```bash
llama-server -hf mmnga/plamo-2-translate-gguf --alias plamo2-translate --port 8000 --chat-template-file /tmp/ja2en.jinja
```

```bash
curl -X POST http://127.0.0.1:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "plamo2-translate",
    "messages": [
      {
        "role": "user",
        "content": "家計は火の車だ。毎月の支払いに追われ、貯金を切り崩す日々が続いている。"
      }
    ]
  }'
```

---

まとめ