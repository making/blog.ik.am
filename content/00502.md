---
title: Spring WebFlux.fnãƒãƒ³ã‚ºã‚ªãƒ³ - 3. YAVIã«ã‚ˆã‚‹Validationã®å®Ÿè£…
tags: ["Spring WebFlux.fn Handson", "Reactor", "Reactor Netty", "Netty", "Spring 5", "Spring WebFlux", "Java", "Cloud Foundry", "Pivotal Web Services", "Pivotal Cloud Foundry", "YAVI"]
categories: ["Programming", "Java", "org", "springframework", "web", "reactive"]
updated: 1970-01-01T09:00:00+09:00
---

æœ¬ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã€æ¬¡ã®å›³ã®ã‚ˆã†ãªç°¡æ˜“å®¶è¨ˆç°¿ã®APIã‚µãƒ¼ãƒãƒ¼ã‚’Spring WebFlux.fnã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¾ã™ã€‚
ã‚ãˆã¦Spring Bootã‚‚Dependency Injectionã‚‚ä½¿ã‚ãªã„ã‚·ãƒ³ãƒ—ãƒ«ãªWebã‚¢ãƒ—ãƒªã¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚

**ãƒãƒ³ã‚ºã‚ªãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„**

1. [ã¯ã˜ã‚ã«](/entries/500)
1. [ç°¡æ˜“å®¶è¨ˆç°¿Moneygerãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ](/entries/501)
1. [YAVIã«ã‚ˆã‚‹Validationã®å®Ÿè£…](/entries/502) ğŸ‘ˆ
1. [R2DBCã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹](/entries/503)
1. [Web UIã®è¿½åŠ ](/entries/504)
1. [ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„](/entries/505)
1. [åå…¥APIã®å®Ÿè£…](/entries/506)


### YAVIã«ã‚ˆã‚‹Validationã®å®Ÿè£…

æ¬¡ã¯Validationã‚’å®Ÿè£…ã—ã¾ã™ã€‚ä»Šå›ã¯Bean Validationã§ã¯ãªãã€Spring WebFlux.fnã«ã‚ˆã‚ŠFitã—ãŸä½¿ã„æ–¹ãŒã§ãã‚‹[YAVI](https://github.com/making/yavi)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚


**TODOéƒ¨åˆ†ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„**ã€‚å‹•ä½œã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã«ç¶šãã¾ã™ã€‚TODOã‚’å®Ÿè£…ã™ã‚‹å‰ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã„ã€‚

* [å‚è€ƒè³‡æ–™](https://github.com/making/yavi)

```java
package com.example.expenditure;

import am.ik.yavi.builder.ValidatorBuilder;
import am.ik.yavi.core.ConstraintViolations;
import am.ik.yavi.core.Validator;
import am.ik.yavi.fn.Either;
import com.fasterxml.jackson.databind.annotation.JsonDeserialize;

import java.time.LocalDate;

@JsonDeserialize(builder = ExpenditureBuilder.class)
public class Expenditure {

    private final Integer expenditureId;

    private final String expenditureName;

    private final int unitPrice;

    private final int quantity;

    private final LocalDate expenditureDate;

    // è¿½åŠ 
    private static Validator<Expenditure> validator = ValidatorBuilder.of(Expenditure.class)
        .constraint(Expenditure::getExpenditureId, "expenditureId", c -> c.isNull())
        // TODO
        // "expenditureName"ã¯ç©ºã§ã¯ãªãã€æ–‡å­—æ•°ã¯255ä»¥ä¸‹
        // "unitPrice"ã¯0ã‚ˆã‚Šå¤§ãã„
        // "quantity"ã¯0ã‚ˆã‚Šå¤§ãã„
        // .constraint(...)
        .constraintOnObject(Expenditure::getExpenditureDate, "expenditureDate", c -> c.notNull())
        .build();

    Expenditure(Integer expenditureId, String expenditureName, int unitPrice, int quantity, LocalDate expenditureDate) {
        this.expenditureId = expenditureId;
        this.expenditureName = expenditureName;
        this.unitPrice = unitPrice;
        this.quantity = quantity;
        this.expenditureDate = expenditureDate;
    }

    public Integer getExpenditureId() {
        return expenditureId;
    }


    public String getExpenditureName() {
        return expenditureName;
    }


    public int getUnitPrice() {
        return unitPrice;
    }


    public int getQuantity() {
        return quantity;
    }


    public LocalDate getExpenditureDate() {
        return expenditureDate;
    }


    // è¿½åŠ 
    public Either<ConstraintViolations, Expenditure> validate() {
        return validator.validateToEither(this);
    }

    @Override
    public String toString() {
        return "Expenditure{" +
            "expenditureId=" + expenditureId +
            ", expenditureName='" + expenditureName + '\'' +
            ", unitPrice=" + unitPrice +
            ", quantity=" + quantity +
            ", expenditureDate=" + expenditureDate +
            '}';
    }
}
```

æ¬¡ã«ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã®Javaã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
`com.example.error`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œã£ã¦`ErrorResponse.java`ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚


```java
package com.example.error;

import com.fasterxml.jackson.annotation.JsonInclude;

import java.util.List;
import java.util.Map;

public class ErrorResponse {

    private final int status;

    private final String error;

    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    private final String message;

    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    private final Map<String, List<String>> details;

    public ErrorResponse(int status, String error, String message, Map<String, List<String>> details) {
        this.status = status;
        this.error = error;
        this.message = message;
        this.details = details;
    }

    public int getStatus() {
        return status;
    }

    public String getError() {
        return error;
    }

    public String getMessage() {
        return message;
    }

    public Map<String, List<String>> getDetails() {
        return details;
    }
}
```

ç¶šã„ã¦`ErrorResponseBuilder.java`ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```java
package com.example.error;

import am.ik.yavi.core.ConstraintViolations;
import org.springframework.http.HttpStatus;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;

import java.util.Collections;
import java.util.List;
import java.util.Map;

public class ErrorResponseBuilder {

    private Map<String, List<String>> details;

    private String error;

    private String message;

    private int status;

    public ErrorResponse createErrorResponse() {
        return new ErrorResponse(status, error, message, details);
    }

    public ErrorResponseBuilder withDetails(Map<String, List<String>> details) {
        this.details = details;
        return this;
    }

    public ErrorResponseBuilder withDetails(ConstraintViolations violations) {
        MultiValueMap<String, String> details = new LinkedMultiValueMap<>();
        violations.details().forEach(d -> details.add((String) d.getArgs()[0], d.getDefaultMessage()));
        this.details = Collections.unmodifiableMap(details);
        return this;
    }

    public ErrorResponseBuilder withMessage(String message) {
        this.message = message;
        return this;
    }

    public ErrorResponseBuilder withStatus(HttpStatus status) {
        this.status = status.value();
        this.error = status.getReasonPhrase();
        return this;
    }
}
```

`ExpenditureHandler`ã®`get`ãƒ¡ã‚½ãƒƒãƒ‰ã®æ¬¡ã®éƒ¨åˆ†(`LinkedHashMap`ã§ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ã„ã‚‹ç®‡æ‰€)ã‚’ã€

```java
    Mono<ServerResponse> get(ServerRequest req) {
        return this.expenditureRepository.findById(Integer.valueOf(req.pathVariable("expenditureId")))
            .flatMap(expenditure -> ServerResponse.ok().syncBody(expenditure))
            .switchIfEmpty(Mono.defer(() -> ServerResponse.status(NOT_FOUND).syncBody(new LinkedHashMap<String, Object>() {

                {
                    put("status", 404);
                    put("error", "Not Found");
                    put("message", "The given expenditure is not found.");
                }
            })));
    }
```

æ¬¡ã®ã‚ˆã†ã«`ErrorResponse`ã§ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

```java
    Mono<ServerResponse> get(ServerRequest req) {
        return this.expenditureRepository.findById(Integer.valueOf(req.pathVariable("expenditureId")))
            .flatMap(expenditure -> ServerResponse.ok().syncBody(expenditure))
            .switchIfEmpty(Mono.defer(() -> ServerResponse.status(NOT_FOUND)
                .syncBody(new ErrorResponseBuilder()
                    .withMessage("The given expenditure is not found.")
                    .withStatus(NOT_FOUND)
                    .createErrorResponse())));
    }
```

ã¾ãŸæ¬¡ã®`post`ãƒ¡ã‚½ãƒƒãƒ‰ã«Validationã‚’è¿½åŠ ã—ã¾ã™ã€‚

```java
    Mono<ServerResponse> post(ServerRequest req) {
        return req.bodyToMono(Expenditure.class)
            .flatMap(this.expenditureRepository::save)
            .flatMap(created -> ServerResponse
                .created(UriComponentsBuilder.fromUri(req.uri()).path("/{expenditureId}").build(created.getExpenditureId()))
                .syncBody(created));
    }
```

`post`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```java
    Mono<ServerResponse> post(ServerRequest req) {
        return req.bodyToMono(Expenditure.class)
            .flatMap(expenditure -> expenditure.validate()
                .bimap(v -> new ErrorResponseBuilder().withStatus(BAD_REQUEST).withDetails(v).createErrorResponse(), this.expenditureRepository::save)
                .fold(error -> ServerResponse.badRequest().syncBody(error),
                    result -> result.flatMap(created -> ServerResponse
                        .created(UriComponentsBuilder.fromUri(req.uri()).path("/{expenditureId}").build(created.getExpenditureId()))
                        .syncBody(created))));
    }
```

`ExpenditureHandlerTest`ã®`post_400`ãƒ¡ã‚½ãƒƒãƒ‰ã«ä»˜ã„ã¦ã„ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã€

```java
    // TODO å¾Œã§å®Ÿè£…ã—ã¾ã™
    // @Test
    void post_400() {
      // ...
    }
```

æ¬¡ã®ã‚ˆã†ã«å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

```java
    @Test
    void post_400() {
      // ...
    }
```

TODOã‚’å®Ÿè£…ã—ãªã„ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«`post_400`ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã™ã€‚

![image](https://user-images.githubusercontent.com/106908/58399914-9f70dd80-8094-11e9-8c90-83a3cff22aae.png)


```
java.lang.AssertionError: 
Expecting:
 <2>
to be equal to:
 <5>
but was not.

> POST /expenditures
> Content-Length: [95]
> Content-Type: [application/json]
> WebTestClient-Request-Id: [8]

{"expenditureId":1000,"expenditureName":"","unitPrice":-1,"quantity":-1,"expenditureDate":null}

< 400 BAD_REQUEST Bad Request
< Content-Type: [application/json]
< Content-Length: [158]

{"status":400,"error":"Bad Request","details":{"expenditureId":["\"expenditureId\" must be null"],"expenditureDate":["\"expenditureDate\" must not be null"]}}
```

`Expenditure`ã‚¯ãƒ©ã‚¹ã®TODOã‚’å®Ÿè£…ã—ã¦ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

TODOã®å®Ÿè£…ä¾‹ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

<details>
  <summary><code>Expenditure</code>ã®æ­£è§£ä¾‹</summary>

```java
package com.example.expenditure;

import am.ik.yavi.builder.ValidatorBuilder;
import am.ik.yavi.core.ConstraintViolations;
import am.ik.yavi.core.Validator;
import am.ik.yavi.fn.Either;
import com.fasterxml.jackson.databind.annotation.JsonDeserialize;

import java.time.LocalDate;

@JsonDeserialize(builder = ExpenditureBuilder.class)
public class Expenditure {

    private final Integer expenditureId;

    private final String expenditureName;

    private final int unitPrice;

    private final int quantity;

    private final LocalDate expenditureDate;

    private static Validator<Expenditure> validator = ValidatorBuilder.of(Expenditure.class)
        .constraint(Expenditure::getExpenditureId, "expenditureId", c -> c.isNull())
        .constraint(Expenditure::getExpenditureName, "expenditureName", c -> c.notEmpty().lessThanOrEqual(255))
        .constraint(Expenditure::getUnitPrice, "unitPrice", c -> c.greaterThan(0))
        .constraint(Expenditure::getQuantity, "quantity", c -> c.greaterThan(0))
        .constraintOnObject(Expenditure::getExpenditureDate, "expenditureDate", c -> c.notNull())
        .build();

    Expenditure(Integer expenditureId, String expenditureName, int unitPrice, int quantity, LocalDate expenditureDate) {
        this.expenditureId = expenditureId;
        this.expenditureName = expenditureName;
        this.unitPrice = unitPrice;
        this.quantity = quantity;
        this.expenditureDate = expenditureDate;
    }

    public Integer getExpenditureId() {
        return expenditureId;
    }


    public String getExpenditureName() {
        return expenditureName;
    }


    public int getUnitPrice() {
        return unitPrice;
    }


    public int getQuantity() {
        return quantity;
    }


    public LocalDate getExpenditureDate() {
        return expenditureDate;
    }


    public Either<ConstraintViolations, Expenditure> validate() {
        return validator.validateToEither(this);
    }

    @Override
    public String toString() {
        return "Expenditure{" +
            "expenditureId=" + expenditureId +
            ", expenditureName='" + expenditureName + '\'' +
            ", unitPrice=" + unitPrice +
            ", quantity=" + quantity +
            ", expenditureDate=" + expenditureDate +
            '}';
    }
}
```

</details>

TODOã‚’å®Ÿè£…ã—ã¦ã€å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸã‚‰ã€`App`ã‚¯ãƒ©ã‚¹ã®`main`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã€æ­£ã—ããƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ curl localhost:8080/expenditures -d "{\"expenditureId\":1000,\"expenditureName\":\"\",\"unitPrice\":-1,\"quantity\":-1,\"expenditureDate\":null}" -H "Content-Type: application/json"
{"status":400,"error":"Bad Request","details":{"expenditureId":["\"expenditureId\" must be null"],"expenditureName":["\"expenditureName\" must not be empty"],"unitPrice":["\"unitPrice\" must be greater than 0"],"quantity":["\"quantity\" must be greater than 0"],"expenditureDate":["\"expenditureDate\" must not be null"]}}
```

