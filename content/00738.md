---
title: Tanzu Application Platform 1.5 (Iterate Profile) をKindにインストールするメモ
tags: ["Kubernetes", "Cartographer", "kind", "Tanzu", "TAP"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP"]
---


[Tanzu Application Platform 1.5](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/overview.html) をKindにインストールします。

Intel版のMacで試しています。

本記事ではTAPをInstallし、"Hello World"なアプリケーションをソースコードからデプロイする機能("Source to URL")を試します。


公式ドキュメントはこちら<br>
https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/install.html

---

**目次**
<!-- toc -->

### Kindクラスタの作成

Dockerには5 CPU, 8 GBメモリ以上を割り当ててください。

```
cat <<EOF > kind-expose-port.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 80
    hostPort: 80
    listenAddress: "0.0.0.0"
  - containerPort: 443
    hostPort: 443
    listenAddress: "0.0.0.0"
EOF
kind create cluster --config kind-expose-port.yaml --image kindest/node:v1.26.3
```

### Pivnet CLIのインストール

ここでは [`pivnet`](https://github.com/pivotal-cf/pivnet-cli) CLIを使用して必要なソフトウェアをダウンロードします。
`pivnet` CLIはbrewでインストールできます。

```
brew install pivotal/tap/pivnet-cli
```

[VMware Tanzu Network](https://network.tanzu.vmware.com/) のAPI Tokenを取得して、`pivnet` CLIでログインします。

```
pivnet login --api-token=<API Token>
```

### EULAの承諾

初めてインストールする場合は、以下のコンポーネントのEULAをAcceptしてください。

* [Tanzu Application Platform](https://network.tanzu.vmware.com/products/tanzu-application-platform/)
* [Cluster Essentials for VMware Tanzu](https://network.tanzu.vmware.com/products/tanzu-cluster-essentials/)

> ⚠️ EULAで定められている使用期間は30日間です。とは言え、特にソフトウェア的に制限がかけられているわけではありません。


### Tanzu CLIのインストール

```
# For Mac
pivnet download-product-files --product-slug='tanzu-application-platform' --release-version='1.5.0' --glob='tanzu-framework-darwin-amd64-*.tar'
# For Linux
pivnet download-product-files --product-slug='tanzu-application-platform' --release-version='1.5.0' --glob='tanzu-framework-linux-amd64-*.tar'
# For Windows
pivnet download-product-files --product-slug='tanzu-application-platform' --release-version='1.5.0' --glob='tanzu-framework-windows-amd64-*.zip'
```

```
tar xvf tanzu-framework-*-amd64-*.tar
install cli/core/v0.28.1/tanzu-core-*_amd64 /usr/local/bin/tanzu
export TANZU_CLI_NO_INIT=true
```

```
$ tanzu version
version: v0.28.1
buildDate: 2023-03-07
sha: 0e6704777-dirty
```

プラグインのインストール

```
tanzu plugin clean
tanzu plugin install --local cli all
```

### Cluster Essentials for VMware Tanzuのインストール

TAPのインストールに必要なKapp ControllerとSecretgen Controllerをデプロイするために [Cluster Essentials for VMware Tanzu](https://network.tanzu.vmware.com/products/tanzu-cluster-essentials) をインストールします。

```
# Mac
pivnet download-product-files --product-slug='tanzu-cluster-essentials' --release-version='1.5.0' --glob='tanzu-cluster-essentials-darwin-amd64-*'
# Linux
pivnet download-product-files --product-slug='tanzu-cluster-essentials' --release-version='1.5.0' --glob='tanzu-cluster-essentials-linux-amd64-*'
```

```yaml
TANZUNET_USERNAME=...
TANZUNET_PASSWORD=...

mkdir tanzu-cluster-essentials
tar xzvf tanzu-cluster-essentials-*-amd64-*.tgz -C tanzu-cluster-essentials

export INSTALL_BUNDLE=registry.tanzu.vmware.com/tanzu-cluster-essentials/cluster-essentials-bundle:1.5.0
export INSTALL_REGISTRY_HOSTNAME=registry.tanzu.vmware.com
export INSTALL_REGISTRY_USERNAME=${TANZUNET_USERNAME}
export INSTALL_REGISTRY_PASSWORD=${TANZUNET_PASSWORD}
cd tanzu-cluster-essentials
./install.sh --yes
cd ..
```

```
$ kubectl get pod -n kapp-controller
NAME                               READY   STATUS    RESTARTS   AGE
kapp-controller-589c94578d-gtzzh   2/2     Running   0          54s

$ kubectl get pod -n secretgen-controller
NAME                                    READY   STATUS    RESTARTS   AGE
secretgen-controller-5b69875cf5-tsczq   1/1     Running   0          35s
```

### Tanzu Application Platformのインストール


#### TAP用Package Repositoryの登録

```
TANZUNET_USERNAME=...
TANZUNET_PASSWORD=...

kubectl create ns tap-install

tanzu secret registry add tap-registry \
  --username "${TANZUNET_USERNAME}" \
  --password "${TANZUNET_PASSWORD}" \
  --server registry.tanzu.vmware.com \
  --export-to-all-namespaces \
  --yes \
  --namespace tap-install

tanzu package repository add tanzu-tap-repository-1.5.0 \
  --url registry.tanzu.vmware.com/tanzu-application-platform/tap-packages:1.5.0 \
  --namespace tap-install
```


```
$ tanzu package available list --namespace tap-install
  NAME                                                 DISPLAY-NAME                                                              
  accelerator.apps.tanzu.vmware.com                    Application Accelerator for VMware Tanzu                                  
  api-portal.tanzu.vmware.com                          API portal                                                                
  apis.apps.tanzu.vmware.com                           API Auto Registration for VMware Tanzu                                    
  apiserver.appliveview.tanzu.vmware.com               Application Live View ApiServer for VMware Tanzu                          
  app-scanning.apps.tanzu.vmware.com                   Supply Chain Security Tools - App Scanning (Alpha)                        
  application-configuration-service.tanzu.vmware.com   Application Configuration Service                                         
  backend.appliveview.tanzu.vmware.com                 Application Live View for VMware Tanzu                                    
  bitnami.services.tanzu.vmware.com                    bitnami-services                                                          
  buildservice.tanzu.vmware.com                        Tanzu Build Service                                                       
  carbonblack.scanning.apps.tanzu.vmware.com           VMware Carbon Black for Supply Chain Security Tools - Scan                
  cartographer.tanzu.vmware.com                        Cartographer                                                              
  cnrs.tanzu.vmware.com                                Cloud Native Runtimes                                                     
  connector.appliveview.tanzu.vmware.com               Application Live View Connector for VMware Tanzu                          
  controller.source.apps.tanzu.vmware.com              Tanzu Source Controller                                                   
  conventions.appliveview.tanzu.vmware.com             Application Live View Conventions for VMware Tanzu                        
  crossplane.tanzu.vmware.com                          crossplane                                                                
  developer-conventions.tanzu.vmware.com               Tanzu App Platform Developer Conventions                                  
  eventing.tanzu.vmware.com                            Eventing                                                                  
  external-secrets.apps.tanzu.vmware.com               External Secrets Operator                                                 
  fluxcd.source.controller.tanzu.vmware.com            Flux Source Controller                                                    
  grype.scanning.apps.tanzu.vmware.com                 Grype for Supply Chain Security Tools - Scan                              
  learningcenter.tanzu.vmware.com                      Learning Center for Tanzu Application Platform                            
  metadata-store.apps.tanzu.vmware.com                 Supply Chain Security Tools - Store                                       
  namespace-provisioner.apps.tanzu.vmware.com          Namespace Provisioner                                                     
  ootb-delivery-basic.tanzu.vmware.com                 Tanzu App Platform Out of The Box Delivery Basic                          
  ootb-supply-chain-basic.tanzu.vmware.com             Tanzu App Platform Out of The Box Supply Chain Basic                      
  ootb-supply-chain-testing-scanning.tanzu.vmware.com  Tanzu App Platform Out of The Box Supply Chain with Testing and Scanning  
  ootb-supply-chain-testing.tanzu.vmware.com           Tanzu App Platform Out of The Box Supply Chain with Testing               
  ootb-templates.tanzu.vmware.com                      Tanzu App Platform Out of The Box Templates                               
  policy.apps.tanzu.vmware.com                         Supply Chain Security Tools - Policy Controller                           
  scanning.apps.tanzu.vmware.com                       Supply Chain Security Tools - Scan                                        
  service-bindings.labs.vmware.com                     Service Bindings for Kubernetes                                           
  services-toolkit.tanzu.vmware.com                    Services Toolkit                                                          
  snyk.scanning.apps.tanzu.vmware.com                  Snyk for Supply Chain Security Tools - Scan                               
  spring-boot-conventions.tanzu.vmware.com             Tanzu Spring Boot Conventions Server                                      
  spring-cloud-gateway.tanzu.vmware.com                Spring Cloud Gateway                                                      
  sso.apps.tanzu.vmware.com                            AppSSO                                                                    
  tap-auth.tanzu.vmware.com                            Default roles for Tanzu Application Platform                              
  tap-gui.tanzu.vmware.com                             Tanzu Application Platform GUI                                            
  tap-telemetry.tanzu.vmware.com                       Telemetry Collector for Tanzu Application Platform                        
  tap.tanzu.vmware.com                                 Tanzu Application Platform                                                
  tekton.tanzu.vmware.com                              Tekton Pipelines                                                          
  workshops.learningcenter.tanzu.vmware.com            Workshop Building Tutorial                                                
```


#### Iterate Profileのインストール

iterate profileをインストールするために、次の`tap-values.yaml`を作成します。
5CPUでもインストールできるように不要なpackageを`excluded_packages`に追加しています。

```yaml
GITHUB_USERNAME=...
GITHUB_API_TOKEN=...

cat <<EOF > tap-values.yaml
shared:
  ingress_domain: 127-0-0-1.sslip.io
  image_registry:
    project_path: ghcr.io/${GITHUB_USERNAME}
    username: ${GITHUB_USERNAME}
    password: ${GITHUB_API_TOKEN}

ceip_policy_disclosed: true
profile: iterate

supply_chain: basic

contour:
  contour:
    replicas: 1
  envoy:
    service:
      type: NodePort
    hostPorts:
      enable: true

cnrs:
  provider: local

excluded_packages:
- policy.apps.tanzu.vmware.com
- image-policy-webhook.signing.apps.tanzu.vmware.com
- eventing.tanzu.vmware.com
- sso.apps.tanzu.vmware.com
EOF
```

> `*.127-0-0-1.sslip.io`は`127.0.0.1`に解決されます。

TAPをインストールします。

```
tanzu package install tap \
  -p tap.tanzu.vmware.com \
  -v 1.5.0 \
  --values-file tap-values.yaml \
  -n tap-install
```


CLIの`package`プラグインがアップデートされて、以前のバージョンに比べてインストールの進捗が分かりやすくなりました。インストールが終わるまで10分強かかります。

```
1:58:57AM: Creating service account 'tap-tap-install-sa'
1:58:57AM: Creating cluster admin role 'tap-tap-install-cluster-role'
1:58:57AM: Creating cluster role binding 'tap-tap-install-cluster-rolebinding'
1:58:57AM: Creating secret 'tap-tap-install-values'
1:58:57AM: Creating overlay secrets
1:58:57AM: Creating package install resource
1:58:57AM: Waiting for PackageInstall reconciliation for 'tap'
1:58:57AM: Fetch started (6s ago)
1:59:03AM: Fetching 
      | apiVersion: vendir.k14s.io/v1alpha1
      | directories:
      | - contents:
      |   - imgpkgBundle:
      |       image: registry.tanzu.vmware.com/tanzu-application-platform/tap-packages@sha256:2ef21f69c3c1d9106836d01d8f0369352a3c30889c41dc8f7455b4b2a8d5c918
      |     path: .
      |   path: "0"
      | kind: LockConfig
      | 
1:59:03AM: Fetch succeeded 
1:59:03AM: Template succeeded 
1:59:03AM: Deploy started (2s ago)
1:59:05AM: Deploying 
      | Target cluster 'https://10.96.0.1:443' (nodes: kind-control-plane)
      | Changes
      | Namespace    Name                                    Kind                Age  Op      Op st.  Wait to    Rs  Ri
      | (cluster)    tap-install-cluster-admin-role          ClusterRole         -    create  -       reconcile  -   -
      | ^            tap-install-cluster-admin-role-binding  ClusterRoleBinding  -    create  -       reconcile  -   -
      | tap-install  api-auto-registration                   PackageInstall      -    create  -       reconcile  -   -
      | ^            api-auto-registration-values-ver-1      Secret              -    create  -       reconcile  -   -
      | ^            appliveview-apiserver                   PackageInstall      -    create  -       reconcile  -   -
      | ^            appliveview-apiserver-values-ver-1      Secret              -    create  -       reconcile  -   -
      | ^            appliveview-connector                   PackageInstall      -    create  -       reconcile  -   -
      | ^            appliveview-connector-values-ver-1      Secret              -    create  -       reconcile  -   -
      | ^            appliveview-conventions                 PackageInstall      -    create  -       reconcile  -   -
      | ^            appliveview-conventions-values-ver-1    Secret              -    create  -       reconcile  -   -
      | ^            bitnami-services                        PackageInstall      -    create  -       reconcile  -   -
      | ^            bitnami-services-values-ver-1           Secret              -    create  -       reconcile  -   -
      | ^            buildservice                            PackageInstall      -    create  -       reconcile  -   -
      | ^            buildservice-values-ver-1               Secret              -    create  -       reconcile  -   -
      | ^            cartographer                            PackageInstall      -    create  -       reconcile  -   -
      | ^            cartographer-values-ver-1               Secret              -    create  -       reconcile  -   -
      | ^            cert-manager                            PackageInstall      -    create  -       reconcile  -   -
      | ^            cert-manager-values-ver-1               Secret              -    create  -       reconcile  -   -
      | ^            cnrs                                    PackageInstall      -    create  -       reconcile  -   -
      | ^            cnrs-values-ver-1                       Secret              -    create  -       reconcile  -   -
      | ^            contour                                 PackageInstall      -    create  -       reconcile  -   -
      | ^            contour-values-ver-1                    Secret              -    create  -       reconcile  -   -
      | ^            crossplane                              PackageInstall      -    create  -       reconcile  -   -
      | ^            crossplane-values-ver-1                 Secret              -    create  -       reconcile  -   -
      | ^            developer-conventions                   PackageInstall      -    create  -       reconcile  -   -
      | ^            developer-conventions-values-ver-1      Secret              -    create  -       reconcile  -   -
      | ^            fluxcd-source-controller                PackageInstall      -    create  -       reconcile  -   -
      | ^            fluxcd-source-controller-values-ver-1   Secret              -    create  -       reconcile  -   -
      | ^            namespace-provisioner                   PackageInstall      -    create  -       reconcile  -   -
      | ^            namespace-provisioner-values-ver-1      Secret              -    create  -       reconcile  -   -
      | ^            ootb-delivery-basic                     PackageInstall      -    create  -       reconcile  -   -
      | ^            ootb-delivery-basic-values-ver-1        Secret              -    create  -       reconcile  -   -
      | ^            ootb-supply-chain-basic                 PackageInstall      -    create  -       reconcile  -   -
      | ^            ootb-supply-chain-basic-values-ver-1    Secret              -    create  -       reconcile  -   -
      | ^            ootb-templates                          PackageInstall      -    create  -       reconcile  -   -
      | ^            ootb-templates-values-ver-1             Secret              -    create  -       reconcile  -   -
      | ^            service-bindings                        PackageInstall      -    create  -       reconcile  -   -
      | ^            services-toolkit                        PackageInstall      -    create  -       reconcile  -   -
      | ^            services-toolkit-values-ver-1           Secret              -    create  -       reconcile  -   -
      | ^            source-controller                       PackageInstall      -    create  -       reconcile  -   -
      | ^            source-controller-values-ver-1          Secret              -    create  -       reconcile  -   -
      | ^            spring-boot-conventions                 PackageInstall      -    create  -       reconcile  -   -
      | ^            springboot-conventions-values-ver-1     Secret              -    create  -       reconcile  -   -
      | ^            tap-auth                                PackageInstall      -    create  -       reconcile  -   -
      | ^            tap-install-sa                          ServiceAccount      -    create  -       reconcile  -   -
      | ^            tap-telemetry                           PackageInstall      -    create  -       reconcile  -   -
      | ^            tap-telemetry-values-ver-1              Secret              -    create  -       reconcile  -   -
      | ^            tekton-pipelines                        PackageInstall      -    create  -       reconcile  -   -
      | ^            tekton-pipelines-values-ver-1           Secret              -    create  -       reconcile  -   -
      | Op:      49 create, 0 delete, 0 update, 0 noop, 0 exists
      | Wait to: 49 reconcile, 0 delete, 0 noop
      | 4:59:03PM: ---- applying 24 changes [0/49 done] ----
      | 4:59:03PM: create secret/api-auto-registration-values-ver-1 (v1) namespace: tap-install
...
      | 5:08:30PM: ---- waiting on 2 changes [47/49 done] ----
      | 5:08:30PM: ok: reconcile packageinstall/cnrs (packaging.carvel.dev/v1alpha1) namespace: tap-install
      | 5:08:30PM: ongoing: reconcile packageinstall/buildservice (packaging.carvel.dev/v1alpha1) namespace: tap-install
      | 5:08:30PM:  ^ Reconciling
      | 5:08:30PM: ---- waiting on 1 changes [48/49 done] ----
2:09:24AM: Deploy succeeded (1s ago)
```

Appリソースが全て`Reconcile succeeded`になっていることを確認します。

```
$ kubectl get app -n tap-install 
NAME                       DESCRIPTION           SINCE-DEPLOY   AGE
api-auto-registration      Reconcile succeeded   80s            22m
appliveview-apiserver      Reconcile succeeded   11m            22m
appliveview-connector      Reconcile succeeded   4m52s          26m
appliveview-conventions    Reconcile succeeded   9m51s          20m
bitnami-services           Reconcile succeeded   11s            20m
buildservice               Reconcile succeeded   6m33s          26m
cartographer               Reconcile succeeded   45s            22m
cert-manager               Reconcile succeeded   2m11s          26m
cnrs                       Reconcile succeeded   7m29s          19m
contour                    Reconcile succeeded   9m29s          22m
crossplane                 Reconcile succeeded   4m15s          26m
developer-conventions      Reconcile succeeded   2s             20m
fluxcd-source-controller   Reconcile succeeded   5m44s          26m
namespace-provisioner      Reconcile succeeded   5m59s          26m
ootb-delivery-basic        Reconcile succeeded   19s            20m
ootb-supply-chain-basic    Reconcile succeeded   18s            20m
ootb-templates             Reconcile succeeded   25s            20m
service-bindings           Reconcile succeeded   5m55s          26m
services-toolkit           Reconcile succeeded   24s            22m
source-controller          Reconcile succeeded   68s            22m
spring-boot-conventions    Reconcile succeeded   9m44s          20m
tap                        Reconcile succeeded   6m32s          27m
tap-auth                   Reconcile succeeded   6m17s          26m
tap-telemetry              Reconcile succeeded   6m31s          26m
tekton-pipelines           Reconcile succeeded   15m            26m
```

インストールされたパッケージは次の通りです。

````
$ tanzu package installed list -n tap-install
  NAME                      PACKAGE-NAME                                 PACKAGE-VERSION   STATUS               
  api-auto-registration     apis.apps.tanzu.vmware.com                   0.3.0             Reconcile succeeded  
  appliveview-apiserver     apiserver.appliveview.tanzu.vmware.com       1.5.1             Reconcile succeeded  
  appliveview-connector     connector.appliveview.tanzu.vmware.com       1.5.1             Reconcile succeeded  
  appliveview-conventions   conventions.appliveview.tanzu.vmware.com     1.5.1             Reconcile succeeded  
  bitnami-services          bitnami.services.tanzu.vmware.com            0.1.0             Reconcile succeeded  
  buildservice              buildservice.tanzu.vmware.com                1.10.8            Reconcile succeeded  
  cartographer              cartographer.tanzu.vmware.com                0.7.1+tap.1       Reconcile succeeded  
  cert-manager              cert-manager.tanzu.vmware.com                2.3.0             Reconcile succeeded  
  cnrs                      cnrs.tanzu.vmware.com                        2.2.0             Reconcile succeeded  
  contour                   contour.tanzu.vmware.com                     1.22.5+tap.1.5.0  Reconcile succeeded  
  crossplane                crossplane.tanzu.vmware.com                  0.1.1             Reconcile succeeded  
  developer-conventions     developer-conventions.tanzu.vmware.com       0.10.0            Reconcile succeeded  
  fluxcd-source-controller  fluxcd.source.controller.tanzu.vmware.com    0.27.0+tap.10     Reconcile succeeded  
  namespace-provisioner     namespace-provisioner.apps.tanzu.vmware.com  0.3.1             Reconcile succeeded  
  ootb-delivery-basic       ootb-delivery-basic.tanzu.vmware.com         0.12.5            Reconcile succeeded  
  ootb-supply-chain-basic   ootb-supply-chain-basic.tanzu.vmware.com     0.12.5            Reconcile succeeded  
  ootb-templates            ootb-templates.tanzu.vmware.com              0.12.5            Reconcile succeeded  
  service-bindings          service-bindings.labs.vmware.com             0.9.1             Reconcile succeeded  
  services-toolkit          services-toolkit.tanzu.vmware.com            0.10.1            Reconcile succeeded  
  source-controller         controller.source.apps.tanzu.vmware.com      0.7.0             Reconcile succeeded  
  spring-boot-conventions   spring-boot-conventions.tanzu.vmware.com     1.5.1             Reconcile succeeded  
  tap                       tap.tanzu.vmware.com                         1.5.0             Reconcile succeeded  
  tap-auth                  tap-auth.tanzu.vmware.com                    1.1.0             Reconcile succeeded  
  tap-telemetry             tap-telemetry.tanzu.vmware.com               0.5.0-build.3     Reconcile succeeded  
  tekton-pipelines          tekton.tanzu.vmware.com                      0.41.0+tap.8      Reconcile succeeded  
````

デプロイされたPodは次の通りです。

```
$ kubectl get pod -A | grep -v kube-system  | grep -v local-path-storage
NAMESPACE                    NAME                                                           READY   STATUS    RESTARTS   AGE
api-auto-registration        api-auto-registration-controller-685c778dc5-qs95q              1/1     Running   0          23m
app-live-view-connector      application-live-view-connector-bmbf8                          1/1     Running   0          28m
app-live-view-conventions    appliveview-webhook-76987d56cb-brql4                           1/1     Running   0          22m
appliveview-tokens-system    appliveview-apiserver-6d6df6fd97-88ms8                         1/1     Running   0          23m
build-service                build-pod-image-fetcher-c27hd                                  5/5     Running   0          28m
build-service                dependency-updater-controller-d5c58c9c6-fwdfz                  1/1     Running   0          28m
build-service                secret-syncer-controller-6489d79d97-9mtst                      1/1     Running   0          28m
build-service                warmer-controller-6dcd9b54cd-zb8cf                             1/1     Running   0          28m
cartographer-system          cartographer-controller-cf9855dd6-4bqvb                        1/1     Running   0          23m
cartographer-system          cartographer-conventions-controller-manager-6dfb8c8695-z7phr   1/1     Running   0          23m
cert-injection-webhook       cert-injection-webhook-58c65df6f9-kkhb5                        1/1     Running   0          28m
cert-manager                 cert-manager-5dcdbc6d45-pdn8c                                  1/1     Running   0          27m
cert-manager                 cert-manager-cainjector-786f64f6c9-rptgc                       1/1     Running   0          27m
cert-manager                 cert-manager-webhook-5f8c898599-mqmrz                          1/1     Running   0          27m
crossplane-system            crossplane-7648686698-cnbkx                                    1/1     Running   0          28m
crossplane-system            crossplane-rbac-manager-679768f775-dddzd                       1/1     Running   0          28m
crossplane-system            provider-helm-a3a14b07b79a-67f8c4559d-2qz68                    1/1     Running   0          26m
crossplane-system            provider-kubernetes-8039f7e56376-68dfcf8dcb-vjhqk              1/1     Running   0          26m
developer-conventions        webhook-74794564dd-w7wxm                                       1/1     Running   0          22m
flux-system                  fluxcd-source-controller-7788d4997c-5n2dr                      1/1     Running   0          28m
kapp-controller              kapp-controller-589c94578d-gtzzh                               2/2     Running   0          39m
knative-serving              activator-7569d75775-887q6                                     1/1     Running   0          21m
knative-serving              autoscaler-57646c4765-r9sfz                                    1/1     Running   0          21m
knative-serving              autoscaler-hpa-f4b6c477-ghrt2                                  1/1     Running   0          21m
knative-serving              controller-5788595b96-jllz7                                    1/1     Running   0          21m
knative-serving              domain-mapping-6bb9fb4775-fq5xb                                1/1     Running   0          21m
knative-serving              domainmapping-webhook-5cbf445bd9-cs6rc                         1/1     Running   0          21m
knative-serving              net-certmanager-controller-69b67f65ff-6cwfz                    1/1     Running   0          21m
knative-serving              net-certmanager-webhook-7cb97df644-9ssqq                       1/1     Running   0          21m
knative-serving              net-contour-controller-75656d497d-rh46m                        1/1     Running   0          21m
knative-serving              webhook-67cd79d96f-jp757                                       1/1     Running   0          21m
kpack                        kpack-controller-db46f4677-p6rkx                               1/1     Running   0          28m
kpack                        kpack-webhook-645c986b8c-s5lwc                                 1/1     Running   0          28m
secretgen-controller         secretgen-controller-5b69875cf5-tsczq                          1/1     Running   0          38m
service-bindings             manager-7566b9876-7nghl                                        1/1     Running   0          28m
services-toolkit             resource-claims-apiserver-7488f85f5c-drctl                     1/1     Running   0          23m
services-toolkit             services-toolkit-controller-manager-5d79487fb9-cbgxz           1/1     Running   0          23m
source-system                source-controller-manager-5d49b7c788-577jb                     1/1     Running   0          23m
spring-boot-convention       spring-boot-webhook-7fd5d6884c-vbhqf                           1/1     Running   0          22m
stacks-operator-system       controller-manager-599784f8fb-xxxj2                            1/1     Running   0          28m
tanzu-system-ingress         contour-6cdd9b89d5-z2lw9                                       1/1     Running   0          23m
tanzu-system-ingress         envoy-pk5vj                                                    2/2     Running   0          23m
tap-namespace-provisioning   controller-manager-64b8f7fbf8-xdw6d                            1/1     Running   0          28m
tap-telemetry                tap-telemetry-informer-7b8bf9cc46-cm5jg                        1/1     Running   0          28m
tekton-pipelines-resolvers   tekton-pipelines-remote-resolvers-69fcdbdd86-4g2r6             1/1     Running   0          28m
tekton-pipelines             tekton-pipelines-controller-64f4478dd7-kpjm9                   1/1     Running   0          28m
tekton-pipelines             tekton-pipelines-webhook-75d5c765dc-67j62                      1/1     Running   0          28m
```

ClusterBuilderがREADYなことを確認します。

```
$ kubectl get clusterbuilder
NAME         LATESTIMAGE                                                                                                                     READY
base         ghcr.io/making/buildservice:clusterbuilder-base@sha256:f0c7bdf126a03a95d5581ddff62b58d141e49891faf745e4424024627728a19f         True
base-jammy   ghcr.io/making/buildservice:clusterbuilder-base-jammy@sha256:517f23a6eda7c186b0d96a3b425e73f980cbaed5d1decc5b3c0b16f0a97f6a30   True
default      ghcr.io/making/buildservice:clusterbuilder-default@sha256:517f23a6eda7c186b0d96a3b425e73f980cbaed5d1decc5b3c0b16f0a97f6a30      True
```

### Workloadのデプロイ

TAP 1.4からはNamespace Provisionerが導入され、Workloadを作成するための事前準備が自動化されました。<br>
https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/namespace-provisioner-provision-developer-ns.html

#### registry-credentialsの作成と公開

```
tanzu secret registry add registry-credentials \
  --server ghcr.io \
  --username ${GITHUB_USERNAME} \
  --password ${GITHUB_API_TOKEN} \
  --namespace tap-install \
  --export-to-all-namespaces \
  -y
```

#### Namespaceの作成

Namespaceに`apps.tanzu.vmware.com/tap-ns`ラベルを設定すると必要なリソースが自動生成されます。

生成されるリソースは次のドキュメントにまとまっています<br>
https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/namespace-provisioner-reference.html#default-resources-1

```
kubectl create ns demo
kubectl label namespaces demo apps.tanzu.vmware.com/tap-ns=""
```


```
$ kubectl get secrets,serviceaccount,rolebinding,configmap -n demo
NAME                            TYPE                             DATA   AGE
secret/registries-credentials   kubernetes.io/dockerconfigjson   1      7s

NAME                     SECRETS   AGE
serviceaccount/default   1         7s

NAME                                                               ROLE                      AGE
rolebinding.rbac.authorization.k8s.io/default-permit-deliverable   ClusterRole/deliverable   7s
rolebinding.rbac.authorization.k8s.io/default-permit-workload      ClusterRole/workload      7s

NAME                         DATA   AGE
configmap/kube-root-ca.crt   1      7s
```

[`kapp`](https://github.com/vmware-tanzu/carvel-kapp/releases) CLIを使うとNamespace Provisionerによって作成されたリソースを確認できます。

```
$ kapp inspect -n tap-namespace-provisioning -a provisioner.app
Target cluster 'https://127.0.0.1:56439' (nodes: kind-control-plane)

Resources in app 'provisioner.app'

Namespace  Name                        Kind            Owner  Rs  Ri  Age  
demo       default                     ServiceAccount  kapp   ok  -   21s  
^          default-permit-deliverable  RoleBinding     kapp   ok  -   21s  
^          default-permit-workload     RoleBinding     kapp   ok  -   21s  
^          registries-credentials      Secret          kapp   ok  -   21s  

Rs: Reconcile state
Ri: Reconcile information

4 resources

Succeeded
```

#### Node.jsアプリのデプロイ

```
tanzu apps workload apply hello-nodejs \
  --app hello-nodejs \
  --git-repo https://github.com/making/hello-nodejs \
  --git-branch master \
  --type web \
  -n demo \
  -y
```

ログは[`stern`](https://github.com/stern/stern)を使うとわかりやすいです。

```
stern -n demo hello-nodejs
```

Supply Chainの進捗は次のコマンドで確認できます。

```
$ tanzu apps workload get -n demo hello-nodejs
📡 Overview
   name:        hello-nodejs
   type:        web
   namespace:   demo

💾 Source
   type:     git
   url:      https://github.com/making/hello-nodejs
   branch:   master

📦 Supply Chain
   name:   source-to-url

   NAME               READY     HEALTHY   UPDATED   RESOURCE
   source-provider    True      True      22s       gitrepositories.source.toolkit.fluxcd.io/hello-nodejs
   image-provider     Unknown   Unknown   22s       images.kpack.io/hello-nodejs
   config-provider    False     Unknown   24s       not found
   app-config         False     Unknown   24s       not found
   service-bindings   False     Unknown   24s       not found
   api-descriptors    False     Unknown   24s       not found
   config-writer      False     Unknown   24s       not found

🚚 Delivery
   name:   delivery-basic

   NAME              READY   HEALTHY   UPDATED   RESOURCE
   source-provider   False   False     19s       imagerepositories.source.apps.tanzu.vmware.com/hello-nodejs-delivery
   deployer          False   Unknown   22s       not found

💬 Messages
   Workload [MissingValueAtPath]:   waiting to read value [.status.latestImage] from resource [images.kpack.io/hello-nodejs] in namespace [demo]
   Deliverable [HealthyConditionRule]:   Unable to resolve image with tag "ghcr.io/making/workloads/hello-nodejs-demo-bundle:8fe0ae6b-62b0-4eee-9980-ef3a021b3639" to a digest: HEAD https://ghcr.io/v2/making/workloads/hello-nodejs-demo-bundle/manifests/8fe0ae6b-62b0-4eee-9980-ef3a021b3639: unexpected status code 404 Not Found (HEAD responses have no body, use GET for details)

🛶 Pods
   NAME                             READY   STATUS     RESTARTS   AGE
   hello-nodejs-build-1-build-pod   0/1     Init:1/6   0          21s

To see logs: "tanzu apps workload tail hello-nodejs --namespace demo --timestamp --since 1h"
```

"Knative Services"の欄が出力され、"Ready"になればアプリでのデプロイは完了です。

```
$ tanzu apps workload get -n demo hello-nodejs
📡 Overview
   name:        hello-nodejs
   type:        web
   namespace:   demo

💾 Source
   type:     git
   url:      https://github.com/making/hello-nodejs
   branch:   master

📦 Supply Chain
   name:   source-to-url

   NAME               READY   HEALTHY   UPDATED   RESOURCE
   source-provider    True    True      3m30s     gitrepositories.source.toolkit.fluxcd.io/hello-nodejs
   image-provider     True    True      112s      images.kpack.io/hello-nodejs
   config-provider    True    True      99s       podintents.conventions.carto.run/hello-nodejs
   app-config         True    True      99s       configmaps/hello-nodejs
   service-bindings   True    True      99s       configmaps/hello-nodejs-with-claims
   api-descriptors    True    True      99s       configmaps/hello-nodejs-with-api-descriptors
   config-writer      True    True      37s       runnables.carto.run/hello-nodejs-config-writer

🚚 Delivery
   name:   delivery-basic

   NAME              READY   HEALTHY   UPDATED   RESOURCE
   source-provider   True    True      23s       imagerepositories.source.apps.tanzu.vmware.com/hello-nodejs-delivery
   deployer          True    True      21s       apps.kappctrl.k14s.io/hello-nodejs

💬 Messages
   No messages found.

🛶 Pods
   NAME                                             READY   STATUS      RESTARTS   AGE
   hello-nodejs-00001-deployment-66f98fc64c-bq8dx   2/2     Running     0          24s
   hello-nodejs-build-1-build-pod                   0/1     Completed   0          3m29s
   hello-nodejs-config-writer-thbcj-pod             0/1     Completed   0          97s

🚢 Knative Services
   NAME           READY   URL
   hello-nodejs   Ready   https://hello-nodejs.demo.127-0-0-1.sslip.io

To see logs: "tanzu apps workload tail hello-nodejs --namespace demo --timestamp --since 1h"
```

```
$ curl -k https://hello-nodejs.demo.127-0-0-1.sslip.io
Hello World!
```

確認が終わればWorkloadを削除します。

```
tanzu apps workload delete -n demo hello-nodejs -y
```

#### Javaアプリのデプロイ

```
tanzu apps workload apply spring-music \
  --app spring-music \
  --git-repo https://github.com/scottfrederick/spring-music \
  --git-branch tanzu \
  --type web \
  --annotation autoscaling.knative.dev/minScale=1 \
  -n demo \
  -y
```

ログは[`stern`](https://github.com/stern/stern)を使うとわかりやすいです。

```
stern -n demo spring-music
```

次のコマンドを実行し、"Knative Services"の欄が出力され、"Ready"になればアプリでのデプロイは完了です。

```
$ tanzu apps workload get -n demo spring-music 
📡 Overview
   name:        spring-music
   type:        web
   namespace:   demo

💾 Source
   type:     git
   url:      https://github.com/scottfrederick/spring-music
   branch:   tanzu

📦 Supply Chain
   name:   source-to-url

   NAME               READY   HEALTHY   UPDATED   RESOURCE
   source-provider    True    True      7m4s      gitrepositories.source.toolkit.fluxcd.io/spring-music
   image-provider     True    True      4m22s     images.kpack.io/spring-music
   config-provider    True    True      4m13s     podintents.conventions.carto.run/spring-music
   app-config         True    True      4m13s     configmaps/spring-music
   service-bindings   True    True      4m13s     configmaps/spring-music-with-claims
   api-descriptors    True    True      4m13s     configmaps/spring-music-with-api-descriptors
   config-writer      True    True      4m        runnables.carto.run/spring-music-config-writer

🚚 Delivery
   name:   delivery-basic

   NAME              READY   HEALTHY   UPDATED   RESOURCE
   source-provider   True    True      3m58s     imagerepositories.source.apps.tanzu.vmware.com/spring-music-delivery
   deployer          True    True      3m56s     apps.kappctrl.k14s.io/spring-music

💬 Messages
   No messages found.

🛶 Pods
   NAME                                            READY   STATUS      RESTARTS   AGE
   spring-music-00001-deployment-bdf86d97f-8rqks   2/2     Running     0          3m58s
   spring-music-build-1-build-pod                  0/1     Completed   0          7m3s
   spring-music-config-writer-v495h-pod            0/1     Completed   0          4m12s

🚢 Knative Services
   NAME           READY   URL
   spring-music   Ready   https://spring-music.demo.127-0-0-1.sslip.io

To see logs: "tanzu apps workload tail spring-music --namespace demo --timestamp --since 1h"
```

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/212458384-0489f362-66fc-4042-af18-5626d47e78a6.png">

"THIS IS UNSAFE"を入力

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/212458400-14b932a6-aaee-4ccc-b716-34ef7edd4c32.png">



TAP 1.4からはSpring Boot Actuatorに関する自動設定のデフォルトが変わりました。Spring Boot Actuatorが依存関係に含まれている場合、TAP 1.3まではデフォルトで環境変数`JAVA_TOOL_OPTIONS`に次のシステムプロパティが設定されていました。

* `-Dmanagement.endpoint.health.show-details="always"`
* `-Dmanagement.endpoints.web.exposure.include="*"` 
* `-Dmanagement.server.port="8081"`

TAP 1.4からはこれが自動で設定されません。次のように`JAVA_TOOL_OPTIONS`を確認すると、上記のプロパティが含まれていないことがわかります。

```
$ kubectl get ksvc -n demo spring-music -ojsonpath='{.spec.template.spec.containers[?(@.name=="workload")].env[?(@.name=="JAVA_TOOL_OPTIONS")].value}'
-Dmanagement.endpoint.health.probes.add-additional-paths="true" -Dmanagement.health.probes.enabled="true" -Dserver.port="8080" -Dserver.shutdown.grace-period="24s"
```


TAP 1.4以降でもTAP 1.3以前と同様の設定を含めたい場合は、次のようにWorkloadレベルで`apps.tanzu.vmware.com/auto-configure-actuators`ラベルに`"true"`を設定すれば良いです。

```
tanzu apps workload apply spring-music \
  --app spring-music \
  --git-repo https://github.com/scottfrederick/spring-music \
  --git-branch tanzu \
  --type web \
  --annotation autoscaling.knative.dev/minScale=1 \
  --label apps.tanzu.vmware.com/auto-configure-actuators=true \
  -n demo \
  -y
```

デプロイ完了後に設定された`JAVA_TOOL_OPTIONS`を確認すると、値が変わっていることがわかります。

```
$ kubectl get ksvc -n demo spring-music -ojsonpath='{.spec.template.spec.containers[?(@.name=="workload")].env[?(@.name=="JAVA_TOOL_OPTIONS")].value}'
-Dmanagement.endpoint.health.probes.add-additional-paths="true" -Dmanagement.endpoint.health.show-details="always" -Dmanagement.endpoints.web.base-path="/actuator" -Dmanagement.endpoints.web.exposure.include="*" -Dmanagement.health.probes.enabled="true" -Dmanagement.server.port="8081" -Dserver.port="8080" -Dserver.shutdown.grace-period="24s"
```


Platformレベルで設定を反映させたい場合は`tap-values.yaml`に次の設定をすれば良いです。

```yaml
springboot_conventions:
  autoConfigureActuators: true
```


Spring Boot Actuatorの設定に関するドキュメントはこちらです。
https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/spring-boot-conventions-configuring-spring-boot-actuators.html


確認が終わればWorkloadを削除します。

```
tanzu apps workload delete -n demo spring-music -y
```

### GitOpsでデプロイする

https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/scc-gitops-vs-regops.html#gitops-0

まず、manifestを管理するgitレポジトリをGitHubで作成ます。READMEのみを含む https://github.com/making/hello-nodejs-manifests を作成しました。
<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178646028-cf7fab55-e3bc-447b-a4ad-95fb78c57c0e.png">

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178646115-141d9c2b-6a1c-4059-bcd7-efcac9716158.png">

GitレポジトリにpushするためのSecretを作成します。[HTTP(S) Basic-auth](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/scc-gitops-vs-regops.html#authentication-3)か[SSH](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/scc-gitops-vs-regops.html#ssh-4)が選べます。
ここではBasic-authを使用します。

https://github.com/settings/tokens からrepoへのアクセス権があるPersonal access tokensを生成してください。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178656962-6cb06cf9-4296-4b1a-80b2-d4f2f61fcee6.png">


このPersonal access tokenのSecetを作成し、Service AccountにこのSecretを参照させる必要があります。
TAP 1.3まではこの作業はNamepsace毎に手動またはTAP以外の仕組みで行う必要がありましたが、TAP 1.4からはNamespace Provisionerを使ってNamespace毎に自動でリソースを作成することができます。

両方のパターンを紹介します。

#### 手動で個々にPersonal access tokenを設定 (TAP 1.3までと同じ)

まずは手動の場合。次のコマンドでSecretを作成します。

```
GITHUB_USERNAME=making
GITHUB_API_TOKEN=ghp_******

kubectl create secret generic git-basic -n demo \
    --type kubernetes.io/basic-auth \
    --from-literal=username=${GITHUB_USERNAME} \
    --from-literal=password=${GITHUB_API_TOKEN} \
    --dry-run=client -oyaml \
 | kubectl apply -f- 
kubectl -n demo annotate secret git-basic tekton.dev/git-0=https://github.com --overwrite=true
kubectl patch -n demo serviceaccount default -p "{\"secrets\":[{\"name\":\"git-basic\"}]}"
```

#### Namespace Provisionerを使ってPersonal access tokenを設定


Namespace ProvisionerによるGit用のSecret作成方法は次のドキュメントに記載されています。<br>
https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/namespace-provisioner-use-case3.html


追加したいリソースのテンプレートを`tap-values.yaml`の`namespace_provisioner.additional_sources`に記述できます。


```yaml
GITHUB_USERNAME=making
GITHUB_API_TOKEN=ghp_******

Namespace Provisionerで追加で作成してもらいたいSecretのテンプレートは以下を使用します。<br>
https://github.com/making/namespace-provisioner-samples/blob/main/git-basic/secret.yaml

<br>
このテンプレートに穴埋めする変数を以下のように作成します。

cat << EOF > workload-git-auth.yaml
apiVersion: v1
kind: Secret
metadata:
  name: workload-git-auth
  namespace: tap-install
type: Opaque
stringData:
  content.yaml: |
    git:
      host: https://github.com
      username: "${GITHUB_USERNAME}"
      token: "${GITHUB_API_TOKEN}"
EOF

kubectl apply -f workload-git-auth.yaml
```

デフォルトで作成されるリソース(ServiceAccount)を変更し、`secrets`に`git-basic`を追加するためのoverlayファイルを作成します。

```yaml
cat << EOF > workload-git-auth-overlay.yaml
apiVersion: v1
kind: Secret
metadata:
  name: workload-git-auth-overlay
  namespace: tap-install
  annotations:
    kapp.k14s.io/change-rule: "delete after deleting tap"
stringData:
  workload-git-auth-overlay.yaml: |
    #@ load("@ytt:overlay", "overlay")
    #@overlay/match by=overlay.subset({"kind": "ServiceAccount","metadata":{"name":"default"}}), expects="0+"
    ---
    secrets:
    #@overlay/append
    - name: git-basic
EOF

kubectl apply -f workload-git-auth-overlay.yaml
```

次のように`tap-values.yaml`に`namespace_provisioner`の設定を追記します。


```yaml
cat <<EOF >> tap-values.yaml

namespace_provisioner:
  controller: true
  additional_sources:
  - git:
      url: https://github.com/making/namespace-provisioner-samples.git
      ref: origin/main
      subPath: git-basic
    path: _ytt_lib/git-basic
  import_data_values_secrets:
  - name: workload-git-auth
    namespace: tap-install
    create_export: true
  overlay_secrets:
  - name: workload-git-auth-overlay
    namespace: tap-install
    create_export: true
EOF
```

> ⚠️ TAP 1.4では`additional_sources`以下に`inline`の設定ができましたが、1.5.0では`git`以外が設定されるとエラーにでるようになっていました。バリデーションと言うよりも`git`以外が設定されることが想定されていないようです。

次のコマンドでTAPをアップデートすれば、`apps.tanzu.vmware.com/tap-ns`ラベルのついた全てのNamespaceに`git-basic`というSecretが作成され、`default` Service Accountの`secrets`に`git-basic`が追加されます。

```
tanzu package installed update -n tap-install tap --values-file tap-values.yaml
```

[`kapp`](https://github.com/vmware-tanzu/carvel-kapp/releases) CLIでリソースを確認すると

```
$ kapp inspect -n tap-namespace-provisioning -a provisioner.app                  
Target cluster 'https://127.0.0.1:56439' (nodes: kind-control-plane)

Resources in app 'provisioner.app'

Namespace  Name                        Kind            Owner  Rs  Ri  Age  
demo       default                     ServiceAccount  kapp   ok  -   2m  
^          default-permit-deliverable  RoleBinding     kapp   ok  -   2m  
^          default-permit-workload     RoleBinding     kapp   ok  -   2m  
^          git-basic                   Secret          kapp   ok  -   21s  
^          registries-credentials      Secret          kapp   ok  -   2m  

Rs: Reconcile state
Ri: Reconcile information

5 resources

Succeeded
```

`default` Service Accountを確認すると

```
$ kubectl get sa -n demo default -oyaml
apiVersion: v1
imagePullSecrets:
- name: registries-credentials
kind: ServiceAccount
metadata:
# ...
secrets:
- name: registries-credentials
- name: git-basic
```


反映が遅い場合は[`kctrl`](https://github.com/vmware-tanzu/carvel-kapp-controller/releases) CLIで次のように強制的に反映できます。どちらか一方だけで良いかもしれません。


```
# tap-values.yamlの変更を反映し、Namespace Provisionerを更新
kctrl app kick -n tap-install -a namespace-provisioner -y

# Namespace Provisionerの変更を反映し、作成するリソースを更新
kctrl app kick -n tap-namespace-provisioning -a provisioner -y
```

#### Workloadのデプロイ


Personal access tokenの設定が終われば、次のコマンドでデプロイできます。

```
tanzu apps workload apply hello-nodejs \
  --app hello-nodejs \
  --git-repo https://github.com/making/hello-nodejs \
  --git-branch master \
  --type web \
  --param gitops_branch=main \
  --param gitops_commit_message=Bump \
  --param gitops_server_address=https://github.com \
  --param gitops_repository_owner=making \
  --param gitops_repository_name=tap-gitops-manifests \
  --param gitops_user_email=makingx+bot@gmail.com \
  --param gitops_user_name=making-bot \
  --param gitops_ssh_secret=git-basic \
  -n demo \
  -y
```

ログは[`stern`](https://github.com/stern/stern)を使うとわかりやすいです。

```
stern -n demo hello-nodejs
```

次のコマンドを実行し、"Knative Services"の欄が出力され、"Ready"になればアプリでのデプロイは完了です。


```
$ tanzu apps workload get hello-nodejs -n demo
```


kpackによるコンテナイメージのビルドが終わると、そのイメージのdigestを使用してmanifestをgit commit & pushがTektonによって行われます。
gitレポジトリを見ると次のコミットが自動で行われていることがわかります。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/204441449-11dcc7ab-c0cf-48e3-aeba-3a4658ec0ff5.png">

URLにアクセスします。

```
$ curl -k https://hello-demo.127-0-0-1.sslip.io
Hello World!
```

ソースコードを変更してgit pushすると、新しいコンテナイメージがビルドされ、manifestも新しいイメージのdigestを使用するようにcommit & pushされます。
次のようなコミットになります。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/204442264-ccee00b1-70ac-4f93-a072-08307fc2cfd5.png">

### GitOpsでpull requestを使用する

TAP 1.2からはmanifestの変更を直接commit & pushする代わり、pull requestを送ることができるようになりました。

https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/scc-gitops-vs-regops.html#pull-requests-2

`tap-values.yaml`の以下の行を追加します。デフォルトは`direct`です。

```yaml
# ...
ootb_supply_chain_basic:
  gitops:
    commit_strategy: pull_request
    pull_request:
      server_kind: github
      commit_branch: ""
      pull_request_title: "ready for review"
      pull_request_body: "generated by supply chain"
```

次のコマンドでTAPをアップデートします。

```
tanzu package installed update -n tap-install tap -f tap-values.yaml
```

ソースコードに変更を加え、git pushすると、コンテナイメージ作成後に次のようなPull Requestが作成されます。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/204446984-75033d9e-da00-4b17-9256-cb39f283bbc4.png">

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/204447043-ca6d18ed-fc4e-460a-ae58-b36acd3377db.png">


このPull Requestをマージすると、変更結果がデプロイされます。

確認が終わればWorkloadを削除します。

```
tanzu apps workload delete -n demo hello -y
```


---
TAPを使うとCI/CDのフローを`tanzu apps workload`だけで作成できるのが便利ですね。
