---
title: Kubernetesãƒãƒ³ã‚ºã‚ªãƒ³ - 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
tags: ["Kubernetes Handson", "Kubernetes", "PKS"]
categories: ["Dev", "CaaS", "Kubernetes"]
updated: 1970-01-01T09:00:00+09:00
---

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã¯`Deployment`ã«ã‚ˆã£ã¦è¡Œã‚ã‚Œã¾ã™ã€‚

![image](https://user-images.githubusercontent.com/106908/40193336-fa554166-5a41-11e8-8f2f-31d5293844db.png)


ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’è¡Œã†å ´åˆã¯ã€Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°ã‚’æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¤‰æ›´ã—ã€`kubectl apply`ã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-pks
spec:
  # ...
  template:
    # ...
    spec:
      containers:
      - image: making/hello-pks:0.0.2 # <-- 0.0.1ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
```

ãŸã ã—ã€ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãªã—ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ãŸã„å ´åˆã¯ã€ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¨Deploymentã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼ã«æ°—ã‚’ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**ç›®æ¬¡**

<!-- toc -->

### ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

Deplotmentã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹å ´åˆã¯ã€æ›´æ–°ã—ãŸã‚³ãƒ³ãƒ†ãƒŠãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’
Deploymentã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¯çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒãªã„ã¨ã€æ¬¡ã®Podã‚’æ›´æ–°ã—ã¦è‰¯ã„ã‹æ­£ã—ãåˆ¤æ–­ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚

ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«ã¯Readiness Probeã¨Liveness Probeã®2ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚
Readiness Probeã¯ã‚³ãƒ³ãƒ†ãƒŠãŒå¿œç­”ã§ãã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€Liveness Probeã¯ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ›´æ–°ã®éš›ã¯Readiness Probeã‚’æ­£ã—ãè¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### Readiness Probe

Deploymentã®`spec.template.spec.containers[]`ã«`readinessProbe`ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-pks
spec:
  # ...
  template:
    # ...
    spec:
      containers:
      - image: making/hello-pks:0.0.1
        name: hello-pks
        ports:
        - containerPort: 8080
        env:
        - # ...
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
          periodSeconds: 5
```

Readinss ProbeãŠã‚ˆã³Liveness Probeã¯HTTPã€TCPã€ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œçµæœã«ã‚ˆã‚‹ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚
ã“ã“ã§ã¯HTTPãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯(`httpGet`)ã®ã¿æ‰±ã„ã¾ã™ã€‚ãã®ä»–ã®æ–¹æ³•ã¯[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
`making/hello-pks`ã¯[Spring Boot Actuator](https://docs.spring.io/spring-boot/docs/2.0.x/reference/html/production-ready-endpoints.html)ã‚’ä½¿ã£ã¦ãŠã‚Šã€ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦`/actuator/health`ã‚’`path`ã«è¨­å®šã§ãã¾ã™ã€‚

`initialDelaySeconds`ã¯ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã‚’é–‹å§‹ã—ã¦ã‹ã‚‰åˆã‚ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã¾ã§ã®å¾…ã¡æ™‚é–“(ç§’)ã§ã™ã€‚
`timeoutSeconds`ã¯1å›ã®ãƒã‚§ãƒƒã‚¯ã§å¤±æ•—ã¨ã¿ãªã™ã¾ã§ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ(ç§’)ã§ã™ã€‚`failureThreshold`ã¯ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å¤±æ•—ã¨ã¿ãªã™ã¾ã§ã®ãƒªãƒˆãƒ©ã‚¤å›æ•°ã§ã™ã€‚
`periodSeconds`ã¯ãƒªãƒˆãƒ©ã‚¤ã®é–“éš”(ç§’)ã§ã™ã€‚

#### Liveness Probe

Liveness Probeã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ›´æ–°ã«ã¯ç›´æ¥é–¢ä¿‚ã—ã¾ã›ã‚“ãŒã€ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®1ç¨®ã¨ã—ã¦ã“ã“ã§èª¬æ˜ã—ã¾ã™ã€‚
Liveness Probeã¯ã‚³ãƒ³ãƒ†ãƒŠã®ç”Ÿå­˜ç¢ºèªã«ä½¿ã‚ã‚Œã€Liveness ProbeãŒå¤±æ•—ã—ãŸå ´åˆã¯ã‚³ãƒ³ãƒ†ãƒŠãŒå†èµ·å‹•ã—ã¾ã™ã€‚

`Deployment`ã®`spec.template.spec.containers[]`ã«`livenessProbe`ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-pks
spec:
  # ...
  template:
    # ...
    spec:
      containers:
      - image: making/hello-pks:0.0.1
        name: hello-pks
        ports:
        - containerPort: 8080
        env:
        - # ...
        readinessProbe:
          # ...
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 20
          timeoutSeconds: 1
          periodSeconds: 10
          failureThreshold: 1
```

è¨­å®šé …ç›®ã¯Readiness Probeã¨åŒã˜ã§ã™ã€‚

> Spring Boot Actuatorã®healthã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯åˆ©ç”¨ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãªã©ã‚‚è¡Œã„ã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒãƒ€ã‚¦ãƒ³ã—ã¦ã„ã‚‹éš›ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•ã—ã¦ã‚‚æ„å‘³ãŒãªã„å ´åˆã¯ã€Rediness Probeã§ã¯ãƒ‡ãƒ¼ã‚¿ãƒ¼ãƒ™ãƒ¼ã‚¹ãªã©ã®ãƒã‚§ãƒƒã‚¯ã¯æ•¢ãˆã¦è¡Œã‚ãªãš`path`ã‚’`/actuator/info`ã«å¤‰ãˆã‚‹ã“ã¨ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚


### Deploymentã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼

`Deployment`ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹å ´åˆã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼ã¨ã—ã¦`RollingUpdate`ã¨`Recreate`ãŒé¸ã¹ã¾ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯`RollingUpdate`ã§ã™ã€‚

#### Rolling Update

Rolling Updateã§ã¯Podã‚’å°‘ã—ãšã¤æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ç§»è¡Œã—ã€ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãªãåˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
Rolling Updateã®æŒ™å‹•ã¯`maxUnavailable`ã¨`maxSurge`ã«ã‚ˆã£ã¦èª¿ç¯€ã§ãã¾ã™ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-pks
spec:
  replicas: 4
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    # ...
```

`maxUnavailable`ã¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆä¸­ã«è¨±å®¹ã§ãã‚‹æœ€å¤§ã®ä½¿ç”¨ä¸å¯Podã®æ•°ã¾ãŸã¯å‰²åˆã§ã™ã€‚
`maxSurge`ã¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆä¸­ã«`replicas`æ•°ã‚’è¶…ãˆã¦å¢—ã‚„ã—ã¦è‰¯ã„Podã®æ•°ã¾ãŸã¯å‰²åˆã§ã™ã€‚
`maxUnavailable`ã‚„`maxSurge`ã¯`replicas`ã«ä¾å­˜ã—ãªã„ã‚ˆã†ã«`%`ã§æŒ‡å®šã—ãŸæ–¹ãŒè‰¯ã„ã§ã™ã€‚

`maxUnavailable`ã¨`maxSurge`ã¨ã‚‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯`25%`ã§ã™ã€‚

ä¾‹ãˆã°`replicas`ãŒ`4`ã®å ´åˆã§`maxUnavailable`ãŒ`2`ã¨`maxSurge`ãŒ`0`ã ã¨ã—ã¾ã™ã€‚
ãã®å ´åˆã¯Podæ•°ã¯æ¬¡ã®è¡¨ã®ã‚ˆã†ã«æ¨ç§»ã—ã¾ã™ã€‚(å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚„ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•é€Ÿåº¦ã«ã‚ˆã‚Šç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)

| æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Podæ•°(Ready/Desired) | æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Podæ•°(Ready/Desired) |
| - | - |
| 4/4 | 0/0 |
| 2/2 | 0/2 |
| 0/0 | 2/4 |
| 0/0 | 4/4 |

ç§»è¡Œã®é€”ä¸­ã«ReadyãªPodæ•°ã®åˆè¨ˆãŒ`2` (`4 - 2`)ãªçŠ¶æ…‹ã‚’çµŒç”±ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

[ğŸ¥ asciinemaã§è¦‹ã‚‹(ReplicaSetã®`DESIRED`ã¨`READY`ã®æ•°å­—ã®æ¨ç§»ã«æ³¨ç›®ã—ã¦ãã ã•ã„)](https://asciinema.org/a/9QeGlebhdg1hwPFM9hlpwKmBw)

`replicas`ãŒ`4`ã®å ´åˆã§`maxUnavailable`ãŒ`0`ã¨`maxSurge`ãŒ`2`ã ã¨ã—ã¾ã™ã€‚
ãã®å ´åˆã¯ReadyçŠ¶æ…‹ãªPodæ•°ã¯æ¬¡ã®è¡¨ã®ã‚ˆã†ã«æ¨ç§»ã—ã¾ã™ã€‚(å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚„ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•é€Ÿåº¦ã«ã‚ˆã‚Šç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)

| æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Podæ•°(Ready/Desired) | æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Podæ•°(Ready/Desired) |
| - | - |
| 4/4 | 0/0 |
| 4/4 | 0/2 |
| 3/3 | 1/3 |
| 2/2 | 2/4 |
| 1/1 | 3/4 |
| 0/0 | 4/4 |

ç§»è¡Œä¸­ã‚‚ReadyãªPodæ•°ã®åˆè¨ˆãŒ`4`ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

[ğŸ¥ asciinemaã§è¦‹ã‚‹(ReplicaSetã®`DESIRED`ã¨`READY`ã®æ•°å­—ã®æ¨ç§»ã«æ³¨ç›®ã—ã¦ãã ã•ã„)](https://asciinema.org/a/AN50nYWbPyLfvHOkR3CkqkuV7)


ä¾‹ãˆã°`replicas`ãŒ`4`ã®å ´åˆã§`maxUnavailable`ãŒ`2`ã¨`maxSurge`ãŒ`2`ã ã¨ã—ã¾ã™ã€‚
ãã®å ´åˆã¯Podæ•°ã¯æ¬¡ã®è¡¨ã®ã‚ˆã†ã«æ¨ç§»ã—ã¾ã™ã€‚(å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚„ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•é€Ÿåº¦ã«ã‚ˆã‚Šç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)

| æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Podæ•°(Ready/Desired) | æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Podæ•°(Ready/Desired) |
| - | - |
| 4/4 | 0/0 |
| 2/2 | 0/4 |
| 1/1 | 1/4 |
| 0/0 | 2/4 |
| 0/0 | 4/4 |

[ğŸ¥ asciinemaã§è¦‹ã‚‹(ReplicaSetã®`DESIRED`ã¨`READY`ã®æ•°å­—ã®æ¨ç§»ã«æ³¨ç›®ã—ã¦ãã ã•ã„)](https://asciinema.org/a/O34TVEM3SWs6TL9seJhBnXh30)


#### Recreate

Recreateã®å ´åˆã€å…¨ã¦ã®Podã‚’åœæ­¢ã—ã¦ã‹ã‚‰å†ä½œæˆã—ã¾ã™ã€‚
ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã«è¦ã™ã‚‹æ™‚é–“ã¯çŸ­ãä½™åˆ†ãªãƒªã‚½ãƒ¼ã‚¹ã‚‚ä¸è¦ã§ã™ãŒã€ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãŒç™ºç”Ÿã—ã¾ã™ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-pks
spec:
  strategy:
    type: Recreate
  # ...
```

`replicas`ãŒ`4`ã®å ´åˆã€Podæ•°ã¯æ¬¡ã®è¡¨ã®ã‚ˆã†ã«æ¨ç§»ã—ã¾ã™ã€‚(å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚„ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•é€Ÿåº¦ã«ã‚ˆã‚Šç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)

| æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Podæ•°(Ready/Desired) | æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Podæ•°(Ready/Desired) |
| - | - |
| 4/4 | 0/0 |
| 0/0 | 0/0 |
| 0/0 | 0/4 |
| 0/0 | 2/4 |
| 0/0 | 4/4 |

[ğŸ¥ asciinemaã§è¦‹ã‚‹(ReplicaSetã®`DESIRED`ã¨`READY`ã®æ•°å­—ã®æ¨ç§»ã«æ³¨ç›®ã—ã¦ãã ã•ã„)](https://asciinema.org/a/4sfvpDgBYMPozyCUCCmSpsVKf)


---

ä»¥ä¸Šã®å†…å®¹ã‚’ã¾ã¨ã‚ã€`hello-pks.yml`ã‚’æ¬¡ã®ã‚ˆã†ã«ç·¨é›†ã—ã¦ãã ã•ã„ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-pks
spec:
  replicas: 4
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
  selector:
    matchLabels:
      app: hello-pks
  template:
    metadata:
      labels:
        app: hello-pks
    spec:
      containers:
      - image: making/hello-pks:0.0.2
        name: hello-pks
        ports:
        - containerPort: 8080
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: NODE_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 20
          timeoutSeconds: 1
          periodSeconds: 10
          failureThreshold: 1
```

`kubectl apply`ã§å¤‰æ›´ã‚’é©ç”¨ã—ã¦ãã ã•ã„ã€‚

```
kubectl apply -f hello-pks.yml
```
å‡ºåŠ›çµæœ
```
deployment "hello-pks" configured
```
