---
title: Tanzu Application Platformã®Workloadã‹ã‚‰HashiCorp Vaultä¸Šã®Secretã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
tags: ["Kubernetes", "Cartographer", "Tanzu", "TAP", "Vault"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP"]
---

Tanzu Application Platformã§ã¯Secretã‚’Service BindingçµŒç”±ã§è¨­å®šã—ã¦æ©Ÿå¯†æƒ…å ±ã‚’è¨­å®šã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã™ãŒã€K8sã®Secretã«æ©Ÿå¯†æƒ…å ±ã‚’ç½®ããŸããªã„ã¨ã„ã†å ´åˆã«
HashiCorp Vaultã‚’ä½¿ã„ãŸã„ã§ã™ã­ã€‚

K8sã‹ã‚‰Vaultã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯

* Vault Agent Injectorã‚’ä½¿ã†
* Container Storage Interface (CSI) Volumeã‚’ä½¿ã†
* [External Secrets Operator](https://external-secrets.io)ã‚’ä½¿ã†

ãŒã‚ã‚Šã¾ã™ãŒã€


* TAPã®Workloadã«CSI Volumeã®è¨­å®šã‚’ã™ã‚‹ã®ãŒhackãªã—ã§ã¯é›£ã—ã„
* External Secretsã¯Vaultã®Secretã‚’K8sã®Secretã«syncã™ã‚‹ã®ã§ã€K8sã®Secretã«æ©Ÿå¯†æƒ…å ±ã‚’ç½®ããŸããªã„ã¨ã„ã†ãƒ‹ãƒ¼ã‚ºã‚’æº€ãŸãªã•ãªã„

ã¨ã„ã†ã“ã¨ã§ã€Vault Agent Injectorã‚’ä½¿ã„ã¾ã™ã€‚

> Tanzu Application Platform 1.4ã§External SecretãŒå®Ÿé¨“çš„ã«ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
> https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/external-secrets-about-external-secrets-operator.html

ä»Šå›ã¯[ã“ã¡ã‚‰ã®è¨˜äº‹](https://ik.am/entries/716)ã§ä½œæˆã—ãŸKindä¸Šã®TAPã«Workloadã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã€Vaultä¸Šã«è¨­å®šã—ãŸSecretã‚’å‚ç…§ã•ã›ã¾ã™ã€‚


TAPã ã¨Multi Clusteræ§‹æˆãŒä¸€èˆ¬çš„ã§ã€Vaultã¯WorkloadãŒè¼‰ã‚‹Run Clusterã¨ã¯åˆ¥ã®å ´æ‰€ã§å‹•ãå¯èƒ½æ€§ãŒé«˜ã„ã®ã§ã€ä»Šå›ã¯æ—¢å­˜ã®Vaultã«å¯¾ã—ã¦Workloadã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-external-vault


**ç›®æ¬¡**
<!-- toc -->

### Vaultã®èµ·å‹•

K8sã‚¯ãƒ©ã‚¹ã‚¿å¤–ã§Vaultã‚’èµ·å‹•ã—ã¾ã™ã€‚ä»Šå›ã¯devãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã™ã€‚

```
vault server -dev -dev-root-token-id root -dev-listen-address 0.0.0.0:8200
```

### Vault Agent Injectorã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

TAPã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚¯ãƒ©ã‚¹ã‚¿ (Multi Clusteræ§‹æˆã®å ´åˆã¯Run Cluster) ã«Vault Agent Injectorã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

Helm Chartã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
helm repo add hashicorp https://helm.releases.hashicorp.com
helm repo update
```

`helm template`ã§ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚`injector.externalVaultAddr`ã«K8sã‚¯ãƒ©ã‚¹ã‚¿ã‹ã‚‰è¦‹ãŸVaultã®URLã‚’æŒ‡å®šã—ã¾ã™ã€‚

```
helm template vault hashicorp/vault -n vault --set "injector.externalVaultAddr=http://host.docker.internal:8200" > vault-agent-injector.yaml
kubectl create ns vault
kubectl apply -f vault-agent-injector.yaml -n vault
```

Podã‚’ç¢ºèªã€‚

```
$ kubectl get pod -n vault
NAME                                    READY   STATUS    RESTARTS   AGE
vault-agent-injector-547d8fc8db-kxtd7   1/1     Running   0          14s
```

### Kubernetes Auth Methodã®æœ‰åŠ¹åŒ–


Kubernetes Auth Methodã®æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚

```
vault auth enable kubernetes
```


Service Accountã«å¯¾ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚

```
kubectl apply -n vault -f -<<EOF
apiVersion: v1
kind: Secret
metadata:
  name: vault-token
  namespace: vault
  annotations:
    kubernetes.io/service-account.name: vault
type: kubernetes.io/service-account-token
EOF
```

Vaultã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹K8sã®æƒ…å ±ã‚’è¨­å®šã—ã¾ã™ã€‚

```
TOKEN_REVIEW_JWT=$(kubectl get secret -n vault vault-token -otemplate='{{index .data "token" | base64decode}}')
KUBE_CA_CERT=$(kubectl get secret -n vault vault-token -otemplate='{{index .data "ca.crt"| base64decode}}')
KUBE_HOST=$(kubectl config view --raw --minify --flatten --output='jsonpath={.clusters[].cluster.server}')

vault write auth/kubernetes/config \
     token_reviewer_jwt="$TOKEN_REVIEW_JWT" \
     kubernetes_host="$KUBE_HOST" \
     kubernetes_ca_cert="$KUBE_CA_CERT" \
     issuer="https://kubernetes.default.svc.cluster.local"
```

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®Secretã‚’ç™»éŒ²

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ https://github.com/making/vehicle-api ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹PostgreSQLã«ã¯ [ElephantSQL](https://www.elephantsql.com/) ã®free planã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

ElephantSQLã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æƒ…å ±ã‚’vehicle-apiç”¨ã®Secretã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚

```
vault kv put secret/vehicle-api/config \
  host='floppy.db.elephantsql.com' \
  username='ixyepwbw' \
  password='QIDpi7cBKioNGyp7JeN8ZMTL-rIWL_9B' \
  database='ixyepwbw'
```

ç™»éŒ²ã•ã‚ŒãŸæƒ…å ±ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ vault read secret/data/vehicle-api/config
Key         Value
---         -----
data        map[database:ixyepwbw host:floppy.db.elephantsql.com password:QIDpi7cBKioNGyp7JeN8ZMTL-rIWL_9B username:ixyepwbw]
metadata    map[created_time:2023-01-11T08:46:51.471224Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

ã“ã®Secretã«å¯¾ã™ã‚‹èª­ã¿å–ã‚Šå°‚ç”¨ã®Policyã‚’ä½œæˆã—ã¾ã™ã€‚

```
vault policy write vehicle-api - <<EOF
path "secret/data/vehicle-api/config" {
  capabilities = ["read"]
}
EOF
```

### Workloadã®ãƒ‡ãƒ—ãƒ­ã‚¤

Workloadã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€`demo` namespaceã®`default` Service Accountã«å¯¾ã™ã‚‹Roleã‚’ä½œæˆã—ã€å…ˆã«ä½œã£ãŸPolicyã‚’ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™ã€‚

```
vault write auth/kubernetes/role/vehicle-api \
     bound_service_account_names=default \
     bound_service_account_namespaces=demo \
     policies=vehicle-api \
     ttl=24h
```

ã“ã®Secretã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®annotationsã‚’Workloadã«è¨­å®šã—ã¾ã™ã€‚

Secretã®å†…å®¹ã‚’`/vault/secrets/application.properties`ã«æ›¸ãè¾¼ã¿ã€ã‚¢ãƒ—ãƒªã‹ã‚‰ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ç’°å¢ƒå¤‰æ•°`SPRING_CONFIG_IMPORT`ã‚’è¨­å®šã—ã¾ã™ã€‚

```
cat <<EOF > workload.yaml
apiVersion: carto.run/v1alpha1
kind: Workload
metadata:
  labels:
    app.kubernetes.io/part-of: vehicle-api
    apps.tanzu.vmware.com/workload-type: web
  name: vehicle-api
spec:
  params:
  - name: annotations
    value:
      autoscaling.knative.dev/minScale: '1'
      vault.hashicorp.com/agent-inject: 'true'
      vault.hashicorp.com/role: vehicle-api
      vault.hashicorp.com/agent-inject-secret-application.properties: secret/data/vehicle-api/config
      vault.hashicorp.com/agent-inject-template-application.properties: |
        {{- with secret "secret/data/vehicle-api/config" -}}
        spring.datasource.url=jdbc:postgresql://{{ .Data.data.host }}/{{ .Data.data.database }}
        spring.datasource.username={{ .Data.data.username }}
        spring.datasource.password={{ .Data.data.password }}
        {{- end -}}
  env:
  - name: SPRING_CONFIG_IMPORT
    value: /vault/secrets/application.properties
  source:
    git:
      url: https://github.com/making/vehicle-api
      ref:
        branch: main
EOF

tanzu apps workload apply -f workload.yaml -n demo
# or kubectl apply -f workload.yaml -n demo
```

> `vault.hashicorp.com/agent-inject-template-...`ã‚’`tanzu` CLIã®`--annotation`ã§è¨­å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>CLIã ã‘ã§Workloadã‚’ä½œæˆã™ã‚‹å ´åˆã¯æ¬¡ã®ã‚ˆã†ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æŒ‡å®šãŒå¿…è¦ã§ã™ã€‚
> 
> ```
> tanzu apps workload apply vehicle-api2 \
>   -n demo\
>   --git-repo https://github.com/making/vehicle-api \
>   --git-branch main \
>   --type web \
>   --app vehicle-api \
>   --env SPRING_CONFIG_IMPORT=/vault/secrets/application.properties \
>   --param-yaml annotation='{"autoscaling.knative.dev/minScale":"1","vault.hashicorp.com/agent-inject":"true","vault.hashicorp.com/agent-inject-secret-application.properties":"secret/data/vehicle-api/config","vault.hashicorp.com/agent-inject-template-application.properties":"{{- with secret \"secret/data/vehicle-api/config\" -}}\nspring.datasource.url=jdbc:postgresql://{{ .Data.data.host }}/{{ .Data.data.database }}\nspring.datasource.username={{ .Data.data.username }}\nspring.datasource.password={{ .Data.data.password }}\n{{- end -}}","vault.hashicorp.com/role":"vehicle-api"}' \
>   --param-yaml buildServiceBindings='[{"name": "settings-xml", "kind": "Secret"}]' \
> ```


ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¦ã€Workloadã‚’ç¢ºèªã—ã¾ã™ã€‚Podã«vault agentã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒå«ã¾ã‚Œã‚‹ã®ã§ã‚³ãƒ³ãƒ†ãƒŠæ•°ãŒ`3/3`ã«ãªã‚Šã¾ã™ã€‚

```
 $ tanzu apps workload get -n demo vehicle-api
ğŸ“¡ Overview
   name:   vehicle-api
   type:   web

ğŸ’¾ Source
   type:     git
   url:      https://github.com/making/vehicle-api
   branch:   main

ğŸ“¦ Supply Chain
   name:   source-to-url

   RESOURCE           READY   HEALTHY   TIME   OUTPUT
   source-provider    True    True      134m   GitRepository/vehicle-api
   image-provider     True    True      131m   Image/vehicle-api
   config-provider    True    True      131m   PodIntent/vehicle-api
   app-config         True    True      131m   ConfigMap/vehicle-api
   service-bindings   True    True      131m   ConfigMap/vehicle-api-with-claims
   api-descriptors    True    True      131m   ConfigMap/vehicle-api-with-api-descriptors
   config-writer      True    True      131m   Runnable/vehicle-api-config-writer

ğŸšš Delivery
   name:   delivery-basic

   RESOURCE          READY   HEALTHY   TIME   OUTPUT
   source-provider   True    True      130m   ImageRepository/vehicle-api-delivery
   deployer          True    True      130m   App/vehicle-api

ğŸ’¬ Messages
   No messages found.

ğŸ›¶ Pods
   NAME                                            READY   STATUS      RESTARTS   AGE
   vehicle-api-00001-deployment-7b6d9f7f49-rl25z   3/3     Running     0          30m
   vehicle-api-build-1-build-pod                   0/1     Completed   0          34m
   vehicle-api-config-writer-trr8r-pod             0/1     Completed   0          31m

ğŸš¢ Knative Services
   NAME          READY   URL
   vehicle-api   Ready   https://vehicle-api-demo.127-0-0-1.sslip.io

To see logs: "tanzu apps workload tail vehicle-api --namespace demo"
```


ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒå–ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ curl -sk https://vehicle-api-demo.127-0-0-1.sslip.io/vehicles
[{"id":1,"name":"Avalon"},{"id":2,"name":"Corolla"},{"id":3,"name":"Crown"},{"id":4,"name":"Levin"},{"id":5,"name":"Yaris"},{"id":6,"name":"Vios"},{"id":7,"name":"Glanza"},{"id":8,"name":"Aygo"}]
```


Vaultã‹ã‚‰å–å¾—ã—ãŸSecretãŒãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
POD_NAME=$(kubectl get pod -n demo -l serving.knative.dev/service=vehicle-api -ojsonpath='{.items[0].metadata.name}')
```

```
$ kubectl exec -it ${POD_NAME} -n demo -c workload -- ls -la /vault/secrets/
total 8
drwxrwxrwt 2 root root   60 Jan 11 09:14 .
drwxr-xr-x 3 root root 4096 Jan 11 09:14 ..
-rw-r--r-- 1 _apt cnb   170 Jan 11 09:14 application.properties
```

```
$ kubectl exec -it ${POD_NAME} -n demo -c workload -- cat /vault/secrets/application.properties
spring.datasource.url=jdbc:postgresql://floppy.db.elephantsql.com/ixyepwbw
spring.datasource.username=ixyepwbw
spring.datasource.password=QIDpi7cBKioNGyp7JeN8ZMTL-rIWL_9
```

Actuatorã®`env`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€å®Ÿéš›ã«ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¨­å®šãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
kubectl port-forward ${POD_NAME} -n demo 8081:8081
```


```
$ curl -s localhost:8081/actuator/env | jq .
{
  "activeProfiles": [],
  "propertySources": [
    {
      "name": "server.ports",
      "properties": {
        ...
      }
    },
    {
      "name": "servletContextInitParams",
      "properties": {}
    },
    {
      "name": "systemProperties",
      "properties": {
        ...
      }
    },
    {
      "name": "systemEnvironment",
      "properties": {
        ...
      }
    },
    {
      "name": "Config resource 'file [/vault/secrets/application.properties]' via location '/vault/secrets/application.properties'",
      "properties": {
        "spring.datasource.url": {
          "value": "jdbc:postgresql://floppy.db.elephantsql.com/ixyepwbw",
          "origin": "URL [file:/vault/secrets/application.properties] - 1:23"
        },
        "spring.datasource.username": {
          "value": "ixyepwbw",
          "origin": "URL [file:/vault/secrets/application.properties] - 2:28"
        },
        "spring.datasource.password": {
          "value": "******",
          "origin": "URL [file:/vault/secrets/application.properties] - 3:28"
        }
      }
    },
    {
      "name": "Config resource 'class path resource [application.properties]' via location 'optional:classpath:/'",
      "properties": {
        ...
      }
    }
  ]
}
```

---

TAPã‹ã‚‰Vaultã«ã§ãã¾ã—ãŸã€‚K8sã®Secretã‚’ä½¿ã†ã“ã¨ãªãã€TAPã‹ã‚‰æ©Ÿå¯†æƒ…å ±ã‚’å–å¾—ã§ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚
