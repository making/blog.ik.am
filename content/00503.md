---
title: Spring WebFlux.fnãƒãƒ³ã‚ºã‚ªãƒ³ - 4. R2DBCã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹
tags: ["Spring WebFlux.fn Handson", "Reactor", "Reactor Netty", "Netty", "Spring 5", "Spring WebFlux", "Java", "Cloud Foundry", "Pivotal Web Services", "Pivotal Cloud Foundry", "R2DBC"]
categories: ["Programming", "Java", "org", "springframework", "web", "reactive"]
updated: 1970-01-01T09:00:00+09:00
---

æœ¬ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã€æ¬¡ã®å›³ã®ã‚ˆã†ãªç°¡æ˜“å®¶è¨ˆç°¿ã®APIã‚µãƒ¼ãƒãƒ¼ã‚’Spring WebFlux.fnã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¾ã™ã€‚
ã‚ãˆã¦Spring Bootã‚‚Dependency Injectionã‚‚ä½¿ã‚ãªã„ã‚·ãƒ³ãƒ—ãƒ«ãªWebã‚¢ãƒ—ãƒªã¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚

**ãƒãƒ³ã‚ºã‚ªãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„**

1. [ã¯ã˜ã‚ã«](/entries/500)
1. [ç°¡æ˜“å®¶è¨ˆç°¿Moneygerãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ](/entries/501)
1. [YAVIã«ã‚ˆã‚‹Validationã®å®Ÿè£…](/entries/502)
1. [R2DBCã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹](/entries/503) ğŸ‘ˆ
1. [Web UIã®è¿½åŠ ](/entries/504)
1. [ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„](/entries/505)
1. [åå…¥APIã®å®Ÿè£…](/entries/506)
1. [Spring Bootã‚¢ãƒ—ãƒªã«å¤‰æ›](/entries/507)
1. [GraalVMã®SubstrateVMã§Native Imageã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«](/entries/510)

**ç›®æ¬¡**
<!-- toc -->

### R2DBCã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹

æ¬¡ã¯[R2DBC](https://r2dbc.io)ã‚’ç”¨ã„ã¦`ExpenditureBuilderRepository`ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿè£…ã‚’ä½œæˆã—ã¾ã™ã€‚

`pom.xml`ã«æ¬¡ã®`dependency`ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```xml
        <dependency>
            <groupId>org.springframework.data</groupId>
            <artifactId>spring-data-r2dbc</artifactId>
            <version>1.0.0.BUILD-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>io.r2dbc</groupId>
            <artifactId>r2dbc-h2</artifactId>
        </dependency>
        <dependency>
            <groupId>io.r2dbc</groupId>
            <artifactId>r2dbc-postgresql</artifactId>
        </dependency>
```

`R2dbcExpenditureRepository`ã‚’ä½œæˆã—ã¦æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

**TODOéƒ¨åˆ†ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„**ã€‚å‹•ä½œã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã«ç¶šãã¾ã™ã€‚TODOã‚’å®Ÿè£…ã™ã‚‹å‰ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã„ã€‚

* [å‚è€ƒè³‡æ–™](https://docs.spring.io/spring-data/r2dbc/docs/1.0.0.BUILD-SNAPSHOT/reference/html/#r2dbc.datbaseclient.queries)


```java
package com.example.expenditure;

import org.springframework.data.r2dbc.core.DatabaseClient;
import org.springframework.transaction.reactive.TransactionalOperator;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import static org.springframework.data.r2dbc.query.Criteria.where;

public class R2dbcExpenditureRepository implements ExpenditureRepository {

    private final DatabaseClient databaseClient;

    private final TransactionalOperator tx;

    public R2dbcExpenditureRepository(DatabaseClient databaseClient, TransactionalOperator tx) {
        this.databaseClient = databaseClient;
        this.tx = tx;
    }

    @Override
    public Flux<Expenditure> findAll() {
        return this.databaseClient.select().from(Expenditure.class)
            .as(Expenditure.class)
            .all();
    }

    @Override
    public Mono<Expenditure> findById(Integer expenditureId) {
        // TODO
        // "expenditure_id"ãŒå¼•æ•°ã®expenditureIdã«ä¸€è‡´ã™ã‚‹1ä»¶ã®Expenditureã‚’è¿”ã™
        return Mono.empty();
    }

    @Override
    public Mono<Expenditure> save(Expenditure expenditure) {
        return this.databaseClient.insert().into(Expenditure.class)
            .using(expenditure)
            .fetch()
            .one()
            .map(map -> new ExpenditureBuilder(expenditure)
                .withExpenditureId((Integer) map.get("expenditure_id"))
                .build())
            .as(this.tx::transactional);
    }

    @Override
    public Mono<Void> deleteById(Integer expenditureId) {
        return this.databaseClient.delete().from(Expenditure.class)
            .matching(where("expenditure_id").is(expenditureId))
            .then()
            .as(this.tx::transactional);
    }
}
```

`App.java`ã«æ¬¡ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚


```java
    static ConnectionFactory connectionFactory() {
        // postgresql://username:password@hostname:5432/dbname
        String databaseUrl = Optional.ofNullable(System.getenv("DATABASE_URL")).orElse("h2:file:///./target/demo?options=DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE");
        return ConnectionFactories.get("r2dbc:" + databaseUrl);
    }

    public static Mono<Void> initializeDatabase(String name, DatabaseClient databaseClient) {
        if ("H2".equals(name)) {
            return databaseClient.execute("CREATE TABLE IF NOT EXISTS expenditure (expenditure_id INT PRIMARY KEY AUTO_INCREMENT, expenditure_name VARCHAR(255), unit_price INT NOT NULL, quantity INT NOT NULL, expenditure_date DATE NOT NULL)")
                .then();
        } else if ("PostgreSQL".equals(name)) {
            return databaseClient.execute("CREATE TABLE IF NOT EXISTS expenditure (expenditure_id SERIAL PRIMARY KEY, expenditure_name VARCHAR(255), unit_price INT NOT NULL, quantity INT NOT NULL, expenditure_date DATE NOT NULL)")
                .then();
        }
        return Mono.error(new IllegalStateException(name + " is not supported."));
    }
```

ã¾ãŸã€`routes`ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```java
    static RouterFunction<ServerResponse> routes() {
        final ConnectionFactory connectionFactory = connectionFactory();
        final DatabaseClient databaseClient = DatabaseClient.builder()
            .connectionFactory(connectionFactory)
            .build();
        final TransactionalOperator transactionalOperator = TransactionalOperator.create(new R2dbcTransactionManager(connectionFactory));

        initializeDatabase(connectionFactory.getMetadata().getName(), databaseClient).subscribe();

        return new ExpenditureHandler(new R2dbcExpenditureRepository(databaseClient, transactionalOperator)).routes();
    }
```

`src/test/java/com/example/expenditure`ã«`R2dbcExpenditureRepositoryTest`ã‚’ä½œæˆã—ã¦ã€æ¬¡ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

```java
package com.example.expenditure;

import com.example.App;
import io.r2dbc.spi.ConnectionFactories;
import io.r2dbc.spi.ConnectionFactory;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.data.r2dbc.connectionfactory.R2dbcTransactionManager;
import org.springframework.data.r2dbc.core.DatabaseClient;
import org.springframework.transaction.reactive.TransactionalOperator;
import reactor.core.publisher.Flux;
import reactor.test.StepVerifier;

import java.time.LocalDate;
import java.util.Arrays;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;

class R2dbcExpenditureRepositoryTest {

    R2dbcExpenditureRepository expenditureRepository;

    DatabaseClient databaseClient;

    TransactionalOperator transactionalOperator;

    private List<Expenditure> fixtures = Arrays.asList(
        new ExpenditureBuilder()
            .withExpenditureName("æœ¬")
            .withUnitPrice(2000)
            .withQuantity(1)
            .withExpenditureDate(LocalDate.of(2019, 4, 1))
            .build(),
        new ExpenditureBuilder()
            .withExpenditureName("ã‚³ãƒ¼ãƒ’ãƒ¼")
            .withUnitPrice(300)
            .withQuantity(2)
            .withExpenditureDate(LocalDate.of(2019, 4, 2))
            .build());

    @BeforeAll
    void init() {
        final ConnectionFactory connectionFactory = ConnectionFactories.get("r2dbc:h2:mem:///test?options=DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE");
        this.databaseClient = DatabaseClient.builder()
            .connectionFactory(connectionFactory)
            .build();
        this.transactionalOperator = TransactionalOperator.create(new R2dbcTransactionManager(connectionFactory));
        this.expenditureRepository = new R2dbcExpenditureRepository(this.databaseClient, transactionalOperator);
        App.initializeDatabase("H2", this.databaseClient).block();
    }

    @BeforeEach
    void each() throws Exception {
        this.databaseClient.execute("TRUNCATE TABLE expenditure")
            .then()
            .thenMany(Flux.fromIterable(this.fixtures)
                .flatMap(expenditure -> this.databaseClient.insert()
                    .into(Expenditure.class)
                    .using(expenditure)
                    .then())
                .as(transactionalOperator::transactional))
            .blockLast();
    }

    @Test
    void findAll() {
        StepVerifier.create(this.expenditureRepository.findAll())
            .consumeNextWith(expenditure -> {
                assertThat(expenditure.getExpenditureId()).isNotNull();
                assertThat(expenditure.getExpenditureName()).isEqualTo("æœ¬");
                assertThat(expenditure.getUnitPrice()).isEqualTo(2000);
                assertThat(expenditure.getQuantity()).isEqualTo(1);
                assertThat(expenditure.getExpenditureDate()).isEqualTo(LocalDate.of(2019, 4, 1));
            })
            .consumeNextWith(expenditure -> {
                assertThat(expenditure.getExpenditureId()).isNotNull();
                assertThat(expenditure.getExpenditureName()).isEqualTo("ã‚³ãƒ¼ãƒ’ãƒ¼");
                assertThat(expenditure.getUnitPrice()).isEqualTo(300);
                assertThat(expenditure.getQuantity()).isEqualTo(2);
                assertThat(expenditure.getExpenditureDate()).isEqualTo(LocalDate.of(2019, 4, 2));
            })
            .verifyComplete();
    }

    @Test
    void findById() {
        Integer expenditureId = this.databaseClient.execute("SELECT expenditure_id FROM expenditure WHERE expenditure_name = :expenditure_name")
            .bind("expenditure_name", "æœ¬")
            .map((row, rowMetadata) -> row.get("expenditure_id", Integer.class))
            .one()
            .block();

        StepVerifier.create(this.expenditureRepository.findById(expenditureId))
            .consumeNextWith(expenditure -> {
                assertThat(expenditure.getExpenditureId()).isNotNull();
                assertThat(expenditure.getExpenditureName()).isEqualTo("æœ¬");
                assertThat(expenditure.getUnitPrice()).isEqualTo(2000);
                assertThat(expenditure.getQuantity()).isEqualTo(1);
                assertThat(expenditure.getExpenditureDate()).isEqualTo(LocalDate.of(2019, 4, 1));
            })
            .verifyComplete();
    }

    @Test
    void findById_Empty() {
        Integer latestId = this.databaseClient.execute("SELECT MAX(expenditure_id) AS max FROM expenditure")
            .map((row, rowMetadata) -> row.get("max", Integer.class))
            .one()
            .block();

        StepVerifier.create(this.expenditureRepository.findById(latestId + 1))
            .verifyComplete();
    }

    @Test
    void save() {
        Integer latestId = this.databaseClient.execute("SELECT MAX(expenditure_id) AS max FROM expenditure")
            .map((row, rowMetadata) -> row.get("max", Integer.class))
            .one()
            .block();

        Expenditure create = new ExpenditureBuilder()
            .withExpenditureName("ãƒ“ãƒ¼ãƒ«")
            .withUnitPrice(250)
            .withQuantity(1)
            .withExpenditureDate(LocalDate.of(2019, 4, 3))
            .build();

        StepVerifier.create(this.expenditureRepository.save(create))
            .consumeNextWith(expenditure -> {
                assertThat(expenditure.getExpenditureId()).isGreaterThan(latestId);
                assertThat(expenditure.getExpenditureName()).isEqualTo("ãƒ“ãƒ¼ãƒ«");
                assertThat(expenditure.getUnitPrice()).isEqualTo(250);
                assertThat(expenditure.getQuantity()).isEqualTo(1);
                assertThat(expenditure.getExpenditureDate()).isEqualTo(LocalDate.of(2019, 4, 3));
            })
            .verifyComplete();
    }

    @Test
    void deleteById() {
        Integer expenditureId = this.databaseClient.execute("SELECT expenditure_id FROM expenditure WHERE expenditure_name = :expenditure_name")
            .bind("expenditure_name", "æœ¬")
            .map((row, rowMetadata) -> row.get("expenditure_id", Integer.class))
            .one()
            .block();

        StepVerifier.create(this.expenditureRepository.deleteById(expenditureId))
            .verifyComplete();

        StepVerifier.create(this.expenditureRepository.findById(expenditureId))
            .verifyComplete();
    }
}
```

TODOã‚’å®Ÿè£…ã—ãªã„ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«`findById`ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã™ã€‚

![image](https://user-images.githubusercontent.com/106908/58765856-374d5a80-85b2-11e9-86e0-b3ec15d40b0a.png)

TODOã‚’å®Ÿè£…ã—ã¦ã€å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸã‚‰ã€`App`ã‚¯ãƒ©ã‚¹ã®`main`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã€æ­£ã—ããƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ curl localhost:8080/expenditures -d "{\"expenditureName\":\"ã‚³ãƒ¼ãƒ’ãƒ¼\",\"unitPrice\":300,\"quantity\":1,\"expenditureDate\":\"2019-06-03\"}" -H "Content-Type: application/json"
{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":"2019-06-03"}
```

```
$ curl localhost:8080/expenditures
[{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":"2019-06-03"}]
```

```
$ curl localhost:8080/expenditures/1
{"expenditureId":1,"expenditureName":"ã‚³ãƒ¼ãƒ’ãƒ¼","unitPrice":300,"quantity":1,"expenditureDate":"2019-06-03"}
```

```
$ curl -XDELETE localhost:8080/expenditures/1
```

```
$ curl localhost:8080/expenditures
[]
```

> SQLãƒ­ã‚°ã‚’ç¢ºèªã—ãŸã„å ´åˆã¯`logback.xml`ã«æ¬¡ã®è¨­å®šã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
>
> ```xml
>     <logger name="org.springframework.data.r2dbc.core.DefaultDatabaseClient" level="DEBUG" />
> ```

<details>
  <summary><code>R2dbcExpenditureRepository</code>ã®æ­£è§£ä¾‹</summary>

```java
package com.example.expenditure;

import org.springframework.data.r2dbc.core.DatabaseClient;
import org.springframework.transaction.reactive.TransactionalOperator;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import static org.springframework.data.r2dbc.query.Criteria.where;

public class R2dbcExpenditureRepository implements ExpenditureRepository {

    private final DatabaseClient databaseClient;

    private final TransactionalOperator tx;

    public R2dbcExpenditureRepository(DatabaseClient databaseClient, TransactionalOperator tx) {
        this.databaseClient = databaseClient;
        this.tx = tx;
    }

    @Override
    public Flux<Expenditure> findAll() {
        return this.databaseClient.select().from(Expenditure.class)
            .as(Expenditure.class)
            .all();
    }

    @Override
    public Mono<Expenditure> findById(Integer expenditureId) {
        return this.databaseClient.select().from(Expenditure.class)
            .matching(where("expenditure_id").is(expenditureId))
            .as(Expenditure.class)
            .one();
    }

    @Override
    public Mono<Expenditure> save(Expenditure expenditure) {
        return this.databaseClient.insert().into(Expenditure.class)
            .using(expenditure)
            .fetch()
            .one()
            .map(map -> new ExpenditureBuilder(expenditure)
                .withExpenditureId((Integer) map.get("expenditure_id"))
                .build())
            .as(this.tx::transactional);
    }

    @Override
    public Mono<Void> deleteById(Integer expenditureId) {
        return this.databaseClient.delete().from(Expenditure.class)
            .matching(where("expenditure_id").is(expenditureId))
            .then()
            .as(this.tx::transactional);
    }
}
```

</details>

#### Cloud Foundryã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

Pivotal Web Servicesã§PostgreSQLã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã€‚`cf create-service`ã‚³ãƒãƒ³ãƒ‰ã§`moneyger-db`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```
cf create-service elephantsql turtle moneyger-db
```

`manifest.yml`ã‚‚æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

```yaml
applications:
- name: moneyger
  path: target/moneyger-1.0.0-SNAPSHOT.jar
  memory: 128m
  env:
    JAVA_OPTS: '-XX:ReservedCodeCacheSize=22M -XX:MaxDirectMemorySize=22M -XX:MaxMetaspaceSize=54M -Xss512K'
    JBP_CONFIG_OPEN_JDK_JRE: '[memory_calculator: {stack_threads: 30}]'
  services:
  - moneyger-db
```

ãƒ“ãƒ«ãƒ‰ã—ã¦`cf push`ã—ã¦ãã ã•ã„ã€‚

```
./mvnw clean package -DskipTests=true
cf push
```

æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã€æ­£ã—ããƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
curl https://moneyger-<CHANGE ME>.cfapps.io/expenditures -d "{\"expenditureName\":\"ã‚³ãƒ¼ãƒ’ãƒ¼\",\"unitPrice\":300,\"quantity\":1,\"expenditureDate\":\"2019-06-03\"}" -H "Content-Type: application/json"
cf restart moneyger
curl https://moneyger-<CHANGE ME>.cfapps.io/expenditures/1
```

"Kubernetesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤"ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆã¯ã€[ã“ã¡ã‚‰](#Connection%20Pool%E3%81%AE%E8%A8%AD%E5%AE%9A)ã¸é€²ã‚“ã§ãã ã•ã„ã€‚

#### Kubernetesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

Cloud Foundryã‚’ä½¿ã†äººã¯ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚

##### Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä½œæˆ

ã¾ãšã¯Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚

```
$ pack build <image-name> --builder cloudfoundry/cnb:bionic --publish

# ä¾‹: pack build making/moneyger --builder cloudfoundry/cnb:bionic --publish
```

ã¾ãŸã¯

```
$ ./mvnw clean package -DskipTests=true
$ pack build <image-name> -p target/moneyger-1.0.0-SNAPSHOT.jar --builder cloudfoundry/cnb:bionic --publish

# ä¾‹: pack build making/moneyger -p target/moneyger-1.0.0-SNAPSHOT.jar --builder cloudfoundry/cnb:bionic --publish
```

ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

##### PostgreSQLã®ãƒ‡ãƒ—ãƒ­ã‚¤

PostgreSQLã‚’Kubernetesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
`moneyger-db.yml`ã‚’ä½œæˆã—ã¦ã€æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: moneyger-db
  namespace: moneyger
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1G
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: moneyger-db
  namespace: moneyger
spec:
  selector:
    matchLabels:
      app: moneyger-db
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: moneyger-db
    spec:
      initContainers:
      - name: remove-lost-found
        image: busybox
        command:          
        - sh
        - -c
        - |
          rm -fr /var/lib/postgresql/data/lost+found
        volumeMounts:
        - name: moneyger-db
          mountPath: /var/lib/postgresql/data
      containers:
      - image: postgres:11.5
        name: postgres
        env:
        - name: POSTGRES_INITDB_ARGS
          value: "--encoding=UTF-8 --locale=C"
        - name: POSTGRES_DB
          valueFrom:
            secretKeyRef:
              name: moneyger-db
              key: postgres-db
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: moneyger-db
              key: postgres-user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: moneyger-db
              key: postgres-password
        ports:
        - containerPort: 5432
          name: moneyger-db
        volumeMounts:
        - name: moneyger-db
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: moneyger-db
        persistentVolumeClaim:
          claimName: moneyger-db
---
apiVersion: v1
kind: Service
metadata:
  name: moneyger-db
  namespace: moneyger
spec:
  ports:
  - port: 5432
  selector:
    app: moneyger-db
  clusterIP: None
```

PostgreSQLã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’`Secret`ã«ä½œæˆã™ã‚‹ãŸã‚ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```
kubectl -n moneyger create secret generic moneyger-db \
  --dry-run -o yaml \
  --from-literal postgres-user=moneyger \
  --from-literal postgres-password=moneyger \
  --from-literal postgres-db=moneyger \
  > moneyger-db-secret.yml
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§PostgreSQLã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

```
kubectl apply -f moneyger-db.yml -f moneyger-db-secret.yml
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€`moneyger-db-*****`ã¨ã„ã†åå‰ã®Podã®`STATUS`ãŒ`Runing` ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ kubectl get -n moneyger all
NAME                               READY   STATUS    RESTARTS   AGE
pod/moneyger-59c9b56d7-ddkdn       1/1     Running   0          5h3m
pod/moneyger-db-77f767f6d5-nfwc8   1/1     Running   0          34m

NAME                  TYPE           CLUSTER-IP       EXTERNAL-IP                                                                    PORT(S)          AGE
service/moneyger      LoadBalancer   10.100.200.144   a812e3e18c7e511e99cb7066f53a5a1a-1913282802.ap-northeast-1.elb.amazonaws.com   8080:31684/TCP   5h3m
service/moneyger-db   ClusterIP      None             <none>                                                                         5432/TCP         34m

NAME                          READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/moneyger      1/1     1            1           5h3m
deployment.apps/moneyger-db   1/1     1            1           34m

NAME                                     DESIRED   CURRENT   READY   AGE
replicaset.apps/moneyger-5779d966cb      1         1         1       5h3m
replicaset.apps/moneyger-db-77f767f6d5   1         1         1       34m
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦PostgreSQLã®å‹•ä½œç¢ºèªã‚’ã—ã¦ãã ã•ã„ã€‚

```
$ kubectl run -it --rm --image=postgres:11.5 --generator=run-pod/v1 --restart=Never --env="PGPASSWORD=moneyger" psql -- psql -h moneyger-db.moneyger.svc.cluster.local -U moneyger -d moneyger -c '\l'
                             List of databases
   Name    |  Owner   | Encoding | Collate | Ctype |   Access privileges   
-----------+----------+----------+---------+-------+-----------------------
 moneyger  | moneyger | UTF8     | C       | C     | 
 postgres  | moneyger | UTF8     | C       | C     | 
 template0 | moneyger | UTF8     | C       | C     | =c/moneyger          +
           |          |          |         |       | moneyger=CTc/moneyger
 template1 | moneyger | UTF8     | C       | C     | =c/moneyger          +
           |          |          |         |       | moneyger=CTc/moneyger
```

##### Moneygerã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

`moneyger.yml`ã‚’æ¬¡ã®ã‚ˆã†ã«æ›´æ–°ã—ã¾ã™ã€‚PostgreSQLã®æ¥ç¶šæƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¾ã™ã€‚

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: moneyger
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: moneyger
  namespace: moneyger
spec:
  replicas: 1
  selector:
    matchLabels:
      app: moneyger
  template:
    metadata:
      labels:
        app: moneyger
    spec:
      containers:
      - image: <image-name>:latest
        # ä¾‹: 
        # image: making/moneyger:latest
        name: moneyger
        ports:
        - containerPort: 8080
        env:
        - name: _JAVA_OPTIONS
          value: "-Xmx15m -XX:ReservedCodeCacheSize=22M -XX:MaxDirectMemorySize=22M -XX:MaxMetaspaceSize=54M -Xss512K"
        ## ã“ã“ã‹ã‚‰è¿½åŠ 
        - name: POSTGRES_DB
          valueFrom:
            secretKeyRef:
              name: moneyger-db
              key: postgres-db
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: moneyger-db
              key: postgres-user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: moneyger-db
              key: postgres-password
        - name: DATABASE_URL
          value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@moneyger-db.moneyger.svc.cluster.local:5432/$(POSTGRES_DB)"
        ## ã“ã“ã¾ã§è¿½åŠ 
        resources:
          limits:
            memory: "128Mi"
          requests:
            memory: "128Mi"
        readinessProbe:
          httpGet:
            path: /expenditures
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
          periodSeconds: 5
---
kind: Service
apiVersion: v1
metadata:
  name: moneyger
  namespace: moneyger
spec:
  type: LoadBalancer
  selector:
    app: moneyger
  ports:
  - protocol: TCP
    port: 8080
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§å¤‰æ›´ã‚’åæ˜ ã—ã¦ãã ã•ã„ã€‚

```
kubectl apply -f moneyger.yml
```

#### Connection Poolã®è¨­å®š

ä»Šå›Pivotal Web Servicesã§ä½¿ç”¨ã—ãŸPostgreSQLã‚µãƒ¼ãƒ“ã‚¹ã¯ç„¡æ–™ãƒ—ãƒ©ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€åŒæ™‚æ¥ç¶šæ•°ãŒ4ã¨ã„ã†åˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚
ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã§ã¯5ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ä»¥ä¸ŠåŒæ™‚ã«æ¥ç¶šã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

Connection Poolã‚’è¨­å®šã—ã€æœ€å¤§Poolæ•°ã‚’4ã«ã™ã‚‹ã“ã¨ã§ã‚¨ãƒ©ãƒ¼ã‚’é˜²ãã¾ã™ã€‚

`pom.xml`ã«æ¬¡ã®`dependency`ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```xml
        <dependency>
            <groupId>io.r2dbc</groupId>
            <artifactId>r2dbc-pool</artifactId>
        </dependency>
```

`App.java`ã«æ¬¡ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```java
    static ConnectionPool connectionPool(ConnectionFactory connectionFactory) {
        return new ConnectionPool(ConnectionPoolConfiguration.builder(connectionFactory)
            .initialSize(4)
            .maxSize(4)
            .maxIdleTime(Duration.ofSeconds(3))
            .validationQuery("SELECT 1")
            .build());
    }
```

`routes`ãƒ¡ã‚½ãƒƒãƒ‰ã®æ¬¡ã®ç®‡æ‰€ã‚’ã€


```java
    static RouterFunction<ServerResponse> routes() {
        final ConnectionFactory connectionFactory = connectionFactory();
        // ...
    }
```

æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```java
    static RouterFunction<ServerResponse> routes() {
        final ConnectionFactory connectionFactory = connectionPool(connectionFactory());
        // ...
    }
```

Cloud Foundryã®å ´åˆã¯ã€ãƒ“ãƒ«ãƒ‰ã—ã¦`cf push`ã—ã¦ãã ã•ã„ã€‚

```
./mvnw clean package -DskipTests=true
cf push
```

[`wrk`](https://github.com/wg/wrk)ã‚³ãƒãƒ³ãƒ‰ã§è² è·ã‚’ã‹ã‘ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

```
wrk -t32 -c100 -d60s --latency --timeout 30s https://moneyger-<CHANGE ME>.cfapps.io/expenditures
```

```
Running 1m test @ https://moneyger-chatty-zebra.cfapps.io/expenditures
  32 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   266.43ms  121.88ms   1.41s    88.77%
    Req/Sec    12.60      5.94    30.00     57.44%
  Latency Distribution
     50%  223.84ms
     75%  292.53ms
     90%  404.77ms
     99%  745.04ms
  21965 requests in 1.00m, 6.37MB read
Requests/sec:    365.52
Transfer/sec:    108.51KB
```

Kubernetesã®å ´åˆã¯ã€

```
$ pack build <image-name> --builder cloudfoundry/cnb:bionic --publish

# ä¾‹: pack build making/moneyger --builder cloudfoundry/cnb:bionic --publish
```

ã¾ãŸã¯

```
$ ./mvnw clean package -DskipTests=true
$ pack build <image-name> -p target/moneyger-1.0.0-SNAPSHOT.jar --builder cloudfoundry/cnb:bionic --publish

# ä¾‹: pack build making/moneyger -p target/moneyger-1.0.0-SNAPSHOT.jar --builder cloudfoundry/cnb:bionic --publish
```

ã‚’å®Ÿè¡Œã—ã¦Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

`moneyger.yml`ã§ä½¿ç”¨ã™ã‚‹Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç¢ºå®Ÿã«æ›´æ–°ã™ã‚‹ãŸã‚ã«ã€

```yaml
image: <image-name>:latest
```
ã®éƒ¨åˆ†ã‚’

```yaml
image: <image-name>@sha256:<image-digest>
```

å½¢å¼ã«ã—ã¦ãã ã•ã„ã€‚

`<image-digest>`ã®å€¤ã¯`pack`ã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ›ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚

ä¾‹ãˆã°ã€æ¬¡ã®å‡ºåŠ›ã®å ´åˆã€`image`ã«è¨­å®šã™ã‚‹å€¤ã¯`making/moneyger@sha256:c0bac5367237f5c1a7989ca7bc21c574d890829f162caace81fc72897221e2f7`ã§ã™ã€‚

```
===> EXPORTING  
[exporter] Reusing layers from image 'index.docker.io/making/moneyger@sha256:b1c8bd34de9eb1993e836191908e1cb6468d08fe9ac1546bec4ce5712b932243'
[exporter] Exporting layer 'app' with SHA sha256:bad05a602ca8572ebf90aff7405c7b8ca12ca47df74ccbca381034f2da1026ef
[exporter] Exporting layer 'config' with SHA sha256:332c6f162dbfa1df40280262e08279deb0ec17876cdfd86bdd84d188110e3c77
[exporter] Reusing layer 'launcher' with SHA sha256:2187c4179a3ddaae0e4ad2612c576b3b594927ba15dd610bbf720197209ceaa6
[exporter] Reusing layer 'org.cloudfoundry.openjdk:openjdk-jre' with SHA sha256:9c84525dcbc758ce1754cce9b8f4d59f5ea6cf103a6c47043d900cad838052da
[exporter] Reusing layer 'org.cloudfoundry.jvmapplication:executable-jar' with SHA sha256:3d9310c8403c8710b6adcd40999547d6dc790513c64bba6abc7a338b429c35d2
[exporter] Exporting layer 'org.cloudfoundry.springboot:spring-boot' with SHA sha256:f8df93a1fec49ede0909fda3631f3a08d04a6ae947494deae4c73b98266ec2f3
[exporter] Reusing layer 'org.cloudfoundry.springautoreconfiguration:auto-reconfiguration' with SHA sha256:f61d2b65c75f9f5f2f2185fccb0be37ec39535bf89975c1632291f5116720479
[exporter] *** Images:
[exporter]       index.docker.io/making/moneyger:latest - succeeded
[exporter] 
[exporter] *** Digest: sha256:c0bac5367237f5c1a7989ca7bc21c574d890829f162caace81fc72897221e2f7
```

`moneyger.yml`ã‚’æ›´æ–°ã—ãŸã‚‰æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§æ›´æ–°ã‚’åæ˜ ã—ã¦ãã ã•ã„ã€‚

```
kubectl apply -f moneyger.yml
```

[`kbld`](https://get-kbld.io)ã‚’ä½¿ã†ã¨ã€`<image-digest>`ã‚’æ›´æ–°ã™ã‚‹ä½œæ¥­ã‚’æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§è‡ªå‹•åŒ–ã§ãã¾ã™ã€‚

```
kbld -f moneyger.yml | kubectl apply -f - 
```

æ¬¡ã®ç« ã§ã‚‚åˆ©ç”¨ã™ã‚‹ã®ã§[ã“ã¡ã‚‰](https://github.com/k14s/kbld/releases)ã‹ã‚‰ãƒã‚¤ãƒŠãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦`kbld`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
