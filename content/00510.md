---
title: Spring WebFlux.fnãƒãƒ³ã‚ºã‚ªãƒ³ - X. GraalVMã®SubstrateVMã§Native Imageã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
tags: ["Spring WebFlux.fn Handson", "Reactor", "Reactor Netty", "Netty", "Spring 5", "Spring WebFlux", "Spring Boot", "Java", "Cloud Foundry", "Pivotal Web Services", "Pivotal Cloud Foundry", "GraalVM"]
categories: ["Programming", "Java", "org", "springframework", "web", "reactive"]
updated: 1970-01-01T09:00:00+09:00
---

æœ¬ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã€æ¬¡ã®å›³ã®ã‚ˆã†ãªç°¡æ˜“å®¶è¨ˆç°¿ã®APIã‚µãƒ¼ãƒãƒ¼ã‚’Spring WebFlux.fnã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¾ã™ã€‚
ã‚ãˆã¦Spring Bootã‚‚Dependency Injectionã‚‚ä½¿ã‚ãªã„ã‚·ãƒ³ãƒ—ãƒ«ãªWebã‚¢ãƒ—ãƒªã¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚

**ãƒãƒ³ã‚ºã‚ªãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„**

1. [ã¯ã˜ã‚ã«](/entries/500)
1. [ç°¡æ˜“å®¶è¨ˆç°¿Moneygerãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ](/entries/501)
1. [YAVIã«ã‚ˆã‚‹Validationã®å®Ÿè£…](/entries/502)
1. [R2DBCã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹](/entries/503)
1. [Web UIã®è¿½åŠ ](/entries/504)
1. [ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„](/entries/505)
1. [åå…¥APIã®å®Ÿè£…](/entries/506)
1. [Spring Bootã‚¢ãƒ—ãƒªã«å¤‰æ›](/entries/507)
1. [GraalVMã®SubstrateVMã§Native Imageã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«](/entries/510) ğŸ‘ˆ

> ã“ã®ç« ã§ã¯Spring Bootã‚¢ãƒ—ãƒªã«**å¤‰æ›å‰**ã®çŠ¶æ…‹ã§è¡Œãªã£ã¦ãã ã•ã„ã€‚

ã‹ãªã‚Šãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°ã§ã™ãŒã€ã“ã“ã¾ã§ä½œã£ãŸã‚¢ãƒ—ãƒªã‚’GraalVMã®SubstrateVMã§Native Imageã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã¿ã¾ã™ã€‚

> âš ï¸ 2019-09-05æ™‚ç‚¹ã§ã€GraalVM Version 19.2.0 CEã§å‹•ä½œç¢ºèªã—ã¦ã„ã¾ã™ãŒã€<br>
> ä»Šåº¦ã‚‚å‹•ä½œã™ã‚‹ä¿è¨¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"ã¨ã‚Šã‚ãˆãšå‹•ã„ãŸ"ãƒ¬ãƒ™ãƒ«ã®å†…å®¹ãªã®ã§ã‚ã¾ã‚Šä¿¡ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚<br>
> å¾Œã€…[spring-graal-feature](https://github.com/spring-projects-experimental/spring-graal-feature)ã‚’ä½¿ã†ç”¨ã«å¤‰æ›´ã™ã‚‹äºˆå®šã§ã™ã€‚

[vanilla-spring-webflux-fn-blank](https://github.com/making/vanilla-spring-webflux-fn-blank)ã®`0.2.15`ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ãŸå ´åˆã¯ã‚ã‚‰ã‹ã˜ã‚Native Imageãƒ“ãƒ«ãƒ‰ç”¨ã®è¨­å®šãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

**ç›®æ¬¡**
<!-- toc -->

### App.javaã®ä¿®æ­£

`Jackson2ObjectMapperBuilder`ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ä»£è¡¨çš„ãª`com.fasterxml.jackson.databind.Module`ãŒã‚¯ãƒ©ã‚¹ãƒ‘ã‚¹ä¸Šã«ã„ã‚‹ã¨è‡ªå‹•ã§ç™»éŒ²ã™ã‚‹ã€‚
ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ãƒã‚§ãƒƒã‚¯ã‚’ã—ã¦ãŠã‚Šã€Native Imageã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚
ä»Šå›ã¯`com.fasterxml.jackson.datatype.jsr310.JavaTimeModule`ã‚’ä½¿ç”¨ã—ãŸã„ã ã‘ãªã®ã§ã€`modules`ãƒ¡ã‚½ãƒƒãƒ‰ã§æ˜ç¤ºçš„ã«ç™»éŒ²ã—ã¾ã™ã€‚

```java
    public static HandlerStrategies handlerStrategies() {
        return HandlerStrategies.empty()
            .codecs(configure -> {
                configure.registerDefaults(true);
                ServerCodecConfigurer.ServerDefaultCodecs defaults = configure
                    .defaultCodecs();
                ObjectMapper objectMapper = Jackson2ObjectMapperBuilder.json()
                    .dateFormat(new StdDateFormat())
                    .modules(new JavaTimeModule()) // <-- ã“ã“ã‚’è¿½åŠ 
                    .build();
                defaults.jackson2JsonEncoder(new Jackson2JsonEncoder(objectMapper));
                defaults.jackson2JsonDecoder(new Jackson2JsonDecoder(objectMapper));
            })
            .exceptionHandler(new ErrorResponseExceptionHandler())
            .build();
    }
```

> ã¡ãªã¿ã«ã€`modules`ãƒ¡ã‚½ãƒƒãƒ‰ã§æ˜ç¤ºçš„ã«ç™»éŒ²ã™ã‚‹ä»£ã‚ã‚Šã«ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚<br>
> ãã®å ´åˆã¯`src/main/resources/META-INF/native-image/com.example.moneyger/reflect-config.json`ã®JSONé…åˆ—ã«æ¬¡ã‚’è¿½åŠ ã™ã‚Œã°è‰¯ã„ã§ã™ã€‚
> 
> ```json
>   {
>     "name": "com.fasterxml.jackson.datatype.jsr310.JavaTimeModule",
>     "allDeclaredConstructors": true,
>     "allDeclaredMethods": true
>   }
> ```


æ¬¡ã«ã€`ConnectionFactory`ã®ç”Ÿæˆæ–¹æ³•ã‚’å¤‰æ›´ã—ã¾ã™ã€‚`ConnectionFactories.get`ã¯ã‚¯ãƒ©ã‚¹ãƒ­ãƒ¼ãƒ€ãƒ¼ã‹ã‚‰`ServiceLoader`ã§`io.r2dbc.spi.ConnectionFactoryProvider`ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŒã€
ã“ã‚Œã‚‚Native Imageä¸Šã§åˆ©ã‹ãªã„ã®ã§ã€ä»Šå›ã¯æ˜ç¤ºçš„ã«PostgreSQLç”¨ã®`PostgresqlConnectionFactory`ã‚’ç›´æ¥ä½œæˆã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```java
    static ConnectionFactory connectionFactory() {
        // postgresql://username:password@hostname:5432/dbname
        String databaseUrl = System.getenv("DATABASE_URL");
        final URI uri = URI.create(databaseUrl);
        final PostgresqlConnectionConfiguration configuration = PostgresqlConnectionConfiguration.builder()
            .host(uri.getHost())
            .port(uri.getPort())
            .database(uri.getPath().substring(1))
            .username(uri.getUserInfo().split(":", 2)[0])
            .password(uri.getUserInfo().split(":", 2)[1])
            .build();
        return new PostgresqlConnectionFactory(configuration);
    }
```

### R2dbcExpenditureRepository.javaã®å¤‰æ›´

`R2dbcExpenditureRepository`ã§ã¯Spring Data R2DBCã«ã‚ˆã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚„SQLç”Ÿæˆã‚’è‡ªå‹•ã§è¡Œãªã£ã¦ã„ã¾ã—ãŸã€‚
ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚„å‹•çš„ProxyãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯æ˜ç¤ºçš„ãªãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¡Œã†ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```java
package com.example.expenditure;

import io.r2dbc.spi.Row;
import org.springframework.data.r2dbc.core.DatabaseClient;
import org.springframework.transaction.reactive.TransactionalOperator;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.time.LocalDate;
import java.util.function.Function;

public class R2dbcExpenditureRepository implements ExpenditureRepository {

    private final DatabaseClient databaseClient;

    private final TransactionalOperator tx;

    @SuppressWarnings("ConstantConditions")
    private final Function<Row, Expenditure> rowExpenditureMapper = row -> new ExpenditureBuilder()
        .withExpenditureId(row.get("expenditure_id", Integer.class))
        .withExpenditureName(row.get("expenditure_name", String.class))
        .withQuantity(row.get("quantity", Integer.class))
        .withUnitPrice(row.get("unit_price", Integer.class))
        .withExpenditureDate(row.get("expenditure_date", LocalDate.class))
        .build();

    public R2dbcExpenditureRepository(DatabaseClient databaseClient, TransactionalOperator tx) {
        this.databaseClient = databaseClient;
        this.tx = tx;
    }

    @Override
    public Flux<Expenditure> findAll() {
        return this.databaseClient.execute("SELECT expenditure_id, expenditure_name, unit_price, quantity, expenditure_date FROM expenditure")
            .map(this.rowExpenditureMapper)
            .all();
    }

    @Override
    public Mono<Expenditure> findById(Integer expenditureId) {
        return this.databaseClient
            .execute("SELECT expenditure_id, expenditure_name, unit_price, quantity, expenditure_date FROM expenditure WHERE expenditure_id = :expenditure_id")
            .bind("expenditure_id", expenditureId)
            .map(this.rowExpenditureMapper)
            .one();
    }

    @Override
    public Mono<Expenditure> save(Expenditure expenditure) {
        final String databaseUrl = System.getenv("DATABASE_URL");
        if (databaseUrl != null && databaseUrl.contains("postgres") /* TODO ğŸ¤” */) {
            return this.databaseClient
                .execute("INSERT INTO expenditure(expenditure_name, unit_price, quantity, expenditure_date) VALUES(:expenditure_name, :unit_price, :quantity, :expenditure_date) RETURNING " +
                    "expenditure_id")
                .bind("expenditure_name", expenditure.getExpenditureName())
                .bind("unit_price", expenditure.getUnitPrice())
                .bind("quantity", expenditure.getQuantity())
                .bind("expenditure_date", expenditure.getExpenditureDate())
                .fetch()
                .one()
                .map(map -> new ExpenditureBuilder(expenditure)
                    .withExpenditureId((Integer) map.get("expenditure_id"))
                    .build())
                .as(this.tx::transactional);
        } else {
            return this.databaseClient
                .execute("INSERT INTO expenditure(expenditure_name, unit_price, quantity, expenditure_date) VALUES(:expenditure_name, :unit_price, :quantity, :expenditure_date)")
                .bind("expenditure_name", expenditure.getExpenditureName())
                .bind("unit_price", expenditure.getUnitPrice())
                .bind("quantity", expenditure.getQuantity())
                .bind("expenditure_date", expenditure.getExpenditureDate())
                .then()
                .then(/* TODO ğŸ¤” */ this.databaseClient.execute("CALL SCOPE_IDENTITY()").fetch().one()
                    .map(map -> new ExpenditureBuilder(expenditure)
                        .withExpenditureId(((Long) map.get("SCOPE_IDENTITY()")).intValue())
                        .build()))
                .as(this.tx::transactional);
        }
    }

    @Override
    public Mono<Void> deleteById(Integer expenditureId) {
        return this.databaseClient.execute("DELETE FROM expenditure WHERE expenditure_id = :expenditure_id")
            .bind("expenditure_id", expenditureId)
            .then()
            .as(this.tx::transactional);
    }
}
```

`R2dbcIncomeRepository`ã‚‚åŒæ§˜ã«ä¿®æ­£ã—ã¾ã™ã€‚

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´å¾Œã‚‚JUnitã®ãƒ†ã‚¹ãƒˆãŒä¾ç„¶æˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å®šç¾©

Jacksonã«ã‚ˆã‚‹JSONã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã¯ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§è¡Œã‚ã‚Œã¾ã™ã€‚ã‚¢ãƒ—ãƒªå´ã§JSONã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯¾è±¡ã¨ãªã‚‹ã‚¯ãƒ©ã‚¹ã¯
`src/main/resources/META-INF/native-image/com.example.moneyger/reflect-config.json`ã®JSONé…åˆ—ã«æ¬¡ã®ã‚ˆã†ã«è¿½åŠ ã—ã¾ã™ã€‚

```json
  {
    "name": "com.example.expenditure.Expenditure",
    "allDeclaredConstructors": true,
    "allDeclaredMethods": true
  },
  {
    "name": "com.example.expenditure.ExpenditureBuilder",
    "allDeclaredConstructors": true,
    "allDeclaredMethods": true
  },
  {
    "name": "com.example.income.Income",
    "allDeclaredConstructors": true,
    "allDeclaredMethods": true
  },
  {
    "name": "com.example.income.IncomeBuilder",
    "allDeclaredConstructors": true,
    "allDeclaredMethods": true
  },
  {
    "name": "com.example.error.ErrorResponse",
    "allDeclaredConstructors": true,
    "allDeclaredMethods": true
  }
```

### Native Imageã®ãƒ“ãƒ«ãƒ‰

[GraalVM 19.2.0](https://github.com/oracle/graal/releases/tag/vm-19.2.0)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
`JAVA_HOME`ã‚’æ›´æ–°ã—ãŸå¾Œã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€`native-image`

```
gu install native-image
```

ã§


```
export DATABASE_URL=postgresql://<username>:<password>@localhost:5432/moneyger

mvn clean package -Pgraal -DskipTests=true
```

æ¬¡ã®ã‚ˆã†ã«ãƒ“ãƒ«ãƒ‰ãŒã§ãã¾ã™ã€‚

```
$ mvn clean package -Pgraal -DskipTests=true
[INFO] Scanning for projects...
[INFO] 
[INFO] ------------------------------------------------------------------------
[INFO] Building moneyger 1.0.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------
[INFO] 
[INFO] --- maven-clean-plugin:2.5:clean (default-clean) @ moneyger ---
[INFO] Deleting /Users/maki/handson/moneyger/target
[INFO] 
[INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ moneyger ---
[INFO] Using 'UTF-8' encoding to copy filtered resources.
[INFO] Copying 8 resources
[INFO] 
[INFO] --- maven-compiler-plugin:3.1:compile (default-compile) @ moneyger ---
[INFO] Changes detected - recompiling the module!
[INFO] Compiling 10 source files to /Users/maki/handson/moneyger/target/classes
[INFO] 
[INFO] --- maven-resources-plugin:2.6:testResources (default-testResources) @ moneyger ---
[INFO] Using 'UTF-8' encoding to copy filtered resources.
[INFO] Copying 1 resource
[INFO] 
[INFO] --- maven-compiler-plugin:3.1:testCompile (default-testCompile) @ moneyger ---
[INFO] Changes detected - recompiling the module!
[INFO] Compiling 2 source files to /Users/maki/handson/moneyger/target/test-classes
[INFO] 
[INFO] --- maven-surefire-plugin:2.22.0:test (default-test) @ moneyger ---
[INFO] Tests are skipped.
[INFO] 
[INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ moneyger ---
[INFO] Building jar: /Users/maki/handson/moneyger/target/moneyger-1.0.0-SNAPSHOT.jar
[INFO] 
[INFO] --- native-image-maven-plugin:19.2.0:native-image (default) @ moneyger ---
[INFO] ImageClasspath Entry: com.github.making:moneyger-ui:jar:master-7d3a8b2729-1:compile (file:///Users/maki/.m2/repository/com/github/making/moneyger-ui/master-7d3a8b2729-1/moneyger-ui-master-7d3a8b2729-1.jar)
[INFO] ImageClasspath Entry: org.springframework:spring-context:jar:5.2.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/org/springframework/spring-context/5.2.0.BUILD-SNAPSHOT/spring-context-5.2.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: org.springframework:spring-aop:jar:5.2.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/org/springframework/spring-aop/5.2.0.BUILD-SNAPSHOT/spring-aop-5.2.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: org.springframework:spring-beans:jar:5.2.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/org/springframework/spring-beans/5.2.0.BUILD-SNAPSHOT/spring-beans-5.2.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: org.springframework:spring-core:jar:5.2.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/org/springframework/spring-core/5.2.0.BUILD-SNAPSHOT/spring-core-5.2.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: org.springframework:spring-jcl:jar:5.2.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/org/springframework/spring-jcl/5.2.0.BUILD-SNAPSHOT/spring-jcl-5.2.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: org.springframework:spring-expression:jar:5.2.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/org/springframework/spring-expression/5.2.0.BUILD-SNAPSHOT/spring-expression-5.2.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: org.springframework:spring-webflux:jar:5.2.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/org/springframework/spring-webflux/5.2.0.BUILD-SNAPSHOT/spring-webflux-5.2.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: org.springframework:spring-web:jar:5.2.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/org/springframework/spring-web/5.2.0.BUILD-SNAPSHOT/spring-web-5.2.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: io.projectreactor:reactor-core:jar:3.3.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/io/projectreactor/reactor-core/3.3.0.BUILD-SNAPSHOT/reactor-core-3.3.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: org.reactivestreams:reactive-streams:jar:1.0.3:compile (file:///Users/maki/.m2/repository/org/reactivestreams/reactive-streams/1.0.3/reactive-streams-1.0.3.jar)
[INFO] ImageClasspath Entry: ch.qos.logback:logback-classic:jar:1.2.3:compile (file:///Users/maki/.m2/repository/ch/qos/logback/logback-classic/1.2.3/logback-classic-1.2.3.jar)
[INFO] ImageClasspath Entry: ch.qos.logback:logback-core:jar:1.2.3:compile (file:///Users/maki/.m2/repository/ch/qos/logback/logback-core/1.2.3/logback-core-1.2.3.jar)
[INFO] ImageClasspath Entry: org.slf4j:slf4j-api:jar:1.7.28:compile (file:///Users/maki/.m2/repository/org/slf4j/slf4j-api/1.7.28/slf4j-api-1.7.28.jar)
[INFO] ImageClasspath Entry: io.projectreactor.netty:reactor-netty:jar:0.9.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/io/projectreactor/netty/reactor-netty/0.9.0.BUILD-SNAPSHOT/reactor-netty-0.9.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: io.netty:netty-codec-http:jar:4.1.39.Final:compile (file:///Users/maki/.m2/repository/io/netty/netty-codec-http/4.1.39.Final/netty-codec-http-4.1.39.Final.jar)
[WARNING] jar:file:///Users/maki/.m2/repository/io/netty/netty-codec-http/4.1.39.Final/netty-codec-http-4.1.39.Final.jar!/META-INF/native-image/io.netty/codec-http/native-image.properties does not match recommended META-INF/native-image/${groupId}/${artifactId}/native-image.properties layout.
[INFO] ImageClasspath Entry: io.netty:netty-common:jar:4.1.39.Final:compile (file:///Users/maki/.m2/repository/io/netty/netty-common/4.1.39.Final/netty-common-4.1.39.Final.jar)
[INFO] ImageClasspath Entry: io.netty:netty-buffer:jar:4.1.39.Final:compile (file:///Users/maki/.m2/repository/io/netty/netty-buffer/4.1.39.Final/netty-buffer-4.1.39.Final.jar)
[INFO] ImageClasspath Entry: io.netty:netty-transport:jar:4.1.39.Final:compile (file:///Users/maki/.m2/repository/io/netty/netty-transport/4.1.39.Final/netty-transport-4.1.39.Final.jar)
[WARNING] jar:file:///Users/maki/.m2/repository/io/netty/netty-transport/4.1.39.Final/netty-transport-4.1.39.Final.jar!/META-INF/native-image/io.netty/transport/native-image.properties does not match recommended META-INF/native-image/${groupId}/${artifactId}/native-image.properties layout.
[INFO] ImageClasspath Entry: io.netty:netty-resolver:jar:4.1.39.Final:compile (file:///Users/maki/.m2/repository/io/netty/netty-resolver/4.1.39.Final/netty-resolver-4.1.39.Final.jar)
[INFO] ImageClasspath Entry: io.netty:netty-codec:jar:4.1.39.Final:compile (file:///Users/maki/.m2/repository/io/netty/netty-codec/4.1.39.Final/netty-codec-4.1.39.Final.jar)
[INFO] ImageClasspath Entry: io.netty:netty-handler:jar:4.1.39.Final:compile (file:///Users/maki/.m2/repository/io/netty/netty-handler/4.1.39.Final/netty-handler-4.1.39.Final.jar)
[INFO] ImageClasspath Entry: io.netty:netty-handler-proxy:jar:4.1.39.Final:compile (file:///Users/maki/.m2/repository/io/netty/netty-handler-proxy/4.1.39.Final/netty-handler-proxy-4.1.39.Final.jar)
[INFO] ImageClasspath Entry: io.netty:netty-codec-socks:jar:4.1.39.Final:compile (file:///Users/maki/.m2/repository/io/netty/netty-codec-socks/4.1.39.Final/netty-codec-socks-4.1.39.Final.jar)
[INFO] ImageClasspath Entry: io.projectreactor.addons:reactor-pool:jar:0.1.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/io/projectreactor/addons/reactor-pool/0.1.0.BUILD-SNAPSHOT/reactor-pool-0.1.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: com.fasterxml.jackson.core:jackson-databind:jar:2.9.9.3:compile (file:///Users/maki/.m2/repository/com/fasterxml/jackson/core/jackson-databind/2.9.9.3/jackson-databind-2.9.9.3.jar)
[INFO] ImageClasspath Entry: com.fasterxml.jackson.core:jackson-annotations:jar:2.9.0:compile (file:///Users/maki/.m2/repository/com/fasterxml/jackson/core/jackson-annotations/2.9.0/jackson-annotations-2.9.0.jar)
[INFO] ImageClasspath Entry: com.fasterxml.jackson.core:jackson-core:jar:2.9.9:compile (file:///Users/maki/.m2/repository/com/fasterxml/jackson/core/jackson-core/2.9.9/jackson-core-2.9.9.jar)
[INFO] ImageClasspath Entry: com.fasterxml.jackson.datatype:jackson-datatype-jsr310:jar:2.9.9:compile (file:///Users/maki/.m2/repository/com/fasterxml/jackson/datatype/jackson-datatype-jsr310/2.9.9/jackson-datatype-jsr310-2.9.9.jar)
[INFO] ImageClasspath Entry: am.ik.yavi:yavi:jar:0.2.2:compile (file:///Users/maki/.m2/repository/am/ik/yavi/yavi/0.2.2/yavi-0.2.2.jar)
[INFO] ImageClasspath Entry: org.springframework.data:spring-data-r2dbc:jar:1.0.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/org/springframework/data/spring-data-r2dbc/1.0.0.BUILD-SNAPSHOT/spring-data-r2dbc-1.0.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: org.springframework.data:spring-data-commons:jar:2.2.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/org/springframework/data/spring-data-commons/2.2.0.BUILD-SNAPSHOT/spring-data-commons-2.2.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: org.springframework.data:spring-data-relational:jar:1.1.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/org/springframework/data/spring-data-relational/1.1.0.BUILD-SNAPSHOT/spring-data-relational-1.1.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: org.springframework:spring-tx:jar:5.2.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/org/springframework/spring-tx/5.2.0.BUILD-SNAPSHOT/spring-tx-5.2.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: io.r2dbc:r2dbc-spi:jar:0.8.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/io/r2dbc/r2dbc-spi/0.8.0.BUILD-SNAPSHOT/r2dbc-spi-0.8.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: io.r2dbc:r2dbc-h2:jar:0.8.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/io/r2dbc/r2dbc-h2/0.8.0.BUILD-SNAPSHOT/r2dbc-h2-0.8.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: com.h2database:h2:jar:1.4.199:compile (file:///Users/maki/.m2/repository/com/h2database/h2/1.4.199/h2-1.4.199.jar)
[INFO] ImageClasspath Entry: org.apache.commons:commons-lang3:jar:3.9:compile (file:///Users/maki/.m2/repository/org/apache/commons/commons-lang3/3.9/commons-lang3-3.9.jar)
[INFO] ImageClasspath Entry: io.r2dbc:r2dbc-postgresql:jar:0.8.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/io/r2dbc/r2dbc-postgresql/0.8.0.BUILD-SNAPSHOT/r2dbc-postgresql-0.8.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: com.ongres.scram:client:jar:1.0.0-beta.2:compile (file:///Users/maki/.m2/repository/com/ongres/scram/client/1.0.0-beta.2/client-1.0.0-beta.2.jar)
[INFO] ImageClasspath Entry: com.ongres.scram:common:jar:1.0.0-beta.2:compile (file:///Users/maki/.m2/repository/com/ongres/scram/common/1.0.0-beta.2/common-1.0.0-beta.2.jar)
[INFO] ImageClasspath Entry: io.r2dbc:r2dbc-pool:jar:0.8.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/io/r2dbc/r2dbc-pool/0.8.0.BUILD-SNAPSHOT/r2dbc-pool-0.8.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: org.springframework:spring-test:jar:5.2.0.BUILD-SNAPSHOT:compile (file:///Users/maki/.m2/repository/org/springframework/spring-test/5.2.0.BUILD-SNAPSHOT/spring-test-5.2.0.BUILD-SNAPSHOT.jar)
[INFO] ImageClasspath Entry: com.example:moneyger:jar:1.0.0-SNAPSHOT (file:///Users/maki/handson/moneyger/target/moneyger-1.0.0-SNAPSHOT.jar)
[INFO] Executing: /Users/maki/.sdkman/candidates/java/19.2.0-grl/jre/bin/native-image -cp /Users/maki/.m2/repository/com/github/making/moneyger-ui/master-7d3a8b2729-1/moneyger-ui-master-7d3a8b2729-1.jar:/Users/maki/.m2/repository/org/springframework/spring-context/5.2.0.BUILD-SNAPSHOT/spring-context-5.2.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/org/springframework/spring-aop/5.2.0.BUILD-SNAPSHOT/spring-aop-5.2.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/org/springframework/spring-beans/5.2.0.BUILD-SNAPSHOT/spring-beans-5.2.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/org/springframework/spring-core/5.2.0.BUILD-SNAPSHOT/spring-core-5.2.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/org/springframework/spring-jcl/5.2.0.BUILD-SNAPSHOT/spring-jcl-5.2.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/org/springframework/spring-expression/5.2.0.BUILD-SNAPSHOT/spring-expression-5.2.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/org/springframework/spring-webflux/5.2.0.BUILD-SNAPSHOT/spring-webflux-5.2.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/org/springframework/spring-web/5.2.0.BUILD-SNAPSHOT/spring-web-5.2.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/io/projectreactor/reactor-core/3.3.0.BUILD-SNAPSHOT/reactor-core-3.3.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/org/reactivestreams/reactive-streams/1.0.3/reactive-streams-1.0.3.jar:/Users/maki/.m2/repository/ch/qos/logback/logback-classic/1.2.3/logback-classic-1.2.3.jar:/Users/maki/.m2/repository/ch/qos/logback/logback-core/1.2.3/logback-core-1.2.3.jar:/Users/maki/.m2/repository/org/slf4j/slf4j-api/1.7.28/slf4j-api-1.7.28.jar:/Users/maki/.m2/repository/io/projectreactor/netty/reactor-netty/0.9.0.BUILD-SNAPSHOT/reactor-netty-0.9.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/io/netty/netty-codec-http/4.1.39.Final/netty-codec-http-4.1.39.Final.jar:/Users/maki/.m2/repository/io/netty/netty-common/4.1.39.Final/netty-common-4.1.39.Final.jar:/Users/maki/.m2/repository/io/netty/netty-buffer/4.1.39.Final/netty-buffer-4.1.39.Final.jar:/Users/maki/.m2/repository/io/netty/netty-transport/4.1.39.Final/netty-transport-4.1.39.Final.jar:/Users/maki/.m2/repository/io/netty/netty-resolver/4.1.39.Final/netty-resolver-4.1.39.Final.jar:/Users/maki/.m2/repository/io/netty/netty-codec/4.1.39.Final/netty-codec-4.1.39.Final.jar:/Users/maki/.m2/repository/io/netty/netty-handler/4.1.39.Final/netty-handler-4.1.39.Final.jar:/Users/maki/.m2/repository/io/netty/netty-handler-proxy/4.1.39.Final/netty-handler-proxy-4.1.39.Final.jar:/Users/maki/.m2/repository/io/netty/netty-codec-socks/4.1.39.Final/netty-codec-socks-4.1.39.Final.jar:/Users/maki/.m2/repository/io/projectreactor/addons/reactor-pool/0.1.0.BUILD-SNAPSHOT/reactor-pool-0.1.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/com/fasterxml/jackson/core/jackson-databind/2.9.9.3/jackson-databind-2.9.9.3.jar:/Users/maki/.m2/repository/com/fasterxml/jackson/core/jackson-annotations/2.9.0/jackson-annotations-2.9.0.jar:/Users/maki/.m2/repository/com/fasterxml/jackson/core/jackson-core/2.9.9/jackson-core-2.9.9.jar:/Users/maki/.m2/repository/com/fasterxml/jackson/datatype/jackson-datatype-jsr310/2.9.9/jackson-datatype-jsr310-2.9.9.jar:/Users/maki/.m2/repository/am/ik/yavi/yavi/0.2.2/yavi-0.2.2.jar:/Users/maki/.m2/repository/org/springframework/data/spring-data-r2dbc/1.0.0.BUILD-SNAPSHOT/spring-data-r2dbc-1.0.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/org/springframework/data/spring-data-commons/2.2.0.BUILD-SNAPSHOT/spring-data-commons-2.2.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/org/springframework/data/spring-data-relational/1.1.0.BUILD-SNAPSHOT/spring-data-relational-1.1.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/org/springframework/spring-tx/5.2.0.BUILD-SNAPSHOT/spring-tx-5.2.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/io/r2dbc/r2dbc-spi/0.8.0.BUILD-SNAPSHOT/r2dbc-spi-0.8.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/io/r2dbc/r2dbc-h2/0.8.0.BUILD-SNAPSHOT/r2dbc-h2-0.8.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/com/h2database/h2/1.4.199/h2-1.4.199.jar:/Users/maki/.m2/repository/org/apache/commons/commons-lang3/3.9/commons-lang3-3.9.jar:/Users/maki/.m2/repository/io/r2dbc/r2dbc-postgresql/0.8.0.BUILD-SNAPSHOT/r2dbc-postgresql-0.8.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/com/ongres/scram/client/1.0.0-beta.2/client-1.0.0-beta.2.jar:/Users/maki/.m2/repository/com/ongres/scram/common/1.0.0-beta.2/common-1.0.0-beta.2.jar:/Users/maki/.m2/repository/io/r2dbc/r2dbc-pool/0.8.0.BUILD-SNAPSHOT/r2dbc-pool-0.8.0.BUILD-SNAPSHOT.jar:/Users/maki/.m2/repository/org/springframework/spring-test/5.2.0.BUILD-SNAPSHOT/spring-test-5.2.0.BUILD-SNAPSHOT.jar:/Users/maki/handson/moneyger/target/moneyger-1.0.0-SNAPSHOT.jar -H:Class=com.example.App -H:Name=moneyger
[moneyger:15419]    classlist:   6,196.53 ms
[moneyger:15419]        (cap):   1,641.41 ms
[moneyger:15419]        setup:   3,431.27 ms
ScriptEngineManager providers.next(): javax.script.ScriptEngineFactory: Provider com.oracle.truffle.js.scriptengine.GraalJSEngineFactory could not be instantiated
ScriptEngineManager providers.next(): javax.script.ScriptEngineFactory: Provider com.oracle.truffle.js.scriptengine.GraalJSEngineFactory could not be instantiated
[moneyger:15419]   (typeflow):  20,420.66 ms
[moneyger:15419]    (objects):  12,896.53 ms
[moneyger:15419]   (features):   1,562.57 ms
[moneyger:15419]     analysis:  36,596.97 ms
[moneyger:15419]     (clinit):     868.41 ms
[moneyger:15419]     universe:   1,846.08 ms
[moneyger:15419]      (parse):   3,072.85 ms
[moneyger:15419]     (inline):   6,360.03 ms
[moneyger:15419]    (compile):  26,694.54 ms
[moneyger:15419]      compile:  38,162.44 ms
[moneyger:15419]        image:   3,108.36 ms
[moneyger:15419]        write:   1,127.10 ms
[moneyger:15419]      [total]:  90,727.56 ms
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 01:34 min
[INFO] Finished at: 2019-09-05T17:56:16+09:00
[INFO] Final Memory: 38M/357M
[INFO] ------------------------------------------------------------------------
```


`psql`ã§`CREATE DATABASE moneyger;`ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚


Native Imageã®ãƒã‚¤ãƒŠãƒªã¯`./target/classes/moneyger`ã§ã™ã€‚ã“ã‚Œã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```
$ ./target/classes/moneyger 
Sep 05, 2019 6:00:02 PM com.fasterxml.jackson.databind.ext.Java7Support <clinit>
WARNING: Unable to load JDK7 types (annotations, java.nio.file.Path): no Java7 support added
2019-09-05 18:00:02.597  INFO --- [           main] com.example.App                          : Started in 0.009 seconds
```

ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ğŸ‰

Dockerã§ã‚‚ãƒ“ãƒ«ãƒ‰ã§ãã¾ã™ã€‚

```
chmod +x mvnw
docker run --rm \
           -v "$PWD":/usr/src \
           -v "$HOME/.m2":/root/.m2 \
           -w /usr/src \
           oracle/graalvm-ce:19.2.0 \
           ./mvnw clean package -Pgraal -DskipTests=true
```

ã“ã“ã§ç”Ÿæˆã•ã‚Œã‚‹ãƒã‚¤ãƒŠãƒªã¯Linuxç”¨ã§ã™ã€‚
