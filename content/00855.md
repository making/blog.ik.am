---
title: MicroK8s(というより任意のK8s)でIRSAを使えるようにするメモ
---

```bash
mkdir oidc-issuer
cd oidc-issuer
echo private_key.pem > .gitignore
```

```bash
openssl genrsa -out private.pem 2048
openssl rsa -in private.pem -outform PEM -pubout -out public.pem
openssl pkcs8 -topk8 -inform PEM -in private.pem -out private_key.pem -nocrypt
rm -f private.pem
```

```bash
git clone https://github.com/making/pem-to-jwks.git
cd pem-to-jwks && ./mvnw clean package -DskipTests && cd -
java -jar pem-to-jwks/target/pem-to-jwks-0.0.1-SNAPSHOT.jar
echo pem-to-jwks >> .gitignore
```


```bash
GITHIB_REPO=making/oidc-issuer

git init
git add -A
git commit -m "Initial commit"
git branch -M main
git remote add origin git@github.com:${GITHIB_REPO}.git
git push -u origin main
```

```bash
curl -s https://raw.githubusercontent.com/${GITHIB_REPO}/refs/heads/main/jwks.json
```

```bash
mkdir -p .well-known
cat << EOF > .well-known/openid-configuration
{
  "response_types_supported": [
    "id_token"
  ],
  "issuer": "https://raw.githubusercontent.com/${GITHIB_REPO}/refs/heads/main",
  "id_token_signing_alg_values_supported": [
    "RS256"
  ],
  "subject_types_supported": [
    "public"
  ],
  "jwks_uri": "https://raw.githubusercontent.com/${GITHIB_REPO}/refs/heads/main/jwks.json"
}
EOF
```

```bash
git add -A
git commit -m "Add OpenID Connect configuration"
git push origin main
```

```bash
curl -s https://raw.githubusercontent.com/${GITHIB_REPO}/refs/heads/main/.well-known/openid-configuration
```

* /opt/k8s/public.pem
* /opt/k8s/private_key.pem



```bash
GITHIB_REPO=making/oidc-issuer

cat <<EOF | sudo tee -a /var/snap/microk8s/current/args/kube-apiserver
--api-audiences=https://kubernetes.default.svc
--service-account-issuer=https://raw.githubusercontent.com/${GITHIB_REPO}/refs/heads/main
--service-account-key-file=/opt/k8s/public.pem
--service-account-signing-key-file=/opt/k8s/private_key.pem
EOF
```

```bash
#--service-account-key-file=${SNAP_DATA}/certs/serviceaccount.key
...
#--service-account-issuer='https://kubernetes.default.svc'
#--service-account-signing-key-file=${SNAP_DATA}/certs/serviceaccount.key
```

```bash
sudo snap restart microk8s
```

```bash
kubectl delete pod -A --all --force
```


```bash
kubectl run -it netshoot --image=nicolaka/netshoot --rm --restart=Never --command=true -- bash
```

```bash
$ cat /run/secrets/kubernetes.io/serviceaccount/token | cut -d'.' -f2 | sed 's/$/===/' | base64 -d | jq .
{
  "aud": [
    "https://kubernetes.default.svc"
  ],
  "exp": 1781800378,
  "iat": 1750264378,
  "iss": "https://raw.githubusercontent.com/making/oidc-issuer/refs/heads/main",
  "jti": "dc1712b8-db40-4b1a-89cd-8b69e26ad4ca",
  "kubernetes.io": {
    "namespace": "default",
    "node": {
      "name": "apricot",
      "uid": "e6edbd10-b5c9-461f-83f5-eaf92559ef07"
    },
    "pod": {
      "name": "netshoot",
      "uid": "0d1dadab-331a-442d-9359-d4e79ab24c7f"
    },
    "serviceaccount": {
      "name": "default",
      "uid": "aa0d94f9-f02c-4560-bcdf-50f10f5a95f0"
    },
    "warnafter": 1750267985
  },
  "nbf": 1750264378,
  "sub": "system:serviceaccount:default:default"
}
```


`issuer`と`iss`が設定した値になっていればOKです。

```bash
exit
```

```bash
FINGERPRINT=$(openssl s_client -servername raw.githubusercontent.com -showcerts -connect raw.githubusercontent.com:443 </dev/null 2>/dev/null | openssl x509 -fingerprint -sha1 -noout | sed 's/sha1 Fingerprint=//' | sed 's/://g')
```

```bash
cat <<EOF > oidc-provider.json
{
    "Url": "https://raw.githubusercontent.com/${GITHIB_REPO}/refs/heads/main",
    "ClientIDList": [
        "https://kubernetes.default.svc"
    ],
    "ThumbprintList": [
        "${FINGERPRINT}"
    ]
}
EOF

aws iam create-open-id-connect-provider --cli-input-json file://oidc-provider.json
```


```bash
OIDC_PROVIDER_ARN=$(aws iam list-open-id-connect-providers --query "OpenIDConnectProviderList[?ends_with(Arn, 'raw.githubusercontent.com/${GITHIB_REPO}/refs/heads/main')].Arn" --output text)
```

```bash
NAMESPACE=default
SERVICE_ACCOUNT_NAME=aws-cli
cat << EOF > k8s_${NAMESPACE}_${SERVICE_ACCOUNT_NAME}-trust-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "${OIDC_PROVIDER_ARN}"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringLike": {
                    "raw.githubusercontent.com/${GITHIB_REPO}/refs/heads/main:sub": "system:serviceaccount:${NAMESPACE}:${SERVICE_ACCOUNT_NAME}",
                    "raw.githubusercontent.com/${GITHIB_REPO}/refs/heads/main:aud": "https://kubernetes.default.svc"
                }
            }
        }
    ]
}
EOF

aws iam create-role --role-name k8s_${NAMESPACE}_${SERVICE_ACCOUNT_NAME} --assume-role-policy-document file://k8s_${NAMESPACE}_${SERVICE_ACCOUNT_NAME}-trust-policy.json
```

```bash
export BUCKET_PREFIX=k8s-${NAMESPACE}-${SERVICE_ACCOUNT_NAME}

cat <<EOF > s3-prefix-full-access-${BUCKET_PREFIX}-policy.json
{
  "Version": "2012-10-17",
  "Statement": [

    {
      "Sid": "FullAccessTo$(echo ${BUCKET_PREFIX} | sed 's/\-//g')Buckets",
      "Effect": "Allow",
      "Action": [
        "s3:*"
      ],
      "Resource": [
        "arn:aws:s3:::${BUCKET_PREFIX}-*",
        "arn:aws:s3:::${BUCKET_PREFIX}-*/*"
      ]
    },
    {
      "Sid": "ListBucketsForConsoleAccess",
      "Effect": "Allow",
      "Action": [
        "s3:ListAllMyBuckets",
        "s3:GetBucketLocation"
      ],
      "Resource": "*"
    }
  ]
}
EOF

aws iam put-role-policy --role-name k8s_${NAMESPACE}_${SERVICE_ACCOUNT_NAME} --policy-name s3-prefix-full-access-${BUCKET_PREFIX} --policy-document file://s3-prefix-full-access-${BUCKET_PREFIX}-policy.json
```


```bash

```yaml
export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
export AWS_REGION=ap-northeast-1
cat <<EOF > aws-cli.yaml
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aws-cli
  namespace: default
---
apiVersion: v1
kind: Pod
metadata:
  name: aws-cli
  namespace: default
spec:
  serviceAccountName: aws-cli
  volumes:
  - name: shared-token
    emptyDir: {}
  containers:
  - name: aws-cli
    image: public.ecr.aws/aws-cli/aws-cli
    command: [ "sleep", "infinity" ]
    env:
    - name: AWS_REGION
      value: ${AWS_REGION}
    - name: AWS_ROLE_ARN
      value: arn:aws:iam::${AWS_ACCOUNT_ID}:role/k8s_default_aws-cli
    - name: AWS_WEB_IDENTITY_TOKEN_FILE
      value: /run/secrets/kubernetes.io/serviceaccount/token
    - name: AWS_ROLE_SESSION_NAME
      value: k8s-demo
  restartPolicy: Never
---
EOF

kubectl apply -f aws-cli.yaml
```

```bash
kubectl exec -ti aws-cli -c aws-cli -- bash
```

```bash
aws sts get-caller-identity
```

```json
{
    "UserId": "*********************:k8s-demo",
    "Account": "*****",
    "Arn": "arn:aws:sts::*****:assumed-role/k8s_default_aws-cli/k8s-demo"
}
```

```bash
aws s3 mb s3://k8s-default-aws-cli-demo
```

```
make_bucket: k8s-default-aws-cli-demo
```

```bash
aws s3 mb s3://k9s-default-aws-cli-demo
```

```
make_bucket failed: s3://k9s-default-aws-cli-demo An error occurred (AccessDenied) when calling the CreateBucket operation: User: arn:aws:sts::*****:assumed-role/k8s_default_aws-cli/k8s-demo is not authorized to perform: s3:CreateBucket on resource: "arn:aws:s3:::k9s-default-aws-cli-demo" because no identity-based policy allows the s3:CreateBucket action
```

```
exit
```