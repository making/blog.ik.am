---
title: Tanzu Application PlatformでPre-ProvisionedなRabbitMQを使ってResourceClaim / ClassClaimを作る
tags: ["Kubernetes", "Cartographer", "kind", "Tanzu", "TAP", "Bitnami Services", "Spring Boot", "Spring Cloud Stream", "Spring Cloud Data Flow", "RabbitMQ", "Helm"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP"]
---

以下の記事ではBitnami Servicesを使ってRabbitMQのサービスインスタンスを動的にProvisionしました。

* [Tanzu Application PlatformのBitnami Servicesを使ってSpring Cloud Streamのアプリをデプロイする](https://ik.am/entries/740)
* [Tanzu Application PlatformにSpring Cloud Data FlowのPre-packagedなStreamアプリをデプロイする](https://ik.am/entries/741)

本記事では次の方を対象に、Pre-ProvisionedなRabbitMQを使ってResourceClaim / ClassClaimを作る方法を紹介します。

* TAP 1.5より前のバージョンを使用しており、Bitnami Servicesを利用できない
* Dev環境ではBitnami Servicesを使用するが、Prod環境ではProduction-gradeなRabbitMQサービスを使用したい


**目次**
<!-- toc -->

### Service Binding互換なRabbitMQのSecretを作成する

Bitnami ServicesではCrossplaneによる動的なProvisionを使用しています。今回は事前に静的にProvisionしたサービスを使用します。
静的にProvisionしたサービスを利用するには接続情報を[Service Binding](https://servicebinding.io/)に対応したSecretに格納する必要があります。

事前に作るRabbitMQの作成方法は以下の2パターンを紹介します。

* Cloud AMQPを使ったHosted ServiceなRabbitMQ
* BitnamiのHelm Chartを使ったSelf HostedなRabbitMQ

#### Cloud AMQPを使う場合

FREEプランのあるRabbitMQのManaged Serviceである[CloudAMQP](https://www.cloudamqp.com)を使ってみます。

アカウントを作成するか、GitHubまたはGoogleアカウントでログインしてください。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/6d040eb3-5ebc-4a56-adaa-779f62c5ce8f">

インスタンス作成画面でNameを入力します。Planは"Little Lemur (Free)"を選択してください。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/e22dc14a-7e1e-470c-b4de-b2af24318318">

RegionとData Centerは"Amazon Web Services"の"AP_NorthEast-1 (Tokyo)"を選択し、インスタンスを作成してください。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/c692b2f3-be4a-4e1e-8933-0c0178811f60">


インスタンス一覧画面から作成したインスタンス名をクリックしてください。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/0abfca3e-ae60-443a-b5af-d7f625327bc2">

インスタンスの接続情報が表示されます。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/972a40ba-171b-451c-8d28-0313388b195f">


> ℹ️ このRabbitMQインスタンスにローカル環境から接続したい場合は、"URL"の文字列をコピーして、`application.properties`に次のように設定してください。
> 
>
> ``` properties
> spring.rabbitmq.addresses=amqps://fmzkajiy:2g6hsLdxgPBLtdaSm19C1byLc-chHIZM@cougar.rmq.cloudamqp.com/fmzkajiy
> ```
> 
> `spring.rabbitmq.host`, `spring.rabbitmq.port`, `spring.rabbitmq.username`, `spring.rabbitmq.password`, `spring.rabbitmq.addresses`を設定する方法もありますが、<br>
> `spring.rabbitmq.addresses` であれば1プロパティで済みます。また、TLSの設定(`spring.rabbitmq.ssl.enabled=true`)も`amqps://...`から自動で判断して設定されます。<br>
> 詳しくは https://docs.spring.io/spring-boot/docs/current/reference/html/messaging.html#messaging.amqp を参照してください。

<br>

インスタンス一覧画面から"RabbitMQ Manager"をクリックすると管理コンソールにアクセスできます。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/500b6f06-4a49-4bec-907f-4721060ac262">

次に

https://github.com/spring-cloud/spring-cloud-bindings#rabbitmq


```yaml
cat <<'EOF' > hello-rabbitmq-svcbind.yaml
apiVersion: v1
kind: Secret
metadata:
  name: hello-rabbitmq-svcbind
  labels:
    services.apps.tanzu.vmware.com/class: rabbitmq-provisioned
type: servicebinding.io/rabbitmq
stringData:
  type: rabbitmq
  addresses: amqps://fmzkajiy:2g6hsLdxgPBLtdaSm19C1byLc-chHIZM@cougar.rmq.cloudamqp.com/fmzkajiy
EOF

kubectl apply -f hello-rabbitmq-svcbind.yaml -n demo
```

#### Bitnami Helm Chartを使ってRabbitMQをKubernetes上にデプロイする場合

https://blog.bitnami.com/2023/04/select-bitnami-packaged-data-services.html

https://github.com/bitnami/charts/tree/main/bitnami/rabbitmq

11.10.0

BitnamiのHelm Chartは[OCIレジストリ](https://helm.sh/docs/topics/registries/)を使用するため、Helmは3.8以上を使用してください。本記事の内容は以下のHelmバージョンで試しました。

```
$ helm version --short
v3.12.0+gc9f554d
```

```
helm template hello-rabbitmq oci://registry-1.docker.io/bitnamicharts/rabbitmq -n demo --set serviceBindings.enabled=true --set persistence.size=1Gi --version 11.15.2 > hello-rabbitmq-bitnami.yaml
```

```
kubectl apply -f hello-rabbitmq-bitnami.yaml
kubectl wait pod/hello-rabbitmq-0 --for=condition=ready --timeout=120s -n demo
```

```
$ kubectl get pod,sts,secret -n demo -l app.kubernetes.io/name=rabbitmq
NAME                   READY   STATUS    RESTARTS   AGE
pod/hello-rabbitmq-0   1/1     Running   0          2m

NAME                              READY   AGE
statefulset.apps/hello-rabbitmq   1/1     2m

NAME                            TYPE                         DATA   AGE
secret/hello-rabbitmq           Opaque                       2      2m
secret/hello-rabbitmq-config    Opaque                       1      2m
secret/hello-rabbitmq-svcbind   servicebinding.io/rabbitmq   7      2m
```

```
$ kubectl get secret -n demo hello-rabbitmq-svcbind -ojson | jq '.data | map_values(@base64d)'
{
  "host": "hello-rabbitmq",
  "password": "X4WGwerjDhYgTpnO",
  "port": "5672",
  "provider": "bitnami",
  "type": "rabbitmq",
  "uri": "amqp://user:X4WGwerjDhYgTpnO@hello-rabbitmq:5672",
  "username": "user"
}
```

```
kubectl port-forward -n demo svc/hello-rabbitmq 15672:15672
```


### ClusterInstanceClassの作成

https://docs.vmware.com/en/Services-Toolkit-for-VMware-Tanzu-Application-Platform/0.9/svc-tlk/usecases-introducing_different_service_implementations_in_different_environments.html


```
cat <<EOF > rabbitmq-provisioned.yaml
apiVersion: services.apps.tanzu.vmware.com/v1alpha1
kind: ClusterInstanceClass
metadata:
  name: rabbitmq-provisioned
spec:
  description:
    short: Pre-provisioned RabbitMQ Instances
  pool:
    kind: Secret
    labelSelector:
      matchLabels:
        services.apps.tanzu.vmware.com/class: rabbitmq-provisioned
    fieldSelector: type=servicebinding.io/rabbitmq
EOF

kubectl apply -f rabbitmq-provisioned.yaml
```


```
$ tanzu services classes list
  NAME                  DESCRIPTION                         
  mysql-unmanaged       MySQL by Bitnami                    
  postgresql-unmanaged  PostgreSQL by Bitnami               
  rabbitmq-provisioned  Pre-provisioned RabbitMQ Instances  
  rabbitmq-unmanaged    RabbitMQ by Bitnami                 
  redis-unmanaged       Redis by Bitnami  
```



```
$ kubectl get secret -n demo --show-labels hello-rabbitmq-svcbind
NAME                     TYPE                         DATA   AGE    LABELS
hello-rabbitmq-svcbind   servicebinding.io/rabbitmq   2      122m   services.apps.tanzu.vmware.com/class=rabbitmq-provisioned
```

Helm ChartでRabbitMQでインストールした場合は
```
$ kubectl get secret -n demo --show-labels hello-rabbitmq-svcbind
NAME                     TYPE                         DATA   AGE   LABELS
hello-rabbitmq-svcbind   servicebinding.io/rabbitmq   7      81m   app.kubernetes.io/instance=hello-rabbitmq,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/name=rabbitmq,helm.sh/chart=rabbitmq-11.15.2,services.apps.tanzu.vmware.com/class=rabbitmq-provisioned
```

### Service Toolkitに対するRBACの設定


```
$ tanzu service claimable list --class rabbitmq-provisioned -n demo
Error: secrets is forbidden: User "system:serviceaccount:services-toolkit:resource-claims-apiserver" cannot list resource "secrets" in API group "" at the cluster scope
```

```yaml
cat <<EOF > stk-secret-reader.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: stk-secret-reader
  labels:
    servicebinding.io/controller: "true"
rules:
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - get
  - list
  - watch
EOF

kubectl apply -f stk-secret-reader.yaml
```

```
$ tanzu service claimable list --class rabbitmq-provisioned -n demo
  NAME                    NAMESPACE  KIND    APIVERSION  
  hello-rabbitmq-svcbind  demo       Secret  v1 
```

### Claimの作成


#### ResourceClaimの作成 (TAP 1.3以前の場合)

https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/services-toolkit-tutorials-direct-secret-references.html


```
tanzu services resource-claim create hello-rabbitmq \
  --resource-name hello-rabbitmq-svcbind \
  --resource-kind Secret \
  --resource-api-version v1 \
  -n demo
```

```
$ tanzu services resource-claims get hello-rabbitmq --namespace demo
Name: hello-rabbitmq
Status: 
  Ready: True
Namespace: demo
Claim Reference: services.apps.tanzu.vmware.com/v1alpha1:ResourceClaim:hello-rabbitmq
Resource Reference: 
  Name: hello-rabbitmq-svcbind
  Namespace: demo
  Group: 
  Version: v1
  Kind: Secret
```

```
$ tanzu service claimable list --class rabbitmq-provisioned -n demo
No claimable service instances found.
```

```
tanzu apps workload apply ticktock-time \
  --app ticktock-time \
  --maven-group org.springframework.cloud.stream.app \
  --maven-artifact time-source-rabbit \
  --maven-version 3.2.1 \
  --env spring.cloud.stream.bindings.output.destination=ticktock.time \
  --build-env BP_JVM_VERSION=17 \
  --type web \
  --annotation autoscaling.knative.dev/minScale=1 \
  --service-ref hello-rabbitmq=services.apps.tanzu.vmware.com/v1alpha1:ResourceClaim:hello-rabbitmq \
  -n demo \
  -y
```

```
tanzu apps workload apply ticktock-log \
  --app ticktock-log \
  --maven-group org.springframework.cloud.stream.app \
  --maven-artifact log-sink-rabbit \
  --maven-version 3.2.1 \
  --env spring.cloud.stream.bindings.input.destination=ticktock.time \
  --env spring.cloud.stream.bindings.input.group=log \
  --build-env BP_JVM_VERSION=17 \
  --type web \
  --annotation autoscaling.knative.dev/minScale=1 \
  --service-ref hello-rabbitmq=services.apps.tanzu.vmware.com/v1alpha1:ResourceClaim:hello-rabbitmq \
  -n demo \
  -y
```


```
kubectl delete workload -n demo --all
tanzu services resource-claims delete -n demo hello-rabbitmq
```

#### ClassClaimの作成 (TAP 1.4以降で利用可能)


https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.5/tap/services-toolkit-tutorials-direct-secret-references.html


```
$ tanzu service claimable list --class rabbitmq-provisioned -n demo
  NAME                    NAMESPACE  KIND    APIVERSION  
  hello-rabbitmq-svcbind  demo       Secret  v1 
```


```
tanzu service class-claim create hello-rabbitmq --class rabbitmq-provisioned -n demo
```


```
$ tanzu services class-claims get hello-rabbitmq --namespace demo
Name: hello-rabbitmq
Namespace: demo
Claim Reference: services.apps.tanzu.vmware.com/v1alpha1:ClassClaim:hello-rabbitmq
Class Reference: 
  Name: rabbitmq-provisioned
Parameters: None
Status: 
  Ready: True
  Claimed Resource: 
    Name: hello-rabbitmq-svcbind
    Namespace: demo
    Group: 
    Version: v1
    Kind: Secret
```

```
$ tanzu service claimable list --class rabbitmq-provisioned -n demo
No claimable service instances found.
```


```
tanzu apps workload apply ticktock-time \
  --app ticktock-time \
  --maven-group org.springframework.cloud.stream.app \
  --maven-artifact time-source-rabbit \
  --maven-version 3.2.1 \
  --env spring.cloud.stream.bindings.output.destination=ticktock.time \
  --build-env BP_JVM_VERSION=17 \
  --type web \
  --annotation autoscaling.knative.dev/minScale=1 \
  --service-ref hello-rabbitmq=services.apps.tanzu.vmware.com/v1alpha1:ClassClaim:hello-rabbitmq \
  -n demo \
  -y
```


```
tanzu apps workload apply ticktock-log \
  --app ticktock-log \
  --maven-group org.springframework.cloud.stream.app \
  --maven-artifact log-sink-rabbit \
  --maven-version 3.2.1 \
  --env spring.cloud.stream.bindings.input.destination=ticktock.time \
  --env spring.cloud.stream.bindings.input.group=log \
  --build-env BP_JVM_VERSION=17 \
  --type web \
  --annotation autoscaling.knative.dev/minScale=1 \
  --service-ref hello-rabbitmq=services.apps.tanzu.vmware.com/v1alpha1:ClassClaim:hello-rabbitmq \
  -n demo \
  -y
```


```
$ stern -n demo ticktock-log -c workload

...
ticktock-log-00001-deployment-77665794b6-wr44c workload 2023-05-19 05:40:59.927  INFO [log-sink,fa8876f82adf3286,87ce0e02f538588e] 1 --- [tock.time.log-1] log-sink                                 : 05/19/23 05:40:59
ticktock-log-00001-deployment-77665794b6-wr44c workload 2023-05-19 05:41:00.928  INFO [log-sink,110363283f063f53,f0b640a58c3cf707] 1 --- [tock.time.log-1] log-sink                                 : 05/19/23 05:41:00
ticktock-log-00001-deployment-77665794b6-wr44c workload 2023-05-19 05:41:01.929  INFO [log-sink,666e768f86e30515,b7394cd3f9dc1333] 1 --- [tock.time.log-1] log-sink                                 : 05/19/23 05:41:01
ticktock-log-00001-deployment-77665794b6-wr44c workload 2023-05-19 05:41:02.930  INFO [log-sink,9be0d2a7dcbdd989,14ab4f7fce911a93] 1 --- [tock.time.log-1] log-sink                                 : 05/19/23 05:41:02
ticktock-log-00001-deployment-77665794b6-wr44c workload 2023-05-19 05:41:03.932  INFO [log-sink,ab81f203d86eae6c,bff8f15675d707c7] 1 --- [tock.time.log-1] log-sink                                 : 05/19/23 05:41:03
ticktock-log-00001-deployment-77665794b6-wr44c workload 2023-05-19 05:41:04.933  INFO [log-sink,173d23e1e2dc4cf7,14a2949c6de641ca] 1 --- [tock.time.log-1] log-sink                                 : 05/19/23 05:41:04
ticktock-log-00001-deployment-77665794b6-wr44c workload 2023-05-19 05:41:05.934  INFO [log-sink,aed73d5f177983d6,fbe38b0583b40dc3] 1 --- [tock.time.log-1] log-sink                                 : 05/19/23 05:41:05
ticktock-log-00001-deployment-77665794b6-wr44c workload 2023-05-19 05:41:06.936  INFO [log-sink,82656e5e46203429,7b83b0d9af6ae7f9] 1 --- [tock.time.log-1] log-sink                                 : 05/19/23 05:41:06
...
```