---
title: Tanzu Application Platformã®Workloadã‚’Datadogã§ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹
tags: ["Kubernetes", "Tanzu", "TAP", "Datadog"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP"]
---

Tanzu Application Platformã§ã¯ä»¥ä¸‹ã®Datadog buildpackãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚

* https://github.com/paketo-buildpacks/datadog
* https://docs.vmware.com/en/VMware-Tanzu-Buildpacks/services/tanzu-buildpacks/GUID-partner-integrations-partner-integration-buildpacks.html#datadog

ã“ã®buildpackã¯Javaã‚¢ãƒ—ãƒªã«Datadog Java Agentã‚’ã€Node.jsã‚¢ãƒ—ãƒªã«ã¯ Datadog Node.js Trace Agentã‚’è¿½åŠ ã—ã¾ã™ãŒã€
ã“ã®buildpackã‚’ä½¿ã†ã ã‘ã§ã¯å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’Datadogã«é€ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚Datadogã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹ã«ã¯åˆ¥é€”Data Agentã‚’èµ·å‹•ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


æ¬¡ã®å›³ã®ã‚ˆã†ãªæ§‹æˆã«ãªã‚Šã¾ã™ã€‚<br>
<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/216759836-5a3c99e4-431f-4072-8ddf-256001890559.png">


æœ¬è¨˜äº‹ã§ã¯æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¾“ã£ã¦Datadog Agentã‚’Kubernetesã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€TAPã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸWorkloadã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã¿ã¾ã™ã€‚

* https://docs.datadoghq.com/containers/kubernetes/installation/?tab=helm


[ã“ã¡ã‚‰ã®è¨˜äº‹](https://ik.am/entries/733)ã§æ§‹ç¯‰ã—ãŸTAP 1.4 on Kindã®ç’°å¢ƒã§è©¦ã—ã¾ã™ã€‚ãªãŠã€Datadogã¯Free Trialã®ç’°å¢ƒã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

**ç›®æ¬¡**
<!-- toc -->

### Datadog Agentã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ä»Šå›ã¯Datadog Agentã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ã¯Helm Chartã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ä»Šå¾Œã¯[Datadog Operator](https://docs.datadoghq.com/containers/kubernetes/installation?tab=operator)ãŒæ¨å¥¨ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```
helm repo add datadog https://helm.datadoghq.com
helm repo update
```

Helmã®values.yamlã‚’æ¬¡ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚ `datadog.site` ã¨ `datadog.apiKey` ã¯è‡ªåˆ†ã®ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚<br>
ã¾ãŸã€Kubernetes Distributionã”ã¨ã«å¿…è¦ãªè¨­å®šã¯<br>
https://docs.datadoghq.com/containers/kubernetes/distributions?tab=helm <br>
ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

```yaml
datadog:
  site: us3.datadoghq.com
  apiKey: xxxxxx
  clusterName: kind-sandbox
  kubelet:
    host:
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    tlsVerify: false
  apm:
    portEnabled: true
  logs:
    enabled: true
  dogstatsd:
    useHostPort: true
```

`helm template`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦manifestã‚’ç”Ÿæˆã—ã€`kubectl apply`ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚Multi Clusteræ§‹æˆã®å ´åˆã¯ã€Runã‚¯ãƒ©ã‚¹ã‚¿ã«å¯¾ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚

```
helm template -n datadog datadog datadog/datadog -f values.yaml > datadog.yaml
kubectl create ns datadog
kubectl apply -n datadog -f datadog.yaml
```

Datadog AgentãŒDaemonSetã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚ã¾ãŸKubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®ç›£è¦–ã®ãŸã‚ã®[Datadog Cluster Agent](https://docs.datadoghq.com/containers/cluster_agent/)ãŒDeploymentã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚

```
$ kubectl get pod,deploy,ds -n datadog
NAME                                         READY   STATUS    RESTARTS   AGE
pod/datadog-cluster-agent-7b8c9fb77b-xpkld   1/1     Running   0          55m
pod/datadog-vk27t                            3/3     Running   0          55m

NAME                                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/datadog-cluster-agent   1/1     1            1           150m

NAME                     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
daemonset.apps/datadog   1         1         1       1            1           kubernetes.io/os=linux   150m
```

Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®ç›£è¦–ã¯ä¸è¦ãªå ´åˆã¯`clusterAgent.enabled`ã‚’`false`ã«ã™ã‚Œã°Datadog Cluster Agentã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã›ã‚“ã€‚
åˆã‚ã›ã¦ `datadog.kubeStateMetricsCore.enabled`ã¨`datadog.collectEvents`ã‚‚`false`ã«ã™ã‚Œã°Kubernetesã«é–¢ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡ã‚’æ¸›ã‚‰ã›ã¾ã™ã€‚


> âš ï¸ `clusterAgent.enabled`ã‚’`false`ã«è¨­å®šã™ã‚‹ã¨[Datadog Admission controller](https://docs.datadoghq.com/containers/cluster_agent/admission_controller/?tab=helm)ãŒãªããªã‚‹ãŸã‚ã€å¾Œè¿°ã®ç’°å¢ƒå¤‰æ•° `DD_AGENT_HOST` ã‚’æ‰‹å‹•ã§è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br>
> `admission.datadoghq.com/enabled` Labelã‚‚è¨­å®šã™ã‚‹æ„å‘³ãŒãªããªã‚Šã¾ã™ã€‚

### Workloadã®ãƒ‡ãƒ—ãƒ­ã‚¤

ãã‚Œã§ã¯ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å¯¾è±¡ã®Workloadã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚¢ãƒ—ãƒªã¯ https://github.com/making/rest-service ã§ã™ã€‚<br>
ã“ã®ã‚¢ãƒ—ãƒªã¯[ecs-logging](https://github.com/elastic/ecs-logging)ã§ãƒ­ã‚°ã‚’æ§‹é€ åŒ–(JSONåŒ–)ã—ã¦ã„ã¾ã™ã€‚Datadogãªã©ã«ãƒ­ã‚°ã‚’è»¢é€ã™ã‚‹å ´åˆã¯æ§‹é€ åŒ–ãƒ­ã‚°ãŒä¾¿åˆ©ã§ã™ã€‚<br>

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Workloadã‚’ä½œæˆã—ã¾ã™ã€‚


```
tanzu apps workload apply rest-service \
  --app rest-service \
  --git-repo https://github.com/making/rest-service \
  --git-branch main \
  --type web \
  --annotation autoscaling.knative.dev/minScale=1 \
  --label admission.datadoghq.com/enabled=true \
  --build-env BP_DATADOG_ENABLED=true \
  --env DD_SERVICE=rest-service \
  --env DD_ENV=sandbox \
  --env DD_VERSION=1.0 \
  -n demo \
  -y
```

ãƒã‚¤ãƒ³ãƒˆã¯

* `--label admission.datadoghq.com/enabled=true` ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§[Datadog Admission controller](https://docs.datadoghq.com/containers/cluster_agent/admission_controller/?tab=helm)ãŒPodã«è‡ªå‹•ã§ç’°å¢ƒå¤‰æ•° `DD_AGENT_HOST` ãªã©ã‚’è¨­å®šã—ã¾ã™ã€‚
* `--build-env BP_DATADOG_ENABLED=true` ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§buildserviceã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆæ™‚ã«[datadog buildpack](https://docs.vmware.com/en/VMware-Tanzu-Buildpacks/services/tanzu-buildpacks/GUID-partner-integrations-partner-integration-buildpacks.html#datadog)ãŒDatadog Java Agentã‚’è‡ªå‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚


ç’°å¢ƒå¤‰æ•°`DD_**`ã®è¨­å®šã¯ä»»æ„ã§ã™ãŒã€è¨­å®šã—ãŸæ–¹ãŒDatadogã‹ã‚‰ã‚¢ãƒ—ãƒªã®æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚„ã™ã„ã§ã™ã€‚å°‘ãªãã¨ã‚‚`DD_SERVICE`ã«ã¯Workloadåã‚’å…¥ã‚Œã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚`DD_ENV`ã¯ç’°å¢ƒåã€`DD_VERSION`ã¯ã‚¢ãƒ—ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã™ã€‚

> â„¹ï¸ Multi Clusterç’°å¢ƒã§ã¯`--env`ã§è¨­å®šã—ãŸå€¤ã¯ã©ã®(Run)ç’°å¢ƒã§ã‚‚åŒã˜å€¤ãŒä½¿ã‚ã‚Œã¾ã™ã€‚`DD_ENV`ã®ã‚ˆã†ãªç’°å¢ƒã«ã‚ˆã£ã¦ç•°ãªã‚‹å€¤ã¯ã€ConfigMapã‚„Secretã‚’çµŒç”±ã—ã¦è¨­å®šã—ãŸæ–¹ãŒè‰¯ã„ã§ã™ã€‚è¨­å®šæ–¹æ³•ã¯å¾Œè¿°ã—ã¾ã™ã€‚


`stern`ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ã‚°ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
stern -n demo rest-service
```

ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ä¸­ã«æ¬¡ã®ã‚ˆã†ãªãƒ­ã‚°ã§ã€Datadog Java AgentãŒè¿½åŠ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```
rest-service-build-1-build-pod build Paketo Buildpack for Datadog 3.0.0
rest-service-build-1-build-pod build   https://github.com/paketo-buildpacks/datadog
rest-service-build-1-build-pod build   Datadog Java Agent 1.1.4: Contributing to layer
rest-service-build-1-build-pod build     Downloading from https://repo1.maven.org/maven2/com/datadoghq/dd-java-agent/1.1.4/dd-java-agent-1.1.4.jar
rest-service-build-1-build-pod build     Verifying checksum
rest-service-build-1-build-pod build     Copying to /layers/paketo-buildpacks_datadog/datadog-agent-java
rest-service-build-1-build-pod build     Writing env.launch/JAVA_TOOL_OPTIONS.append
rest-service-build-1-build-pod build     Writing env.launch/JAVA_TOOL_OPTIONS.delim
```

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã®ãƒ­ã‚°ã«ç’°å¢ƒå¤‰æ•°`JAVA_TOOL_OPTIONS`ãŒå‡ºåŠ›ã•ã‚Œã€`-javaagent:/layers/paketo-buildpacks_datadog/datadog-agent-java/dd-java-agent-1.1.4.jar`ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚
ã¾ãŸã€`[dd.trace`ã‹ã‚‰å§‹ã¾ã‚‹ãƒ­ã‚°ã§Datadog Java AgentãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‹ã‚Šã¾ã™ã€‚Datadog Java AgentãŒæ¥ç¶šã™ã‚‹Datadog Agentã®URLãŒ`"agent_url":"http://172.19.0.2:8126"`ã¨å‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚`172.19.0.2`ã¯Nodeã®IPã§ã™ã€‚

```
rest-service-00001-deployment-78454d968b-hmb9z workload Setting Active Processor Count to 8
rest-service-00001-deployment-78454d968b-hmb9z workload Calculating JVM memory based on 11788884K available memory
rest-service-00001-deployment-78454d968b-hmb9z workload For more information on this calculation, see https://paketo.io/docs/reference/java-reference/#memory-calculator
rest-service-00001-deployment-78454d968b-hmb9z workload Calculated JVM Memory Configuration: -XX:MaxDirectMemorySize=10M -Xmx11168701K -XX:MaxMetaspaceSize=108182K -XX:ReservedCodeCacheSize=240M -Xss1M (Total Memory: 11788884K, Thread Count: 250, Loaded Class Count: 16686, Headroom: 0%)
rest-service-00001-deployment-78454d968b-hmb9z workload Enabling Java Native Memory Tracking
rest-service-00001-deployment-78454d968b-hmb9z workload Adding 124 container CA certificates to JVM truststore
rest-service-00001-deployment-78454d968b-hmb9z workload Spring Cloud Bindings Enabled
rest-service-00001-deployment-78454d968b-hmb9z workload Picked up JAVA_TOOL_OPTIONS: -Dmanagement.endpoint.health.probes.add-additional-paths="true" -Dmanagement.health.probes.enabled="true" -Dserver.port="8080" -Dserver.shutdown.grace-period="24s" -Djava.security.properties=/layers/paketo-buildpacks_bellsoft-liberica/java-security-properties/java-security.properties -XX:+ExitOnOutOfMemoryError -javaagent:/layers/paketo-buildpacks_datadog/datadog-agent-java/dd-java-agent-1.1.4.jar -XX:ActiveProcessorCount=8 -XX:MaxDirectMemorySize=10M -Xmx11168701K -XX:MaxMetaspaceSize=108182K -XX:ReservedCodeCacheSize=240M -Xss1M -XX:+UnlockDiagnosticVMOptions -XX:NativeMemoryTracking=summary -XX:+PrintNMTStatistics -Dorg.springframework.cloud.bindings.boot.enable=true
rest-service-00001-deployment-78454d968b-hmb9z queue-proxy {"severity":"INFO","timestamp":"2023-02-03T17:21:50.2316515Z","logger":"queueproxy","caller":"sharedmain/main.go:270","message":"Starting queue-proxy","commit":"d7e9873","knative.dev/key":"demo/rest-service-00001","knative.dev/pod":"rest-service-00001-deployment-78454d968b-hmb9z"}
rest-service-00001-deployment-78454d968b-hmb9z workload [dd.trace 2023-02-03 17:21:51:856 +0000] [main] INFO com.datadog.appsec.AppSecSystem - AppSec is ENABLED_INACTIVE with powerwaf(libddwaf: 1.5.1) no rules loaded
rest-service-00001-deployment-78454d968b-hmb9z workload [dd.trace 2023-02-03 17:21:52:220 +0000] [dd-task-scheduler] INFO datadog.trace.agent.core.StatusLogger - DATADOG TRACER CONFIGURATION {"version":"1.1.4~022e2ba179","os_name":"Linux","os_version":"5.10.104-linuxkit","architecture":"amd64","lang":"jvm","lang_version":"11.0.17","jvm_vendor":"BellSoft","jvm_version":"11.0.17+7-LTS","java_class_version":"55.0","http_nonProxyHosts":"null","http_proxyHost":"null","enabled":true,"service":"rest-service","agent_url":"http://172.19.0.2:8126","agent_error":false,"debug":false,"analytics_enabled":false,"sampling_rules":[{},{}],"priority_sampling_enabled":true,"logs_correlation_enabled":true,"profiling_enabled":false,"remote_config_enabled":true,"debugger_enabled":false,"appsec_enabled":"ENABLED_INACTIVE","telemetry_enabled":true,"dd_version":"1.0","health_checks_enabled":true,"configuration_file":"no config file present","runtime_id":"d10c232d-88f9-441f-9efa-35ea763a7e04","logging_settings":{"levelInBrackets":false,"dateTimeFormat":"'[dd.trace 'yyyy-MM-dd HH:mm:ss:SSS Z']'","logFile":"System.err","configurationFile":"simplelogger.properties","showShortLogName":false,"showDateTime":true,"showLogName":true,"showThreadName":true,"defaultLogLevel":"INFO","warnLevelString":"WARN","embedException":false},"cws_enabled":false,"cws_tls_refresh":5000}
rest-service-00001-deployment-78454d968b-hmb9z workload [dd.trace 2023-02-03 17:21:52:869 +0000] [dd-task-scheduler] WARN datadog.telemetry.dependency.DependencyResolverQueue - unable to detect dependency for URI file:/workspace/
rest-service-00001-deployment-78454d968b-hmb9z workload 
rest-service-00001-deployment-78454d968b-hmb9z workload   .   ____          _            __ _ _
rest-service-00001-deployment-78454d968b-hmb9z workload  /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
rest-service-00001-deployment-78454d968b-hmb9z workload ( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
rest-service-00001-deployment-78454d968b-hmb9z workload  \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
rest-service-00001-deployment-78454d968b-hmb9z workload   '  |____| .__|_| |_|_| |_\__, | / / / /
rest-service-00001-deployment-78454d968b-hmb9z workload  =========|_|==============|___/=/_/_/_/
rest-service-00001-deployment-78454d968b-hmb9z workload  :: Spring Boot ::                (v2.7.8)
rest-service-00001-deployment-78454d968b-hmb9z workload 
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:53.382Z","log.level": "INFO","message":"Starting RestServiceApplication v0.0.1-SNAPSHOT using Java 11.0.17 on rest-service-00001-deployment-78454d968b-hmb9z with PID 1 (/workspace/BOOT-INF/classes started by cnb in /workspace)","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"main","log.logger":"com.example.restservice.RestServiceApplication","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:53.390Z","log.level": "INFO","message":"No active profile set, falling back to 1 default profile: \"default\"","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"main","log.logger":"com.example.restservice.RestServiceApplication","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload [dd.trace 2023-02-03 17:21:53:868 +0000] [dd-task-scheduler] WARN datadog.telemetry.dependency.DependencyResolverQueue - unable to detect dependency for URI file:/workspace/BOOT-INF/classes/
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:55.267Z","log.level": "INFO","message":"Tomcat initialized with port(s): 8080 (http)","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"main","log.logger":"org.springframework.boot.web.embedded.tomcat.TomcatWebServer","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:55.331Z","log.level": "INFO","message":"Starting service [Tomcat]","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"main","log.logger":"org.apache.catalina.core.StandardService","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:55.331Z","log.level": "INFO","message":"Starting Servlet engine: [Apache Tomcat/9.0.71]","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"main","log.logger":"org.apache.catalina.core.StandardEngine","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:55.434Z","log.level": "INFO","message":"Initializing Spring embedded WebApplicationContext","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"main","log.logger":"org.apache.catalina.core.ContainerBase.[Tomcat].[localhost].[/]","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:55.434Z","log.level": "INFO","message":"Root WebApplicationContext: initialization completed in 1974 ms","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"main","log.logger":"org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:56.917Z","log.level": "INFO","message":"Exposing 1 endpoint(s) beneath base path '/actuator'","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"main","log.logger":"org.springframework.boot.actuate.endpoint.web.EndpointLinksResolver","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:56.979Z","log.level": "INFO","message":"Tomcat started on port(s): 8080 (http) with context path ''","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"main","log.logger":"org.springframework.boot.web.embedded.tomcat.TomcatWebServer","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:56.999Z","log.level": "INFO","message":"Started RestServiceApplication in 4.712 seconds (JVM running for 6.843)","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"main","log.logger":"com.example.restservice.RestServiceApplication","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:57.269Z","log.level": "INFO","message":"Initializing Spring DispatcherServlet 'dispatcherServlet'","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"http-nio-8080-exec-3","log.logger":"org.apache.catalina.core.ContainerBase.[Tomcat].[localhost].[/]","dd.trace_id":"8339885192089890711","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0","dd.span_id":"2116877690292855250"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:57.270Z","log.level": "INFO","message":"Initializing Servlet 'dispatcherServlet'","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"http-nio-8080-exec-3","log.logger":"org.springframework.web.servlet.DispatcherServlet","dd.trace_id":"8339885192089890711","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0","dd.span_id":"2116877690292855250"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:57.272Z","log.level": "INFO","message":"Completed initialization in 2 ms","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"http-nio-8080-exec-3","log.logger":"org.springframework.web.servlet.DispatcherServlet","dd.trace_id":"8339885192089890711","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0","dd.span_id":"2116877690292855250"}
```

`tanzu apps workload get ...`ã§Workloadã®æƒ…å ±ã‚’ç¢ºèªã—ã¾ã™ã€‚`Knative Services`ãŒ`READY`ã§ã‚ã‚Œã°ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚

```
$ tanzu apps workload get -n demo rest-service
ğŸ“¡ Overview
   name:        rest-service
   type:        web
   namespace:   demo

ğŸ’¾ Source
   type:     git
   url:      https://github.com/making/rest-service
   branch:   main

ğŸ“¦ Supply Chain
   name:   source-to-url

   NAME               READY   HEALTHY   UPDATED   RESOURCE
   source-provider    True    True      5m13s     gitrepositories.source.toolkit.fluxcd.io/rest-service
   image-provider     True    True      110s      images.kpack.io/rest-service
   config-provider    True    True      102s      podintents.conventions.carto.run/rest-service
   app-config         True    True      102s      configmaps/rest-service
   service-bindings   True    True      102s      configmaps/rest-service-with-claims
   api-descriptors    True    True      102s      configmaps/rest-service-with-api-descriptors
   config-writer      True    True      89s       runnables.carto.run/rest-service-config-writer

ğŸšš Delivery
   name:   delivery-basic

   NAME              READY   HEALTHY   UPDATED   RESOURCE
   source-provider   True    True      67s       imagerepositories.source.apps.tanzu.vmware.com/rest-service-delivery
   deployer          True    True      64s       apps.kappctrl.k14s.io/rest-service

ğŸ’¬ Messages
   No messages found.

ğŸ›¶ Pods
   NAME                                             READY   STATUS      RESTARTS   AGE
   rest-service-00001-deployment-78454d968b-hmb9z   2/2     Running     0          67s
   rest-service-build-1-build-pod                   0/1     Completed   0          5m12s
   rest-service-config-writer-9hbdf-pod             0/1     Completed   0          100s

ğŸš¢ Knative Services
   NAME           READY   URL
   rest-service   Ready   https://rest-service.demo.127-0-0-1.sslip.io

To see logs: "tanzu apps workload tail rest-service --namespace demo --timestamp --since 1h"
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Datadog Admission controllerã«ã‚ˆã£ã¦Podã«ç’°å¢ƒå¤‰æ•°ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

```
$ kubectl get pod -n demo rest-service-00001-deployment-78454d968b-hmb9z -oyaml | grep env: -A 12
  - env:
    - name: DD_ENTITY_ID
      valueFrom:
        fieldRef:
          apiVersion: v1
          fieldPath: metadata.uid
    - name: DD_AGENT_HOST
      valueFrom:
        fieldRef:
          apiVersion: v1
          fieldPath: status.hostIP
    - name: DD_SERVICE
      value: rest-service
--
  - env:
    - name: DD_ENTITY_ID
      valueFrom:
        fieldRef:
          apiVersion: v1
          fieldPath: metadata.uid
    - name: DD_AGENT_HOST
      valueFrom:
        fieldRef:
          apiVersion: v1
          fieldPath: status.hostIP
    - name: SERVING_NAMESPACE
      value: demo
```

`DD_ENTITY_ID`ã¨`DD_AGENT_HOST`ãŒè‡ªå‹•ã§è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚`DD_AGENT_HOST`ã«ã¯hostIPãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€ãƒ­ã‚°ã«`"agent_url":"http://172.19.0.2:8126"`ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚


Datadogã§APM -> Servicesã¸é·ç§»ã™ã‚‹ã¨Serviceä¸€è¦§ã«"reset-service"ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/216661256-b938f72a-eed0-49aa-a699-cfca0f44fb6c.png">


"reset-service"ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨rest-serviceã®SummaryãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚Readiness Probeã¨Liveness Probeã®`GET /readyz`ã¨`GET /livez`ã«é–¢ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒæ¯ç§’é€ã‚‰ã‚Œã¦ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/216667327-99d71258-f61c-465e-a04c-1ed09d449941.png">

"Service Summary"ã®ä¸‹ã®"JVM Metrics"ã§JVMã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¦‹ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/216675233-0ce952bd-544d-4e89-adae-df66c113229a.png">


ã‚¢ãƒ—ãƒªã®`/greeting`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã—ã‚‡ã†ã€‚

```
for i in `seq 1 100`;do 
  curl -sk https://rest-service.demo.127-0-0-1.sslip.io/greeting
  echo
done
```

æ¬¡ã®ã‚ˆã†ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚Šã¾ã™ã€‚

```
{"id":1,"content":"Hello, World!"}
{"id":2,"content":"Hello, World!"}
{"id":3,"content":"Hello, World!"}
{"id":4,"content":"Hello, World!"}
{"id":5,"content":"Hello, World!"}
...
{"id":100,"content":"Hello, World!"}
```

ã¾ãŸã€æ¬¡ã®ã‚ˆã†ãªã‚¢ãƒ—ãƒªã®ãƒ­ã‚°ã‚‚å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚Datadog Java Agentã¯`dd.trace_id`ã¨`dd.span_id`ã‚’MDCã«è‡ªå‹•ã§è¨­å®šã—ã¾ã™ã€‚ecs-loggingã‚’ä½¿ç”¨ã™ã‚Œã°ã€MDCã«è¨­å®šã•ã‚ŒãŸå€¤ã‚’è‡ªå‹•ã§JSONã«è¿½åŠ ã—ã¦ãã‚Œã‚‹ã®ã§ã€ãƒ­ã‚°ã«ã‚‚`dd.trace_id`ã¨`dd.span_id`ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã®ã¡ã«Traceã¨Logã‚’çµã³ã¤ã‘ã‚‹éš›ã«å½¹ç«‹ã¡ã¾ã™ã€‚


```
...
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:25:37.895Z","log.level": "INFO","message":"Greeting{id=98, content='Hello, World!'}","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"http-nio-8080-exec-1","log.logger":"com.example.restservice.GreetingController","dd.trace_id":"5626764257006979930","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0","dd.span_id":"2368498438859442974"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:25:37.945Z","log.level": "INFO","message":"Greeting{id=99, content='Hello, World!'}","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"http-nio-8080-exec-5","log.logger":"com.example.restservice.GreetingController","dd.trace_id":"8014719942895616066","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0","dd.span_id":"8884205664488887926"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:25:37.999Z","log.level": "INFO","message":"Greeting{id=100, content='Hello, World!'}","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"http-nio-8080-exec-3","log.logger":"com.example.restservice.GreetingController","dd.trace_id":"3762825320413857103","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0","dd.span_id":"3963548649385222325"}
```

Datadogã§APM -> Tracesã«é·ç§»ã—ã¦ãã ã•ã„ã€‚

`/greeting`ã¸ã®Traceæƒ…å ±ãŒä¸€è¦§ã«å«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/216668064-6f91865f-8428-48fa-9ed4-62bdae33ac55.png">

ä¸€ã¤é¸ã‚“ã§ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€è©³ç´°ã‚’ç¢ºèªã—ã¾ã™ã€‚å‡¦ç†å†…å®¹ã®å†…è¨³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/216669142-45519781-b584-4684-8351-19997aa4bd0f.png">

"Logs"ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨"No logs found"ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã¾ã ã‚¢ãƒ—ãƒªã‹ã‚‰ãƒ­ã‚°ã‚’é€ã‚‹è¨­å®šã‚’è¡Œãªã£ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/216669271-0cf36182-d6f0-45f9-808d-46c89a4c75f5.png">


### ã‚¢ãƒ—ãƒªã®ãƒ­ã‚°ã‚’Datadogã«é€ã‚‹

Datadogã¸ã®ãƒ­ã‚°è»¢é€ã¯Platformå˜ä½ã§è¡Œã†æ–¹æ³•ã¨Workloadå˜ä½ã§è¡Œã†æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ä»Šå›ã¯Workloadå˜ä½ã§è¨­å®šã—ã¾ã™ã€‚

æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚ˆã†ã«Podã®`ad.datadoghq.com/<CONTAINER_IDENTIFIER>.logs`ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«`'[{"source": "<Source>","service": "<Service>","tags": ["<Tag1>", "<Tag2>"]}]'`ã¨ã„ã†è¨­å®šã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br>
https://docs.datadoghq.com/containers/kubernetes/log/?tab=kubernetes#configuration


`tanzu apps workload`ã®`--annotation`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JSONã‚’è¨­å®šã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€Workloadã¯YAMLã§è¨­å®šã—ã¾ã™ã€‚
ç¾åœ¨ã®Workloadã®è¨­å®šå†…å®¹ã‚’YAMLã«å‡ºåŠ›ã«ã™ã‚‹ã«ã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚

```
tanzu apps workload get -n demo rest-service --export
```

ã‚‚ã—ãã¯ã€Workloadã‚’ä½œæˆã™ã‚‹å‰ã«YAMLåŒ–ã—ãŸã„å ´åˆã¯`--dry-run`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚Œã°è‰¯ã„ã§ã™ã€‚

```
tanzu apps workload apply rest-service \
  --app rest-service \
  --git-repo https://github.com/making/rest-service \
  --git-branch main \
  --type web \
  --annotation autoscaling.knative.dev/minScale=1 \
  --label admission.datadoghq.com/enabled=true \
  --build-env BP_DATADOG_ENABLED=true \
  --env DD_SERVICE=rest-service \
  --env DD_ENV=sandbox \
  --env DD_VERSION=1.0 \
  -n demo --dry-run | kubectl neat
```

ã„ãšã‚Œã‹ã®ã‚³ãƒãƒ³ãƒ‰ã§æ¬¡ã®YAMLãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

```yaml
---
apiVersion: carto.run/v1alpha1
kind: Workload
metadata:
  labels:
    admission.datadoghq.com/enabled: "true"
    app.kubernetes.io/part-of: rest-service
    apps.tanzu.vmware.com/workload-type: web
  name: rest-service
  namespace: demo
spec:
  build:
    env:
    - name: BP_DATADOG_ENABLED
      value: "true"
  env:
  - name: DD_SERVICE
    value: rest-service
  - name: DD_ENV
    value: sandbox
  - name: DD_VERSION
    value: "1.0"
  params:
  - name: annotations
    value:
      autoscaling.knative.dev/minScale: "1"
  source:
    git:
      ref:
        branch: main
      url: https://github.com/making/rest-service
```


`annotations` paramã«`ad.datadoghq.com/workload.logs`ã‚’è¿½åŠ ã—ã¾ã™ã€‚æ¬¡ã®ã‚ˆã†ã«YAMLã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```yaml
---
apiVersion: carto.run/v1alpha1
kind: Workload
metadata:
  labels:
    admission.datadoghq.com/enabled: "true"
    app.kubernetes.io/part-of: rest-service
    apps.tanzu.vmware.com/workload-type: web
  name: rest-service
  namespace: demo
spec:
  build:
    env:
    - name: BP_DATADOG_ENABLED
      value: "true"
  env:
  - name: DD_SERVICE
    value: rest-service
  - name: DD_ENV
    value: sandbox
  - name: DD_VERSION
    value: "1.0"
  params:
  - name: annotations
    value:
      ad.datadoghq.com/workload.logs: '[{"source":"workload","service":"rest-service"}]' # <--- Added
      autoscaling.knative.dev/minScale: "1"
  source:
    git:
      ref:
        branch: main
      url: https://github.com/making/rest-service
```

ã“ã®YAMLã‚’applyã—ã¾ã™ã€‚

```
$ tanzu apps workload apply -f workload.yaml                           
â— WARNING: Configuration file update strategy is changing. By default, provided configuration files will replace rather than merge existing configuration. The change will take place in the January 2024 TAP release (use "--update-strategy" to control strategy explicitly).

ğŸ” Update workload:
...
 22, 22   |    value: "1.0"
 23, 23   |  params:
 24, 24   |  - name: annotations
 25, 25   |    value:
     26 + |      ad.datadoghq.com/workload.logs: '[{"source":"workload","service":"rest-service"}]'
 26, 27   |      autoscaling.knative.dev/minScale: "1"
 27, 28   |  source:
 28, 29   |    git:
 29, 30   |      ref:
...
â“ Really update the workload "rest-service"? [yN]: y
ğŸ‘ Updated workload "rest-service"

To see logs:   "tanzu apps workload tail rest-service --namespace demo --timestamp --since 1h"
To get status: "tanzu apps workload get rest-service --namespace demo"
```


> ã©ã†ã—ã¦ã‚‚YAMLã‚’ä½¿ã„ãŸããªã„å ´åˆã¯ã€`--anotation`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ä»£ã‚ã‚Šã«`--param-yaml`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚‚è¨­å®šå¯èƒ½ã§ã™
> 
> ```
> tanzu apps workload apply rest-service \
>   --app rest-service \
>   --git-repo https://github.com/making/rest-service \
>   --git-branch main \
>   --type web \
>   --param-yaml annotation='{"ad.datadoghq.com/workload.logs":"[{\"source\":\"workload\",\"service\":\"rest-service\"}]","autoscaling.knative.dev/minScale":"1"}' \
>   --label admission.datadoghq.com/enabled=true \
>   --build-env BP_DATADOG_ENABLED=true \
>   --env DD_SERVICE=rest-service \
>   --env DD_ENV=sandbox \
>   --env DD_VERSION=1.0 \
> ```

æ¬¡ã®ã‚ˆã†ã«ã€Knative Serviceã®RevisionãŒ`rest-service-00002`ã«ãªã‚Œã°ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã§ã™ã€‚

```
$ kubectl get ksvc -n demo rest-service 
NAME           URL                                            LATESTCREATED        LATESTREADY          READY   REASON
rest-service   https://rest-service.demo.127-0-0-1.sslip.io   rest-service-00002   rest-service-00002   True 
```

ã‚‚ã†ä¸€åº¦ã€ã‚¢ãƒ—ãƒªã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã™ã€‚

```
for i in `seq 1 100`;do 
  curl -sk https://rest-service.demo.127-0-0-1.sslip.io/greeting
  echo
done
```

æ¬¡ã®ã‚ˆã†ãªã‚¢ãƒ—ãƒªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```
...
rest-service-00002-deployment-6cfcb4b6f5-kng8m workload {"@timestamp":"2023-02-03T17:37:36.146Z","log.level": "INFO","message":"Greeting{id=98, content='Hello, World!'}","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"http-nio-8080-exec-3","log.logger":"com.example.restservice.GreetingController","dd.trace_id":"7335734608230234482","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0","dd.span_id":"6315277859940185552"}
rest-service-00002-deployment-6cfcb4b6f5-kng8m workload {"@timestamp":"2023-02-03T17:37:36.195Z","log.level": "INFO","message":"Greeting{id=99, content='Hello, World!'}","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"http-nio-8080-exec-2","log.logger":"com.example.restservice.GreetingController","dd.trace_id":"8586535972007884877","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0","dd.span_id":"7454967409341757930"}
rest-service-00002-deployment-6cfcb4b6f5-kng8m workload {"@timestamp":"2023-02-03T17:37:36.247Z","log.level": "INFO","message":"Greeting{id=100, content='Hello, World!'}","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"spring-boot-application","process.thread.name":"http-nio-8080-exec-8","log.logger":"com.example.restservice.GreetingController","dd.trace_id":"8792935479711312615","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0","dd.span_id":"1391216223413785587"}
```

Datadogã‹ã‚‰Logsã‚’ç¢ºèªã™ã‚‹ã¨ã€åŒã˜ãƒ­ã‚°ãŒè»¢é€ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚[ecs-logging](https://github.com/elastic/ecs-logging)ã«ã‚ˆã£ã¦æ§‹é€ åŒ–ãƒ­ã‚°ãŒé€ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã€"CONTENT"åˆ—ã«ã¯ãƒ­ã‚°ã®ã†ã¡`message`ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/216670418-430061ed-c63f-499c-9cbb-4a6305c773bf.png">

ä»–ã®é …ç›®ã¯ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/216857488-3f53e5b0-3965-4f24-987b-56f583174c0c.png">

Traceã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã“ã®ãƒ­ã‚°å‡ºåŠ›ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®Traceæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯[ecs-logging](https://github.com/elastic/ecs-logging)ã«ã‚ˆã£ã¦ã€æ§‹é€ åŒ–ãƒ­ã‚°ã«`dd.trace_id`ã¨`dd.span_id`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚æ§‹é€ åŒ–ãƒ­ã‚°ã§ãªã„å ´åˆã¯ã€[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.datadoghq.com/tracing/troubleshooting/correlated-logs-not-showing-up-in-the-trace-id-panel/?%3Ftab=jsonlogs&tab=custom#trace-id-option)ã«ã—ãŸãŒã£ã¦ã€ãƒãƒƒãƒ”ãƒ³ã‚°ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/216670580-e15a2de7-e369-4769-8e86-8ada49fbb77a.png">

é€†ã«Traceã‹ã‚‰Logsã‚‚è¦‹ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/216670713-67baa7d2-b323-4425-a058-64a55f30e90b.png">


### ç’°å¢ƒå¤‰æ•°DD_ENVã‚’ç’°å¢ƒã”ã¨ã«å¤‰ãˆã‚‹

```
kubectl create cm -n demo rest-service-config --from-literal env=sandbox --dry-run -oyaml | kubectl apply -f-
```


```yaml
---
apiVersion: carto.run/v1alpha1
kind: Workload
metadata:
  labels:
    admission.datadoghq.com/enabled: "true"
    app.kubernetes.io/part-of: rest-service
    apps.tanzu.vmware.com/workload-type: web
  name: rest-service
  namespace: demo
spec:
  build:
    env:
    - name: BP_DATADOG_ENABLED
      value: "true"
  env:
  - name: DD_SERVICE
    value: rest-service
  - name: DD_ENV
    valueFrom:
      configMapKeyRef:
        name: rest-service-config
        key: env
  - name: DD_VERSION
    value: "1.0"
  params:
  - name: annotations
    value:
      ad.datadoghq.com/workload.logs: '[{"source":"workload","service":"rest-service"}]'
      autoscaling.knative.dev/minScale: "1"
  source:
    git:
      ref:
        branch: main
      url: https://github.com/making/rest-service
```