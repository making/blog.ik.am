---
title: Cartographer 0.0.6をkindで試す
tags: ["Kubernetes", "Cartographer"]
categories: ["Dev", "CaaS", "Kubernetes", "Cartographer"]
---

"Cloud Native Supply Chains"と呼ばれる[Cartographer](https://cartographer.sh)がリリースされたので、kindで試してみます。

<!-- toc -->

### Cartographerとは

Cartographerがやってくれることを簡単にいうと、任意のk8sリソースのoutput(status)を使って次のk8sリソースに反映させるという橋渡しを行い、アプリケーションをリリースするための"Supply Chain"を提供することです。
例えばgitにpushしたソースコードをpullしてコンテナイメージを作成し、そのイメージをマニフェストに反映してデプロイするというフローを実現したい場合、

1. [Flux](https://fluxcd.io) の [GitRepository](https://fluxcd.io/docs/components/source/gitrepositories/) リソースがgitレポジトリがwatchし、変更があればソースコードをtar.gzファイルに圧縮してファイルサーバーに保存する
2. [kpack](https://github.com/pivotal/kpack) の [Image](https://github.com/pivotal/kpack/blob/main/docs/image.md) リソースが1.のURLからソースコードを取得し、 [Cloud Native Buildpacks](https://buildpacks.io) を使用してコンテナイメージを作成し、Dockerレジストリにイメージをpushする
3. [Knative](https://knative.dev) の [Service](https://github.com/knative/specs/blob/main/specs/serving/knative-api-specification-1.0.md#service) リソースが2.のimageを使用してアプリケーションをデプロイする

という連携が考えられますが、Cartographerはこれらのリソースの変更をwatchし、↓の図のようにリソース間の値の受け渡しを自動で行います。

![image](https://user-images.githubusercontent.com/106908/136144130-872f6bc9-ec94-4960-9e2a-a00f6f9af93b.jpeg)

例えば
1. watchしているgitリポジトリに対して新しいcommitがpushされることにより 、GitRepositoryリソースの `.status.artifact.url` が変更されれば、その値を自動でImageリソースの `.spec.source.blob.url` に設定する
2. 1.の後や、kpackの [ClusterBuilder](https://github.com/pivotal/kpack/blob/main/docs/builders.md#cluster-builders) や [ClusterStack](https://github.com/pivotal/kpack/blob/main/docs/stack.md) (OSのベースイメージ)がアップデートされることにより、Imageリソースの `.status.latestImage` が変更されれば、その値を自動でServiceリソースの `.spec.template.spec.containers[0].image` に設定する

ということをCartographerが行います。 
これらの組み合わせや値の受け渡し方法は自由にカスタマイズできて、下の図のように使い慣れたコンポーネントを選択して、組織にあった"Supply Chain"を定義することができます。
k8sリソースの入出力がfitすれば、どんなコンポーネントでも間に挟むことができます。例えばコンテナイメージをビルドする前にユニットテストを実行したり、イメージをビルドした後にイメージをスキャンすることもできます。

[ClusterSupplyChain](https://cartographer.sh/docs/v0.0.6/reference/#clustersupplychain) リソースにこのSupply Chainを定義できます。またSupply Chainへの入力(e.g. gitリポジトリのURLなど)を [Workload](https://cartographer.sh/docs/v0.0.6/reference/#workload) リソースに定義できます。

![image](https://content.cdntwrk.com/files/aHViPTYzOTc1JmNtZD1pdGVtZWRpdG9yaW1hZ2UmZmlsZW5hbWU9aXRlbWVkaXRvcmltYWdlXzYxNWI4NmE0MjE0NzMucG5nJnZlcnNpb249MDAwMCZzaWc9YjMxMDdmNDZmMTIwYjhiNzFhNTY4NTg0OGE2YWIyOTc%253D)
(図は https://tanzu.vmware.com/content/blog/vmware-tanzu-application-platform-beta-2-announcement より)

同じようなことをCI/CDツールを組み合わせて既に行っている組織も多いのではないかと思いますが、
Cartographerの良いところはDeveloperとOperatorの責任の分離を明確に行っている点です。

下の図のように、Operatorが定義したClusterSupplyChainを使ってDeveloperがWorkloadを定義しアプリケーションをデプロイできます。

![image](https://user-images.githubusercontent.com/106908/136133334-872d0ce8-f4e4-4a27-8286-3aecd1c7a710.png)
(図は https://cartographer.sh/docs/v0.0.6/ より)

CI/CDツールの組み合わせの場合は、
"誰がマニフェストやCIパイプラインを作るのか"や"Operatorがテンプレートを配布し、Developerがそれをカスタマイズする運用をするとテンプレートの変更を反映するのが大変"という課題を解決することができます。



### Getting Started

前置きが長くなりましたが、早速試してみます。

ここではKnativeの代わりにシンプルに標準のDeployment・Service・Ingressを使用します。Supply Chainは次の図のようになります。

![image](https://user-images.githubusercontent.com/106908/136181993-3655c270-40b6-4d6d-b896-b57dbe7d438d.jpeg)


#### kindクラスタの作成

まずはkindクラスタを作成します。[`extraPortMappings`](https://kind.sigs.k8s.io/docs/user/ingress/) を設定してLaptop上の80/443ポートを通じてIngressにアクセスできるようにします。

```
curl -sL https://github.com/projectcontour/contour/raw/main/examples/kind/kind-expose-port.yaml > kind-expose-port.yaml
kind create cluster --config kind-expose-port.yaml
```

#### コンポーネント群のインストール

今回のSupply Chainを作るために必要な次のコンポーネント群をインストールします。

* [cert-manager](https://github.com/jetstack/cert-manager)
* [kpack](https://github.com/pivotal/kpack)
* [Flux2 (source controller)](https://github.com/fluxcd/source-controller)
* [Contour (ingress)](https://github.com/projectcontour/contour)

```
kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.5.4/cert-manager.yaml
kubectl apply -f https://github.com/pivotal/kpack/releases/download/v0.4.0/release-0.4.0.yaml
kubectl create namespace gitops-toolkit
kubectl create clusterrolebinding gitops-toolkit-admin --clusterrole=cluster-admin --serviceaccount=gitops-toolkit:default
kubectl apply -n gitops-toolkit -f https://github.com/fluxcd/source-controller/releases/download/v0.15.4/source-controller.crds.yaml -f https://github.com/fluxcd/source-controller/releases/download/v0.15.4/source-controller.deployment.yaml
kubectl apply -f https://projectcontour.io/quickstart/contour.yaml
```

インストール後のPod一覧は次の通りです。

```
$ kubectl get pod -A
NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE
cert-manager         cert-manager-7c6f78c46d-xncwh                1/1     Running   0          77s
cert-manager         cert-manager-cainjector-668d9c86df-dskgc     1/1     Running   0          77s
cert-manager         cert-manager-webhook-764b556954-zfb7c        1/1     Running   0          77s
gitops-toolkit       source-controller-764686cbbd-tjpk2           1/1     Running   0          76s
kpack                kpack-controller-98c4fd6c7-qld5f             1/1     Running   0          77s
kpack                kpack-webhook-65d59b7ffd-d2x8l               1/1     Running   0          77s
kube-system          coredns-558bd4d5db-gjlmc                     1/1     Running   0          77s
kube-system          coredns-558bd4d5db-xlp85                     1/1     Running   0          77s
kube-system          etcd-kind-control-plane                      1/1     Running   0          86s
kube-system          kindnet-zrzgv                                1/1     Running   0          77s
kube-system          kube-apiserver-kind-control-plane            1/1     Running   0          86s
kube-system          kube-controller-manager-kind-control-plane   1/1     Running   0          93s
kube-system          kube-proxy-mq9fx                             1/1     Running   0          77s
kube-system          kube-scheduler-kind-control-plane            1/1     Running   0          86s
local-path-storage   local-path-provisioner-547f784dff-qb9jx      1/1     Running   0          77s
projectcontour       contour-7cc4786577-gpvgn                     1/1     Running   0          75s
projectcontour       contour-7cc4786577-pmwch                     1/1     Running   0          75s
projectcontour       envoy-n7q6l                                  2/2     Running   0          66s
```

#### Cartographerのインストール

次にCartographerをインストールします。

[ドキュメント](https://cartographer.sh/docs/v0.0.6/install/) の通りにインストールしますが、
現時点のドキュメントは [Carvel](https://carvel.dev) を使った手順のみ用意されています。
この方法は [Air-gapped環境](https://carvel.dev/imgpkg/docs/latest/air-gapped-workflow/) にもインストール可能な、応用の効くやり方なのですが、少し手間がかかります。

[こちらのissue](https://github.com/vmware-tanzu/cartographer/issues/198) の通り、`kubectl apply -f ...`でインストールできる方法は今度準備するようです。

#### Carvel Toolsのインストール

まずは [Carvel](https://carvel.dev/#install) のツール群をインストールします。

```
brew tap vmware-tanzu/carvel
brew install ytt kbld kapp imgpkg kwt vendir
```

あるいは

```
curl -sL https://carvel.dev/install.sh | bash
```

を実行してください。

本記事では `imgpkg`、`kbld`、`kapp` を使用します。次のバージョンで動作確認しています。

```
$ imgpkg version
imgpkg version 0.19.0

Succeeded
$ kbld version
kbld version 0.31.0

Succeeded
$ kapp version
kapp version 0.42.0
```

##### Carvelを使ったCartographerのインストール

バージョン [0.0.6](https://github.com/vmware-tanzu/cartographer/releases/tag/v0.0.6) 時点では、Cartographerのマニフェスト及びコンテナイメージは [imgpkg](https://carvel.dev/imgpkg/docs/latest/) のtar形式で配布されています。
これはコンテナイメージを別途コンテナレジストリにrelocationする想定です。

ここではコンテナレジストリとして、GitHub Packages(ghcr.io)を使用します。
このコンテナレジストリは後ほど設定するkpackでも使用するので、ユーザー名とパスワードを環境変数に設定します。

```
export GITHUB_USERNAME=making
export GITHUB_API_TOKEN=*************

docker login ghcr.io -u ${GITHUB_USERNAME} -p ${GITHUB_API_TOKEN}
```

次のコマンドでCartographerのtarファイルをダウンロードして、`imgpkg` コマンドを使用してGitHub Packagesへrelocationします。

```
curl -sL https://github.com/vmware-tanzu/cartographer/releases/download/v0.0.6/bundle.tar > /tmp/bundle.tar
imgpkg copy --tar /tmp/bundle.tar --to-repo ghcr.io/${GITHUB_USERNAME}/cartographer-bundle --lock-output /tmp/cartographer-bundle.lock.yaml
```

次のようなログが出力されます。

```
copy | importing 2 images...

35.20 MiB / 35.27 MiB [===================================================================================================================================================================================================================================================]  99.80% 3.20 MiB/s 10s

copy | done uploading images
Succeeded
```

GitHub Packagesを確認すると `cartographer-bundle` というイメージがアップロードされていることがわかります。  

![image](https://user-images.githubusercontent.com/106908/136062122-5948e18a-cc7d-4a50-bce6-49f76c38cae1.png)

次に、次のコマンドを実行して、relocation後のimageの設定が反映されたmanifestファイル群を取得します。

```
imgpkg pull --lock /tmp/cartographer-bundle.lock.yaml --output /tmp/cartographer
```

次のようなログが出力されます。

```
Pulling bundle 'ghcr.io/making/cartographer-bundle@sha256:f7e402cfa7c9404afdb51f9c6967c688e2595660b9335429ed5a880fc2caa80f'
  Extracting layer 'sha256:ec8f865d6051db9570e067cf3604a19face114a6d1e8920b61bae44eae64078d' (1/1)

Locating image lock file images...
The bundle repo (ghcr.io/making/cartographer-bundle) is hosting every image specified in the bundle's Images Lock file (.imgpkg/images.yml)

Succeeded
```

次のようなファイルが取得されます。imgpkgの [bundle形式](https://carvel.dev/imgpkg/docs/latest/resources/#bundle) です。

```
$ find /tmp/cartographer 
/tmp/cartographer
/tmp/cartographer/.imgpkg
/tmp/cartographer/.imgpkg/images.yml
/tmp/cartographer/config
/tmp/cartographer/config/cartographer.yaml
/tmp/cartographer/config/overlays
/tmp/cartographer/config/overlays/.gitkeep
/tmp/cartographer/config/objects
/tmp/cartographer/config/objects/kapp-secret-ignore.yaml
```

次のコマンドでこのmanifestをデプロイします。ここでは`kbld`と`kapp`コマンドを使用します。

```
kubectl create namespace cartographer-system
kubectl create secret -n cartographer-system docker-registry private-registry-credentials --docker-server=ghcr.io --docker-username=${GITHUB_USERNAME} --docker-password=${GITHUB_API_TOKEN}
kbld -f /tmp/cartographer | kapp deploy -a cartographer -c -f - -y
```

インストールが完了すれば、次のコマンドを実行してどのようなリソースが作成されたか確認できます。

```
$ kapp inspect -a cartographer -t
Target cluster 'https://127.0.0.1:51332' (nodes: kind-control-plane)

Resources in app 'cartographer'

Namespace            Name                                         Kind                            Owner    Conds.  Rs  Ri  Age  
(cluster)            clusterimagetemplates.carto.run              CustomResourceDefinition        kapp     2/2 t   ok  -   30s  
(cluster)            clustersourcetemplates.carto.run             CustomResourceDefinition        kapp     2/2 t   ok  -   30s  
cartographer-system  cartographer-webhook                         Certificate                     kapp     1/1 t   ok  -   29s  
cartographer-system   L cartographer-webhook-chq25                CertificateRequest              cluster  2/2 t   ok  -   28s  
(cluster)            pipelines.carto.run                          CustomResourceDefinition        kapp     2/2 t   ok  -   30s  
(cluster)            clustersupplychainvalidator                  ValidatingWebhookConfiguration  kapp     -       ok  -   30s  
cartographer-system  cartographer-webhook                         Secret                          kapp     -       ok  -   30s  
(cluster)            clustersupplychains.carto.run                CustomResourceDefinition        kapp     2/2 t   ok  -   30s  
(cluster)            clusterconfigtemplates.carto.run             CustomResourceDefinition        kapp     2/2 t   ok  -   30s  
cartographer-system  cartographer-webhook                         Service                         kapp     -       ok  -   29s  
cartographer-system   L cartographer-webhook                      Endpoints                       cluster  -       ok  -   29s  
cartographer-system   L cartographer-webhook-kd7mx                EndpointSlice                   cluster  -       ok  -   29s  
(cluster)            clustertemplates.carto.run                   CustomResourceDefinition        kapp     2/2 t   ok  -   30s  
(cluster)            workloads.carto.run                          CustomResourceDefinition        kapp     2/2 t   ok  -   30s  
(cluster)            cartographer-cluster-admin                   ClusterRoleBinding              kapp     -       ok  -   30s  
cartographer-system  cartographer-controller                      ServiceAccount                  kapp     -       ok  -   30s  
cartographer-system  selfsigned-issuer                            Issuer                          kapp     1/1 t   ok  -   29s  
cartographer-system  cartographer-controller                      Deployment                      kapp     2/2 t   ok  -   29s  
cartographer-system   L cartographer-controller-f664d5bc          ReplicaSet                      cluster  -       ok  -   29s  
cartographer-system   L.. cartographer-controller-f664d5bc-vhg64  Pod                             cluster  4/4 t   ok  -   29s  
cartographer-system  private-registry-credentials                 Secret                          kapp     -       ok  -   30s  
(cluster)            runtemplates.carto.run                       CustomResourceDefinition        kapp     2/2 t   ok  -   30s  

Rs: Reconcile state
Ri: Reconcile information

22 resources

Succeeded
```

#### kpackの設定

次にkpackの設定を行います。

##### imagePullSecretの設定

`default` namespaceの`default` service accountに対してghcr.ioへの`imagePullSecret`を設定しておきます。

```
cat <<EOF > dockerconfig.yaml
apiVersion: v1
kind: Secret
metadata:
  name: regsecret
  namespace: default
type: kubernetes.io/dockerconfigjson
stringData:
  .dockerconfigjson: |
    {
      "auths": {
        "https://ghcr.io": {
          "username": "${GITHUB_USERNAME}",
          "password": "${GITHUB_API_TOKEN}"
        }
      }
    }
EOF
kubectl apply -f dockerconfig.yaml
kubectl patch -n default serviceaccount default -p "{\"secrets\":[{\"name\":\"regsecret\"}],\"imagePullSecrets\":[{\"name\":\"regsecret\"}]}"
```

##### ClusterBuilderの設定

[Paketo Buildpacks](https://paketo.io) を使ったClusterBuilder及び、ClusterStore、ClusterStackを定義します。
ここではGo、Java、Node.js、Rubyのみ対応します。

```yaml
cat <<EOF > clusterbuilder.yaml
apiVersion: kpack.io/v1alpha1
kind: ClusterStore
metadata:
  name: default
spec:
  sources:
  - image: gcr.io/paketo-buildpacks/ruby
  - image: gcr.io/paketo-buildpacks/nodejs
  - image: gcr.io/paketo-buildpacks/go
  - image: gcr.io/paketo-buildpacks/java
---
apiVersion: kpack.io/v1alpha1
kind: ClusterStack
metadata:
  name: base
spec:
  id: io.buildpacks.stacks.bionic
  buildImage:
    image: paketobuildpacks/build:base-cnb
  runImage:
    image: paketobuildpacks/run:base-cnb
---
apiVersion: kpack.io/v1alpha1
kind: ClusterBuilder
metadata:
  name: base
spec:
  serviceAccountRef:
    name: default
    namespace: default
  tag: ghcr.io/${GITHUB_USERNAME}/clusterbuilder:base
  stack:
    name: base
    kind: ClusterStack
  store:
    name: default
    kind: ClusterStore
  order:
  - group:
    - id: paketo-buildpacks/ruby
  - group:
    - id: paketo-buildpacks/nodejs
  - group:
    - id: paketo-buildpacks/go
  - group:
    - id: paketo-buildpacks/java
EOF
kubectl apply -f clusterbuilder.yaml 
```

しばらくするとClusterBuilderに対応するbuilderのイメージがアップロードされます。

```
$ kubectl get clusterbuilder
NAME   LATESTIMAGE                                                                                                  READY
base   ghcr.io/making/clusterbuilder:base@sha256:c3640f0f6e1643e692d7f2abacaee766dfb7f76fa84adc1bdc6ecdc5dcc29cfa   True
```

GitHub Packagesでそのイメージを確認できます。

![image](https://user-images.githubusercontent.com/106908/136072771-54443aa5-21a4-42d1-b9ab-b242e6561cf2.png)

> ⚠️ GitHub PackagesのFreeプランを使用する場合、private repositoryに対するストーレジと転送量の制約があるため、場合によってはpublic repositoryへ変更した方が良いかもしれません。

#### Supply Chainの設定

いよいよCartographerのSupply Chainを定義します。再掲になりますが、次のようなSupply Chainを作成します。

![image](https://user-images.githubusercontent.com/106908/136181993-3655c270-40b6-4d6d-b896-b57dbe7d438d.jpeg)

CartographerではSupply Chainを構成するテンプレートとして次の4種類を利用できます。

* [ClusterSourceTemplate](https://cartographer.sh/docs/v0.0.6/reference/#clustersourcetemplate) ... outputがソースコードの情報(urlとrevision)であるk8sリソースのテンプレート定義
* [ClusterImageTemplate](https://cartographer.sh/docs/v0.0.6/reference/#clusterimagetemplate) ... outputがコンテナイメージの情報(image name)であるk8sリソースのテンプレート定義
* [ClusterConfigTemplate](https://cartographer.sh/docs/v0.0.6/reference/#clusterconfigtemplate) ... outputが修正されたconfigであるk8sリソースのテンプレート定義
* [ClusterTemplate](https://cartographer.sh/docs/v0.0.6/reference/#clustertemplate) ... outputを必要としないk8sリソースのテンプレート定義

上記の例では

* GitRepositoryリソースのテンプレート定義　-> ClusterSourceTemplate
* Imageリソースのテンプレート定義 -> ClusterImageTemplate
* Deploy, Service, Ingressリソースのテンプレート定義 -> ClusterTemplate

に対応します。

##### Templatesの作成

各種テンプレートを次のように作成します。

```yaml
cat <<'EOF' | sed "s/CHANGE_ME/${GITHUB_USERNAME}/" > supply-chain-templates.yaml                       
apiVersion: carto.run/v1alpha1
kind: ClusterSourceTemplate
metadata:
  name: source
spec:
  urlPath: .status.artifact.url
  revisionPath: .status.artifact.revision
  template:
    apiVersion: source.toolkit.fluxcd.io/v1beta1
    kind: GitRepository
    metadata:
      name: $(workload.metadata.name)$
      labels:
        app.kubernetes.io/part-of: $(workload.metadata.name)$
    spec:
      interval: 3m
      url: $(workload.spec.source.git.url)$
      ref: $(workload.spec.source.git.ref)$
      ignore: ""
---
apiVersion: carto.run/v1alpha1
kind: ClusterImageTemplate
metadata:
  name: image
spec:
  imagePath: .status.latestImage
  template:
    apiVersion: kpack.io/v1alpha1
    kind: Image
    metadata:
      name: $(workload.metadata.name)$
      labels:
        app.kubernetes.io/part-of: $(workload.metadata.name)$
    spec:
      tag: ghcr.io/CHANGE_ME/$(workload.metadata.name)$
      serviceAccount: default
      builder:
        kind: ClusterBuilder
        name: base
      source:
        blob:
          url: $(sources.source.url)$
---
apiVersion: carto.run/v1alpha1
kind: ClusterTemplate
metadata:
  name: app-deploy-deployment
spec:
  template:
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: $(workload.metadata.name)$
      labels:
        app.kubernetes.io/part-of: $(workload.metadata.name)$
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/part-of: $(workload.metadata.name)$          
        spec:
          containers:
          - name: workload
            image: $(images.image.image)$
            env: $(workload.spec.env)$
            resources: $(workload.spec.resources)$
            ports:
            - name: http-port
              containerPort: 8080
            securityContext:
              runAsUser: 1000
      selector:
        matchLabels:
          app.kubernetes.io/part-of: $(workload.metadata.name)$
---
apiVersion: carto.run/v1alpha1
kind: ClusterTemplate
metadata:
  name: app-deploy-service
spec:
  template:
    apiVersion: v1
    kind: Service
    metadata:
      name: $(workload.metadata.name)$
      labels:
        app.kubernetes.io/part-of: $(workload.metadata.name)$
    spec:
      ports:
      - name: http
        port: 80
        protocol: TCP
        targetPort: 8080
      selector:
        app.kubernetes.io/part-of: $(workload.metadata.name)$ 
      type: ClusterIP
---
apiVersion: carto.run/v1alpha1
kind: ClusterTemplate
metadata:
  name: app-deploy-ingress
spec:
  template:
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: $(workload.metadata.name)$
      labels:
        app.kubernetes.io/part-of: $(workload.metadata.name)$ 
    spec:
      rules:
      - host: $(workload.metadata.name)$-127-0-0-1.sslip.io
        http:
          paths:
          - backend:
              service:
                name: $(workload.metadata.name)$
                port:
                  number: 80
            path: /
            pathType: Exact
EOF
kubectl apply -f supply-chain-templates.yaml
```

##### SupplyChainの定義

定義したテンプレートを組み合わせたSupply ChainをClusterSupplyChainリソースとして次のように定義します。

```yaml
cat <<'EOF' > supply-chain.yaml
apiVersion: carto.run/v1alpha1
kind: ClusterSupplyChain
metadata:
  name: supply-chain
spec:
  selector:
    app.tanzu.vmware.com/workload-type: web
  components:
  - name: source-provider
    templateRef:
      kind: ClusterSourceTemplate
      name: source
  - name: image-builder
    templateRef:
      kind: ClusterImageTemplate
      name: image
    sources:
    - component: source-provider
      name: source
  - name: deployer-deployment
    templateRef:
      kind: ClusterTemplate
      name: app-deploy-deployment
    images:
    - component: image-builder
      name: image
  - name: deployer-service
    templateRef:
      kind: ClusterTemplate
      name: app-deploy-service  
  - name: deployer-ingress
    templateRef:
      kind: ClusterTemplate
      name: app-deploy-ingress
EOF
kubectl apply -f supply-chain.yaml
```

ここまではOperatorの役目です。

#### Workloadのデプロイ

このSupply Chainを使って、いよいよアプリケーションをデプロイします。ここからはDeveloperの役目です。

##### Goアプリのデプロイ

まずはGoのアプリをデプロイします。デプロイするサンプルアプリとして https://github.com/making/hello-golang を使用します。

次のWorkloadを作成します。Developerとして定義する内容はこれだけです。どのようにコンテナイメージが作られてどのようにk8sへデプロイするかを意識する必要がありません。

```yaml
cat <<EOF > hello-golang.yaml
apiVersion: carto.run/v1alpha1
kind: Workload
metadata:
  labels:
    app.tanzu.vmware.com/workload-type: web
  name: hello-golang
spec:
  source:
    git:
      url: https://github.com/making/hello-golang.git
      ref:
        branch: master
  env:
  - name: TARGET
    value: World            
  resources: {}    
EOF
kubectl apply -f hello-golang.yaml
```

実際にどのような処理が行われているかをログで確認します。複数のコンテナで処理が行われるので [stern](https://github.com/stern/stern) を使用すると良いです。 

ソースコード(tar.gz)が取得され、そのソースコードがGoのものであることが検出され、ビルドが行われて、イメージがpushされ、その後アプリケーションが起動していることがわかります。

```
$ stern 'hello-golang.*'    

+ hello-golang-build-1-rqzsd-build-pod › prepare
hello-golang-build-1-rqzsd-build-pod prepare Build reason(s): CONFIG
hello-golang-build-1-rqzsd-build-pod prepare CONFIG:
hello-golang-build-1-rqzsd-build-pod prepare 	resources: {}
hello-golang-build-1-rqzsd-build-pod prepare 	- source: {}
hello-golang-build-1-rqzsd-build-pod prepare 	+ source:
hello-golang-build-1-rqzsd-build-pod prepare 	+   blob:
hello-golang-build-1-rqzsd-build-pod prepare 	+     url: http://source-controller.gitops-toolkit.svc.cluster.local./gitrepository/default/hello-golang/1f8f29d92011f329b695223a35bf3f480c05f8a2.tar.gz
hello-golang-build-1-rqzsd-build-pod prepare Loading secret for "https://ghcr.io" from secret "regsecret" at location "/var/build-secrets/regsecret"
hello-golang-build-1-rqzsd-build-pod prepare Downloading source-controller.gitops-toolkit.svc.cluster.local./gitrepository/default/hello-golang/1f8f29d92011f329b695223a35bf3f480c05f8a2.tar.gz...
hello-golang-build-1-rqzsd-build-pod prepare Successfully downloaded source-controller.gitops-toolkit.svc.cluster.local./gitrepository/default/hello-golang/1f8f29d92011f329b695223a35bf3f480c05f8a2.tar.gz in path "/workspace"
- hello-golang-build-1-rqzsd-build-pod › prepare
+ hello-golang-build-1-rqzsd-build-pod › detect
hello-golang-build-1-rqzsd-build-pod detect 4 of 7 buildpacks participating
hello-golang-build-1-rqzsd-build-pod detect paketo-buildpacks/ca-certificates 2.3.2
hello-golang-build-1-rqzsd-build-pod detect paketo-buildpacks/go-dist         0.6.0
hello-golang-build-1-rqzsd-build-pod detect paketo-buildpacks/go-mod-vendor   0.3.1
hello-golang-build-1-rqzsd-build-pod detect paketo-buildpacks/go-build        0.4.1
- hello-golang-build-1-rqzsd-build-pod › detect
+ hello-golang-build-1-rqzsd-build-pod › analyze
hello-golang-build-1-rqzsd-build-pod analyze Previous image with name "ghcr.io/making/hello-golang" not found
- hello-golang-build-1-rqzsd-build-pod › analyze
+ hello-golang-build-1-rqzsd-build-pod › build
hello-golang-build-1-rqzsd-build-pod build 
hello-golang-build-1-rqzsd-build-pod build Paketo CA Certificates Buildpack 2.3.2
hello-golang-build-1-rqzsd-build-pod build   https://github.com/paketo-buildpacks/ca-certificates
hello-golang-build-1-rqzsd-build-pod build   Launch Helper: Contributing to layer
hello-golang-build-1-rqzsd-build-pod build     Creating /layers/paketo-buildpacks_ca-certificates/helper/exec.d/ca-certificates-helper
hello-golang-build-1-rqzsd-build-pod build Paketo Go Distribution Buildpack 0.6.0
hello-golang-build-1-rqzsd-build-pod build   Resolving Go version
hello-golang-build-1-rqzsd-build-pod build     Candidate version sources (in priority order):
hello-golang-build-1-rqzsd-build-pod build       go.mod    -> ">= 1.16"
hello-golang-build-1-rqzsd-build-pod build       <unknown> -> ""
hello-golang-build-1-rqzsd-build-pod build 
hello-golang-build-1-rqzsd-build-pod build     Selected Go version (using go.mod): 1.17
hello-golang-build-1-rqzsd-build-pod build 
hello-golang-build-1-rqzsd-build-pod build   Executing build process
hello-golang-build-1-rqzsd-build-pod build     Installing Go 1.17
hello-golang-build-1-rqzsd-build-pod build       Completed in 7.806s
hello-golang-build-1-rqzsd-build-pod build 
hello-golang-build-1-rqzsd-build-pod build Paketo Go Mod Vendor Buildpack 0.3.1
hello-golang-build-1-rqzsd-build-pod build   Checking module graph
hello-golang-build-1-rqzsd-build-pod build     Running 'go mod graph'
hello-golang-build-1-rqzsd-build-pod build       Completed in 6ms
hello-golang-build-1-rqzsd-build-pod build 
hello-golang-build-1-rqzsd-build-pod build   Skipping build process: module graph is empty
hello-golang-build-1-rqzsd-build-pod build 
hello-golang-build-1-rqzsd-build-pod build Paketo Go Build Buildpack 0.4.1
hello-golang-build-1-rqzsd-build-pod build   Executing build process
hello-golang-build-1-rqzsd-build-pod build     Running 'go build -o /layers/paketo-buildpacks_go-build/targets/bin -buildmode pie .'
hello-golang-build-1-rqzsd-build-pod build       Completed in 15.708s
hello-golang-build-1-rqzsd-build-pod build 
hello-golang-build-1-rqzsd-build-pod build   Assigning launch processes:
hello-golang-build-1-rqzsd-build-pod build     web: /layers/paketo-buildpacks_go-build/targets/bin/hello-golang
hello-golang-build-1-rqzsd-build-pod build     hello-golang: /layers/paketo-buildpacks_go-build/targets/bin/hello-golang
hello-golang-build-1-rqzsd-build-pod build 
- hello-golang-build-1-rqzsd-build-pod › build
+ hello-golang-build-1-rqzsd-build-pod › export
hello-golang-build-1-rqzsd-build-pod export Adding layer 'paketo-buildpacks/ca-certificates:helper'
hello-golang-build-1-rqzsd-build-pod export Adding layer 'paketo-buildpacks/go-build:targets'
hello-golang-build-1-rqzsd-build-pod export Adding 1/1 app layer(s)
hello-golang-build-1-rqzsd-build-pod export Adding layer 'launcher'
hello-golang-build-1-rqzsd-build-pod export Adding layer 'config'
hello-golang-build-1-rqzsd-build-pod export Adding layer 'process-types'
hello-golang-build-1-rqzsd-build-pod export Adding label 'io.buildpacks.lifecycle.metadata'
hello-golang-build-1-rqzsd-build-pod export Adding label 'io.buildpacks.build.metadata'
hello-golang-build-1-rqzsd-build-pod export Adding label 'io.buildpacks.project.metadata'
hello-golang-build-1-rqzsd-build-pod export Setting default process type 'web'
hello-golang-build-1-rqzsd-build-pod export Saving ghcr.io/making/hello-golang...
hello-golang-build-1-rqzsd-build-pod export *** Images (sha256:9cfb82e456bdff7e0b2dea85b48235da56b12667a52fb865de9067132fb2071a):
hello-golang-build-1-rqzsd-build-pod export       ghcr.io/making/hello-golang
hello-golang-build-1-rqzsd-build-pod export       ghcr.io/making/hello-golang:b1.20211006.005809
hello-golang-build-1-rqzsd-build-pod export Adding cache layer 'paketo-buildpacks/go-dist:go'
hello-golang-build-1-rqzsd-build-pod export Adding cache layer 'paketo-buildpacks/go-build:gocache'
- hello-golang-build-1-rqzsd-build-pod › export
+ hello-golang-566c6c75c7-b6tdr › workload
hello-golang-566c6c75c7-b6tdr workload 2021/10/06 00:59:38 helloworld: starting server...
hello-golang-566c6c75c7-b6tdr workload 2021/10/06 00:59:38 helloworld: listening on port 8080
```

このWorkloadからSupply Chainを経由して作成されるリソースを次のコマンドで確認します。

```
$ kubectl get workload,deploy,pod,image,build,gitrepo,service,ingress  

NAME                              AGE
workload.carto.run/hello-golang   2m31s

NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/hello-golang   1/1     1            1           61s

NAME                                       READY   STATUS      RESTARTS   AGE
pod/hello-golang-566c6c75c7-b6tdr          1/1     Running     0          61s
pod/hello-golang-build-1-rqzsd-build-pod   0/1     Completed   0          2m25s

NAME                          LATESTIMAGE                                                                                           READY
image.kpack.io/hello-golang   ghcr.io/making/hello-golang@sha256:9cfb82e456bdff7e0b2dea85b48235da56b12667a52fb865de9067132fb2071a   True

NAME                                        IMAGE                                                                                                 SUCCEEDED
build.kpack.io/hello-golang-build-1-rqzsd   ghcr.io/making/hello-golang@sha256:9cfb82e456bdff7e0b2dea85b48235da56b12667a52fb865de9067132fb2071a   True

NAME                                                  URL                                          READY   STATUS                                                              AGE
gitrepository.source.toolkit.fluxcd.io/hello-golang   https://github.com/making/hello-golang.git   True    Fetched revision: master/1f8f29d92011f329b695223a35bf3f480c05f8a2   2m31s

NAME                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/hello-golang   ClusterIP   10.96.31.196   <none>        80/TCP    61s
service/kubernetes     ClusterIP   10.96.0.1      <none>        443/TCP   7h54m

NAME                                    　CLASS   HOSTS                             ADDRESS   PORTS   AGE
ingress.networking.k8s.io/hello-golang    <none>  hello-golang-127-0-0-1.sslip.io             80      61s
```

IngressのURL( http://hello-golang-127-0-0-1.sslip.io )にアクセスします。

```
$ curl http://hello-golang-127-0-0-1.sslip.io
Hello World!
```

"Hello World!"が返りました。

WorkloadにはソースコードのURLしか書いていないですが、アプリがURLでアクセスなところまで用意されました。
これはPaaSで実現されていた"Source to URL"に近い体験です。


ここでは割愛しますが、ソースコードを変更してgit pushすれば新しいイメージが作成されて、再デプロイされます。

Workloadを削除すれば、各種リソースも削除されます。
```
kubectl delete -f hello-golang.yaml
```

##### Javaアプリのデプロイ

次にJavaのアプリをデプロイします。デプロイするサンプルアプリとして https://github.com/tanzu-japan/hello-tanzu を使用します。

次のWorkloadを作成します。

```yaml
cat <<EOF > hello-tanzu.yaml
apiVersion: carto.run/v1alpha1
kind: Workload
metadata:
  labels:
    app.tanzu.vmware.com/workload-type: web
  name: hello-tanzu
spec:
  source:
    git:
      url: https://github.com/tanzu-japan/hello-tanzu.git
      ref:
        branch: main
  env: []
  resources: {}        
EOF
kubectl apply -f hello-tanzu.yaml
```

同様にsternでログを確認すれば、ソースコード取得後Mavenによるビルドが行われ、イメージ作成後にデプロイされてTomcatが起動していることがわかります。
なお、Mavenによるビルドは2回目移行はキャッシュされます。

```
$ stern 'hello-tanzu.*'     

+ hello-tanzu-build-1-fvt6g-build-pod › prepare
hello-tanzu-build-1-fvt6g-build-pod prepare Build reason(s): CONFIG
hello-tanzu-build-1-fvt6g-build-pod prepare CONFIG:
hello-tanzu-build-1-fvt6g-build-pod prepare 	resources: {}
hello-tanzu-build-1-fvt6g-build-pod prepare 	- source: {}
hello-tanzu-build-1-fvt6g-build-pod prepare 	+ source:
hello-tanzu-build-1-fvt6g-build-pod prepare 	+   blob:
hello-tanzu-build-1-fvt6g-build-pod prepare 	+     url: http://source-controller.gitops-toolkit.svc.cluster.local./gitrepository/default/hello-tanzu/4ecc9c52d4209560e1b2f96576bab9f51cfa3661.tar.gz
hello-tanzu-build-1-fvt6g-build-pod prepare Loading secret for "https://ghcr.io" from secret "regsecret" at location "/var/build-secrets/regsecret"
hello-tanzu-build-1-fvt6g-build-pod prepare Downloading source-controller.gitops-toolkit.svc.cluster.local./gitrepository/default/hello-tanzu/4ecc9c52d4209560e1b2f96576bab9f51cfa3661.tar.gz...
hello-tanzu-build-1-fvt6g-build-pod prepare Successfully downloaded source-controller.gitops-toolkit.svc.cluster.local./gitrepository/default/hello-tanzu/4ecc9c52d4209560e1b2f96576bab9f51cfa3661.tar.gz in path "/workspace"
- hello-tanzu-build-1-fvt6g-build-pod › prepare
+ hello-tanzu-build-1-fvt6g-build-pod › analyze
hello-tanzu-build-1-fvt6g-build-pod analyze Restoring metadata for "paketo-buildpacks/ca-certificates:helper" from app image
hello-tanzu-build-1-fvt6g-build-pod analyze Restoring metadata for "paketo-buildpacks/bellsoft-liberica:helper" from app image
hello-tanzu-build-1-fvt6g-build-pod analyze Restoring metadata for "paketo-buildpacks/bellsoft-liberica:java-security-properties" from app image
hello-tanzu-build-1-fvt6g-build-pod analyze Restoring metadata for "paketo-buildpacks/bellsoft-liberica:jre" from app image
hello-tanzu-build-1-fvt6g-build-pod analyze Restoring metadata for "paketo-buildpacks/apache-tomcat:tomcat" from app image
hello-tanzu-build-1-fvt6g-build-pod analyze Restoring metadata for "paketo-buildpacks/apache-tomcat:catalina-base" from app image
hello-tanzu-build-1-fvt6g-build-pod analyze Restoring metadata for "paketo-buildpacks/apache-tomcat:helper" from app image
- hello-tanzu-build-1-fvt6g-build-pod › analyze
+ hello-tanzu-build-1-fvt6g-build-pod › build
hello-tanzu-build-1-fvt6g-build-pod build 
hello-tanzu-build-1-fvt6g-build-pod build Paketo CA Certificates Buildpack 2.4.1
hello-tanzu-build-1-fvt6g-build-pod build   https://github.com/paketo-buildpacks/ca-certificates
hello-tanzu-build-1-fvt6g-build-pod build   Launch Helper: Reusing cached layer
hello-tanzu-build-1-fvt6g-build-pod build 
hello-tanzu-build-1-fvt6g-build-pod build Paketo BellSoft Liberica Buildpack 8.7.1
hello-tanzu-build-1-fvt6g-build-pod build   https://github.com/paketo-buildpacks/bellsoft-liberica
hello-tanzu-build-1-fvt6g-build-pod build   Build Configuration:
hello-tanzu-build-1-fvt6g-build-pod build     $BP_JVM_TYPE                 JRE             the JVM type - JDK or JRE
hello-tanzu-build-1-fvt6g-build-pod build     $BP_JVM_VERSION              11              the Java version
hello-tanzu-build-1-fvt6g-build-pod build   Launch Configuration:
hello-tanzu-build-1-fvt6g-build-pod build     $BPL_DEBUG_ENABLED           false           enables Java remote debugging support
hello-tanzu-build-1-fvt6g-build-pod build     $BPL_DEBUG_PORT              8000            configure the remote debugging port
hello-tanzu-build-1-fvt6g-build-pod build     $BPL_DEBUG_SUSPEND           false           configure whether to suspend execution until a debugger has attached
hello-tanzu-build-1-fvt6g-build-pod build     $BPL_HEAP_DUMP_PATH                          write heap dumps on error to this path
hello-tanzu-build-1-fvt6g-build-pod build     $BPL_JAVA_NMT_ENABLED        true            enables Java Native Memory Tracking (NMT)
hello-tanzu-build-1-fvt6g-build-pod build     $BPL_JAVA_NMT_LEVEL          summary         configure level of NMT, summary or detail
hello-tanzu-build-1-fvt6g-build-pod build     $BPL_JMX_ENABLED             false           enables Java Management Extensions (JMX)
hello-tanzu-build-1-fvt6g-build-pod build     $BPL_JMX_PORT                5000            configure the JMX port
hello-tanzu-build-1-fvt6g-build-pod build     $BPL_JVM_HEAD_ROOM           0               the headroom in memory calculation
hello-tanzu-build-1-fvt6g-build-pod build     $BPL_JVM_LOADED_CLASS_COUNT  35% of classes  the number of loaded classes in memory calculation
hello-tanzu-build-1-fvt6g-build-pod build     $BPL_JVM_THREAD_COUNT        250             the number of threads in memory calculation
hello-tanzu-build-1-fvt6g-build-pod build     $JAVA_TOOL_OPTIONS                           the JVM launch flags
hello-tanzu-build-1-fvt6g-build-pod build   BellSoft Liberica JDK 11.0.12: Contributing to layer
hello-tanzu-build-1-fvt6g-build-pod build     Downloading from https://github.com/bell-sw/Liberica/releases/download/11.0.12+7/bellsoft-jdk11.0.12+7-linux-amd64.tar.gz
hello-tanzu-build-1-fvt6g-build-pod build     Verifying checksum
hello-tanzu-build-1-fvt6g-build-pod build     Expanding to /layers/paketo-buildpacks_bellsoft-liberica/jdk
hello-tanzu-build-1-fvt6g-build-pod build     Adding 128 container CA certificates to JVM truststore
hello-tanzu-build-1-fvt6g-build-pod build     Writing env.build/JAVA_HOME.override
hello-tanzu-build-1-fvt6g-build-pod build     Writing env.build/JDK_HOME.override
hello-tanzu-build-1-fvt6g-build-pod build   BellSoft Liberica JRE 11.0.12: Contributing to layer
hello-tanzu-build-1-fvt6g-build-pod build     Downloading from https://github.com/bell-sw/Liberica/releases/download/11.0.12+7/bellsoft-jre11.0.12+7-linux-amd64.tar.gz
hello-tanzu-build-1-fvt6g-build-pod build     Verifying checksum
hello-tanzu-build-1-fvt6g-build-pod build     Expanding to /layers/paketo-buildpacks_bellsoft-liberica/jre
hello-tanzu-build-1-fvt6g-build-pod build     Adding 128 container CA certificates to JVM truststore
hello-tanzu-build-1-fvt6g-build-pod build     Writing env.launch/BPI_APPLICATION_PATH.default
hello-tanzu-build-1-fvt6g-build-pod build     Writing env.launch/BPI_JVM_CACERTS.default
hello-tanzu-build-1-fvt6g-build-pod build     Writing env.launch/BPI_JVM_CLASS_COUNT.default
hello-tanzu-build-1-fvt6g-build-pod build     Writing env.launch/BPI_JVM_SECURITY_PROVIDERS.default
hello-tanzu-build-1-fvt6g-build-pod build     Writing env.launch/JAVA_HOME.default
hello-tanzu-build-1-fvt6g-build-pod build     Writing env.launch/JAVA_TOOL_OPTIONS.append
hello-tanzu-build-1-fvt6g-build-pod build     Writing env.launch/JAVA_TOOL_OPTIONS.delim
hello-tanzu-build-1-fvt6g-build-pod build     Writing env.launch/MALLOC_ARENA_MAX.default
hello-tanzu-build-1-fvt6g-build-pod build   Launch Helper: Contributing to layer
hello-tanzu-build-1-fvt6g-build-pod build     Creating /layers/paketo-buildpacks_bellsoft-liberica/helper/exec.d/active-processor-count
hello-tanzu-build-1-fvt6g-build-pod build     Creating /layers/paketo-buildpacks_bellsoft-liberica/helper/exec.d/java-opts
hello-tanzu-build-1-fvt6g-build-pod build     Creating /layers/paketo-buildpacks_bellsoft-liberica/helper/exec.d/jvm-heap
hello-tanzu-build-1-fvt6g-build-pod build     Creating /layers/paketo-buildpacks_bellsoft-liberica/helper/exec.d/link-local-dns
hello-tanzu-build-1-fvt6g-build-pod build     Creating /layers/paketo-buildpacks_bellsoft-liberica/helper/exec.d/memory-calculator
hello-tanzu-build-1-fvt6g-build-pod build     Creating /layers/paketo-buildpacks_bellsoft-liberica/helper/exec.d/openssl-certificate-loader
hello-tanzu-build-1-fvt6g-build-pod build     Creating /layers/paketo-buildpacks_bellsoft-liberica/helper/exec.d/security-providers-configurer
hello-tanzu-build-1-fvt6g-build-pod build     Creating /layers/paketo-buildpacks_bellsoft-liberica/helper/exec.d/jmx
hello-tanzu-build-1-fvt6g-build-pod build     Creating /layers/paketo-buildpacks_bellsoft-liberica/helper/exec.d/security-providers-classpath-9
hello-tanzu-build-1-fvt6g-build-pod build     Creating /layers/paketo-buildpacks_bellsoft-liberica/helper/exec.d/debug-9
hello-tanzu-build-1-fvt6g-build-pod build     Creating /layers/paketo-buildpacks_bellsoft-liberica/helper/exec.d/nmt
hello-tanzu-build-1-fvt6g-build-pod build   Java Security Properties: Contributing to layer
hello-tanzu-build-1-fvt6g-build-pod build     Writing env.launch/JAVA_SECURITY_PROPERTIES.default
hello-tanzu-build-1-fvt6g-build-pod build     Writing env.launch/JAVA_TOOL_OPTIONS.append
hello-tanzu-build-1-fvt6g-build-pod build     Writing env.launch/JAVA_TOOL_OPTIONS.delim
hello-tanzu-build-1-fvt6g-build-pod build 
hello-tanzu-build-1-fvt6g-build-pod build Paketo Maven Buildpack 5.6.0
hello-tanzu-build-1-fvt6g-build-pod build   https://github.com/paketo-buildpacks/maven
hello-tanzu-build-1-fvt6g-build-pod build   Build Configuration:
hello-tanzu-build-1-fvt6g-build-pod build     $BP_MAVEN_BUILD_ARGUMENTS  -Dmaven.test.skip=true package  the arguments to pass to Maven
hello-tanzu-build-1-fvt6g-build-pod build     $BP_MAVEN_BUILT_ARTIFACT   target/*.[ejw]ar                the built application artifact explicitly.  Supersedes $BP_MAVEN_BUILT_MODULE
hello-tanzu-build-1-fvt6g-build-pod build     $BP_MAVEN_BUILT_MODULE                                     the module to find application artifact in
hello-tanzu-build-1-fvt6g-build-pod build     $BP_MAVEN_POM_FILE         pom.xml                         the location of the main pom.xml file, relative to the application root
hello-tanzu-build-1-fvt6g-build-pod build     Creating cache directory /home/cnb/.m2
hello-tanzu-build-1-fvt6g-build-pod build   Compiled Application: Contributing to layer
hello-tanzu-build-1-fvt6g-build-pod build     Executing mvnw --batch-mode -Dmaven.test.skip=true package
hello-tanzu-build-1-fvt6g-build-pod build [INFO] Scanning for projects...
hello-tanzu-build-1-fvt6g-build-pod build [INFO] 
hello-tanzu-build-1-fvt6g-build-pod build [INFO] ----------------------< org.example:hello-tanzu >-----------------------
hello-tanzu-build-1-fvt6g-build-pod build [INFO] Building hello-tanzu 1.0.0-SNAPSHOT
hello-tanzu-build-1-fvt6g-build-pod build [INFO] --------------------------------[ war ]---------------------------------
hello-tanzu-build-1-fvt6g-build-pod build [INFO] Downloading from central: https://repo.maven.apache.org/maven2/org/apache/maven/plugins/maven-resources-plugin/2.6/maven-resources-plugin-2.6.pom
...
hello-tanzu-build-1-fvt6g-build-pod build [INFO] Downloaded from central: https://repo.maven.apache.org/maven2/org/codehaus/plexus/plexus-utils/3.0/plexus-utils-3.0.jar (226 kB at 404 kB/s)
hello-tanzu-build-1-fvt6g-build-pod build WARNING: An illegal reflective access operation has occurred
hello-tanzu-build-1-fvt6g-build-pod build WARNING: Illegal reflective access by com.thoughtworks.xstream.core.util.Fields (file:/home/cnb/.m2/repository/com/thoughtworks/xstream/xstream/1.3.1/xstream-1.3.1.jar) to field java.util.Properties.defaults
hello-tanzu-build-1-fvt6g-build-pod build WARNING: Please consider reporting this to the maintainers of com.thoughtworks.xstream.core.util.Fields
hello-tanzu-build-1-fvt6g-build-pod build WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
hello-tanzu-build-1-fvt6g-build-pod build WARNING: All illegal access operations will be denied in a future release
hello-tanzu-build-1-fvt6g-build-pod build [INFO] Packaging webapp
hello-tanzu-build-1-fvt6g-build-pod build [INFO] Assembling webapp [hello-tanzu] in [/workspace/target/ROOT]
hello-tanzu-build-1-fvt6g-build-pod build [INFO] Processing war project
hello-tanzu-build-1-fvt6g-build-pod build [INFO] Webapp assembled in [42 msecs]
hello-tanzu-build-1-fvt6g-build-pod build [INFO] Building war: /workspace/target/ROOT.war
hello-tanzu-build-1-fvt6g-build-pod build [INFO] ------------------------------------------------------------------------
hello-tanzu-build-1-fvt6g-build-pod build [INFO] BUILD SUCCESS
hello-tanzu-build-1-fvt6g-build-pod build [INFO] ------------------------------------------------------------------------
hello-tanzu-build-1-fvt6g-build-pod build [INFO] Total time:  01:02 min
hello-tanzu-build-1-fvt6g-build-pod build [INFO] Finished at: 2021-10-06T01:38:39Z
hello-tanzu-build-1-fvt6g-build-pod build [INFO] ------------------------------------------------------------------------
hello-tanzu-build-1-fvt6g-build-pod build   Removing source code
hello-tanzu-build-1-fvt6g-build-pod build 
hello-tanzu-build-1-fvt6g-build-pod build Paketo Apache Tomcat Buildpack 6.3.0
hello-tanzu-build-1-fvt6g-build-pod build   https://github.com/paketo-buildpacks/apache-tomcat
hello-tanzu-build-1-fvt6g-build-pod build   Build Configuration:
hello-tanzu-build-1-fvt6g-build-pod build     $BP_TOMCAT_CONTEXT_PATH                  the application context path
hello-tanzu-build-1-fvt6g-build-pod build     $BP_TOMCAT_EXT_CONF_SHA256               the SHA256 hash of the external Tomcat configuration archive
hello-tanzu-build-1-fvt6g-build-pod build     $BP_TOMCAT_EXT_CONF_STRIP           0    the number of directory components to strip from the external Tomcat configuration archive
hello-tanzu-build-1-fvt6g-build-pod build     $BP_TOMCAT_EXT_CONF_URI                  the download location of the external Tomcat configuration
hello-tanzu-build-1-fvt6g-build-pod build     $BP_TOMCAT_EXT_CONF_VERSION              the version of the external Tomcat configuration
hello-tanzu-build-1-fvt6g-build-pod build     $BP_TOMCAT_VERSION                  9.*  the Tomcat version
hello-tanzu-build-1-fvt6g-build-pod build   Launch Configuration:
hello-tanzu-build-1-fvt6g-build-pod build     $BPL_TOMCAT_ACCESS_LOGGING_ENABLED       the Tomcat access logging state
hello-tanzu-build-1-fvt6g-build-pod build   Apache Tomcat 9.0.53: Reusing cached layer
hello-tanzu-build-1-fvt6g-build-pod build   Launch Helper: Reusing cached layer
hello-tanzu-build-1-fvt6g-build-pod build   Apache Tomcat Support: Reusing cached layer
hello-tanzu-build-1-fvt6g-build-pod build   Process types:
hello-tanzu-build-1-fvt6g-build-pod build     task:   catalina.sh run
hello-tanzu-build-1-fvt6g-build-pod build     tomcat: catalina.sh run
hello-tanzu-build-1-fvt6g-build-pod build     web:    catalina.sh run
- hello-tanzu-build-1-fvt6g-build-pod › build
+ hello-tanzu-build-1-fvt6g-build-pod › export
hello-tanzu-build-1-fvt6g-build-pod export Reusing layers from image 'ghcr.io/making/hello-tanzu@sha256:46cb3da1810e437e65dcf1c46f1d8deb8f164a6586c1f347a3666ae2761370e6'
hello-tanzu-build-1-fvt6g-build-pod export Reusing layer 'paketo-buildpacks/ca-certificates:helper'
hello-tanzu-build-1-fvt6g-build-pod export Adding layer 'paketo-buildpacks/bellsoft-liberica:helper'
hello-tanzu-build-1-fvt6g-build-pod export Reusing layer 'paketo-buildpacks/bellsoft-liberica:java-security-properties'
hello-tanzu-build-1-fvt6g-build-pod export Adding layer 'paketo-buildpacks/bellsoft-liberica:jre'
hello-tanzu-build-1-fvt6g-build-pod export Reusing layer 'paketo-buildpacks/apache-tomcat:catalina-base'
hello-tanzu-build-1-fvt6g-build-pod export Reusing layer 'paketo-buildpacks/apache-tomcat:helper'
hello-tanzu-build-1-fvt6g-build-pod export Reusing layer 'paketo-buildpacks/apache-tomcat:tomcat'
hello-tanzu-build-1-fvt6g-build-pod export Adding 1/1 app layer(s)
hello-tanzu-build-1-fvt6g-build-pod export Reusing layer 'launcher'
hello-tanzu-build-1-fvt6g-build-pod export Adding layer 'config'
hello-tanzu-build-1-fvt6g-build-pod export Reusing layer 'process-types'
hello-tanzu-build-1-fvt6g-build-pod export Adding label 'io.buildpacks.lifecycle.metadata'
hello-tanzu-build-1-fvt6g-build-pod export Adding label 'io.buildpacks.build.metadata'
hello-tanzu-build-1-fvt6g-build-pod export Adding label 'io.buildpacks.project.metadata'
hello-tanzu-build-1-fvt6g-build-pod export Setting default process type 'web'
hello-tanzu-build-1-fvt6g-build-pod export Saving ghcr.io/making/hello-tanzu...
hello-tanzu-build-1-fvt6g-build-pod export *** Images (sha256:ab5c70080c2b8a73b67d90b1255a1f92a7a6261d03cf35f5812457214b00c626):
hello-tanzu-build-1-fvt6g-build-pod export       ghcr.io/making/hello-tanzu
hello-tanzu-build-1-fvt6g-build-pod export       ghcr.io/making/hello-tanzu:b1.20211006.013705
hello-tanzu-build-1-fvt6g-build-pod export Adding cache layer 'paketo-buildpacks/bellsoft-liberica:jdk'
hello-tanzu-build-1-fvt6g-build-pod export Adding cache layer 'paketo-buildpacks/maven:application'
hello-tanzu-build-1-fvt6g-build-pod export Adding cache layer 'paketo-buildpacks/maven:cache'
- hello-tanzu-build-1-fvt6g-build-pod › export
+ hello-tanzu-54dd5899f4-hsxb6 › workload
hello-tanzu-54dd5899f4-hsxb6 workload Setting Active Processor Count to 6
hello-tanzu-54dd5899f4-hsxb6 workload Calculating JVM memory based on 13829004K available memory
hello-tanzu-54dd5899f4-hsxb6 workload Calculated JVM Memory Configuration: -XX:MaxDirectMemorySize=10M -Xmx13252315K -XX:MaxMetaspaceSize=64688K -XX:ReservedCodeCacheSize=240M -Xss1M (Total Memory: 13829004K, Thread Count: 250, Loaded Class Count: 9007, Headroom: 0%)
hello-tanzu-54dd5899f4-hsxb6 workload Enabling Java Native Memory Tracking
hello-tanzu-54dd5899f4-hsxb6 workload Adding 128 container CA certificates to JVM truststore
hello-tanzu-54dd5899f4-hsxb6 workload NOTE: Picked up JDK_JAVA_OPTIONS:  --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.util.concurrent=ALL-UNNAMED --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED
hello-tanzu-54dd5899f4-hsxb6 workload Picked up JAVA_TOOL_OPTIONS: -Djava.security.properties=/layers/paketo-buildpacks_bellsoft-liberica/java-security-properties/java-security.properties -XX:+ExitOnOutOfMemoryError -XX:ActiveProcessorCount=6 -XX:MaxDirectMemorySize=10M -Xmx13252315K -XX:MaxMetaspaceSize=64688K -XX:ReservedCodeCacheSize=240M -Xss1M -XX:+UnlockDiagnosticVMOptions -XX:NativeMemoryTracking=summary -XX:+PrintNMTStatistics
hello-tanzu-54dd5899f4-hsxb6 workload [CONTAINER] org.apache.coyote.http11.Http11NioProtocol         INFO    Initializing ProtocolHandler ["http-nio-8080"]
hello-tanzu-54dd5899f4-hsxb6 workload [CONTAINER] org.apache.catalina.startup.Catalina               INFO    Server initialization in [630] milliseconds
hello-tanzu-54dd5899f4-hsxb6 workload [CONTAINER] org.apache.catalina.core.StandardService           INFO    Starting service [Catalina]
hello-tanzu-54dd5899f4-hsxb6 workload [CONTAINER] org.apache.catalina.core.StandardEngine            INFO    Starting Servlet engine: [Apache Tomcat/9.0.53]
hello-tanzu-54dd5899f4-hsxb6 workload [CONTAINER] org.apache.catalina.startup.HostConfig             INFO    Deploying web application directory [/layers/paketo-buildpacks_apache-tomcat/catalina-base/webapps/ROOT]
hello-tanzu-54dd5899f4-hsxb6 workload [CONTAINER] org.apache.jasper.servlet.TldScanner               INFO    At least one JAR was scanned for TLDs yet contained no TLDs. Enable debug logging for this logger for a complete list of JARs that were scanned but no TLDs were found in them. Skipping unneeded JARs during scanning can improve startup time and JSP compilation time.
hello-tanzu-54dd5899f4-hsxb6 workload [CONTAINER] org.apache.catalina.startup.HostConfig             INFO    Deployment of web application directory [/layers/paketo-buildpacks_apache-tomcat/catalina-base/webapps/ROOT] has finished in [619] ms
hello-tanzu-54dd5899f4-hsxb6 workload [CONTAINER] org.apache.coyote.http11.Http11NioProtocol         INFO    Starting ProtocolHandler ["http-nio-8080"]
hello-tanzu-54dd5899f4-hsxb6 workload [CONTAINER] org.apache.catalina.startup.Catalina               INFO    Server startup in [703] milliseconds
```

このWorkloadからSupply Chainを経由して作成されるリソースを次のコマンドで確認します。

```
$ kubectl get workload,deploy,pod,image,build,gitrepo,service,ingress  

NAME                             AGE
workload.carto.run/hello-tanzu   12m

NAME                          READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/hello-tanzu   1/1     1            1           9m43s

NAME                                      READY   STATUS      RESTARTS   AGE
pod/hello-tanzu-54dd5899f4-hsxb6          1/1     Running     0          9m43s
pod/hello-tanzu-build-1-fvt6g-build-pod   0/1     Completed   0          11m

NAME                         LATESTIMAGE                                                                                          READY
image.kpack.io/hello-tanzu   ghcr.io/making/hello-tanzu@sha256:ab5c70080c2b8a73b67d90b1255a1f92a7a6261d03cf35f5812457214b00c626   True

NAME                                       IMAGE                                                                                                SUCCEEDED
build.kpack.io/hello-tanzu-build-1-fvt6g   ghcr.io/making/hello-tanzu@sha256:ab5c70080c2b8a73b67d90b1255a1f92a7a6261d03cf35f5812457214b00c626   True

NAME                                                 URL                                              READY     STATUS                       AGE
gitrepository.source.toolkit.fluxcd.io/hello-tanzu   https://github.com/tanzu-japan/hello-tanzu.git   Unknown   reconciliation in progress   12m

NAME                  TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/hello-tanzu   ClusterIP   10.96.96.239   <none>        80/TCP    9m43s
service/kubernetes    ClusterIP   10.96.0.1      <none>        443/TCP   8h

NAME                                    CLASS    HOSTS                            ADDRESS   PORTS   AGE
ingress.networking.k8s.io/hello-tanzu   <none>   hello-tanzu-127-0-0-1.sslip.io             80      9m43s
```

IngressのURL( http://hello-tanzu-127-0-0-1.sslip.io )にブラウザでアクセスして動作確認します。

![image](https://user-images.githubusercontent.com/106908/136128060-004f3a9f-1aed-4dd6-b573-7250360f724f.png)

Workloadを削除します。

```
kubectl delete -f hello-tanzu.yaml 
```

##### Node.jsアプリのデプロイ

次にNode.jsのアプリをデプロイします。デプロイするサンプルアプリとして https://github.com/making/hello-nodejs を使用します。

次のWorkloadを作成します。

```yaml
cat <<EOF > hello-nodejs.yaml
apiVersion: carto.run/v1alpha1
kind: Workload
metadata:
  name: hello-nodejs  
  labels:
    app.tanzu.vmware.com/workload-type: web
spec:
  source:
    git:
      url: https://github.com/making/hello-nodejs
      ref:
        branch: master  
EOF
kubectl apply -f hello-nodejs.yaml
```

同様にsternでログを確認すれば、ソースコード取得後npmによるビルドが行われていることがわかります。
なお、npmによるビルドは2回目移行はキャッシュされます。

```
$ stern 'hello-nodejs.*'    

+ hello-nodejs-build-1-qxxwq-build-pod › prepare
hello-nodejs-build-1-qxxwq-build-pod prepare Build reason(s): CONFIG
hello-nodejs-build-1-qxxwq-build-pod prepare CONFIG:
hello-nodejs-build-1-qxxwq-build-pod prepare 	resources: {}
hello-nodejs-build-1-qxxwq-build-pod prepare 	- source: {}
hello-nodejs-build-1-qxxwq-build-pod prepare 	+ source:
hello-nodejs-build-1-qxxwq-build-pod prepare 	+   blob:
hello-nodejs-build-1-qxxwq-build-pod prepare 	+     url: http://source-controller.gitops-toolkit.svc.cluster.local./gitrepository/default/hello-nodejs/9b066f581bd86f6580b73209439bd5cb4b3af523.tar.gz
hello-nodejs-build-1-qxxwq-build-pod prepare Loading secret for "https://ghcr.io" from secret "regsecret" at location "/var/build-secrets/regsecret"
hello-nodejs-build-1-qxxwq-build-pod prepare Downloading source-controller.gitops-toolkit.svc.cluster.local./gitrepository/default/hello-nodejs/9b066f581bd86f6580b73209439bd5cb4b3af523.tar.gz...
hello-nodejs-build-1-qxxwq-build-pod prepare Successfully downloaded source-controller.gitops-toolkit.svc.cluster.local./gitrepository/default/hello-nodejs/9b066f581bd86f6580b73209439bd5cb4b3af523.tar.gz in path "/workspace"
- hello-nodejs-build-1-qxxwq-build-pod › prepare
+ hello-nodejs-build-1-qxxwq-build-pod › analyze
hello-nodejs-build-1-qxxwq-build-pod analyze Previous image with name "ghcr.io/making/hello-nodejs" not found
- hello-nodejs-build-1-qxxwq-build-pod › analyze
+ hello-nodejs-build-1-qxxwq-build-pod › build
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build Paketo CA Certificates Buildpack 2.4.1
hello-nodejs-build-1-qxxwq-build-pod build   https://github.com/paketo-buildpacks/ca-certificates
hello-nodejs-build-1-qxxwq-build-pod build   Launch Helper: Contributing to layer
hello-nodejs-build-1-qxxwq-build-pod build     Creating /layers/paketo-buildpacks_ca-certificates/helper/exec.d/ca-certificates-helper
hello-nodejs-build-1-qxxwq-build-pod build Paketo Node Engine Buildpack 0.8.0
hello-nodejs-build-1-qxxwq-build-pod build   Resolving Node Engine version
hello-nodejs-build-1-qxxwq-build-pod build     Candidate version sources (in priority order):
hello-nodejs-build-1-qxxwq-build-pod build                 -> ""
hello-nodejs-build-1-qxxwq-build-pod build       <unknown> -> ""
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build     Selected Node Engine version (using ): 14.17.6
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build   Executing build process
hello-nodejs-build-1-qxxwq-build-pod build     Installing Node Engine 14.17.6
hello-nodejs-build-1-qxxwq-build-pod build       Completed in 17.846s
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build   Configuring build environment
hello-nodejs-build-1-qxxwq-build-pod build     NODE_ENV     -> "production"
hello-nodejs-build-1-qxxwq-build-pod build     NODE_HOME    -> "/layers/paketo-buildpacks_node-engine/node"
hello-nodejs-build-1-qxxwq-build-pod build     NODE_VERBOSE -> "false"
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build   Configuring launch environment
hello-nodejs-build-1-qxxwq-build-pod build     NODE_ENV     -> "production"
hello-nodejs-build-1-qxxwq-build-pod build     NODE_HOME    -> "/layers/paketo-buildpacks_node-engine/node"
hello-nodejs-build-1-qxxwq-build-pod build     NODE_VERBOSE -> "false"
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build     Writing profile.d/0_memory_available.sh
hello-nodejs-build-1-qxxwq-build-pod build       Calculates available memory based on container limits at launch time.
hello-nodejs-build-1-qxxwq-build-pod build       Made available in the MEMORY_AVAILABLE environment variable.
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build Paketo NPM Install Buildpack 0.4.0
hello-nodejs-build-1-qxxwq-build-pod build   Resolving installation process
hello-nodejs-build-1-qxxwq-build-pod build     Process inputs:
hello-nodejs-build-1-qxxwq-build-pod build       node_modules      -> "Not found"
hello-nodejs-build-1-qxxwq-build-pod build       npm-cache         -> "Not found"
hello-nodejs-build-1-qxxwq-build-pod build       package-lock.json -> "Found"
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build     Selected NPM build process: 'npm ci'
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build   Executing build process
hello-nodejs-build-1-qxxwq-build-pod build     Running 'npm ci --unsafe-perm --cache /layers/paketo-buildpacks_npm-install/npm-cache'
hello-nodejs-build-1-qxxwq-build-pod build       Completed in 1.867s
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build   Configuring launch environment
hello-nodejs-build-1-qxxwq-build-pod build     NPM_CONFIG_LOGLEVEL -> "error"
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build   Configuring environment shared by build and launch
hello-nodejs-build-1-qxxwq-build-pod build     PATH -> "$PATH:/layers/paketo-buildpacks_npm-install/modules/node_modules/.bin"
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build Paketo Node Module Bill of Materials Generator Buildpack 0.1.2
hello-nodejs-build-1-qxxwq-build-pod build   Resolving CycloneDX Node.js Module version
hello-nodejs-build-1-qxxwq-build-pod build     Selected CycloneDX Node.js Module version: 3.0.7
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build   Executing build process
hello-nodejs-build-1-qxxwq-build-pod build     Installing CycloneDX Node.js Module 3.0.7
hello-nodejs-build-1-qxxwq-build-pod build       Completed in 110ms
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build   Configuring environment
hello-nodejs-build-1-qxxwq-build-pod build     Appending CycloneDX Node.js Module onto PATH
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build   Running CycloneDX Node.js Module
hello-nodejs-build-1-qxxwq-build-pod build     Running 'cyclonedx-bom -o bom.json'
hello-nodejs-build-1-qxxwq-build-pod build       Completed in 422ms
hello-nodejs-build-1-qxxwq-build-pod build 
hello-nodejs-build-1-qxxwq-build-pod build Paketo NPM Start Buildpack 0.4.0
hello-nodejs-build-1-qxxwq-build-pod build   Assigning launch processes
hello-nodejs-build-1-qxxwq-build-pod build     web: node server.js
hello-nodejs-build-1-qxxwq-build-pod build 
- hello-nodejs-build-1-qxxwq-build-pod › build
+ hello-nodejs-build-1-qxxwq-build-pod › export
hello-nodejs-build-1-qxxwq-build-pod export Adding layer 'paketo-buildpacks/ca-certificates:helper'
hello-nodejs-build-1-qxxwq-build-pod export Adding layer 'paketo-buildpacks/node-engine:node'
hello-nodejs-build-1-qxxwq-build-pod export Adding layer 'paketo-buildpacks/npm-install:modules'
hello-nodejs-build-1-qxxwq-build-pod export Adding layer 'paketo-buildpacks/npm-install:npm-cache'
hello-nodejs-build-1-qxxwq-build-pod export Adding 1/1 app layer(s)
hello-nodejs-build-1-qxxwq-build-pod export Adding layer 'launcher'
hello-nodejs-build-1-qxxwq-build-pod export Adding layer 'config'
hello-nodejs-build-1-qxxwq-build-pod export Adding layer 'process-types'
hello-nodejs-build-1-qxxwq-build-pod export Adding label 'io.buildpacks.lifecycle.metadata'
hello-nodejs-build-1-qxxwq-build-pod export Adding label 'io.buildpacks.build.metadata'
hello-nodejs-build-1-qxxwq-build-pod export Adding label 'io.buildpacks.project.metadata'
hello-nodejs-build-1-qxxwq-build-pod export Setting default process type 'web'
hello-nodejs-build-1-qxxwq-build-pod export Saving ghcr.io/making/hello-nodejs...
hello-nodejs-build-1-qxxwq-build-pod export *** Images (sha256:b11ec565f737dda90a76cbfa87aae92cdc348fccdf36de1d0b387c229cb5e4df):
hello-nodejs-build-1-qxxwq-build-pod export       ghcr.io/making/hello-nodejs
hello-nodejs-build-1-qxxwq-build-pod export       ghcr.io/making/hello-nodejs:b1.20211006.015441
hello-nodejs-build-1-qxxwq-build-pod export Adding cache layer 'paketo-buildpacks/node-engine:node'
hello-nodejs-build-1-qxxwq-build-pod export Adding cache layer 'paketo-buildpacks/npm-install:modules'
hello-nodejs-build-1-qxxwq-build-pod export Adding cache layer 'paketo-buildpacks/npm-install:npm-cache'
hello-nodejs-build-1-qxxwq-build-pod export Adding cache layer 'paketo-buildpacks/node-module-bom:cyclonedx-node-module'
- hello-nodejs-build-1-qxxwq-build-pod › export
+ hello-nodejs-7f87556847-kk4bk › workload
hello-nodejs-7f87556847-kk4bk workload Running on http://0.0.0.0:8080
```

```
$ kubectl get workload,deploy,pod,image,build,gitrepo,service,ingress  

NAME                              AGE
workload.carto.run/hello-nodejs   7m18s

NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/hello-nodejs   1/1     1            1           6m23s

NAME                                       READY   STATUS      RESTARTS   AGE
pod/hello-nodejs-7f87556847-kk4bk          1/1     Running     0          6m23s
pod/hello-nodejs-build-1-qxxwq-build-pod   0/1     Completed   0          7m12s

NAME                          LATESTIMAGE                                                                                           READY
image.kpack.io/hello-nodejs   ghcr.io/making/hello-nodejs@sha256:b11ec565f737dda90a76cbfa87aae92cdc348fccdf36de1d0b387c229cb5e4df   True

NAME                                        IMAGE                                                                                                 SUCCEEDED
build.kpack.io/hello-nodejs-build-1-qxxwq   ghcr.io/making/hello-nodejs@sha256:b11ec565f737dda90a76cbfa87aae92cdc348fccdf36de1d0b387c229cb5e4df   True

NAME                                                  URL                                      READY   STATUS                                                              AGE
gitrepository.source.toolkit.fluxcd.io/hello-nodejs   https://github.com/making/hello-nodejs   True    Fetched revision: master/9b066f581bd86f6580b73209439bd5cb4b3af523   7m18s

NAME                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/hello-nodejs   ClusterIP   10.96.88.240   <none>        80/TCP    6m23s
service/kubernetes     ClusterIP   10.96.0.1      <none>        443/TCP   8h

NAME                                     CLASS    HOSTS                             ADDRESS   PORTS   AGE
ingress.networking.k8s.io/hello-nodejs   <none>   hello-nodejs-127-0-0-1.sslip.io             80      6m23s
```


IngressのURL( http://hello-nodejs-127-0-0-1.sslip.io )にcurlでアクセスして動作確認します。

```
$ curl http://hello-nodejs-127-0-0-1.sslip.io
Hello World!
```

Workloadを削除します。

```
kubectl delete -f hello-nodejs.yaml 
```

##### Rubyアプリのデプロイ

次にRubyのアプリをデプロイします。デプロイするサンプルアプリとして https://github.com/making/hello-ruby を使用します。

次のWorkloadを作成します。

```yaml
cat <<EOF > hello-ruby.yaml
apiVersion: carto.run/v1alpha1
kind: Workload
metadata:
  name: hello-ruby  
  labels:
    app.tanzu.vmware.com/workload-type: web
spec:
  source:
    git:
      url: https://github.com/making/hello-ruby
      ref:
        branch: main
  env:
  - name: PORT
    value: "8080"        
EOF
kubectl apply -f hello-ruby.yaml
```

同様にsternでログを確認します。

```
$ stern 'hello-ruby.*'      

+ hello-ruby-build-1-9nmz8-build-pod › prepare
hello-ruby-build-1-9nmz8-build-pod prepare Build reason(s): CONFIG
hello-ruby-build-1-9nmz8-build-pod prepare CONFIG:
hello-ruby-build-1-9nmz8-build-pod prepare 	resources: {}
hello-ruby-build-1-9nmz8-build-pod prepare 	- source: {}
hello-ruby-build-1-9nmz8-build-pod prepare 	+ source:
hello-ruby-build-1-9nmz8-build-pod prepare 	+   blob:
hello-ruby-build-1-9nmz8-build-pod prepare 	+     url: http://source-controller.gitops-toolkit.svc.cluster.local./gitrepository/default/hello-ruby/b259d9f2bd6f7da6b0fc266f1d8bb6db56a199fd.tar.gz
hello-ruby-build-1-9nmz8-build-pod prepare Loading secret for "https://ghcr.io" from secret "regsecret" at location "/var/build-secrets/regsecret"
hello-ruby-build-1-9nmz8-build-pod prepare Downloading source-controller.gitops-toolkit.svc.cluster.local./gitrepository/default/hello-ruby/b259d9f2bd6f7da6b0fc266f1d8bb6db56a199fd.tar.gz...
hello-ruby-build-1-9nmz8-build-pod prepare Successfully downloaded source-controller.gitops-toolkit.svc.cluster.local./gitrepository/default/hello-ruby/b259d9f2bd6f7da6b0fc266f1d8bb6db56a199fd.tar.gz in path "/workspace"
- hello-ruby-build-1-9nmz8-build-pod › prepare
+ hello-ruby-build-1-9nmz8-build-pod › analyze
hello-ruby-build-1-9nmz8-build-pod analyze Previous image with name "ghcr.io/making/hello-ruby" not found
- hello-ruby-build-1-9nmz8-build-pod › analyze
+ hello-ruby-build-1-9nmz8-build-pod › build
hello-ruby-build-1-9nmz8-build-pod build 
hello-ruby-build-1-9nmz8-build-pod build Paketo CA Certificates Buildpack 2.4.0
hello-ruby-build-1-9nmz8-build-pod build   https://github.com/paketo-buildpacks/ca-certificates
hello-ruby-build-1-9nmz8-build-pod build   Launch Helper: Contributing to layer
hello-ruby-build-1-9nmz8-build-pod build     Creating /layers/paketo-buildpacks_ca-certificates/helper/exec.d/ca-certificates-helper
hello-ruby-build-1-9nmz8-build-pod build Paketo MRI Buildpack 0.2.5
hello-ruby-build-1-9nmz8-build-pod build   Resolving MRI version
hello-ruby-build-1-9nmz8-build-pod build     Candidate version sources (in priority order):
hello-ruby-build-1-9nmz8-build-pod build       <unknown> -> ""
hello-ruby-build-1-9nmz8-build-pod build 
hello-ruby-build-1-9nmz8-build-pod build     Selected MRI version (using <unknown>): 2.7.4
hello-ruby-build-1-9nmz8-build-pod build 
hello-ruby-build-1-9nmz8-build-pod build   Executing build process
hello-ruby-build-1-9nmz8-build-pod build     Installing MRI 2.7.4
hello-ruby-build-1-9nmz8-build-pod build       Completed in 2.836s
hello-ruby-build-1-9nmz8-build-pod build 
hello-ruby-build-1-9nmz8-build-pod build   Configuring environment
hello-ruby-build-1-9nmz8-build-pod build     GEM_PATH -> "/home/cnb/.gem/ruby/2.7.0:/layers/paketo-buildpacks_mri/mri/lib/ruby/gems/2.7.0"
hello-ruby-build-1-9nmz8-build-pod build 
hello-ruby-build-1-9nmz8-build-pod build Paketo Bundler Buildpack 0.1.9
hello-ruby-build-1-9nmz8-build-pod build   Resolving Bundler version
hello-ruby-build-1-9nmz8-build-pod build     Candidate version sources (in priority order):
hello-ruby-build-1-9nmz8-build-pod build       Gemfile.lock -> "1.*.*"
hello-ruby-build-1-9nmz8-build-pod build       <unknown>    -> ""
hello-ruby-build-1-9nmz8-build-pod build 
hello-ruby-build-1-9nmz8-build-pod build     Selected Bundler version (using Gemfile.lock): 1.17.3
hello-ruby-build-1-9nmz8-build-pod build 
hello-ruby-build-1-9nmz8-build-pod build   Executing build process
hello-ruby-build-1-9nmz8-build-pod build     Installing Bundler 1.17.3
hello-ruby-build-1-9nmz8-build-pod build       Completed in 1.343s
hello-ruby-build-1-9nmz8-build-pod build 
hello-ruby-build-1-9nmz8-build-pod build   Configuring environment
hello-ruby-build-1-9nmz8-build-pod build     GEM_PATH -> "$GEM_PATH:/layers/paketo-buildpacks_bundler/bundler"
hello-ruby-build-1-9nmz8-build-pod build 
hello-ruby-build-1-9nmz8-build-pod build Paketo Bundle Install Buildpack 0.2.4
hello-ruby-build-1-9nmz8-build-pod build   Executing launch environment install process
hello-ruby-build-1-9nmz8-build-pod build     Running 'bundle config --global clean true'
hello-ruby-build-1-9nmz8-build-pod build     Running 'bundle config --global path /layers/paketo-buildpacks_bundle-install/launch-gems'
hello-ruby-build-1-9nmz8-build-pod build     Running 'bundle config --global without development:test'
hello-ruby-build-1-9nmz8-build-pod build     Running 'bundle config --global cache_path --parseable'
hello-ruby-build-1-9nmz8-build-pod build     Running 'bundle install'
hello-ruby-build-1-9nmz8-build-pod build       Completed in 2.186s
hello-ruby-build-1-9nmz8-build-pod build 
hello-ruby-build-1-9nmz8-build-pod build   Configuring launch environment
hello-ruby-build-1-9nmz8-build-pod build     BUNDLE_USER_CONFIG -> "/layers/paketo-buildpacks_bundle-install/launch-gems/config"
hello-ruby-build-1-9nmz8-build-pod build 
hello-ruby-build-1-9nmz8-build-pod build Paketo Rackup Buildpack 0.0.59
hello-ruby-build-1-9nmz8-build-pod build   Writing start command
hello-ruby-build-1-9nmz8-build-pod build     bundle exec rackup --env RACK_ENV=production -p "${PORT:-9292}"
- hello-ruby-build-1-9nmz8-build-pod › build
+ hello-ruby-build-1-9nmz8-build-pod › export
hello-ruby-build-1-9nmz8-build-pod export Adding layer 'paketo-buildpacks/ca-certificates:helper'
hello-ruby-build-1-9nmz8-build-pod export Adding layer 'paketo-buildpacks/mri:mri'
hello-ruby-build-1-9nmz8-build-pod export Adding layer 'paketo-buildpacks/bundler:bundler'
hello-ruby-build-1-9nmz8-build-pod export Adding layer 'paketo-buildpacks/bundle-install:launch-gems'
hello-ruby-build-1-9nmz8-build-pod export Adding 1/1 app layer(s)
hello-ruby-build-1-9nmz8-build-pod export Adding layer 'launcher'
hello-ruby-build-1-9nmz8-build-pod export Adding layer 'config'
hello-ruby-build-1-9nmz8-build-pod export Adding layer 'process-types'
hello-ruby-build-1-9nmz8-build-pod export Adding label 'io.buildpacks.lifecycle.metadata'
hello-ruby-build-1-9nmz8-build-pod export Adding label 'io.buildpacks.build.metadata'
hello-ruby-build-1-9nmz8-build-pod export Adding label 'io.buildpacks.project.metadata'
hello-ruby-build-1-9nmz8-build-pod export Setting default process type 'web'
hello-ruby-build-1-9nmz8-build-pod export Saving ghcr.io/making/hello-ruby...
hello-ruby-build-1-9nmz8-build-pod export *** Images (sha256:5c2bcd9182a62c9fcb191f2f1d9639f0eb86836943093a553d9b00d363223cfe):
hello-ruby-build-1-9nmz8-build-pod export       ghcr.io/making/hello-ruby
hello-ruby-build-1-9nmz8-build-pod export       ghcr.io/making/hello-ruby:b1.20211006.020335
hello-ruby-build-1-9nmz8-build-pod export Adding cache layer 'paketo-buildpacks/mri:mri'
hello-ruby-build-1-9nmz8-build-pod export Adding cache layer 'paketo-buildpacks/bundler:bundler'
- hello-ruby-build-1-9nmz8-build-pod › export
+ hello-ruby-5cbcd9546f-xcf7g › workload
hello-ruby-5cbcd9546f-xcf7g workload [2021-10-06 02:04:16] INFO  WEBrick 1.6.1
hello-ruby-5cbcd9546f-xcf7g workload [2021-10-06 02:04:16] INFO  ruby 2.7.4 (2021-07-07) [x86_64-linux]
hello-ruby-5cbcd9546f-xcf7g workload [2021-10-06 02:04:16] INFO  WEBrick::HTTPServer#start: pid=1 port=8080
hello-ruby-5cbcd9546f-xcf7g workload 172.18.0.1 - - [06/Oct/2021:02:04:31 +0000] "GET / HTTP/1.1" 200 12 0.0016
```

```
$ kubectl get workload,deploy,pod,image,build,gitrepo,service,ingress  

NAME                            AGE
workload.carto.run/hello-ruby   8m7s

NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/hello-ruby   1/1     1            1           7m27s

NAME                                     READY   STATUS      RESTARTS   AGE
pod/hello-ruby-5cbcd9546f-xcf7g          1/1     Running     0          7m27s
pod/hello-ruby-build-1-9nmz8-build-pod   0/1     Completed   0          8m1s

NAME                        LATESTIMAGE                                                                                         READY
image.kpack.io/hello-ruby   ghcr.io/making/hello-ruby@sha256:5c2bcd9182a62c9fcb191f2f1d9639f0eb86836943093a553d9b00d363223cfe   True

NAME                                      IMAGE                                                                                               SUCCEEDED
build.kpack.io/hello-ruby-build-1-9nmz8   ghcr.io/making/hello-ruby@sha256:5c2bcd9182a62c9fcb191f2f1d9639f0eb86836943093a553d9b00d363223cfe   True

NAME                                                URL                                    READY   STATUS                                                            AGE
gitrepository.source.toolkit.fluxcd.io/hello-ruby   https://github.com/making/hello-ruby   True    Fetched revision: main/b259d9f2bd6f7da6b0fc266f1d8bb6db56a199fd   8m7s

NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/hello-ruby   ClusterIP   10.96.117.16   <none>        80/TCP    7m27s
service/kubernetes   ClusterIP   10.96.0.1      <none>        443/TCP   9h

NAME                                   CLASS    HOSTS                           ADDRESS   PORTS   AGE
ingress.networking.k8s.io/hello-ruby   <none>   hello-ruby-127-0-0-1.sslip.io             80      7m27s
```

IngressのURL( http://hello-ruby-127-0-0-1.sslip.io )にcurlでアクセスして動作確認します。

```
$ curl http://hello-ruby-127-0-0-1.sslip.io 
Hello World!
```

Workloadを削除します。

```
kubectl delete -f hello-ruby.yaml 
```

---

Cartographer 0.0.6をkindにインストールして様々なアプリケーションをデプロイしました。
Cartographerの面白さを少しは感じてもらえたのではないでしょうか。

次はKnativeやTektonとの連携を試そうと思います。