---
title: Tanzu Application Platform 1.7 (Full Profile) をEKSにインストールするメモ
tags: ["Kubernetes", "Cartographer", "EKS", "Tanzu", "TAP"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP"]
---


```yaml
cat <<EOF > eks-cluster-config.yaml
---
kind: ClusterConfig
apiVersion: eksctl.io/v1alpha5
metadata:
  name: tap-demo
  region: ap-northeast-1
  version: "1.27"
managedNodeGroups:
- name: tap-demo-ng-1
  minSize: 3
  maxSize: 3
  desiredCapacity: 3
  volumeSize: 200
  maxPodsPerNode: 110
  instanceType: m5.xlarge
  spot: true
  ssh:
    allow: true
    publicKeyPath: ~/.ssh/id_rsa.pub
addons:
- name: aws-ebs-csi-driver
  wellKnownPolicies:
    ebsCSIController: true
iam:
  withOIDC: true
---
EOF
```

```
eksctl create cluster -f eks-cluster-config.yaml
```

```
export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
export AWS_REGION=ap-northeast-1
export EKS_CLUSTER_NAME=tap-demo
```


```
aws ecr create-repository --repository-name tap-images --region $AWS_REGION
aws ecr create-repository --repository-name tap-build-service --region $AWS_REGION

aws ecr create-repository --repository-name full-deps-package-repo --region $AWS_REGION
aws ecr create-repository --repository-name tap-lsp --region $AWS_REGION
aws ecr create-repository --repository-name tanzu-cluster-essentials --region $AWS_REGION
```


```
# Retrieve the OIDC endpoint from the Kubernetes cluster and store it for use in the policy.
export OIDCPROVIDER=$(aws eks describe-cluster --name $EKS_CLUSTER_NAME --region $AWS_REGION --output json | jq '.cluster.identity.oidc.issuer' | tr -d '"' | sed 's/https:\/\///')
cat << EOF > build-service-trust-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/${OIDCPROVIDER}"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "${OIDCPROVIDER}:aud": "sts.amazonaws.com"
                },
                "StringLike": {
                    "${OIDCPROVIDER}:sub": [
                        "system:serviceaccount:kpack:controller",
                        "system:serviceaccount:build-service:dependency-updater-controller-serviceaccount"
                    ]
                }
            }
        }
    ]
}
EOF

cat << EOF > build-service-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": [
                "ecr:DescribeRegistry",
                "ecr:GetAuthorizationToken",
                "ecr:GetRegistryPolicy",
                "ecr:PutRegistryPolicy",
                "ecr:PutReplicationConfiguration",
                "ecr:DeleteRegistryPolicy"
            ],
            "Resource": "*",
            "Effect": "Allow",
            "Sid": "TAPEcrBuildServiceGlobal"
        },
        {
            "Action": [
                "ecr:DescribeImages",
                "ecr:ListImages",
                "ecr:BatchCheckLayerAvailability",
                "ecr:BatchGetImage",
                "ecr:BatchGetRepositoryScanningConfiguration",
                "ecr:DescribeImageReplicationStatus",
                "ecr:DescribeImageScanFindings",
                "ecr:DescribeRepositories",
                "ecr:GetDownloadUrlForLayer",
                "ecr:GetLifecyclePolicy",
                "ecr:GetLifecyclePolicyPreview",
                "ecr:GetRegistryScanningConfiguration",
                "ecr:GetRepositoryPolicy",
                "ecr:ListTagsForResource",
                "ecr:TagResource",
                "ecr:UntagResource",
                "ecr:BatchDeleteImage",
                "ecr:BatchImportUpstreamImage",
                "ecr:CompleteLayerUpload",
                "ecr:CreatePullThroughCacheRule",
                "ecr:CreateRepository",
                "ecr:DeleteLifecyclePolicy",
                "ecr:DeletePullThroughCacheRule",
                "ecr:DeleteRepository",
                "ecr:InitiateLayerUpload",
                "ecr:PutImage",
                "ecr:PutImageScanningConfiguration",
                "ecr:PutImageTagMutability",
                "ecr:PutLifecyclePolicy",
                "ecr:PutRegistryScanningConfiguration",
                "ecr:ReplicateImage",
                "ecr:StartImageScan",
                "ecr:StartLifecyclePolicyPreview",
                "ecr:UploadLayerPart",
                "ecr:DeleteRepositoryPolicy",
                "ecr:SetRepositoryPolicy"
            ],
            "Resource": [
                "arn:aws:ecr:${AWS_REGION}:${AWS_ACCOUNT_ID}:repository/full-deps-package-repo",
                "arn:aws:ecr:${AWS_REGION}:${AWS_ACCOUNT_ID}:repository/tap-build-service",
                "arn:aws:ecr:${AWS_REGION}:${AWS_ACCOUNT_ID}:repository/tap-images"
            ],
            "Effect": "Allow",
            "Sid": "TAPEcrBuildServiceScoped"
        }
    ]
}
EOF

cat << EOF > workload-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": [
                "ecr:DescribeRegistry",
                "ecr:GetAuthorizationToken",
                "ecr:GetRegistryPolicy",
                "ecr:PutRegistryPolicy",
                "ecr:PutReplicationConfiguration",
                "ecr:DeleteRegistryPolicy"
            ],
            "Resource": "*",
            "Effect": "Allow",
            "Sid": "TAPEcrWorkloadGlobal"
        },
        {
            "Action": [
                "ecr:DescribeImages",
                "ecr:ListImages",
                "ecr:BatchCheckLayerAvailability",
                "ecr:BatchGetImage",
                "ecr:BatchGetRepositoryScanningConfiguration",
                "ecr:DescribeImageReplicationStatus",
                "ecr:DescribeImageScanFindings",
                "ecr:DescribeRepositories",
                "ecr:GetDownloadUrlForLayer",
                "ecr:GetLifecyclePolicy",
                "ecr:GetLifecyclePolicyPreview",
                "ecr:GetRegistryScanningConfiguration",
                "ecr:GetRepositoryPolicy",
                "ecr:ListTagsForResource",
                "ecr:TagResource",
                "ecr:UntagResource",
                "ecr:BatchDeleteImage",
                "ecr:BatchImportUpstreamImage",
                "ecr:CompleteLayerUpload",
                "ecr:CreatePullThroughCacheRule",
                "ecr:CreateRepository",
                "ecr:DeleteLifecyclePolicy",
                "ecr:DeletePullThroughCacheRule",
                "ecr:DeleteRepository",
                "ecr:InitiateLayerUpload",
                "ecr:PutImage",
                "ecr:PutImageScanningConfiguration",
                "ecr:PutImageTagMutability",
                "ecr:PutLifecyclePolicy",
                "ecr:PutRegistryScanningConfiguration",
                "ecr:ReplicateImage",
                "ecr:StartImageScan",
                "ecr:StartLifecyclePolicyPreview",
                "ecr:UploadLayerPart",
                "ecr:DeleteRepositoryPolicy",
                "ecr:SetRepositoryPolicy"
            ],
            "Resource": [
                "arn:aws:ecr:${AWS_REGION}:${AWS_ACCOUNT_ID}:repository/full-deps-package-repo",
                "arn:aws:ecr:${AWS_REGION}:${AWS_ACCOUNT_ID}:repository/tanzu-application-platform/*"
            ],
            "Effect": "Allow",
            "Sid": "TAPEcrWorkloadScoped"
        }
    ]
}
EOF

cat << EOF > workload-trust-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/${OIDCPROVIDER}"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringLike": {
                    "${OIDCPROVIDER}:sub": "system:serviceaccount:*:default",
                    "${OIDCPROVIDER}:aud": "sts.amazonaws.com"
                }
            }
        }
    ]
}
EOF

cat << EOF > local-source-proxy-trust-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/${OIDCPROVIDER}"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "${OIDCPROVIDER}:aud": "sts.amazonaws.com"
                },
                "StringLike": {
                    "${OIDCPROVIDER}:sub": [
                        "system:serviceaccount:tap-local-source-system:proxy-manager"
                    ]
                }
            }
        }
    ]
}
EOF

cat << EOF > local-source-proxy-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": [
                "ecr:GetAuthorizationToken"
            ],
            "Resource": "*",
            "Effect": "Allow",
            "Sid": "TAPLSPGlobal"
        },
        {
            "Effect": "Allow",
            "Action": [
                "ecr:BatchCheckLayerAvailability",
                "ecr:GetDownloadUrlForLayer",
                "ecr:GetRepositoryPolicy",
                "ecr:DescribeRepositories",
                "ecr:ListImages",
                "ecr:DescribeImages",
                "ecr:BatchGetImage",
                "ecr:GetLifecyclePolicy",
                "ecr:GetLifecyclePolicyPreview",
                "ecr:ListTagsForResource",
                "ecr:DescribeImageScanFindings",
                "ecr:InitiateLayerUpload",
                "ecr:UploadLayerPart",
                "ecr:CompleteLayerUpload",
                "ecr:PutImage"
            ],
            "Resource": [
                "arn:aws:ecr:${AWS_REGION}:${AWS_ACCOUNT_ID}:repository/tap-lsp"
            ],
            "Sid": "TAPLSPScoped"
        }
    ]
}
EOF

aws iam create-role --role-name tap-build-service --assume-role-policy-document file://build-service-trust-policy.json
aws iam put-role-policy --role-name tap-build-service --policy-name tapBuildServicePolicy --policy-document file://build-service-policy.json

aws iam create-role --role-name tap-workload --assume-role-policy-document file://workload-trust-policy.json
aws iam put-role-policy --role-name tap-workload --policy-name tapWorkload --policy-document file://workload-policy.json

aws iam create-role --role-name tap-local-source-proxy --assume-role-policy-document file://local-source-proxy-trust-policy.json
aws iam put-role-policy --role-name tap-local-source-proxy --policy-name tapLocalSourcePolicy --policy-document file://local-source-proxy-policy.json
```


> ```
> aws iam delete-role-policy --role-name tap-build-service --policy-name tapBuildServicePolicy
> aws iam delete-role-policy --role-name tap-workload --policy-name tapWorkload
> aws iam delete-role-policy --role-name tap-local-source-proxy --policy-name tapLocalSourcePolicy
> 
> 
> aws iam delete-role --role-name tap-build-service
> aws iam delete-role --role-name tap-workload
> aws iam delete-role --role-name tap-local-source-proxy
> ```



```
IMGPKG_REGISTRY_HOSTNAME=registry.tanzu.vmware.com \
IMGPKG_REGISTRY_USERNAME=$TANZUNET_USERNAME \
IMGPKG_REGISTRY_PASSWORD=$TANZUNET_PASSWORD \
imgpkg copy \
  -b registry.tanzu.vmware.com/tanzu-cluster-essentials/cluster-essentials-bundle:1.7.1 \
  --to-tar cluster-essentials-bundle-1.7.1.tar \
  --include-non-distributable-layers
```

```
ECR_REPO=$(aws ecr describe-repositories --region ap-northeast-1 --query 'repositories[?repositoryName==`tanzu-cluster-essentials`].repositoryUri' --output text)
aws ecr get-login-password --region ${AWS_REGION} | docker login ${ECR_REPO} -u AWS --password-stdin

imgpkg copy \
  --tar cluster-essentials-bundle-1.7.1.tar \
  --to-repo ${ECR_REPO} \
  --include-non-distributable-layers
```


```
pivnet download-product-files --product-slug='tanzu-cluster-essentials' --release-version='1.7.1' --glob='tanzu-cluster-essentials-darwin-amd64-*'

mkdir -p tanzu-cluster-essentials
tar -xvf tanzu-cluster-essentials-*.tgz -C tanzu-cluster-essentials
cd tanzu-cluster-essentials

INSTALL_BUNDLE=${ECR_REPO}:1.7.1 \
INSTALL_REGISTRY_HOSTNAME=${ECR_REPO} \
INSTALL_REGISTRY_USERNAME=AWS \
INSTALL_REGISTRY_PASSWORD=$(aws ecr get-login-password --region ${AWS_REGION}) \
./install.sh --yes
cd ..
```


```
IMGPKG_REGISTRY_HOSTNAME=registry.tanzu.vmware.com \
IMGPKG_REGISTRY_USERNAME=$TANZUNET_USERNAME \
IMGPKG_REGISTRY_PASSWORD=$TANZUNET_PASSWORD \
imgpkg copy \
  -b registry.tanzu.vmware.com/tanzu-application-platform/tap-packages:1.7.1 \
  --to-tar tap-bundle-1.7.1.tar \
  --include-non-distributable-layers
```

```
ECR_REPO=$(aws ecr describe-repositories --region ap-northeast-1 --query 'repositories[?repositoryName==`tap-images`].repositoryUri' --output text)
aws ecr get-login-password --region ${AWS_REGION} | docker login ${ECR_REPO} -u AWS --password-stdin

imgpkg copy \
  --concurrency 1 \
  --tar tap-bundle-1.7.1.tar \
  --to-repo ${ECR_REPO} \
  --include-non-distributable-layers
```

```
brew install vmware-tanzu/tanzu/tanzu-cli
```

```
tanzu plugin install --group vmware-tap/default:v1.7.1
```


```
kubectl create ns tap-install

tanzu secret registry add tap-registry \
  --username AWS \
  --password $(aws ecr get-login-password --region ${AWS_REGION}) \
  --server ${ECR_REPO} \
  --export-to-all-namespaces \
  --yes \
  --namespace tap-install
```

```
tanzu package repository add tanzu-tap-repository \
  --url ${ECR_REPO}:1.7.1 \
  --namespace tap-install
```

```
aws ec2 allocate-address --region ${AWS_REGION} > envoy-eip-1.json
aws ec2 create-tags --resources $(cat envoy-eip-1.json | jq -r .AllocationId) --region ${AWS_REGION} --tags Key=Name,Value=envoy-ip-1

aws ec2 allocate-address --region ${AWS_REGION} > envoy-eip-2.json
aws ec2 create-tags --resources $(cat envoy-eip-2.json | jq -r .AllocationId) --region ${AWS_REGION} --tags Key=Name,Value=envoy-ip-2

aws ec2 allocate-address --region ${AWS_REGION} > envoy-eip-3.json
aws ec2 create-tags --resources $(cat envoy-eip-3.json | jq -r .AllocationId) --region ${AWS_REGION} --tags Key=Name,Value=envoy-ip-3

```



```yaml
cat << EOF > tap-values.yaml
---
shared:
  ingress_domain: tap.$(cat envoy-eip-1.json | jq -r .PublicIp).nip.io

ceip_policy_disclosed: true

profile: full

supply_chain: testing_scanning

ootb_supply_chain_testing_scanning:
  registry:
    server: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
    # The prefix of the ECR repository.  Workloads will need
    # two repositories created:
    #
    # tanzu-application-platform/<workloadname>-<namespace>
    # tanzu-application-platform/<workloadname>-<namespace>-bundle
    repository: tanzu-application-platform

contour:
  infrastructure_provider: aws
  envoy:
    workload:
      type: Deployment
      replicas: 3
    service:
      type: LoadBalancer
      annotations: 
        service.beta.kubernetes.io/aws-load-balancer-eip-allocations: $(cat envoy-eip-1.json | jq -r .AllocationId),$(cat envoy-eip-2.json | jq -r .AllocationId),$(cat envoy-eip-3.json | jq -r .AllocationId)
      aws:
        LBType: nlb
  contour:
    replicas: 1
    configFileContents:
      accesslog-format: json

buildservice:
  kp_default_repository: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/tap-build-service
  kp_default_repository_aws_iam_role_arn: arn:aws:iam::${AWS_ACCOUNT_ID}:role/tap-build-service
  exclude_dependencies: true

local_source_proxy:
  repository: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/tap-lsp
  push_secret:
    aws_iam_role_arn: arn:aws:iam::${AWS_ACCOUNT_ID}:role/tap-local-source-proxy

ootb_templates:
  iaas_auth: true

tap_gui:
  app_config:
    auth:
      allowGuestAccess: true

metadata_store:
  ns_for_export_app_cert: "*"
  app_service_type: ClusterIP
  pg_req_cpu: "200m"
  pg_req_memory: "200Mi"

namespace_provisioner:
  aws_iam_role_arn: arn:aws:iam::${AWS_ACCOUNT_ID}:role/tap-workload

# 以下リソース節約用
cnrs:
  lite:
    enable: true
  pdb:
    enable: false
cartographer:
  cartographer:
    resources:
      requests:
        cpu: 100m
        memory: 200Mi
crossplane:
  resourcesCrossplane:
    requests:
      cpu: 100m
      memory: 200Mi
  resourcesRBACManager:
    requests:
      cpu: 100m
      memory: 200Mi

excluded_packages:
- policy.apps.tanzu.vmware.com
- image-policy-webhook.signing.apps.tanzu.vmware.com
- sso.apps.tanzu.vmware.com
- api-portal.tanzu.vmware.com
---
EOF
```

```
tanzu package install tap -p tap.tanzu.vmware.com -v 1.7.1 --values-file tap-values.yaml -n tap-install
```

```
IMGPKG_REGISTRY_HOSTNAME=registry.tanzu.vmware.com \
IMGPKG_REGISTRY_USERNAME=$TANZUNET_USERNAME \
IMGPKG_REGISTRY_PASSWORD=$TANZUNET_PASSWORD \
imgpkg copy \
  -b registry.tanzu.vmware.com/tanzu-application-platform/full-deps-package-repo:1.7.1 \
  --to-tar full-deps-1.7.1.tar \
  --include-non-distributable-layers


ECR_REPO=$(aws ecr describe-repositories --region ap-northeast-1 --query 'repositories[?repositoryName==`full-deps-package-repo`].repositoryUri' --output text)
aws ecr get-login-password --region ap-northeast-1 | docker login ${ECR_REPO} -u AWS --password-stdin

imgpkg copy \
  --tar full-deps-1.7.1.tar \
  --to-repo ${ECR_REPO} \
  --include-non-distributable-layers
```


```
tanzu package repository add full-deps-package-repo \
  --url ${ECR_REPO}:1.7.1 \
  --namespace tap-install
```

```
tanzu package install full-deps -p full-deps.buildservice.tanzu.vmware.com -v "> 0.0.0" -n tap-install --values-file tap-values.yaml
```


```
$ kubectl get pkgi -n tap-install
NAME                                 PACKAGE NAME                                          PACKAGE VERSION   DESCRIPTION           AGE
accelerator                          accelerator.apps.tanzu.vmware.com                     1.7.6             Reconcile succeeded   11m
amr-observer                         amr-observer.apps.tanzu.vmware.com                    0.2.1             Reconcile succeeded   11m
api-auto-registration                apis.apps.tanzu.vmware.com                            0.4.1             Reconcile succeeded   11m
appliveview                          backend.appliveview.tanzu.vmware.com                  1.7.2             Reconcile succeeded   11m
appliveview-apiserver                apiserver.appliveview.tanzu.vmware.com                1.7.2             Reconcile succeeded   18m
appliveview-connector                connector.appliveview.tanzu.vmware.com                1.7.2             Reconcile succeeded   18m
appliveview-conventions              conventions.appliveview.tanzu.vmware.com              1.7.2             Reconcile succeeded   17m
base-jammy-builder                   base-jammy-builder.buildpacks.tanzu.vmware.com        0.1.0             Reconcile succeeded   3m41s
base-jammy-stack                     base-jammy-stack.buildpacks.tanzu.vmware.com          0.1.63            Reconcile succeeded   4m
bitnami-services                     bitnami.services.tanzu.vmware.com                     0.3.1             Reconcile succeeded   17m
buildservice                         buildservice.tanzu.vmware.com                         1.12.2            Reconcile succeeded   18m
cartographer                         cartographer.tanzu.vmware.com                         0.8.5             Reconcile succeeded   18m
cert-manager                         cert-manager.tanzu.vmware.com                         2.4.1             Reconcile succeeded   18m
cnrs                                 cnrs.tanzu.vmware.com                                 2.4.3             Reconcile succeeded   11m
contour                              contour.tanzu.vmware.com                              1.25.3            Reconcile succeeded   18m
crossplane                           crossplane.tanzu.vmware.com                           0.3.0             Reconcile succeeded   18m
developer-conventions                developer-conventions.tanzu.vmware.com                0.14.1            Reconcile succeeded   17m
dotnet-core-buildpack                dotnet-core.buildpacks.tanzu.vmware.com               2.8.2             Reconcile succeeded   4m
fluxcd-source-controller             fluxcd.source.controller.tanzu.vmware.com             0.36.1+tanzu.2    Reconcile succeeded   18m
full-deps                            full-deps.buildservice.tanzu.vmware.com               1.7.38            Reconcile succeeded   4m23s
full-jammy-builder                   full-jammy-builder.buildpacks.tanzu.vmware.com        0.1.0             Reconcile succeeded   3m41s
full-jammy-stack                     full-jammy-stack.buildpacks.tanzu.vmware.com          0.1.114           Reconcile succeeded   4m
go-buildpack                         go.buildpacks.tanzu.vmware.com                        2.2.2             Reconcile succeeded   4m
java-buildpack                       java.buildpacks.tanzu.vmware.com                      9.11.0            Reconcile succeeded   4m
java-native-image-buildpack          java-native-image.buildpacks.tanzu.vmware.com         7.9.0             Reconcile succeeded   4m
local-source-proxy                   local-source-proxy.apps.tanzu.vmware.com              0.2.1             Reconcile succeeded   18m
metadata-store                       metadata-store.apps.tanzu.vmware.com                  1.7.1             Reconcile succeeded   11m
namespace-provisioner                namespace-provisioner.apps.tanzu.vmware.com           0.5.0             Reconcile succeeded   18m
nodejs-buildpack                     nodejs.buildpacks.tanzu.vmware.com                    2.3.2             Reconcile succeeded   4m
ootb-delivery-basic                  ootb-delivery-basic.tanzu.vmware.com                  0.14.8            Reconcile succeeded   17m
ootb-supply-chain-testing-scanning   ootb-supply-chain-testing-scanning.tanzu.vmware.com   0.14.8            Reconcile succeeded   17m
ootb-templates                       ootb-templates.tanzu.vmware.com                       0.14.8            Reconcile succeeded   17m
php-buildpack                        php.buildpacks.tanzu.vmware.com                       2.6.1             Reconcile succeeded   4m
procfile-buildpack                   procfile.buildpacks.tanzu.vmware.com                  5.6.1             Reconcile succeeded   4m
python-buildpack                     python.buildpacks.tanzu.vmware.com                    2.5.1             Reconcile succeeded   4m
ruby-buildpack                       ruby.buildpacks.tanzu.vmware.com                      2.8.1             Reconcile succeeded   4m
scanning                             scanning.apps.tanzu.vmware.com                        1.7.1             Reconcile succeeded   18m
service-bindings                     servicebinding.tanzu.vmware.com                       0.10.2            Reconcile succeeded   18m
services-toolkit                     services-toolkit.tanzu.vmware.com                     0.12.0            Reconcile succeeded   18m
source-controller                    controller.source.apps.tanzu.vmware.com               0.8.3             Reconcile succeeded   18m
spring-boot-conventions              spring-boot-conventions.tanzu.vmware.com              1.7.2             Reconcile succeeded   17m
tap                                  tap.tanzu.vmware.com                                  1.7.1             Reconcile succeeded   18m
tap-auth                             tap-auth.tanzu.vmware.com                             1.1.0             Reconcile succeeded   18m
tap-gui                              tap-gui.tanzu.vmware.com                              1.7.8             Reconcile succeeded   11m
tap-telemetry                        tap-telemetry.tanzu.vmware.com                        0.7.0             Reconcile succeeded   18m
tekton-pipelines                     tekton.tanzu.vmware.com                               0.50.3+tanzu.3    Reconcile succeeded   18m
tiny-jammy-builder                   tiny-jammy-builder.buildpacks.tanzu.vmware.com        0.1.0             Reconcile succeeded   3m41s
tiny-jammy-stack                     tiny-jammy-stack.buildpacks.tanzu.vmware.com          0.1.66            Reconcile succeeded   4m
web-servers-buildpack                web-servers.buildpacks.tanzu.vmware.com               0.15.4            Reconcile succeeded   4m
```

```
$ kubectl get svc -n tanzu-system-ingress envoy
NAME    TYPE           CLUSTER-IP       EXTERNAL-IP                                                                          PORT(S)                      AGE
envoy   LoadBalancer   10.100.101.173   ae43d7e09134b43ef80574560580805a-ea69a645539d0581.elb.ap-northeast-1.amazonaws.com   80:30850/TCP,443:31534/TCP   11m
```

```
$ kubectl get httpproxy -A
NAMESPACE               NAME                               FQDN                                               TLS SECRET                            STATUS   STATUS DESCRIPTION
api-auto-registration   api-auto-registration-controller   api-auto-registration.tap.57.180.147.144.nip.io    api-auto-registration-cert            valid    Valid HTTPProxy
metadata-store          amr-cloudevent-handler-ingress     amr-cloudevent-handler.tap.57.180.147.144.nip.io   amr-cloudevent-handler-ingress-cert   valid    Valid HTTPProxy
metadata-store          amr-graphql-ingress                amr-graphql.tap.57.180.147.144.nip.io              amr-ingress-cert                      valid    Valid HTTPProxy
metadata-store          metadata-store-ingress             metadata-store.tap.57.180.147.144.nip.io           ingress-cert                          valid    Valid HTTPProxy
tap-gui                 tap-gui                            tap-gui.tap.57.180.147.144.nip.io                  tap-gui-cert                          valid    Valid HTTPProxy
```

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/aa4391c8-64a5-4ea4-b140-ce081ae1fc3d">


```
$ kubectl get clusterbuilder 
NAME         LATESTIMAGE                                                                                                                                                      READY
base-jammy   532912407632.dkr.ecr.ap-northeast-1.amazonaws.com/tap-build-service:base-jammy-builder@sha256:c80efd84db8d5f1738c2e77b6889a76b457ed11d81152f9da7689707ff81b307   True
default      532912407632.dkr.ecr.ap-northeast-1.amazonaws.com/tap-build-service:default-builder@sha256:c80efd84db8d5f1738c2e77b6889a76b457ed11d81152f9da7689707ff81b307      True
full-jammy   532912407632.dkr.ecr.ap-northeast-1.amazonaws.com/tap-build-service:full-jammy-builder@sha256:fb880f8be4f3f411a0da4a6b05bc8794b0806c7fc0731148febcbb8d6384b228   True
tiny-jammy   532912407632.dkr.ecr.ap-northeast-1.amazonaws.com/tap-build-service:tiny-jammy-builder@sha256:480f70598378dde45304ac66d65fafe8fee07ae8b0104755b50d31aca99b8fe0   True
```



```
kubectl create ns demo
kubectl label namespaces demo apps.tanzu.vmware.com/tap-ns=""
```

```
$ tanzu apps cluster-supply-chain list
NAME                         READY   AGE
scanning-image-scan-to-url   Ready   22m
source-test-scan-to-url      Ready   22m
```

```yaml
kubectl apply -f - -n demo << 'EOF'
---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: skip-test-pipeline
  labels:
    apps.tanzu.vmware.com/pipeline: test
    apps.tanzu.vmware.com/language: skip
spec:
  params:
  - name: source-url
  - name: source-revision
  tasks:
  - name: test
    params:
    - name: source-url
      value: $(params.source-url)
    - name: source-revision
      value: $(params.source-revision)
    taskSpec:
      params:
      - name: source-url
      - name: source-revision
      steps:
      - name: test
        image: alpine
        script: |-
          echo 'skip'
---
EOF
```

```yaml
kubectl apply -f - -n demo << 'EOF'
---
apiVersion: scanning.apps.tanzu.vmware.com/v1beta1
kind: ScanPolicy
metadata:
  labels:
    app.kubernetes.io/part-of: enable-in-gui
  name: scan-policy
spec:
  regoFile: |
    package main
    
    # Accepted Values: "Critical", "High", "Medium", "Low", "Negligible", "UnknownSeverity"
    notAllowedSeverities := ["UnknownSeverity"]
    
    ignoreCves := []
    
    contains(array, elem) = true {
      array[_] = elem
    } else = false { true }
    
    isSafe(match) {
      severities := { e | e := match.ratings.rating.severity } | { e | e := match.ratings.rating[_].severity }
      some i
      fails := contains(notAllowedSeverities, severities[i])
      not fails
    }
    
    isSafe(match) {
      ignore := contains(ignoreCves, match.id)
      ignore
    }
    
    deny[msg] {
      comps := { e | e := input.bom.components.component } | { e | e := input.bom.components.component[_] }
      some i
      comp := comps[i]
      vulns := { e | e := comp.vulnerabilities.vulnerability } | { e | e := comp.vulnerabilities.vulnerability[_] }
      some j
      vuln := vulns[j]
      ratings := { e | e := vuln.ratings.rating.severity } | { e | e := vuln.ratings.rating[_].severity }
      not isSafe(vuln)
      msg = sprintf("CVE %s %s %s", [comp.name, vuln.id, ratings])
    }
---
EOF
```

```
WORKLOADNAME=hello-nodejs
NAMESPACE=demo

aws ecr create-repository --repository-name tanzu-application-platform/${WORKLOADNAME}-${NAMESPACE} --region $AWS_REGION
aws ecr create-repository --repository-name tanzu-application-platform/${WORKLOADNAME}-${NAMESPACE}-bundle --region $AWS_REGION
```

```
tanzu apps workload apply hello-nodejs \
  --app hello-nodejs \
  --git-repo https://github.com/making/hello-nodejs \
  --git-branch master \
  --type web \
  --label apps.tanzu.vmware.com/has-tests=true \
  -n demo \
  -y
```


```
$ tanzu apps workload get hello-nodejs --namespace demo       
📡 Overview
   name:        hello-nodejs
   type:        web
   namespace:   demo

💾 Source
   type:       git
   url:        https://github.com/making/hello-nodejs
   branch:     master
   revision:   master@sha1:76f84e92aa878f170b5b5010bf4cd7cabfbf7e53

📦 Supply Chain
   name:   source-test-scan-to-url

   NAME               READY   HEALTHY   UPDATED   RESOURCE
   source-provider    True    True      101m      gitrepositories.source.toolkit.fluxcd.io/hello-nodejs
   source-tester      True    True      36m       runnables.carto.run/hello-nodejs
   image-provider     True    True      58m       images.kpack.io/hello-nodejs
   image-scanner      True    True      47m       imagescans.scanning.apps.tanzu.vmware.com/hello-nodejs
   config-provider    True    True      47m       podintents.conventions.carto.run/hello-nodejs
   app-config         True    True      47m       configmaps/hello-nodejs
   service-bindings   True    True      47m       configmaps/hello-nodejs-with-claims
   api-descriptors    True    True      47m       configmaps/hello-nodejs-with-api-descriptors
   config-writer      True    True      34m       taskruns.tekton.dev/hello-nodejs-config-writer-slczz

🚚 Delivery
   name:   delivery-basic

   NAME              READY   HEALTHY   UPDATED   RESOURCE
   source-provider   True    True      45m       imagerepositories.source.apps.tanzu.vmware.com/hello-nodejs-delivery
   deployer          True    True      45m       apps.kappctrl.k14s.io/hello-nodejs

💬 Messages
   No messages found.

🛶 Pods
   NAME                                             READY   STATUS      RESTARTS   AGE
   hello-nodejs-00001-deployment-745768cdcb-6c2h5   2/2     Running     0          4s
   hello-nodejs-config-writer-slczz-pod             0/1     Completed   0          36m
   hello-nodejs-jt8dc-test-pod                      0/1     Completed   0          36m

🚢 Knative Services
   NAME           READY   URL
   hello-nodejs   Ready   https://hello-nodejs.demo.tap.57.180.147.144.nip.io

To see logs: "tanzu apps workload tail hello-nodejs --namespace demo --timestamp --since 1h"
```

```
$ curl -k https://hello-nodejs.demo.tap.57.180.147.144.nip.io

Hello World! (hello-nodejs-00001-deployment-745768cdcb-xbtdb)
```

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/0f3ef596-f8c1-4f34-ad0c-edbe829e45ba">

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/603ce9ff-3f17-4546-b565-402bd8a1c494">

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/16cdd6e0-5f89-4de4-800c-fa6cdb30f2ac">

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/ae34ddf2-c4f5-4d6e-8890-9d665c9f8bb5">