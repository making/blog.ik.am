---
title: Cloud Foundry Container Runtime 0.16.0 (Kubernetes on BOSH)ã‚’BOSH-wayã§AWSã«ãƒ‡ãƒ—ãƒ­ã‚¤
tags: ["Kubo", "BOSH", "Kubernetes", "AWS", "CFCR", "PKS"]
categories: ["Dev", "CaaS", "Kubernetes", "CFCR"]
---

**ç›®æ¬¡**

[Cloud Foundry Container Runtime](https://docs-cfcr.cfapps.io/)(CFCR)ã‚’ä½¿ã£ã¦Kubernetesã‚’[BOSH](https://bosh.io)ã§AWSã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

CFCRã¯ã‹ã¤ã¦Kubo(Kubernetes on BOSH)ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã—ãŸãŒã€renameã•ã‚Œã¾ã—ãŸã€‚
[Kubo 0.8.0ã®æ™‚](https://blog.ik.am/entries/436)ã«ã‚‚ãƒ¡ãƒ¢ã‚’æ›¸ã„ã¦ã„ãŸã®ã§ã™ãŒã€ã‚ã¾ã‚Šã«ã‚‚å¤ã„ã®ã§ä¸€æ—¦ç’°å¢ƒä½œã‚Šç›´ã—ã§ã™ã€‚
ã“ã®è¨˜äº‹ã§ä¸€åº¦ç’°å¢ƒã‚’ä½œã‚Œã°ã€ä»Šå¾Œã¯(Breaking ChangeãŒãªã„é™ã‚Š)ç°¡å˜ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã«è¿½å¾“ã§ãã‚‹ã¯ãšã§ã™ã€‚

* ğŸ†•**0.16.0ã‹ã‚‰0.17.0ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹æ–¹æ³•**ã¯[ã“ã¡ã‚‰](https://blog.ik.am/entries/452)
* ğŸ†•0.17.0ã‹ã‚‰æ–°è¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ–¹æ³•ã¯[ã“ã¡ã‚‰](https://blog.ik.am/entries/453)

<!-- toc -->

### CFCRã®deploy

[Official Document](https://docs-cfcr.cfapps.io/installing/)ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã¯æ‰‹ä½œæ¥­ãŒæ··ã˜ã£ã¦ã„ã‚‹ã®ã¨BOSHã®æ“ä½œã‚’éš è”½ã—ã¦ã—ã¾ã£ã¦ãŠã‚Šã€BOSHãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯æ‰±ã„ã¥ã‚‰ã„å†…å®¹ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€
ç´ ç›´ãªBOSH wayã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã—ãŸã€‚ã¾ãŸTerraformãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚‚[ã‚ªãƒ•ã‚£ã‚·ãƒ£ãƒ«ã®ã‚‚ã®](https://github.com/cloudfoundry-incubator/kubo-deployment/tree/master/docs/terraform/aws)ã«åŠ ãˆã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ‰‹ä½œæ¥­éƒ¨åˆ†ã‚‚è¿½åŠ ã—ã¾ã—ãŸã€‚

#### Terraformã§AWSç’°å¢ƒã‚’Paving

ã¾ãšã¯BOSHãŠã‚ˆã³Kuberneteã«å¿…è¦ãªAWSç’°å¢ƒã‚’Paving(èˆ—è£…)ã—ã¾ã™ã€‚ã“ã“ã§ã¯[Terraform](https://www.terraform.io/)ã‚’ä½¿ã„ã¾ã™ã€‚

[ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ¸ˆã¿Terraformãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](https://github.com/making/cfcr-aws)ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚

```bash
git clone https://github.com/making/cfcr-aws.git
cd cfcr-aws/terraform
```

`terraform.tfvars`ã«å¤‰æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚`access_key`ã¨`secret_key`ã¯Terraformå®Ÿè¡Œç”¨ã®IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã§`AdministratorAccess` Roleã‚’æŒã£ãŸã‚‚ã®ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚

```bash
cat <<EOF > terraform.tfvars
prefix                   = "demo"
access_key               = "abcdef"
secret_key               = "foobar"
region                   = "ap-northeast-1"
zone                     = "ap-northeast-1a"
vpc_cidr                 = "10.0.0.0/16"
public_subnet_ip_prefix  = "10.0.1"
private_subnet_ip_prefix = "10.0.2"
EOF
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Terraformã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```
terraform init
terraform plan -out plan
terraform apply plan
```

æ¬¡ã®å›³ã®ã‚ˆã†ãªç’°å¢ƒãŒã§ãã¾ã—ãŸã€‚

![image](https://user-images.githubusercontent.com/106908/40372551-eb314806-5e1f-11e8-97df-d665b321c33a.png)


#### Bastionã‚µãƒ¼ãƒãƒ¼ã¸login

æ¬¡ã«èˆ—è£…ã•ã‚ŒãŸç’°å¢ƒä¸Šã§BOSHã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ãŒã€ä½œæ¥­ã¯Bastion(è¸ã¿å°)ã‚µãƒ¼ãƒãƒ¼ä¸Šã§è¡Œã„ã¾ã™ã€‚

```bash
cat terraform.tfstate | jq -r '.modules[0].resources["tls_private_key.deployer"].primary.attributes.private_key_pem' > deployer.pem
chmod 600 deployer.pem
export BASTION_IP=`cat terraform.tfstate | jq -r '.modules[0].outputs["bosh_bastion_ip"].value'`

echo "ssh -o StrictHostKeyChecking=no -i $(pwd)/deployer.pem ubuntu@${BASTION_IP}" > ssh-bastion.sh
chmod +x ssh-bastion.sh
```

æ¬¡ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦Bastionã‚µãƒ¼ãƒãƒ¼ã«sshãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚

```bash
./ssh-bastion.sh
```

#### BOSHã®provisioning

BOSH(BOSH Director)ã‚’[bosh-deployment](https://github.com/cloudfoundry/bosh-deployment)ã‚’ä½¿ã£ã¦Provisioningã—ã¾ã™ã€‚
åˆã‚ã›ã¦[kubo-deployment](https://github.com/cloudfoundry-incubator/kubo-deployment)ã‚‚å–å¾—ã—ã€ä¸€æ—¦Gitç®¡ç†ã—ã¾ã™ã€‚

```bash
mkdir cfcr-manifests
cd cfcr-manifests
git init
git submodule add https://github.com/cloudfoundry/bosh-deployment.git
git submodule add https://github.com/cloudfoundry-incubator/kubo-deployment.git
cd kubo-deployment
git checkout v0.16.0
cd ..
git add -A
git commit -m "import CFCR v0.16.0"
```

YAMLã®å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«(ops-file)ã¯`ops-files`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ç®¡ç†ã—ã¾ã™ã€‚

```bash
mkdir -p ops-files
```

BOSH Directorã®VMã‚µã‚¤ã‚ºã‚’å°ã•ã‚ã®`t2.small`ã«ã™ã‚‹ops-fileã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml
cat <<EOF > ops-files/director-size-aws.yml
- type: replace
  path: /resource_pools/name=vms/cloud_properties/instance_type
  value: t2.small
EOF
```

BOSHã‚’provisioningã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚å„ç¨®ç’°å¢ƒå¤‰æ•°ã¯Terraformã§Bastionã‚µãƒ¼ãƒãƒ¼ã«è¨­å®šæ¸ˆã¿ã§ã™ã€‚

```bash
cat <<'EOF' > deploy-bosh.sh
#!/bin/bash
bosh create-env bosh-deployment/bosh.yml \
    -o bosh-deployment/aws/cpi.yml \
    -o bosh-deployment/uaa.yml \
    -o bosh-deployment/credhub.yml \
    -o bosh-deployment/jumpbox-user.yml \
    -o bosh-deployment/local-dns.yml \
    -o ops-files/director-size-aws.yml \
    -o kubo-deployment/configurations/generic/dns-addresses.yml \
    -o kubo-deployment/configurations/generic/bosh-admin-client.yml \
    -o kubo-deployment/manifests/ops-files/iaas/aws/bosh/tags.yml \
    -v director_name=bosh-aws \
    -v internal_cidr=${private_subnet_ip_prefix}.0/24 \
    -v internal_gw=${private_subnet_ip_prefix}.1 \
    -v internal_ip=${private_subnet_ip_prefix}.252 \
    -v access_key_id=${AWS_ACCESS_KEY_ID} \
    -v secret_access_key=${AWS_SECRET_ACCESS_KEY} \
    -v region=${region} \
    -v az=${zone} \
    -v default_key_name=${default_key_name} \
    -v default_security_groups=[${default_security_groups}] \
    --var-file private_key=${HOME}/deployer.pem \
    -v subnet_id=${private_subnet_id} \
    --vars-store=bosh-aws-creds.yml \
    --state bosh-aws-state.json
EOF
chmod +x deploy-bosh.sh
```

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦BOSH Directorã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```bash
./deploy-bosh.sh
```
æ¬¡ã®å›³ã®ã‚ˆã†ãªç’°å¢ƒãŒã§ãã¾ã—ãŸã€‚

![image](https://user-images.githubusercontent.com/106908/40372434-a36b332e-5e1f-11e8-90e0-7ea768bb2b2f.png)

BOSH Directorã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ãŸã„å ´åˆã¯`bosh-deployment`ã‚’`git pull`ã—ã¦`./deploy-bosh.sh`ã‚’å†å®Ÿè¡Œã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

#### BOSH Directorã®è¨­å®š

BOSH Directorã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’è¡Œã„ã€BOSH Directorã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

```bash
cat <<'EOF' > bosh-aws-env.sh
export BOSH_CLIENT=admin  
export BOSH_CLIENT_SECRET=$(bosh int ./bosh-aws-creds.yml --path /admin_password)
export BOSH_CA_CERT=$(bosh int ./bosh-aws-creds.yml --path /director_ssl/ca)
export BOSH_ENVIRONMENT=${private_subnet_ip_prefix}.252
EOF
chmod +x bosh-aws-env.sh
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```bash
source bosh-aws-env.sh
```

`bosh env`ã¨`bosh login`ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ bosh env
Using environment '10.0.2.252' as client 'admin'

Name      bosh-aws  
UUID      7feb01e4-0eee-4eae-a735-8e3183428087  
Version   265.2.0 (00000000)  
CPI       aws_cpi  
Features  compiled_package_cache: disabled  
          config_server: enabled  
          dns: disabled  
          snapshots: disabled  
User      admin  

Succeeded
```

```
$ bosh login
Successfully authenticated with UAA

Succeeded
```

#### Stemcellã®upload

BOSHãŒä½œæˆã™ã‚‹VMã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã‚ã‚‹Stemcellã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

```
STEMCELL_VERSION=$(bosh int kubo-deployment/manifests/cfcr.yml --path /stemcells/0/version)
bosh upload-stemcell https://s3.amazonaws.com/bosh-aws-light-stemcells/light-bosh-stemcell-${STEMCELL_VERSION}-aws-xen-hvm-ubuntu-trusty-go_agent.tgz
```


#### Cloud Configã®update

BOSH Directorã«IaaSã®ç’°å¢ƒä¸Šã‚’è¨­å®šã™ã‚‹ãŸã‚ã®Cloud Configã‚’ä½œæˆã—ã¾ã™ã€‚

Cloud Configã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯[Officialã®ã‚‚ã®](https://github.com/cloudfoundry-incubator/kubo-deployment/blob/v0.16.0/configurations/aws/cloud-config.yml)ã‚’ä½¿ã„ã¾ã™ãŒã€`vm_type`åãŒãªãœã‹[`cfcr.yml`](https://github.com/cloudfoundry-incubator/kubo-deployment/blob/v0.16.0/manifests/cfcr.yml)ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹å€¤ã¨é•ã†ãŸã‚ã€renameã™ã‚‹ãŸã‚ã®ops-fileã‚’ä½œæˆã—ã¾ã™...

```yaml
cat <<EOF > ops-files/cloud-config-rename-vm-types.yml
- type: replace
  path: /vm_types/name=master/name
  value: small
- type: replace
  path: /vm_types/name=worker/name
  value: small-highmem
- type: replace
  path: /compilation/vm_type
  value: small-highmem
EOF
```

`instance_type`ã‚’å°ã•ãã—ã¾ã™ã€‚

```yaml
cat <<EOF > ops-files/cloud-config-small-vm-types.yml
- type: replace
  path: /vm_types/name=minimal/cloud_properties/instance_type
  value: t2.micro
- type: replace
  path: /vm_types/name=small/cloud_properties/instance_type
  value: t2.micro
- type: replace
  path: /vm_types/name=small-highmem/cloud_properties/instance_type
  value: t2.medium
EOF
```

Master APIã«LoadBalancerã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ãŸã‚ã®`vm_extensions`ã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml
cat <<EOF > ops-files/cloud-config-master-lb.yml
- type: replace
  path: /vm_extensions?/-
  value:
    name: master-lb
    cloud_properties:
      elbs:
      - ((master_target_pool))
EOF
```

Cloud Configã‚’updateã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
cat <<'EOF' > update-cloud-config.sh
#!/bin/bash
bosh update-cloud-config kubo-deployment/configurations/aws/cloud-config.yml \
    -o ops-files/cloud-config-rename-vm-types.yml \
    -o ops-files/cloud-config-small-vm-types.yml \
    -o ops-files/cloud-config-master-lb.yml \
    -v az=${zone} \
    -v master_iam_instance_profile=${prefix}-cfcr-master \
    -v worker_iam_instance_profile=${prefix}-cfcr-worker \
    -v internal_cidr=${private_subnet_ip_prefix}.0/24 \
    -v internal_gw=${private_subnet_ip_prefix}.1 \
    -v dns_recursor_ip=${private_subnet_ip_prefix}.1 \
    -v subnet_id=${private_subnet_id} \
    -v master_target_pool=${prefix}-cfcr-api
EOF
chmod +x update-cloud-config.sh
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```bash
./update-cloud-config.sh
```

#### Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®ãƒ‡ãƒ—ãƒ­ã‚¤


Kubernetesã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯[Officialã®Manifest](https://github.com/cloudfoundry-incubator/kubo-deployment/blob/v0.16.0/manifests)ã‚’ãƒ™ãƒ¼ã‚¹ã«å·®åˆ†ã‚’ops-fileã§é©ç”¨ã™ã‚‹å½¢ã§è¡Œã„ã¾ã™ã€‚


CFCR 0.16.0ã‚’ä½¿ã†ops-fileã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml
cat <<EOF > ops-files/kubernetes-kubo-0.16.0.yml
- type: replace
  path: /releases/name=kubo?
  value:
    name: kubo
    version: 0.16.0
    url: https://bosh.io/d/github.com/cloudfoundry-incubator/kubo-release?v=0.16.0
    sha1: 8a513e48cccdea224c17a92ce73edbda04acee91
EOF
```

Workerã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ã‚’1ã«æ¸›ã‚‰ã™ops-fileã‚’ä½œæˆã—ã¾ã™ã€‚(Workerã‚’å¢—ã‚„ã—ãŸã„å ´åˆã¯ã“ã®å€¤ã‚’å¤‰ãˆã¦ãã ã•ã„)

```yaml
cat <<EOF > ops-files/kubernetes-worker.yml
- type: replace
  path: /instance_groups/name=worker/instances
  value: 1
EOF
```

Masterã«LBã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ãŸã‚ã®`vm_extensions`ã¨ã€Masterã®TLSè¨¼æ˜æ›¸ã®SANã«ELBã®DNSåã‚’è¿½åŠ ã™ã‚‹ops-fileã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml
cat <<EOF > ops-files/kubernetes-master-lb.yml
- type: replace
  path: /instance_groups/name=master/vm_extensions?/-
  value: master-lb

- type: replace
  path: /variables/name=tls-kubernetes/options/alternative_names/-
  value: ((kubernetes_master_host))
EOF
```

ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«è¿½åŠ ã§ç™»éŒ²ã—ãŸã„Addonã¯`specs`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã§ç®¡ç†ã—ã¾ã™ã€‚

```bash
mkdir -p specs
```

EBSç”¨ã®StorageClassã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦ç™»éŒ²ã™ã‚‹Specã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml
cat <<EOF > specs/aws-storage-class.yml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: standard
  annotations:
    storageclass.beta.kubernetes.io/is-default-class: "true"
  labels:
    kubernetes.io/cluster-service: "true"
    addonmanager.kubernetes.io/mode: EnsureExists
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp2
EOF
```

Kubrnetesã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
cat <<'EOF' > deploy-kubernetes.sh
#!/bin/bash
bosh deploy -d cfcr kubo-deployment/manifests/cfcr.yml \
    -o kubo-deployment/manifests/ops-files/addons-spec.yml \
    -o kubo-deployment/manifests/ops-files/iaas/aws/lb.yml \
    -o kubo-deployment/manifests/ops-files/iaas/aws/cloud-provider.yml \
    -o ops-files/kubernetes-kubo-0.16.0.yml \
    -o ops-files/kubernetes-worker.yml \
    -o ops-files/kubernetes-master-lb.yml \
    --var-file addons-spec=<(for f in `ls specs/*.yml`;do cat $f;echo;echo "---";done) \
    -v kubernetes_cluster_tag=${kubernetes_cluster_tag} \
    -v kubernetes_master_host=${master_lb_ip_address} \
    --no-redact
EOF
chmod +x deploy-kubernetes.sh
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ã€‚(é€”ä¸­ã§`y`ã‚’å…¥åŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚)

```bash
./deploy-kubernetes.sh
```

æ¬¡ã®å›³ã®ã‚ˆã†ãªç’°å¢ƒãŒã§ãã¾ã—ãŸã€‚

![image](https://user-images.githubusercontent.com/106908/40374599-59ebcdb2-5e24-11e8-8631-af8ef0c5f39d.png)

`bosh vms`ã€`bosh instances --ps`ã‚’å®Ÿè¡Œã—ã¦VMä¸€è¦§ã€ãƒ—ãƒ­ã‚»ã‚¹ä¸€è¦§ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ bosh -d cfcr vms
Using environment '10.0.2.252' as client 'admin'

Task 13. Done

Deployment 'cfcr'

Instance                                     Process State  AZ  IPs       VM CID               VM Type        Active  
master/bc14d482-2481-4cd4-ab61-f8998959befe  running        z1  10.0.2.4  i-07b65c52ed5de9bfa  small          -  
worker/9a57034a-99a5-48cb-9db0-59841e083a8c  running        z1  10.0.2.5  i-0cadb8a54cec35909  small-highmem  -  
```

```
$ bosh -d cfcr instances --ps
Using environment '10.0.2.252' as client 'admin'

Task 14. Done

Deployment 'cfcr'

Instance                                           Process                  Process State  AZ  IPs  
apply-addons/70988ada-d3b8-4015-b2a7-de93ebd21e92  -                        -              z1  -  
master/bc14d482-2481-4cd4-ab61-f8998959befe        -                        running        z1  10.0.2.4  
~                                                  bosh-dns                 running        -   -  
~                                                  bosh-dns-healthcheck     running        -   -  
~                                                  bosh-dns-resolvconf      running        -   -  
~                                                  etcd                     running        -   -  
~                                                  flanneld                 running        -   -  
~                                                  kube-apiserver           running        -   -  
~                                                  kube-controller-manager  running        -   -  
~                                                  kube-scheduler           running        -   -  
worker/9a57034a-99a5-48cb-9db0-59841e083a8c        -                        running        z1  10.0.2.5  
~                                                  bosh-dns                 running        -   -  
~                                                  bosh-dns-healthcheck     running        -   -  
~                                                  bosh-dns-resolvconf      running        -   -  
~                                                  docker                   running        -   -  
~                                                  flanneld                 running        -   -  
~                                                  kube-proxy               running        -   -  
~                                                  kubelet                  running        -   -  

18 instances
```

CFCRãŒã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚ŒãŸå ´åˆã¯ã€Breaking ChangeãŒãªã‘ã‚Œã°`kubo-deployment`ã‚’`git pull`ã—ã¦ã€`./deploy-kubernetes.sh`ã‚’å®Ÿè¡Œã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

#### Addonã®deploy

KubeDNS, Kubenetes Dashboardãªã©ã®Addonã¯errandã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```bash
bosh -d cfcr run-errand apply-addons
```

#### CredHubã¸ã®ãƒ­ã‚°ã‚¤ãƒ³

Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã«é–¢ã™ã‚‹Credentialsæƒ…å ±ã¯BOSH Director VMå†…ã®CredHubã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
TLSè¨¼æ˜æ›¸ã‚„Adminã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ã«ã¯CredHubã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

CredHubã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
cat <<'EOF' > credhub-login.sh
#!/bin/bash
credhub login \
        -s ${BOSH_ENVIRONMENT}:8844 \
        --client-name=credhub-admin \
        --client-secret=$(bosh int ./bosh-aws-creds.yml --path /credhub_admin_client_secret) \
        --ca-cert <(bosh int ./bosh-aws-creds.yml --path /uaa_ssl/ca) \
        --ca-cert <(bosh int ./bosh-aws-creds.yml --path /credhub_ca/ca)
EOF
chmod +x credhub-login.sh
```

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦CredHubã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚

```bash
./credhub-login.sh
```

CredHubã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯1æ™‚é–“ã§åˆ‡ã‚Œã‚‹ã®ã§ã€æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚ŒãŸã‚‰å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚

#### Kubernetesã¸ã‚¢ã‚¯ã‚»ã‚¹

Adminã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’CredHubã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚

```bash
admin_password=$(credhub get -n /bosh-aws/cfcr/kubo-admin-password | bosh int - --path=/value)
```

Master APIã®TLS CAè¨¼æ˜æ›¸ã‚’å–å¾—ã—ã¾ã™ã€‚

```bash
tmp_ca_file="$(mktemp)"
credhub get -n /bosh-aws/cfcr/tls-kubernetes | bosh int - --path=/value/ca > "${tmp_ca_file}"
```

`kubectl`ã®Contextã‚’è¨­å®šã—ã¾ã™ã€‚

```bash
cluster_name="cfcr-aws"
user_name="admin-aws"
context_name="cfcr-aws"

kubectl config set-cluster "${cluster_name}" \
  --server="https://${master_lb_ip_address}:8443" \
  --certificate-authority="${tmp_ca_file}" \
  --embed-certs=true

kubectl config set-credentials "${user_name}" --token="${admin_password}"

kubectl config set-context "${context_name}" --cluster="${cluster_name}" --user="${user_name}"

kubectl config use-context "${context_name}"
```

`kubectl cluster-info`ã§ã‚¯ãƒ©ã‚¹ã‚¿æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ kubectl cluster-info
Kubernetes master is running at https://demo-cfcr-api-658626716.ap-northeast-1.elb.amazonaws.com:8443
Heapster is running at https://demo-cfcr-api-658626716.ap-northeast-1.elb.amazonaws.com:8443/api/v1/namespaces/kube-system/services/heapster/proxy
KubeDNS is running at https://demo-cfcr-api-658626716.ap-northeast-1.elb.amazonaws.com:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
monitoring-influxdb is running at https://demo-cfcr-api-658626716.ap-northeast-1.elb.amazonaws.com:8443/api/v1/namespaces/kube-system/services/monitoring-influxdb/proxy
```

Master APIã¯Internet FacingãªELBã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹ã®ã§ã€`~/.kube/config`ã®å†…å®¹ã¯Bastionã‚µãƒ¼ãƒãƒ¼ä»¥å¤–ã§ã‚‚åˆ©ç”¨å¯èƒ½ã§ã™ã€‚


æœ€çµ‚çš„ã«ã“ã®è¨˜äº‹ã§ä½¿ç”¨ã™ã‚‹EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

![image](https://user-images.githubusercontent.com/106908/40376301-f97e7fa6-5e28-11e8-99cf-e40fd3a309ff.png)


#### CFCR 0.16.0ã§ã®åˆ¶ç´„äº‹é …

CFCR 0.16.0ã§ã¯

* Multi-AZå¯¾å¿œ
* Masterã®HAå¯¾å¿œ

ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ¬¡ã®0.17.0ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹äºˆå®šã§ã™ã€‚

### CFCRã®destroy

ä½¿ã„çµ‚ã‚ã£ãŸç’°å¢ƒã¯å‰Šé™¤ã—ã¾ã™ã€‚

#### Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®å‰Šé™¤

Kubernetesã‚’æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰å‰Šé™¤ã—ã¾ã™ã€‚
ãªãŠã€KubernetesãŒprovisioningã—ãŸServiceç”¨ã®ELBã‚„PersistentVolumeç”¨ã®EBSã¯BOSHç®¡ç†å¤–ãªã®ã§ã€`kubectl`ã‚³ãƒãƒ³ãƒ‰ã§äº‹å‰ã«å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

```bash
bosh -d cfcr delete-deployment
bosh -n clean-up --all
```

#### BOSH Directorã®å‰Šé™¤

BOSH Directorã‚’æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§å‰Šé™¤ã—ã¾ã™ã€‚

```bash
eval "$(sed 's/create-env/delete-env/' deploy-bosh.sh)"
```

#### AWSç’°å¢ƒã®å‰Šé™¤

AWSç’°å¢ƒã‚’æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§å‰Šé™¤ã—ã¾ã™ã€‚

```bash
terraform destroy
```


### Pivotal Container Serviceã«ã¤ã„ã¦

CFCRã‚’ä½¿ãˆã°BOSHã‚’ç”¨ã„ã¦Kubernetesã‚’ç°¡å˜ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã€ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã€è‡ªå‹•å¾©æ—§ã‚‚å®¹æ˜“ã§ã™ã€‚
CFCRã¯OSSã§ã™ãŒã€ã“ã‚Œã®ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºç‰ˆã«ç›¸å½“ã™ã‚‹ã®ãŒ[Pivotal Container Service(PKS)](https://pivotal.io/platform/pivotal-container-service)ã§ã™ã€‚

PKSã§ã¯ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä¸€ã¤ä¸€ã¤æ‰‹ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ã§ã¯ãªãã€PKS Controllerã¨ã„ã†APIã‚µãƒ¼ãƒãƒ¼ãŒã“ã®è¨˜äº‹ã®å†…å®¹ã‚’å®Ÿè¡Œã—ã¦Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œæˆã—ã¦ãã‚Œã¾ã™ã€‚

PKSãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯

```
pks create-cluster my-k8s --external-hostname my-k8s.example.com --plan small --num-nodes 3
```

ã¨ã„ã†ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚Œã°ã€ã‚¯ãƒ©ã‚¹ã‚¿ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

æ¬¡ã®å›³ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![image](https://user-images.githubusercontent.com/106908/40376882-7350c66c-5e2a-11e8-81bb-a1f4209e078b.png)

CFCRã®Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã‚’ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã§ä½œæˆã™ã‚‹ã®ãŒPKSã§ã™ã€‚

ã‚ã¨ã¯CNIå®Ÿè£…ã¨ã—ã¦ã®[NSX-T](https://docs.vmware.com/jp/VMware-NSX-T/index.html)é€£æºã‚„[Habor](https://vmware.github.io/harbor/) Docker Registryé€£æºãªã©ã‚‚ã‚ã‚Šã¾ã™ã€‚
1.0ã§ã¯IaaSã¨ã—ã¦vSphereã¨GCPã®ã¿ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ãŒã€ä»–ã®IaaSã‚‚é †æ¬¡å¯¾å¿œäºˆå®šã§ã™ã€‚

ã“ã®ãƒ–ãƒ­ã‚°ã§ã‚‚ä»Šå¾ŒPKSã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ã¤ã„ã¦æ‰±ã„ãŸã„ã¨æ€ã„ã¾ã™ã€‚

èˆˆå‘³ã®ã‚ã‚‹æ–¹ã¯[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.pivotal.io/runtimes/pks/)ã‚’å‚ç…§ã—ã¤ã¤ã€[@making](https://twitter.com/making)ã«ã‚‚å£°ã‚’ã‹ã‘ã¦ã¿ã¦ãã ã•ã„ã€‚

