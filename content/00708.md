---
title: Tanzu Application Platform 1.2 (Full Profile) をAKSにインストールしAzure ADと連携するメモ - Self Signed編
tags: ["Kubernetes", "Cartographer", "AKS", "Tanzu", "TAP", "Knative", "Azure", "Backstage"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP"]
---

[Tanzu Application Platform 1.2](https://docs.vmware.com/en/Tanzu-Application-Platform/1.2/tap//GUID-overview.html) をAKSにインストールします。

本記事ではTAPをInstallし、"Hello World"なアプリケーションをソースコードからデプロイする機能("Source to URL")を試します。<br>
コンテナレジストリにはACRを使用し、RBACをAzure ADと連携します。<br>
また、Self Signedな証明書でHTTPSを有効にします。


**目次**
<!-- toc -->

### 必要なCLI

以下のCLIは事前にインストール済みとします。

* [kubectl](https://kubernetes.io/docs/tasks/tools/)
* [az](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)


### リソースグループ作成

```
az group create --name tap-rg --location japaneast
```

### ACRインスタンスの作成

今回はACRのadminアカウントを使用します。

```
ACR_NAME=tap${RANDOM}
az acr create --resource-group tap-rg \
  --name ${ACR_NAME} --sku standard \
  --admin-enabled true
```

```
ACR_SERVER=${ACR_NAME}.azurecr.io
ACR_USERNAME=${ACR_NAME}
ACR_PASSWORD=$(az acr credential show --name ${ACR_NAME} --resource-group tap-rg --query 'passwords[0].value' --output tsv)

docker login ${ACR_SERVER} -u ${ACR_USERNAME} -p ${ACR_PASSWORD}
```

### AKSクラスタの作成

AKSクラスタにはstandard_f4s_v2 (4 vCPU, 8GB Memory)のWorker Nodeを使用し、cluster-autoscalerを有効にしておきます。またAzure ADとの連携を有効にします。

```
az aks create \
  --resource-group tap-rg \
  --name tap-sandbox \
  --node-count 3 \
  --enable-cluster-autoscaler \
  --min-count 3 \
  --max-count 10 \
  --node-vm-size standard_f4s_v2 \
  --load-balancer-sku standard \
  --zones 1 2 3 \
  --generate-ssh-keys \
  --attach-acr ${ACR_NAME} \
  --enable-aad
```

TAPのインストールはadminアカウントで行います。

```
az aks get-credentials --resource-group tap-rg --name tap-sandbox --admin --overwrite-existing
```

### Pivnet CLIのインストール

ここでは [`pivnet`](https://github.com/pivotal-cf/pivnet-cli) CLIを使用して必要なソフトウェアをダウンロードします。
`pivnet` CLIはbrewでインストールできます。

```
brew install pivotal/tap/pivnet-cli
```

[VMware Tanzu Network](https://network.tanzu.vmware.com/) のAPI Tokenを取得して、`pivnet` CLIでログインします。

```
pivnet login --api-token=<API Token>
```

### EULAの承諾

初めてインストールする場合は、以下のコンポーネントのEULAをAcceptしてください。

* [Tanzu Application Platform](https://network.tanzu.vmware.com/products/tanzu-application-platform/)
* [Cluster Essentials for VMware Tanzu](https://network.tanzu.vmware.com/products/tanzu-cluster-essentials/)

> ⚠️ EULAで定められている使用期間は30日間です。とは言え、特にソフトウェア的に制限がかけられているわけではありません。


### Tanzu CLIのインストール

```
# For Mac
pivnet download-product-files --product-slug='tanzu-application-platform' --release-version='1.2.0' --glob='tanzu-framework-darwin-amd64.tar'
# For Linux
pivnet download-product-files --product-slug='tanzu-application-platform' --release-version='1.2.0' --glob='tanzu-framework-linux-amd64.tar'
# For Windows
pivnet download-product-files --product-slug='tanzu-application-platform' --release-version='1.2.0' --glob='tanzu-framework-windows-amd64.zip'
```

```
tar xvf tanzu-framework-*-amd64.tar
install cli/core/v0.11.6/tanzu-core-*_amd64 /usr/local/bin/tanzu
export TANZU_CLI_NO_INIT=true
```

```
$ tanzu version
version: v0.11.6
buildDate: 2022-05-20
sha: 90440e2b
```

プラグインのインストール

```
tanzu plugin install --local cli all
```

### Cluster Essentials for VMware Tanzuのインストール

TAPのインストールに必要なKapp ControllerとSecretgen Controllerをデプロイするために [Cluster Essentials for VMware Tanzu](https://network.tanzu.vmware.com/products/tanzu-cluster-essentials/#/releases/1130414) をインストールします。

```
# Mac
pivnet download-product-files --product-slug='tanzu-cluster-essentials' --release-version='1.2.0' --glob='tanzu-cluster-essentials-darwin-amd64-*'
# Linux
pivnet download-product-files --product-slug='tanzu-cluster-essentials' --release-version='1.2.0' --glob='tanzu-cluster-essentials-linux-amd64-*'
```

```yaml
TANZUNET_USERNAME=...
TANZUNET_PASSWORD=...

mkdir tanzu-cluster-essentials
tar xzvf tanzu-cluster-essentials-*-amd64-*.tgz -C tanzu-cluster-essentials

export INSTALL_BUNDLE=registry.tanzu.vmware.com/tanzu-cluster-essentials/cluster-essentials-bundle:1.2.0
export INSTALL_REGISTRY_HOSTNAME=registry.tanzu.vmware.com
export INSTALL_REGISTRY_USERNAME=${TANZUNET_USERNAME}
export INSTALL_REGISTRY_PASSWORD=${TANZUNET_PASSWORD}
cd tanzu-cluster-essentials
./install.sh --yes
cd ..
```

### Tanzu Application Platformのインストール


#### TAP用Package Repositoryの登録

```
TANZUNET_USERNAME=...
TANZUNET_PASSWORD=...

kubectl create ns tap-install

tanzu secret registry add tap-registry \
  --username "${TANZUNET_USERNAME}" \
  --password "${TANZUNET_PASSWORD}" \
  --server registry.tanzu.vmware.com \
  --export-to-all-namespaces \
  --yes \
  --namespace tap-install

tanzu package repository add tanzu-tap-repository \
  --url registry.tanzu.vmware.com/tanzu-application-platform/tap-packages:1.2.0 \
  --namespace tap-install
```


```
$ tanzu package available list --namespace tap-install
- Retrieving available packages... 
  NAME                                                 DISPLAY-NAME                                                              SHORT-DESCRIPTION                                                                                                                                              LATEST-VERSION  
  accelerator.apps.tanzu.vmware.com                    Application Accelerator for VMware Tanzu                                  Used to create new projects and configurations.                                                                                                                1.2.1           
  api-portal.tanzu.vmware.com                          API portal                                                                A unified user interface to enable search, discovery and try-out of API endpoints at ease.                                                                     1.0.21          
  backend.appliveview.tanzu.vmware.com                 Application Live View for VMware Tanzu                                    App for monitoring and troubleshooting running apps                                                                                                            1.2.0           
  build.appliveview.tanzu.vmware.com                   Application Live View Conventions for VMware Tanzu                        Application Live View convention server                                                                                                                        1.0.2           
  buildservice.tanzu.vmware.com                        Tanzu Build Service                                                       Tanzu Build Service enables the building and automation of containerized software workflows securely and at scale.                                             1.6.0           
  cartographer.tanzu.vmware.com                        Cartographer                                                              Kubernetes native Supply Chain Choreographer.                                                                                                                  0.4.2           
  cnrs.tanzu.vmware.com                                Cloud Native Runtimes                                                     Cloud Native Runtimes is a serverless runtime based on Knative                                                                                                 1.3.0           
  connector.appliveview.tanzu.vmware.com               Application Live View Connector for VMware Tanzu                          App for discovering and registering running apps                                                                                                               1.2.0           
  controller.conventions.apps.tanzu.vmware.com         Convention Service for VMware Tanzu                                       Convention Service enables app operators to consistently apply desired runtime configurations to fleets of workloads.                                          0.7.0           
  controller.source.apps.tanzu.vmware.com              Tanzu Source Controller                                                   Tanzu Source Controller enables workload create/update from source code.                                                                                       0.4.1           
  conventions.appliveview.tanzu.vmware.com             Application Live View Conventions for VMware Tanzu                        Application Live View convention server                                                                                                                        1.2.0           
  developer-conventions.tanzu.vmware.com               Tanzu App Platform Developer Conventions                                  Developer Conventions                                                                                                                                          0.7.0           
  fluxcd.source.controller.tanzu.vmware.com            Flux Source Controller                                                    The source-controller is a Kubernetes operator, specialised in artifacts acquisition from external sources such as Git, Helm repositories and S3 buckets.      0.16.4          
  grype.scanning.apps.tanzu.vmware.com                 Grype for Supply Chain Security Tools - Scan                              Default scan templates using Anchore Grype                                                                                                                     1.2.2           
  image-policy-webhook.signing.apps.tanzu.vmware.com   Image Policy Webhook                                                      Image Policy Webhook enables defining of a policy to restrict unsigned container images.                                                                       1.1.3           
  learningcenter.tanzu.vmware.com                      Learning Center for Tanzu Application Platform                            Guided technical workshops                                                                                                                                     0.2.1           
  metadata-store.apps.tanzu.vmware.com                 Supply Chain Security Tools - Store                                       Post SBoMs and query for image, package, and vulnerability metadata.                                                                                           1.2.2           
  ootb-delivery-basic.tanzu.vmware.com                 Tanzu App Platform Out of The Box Delivery Basic                          Out of The Box Delivery Basic.                                                                                                                                 0.8.0-build.4   
  ootb-supply-chain-basic.tanzu.vmware.com             Tanzu App Platform Out of The Box Supply Chain Basic                      Out of The Box Supply Chain Basic.                                                                                                                             0.8.0-build.4   
  ootb-supply-chain-testing-scanning.tanzu.vmware.com  Tanzu App Platform Out of The Box Supply Chain with Testing and Scanning  Out of The Box Supply Chain with Testing and Scanning.                                                                                                         0.8.0-build.4   
  ootb-supply-chain-testing.tanzu.vmware.com           Tanzu App Platform Out of The Box Supply Chain with Testing               Out of The Box Supply Chain with Testing.                                                                                                                      0.8.0-build.4   
  ootb-templates.tanzu.vmware.com                      Tanzu App Platform Out of The Box Templates                               Out of The Box Templates.                                                                                                                                      0.8.0-build.4   
  policy.apps.tanzu.vmware.com                         Supply Chain Security Tools - Policy Controller                           Policy Controller enables defining of a policy to restrict unsigned container images.                                                                          1.0.1           
  scanning.apps.tanzu.vmware.com                       Supply Chain Security Tools - Scan                                        Scan for vulnerabilities and enforce policies directly within Kubernetes native Supply Chains.                                                                 1.2.2           
  service-bindings.labs.vmware.com                     Service Bindings for Kubernetes                                           Service Bindings for Kubernetes implements the Service Binding Specification.                                                                                  0.7.2           
  services-toolkit.tanzu.vmware.com                    Services Toolkit                                                          The Services Toolkit enables the management, lifecycle, discoverability and connectivity of Service Resources (databases, message queues, DNS records, etc.).  0.7.1           
  snyk.scanning.apps.tanzu.vmware.com                  Snyk for Supply Chain Security Tools - Scan                               Default scan templates using Snyk                                                                                                                              1.0.0-beta.2    
  spring-boot-conventions.tanzu.vmware.com             Tanzu Spring Boot Conventions Server                                      Default Spring Boot convention server.                                                                                                                         0.4.1           
  sso.apps.tanzu.vmware.com                            AppSSO                                                                    Application Single Sign-On for Tanzu                                                                                                                           1.0.0           
  tap-auth.tanzu.vmware.com                            Default roles for Tanzu Application Platform                              Default roles for Tanzu Application Platform                                                                                                                   1.0.1           
  tap-gui.tanzu.vmware.com                             Tanzu Application Platform GUI                                            web app graphical user interface for Tanzu Application Platform                                                                                                1.2.3           
  tap-telemetry.tanzu.vmware.com                       Telemetry Collector for Tanzu Application Platform                        Tanzu Application Plaform Telemetry                                                                                                                            0.2.0           
  tap.tanzu.vmware.com                                 Tanzu Application Platform                                                Package to install a set of TAP components to get you started based on your use case.                                                                          1.2.0           
  tekton.tanzu.vmware.com                              Tekton Pipelines                                                          Tekton Pipelines is a framework for creating CI/CD systems.                                                                                                    0.33.5          
  workshops.learningcenter.tanzu.vmware.com            Workshop Building Tutorial                                                Workshop Building Tutorial                                                                                                                                     0.2.1  
```

#### Full Profileのインストール

TAPをインストールするための`tap-values.yml`を作成します。
`cnrs.domain_name`には仮のドメインを指定します。あとでenvoyのExternal IPが設定されてから変更します。

Learning Centerは使用しないため、またgrypeは個別にインストールした方良いため([こちらの記事](https://ik.am/entries/698)参照)、 これらのパッケージは`excluded_packages`除外します。
また、Cloud Native RuntimesはKnative Servingしか使わないので、それ以外のリソースを削除するoverlayを設定します。

```yaml
cat <<EOF > tap-values.yml
profile: full

ceip_policy_disclosed: true

cnrs:
  domain_name: tap.example.com  
  domain_template: "{{.Name}}-{{.Namespace}}.{{.Domain}}"
  default_tls_secret: tanzu-system-ingress/cnrs-default-tls

buildservice:
  kp_default_repository: ${ACR_SERVER}/build-service
  kp_default_repository_username: ${ACR_USERNAME}
  kp_default_repository_password: ${ACR_PASSWORD}

supply_chain: basic

ootb_supply_chain_basic:
  registry:
    server: ${ACR_SERVER}
    repository: supply-chain
  gitops:
    ssh_secret: git-ssh

contour:
  infrastructure_provider: azure
  envoy:
    service:
      type: LoadBalancer
      externalTrafficPolicy: Local
      annotations: {}

tap_gui:
  ingressEnabled: true
  ingressDomain: tap.example.com  
  service_type: ClusterIP
  tls:
    secretName: cnrs-default-tls
    namespace: tanzu-system-ingress
  app_config:
    app:
      baseUrl: https://tap-gui.tap.example.com
    backend:
      baseUrl: https://tap-gui.tap.example.com
      cors:
        origin: https://tap-gui.tap.example.com
    catalog:
      locations:
      - type: url
        target: https://github.com/sample-accelerators/tanzu-java-web-app/blob/main/catalog/catalog-info.yaml
      - type: url
        target: https://github.com/sample-accelerators/spring-petclinic/blob/accelerator/catalog/catalog-info.yaml
      - type: url
        target: https://github.com/tanzu-japan/spring-music/blob/tanzu/catalog/catalog-info.yaml

accelerator:
  domain: tap.example.com  
  ingress:
    include: true
    enable_tls: true
  tls:
    secret_name: cnrs-default-tls
    namespace: tanzu-system-ingress
  server:
    service_type: ClusterIP

metadata_store:
  app_service_type: ClusterIP
  ingress_enabled: "true"
  ingress_domain: tap.example.com

scanning:
  metadataStore:
    url: "" # Disable embedded integration since it's deprecated

package_overlays:
- name: cnrs
  secrets:
  - name: cnrs-default-tls
  - name: cnrs-slim
- name: metadata-store
  secrets:
  - name: metadata-store-ingress-tls

excluded_packages:
- grype.scanning.apps.tanzu.vmware.com
- learningcenter.tanzu.vmware.com
- workshops.learningcenter.tanzu.vmware.com
EOF
```

> ℹ️ LoadBalacerに関する[annotations](https://docs.microsoft.com/en-us/azure/aks/load-balancer-standard#additional-customizations-via-kubernetes-annotations)は`contour.envoy.service.annotations`に指定可能です。

Cloud Native Runtimesで使用するデフォルトのTLS証明書を用意するための次の定義をoverlayで作成します。以下のドキュメントを参考にしました。

* https://docs.vmware.com/en/Cloud-Native-Runtimes-for-VMware-Tanzu/1.1/tanzu-cloud-native-runtimes-1-1/GUID-external_dns.html
* https://knative.dev/docs/serving/using-a-tls-cert/#manually-adding-a-tls-certificate

```yaml
cat <<EOF > cnrs-default-tls.yml
#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")
#@ namespace = data.values.ingress.external.namespace
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: cnrs-selfsigned-issuer
  namespace: #@ namespace
spec:
  selfSigned: { }
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: cnrs-ca
  namespace: #@ namespace
spec:
  commonName: cnrs-ca
  isCA: true
  issuerRef:
    kind: Issuer
    name: cnrs-selfsigned-issuer
  secretName: cnrs-ca
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: cnrs-ca-issuer
  namespace: #@ namespace
spec:
  ca:
    secretName: cnrs-ca
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: cnrs-default-tls
  namespace: #@ namespace
spec:
  dnsNames:
  - #@ "*.{}".format(data.values.domain_name)
  issuerRef:
    kind: Issuer
    name: cnrs-ca-issuer
  secretName: cnrs-default-tls
---
apiVersion: projectcontour.io/v1
kind: TLSCertificateDelegation
metadata:
  name: contour-delegation
  namespace: #@ namespace
spec:
  delegations:
  - secretName: cnrs-default-tls
    targetNamespaces:
    - "*"
#@overlay/match by=overlay.subset({"metadata":{"name":"config-network"}, "kind": "ConfigMap"})
---
data:
  #@overlay/match missing_ok=True
  default-external-scheme: https
EOF
```

Cloud Native RuntimesからKnative Serving以外のリソースを削除するoverlayを作成します。

```yaml
cat <<EOF > cnrs-slim.yml
#@ load("@ytt:overlay", "overlay")
#@overlay/match by=overlay.subset({"metadata":{"namespace":"knative-eventing"}}), expects="1+"
#@overlay/remove
---
#@overlay/match by=overlay.subset({"metadata":{"namespace":"knative-sources"}}), expects="1+"
#@overlay/remove
---
#@overlay/match by=overlay.subset({"metadata":{"namespace":"triggermesh"}}), expects="1+"
#@overlay/remove
---
#@overlay/match by=overlay.subset({"metadata":{"namespace":"vmware-sources"}}), expects="1+"
#@overlay/remove
---
EOF
```

Metadata StoreにCloud Native RuntimesのデフォルトのTLS証明書を使うoverlayを作成します。

```yaml
cat <<EOF > metadata-store-ingress-tls.yml
#@ load("@ytt:overlay", "overlay")
#@overlay/match by=overlay.subset({"metadata":{"name":"metadata-store-ingress"}, "kind": "HTTPProxy"})
---
spec:
  virtualhost:
    tls:
      secretName: tanzu-system-ingress/cnrs-default-tls
#@overlay/match by=overlay.subset({"metadata":{"name":"ingress-cert"}, "kind": "Certificate"})
#@overlay/remove
---
EOF
```

overlayファイルをSecretとして作成します。

```
kubectl -n tap-install create secret generic cnrs-default-tls \
  -o yaml \
  --dry-run=client \
  --from-file=cnrs-default-tls.yml \
  | kubectl apply -f-

kubectl -n tap-install create secret generic cnrs-slim \
  -o yaml \
  --dry-run=client \
  --from-file=cnrs-slim.yml \
  | kubectl apply -f-

kubectl -n tap-install create secret generic metadata-store-ingress-tls \
  -o yaml \
  --dry-run=client \
  --from-file=metadata-store-ingress-tls.yml \
  | kubectl apply -f-
```

TAPをインストールします。

```
tanzu package install tap -p tap.tanzu.vmware.com -v 1.2.0 --values-file tap-values.yml -n tap-install --poll-timeout 60m
```

インストールの進捗は次のコマンドで確認します。

```
watch kubectl get node,app,pod -A -owide
```

`tanzu package install`の方は途中で次のようなエラーが出るかもしれませんが、待っていれば `Reconcile succeeded` になるのでwatchで確認してください。Race Conditionかな？


```
Error: resource reconciliation failed: kapp: Error: waiting on reconcile packageinstall/appliveview-connector (packaging.carvel.dev/v1alpha1) namespace: tap-install:
  Finished unsuccessfully (Reconcile failed:  (message: Error (see .status.usefulErrorMessage for details))). Reconcile failed: Error (see .status.usefulErrorMessage for details)
Error: exit status 1
```

または

```
Error: resource reconciliation failed: kapp: Error: waiting on reconcile packageinstall/metadata-store (packaging.carvel.dev/v1alpha1) namespace: tap-install:
  Finished unsuccessfully (Reconcile failed:  (message: Error (see .status.usefulErrorMessage for details))). Reconcile failed: Error (see .status.usefulErrorMessage for details)
Error: exit status 1
```

全てのappが `Reconcile succeeded` になるまで待ちます。8分くらいかかります。

```
$ kubectl get app -n tap-install 
NAME                       DESCRIPTION           SINCE-DEPLOY   AGE
accelerator                Reconcile succeeded   4m39s          4m48s
api-portal                 Reconcile succeeded   8m13s          8m20s
appliveview                Reconcile succeeded   4m41s          4m48s
appliveview-connector      Reconcile succeeded   7m50s          8m20s
appliveview-conventions    Reconcile succeeded   5m11s          5m56s
appsso                     Reconcile succeeded   7m38s          7m45s
buildservice               Reconcile succeeded   8m4s           8m18s
cartographer               Reconcile succeeded   6m2s           7m43s
cert-manager               Reconcile succeeded   8m12s          8m21s
cnrs                       Reconcile succeeded   4m39s          4m48s
contour                    Reconcile succeeded   7m17s          7m45s
conventions-controller     Reconcile succeeded   7m19s          7m45s
developer-conventions      Reconcile succeeded   5m49s          5m57s
fluxcd-source-controller   Reconcile succeeded   8m12s          8m20s
image-policy-webhook       Reconcile succeeded   7m16s          7m44s
metadata-store             Reconcile succeeded   7m1s           7m44s
ootb-delivery-basic        Reconcile succeeded   4m14s          4m21s
ootb-supply-chain-basic    Reconcile succeeded   4m14s          4m21s
ootb-templates             Reconcile succeeded   4m30s          4m37s
policy-controller          Reconcile succeeded   6m56s          7m44s
scanning                   Reconcile succeeded   8m11s          8m20s
service-bindings           Reconcile succeeded   8m12s          8m19s
services-toolkit           Reconcile succeeded   8m13s          8m21s
source-controller          Reconcile succeeded   6m8s           7m43s
spring-boot-conventions    Reconcile succeeded   5m10s          5m55s
tap                        Reconcile succeeded   7m48s          8m29s
tap-auth                   Reconcile succeeded   8m2s           8m18s
tap-gui                    Reconcile succeeded   4m41s          4m48s
tap-telemetry              Reconcile succeeded   8m11s          8m19s
tekton-pipelines           Reconcile succeeded   8m13s          8m20s
```

インストールされたパッケージは次の通りです。

```
$ kubectl get packageinstall -n tap-install 
NAME                       PACKAGE NAME                                         PACKAGE VERSION   DESCRIPTION           AGE
accelerator                accelerator.apps.tanzu.vmware.com                    1.2.1             Reconcile succeeded   5m6s
api-portal                 api-portal.tanzu.vmware.com                          1.0.21            Reconcile succeeded   8m38s
appliveview                backend.appliveview.tanzu.vmware.com                 1.2.0             Reconcile succeeded   5m6s
appliveview-connector      connector.appliveview.tanzu.vmware.com               1.2.0             Reconcile succeeded   8m38s
appliveview-conventions    conventions.appliveview.tanzu.vmware.com             1.2.0             Reconcile succeeded   6m19s
appsso                     sso.apps.tanzu.vmware.com                            1.0.0             Reconcile succeeded   8m3s
buildservice               buildservice.tanzu.vmware.com                        1.6.0             Reconcile succeeded   8m38s
cartographer               cartographer.tanzu.vmware.com                        0.4.2             Reconcile succeeded   8m3s
cert-manager               cert-manager.tanzu.vmware.com                        1.5.3+tap.2       Reconcile succeeded   8m38s
cnrs                       cnrs.tanzu.vmware.com                                1.3.0             Reconcile succeeded   5m6s
contour                    contour.tanzu.vmware.com                             1.18.2+tap.2      Reconcile succeeded   8m3s
conventions-controller     controller.conventions.apps.tanzu.vmware.com         0.7.0             Reconcile succeeded   8m3s
developer-conventions      developer-conventions.tanzu.vmware.com               0.7.0             Reconcile succeeded   6m19s
fluxcd-source-controller   fluxcd.source.controller.tanzu.vmware.com            0.16.4            Reconcile succeeded   8m38s
image-policy-webhook       image-policy-webhook.signing.apps.tanzu.vmware.com   1.1.3             Reconcile succeeded   8m3s
metadata-store             metadata-store.apps.tanzu.vmware.com                 1.2.2             Reconcile succeeded   8m3s
ootb-delivery-basic        ootb-delivery-basic.tanzu.vmware.com                 0.8.0-build.4     Reconcile succeeded   4m40s
ootb-supply-chain-basic    ootb-supply-chain-basic.tanzu.vmware.com             0.8.0-build.4     Reconcile succeeded   4m40s
ootb-templates             ootb-templates.tanzu.vmware.com                      0.8.0-build.4     Reconcile succeeded   4m56s
policy-controller          policy.apps.tanzu.vmware.com                         1.0.1             Reconcile succeeded   8m3s
scanning                   scanning.apps.tanzu.vmware.com                       1.2.2             Reconcile succeeded   8m38s
service-bindings           service-bindings.labs.vmware.com                     0.7.2             Reconcile succeeded   8m38s
services-toolkit           services-toolkit.tanzu.vmware.com                    0.7.1             Reconcile succeeded   8m38s
source-controller          controller.source.apps.tanzu.vmware.com              0.4.1             Reconcile succeeded   8m3s
spring-boot-conventions    spring-boot-conventions.tanzu.vmware.com             0.4.1             Reconcile succeeded   6m19s
tap                        tap.tanzu.vmware.com                                 1.2.0             Reconcile succeeded   8m46s
tap-auth                   tap-auth.tanzu.vmware.com                            1.0.1             Reconcile succeeded   8m38s
tap-gui                    tap-gui.tanzu.vmware.com                             1.2.3             Reconcile succeeded   5m6s
tap-telemetry              tap-telemetry.tanzu.vmware.com                       0.2.0             Reconcile succeeded   8m38s
tekton-pipelines           tekton.tanzu.vmware.com                              0.33.5            Reconcile succeeded   8m38s
```

デプロイされたPodは次の通りです。

```
$ kubectl get pod -A
NAMESPACE                   NAME                                                          READY   STATUS    RESTARTS        AGE
accelerator-system          acc-engine-66447dc5f6-klxqf                                   1/1     Running   0               5m2s
accelerator-system          acc-server-64d86547d4-wnp66                                   1/1     Running   0               5m2s
accelerator-system          accelerator-controller-manager-5668f9f548-jm64b               1/1     Running   2 (4m12s ago)   5m4s
api-portal                  api-portal-server-58fcff9c4b-5v7q2                            1/1     Running   0               8m41s
app-live-view-connector     application-live-view-connector-dgn6n                         1/1     Running   0               8m14s
app-live-view-connector     application-live-view-connector-kcv7n                         1/1     Running   0               8m16s
app-live-view-connector     application-live-view-connector-pkbr7                         1/1     Running   0               8m14s
app-live-view-conventions   appliveview-webhook-56f45cd9b-bnhkz                           1/1     Running   0               5m39s
app-live-view               application-live-view-server-847f8df5b9-fkszk                 1/1     Running   0               5m8s
appsso                      operator-6997dc9c49-9x6wt                                     1/1     Running   0               8m3s
build-service               build-pod-image-fetcher-9rrv9                                 5/5     Running   0               8m19s
build-service               build-pod-image-fetcher-f5ztk                                 5/5     Running   0               8m19s
build-service               build-pod-image-fetcher-qnbzv                                 5/5     Running   0               8m21s
build-service               dependency-updater-controller-6b4dcdc48c-rfxnr                1/1     Running   0               8m21s
build-service               secret-syncer-controller-55969d798d-m4djk                     1/1     Running   0               8m23s
build-service               smart-warmer-image-fetcher-cbbr7                              2/2     Running   0               4m32s
build-service               smart-warmer-image-fetcher-prdbx                              2/2     Running   0               4m37s
build-service               smart-warmer-image-fetcher-qb6sc                              2/2     Running   0               4m47s
build-service               warmer-controller-5b4bc95bd6-mvj7q                            1/1     Running   0               8m23s
cartographer-system         cartographer-controller-b99c5b6c7-9lh5x                       1/1     Running   0               6m23s
cartographer-system         cartographer-conventions-controller-manager-6664c8cc5-6jkgm   1/1     Running   0               6m22s
cert-injection-webhook      cert-injection-webhook-db7f69645-7q86r                        1/1     Running   0               8m21s
cert-manager                cert-manager-855bfc6dcc-gwjzv                                 1/1     Running   0               8m25s
cert-manager                cert-manager-cainjector-55d4ff4f8c-lf75d                      1/1     Running   0               8m25s
cert-manager                cert-manager-webhook-64864cb598-khpwk                         1/1     Running   0               8m25s
conventions-system          conventions-controller-manager-78c5dbcb5d-m9dpk               1/1     Running   0               7m36s
cosign-system               policy-webhook-784874c44-d7pc8                                1/1     Running   0               7m14s
cosign-system               webhook-56d4d89d65-6n2lf                                      1/1     Running   0               7m14s
developer-conventions       webhook-548d4f7f67-gxb7c                                      1/1     Running   0               6m19s
flux-system                 source-controller-f587c959c-qbqwt                             1/1     Running   0               8m39s
image-policy-system         image-policy-controller-manager-78db9d94b4-z58cp              2/2     Running   0               7m39s
kapp-controller             kapp-controller-6b588c849f-t96k2                              2/2     Running   0               41m
knative-serving             activator-66b78ccfdd-jx8nr                                    1/1     Running   0               4m36s
knative-serving             activator-66b78ccfdd-n9wwl                                    1/1     Running   0               4m36s
knative-serving             activator-66b78ccfdd-tfnjr                                    1/1     Running   0               4m51s
knative-serving             autoscaler-59bd7b555c-2hp4j                                   1/1     Running   0               4m54s
knative-serving             autoscaler-hpa-7c464c97d9-5fw9d                               1/1     Running   0               4m53s
knative-serving             controller-58b7cc8b96-tqbdv                                   1/1     Running   0               4m53s
knative-serving             domain-mapping-75cb855867-j9hcm                               1/1     Running   0               4m52s
knative-serving             domainmapping-webhook-7ffc98687-8mpjq                         1/1     Running   0               4m51s
knative-serving             net-certmanager-controller-c5d7844df-f2slj                    1/1     Running   0               4m54s
knative-serving             net-certmanager-webhook-5f4b99b56f-9n9s4                      1/1     Running   0               4m53s
knative-serving             net-contour-controller-7fb9b4db7c-s2x5b                       1/1     Running   0               4m53s
knative-serving             webhook-7d55f96999-4vsvm                                      1/1     Running   0               4m39s
knative-serving             webhook-7d55f96999-wbcwq                                      1/1     Running   0               4m54s
kpack                       kpack-controller-5fc77ddb4d-rjl4g                             1/1     Running   0               8m21s
kpack                       kpack-webhook-94f4d5cc4-6lhds                                 1/1     Running   0               8m23s
kube-system                 azure-ip-masq-agent-8kz8l                                     1/1     Running   0               49m
kube-system                 azure-ip-masq-agent-g8mz6                                     1/1     Running   0               49m
kube-system                 azure-ip-masq-agent-xdqrl                                     1/1     Running   0               49m
kube-system                 cloud-node-manager-hhclm                                      1/1     Running   0               49m
kube-system                 cloud-node-manager-tt7xp                                      1/1     Running   0               49m
kube-system                 cloud-node-manager-ws7zh                                      1/1     Running   0               49m
kube-system                 coredns-autoscaler-7d56cd888-zgrmj                            1/1     Running   0               51m
kube-system                 coredns-dc97c5f55-9ptdl                                       1/1     Running   0               51m
kube-system                 coredns-dc97c5f55-v5qcp                                       1/1     Running   0               49m
kube-system                 csi-azuredisk-node-dxnvw                                      3/3     Running   0               49m
kube-system                 csi-azuredisk-node-mc5g5                                      3/3     Running   0               49m
kube-system                 csi-azuredisk-node-xfr44                                      3/3     Running   0               49m
kube-system                 csi-azurefile-node-9ghcp                                      3/3     Running   0               49m
kube-system                 csi-azurefile-node-m56r8                                      3/3     Running   0               49m
kube-system                 csi-azurefile-node-nx88x                                      3/3     Running   0               49m
kube-system                 konnectivity-agent-7758d8bd7c-46rtt                           1/1     Running   0               45m
kube-system                 konnectivity-agent-7758d8bd7c-rlp4n                           1/1     Running   0               44m
kube-system                 kube-proxy-n6mw8                                              1/1     Running   0               49m
kube-system                 kube-proxy-nxh9w                                              1/1     Running   0               49m
kube-system                 kube-proxy-pdmp2                                              1/1     Running   0               49m
kube-system                 metrics-server-64b66fbbc8-znhnb                               1/1     Running   0               51m
metadata-store              metadata-store-app-57f79879c5-7hwhm                           2/2     Running   0               7m25s
metadata-store              metadata-store-db-0                                           1/1     Running   0               7m25s
scan-link-system            scan-link-controller-manager-8564cf976f-jvbhp                 2/2     Running   0               8m32s
secretgen-controller        secretgen-controller-85fd64bc7-9pd4t                          1/1     Running   0               40m
service-bindings            manager-67b8f6fc94-cwldw                                      1/1     Running   0               8m36s
services-toolkit            resource-claims-apiserver-85b7599b4-m2jfr                     1/1     Running   0               8m37s
services-toolkit            services-toolkit-controller-manager-8594d7c5cc-xd45g          1/1     Running   0               8m37s
source-system               source-controller-manager-c9858f8c7-7j4cc                     1/1     Running   0               6m34s
spring-boot-convention      spring-boot-webhook-5564c46586-gl88d                          1/1     Running   0               5m39s
stacks-operator-system      controller-manager-64dc9c67cb-lj8vg                           1/1     Running   0               8m23s
tanzu-system-ingress        contour-7878c955df-c7lk7                                      1/1     Running   0               7m24s
tanzu-system-ingress        contour-7878c955df-wdrwn                                      1/1     Running   0               7m26s
tanzu-system-ingress        envoy-n7f9r                                                   2/2     Running   0               7m30s
tanzu-system-ingress        envoy-w949r                                                   2/2     Running   0               7m30s
tanzu-system-ingress        envoy-zw9vc                                                   2/2     Running   0               7m32s
tap-gui                     server-65fd6984c-jvsww                                        1/1     Running   0               5m7s
tap-telemetry               tap-telemetry-informer-68dc97f484-tf4tm                       1/1     Running   4 (5m19s ago)   8m39s
tekton-pipelines            tekton-pipelines-controller-7bb9c7f456-vmr57                  1/1     Running   0               8m37s
tekton-pipelines            tekton-pipelines-webhook-8687956cdc-nxqnf                     1/1     Running   0               8m37s
```

Build Serviceで使用されるClusterBuilderがACRに作成されていることを確認します。

```
$ kubectl get clusterbuilder
NAME      LATESTIMAGE                                                                                                                        READY
base      tap27664.azurecr.io/build-service:clusterbuilder-base@sha256:0bf26eeb5e39e072fe6db3cd54810f08fbe0bdbc8255c6bf0906d9fc3cb4ff3f      True
default   tap27664.azurecr.io/build-service:clusterbuilder-default@sha256:0bf26eeb5e39e072fe6db3cd54810f08fbe0bdbc8255c6bf0906d9fc3cb4ff3f   True
```

Envoyに設定されたExternal IPを使って、`cnrs.domain_name`を変更します。ドメイン名には[sslip.io](https://sslip.io)を使用します。
例えば、External IPが10.99.0.147の場合は`cnrs.domain_name`に*.10-99-0-147.sslip.ioを指定します。

次のコマンドで`tap-values.yml`を更新します。

```
sed -i.bak "s|tap.example.com|$(kubectl get -n tanzu-system-ingress svc envoy -ojsonpath='{.status.loadBalancer.ingress[0].ip}' | sed 's/\./-/g').sslip.io|g" tap-values.yml
```

TAPを更新します。

```
tanzu package installed update tap -n tap-install -v 1.2.0 -f tap-values.yml 
```

Default TLSのCertificateのDNS名が更新されたことを確認してください。少し時間がかかる場合があります。

```
$ kubectl get certificate -n tanzu-system-ingress cnrs-default-tls -ojsonpath='{.spec.dnsNames[0]}'
*.20-194-146-185.sslip.io
```

Ingress (Contour)経由でアクセスできるコンポーネントは次の通りです。

```
$ kubectl get httpproxy -A
NAMESPACE            NAME                     FQDN                                     TLS SECRET                              STATUS   STATUS DESCRIPTION
accelerator-system   accelerator              accelerator.20-194-146-185.sslip.io      tanzu-system-ingress/cnrs-default-tls   valid    Valid HTTPProxy
metadata-store       metadata-store-ingress   metadata-store.20-194-146-185.sslip.io   tanzu-system-ingress/cnrs-default-tls   valid    Valid HTTPProxy
tap-gui              tap-gui                  tap-gui.20-194-146-185.sslip.io          tanzu-system-ingress/cnrs-default-tls   valid    Valid HTTPProxy
```


### TAP GUIへのアクセス

TAP GUIへのホスト名は次のコマンドで確認できます。

```
$ kubectl get httpproxy -n tap-gui tap-gui -ojsonpath='{.spec.virtualhost.fqdn}'
tap-gui.20-194-146-185.sslip.io
```

このホスト名へHTTPSでアクセスします。

> ⚠️ `cnrs.domain_name`の設定変更後TAP-GUIのPodが再作成されるので、再作成後にアクセスしてください。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178155402-034c3928-1dce-4257-8e0c-a5e979e366e1.png">

自己署名証明書を使用しているので"THIS IS UNSAFE"を入力してください。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178155454-d6515909-27d8-4da0-8caf-20b7f2a5dc91.png">

TAP GUIの認証設定を行っていないので、Guest Userでログインします。後ほどAzure ADでログインできるようにします。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178155490-cb805f53-667c-481d-97e6-abec3e04adbc.png">

"YOUR ORGANIZATION"の"All"をクリックします。

インストール時に設定したCatalogが登録されています。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178155533-3c2937f6-b76a-431d-801d-ce46295f77ff.png">

サイドバーの➕アイコンをクリックすると"Accelerators"一覧が表示されます。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/179791560-9d143ac3-a697-4df9-82fa-9a60e27bff43.png">

### ADグループの作成とメンバー追加

TAP Developer用のADグループを作成します。

```
GROUP_ID=$(az ad group create --display-name tap-demo-developer --mail-nickname tap-demo-developer --query id -o tsv)
```

自分のアカウント(ここでは`tmaki@pivotalazure.vmware.com`)をこのグループに追加します。

```
az ad group member add --group tap-demo-developer --member-id $(az ad user show --id tmaki@pivotalazure.vmware.com --query id -o tsv)
```

groupに追加されていることを確認します。

```
$ az ad group member list --group tap-demo-developer 
[
  {
    "@odata.type": "#microsoft.graph.user",
    "businessPhones": [],
    "displayName": "Toshiaki Maki",
    "givenName": "Toshiaki",
    "id": "********",
    "jobTitle": null,
    "mail": null,
    "mobilePhone": null,
    "officeLocation": null,
    "preferredLanguage": null,
    "surname": "Maki",
    "userPrincipalName": "tmaki@pivotalazure.vmware.com"
  }
]
```

`GROUP_ID`は次のコマンドでも取得できます。

```
GROUP_ID=$(az ad group list --filter "displayname eq 'tap-demo-developer'" --query '[0].id' -o tsv )
```

### Workloadのデプロイ

#### Workloadを作成するための事前準備

ここは引き続き、adminとして作業します。

```
az aks get-credentials --resource-group tap-rg --name tap-sandbox --admin --overwrite-existing
```

https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.2/tap/GUID-set-up-namespaces.html
(一部変更しています)

`demo` namespaceを作成します。

```
kubectl create ns demo
```

`demo` namespaceにおいた、先に作成したADグループに対して、[`app-editor`](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.1/tap/GUID-authn-authz-role-descriptions.html#appeditor-0) ClusterRoleをバインドします。

```
kubectl create rolebinding app-editor -n demo --clusterrole app-editor --group ${GROUP_ID}
kubectl create clusterrolebinding app-editor-${GROUP_ID} -n demo --clusterrole app-editor-cluster-access --group ${GROUP_ID}
```

ACRにアクセスするSecretを作成します。ここではadminアカウント使用しますが、[Service Principal](https://docs.microsoft.com/en-us/azure/container-registry/container-registry-authentication?tabs=azure-cli#service-principal)の方がいいかもしれません。

```
tanzu secret registry add registry-credentials --server ${ACR_SERVER} --username ${ACR_USERNAME} --password ${ACR_PASSWORD} --namespace demo
```

Service Accountの設定を行います。

```yaml
cat <<EOF | kubectl -n demo apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: tap-registry
  annotations:
    secretgen.carvel.dev/image-pull-secret: ""
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: e30K
---
apiVersion: v1
kind: Secret
metadata:
  name: git-ssh
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: default
secrets:
- name: registry-credentials
- name: git-ssh
imagePullSecrets:
- name: registry-credentials
- name: tap-registry
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: default-permit-deliverable
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: deliverable
subjects:
- kind: ServiceAccount
  name: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: default-permit-workload
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: workload
subjects:
- kind: ServiceAccount
  name: default
EOF
```

#### Developerとしてログイン

ここでDeveloperとしてk8sにログインします。

```
az aks get-credentials --resource-group tap-rg --name tap-sandbox --overwrite-existing
```

K8sクラスタへ初回アクセスのタイミングでAzureへのログインを求められます。<br>
`default` namespaceに対するPodのRead権限はないので、`kubectl get pod`はForbiddenになります。

```
$ kubectl get pod
To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code AJ9MVQ438 to authenticate.
Error from server (Forbidden): pods is forbidden: User "tmaki@pivotalazure.vmware.com" cannot list resource "pods" in API group "" in the namespace "default"
```


`demo` namespaceはPod一覧を取得できます。
```
$ kubectl get pod -n demo
No resources found in demo namespace.
```

#### Javaアプリのデプロイ

```
tanzu apps workload apply spring-music \
  --app spring-music \
  --git-repo https://github.com/scottfrederick/spring-music \
  --git-branch tanzu \
  --type web \
  --annotation autoscaling.knative.dev/minScale=1 \
  -n demo \
  -y
tanzu apps workload tail spring-music -n demo   
```

作成されるリソースを確認したければ次のコマンドをwatchしてください。

```
watch kubectl get workload,pod,gitrepo,imgs,build,podintent,taskrun,imagerepository,deliverable,app,ksvc -n demo -owide
```

```
$ kubectl get workload,pod,gitrepo,imgs,build,podintent,taskrun,imagerepository,app,ksvc -n demo -owide 

NAME                              SOURCE                                           SUPPLYCHAIN     READY   REASON   AGE
workload.carto.run/spring-music   https://github.com/scottfrederick/spring-music   source-to-url   True    Ready    4m57s

NAME                                                 READY   STATUS      RESTARTS   AGE     IP            NODE                                NOMINATED NODE   READINESS GATES
pod/spring-music-00001-deployment-6fd554c768-vwlnm   2/2     Running     0          46s     10.244.0.66   aks-nodepool1-13103931-vmss000000   <none>           <none>
pod/spring-music-build-1-build-pod                   0/1     Completed   0          4m50s   10.244.1.54   aks-nodepool1-13103931-vmss000002   <none>           <none>
pod/spring-music-config-writer-4g7cs-pod             0/1     Completed   0          91s     10.244.0.65   aks-nodepool1-13103931-vmss000000   <none>           <none>

NAME                                                  URL                                              READY   STATUS                                                             AGE
gitrepository.source.toolkit.fluxcd.io/spring-music   https://github.com/scottfrederick/spring-music   True    Fetched revision: tanzu/922a509361d1345984899cafeb34622ef7dd2086   4m54s

NAME                          LATESTIMAGE                                                                                                                  READY
image.kpack.io/spring-music   tap27664.azurecr.io/supply-chain/spring-music-demo@sha256:461c8e0c6dc3fec819a5dd7f88f2d28e4d861868f4bcc36caa45e64cfe3499ac   True

NAME                                  IMAGE                                                                                                                        SUCCEEDED
build.kpack.io/spring-music-build-1   tap27664.azurecr.io/supply-chain/spring-music-demo@sha256:461c8e0c6dc3fec819a5dd7f88f2d28e4d861868f4bcc36caa45e64cfe3499ac   True

NAME                                                       READY   REASON               AGE
podintent.conventions.apps.tanzu.vmware.com/spring-music   True    ConventionsApplied   97s

NAME                                                  SUCCEEDED   REASON      STARTTIME   COMPLETIONTIME
taskrun.tekton.dev/spring-music-config-writer-4g7cs   True        Succeeded   91s         84s

NAME                                                                 IMAGE                                                                                            URL                                                                                                                                                                                                     READY   REASON   AGE
imagerepository.source.apps.tanzu.vmware.com/spring-music-delivery   tap27664.azurecr.io/supply-chain/spring-music-demo-bundle:40f8ccc1-1b84-4467-b7c5-223edf7135fc   http://source-controller-manager-artifact-service.source-system.svc.cluster.local./imagerepository/demo/spring-music-delivery/083cd2d2646cacfb6225517eecf97e013b7b926c0a78cc630adde024078fb964.tar.gz   True    Ready    4m51s

NAME                                 SOURCE                                                                                           DELIVERY         READY   REASON   AGE
deliverable.carto.run/spring-music   tap27664.azurecr.io/supply-chain/spring-music-demo-bundle:40f8ccc1-1b84-4467-b7c5-223edf7135fc   delivery-basic   True    Ready    4m54s

NAME                                DESCRIPTION           SINCE-DEPLOY   AGE
app.kappctrl.k14s.io/spring-music   Reconcile succeeded   46s            47s

NAME                                       URL                                                 LATESTCREATED        LATESTREADY          READY   REASON
service.serving.knative.dev/spring-music   https://spring-music-demo.20-194-146-185.sslip.io   spring-music-00001   spring-music-00001   True 
```

```
$ tanzu apps workload get -n demo spring-music
---
# spring-music: Ready
---
Source
type:     git
url:      https://github.com/scottfrederick/spring-music
branch:   tanzu

Supply Chain
name:          source-to-url
last update:   95s
ready:         True

RESOURCE          READY   TIME
source-provider   True    5m7s
deliverable       True    5m10s
image-builder     True    113s
config-provider   True    110s
app-config        True    110s
config-writer     True    95s

Issues
No issues reported.

Pods
NAME                                             STATUS      RESTARTS   AGE
spring-music-00001-deployment-6fd554c768-vwlnm   Running     0          62s
spring-music-build-1-build-pod                   Succeeded   0          5m6s
spring-music-config-writer-4g7cs-pod             Succeeded   0          107s

Knative Services
NAME           READY   URL
spring-music   Ready   https://spring-music-demo.20-194-146-185.sslip.io

To see logs: "tanzu apps workload tail spring-music --namespace demo"
```

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178102885-9611f1fa-d763-4293-886c-a229035a2bb8.png">

"THIS IS UNSAFE"を入力

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178102908-a0e13915-8636-4885-bd64-3c3244f05450.png">

TAP GUIでSpring Musicの情報を見ることができます。

TAP GUIのCatalogからSpring Musicを選択。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/179800258-fb3dbb07-adb5-49fc-b942-c4cfc9196665.png">

Podを選択。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178221579-21c06bc4-9220-4f5d-98b4-b7cb419a70b7.png">

> ⚠️ `Access error when querying cluster 'host' for resource '/apis/source.apps.tanzu.vmware.com/v1alpha1/mavenartifacts' (status: 403). Contact your administrator.` が表示されるのはバグです。<br>
> 1.2.1で修正されるかもしれませんが、以下のoverlayを適用することでfixすることができます。
> 
> ```yaml
> cat <<EOF > tap-gui-permit-mavenartifacts-read.yml
> #@ load("@ytt:overlay", "overlay")
> #@overlay/match by=overlay.subset({"kind": "ClusterRole", "metadata": {"name": "k8s-reader"}}), expects="1+"
> ---
> rules:
>   #@overlay/match by=overlay.subset({"apiGroups": ["source.apps.tanzu.vmware.com"]})
>   - resources:
>     - mavenartifacts
> EOF
> ```
> 
> overlayをSecretに登録します。
> 
> ```
> kubectl -n tap-install create secret generic tap-gui-permit-mavenartifacts-read \
>   -o yaml \
>   --dry-run=client \
>   --from-file=tap-gui-permit-mavenartifacts-read.yml \
>   | kubectl apply -f-
> ```
> 
> `tap-values.yml`の`package_overlays`に以下の設定を追加します。
> 
> ```yaml
> # ...
> package_overlays:
> # ...
> - name: tap-gui
>   secrets:
>   - name: tap-gui-permit-mavenartifacts-read
> ```
>
> 次のコマンドでTAPを更新します。
>
> ```
> tanzu package installed update tap -n tap-install -v 1.2.0 -f tap-values.yml 
> ```

Live Viewが見られます。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/179815701-fcebe435-ffdb-415b-95ca-eab13d4b03ef.png">

Spring Boot Actuatorのエンドポイントを選択できます。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178221958-f56263a9-e74c-46bb-bd7c-b7b11c3fd559.png">

Memoryを選んだ場合、

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/179816084-febc36d7-add8-4f5f-9708-255c0ccb36c8.png">

> ⚠️ AdBlockをインストールしている場合は、TAP GUIでは無効化してください。

TAP 1.2からはPod Logsも見れるようになりました。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/179816217-101d4e20-5e85-4e31-9023-37ea38ae6155.png">

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/179816377-4fcc96c1-2990-4143-a65b-e7e7d92abdf6.png">

ActuatorによるLog Levelの変更もここから行えます。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/179816450-21e8068e-267e-4590-aea7-55853a886bdd.png">


次に、サイドバーから"Workloads"を選択します。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/179816790-e928930c-cc62-4915-8031-2ccac27469cc.png">

Spring Musicを選択すると、Supply Chainの状態を確認することができます。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/179817093-681ac630-7323-45bf-8d89-17585caecfb9.png">

Image Buildのログが見れるようになる等、TAP 1.2で様々な改善が行われています。詳細は[リリースノート](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.2/tap/GUID-release-notes.html#new-features-1)を確認してください。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/179817166-cab9e77c-4196-4c0c-98b7-18b76f3b1b4d.png">

確認が終わればWorkloadを削除します。

```
tanzu apps workload delete -n demo spring-music -y
```

### Azure ADでTAP GUIにログインする

TAP GUIの認証にAzure ADを使用するには、[Backstageのドキュメント](https://backstage.io/docs/auth/microsoft/provider)の手順通り、
App Registrationを作成します。次の通りです。

> 1. Log in to the [Azure Portal](https://portal.azure.com/)
> 2. Create an [Active Directory Tenant](https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview), if one does not yet exist
> 3. Navigate to [Azure Active Directory > App Registrations](https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps)
> 4. Register an application 
>    * Name: TAP GUI
>    * Redirect URI: Web > https://tap-gui.20-194-146-185.sslip.io/api/auth/microsoft/handler/frame
> 5. Navigate to Certificates & secrets > New client secret to create a secret


clientSecretはSecret生成直後にコピーできます。

<img width="738" alt="image" src="https://user-images.githubusercontent.com/106908/178233132-706169fa-40c0-442e-b9f9-54d669cf0faa.png">

clientId、tenantIdはOverviewから確認できます。

<img width="988" alt="image" src="https://user-images.githubusercontent.com/106908/178233226-a90f8395-8e80-4ec0-9d61-3fbe46b9cc8d.png">

`tap-values.yml`にclientId、clientSecret、tenantIdを設定します。

```yaml
tap_gui:
  # ...
  app_config:
    # ...
    auth:
      environment: development
      providers:
        microsoft:
          development:
            clientId: ${AUTH_MICROSOFT_CLIENT_ID}
            clientSecret: ${AUTH_MICROSOFT_CLIENT_SECRET}
            tenantId: ${AUTH_MICROSOFT_TENANT_ID}
```

adminとして作業します。

```
az aks get-credentials --resource-group tap-rg --name tap-sandbox --admin --overwrite-existing
```

TAPを更新します。

```
tanzu package installed update tap -n tap-install -v 1.1.2 -f tap-values.yml 
```

TAP GUIが再作成されるまで次のコマンドで確認して待ってください。
```
watch kubectl get pod -n tap-gui
```

再起動後、TAP GUIにアクセスすれば、"Sign in with Azure OAuth"と表示されます。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/179818494-332d26ce-655f-4081-a73d-67b2da89d535.png">

DeveloperのアカウントでAzureにログインします。

<img width="562" alt="image" src="https://user-images.githubusercontent.com/106908/178231534-38640932-4f48-4676-ba29-af914f1b860a.png">

承諾します。

<img width="562" alt="image" src="https://user-images.githubusercontent.com/106908/178232397-203c4d0e-4650-438d-9c48-a5f8cd3de5a4.png">

ログインに成功し、サイドバーから"Settings"を確認すると、ログインユーザー名とメールアドレスが表示されることを確認できます。

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178233669-2185131c-1106-4e86-bad9-add8c69f445e.png">

### [Optional] Source Test Scan to URLを試す

TBD

TAP 1.1版は[こちら](/entries/698)ですが、1.2で変更があります。

### [Optional] ADユーザーの追加

[TAP 1.1版](/entries/704#%5BOptional%5D%20ADユーザーの追加)と同じです。

### TAPのアンインストール

```
kubectl delete workload -A --all
```

```
tanzu package installed delete tap -n tap-install -y
```

### AKSクラスタの削除

```
az aks delete \
  --resource-group tap-rg \
  --name tap-sandbox
```

### ACRインスタンスの削除

```
az acr delete --resource-group tap-rg --name ${ACR_NAME}
```

### リソースグループ削除

```
az group delete --name tap-rg
```