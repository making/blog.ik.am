---
title: Spring WebFlux.fnãƒãƒ³ã‚ºã‚ªãƒ³ - 8. Spring Bootã‚¢ãƒ—ãƒªã«å¤‰æ›
tags: ["Spring WebFlux.fn Handson", "Reactor", "Reactor Netty", "Netty", "Spring 5", "Spring WebFlux", "Spring Boot", "Java", "Cloud Foundry", "Pivotal Web Services", "Pivotal Cloud Foundry"]
categories: ["Programming", "Java", "org", "springframework", "web", "reactive"]
updated: 1970-01-01T09:00:00+09:00
---

æœ¬ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã€æ¬¡ã®å›³ã®ã‚ˆã†ãªç°¡æ˜“å®¶è¨ˆç°¿ã®APIã‚µãƒ¼ãƒãƒ¼ã‚’Spring WebFlux.fnã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¾ã™ã€‚
ã‚ãˆã¦Spring Bootã‚‚Dependency Injectionã‚‚ä½¿ã‚ãªã„ã‚·ãƒ³ãƒ—ãƒ«ãªWebã‚¢ãƒ—ãƒªã¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚

**ãƒãƒ³ã‚ºã‚ªãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„**

1. [ã¯ã˜ã‚ã«](/entries/500)
1. [ç°¡æ˜“å®¶è¨ˆç°¿Moneygerãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ](/entries/501)
1. [YAVIã«ã‚ˆã‚‹Validationã®å®Ÿè£…](/entries/502)
1. [R2DBCã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹](/entries/503)
1. [Web UIã®è¿½åŠ ](/entries/504)
1. [ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„](/entries/505)
1. [åå…¥APIã®å®Ÿè£…](/entries/506)
1. [Spring Bootã‚¢ãƒ—ãƒªã«å¤‰æ›](/entries/507) ğŸ‘ˆ
1. [GraalVMã®SubstrateVMã§Native Imageã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«](/entries/510)

ã“ã“ã¾ã§ã€Spring Bootã‚„Dependency Injectionã‚’æ•¢ãˆã¦ä½¿ã‚ãšå®Ÿè£…ã—ã¦ãã¾ã—ãŸã€‚Spring Bootã‚’ä½¿ã‚ãªãã¦ã‚‚(Small Footprintãª)ã‚¢ãƒ—ãƒªã¯ä½œã‚Œã‚‹ã¨ã„ã†ã“ã¨ã‚’ç¤ºã™ç›®çš„ã ã£ãŸã®ã§ã™ãŒã€
Spring Boot Actuatorã‚„ã“ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã§æ‰±ã‚ãªã‹ã£ãŸæ©Ÿèƒ½ã‚’Spring Bootã‚’ä½¿ã‚ãšã«å®Ÿè£…ã—ã¦ã„ãã®ã¯åŠ¹ç‡çš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ä»Šå¾Œã€Moneygerã‚’é–‹ç™ºã—ç¶šã‘ã¦ã„ãã®ã§ã‚ã‚Œã°Spring Boot Wayã«ä¹—ã£ãŸæ–¹ãŒç„¡é›£ã§ã—ã‚‡ã†ã€‚

ã“ã®ç« ã§ã¯ã“ã‚Œã¾ã§ä½œã£ãŸSpring Bootã‚¢ãƒ—ãƒªã«å¤‰æ›ã—ã¾ã™ã€‚

**ç›®æ¬¡**
<!-- toc -->


### pom.xmlã®æ›´æ–°

`pom.xml`ã«`spring-boot-starter-parent`ã‚’è¨­å®šã—ã¾ã™ã€‚

```xml
    <description>...</description>

    <!-- ã“ã“ã‹ã‚‰ -->
     <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.0.BUILD-SNAPSHOT</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <!-- ã“ã“ã¾ã§ -->

    <properties>
    <!-- ... -->
    </properties>
```

ä»£ã‚ã‚Šã«

`<dependenciesManagement>`ã®æ¬¡ã®ç®‡æ‰€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```xml
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-dependencies</artifactId>
                <version>${spring-boot.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
```

ã¾ãŸã€`<properties>` å†…ã®`<spring-boot.version>`ã‚‚å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚


æ¬¡ã«ã€`<dependencies>`å†…ã®ã€

``` xml
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-context</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-webflux</artifactId>
        </dependency>
        <dependency>
            <groupId>ch.qos.logback</groupId>
            <artifactId>logback-classic</artifactId>
        </dependency>
        <dependency>
            <groupId>io.projectreactor.netty</groupId>
            <artifactId>reactor-netty</artifactId>
            <exclusions>
                <exclusion>
                    <groupId>io.netty</groupId>
                    <artifactId>netty-transport-native-epoll</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>io.netty</groupId>
                    <artifactId>netty-transport-native-unix-common</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.datatype</groupId>
            <artifactId>jackson-datatype-jsr310</artifactId>
        </dependency>
```

ã‚’

```xml
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>
```

ã«ç½®æ›ã—ã¾ã™ã€‚


### Handlerã¨Repositoryã¸ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ä¸

`ExpenditureHandler`ãŠã‚ˆã³`IncomeHandler`ã«`@Component`ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ã¾ã™ã€‚


```java
import org.springframework.stereotype.Component;

// ...

@Component
public class ExpenditureHandler {
  // ...
}
```

`R2dbcExpenditureRepository`ãŠã‚ˆã³`R2dbcIncomeRepository`ã«`@Repository`ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

```java
import org.springframework.stereotype.Repository;
// ...

@Repository
public class R2dbcExpenditureRepository implements ExpenditureRepository {
  // ...
}
```

### App.javaã®Spring Boot ApplicationåŒ–ãŠã‚ˆã³Configã‚¯ãƒ©ã‚¹ã®ä½œæˆ

`App.ava`ã«å…¨ã¦ã®Configurationã‚’å®šç¾©ã—ã¾ã—ãŸãŒã€Spring Bootå¯¾å¿œã«ä¼´ã„ã€`App.java`ã¯æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã ã‘ã«ã—ã¾ã™ã€‚

```java
// ...
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class App {

    public static void main(String[] args) throws Exception {
        SpringApplication.run(App.class, args);
    }
}
```

Configurationã¯å¿…è¦ãªã‚‚ã®ã ã‘`com.example.config`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸é…ä¸‹ã«å®šç¾©ã—ã¾ã™ã€‚


* `src/main/java/com/example/config/RouteConfig.java`
* `src/main/java/com/example/config/R2dbcConfig.java`

ã®2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚


#### RouteConfigã®ä½œæˆ

`RouteConfig`ã«æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

```java
package com.example.config;

import com.example.expenditure.ExpenditureHandler;
import com.example.income.IncomeHandler;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.server.RouterFunction;
import org.springframework.web.reactive.function.server.ServerResponse;

@Configuration
public class RouteConfig {

    @Bean
    public RouterFunction<ServerResponse> routes(ExpenditureHandler expenditureHandler, IncomeHandler incomeHandler) {
        return expenditureHandler.routes()
            .and(incomeHandler.routes());
    }
}
```

åå…¥APIã‚’ä½œæˆã—ã¦ã„ãªã„å ´åˆã¯

```java
package com.example.config;

import com.example.expenditure.ExpenditureHandler;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.server.RouterFunction;
import org.springframework.web.reactive.function.server.ServerResponse;

@Configuration
public class RouteConfig {

    @Bean
    public RouterFunction<ServerResponse> routes(ExpenditureHandler expenditureHandler) {
        return expenditureHandler.routes();
    }
}
```

ã§è‰¯ã„ã§ã™ã€‚

`App.staticRoutes()`ã¨åŒç­‰ã®æ©Ÿèƒ½ã¯Spring Bootã‚ˆã‚Šæä¾›ã•ã‚Œã‚‹ãŸã‚å‰Šé™¤ã—ã¾ã—ãŸã€‚
ã¾ãŸ`App.handlerStrategies()`ã‚‚åŒã˜ãå‰Šé™¤ã—ã¾ã™ã€‚

`com.example.error.ErrorResponseExceptionHandler`ã‚‚ä½¿ã‚ãªã„ã®ã§å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

#### R2dbcConfigã®ä½œæˆ

`R2dbcConfig`ã«æ¬¡ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

```java
package com.example.config;

import io.r2dbc.pool.ConnectionPool;
import io.r2dbc.pool.ConnectionPoolConfiguration;
import io.r2dbc.spi.ConnectionFactories;
import io.r2dbc.spi.ConnectionFactory;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.r2dbc.connectionfactory.R2dbcTransactionManager;
import org.springframework.data.r2dbc.core.DatabaseClient;
import org.springframework.transaction.reactive.TransactionalOperator;
import reactor.core.publisher.Mono;

import java.time.Duration;
import java.util.Optional;

@Configuration
public class R2dbcConfig {

    @Bean
    public TransactionalOperator transactionalOperator(ConnectionFactory connectionFactory) {
        return TransactionalOperator.create(new R2dbcTransactionManager(connectionFactory));
    }

    @Bean
    public DatabaseClient databaseClient(ConnectionFactory connectionFactory) {
        final DatabaseClient databaseClient = DatabaseClient.builder()
            .connectionFactory(connectionFactory)
            .build();
        initializeDatabase(connectionFactory.getMetadata().getName(), databaseClient).subscribe();
        return databaseClient;
    }

    @Bean
    public ConnectionFactory connectionFactory() {
        // postgresql://username:password@hostname:5432/dbname
        String databaseUrl = Optional.ofNullable(System.getenv("DATABASE_URL")).orElse("h2:file:///./target/demo?options=DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE");
        return ConnectionFactories.get("r2dbc:" + databaseUrl);
    }

    @Bean
    public ConnectionPool connectionPool(ConnectionFactory connectionFactory) {
        return new ConnectionPool(ConnectionPoolConfiguration.builder(connectionFactory)
            .initialSize(4)
            .maxSize(4)
            .maxIdleTime(Duration.ofSeconds(3))
            .validationQuery("SELECT 1")
            .build());
    }

    public static Mono<Void> initializeDatabase(String name, DatabaseClient databaseClient) {
        if ("H2".equals(name)) {
            return databaseClient.execute("CREATE TABLE IF NOT EXISTS expenditure (expenditure_id INT PRIMARY KEY AUTO_INCREMENT, expenditure_name VARCHAR(255), unit_price INT NOT NULL, quantity INT NOT NULL, expenditure_date DATE NOT NULL)")
                .then()
                .then(databaseClient.execute("CREATE TABLE IF NOT EXISTS income (income_id INT PRIMARY KEY AUTO_INCREMENT, income_name VARCHAR(255), amount INT NOT NULL, income_date DATE NOT NULL)")
                    .then());
        } else if ("PostgreSQL".equals(name)) {
            return databaseClient.execute("CREATE TABLE IF NOT EXISTS expenditure (expenditure_id SERIAL PRIMARY KEY, expenditure_name VARCHAR(255), unit_price INT NOT NULL, quantity INT NOT NULL, expenditure_date DATE NOT NULL)")
                .then()
                .then(databaseClient.execute("CREATE TABLE IF NOT EXISTS income (income_id SERIAL PRIMARY KEY, income_name VARCHAR(255), amount INT NOT NULL, income_date DATE NOT NULL)")
                    .then());
        }
        return Mono.error(new IllegalStateException(name + " is not supported."));
    }
}
```

åå…¥APIã‚’ä½œæˆã—ã¦ã„ãªã„å ´åˆã¯

```java
package com.example.config;

import io.r2dbc.pool.ConnectionPool;
import io.r2dbc.pool.ConnectionPoolConfiguration;
import io.r2dbc.spi.ConnectionFactories;
import io.r2dbc.spi.ConnectionFactory;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.r2dbc.connectionfactory.R2dbcTransactionManager;
import org.springframework.data.r2dbc.core.DatabaseClient;
import org.springframework.transaction.reactive.TransactionalOperator;
import reactor.core.publisher.Mono;

import java.time.Duration;
import java.util.Optional;

@Configuration
public class R2dbcConfig {

    @Bean
    public TransactionalOperator transactionalOperator(ConnectionFactory connectionFactory) {
        return TransactionalOperator.create(new R2dbcTransactionManager(connectionFactory));
    }

    @Bean
    public DatabaseClient databaseClient(ConnectionFactory connectionFactory) {
        final DatabaseClient databaseClient = DatabaseClient.builder()
            .connectionFactory(connectionFactory)
            .build();
        initializeDatabase(connectionFactory.getMetadata().getName(), databaseClient).subscribe();
        return databaseClient;
    }

    @Bean
    public ConnectionFactory connectionFactory() {
        // postgresql://username:password@hostname:5432/dbname
        String databaseUrl = Optional.ofNullable(System.getenv("DATABASE_URL")).orElse("h2:file:///./target/demo?options=DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE");
        return ConnectionFactories.get("r2dbc:" + databaseUrl);
    }

    @Bean
    public ConnectionPool connectionPool(ConnectionFactory connectionFactory) {
        return new ConnectionPool(ConnectionPoolConfiguration.builder(connectionFactory)
            .initialSize(4)
            .maxSize(4)
            .maxIdleTime(Duration.ofSeconds(3))
            .validationQuery("SELECT 1")
            .build());
    }

    public static Mono<Void> initializeDatabase(String name, DatabaseClient databaseClient) {
        if ("H2".equals(name)) {
            return databaseClient.execute("CREATE TABLE IF NOT EXISTS expenditure (expenditure_id INT PRIMARY KEY AUTO_INCREMENT, expenditure_name VARCHAR(255), unit_price INT NOT NULL, quantity INT NOT NULL, expenditure_date DATE NOT NULL)")
                .then();
        } else if ("PostgreSQL".equals(name)) {
            return databaseClient.execute("CREATE TABLE IF NOT EXISTS expenditure (expenditure_id SERIAL PRIMARY KEY, expenditure_name VARCHAR(255), unit_price INT NOT NULL, quantity INT NOT NULL, expenditure_date DATE NOT NULL)")
                .then();
        }
        return Mono.error(new IllegalStateException(name + " is not supported."));
    }
}
```

ã§è‰¯ã„ã§ã™ã€‚


ã“ã®å¤‰æ›´ã«ä¼´ã„ã€

`R2dbcExpenditureRepositoryTest.java`ãŠã‚ˆã³`R2dbcIncomeRepositoryTest.java`ã®

```java
App.initializeDatabase("H2", this.databaseClient).block();
```

ã‚’

```java
R2dbcConfig.initializeDatabase("H2", this.databaseClient).block();
```

ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

ãªãŠã€[Spring Boot R2DBC Starter](https://github.com/spring-projects-experimental/spring-boot-r2dbc)ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã€ä»Šå¾Œã¯Spring Bootã«å–ã‚Šè¾¼ã¾ã‚Œã‚‹ã®ã§ã€`R2dbcConfig`ã®Beanå®šç¾©ã¯ä¸è¦ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£

ã“ã‚Œã¾ã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å†…ã§`App.handlerStrategies()`ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®WebFluxåŸºç›¤ã®è¨­å®šã¨ãƒ†ã‚¹ãƒˆå´ã®WebFluxåŸºç›¤ã®è¨­å®šã‚’åŒä¸€ã«ã—ã¦ã„ã¾ã—ãŸã€‚
Spring Bootå¯¾å¿œã«ä¼´ã„ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®WebFluxåŸºç›¤ã¯Spring Bootã‚ˆã‚Šæä¾›ã•ã‚Œã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆå´ã‚‚ã“ã‚Œã«åˆã‚ã›ã¾ã™ã€‚
`org.springframework.boot.test.autoconfigure.web.reactive.WebFluxTest`ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¨`WebTestClient.bindToApplicationContext`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã“ã¨ã§ã“ã‚Œã‚’å®Ÿç¾ã—ã¾ã™ã€‚


`ExpenditureHandlerTest`ã‚’æ¬¡ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚


```java
// ...

// ã“ã“ã‹ã‚‰è¿½åŠ 
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.reactive.WebFluxTest;
import org.springframework.context.ApplicationContext;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.Primary;
import org.springframework.web.reactive.function.server.RouterFunction;
// ã“ã“ã¾ã§è¿½åŠ 

// ...
// ã“ã“ã‹ã‚‰è¿½åŠ 
@WebFluxTest
@Import(ExpenditureHandler.class)
// ã“ã“ã¾ã§è¿½åŠ 
class ExpenditureHandlerTest {
    // ã“ã“ã‹ã‚‰è¿½åŠ 
    @Configuration
    static class Config {

        @Bean
        public RouterFunction<?> routes(ExpenditureHandler expenditureHandler) {
            return expenditureHandler.routes();
        }

        @Bean
        @Primary
        public ExpenditureRepository expenditureRepository() {
            return new InMemoryExpenditureRepository();
        }
    }

    @Autowired
    private ApplicationContext applicationContext;
    // ã“ã“ã¾ã§è¿½åŠ 
}
```


```java
    private InMemoryExpenditureRepository expenditureRepository = new InMemoryExpenditureRepository();
```

ã¯Beanå®šç¾©ã—ãŸã‚‚ã®ã‚’ä½¿ã†ã®ã§

```java
    @Autowired
    private InMemoryExpenditureRepository expenditureRepository;
```

æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã¯ä¸è¦ãªã®ã§å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚


```java
    private ExpenditureHandler expenditureHandler = new Expenditure(this.expenditureRepository);
```

æœ€å¾Œã«`WebTestClient`ã®ä½œæˆæ–¹æ³•ã‚’å¤‰æ›´ã—ã¾ã™ã€‚æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’

```java
        this.testClient = WebTestClient.bindToRouterFunction(this.expenditureHandler.routes())
            .handlerStrategies(App.handlerStrategies())
            // ...
```

æ¬¡ã®å†…å®¹ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```java
        this.testClient = WebTestClient.bindToApplicationContext(this.applicationContext)
        // ...
```

ä»¥ä¸Šã§ä¿®æ­£ã¯çµ‚äº†ã§ã™ã€‚`IncomeHandlerTest`ã‚‚åŒã˜ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

ä¿®æ­£ãŒçµ‚ã‚ã‚Œã°å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚




