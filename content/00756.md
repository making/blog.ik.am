---
title: Tanzu Application Platformã§type=serverã®Workloadã«å¯¾ã—ã¦Ingressã‚’ä½œã‚‹
tags: ["Kubernetes", "Cartographer", "kind", "Tanzu", "TAP", "Carvle"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP"]
---

Tanzu Application Platform (1.6æ™‚ç‚¹)ã§ã¯ã€[ã“ã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.6/tap/workloads-workload-types.html)ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€Out of the Box (OOTB) Supply Chainsã«ã¦ä»¥ä¸‹ã®Workload TypeãŒã‚µãƒãƒ¼ãƒˆã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚

* `type=web` ... ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æƒ³å®šã—ãŸã‚‚ã®ã€‚Knativeã®Serviceãƒªã‚½ãƒ¼ã‚¹ã‚’ãŒä½œæˆã•ã‚Œã‚‹ã€‚Scale to Zeroã€Zero to NãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹ã€‚
* `type=server` ... ãƒˆãƒ©ãƒ‡ã‚£ã‚·ãƒ§ãƒŠãƒ«ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æƒ³å®šã—ãŸã‚‚ã®ã€‚K8sæ¨™æº–ã®Deploymentã€Serviceãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã‚‹ã€‚
* `type=worker` ... ã‚­ãƒ¥ãƒ¼ã‚’å‡¦ç†ã™ã‚‹ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æƒ³å®šã—ãŸã‚‚ã®ã€‚K8sæ¨™æº–ã®DeploymentãŒä½œæˆã•ã‚Œã‚‹ã€‚


`type=server`ã§ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸå ´åˆã€Ingressã§ã‚¢ãƒ—ãƒªã‚’å…¬é–‹ã—ãŸã„å ´åˆã¯Ingressãƒªã‚½ãƒ¼ã‚¹ã‚’ä½•ã‹ã—ã‚‰ã®æ–¹æ³•ã§ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã®3ã¤ã®æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

* `kubectl`ã§ç›´æ¥Ingressãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹
* OOTB SupplyChainã§ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«Ingressã‚’è¿½åŠ ã™ã‚‹
* Carvel Package Supply Chainã‚’ä½¿ç”¨ã™ã‚‹

---

**ç›®æ¬¡**
<!-- toc -->

### `kubectl`ã§ç›´æ¥Ingressãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹

ã¾ãšã¯ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®Workloadã‚’ä½œæˆã—ã¾ã™ã€‚

```
tanzu apps workload apply hello-nodejs \
  --app hello-nodejs \
  --git-repo https://github.com/making/hello-nodejs \
  --git-branch master \
  --type server \
  -n demo
```

ã“ã®Workloadã‹ã‚‰ä½œæˆã•ã‚Œã‚‹ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã¾ã™ã€‚

```
kubectl get cm -n demo hello-nodejs-server -ojsonpath='{.data.delivery\.yml}'
```

æ¬¡ã®å‡ºåŠ›ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-nodejs
  annotations:
    kapp.k14s.io/update-strategy: fallback-on-replace
    ootb.apps.tanzu.vmware.com/servicebinding-workload: "true"
    kapp.k14s.io/change-rule: upsert after upserting servicebinding.io/ServiceBindings
  labels:
    app.kubernetes.io/part-of: hello-nodejs
    apps.tanzu.vmware.com/workload-type: server
    app.kubernetes.io/component: run
    carto.run/workload-name: hello-nodejs
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: run
      app.kubernetes.io/part-of: hello-nodejs
      apps.tanzu.vmware.com/workload-type: server
      carto.run/workload-name: hello-nodejs
  template:
    metadata:
      annotations:
        conventions.carto.run/applied-conventions: |-
          appliveview-sample/app-live-view-appflavour-check
          spring-boot-convention/auto-configure-actuators-check
          spring-boot-convention/app-live-view-appflavour-check
        developer.conventions/target-containers: workload
      labels:
        app.kubernetes.io/component: run
        app.kubernetes.io/part-of: hello-nodejs
        apps.tanzu.vmware.com/workload-type: server
        carto.run/workload-name: hello-nodejs
    spec:
      containers:
      - image: ghcr.io/making/workloads/hello-nodejs-demo@sha256:052ffee7966eeda9cf3a0d6a255f70b443ed0c39ab24591ab4b9ab857b30995b
        name: workload
        resources: {}
        securityContext:
          runAsUser: 1000
      serviceAccountName: default
---
apiVersion: v1
kind: Service
metadata:
  name: hello-nodejs
  labels:
    app.kubernetes.io/part-of: hello-nodejs
    apps.tanzu.vmware.com/workload-type: server
    app.kubernetes.io/component: run
    carto.run/workload-name: hello-nodejs
spec:
  selector:
    app.kubernetes.io/component: run
    app.kubernetes.io/part-of: hello-nodejs
    apps.tanzu.vmware.com/workload-type: server
    carto.run/workload-name: hello-nodejs
  ports:
  - targetPort: 8080
    port: 8080
    name: http
```

ã“ã®ã‚¢ãƒ—ãƒªã‚’ä¾‹ãˆã°ã€`hello-nodejs-demo.tap.192-168-228-200.sslip.io` ã§å…¬é–‹ã—ãŸã„å ´åˆ (envoyã®ExternalIPãŒ`192.168.228.201`ã§ã‚ã‚‹å‰æã§ã™)ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Ingressã‚’ä½œæˆã™ã‚Œã°è‰¯ã„ã§ã™ã€‚
TAPã®multi clusteræ§‹æˆã®å ´åˆã¯ã€Runã‚¯ãƒ©ã‚¹ã‚¿ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
ãŸã ã—ã€`app-editor`ã«ã¯**ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“**ã€‚`app-operator`ã§ã‚ã‚Œã°å®Ÿè¡Œå¯èƒ½ã§ã™ã€‚

* TLSã‚’ä½¿ç”¨ã—ãªã„å ´åˆ
```
kubectl create ingress hello-nodejs -n demo \
  --rule="hello-nodejs-demo.tap.192-168-228-200.sslip.io/*=hello-nodejs:8080"
```

```
$ curl -sv http://hello-nodejs-demo.tap.192-168-228-200.sslip.io
> GET / HTTP/1.1
> Host: hello-nodejs-demo.tap.192-168-228-200.sslip.io
> User-Agent: curl/8.1.2
> Accept: */*
> 
< HTTP/1.1 200 OK
< x-powered-by: Express
< content-type: text/html; charset=utf-8
< content-length: 14
< etag: W/"e-LQS9yOYOT+WGITCx9XjB8GC9nDI"
< date: Thu, 10 Aug 2023 06:03:01 GMT
< x-envoy-upstream-service-time: 5
< server: envoy
< 
Hello World!!
```

* TLSã®è¨¼æ˜æ›¸ã‚’cert-managerã§ç™ºè¡Œã™ã‚‹å ´åˆ

```
kubectl create ingress hello-nodejs -n demo \
  --rule="hello-nodejs-demo.tap.192-168-228-200.sslip.io/*=hello-nodejs:8080,tls=hello-nodejs-tls" \
  --annotation cert-manager.io/cluster-issuer=tap-ingress-selfsigned
```

ä¸Šè¨˜ã®annotationã¯`tap-ingress-selfsigned`ã¨ã„ã†ClusterIssuerãŒå­˜åœ¨ã™ã‚‹ã“ã¨ãŒå‰æã§ã™ã€‚

```
$ curl -skv https://hello-nodejs-demo.tap.192-168-228-200.sslip.io
> GET / HTTP/2
> Host: hello-nodejs-demo.tap.192-168-228-200.sslip.io
> User-Agent: curl/8.1.2
> Accept: */*
> 
< HTTP/2 200 
< x-powered-by: Express
< content-type: text/html; charset=utf-8
< content-length: 14
< etag: W/"e-LQS9yOYOT+WGITCx9XjB8GC9nDI"
< date: Thu, 10 Aug 2023 06:03:53 GMT
< x-envoy-upstream-service-time: 5
< server: envoy
< 
Hello World!!
```

* Contourã®[TLS Certificate Delegation](https://projectcontour.io/docs/1.25/config/tls-delegation/)ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ

```
kubectl create ingress hello-nodejs -n demo \
  --rule="hello-nodejs-demo.tap.192-168-228-200.sslip.io/*=hello-nodejs:8080,tls=tap-default-tls" \
  --annotation projectcontour.io/tls-cert-namespace=tanzu-system-ingress
```

ä¸Šè¨˜ã®annotationã¯`tanzu-system-ingress` namespaceã«`*.tap.192-168-228-200.sslip.io`ã«å¯¾ã™ã‚‹Wildcardè¨¼æ˜æ›¸ã‚’å«ã‚€`tap-default-tls`ã¨ã„ã†SecretãŒå­˜åœ¨ã—ã€TLSCertificateDelegationã§å‚ç…§å¯èƒ½ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒå‰æã§ã™ã€‚

`kubectl create`ã‚’å®Ÿè¡Œã™ã‚‹ä»£ã‚ã‚Šã«YAMLã‚’ç®¡ç†ã—ãŸã„å ´åˆã¯ã€ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã«`--dry-run=client -oyaml`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚Œã°è‰¯ã„ã§ã™ã€‚
ã¾ãŸã€Contourä»¥å¤–ã®Ingressã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯`--class`ã§IngressClassåã‚’æŒ‡å®šã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ã«TAPã®Runã‚¯ãƒ©ã‚¹ã‚¿ã«[ingress-nginx](https://kubernetes.github.io/ingress-nginx/)ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆã€

```
$ kubectl get ingressclass
NAME    CONTROLLER             PARAMETERS   AGE
nginx   k8s.io/ingress-nginx   <none>       3m30s
```

æ¬¡ã®ã‚ˆã†ã«`--class=nginx`ã‚’ã¤ã‘ã‚Œã°è‰¯ã„ã§ã™ã€‚ (ingress-nginx-controllerã®ExternalIPãŒ`192.168.228.201`ã§ã‚ã‚‹å‰æã§ã™ã€‚)

```
kubectl create ingress hello-nodejs -n demo \
  --rule="hello-nodejs-demo.tap.192-168-228-201.sslip.io/*=hello-nodejs:8080" \
  --class=nginx
```

```
$ curl -sv http://hello-nodejs-demo.tap.192-168-228-201.sslip.io
> GET / HTTP/1.1
> Host: hello-nodejs-demo.tap.192-168-228-201.sslip.io
> User-Agent: curl/8.1.2
> Accept: */*
> 
< HTTP/1.1 200 OK
< Date: Thu, 10 Aug 2023 06:11:16 GMT
< Content-Type: text/html; charset=utf-8
< Content-Length: 14
< Connection: keep-alive
< X-Powered-By: Express
< ETag: W/"e-LQS9yOYOT+WGITCx9XjB8GC9nDI"
< 
Hello World!!
```

ã“ã®æ–¹æ³•ã¯TAPã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒä¸è¦ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚ã‚‹åé¢ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯é–‹ç™ºè€…(`app-editor`)ãŒIngressã‚’ä½œæˆã§ããªã„ã®ã§ã€`app-operator`ã«ä½œæˆã‚’ä¾é ¼ã™ã‚‹ã‹ã€æ¬¡ã®ã‚ˆã†ã«`app-editor`ã«æ¨©é™ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```yaml
kubectl apply -f -  << 'EOF'
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: app-editor-with-ingress
  labels:
    apps.tanzu.vmware.com/aggregate-to-app-editor: "true"
rules:
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
  - create
  - patch
  - update
  - delete
  - deletecollection
EOF
```

ã¾ãŸã€Ingressãƒªã‚½ãƒ¼ã‚¹ã‚’åˆ¥é€”ç®¡ç†ã™ã‚‹æ‰‹é–“ãŒç™ºç”Ÿã—ã¾ã™ã€‚
æ¬¡ã®OOTB SupplyChainã§ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«Ingressã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ã§ã‚ã‚Œã°ã€ã“ã‚Œã‚‰ã®èª²é¡Œã¯è§£æ±ºã•ã‚Œã¾ã™ã€‚

### OOTB SupplyChainã§ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«Ingressã‚’è¿½åŠ ã™ã‚‹

ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã‹ã‚Œã¦ã„ã‚‹é€šã‚Šã€ClusterConfigTemplateã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ã§Workloadã‹ã‚‰ç”Ÿæˆã•ã‚Œã‚‹ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«Ingressã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ <br>
https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.6/tap/workloads-server.html#define-a-workload-type-that-exposes-server-workloads-outside-the-cluster-5

ã“ã®å ´åˆã€`type=server-ingress`ã®ã‚ˆã†ã«æ–°è¦ã®Workload Typeã‚’è¿½åŠ ã™ã‚‹ã‹ã€æ—¢å­˜ã®`type=server`ã«Ingressã‚’è¿½åŠ ã™ã‚‹ã‹ã®é¸æŠè‚¢ãŒã‚ã‚Šã¾ã™ã€‚

#### æ–°è¦ã®Workload Typeã‚’è¿½åŠ ã™ã‚‹

æ—¢å­˜ã®`server-template`ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€`server-ingress-template`ã‚’ä½œæˆã—ã¾ã™ã€‚

`server-ingress-template`ã‚’ä»¥ä¸‹ã«å®šç¾©ã—ã¾ã™ã€‚`server-template`ã‹ã‚‰ã®å·®åˆ†ã¯`<------------ Added ---------------->`ã®éƒ¨åˆ†ã§ã™ã€‚

```yaml
apiVersion: carto.run/v1alpha1
kind: ClusterConfigTemplate
metadata:
  name: server-ingress-template
spec:
  configPath: .data

  params:
  - name: ports
    default:
    - containerPort: 8080
      port: 8080
      name: http

  healthRule:
    alwaysHealthy: {}

  ytt: |
    #@ load("@ytt:data", "data")
    #@ load("@ytt:yaml", "yaml")
    #@ load("@ytt:struct", "struct")
    #@ load("@ytt:assert", "assert")

    #@ def merge_labels(fixed_values):
    #@   labels = {}
    #@   if hasattr(data.values.workload.metadata, "labels"):
    #@     labels.update(data.values.workload.metadata.labels)
    #@   end
    #@   labels.update(fixed_values)
    #@   return labels
    #@ end

    #@ def intOrString(v):
    #@   return v if type(v) == "int" else int(v.strip()) if v.strip().isdigit() else v
    #@ end

    #@ def merge_ports(ports_spec, containers):
    #@   ports = {}
    #@   for c in containers:
    #@     for p in getattr(c, "ports", []):
    #@       ports[p.containerPort] = {"targetPort": p.containerPort, "port": p.containerPort, "name": getattr(p, "name", str(p.containerPort))}
    #@     end
    #@   end
    #@   for p in ports_spec:
    #@     targetPort = getattr(p, "containerPort", p.port)
    #@     type(targetPort) in ("string", "int") or fail("containerPort must be a string or int")
    #@     targetPort = intOrString(targetPort)
    #@     
    #@     port = p.port
    #@     type(port) in ("string", "int") or fail("port must be a string or int")
    #@     port = int(port)
    #@     ports[p.port] = {"targetPort": targetPort, "port": port, "name": getattr(p, "name", str(p.port))}
    #@   end
    #@   return ports.values()
    #@ end

    #! <------------ Added ---------------->
    #@ def merge_annotations(fixed_values):
    #@   annotations = {}
    #@   if hasattr(data.values.params, "annotations"):
    #@     annotations.update(data.values.params.annotations)
    #@   end
    #@   annotations.update(fixed_values)
    #@   return annotations
    #@ end
    #! <------------ Added ---------------->
  
    #@ def delivery():
    ---
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: #@ data.values.workload.metadata.name
      annotations:
        kapp.k14s.io/update-strategy: "fallback-on-replace"
        ootb.apps.tanzu.vmware.com/servicebinding-workload: "true"
        kapp.k14s.io/change-rule: "upsert after upserting servicebinding.io/ServiceBindings"
      labels: #@ merge_labels({ "app.kubernetes.io/component": "run", "carto.run/workload-name": data.values.workload.metadata.name })
    spec:
      selector:
        matchLabels: #@ data.values.config.metadata.labels
      template: #@ data.values.config
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: #@ data.values.workload.metadata.name
      labels: #@ merge_labels({ "app.kubernetes.io/component": "run", "carto.run/workload-name": data.values.workload.metadata.name })
    spec:
      selector: #@ data.values.config.metadata.labels
      ports:
      #@ hasattr(data.values.params, "ports") and len(data.values.params.ports) or assert.fail("one or more ports param must be provided.")
      #@ declared_ports = {}
      #@ if "ports" in data.values.params:
      #@   declared_ports = data.values.params.ports
      #@ else:
      #@   declared_ports = struct.encode([{ "containerPort": 8080, "port": 8080, "name": "http"}])
      #@ end
      #@ for p in merge_ports(declared_ports, data.values.config.spec.containers):
      - #@ p
      #@ end
    #! <------------ Added ---------------->
    #@ ingress_domain = "tap.192-168-228-200.sslip.io"
    #@ cluster_issuer = "tap-ingress-selfsigned"
    #@ port = intOrString(data.values.params.ports[0].port) if hasattr(data.values.params, "ports") and len(data.values.params.ports) > 0 and hasattr(data.values.params.ports[0], "port") else 8080
    ---
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: #@ data.values.workload.metadata.name
      annotations: #@ merge_annotations({"cert-manager.io/cluster-issuer": cluster_issuer, "kapp.k14s.io/change-rule": "upsert after upserting Services"})
      labels: #@ merge_labels({ "app.kubernetes.io/component": "run", "carto.run/workload-name": data.values.workload.metadata.name })
    spec:
      tls:
        - secretName: #@ "{}-tls".format(data.values.workload.metadata.name)
          hosts:
          - #@ "{}-{}.{}".format(data.values.workload.metadata.name, data.values.workload.metadata.namespace, ingress_domain)
      rules:
      - host: #@ "{}-{}.{}".format(data.values.workload.metadata.name, data.values.workload.metadata.namespace, ingress_domain)
        http:
          paths:
          - pathType: Prefix
            path: /
            backend:
              service:
                name: #@ data.values.workload.metadata.name
                port:
                  number: #@ port
    #! <------------ Added ---------------->
    #@ end

    ---
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: #@ data.values.workload.metadata.name + "-server"
      labels: #@ merge_labels({ "app.kubernetes.io/component": "config" })
    data:
      delivery.yml: #@ yaml.encode(delivery())
```

ã“ã®å†…å®¹ã‚’`server-ingress-template.yaml`ã«ä¿å­˜ã—ã€applyã—ã¾ã™ã€‚TAPã®multi clusteræ§‹æˆã®å ´åˆã¯ã€Buildã‚¯ãƒ©ã‚¹ã‚¿ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```
kubectl apply -f server-ingress-template.yaml
```

ã¾ãŸSupplyChainã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸIngressãƒªã‚½ãƒ¼ã‚¹ã‚’DeliverableãŒä½œæˆã§ãã‚‹ã‚ˆã†ã«ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ClusterRoleã‚’è¿½åŠ ã—ã¾ã™ã€‚TAPã®multi clusteræ§‹æˆã®å ´åˆã¯ã€Runã‚¯ãƒ©ã‚¹ã‚¿ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```yaml
cat << 'EOF' > deliverable-with-ingress.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: deliverable-with-ingress
  labels:
    apps.tanzu.vmware.com/aggregate-to-deliverable: "true"
rules:
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
  - create
  - patch
  - update
  - delete
  - deletecollection
EOF
kubectl apply -f deliverable-with-ingress.yaml
```

`tap-values.yaml`ã«ä»¥ä¸‹ã®å†…å®¹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```yaml
ootb_supply_chain_basic:
  supported_workloads:
    - type: web
      cluster_config_template_name: config-template
    - type: server
      cluster_config_template_name: server-template
    - type: worker
      cluster_config_template_name: worker-template
    - type: server-ingress #! <--- Added
      cluster_config_template_name: server-ingress-template
```

è¨­å®šã™ã‚‹ã‚­ãƒ¼ã¯`ootb_supply_chain_<suppy_chain>`ã§ã‚ã‚Šã€ä¸Šè¨˜ã®ä¾‹ã¯`supply_chain: basic`ã®å ´åˆã§ã™ã€‚

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§TAPã‚’æ›´æ–°ã—ã¾ã™ã€‚TAPã®multi clusteræ§‹æˆã®å ´åˆã¯ã€Buildã‚¯ãƒ©ã‚¹ã‚¿ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```
tanzu package installed update -n tap-install tap --values-file tap-values.yaml
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€åˆ©ç”¨å¯èƒ½ãªWorkload Typeã«`server-ingress`ãŒè¿½åŠ ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ tanzu apps cluster-supply-chain get source-to-url
---
# source-to-url: Ready
---
Supply Chain Selectors
   TYPE          KEY                                             OPERATOR   VALUE
   expressions   apps.tanzu.vmware.com/workload-type             In         web
   expressions   apps.tanzu.vmware.com/workload-type             In         server
   expressions   apps.tanzu.vmware.com/workload-type             In         worker
   expressions   apps.tanzu.vmware.com/workload-type             In         server-ingress
   expressions   apps.tanzu.vmware.com/carvel-package-workflow   DoesNotExist
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€`type=server-ingress`ã®Workloadã‚’ä½œæˆã—ã¾ã™ã€‚

```
kubectl delete ingress hello-nodejs -n demo # if exists
tanzu apps workload apply hello-nodejs \
  --app hello-nodejs \
  --git-repo https://github.com/making/hello-nodejs \
  --git-branch master \
  --type server-ingress \
  -n demo
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Workloadã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸYAMLã‚’ç¢ºèªã§ãã¾ã™ã€‚

```
kubectl get cm -n demo hello-nodejs-server -ojsonpath='{.data.delivery\.yml}'
```

æ¬¡ã®ã‚ˆã†ãªYAMLãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚IngressãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-nodejs
  annotations:
    kapp.k14s.io/update-strategy: fallback-on-replace
    ootb.apps.tanzu.vmware.com/servicebinding-workload: "true"
    kapp.k14s.io/change-rule: upsert after upserting servicebinding.io/ServiceBindings
  labels:
    app.kubernetes.io/part-of: hello-nodejs
    apps.tanzu.vmware.com/workload-type: server-ingress
    app.kubernetes.io/component: run
    carto.run/workload-name: hello-nodejs
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: run
      app.kubernetes.io/part-of: hello-nodejs
      apps.tanzu.vmware.com/workload-type: server-ingress
      carto.run/workload-name: hello-nodejs
  template:
    metadata:
      annotations:
        conventions.carto.run/applied-conventions: |-
          appliveview-sample/app-live-view-appflavour-check
          spring-boot-convention/auto-configure-actuators-check
          spring-boot-convention/app-live-view-appflavour-check
        developer.conventions/target-containers: workload
      labels:
        app.kubernetes.io/component: run
        app.kubernetes.io/part-of: hello-nodejs
        apps.tanzu.vmware.com/workload-type: server-ingress
        carto.run/workload-name: hello-nodejs
    spec:
      containers:
      - image: ghcr.io/making/workloads/hello-nodejs-demo@sha256:052ffee7966eeda9cf3a0d6a255f70b443ed0c39ab24591ab4b9ab857b30995b
        name: workload
        resources: {}
        securityContext:
          runAsUser: 1000
      serviceAccountName: default
---
apiVersion: v1
kind: Service
metadata:
  name: hello-nodejs
  labels:
    app.kubernetes.io/part-of: hello-nodejs
    apps.tanzu.vmware.com/workload-type: server-ingress
    app.kubernetes.io/component: run
    carto.run/workload-name: hello-nodejs
spec:
  selector:
    app.kubernetes.io/component: run
    app.kubernetes.io/part-of: hello-nodejs
    apps.tanzu.vmware.com/workload-type: server-ingress
    carto.run/workload-name: hello-nodejs
  ports:
  - targetPort: 8080
    port: 8080
    name: http
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-nodejs
  annotations:
    cert-manager.io/cluster-issuer: tap-ingress-selfsigned
    kapp.k14s.io/change-rule: upsert after upserting Services
  labels:
    app.kubernetes.io/part-of: hello-nodejs
    apps.tanzu.vmware.com/workload-type: server-ingress
    app.kubernetes.io/component: run
    carto.run/workload-name: hello-nodejs
spec:
  tls:
  - secretName: hello-nodejs-tls
    hosts:
    - hello-nodejs-demo.tap.192-168-228-200.sslip.io
  rules:
  - host: hello-nodejs-demo.tap.192-168-228-200.sslip.io
    http:
      paths:
      - pathType: Prefix
        path: /
        backend:
          service:
            name: hello-nodejs
            port:
              number: 8080
```

Supply Chainã‹ã‚‰Ingressãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```
$ kubectl get ing -n demo --show-labels
NAME           CLASS    HOSTS                                            ADDRESS           PORTS     AGE   LABELS
hello-nodejs   <none>   hello-nodejs-demo.tap.192-168-228-200.sslip.io   192.168.228.200   80, 443   96s   app.kubernetes.io/component=run,app.kubernetes.io/part-of=hello-nodejs,apps.tanzu.vmware.com/workload-type=server-ingress,carto.run/workload-name=hello-nodejs,kapp.k14s.io/app=1691647255322645686,kapp.k14s.io/association=v1.4aa1edeb0a707e6a5e81cfde4668a7b0
```

```
$ curl -ks https://hello-nodejs-demo.tap.192-168-228-200.sslip.io 
Hello World!!
```


ClusterConfigTemplateã®è¿½åŠ ã¨ClusterRoleã®è¿½åŠ ã‚’`tanzu package install`ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã¾ã¨ã‚ã¦è¡Œã„ãŸã„å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«overlayã¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Secretã«ç™»éŒ²ã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

```
# Muti Clusteræ§‹æˆã®å ´åˆã¯Build Clusterã«ã¦
kubectl -n tap-install create secret generic ootb-templates-server-ingress-template \
  -o yaml \
  --dry-run=client \
  --from-file=server-ingress-template.yaml \
  | kubectl apply -f-
```

```
# Muti Clusteræ§‹æˆã®å ´åˆã¯Run Clusterã«ã¦
kubectl -n tap-install create secret generic tap-auth-deliverable-with-ingress \
  -o yaml \
  --dry-run=client \
  --from-file=deliverable-with-ingress.yaml \
  | kubectl apply -f-
```

`tap-values.yaml`ã«ä»¥ä¸‹ã®è¨­å®šã‚’è¿½åŠ ã€‚

```yaml
package_overlays:
- name: ootb-templates
  secrets:
  - name: ootb-templates-server-ingress-template # Muti Clusteræ§‹æˆã®å ´åˆã¯Build Clusterã«ã¦
- name: tap-auth
  secrets:
  - name: tap-auth-deliverable-with-ingress # Muti Clusteræ§‹æˆã®å ´åˆã¯Run Clusterã«ã¦
```

TAPã‚’æ›´æ–°ã—ã¾ã™ã€‚

```
tanzu package installed update -n tap-install tap --values-file tap-values.yaml
```

#### æ—¢å­˜ã®`type=server`ã«Ingressã‚’è¿½åŠ ã™ã‚‹

æ–°è¦ã®Workload Typeã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ã¯Templateã‚’è‡ªåˆ†ã§ç®¡ç†ã§ãã‚‹ã®ã§ã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã‚„ã™ã„ä¸€æ–¹ã€
ã‚³ãƒ”ãƒ¼å…ƒã®`type=server`ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ã€æ›´æ–°å†…å®¹ã‚’åæ˜ ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

æ¬¡ã®overlayã‚’é©ç”¨ã—ã¦ã€æ—¢å­˜ã®ClusterConfigTemplate `server-template`ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: ootb-templates-overlay-ingress
  namespace: tap-install
type: Opaque
stringData:
  overlay-ingress.yaml: |
    #@ def merge_annotations_def_string():
    #@   return '''
    #@ #@ def merge_annotations(fixed_values):
    #@ #@   annotations = {}
    #@ #@   if hasattr(data.values.params, "annotations"):
    #@ #@     annotations.update(data.values.params.annotations)
    #@ #@   end
    #@ #@   annotations.update(fixed_values)
    #@ #@   return annotations
    #@ #@ end
    #@ '''
    #@ end
    
    #@ load("@ytt:overlay", "overlay")
    #@ load("@ytt:data", "data")
    #@ ingress_domain = data.values.ingress_domain
    #@ cluster_issuer = data.values.cluster_issuer
    #@overlay/match by=overlay.subset({"kind":"ClusterConfigTemplate", "metadata": {"name": "server-template"}})
    ---
    spec:
      #@overlay/replace via=lambda left, right: "{}\n{}".format(left.replace("#@ def delivery():", '\n'.join([ merge_annotations_def_string(), "#@ def delivery():"])), '\n'.join(['  {}'.format(x) for x in right.replace("INGRESS_DOMAIN", ingress_domain).replace("CLUSTER_ISSUER", cluster_issuer).split('\n')]))
      ytt: |
        #@yaml/text-templated-strings
        ingress.yml: |
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: (@= data.values.workload.metadata.name @)
            annotations:
          (@= '\n'.join(['    {}'.format(x) for x in yaml.encode(merge_annotations({ "cert-manager.io/cluster-issuer": "CLUSTER_ISSUER", "kapp.k14s.io/change-rule": "upsert after upserting Services" })).split('\n')]) @)
            labels: 
          (@= '\n'.join(['    {}'.format(x) for x in yaml.encode(merge_labels({ "app.kubernetes.io/component": "run", "carto.run/workload-name": data.values.workload.metadata.name })).split('\n')]) @)
          spec:
            tls:
              - secretName: (@= data.values.workload.metadata.name @)-tls
                hosts:
                - (@= "{}-{}.{}".format(data.values.workload.metadata.name, data.values.workload.metadata.namespace, "INGRESS_DOMAIN") @)
            rules:
            - host: (@= "{}-{}.{}".format(data.values.workload.metadata.name, data.values.workload.metadata.namespace, "INGRESS_DOMAIN") @)
              http:
                paths:
                - pathType: Prefix
                  path: /
                  backend:
                    service:
                      name: (@= data.values.workload.metadata.name @)
                      port:
                        number: (@= str(data.values.params.ports[0].port) if hasattr(data.values.params, "ports") and len(data.values.params.ports) > 0 and hasattr(data.values.params.ports[0], "port") else "8080" @)
```

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`ootb-templates-overlay-ingress.yaml`ã«ä¿å­˜ã—ã¦ã€applyã—ã¾ã™ã€‚

```
kubectl apply -f ootb-templates-overlay-ingress.yaml
```

`tap-values.yaml`ã«æ¬¡ã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

```yaml
ootb_templates:
  ingress_domain: tap.192-168-228-200.sslip.io
  cluster_issuer: tap-ingress-selfsigned

package_overlays:
- name: ootb-templates # Muti Clusteræ§‹æˆã®å ´åˆã¯Build Clusterã«ã¦
  secrets:
  - name: ootb-templates-overlay-ingress
```

TAPã‚’æ›´æ–°ã—ã¾ã™ã€‚

```
tanzu package installed update -n tap-install tap --values-file tap-values.yaml
```

`type=server`ã§Workloadã‚’ä½œæˆã—ã¾ã™ã€‚

```
tanzu apps workload apply hello-nodejs \
  --app hello-nodejs \
  --git-repo https://github.com/making/hello-nodejs \
  --git-branch master \
  --type server \
  -n demo
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Workloadã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸIngressã®YAMLã‚’ç¢ºèªã§ãã¾ã™ã€‚

```
kubectl get cm -n demo hello-nodejs-server -ojsonpath='{.data.ingress\.yml}'
```

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-nodejs
  annotations:
    cert-manager.io/cluster-issuer: tap-ingress-selfsigned
    kapp.k14s.io/change-rule: upsert after upserting Services
    
  labels: 
    app.kubernetes.io/part-of: hello-nodejs
    apps.tanzu.vmware.com/workload-type: server
    app.kubernetes.io/component: run
    carto.run/workload-name: hello-nodejs
    
spec:
  tls:
    - secretName: hello-nodejs-tls
      hosts:
      - hello-nodejs-demo.tap.192-168-228-200.sslip.io
  rules:
  - host: hello-nodejs-demo.tap.192-168-228-200.sslip.io
    http:
      paths:
      - pathType: Prefix
        path: /
        backend:
          service:
            name: hello-nodejs
            port:
              number: 8080
```

Supply Chainã‹ã‚‰Ingressãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```
$ kubectl get ing -n demo --show-labels
NAME           CLASS    HOSTS                                            ADDRESS           PORTS     AGE    LABELS
hello-nodejs   <none>   hello-nodejs-demo.tap.192-168-228-200.sslip.io   192.168.228.200   80, 443   154m   app.kubernetes.io/component=run,app.kubernetes.io/part-of=hello-nodejs,apps.tanzu.vmware.com/workload-type=server,carto.run/workload-name=hello-nodejs,kapp.k14s.io/app=1691647255322645686,kapp.k14s.io/association=v1.4aa1edeb0a707e6a5e81cfde4668a7b0
```

æ–°è¦ã®Workload Typeã‚’è¿½åŠ ã™ã‚‹å ´åˆã«æ¯”ã¹ã¦ã€æ—¢å­˜ã®Workload Typeã‚’æ›´æ–°ã™ã‚‹æ–¹æ³•ã¯ã€TAPã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼å…ƒã®templateã®å¤‰æ›´ã‚’è‡ªå‹•ã§ãƒãƒ¼ã‚¸ã™ã‚‹ã®ã§ã€å¤‰æ›´ã‚’åæ˜ ã•ã›ã‚‹æ‰‹é–“ãŒå…¥ã‚Šã¾ã›ã‚“ã€‚
ä¸€æ–¹ã§ã€overlayãŒæ¬¡ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚‚æ©Ÿèƒ½ã™ã‚‹ã‹ã©ã†ã‹ã¯ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã«ã¯å¿…ãšå‹•ä½œæ¤œè¨¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


Supply Chainã‹ã‚‰Ingressã‚’ç”Ÿæˆã™ã‚‹æ–¹æ³•ã¯ã€è‡ªå‹•ã§Ingressãƒªã‚½ãƒ¼ã‚¹ãŒã§ãã‚‹ã®ã§ä¾¿åˆ©ãªã®ã§ã™ãŒã€Workloadã‚’ä½œã‚‹æ™‚ç‚¹ã§ä½œæˆã•ã‚Œã‚‹Ingressã®hoståãŒå›ºå®šã•ã‚Œã¦ã—ã¾ã†ç‚¹ã§ã™ã€‚
ä»Šå›ã®ä¾‹ã ã¨Ingressãƒªã‚½ãƒ¼ã‚¹ã«`hello-nodejs-demo.tap.192-168-228-200.sslip.io`ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚
ã‚¢ãƒ—ãƒªãŒå‹•ä½œã™ã‚‹ç’°å¢ƒ(Runã‚¯ãƒ©ã‚¹ã‚¿ãªã©)ãŒ1ç’°å¢ƒã®å ´åˆã¯å•é¡Œãªã„ã®ã§ã™ãŒã€è¤‡æ•°ã®Runã‚¯ãƒ©ã‚¹ã‚¿ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„å ´åˆã¯å•é¡Œã«ãªã‚Šã¾ã™ã€‚Supply Chainã‹ã‚‰ç”Ÿæˆã•ã‚Œã‚‹ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ç’°å¢ƒã«å¿œã˜ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚

Workaroundã¯[Gitopsãƒ¢ãƒ¼ãƒ‰](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.6/tap/scc-gitops-vs-regops.html#gitops-0)ã‚’åˆ©ç”¨ã—ã¦ã€åˆ¥ã®Runã‚¯ãƒ©ã‚¹ã‚¿ã«å¯¾ã—ã¦ã¯æ¬¡ã®ã‚ˆã†ãªoverlayã‚’Gitãƒ¬ãƒã‚¸ãƒˆãƒªä¸Šã«ä½œã‚Œã°ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«hoståãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚

```yaml
#@ load("@ytt:overlay", "overlay")
#@ ingress_domain = "hello-nodejs-demo.production.example.com"
#@overlay/match by=overlay.subset({"kind":"Ingress"})
---
spec:
  tls:
  #@overlay/match by=overlay.index(0)
  - hosts:
    #@overlay/match by=overlay.index(0)
    - #@ ingress_domain
  rules:
  #@overlay/match by=overlay.index(0)
  - host: #@ ingress_domain
```

### Carvel Package Supply Chainã‚’ä½¿ç”¨ã™ã‚‹

Supply Chainã‹ã‚‰ç”Ÿæˆã•ã‚Œã‚‹ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ç’°å¢ƒã«å¿œã˜ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ããªã„ã¨ã„ã†èª²é¡Œã‚’è§£æ±ºã™ã‚‹ã®ãŒ[Carvel Package Supply Chains](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.6/tap/scc-config-deploy-multi-env.html)ã§ã™ã€‚
TAP 1.5ã§Alphaãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã—ã¦å°å…¥ã•ã‚Œã€TAP 1.6æ™‚ç‚¹ã§ã¯Betaãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã™ã€‚ã¾ã ã€å®Ÿé¨“çš„ãªæ©Ÿèƒ½ã§åˆ¶ç´„ãŒå¤šãã€ OOTB Basic Supply Chainã§ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚

Carvel Package Supply Chainsã¯é€šå¸¸ã®Supply Chainã®ã‚ˆã†ã«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ä½œã‚Šã€pushã—ã¾ã™ãŒã€ãã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã«Deliverableã‚’ä½œã‚‹ä»£ã‚ã‚Šã«ã€Carvelã®Packageãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
ã“ã®Packageã‚’å®Ÿè¡Œç’°å¢ƒï¼ˆRunã‚¯ãƒ©ã‚¹ã‚¿ãªã©ï¼‰ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ã“ã®æ™‚ä½œæˆã™ã‚‹PackageInstallãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã“ã¨ã§å®Ÿè¡Œç’°å¢ƒã«å¿œã˜ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
Carvel Package Supply Chainsã§ã¯`type=server`ã®å ´åˆã«Ingressãƒªã‚½ãƒ¼ã‚¹ã‚‚ä½œæˆã•ã‚Œã¾ã™ã€‚

ãªãŠã€TAP 1.6æ™‚ç‚¹ã§ã¯ã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®pushå…ˆã¯Git Repositoryã®ã¿ãªã®ã§ã€[Gitopsãƒ¢ãƒ¼ãƒ‰](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.6/tap/scc-gitops-vs-regops.html#gitops-0)ãŒå¿…é ˆã§ã™ã€‚

Carvel Package Supply Chainsã‚’æœ‰åŠ¹ã™ã‚‹ã«ã¯ã€`tap-values.yaml`ã«æ¬¡ã®è¨­å®šã‚’æ˜ç¤ºçš„ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚multi clusterã®å ´åˆã¯ã€Buildã‚¯ãƒ©ã‚¹ã‚¿ã§ã“ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚

```yaml
ootb_supply_chain_basic:
  carvel_package:
    workflow_enabled: true
```

ã“ã®è¨­å®šã‚’æœ‰åŠ¹ã«ã—ã¦ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§TAPã‚’æ›´æ–°ã—ã¾ã™ã€‚

```
tanzu package installed update -n tap-install tap --values-file tap-values.yaml 
```

> âš ï¸ Ingressã®ä½œæˆãŒé‡è¤‡ã™ã‚‹ãŸã‚ã€`tap-values.yaml`ã‹ã‚‰`ootb-templates-overlay-ingress`ã®overlayè¨­å®šã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚


Supply Chainãƒªã‚¹ãƒˆã‚’ç¢ºèªã™ã‚‹ã¨`source-to-url-package`ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
$ tanzu apps cluster-supply-chain list
NAME                         READY   AGE
basic-image-to-url           Ready   6h31m
basic-image-to-url-package   Ready   89s
source-to-url                Ready   6h31m
source-to-url-package        Ready   89s
```

ã“ã®Supply Chainã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªã™ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ã«ãƒ©ãƒ™ãƒ«ã§ `apps.tanzu.vmware.com/carvel-package-workflow=true` ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ 

```
$ tanzu apps cluster-supply-chain get source-to-url-package
---
# source-to-url-package: Ready
---
Supply Chain Selectors
   TYPE          KEY                                             OPERATOR   VALUE
   expressions   apps.tanzu.vmware.com/workload-type             In         web
   expressions   apps.tanzu.vmware.com/workload-type             In         server
   expressions   apps.tanzu.vmware.com/workload-type             In         worker
   expressions   apps.tanzu.vmware.com/carvel-package-workflow   In         true
```

å®Ÿéš›ã«æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Carvel Package Supply Chainã‚’ä½¿ã£ãŸWorkloadã‚’ä½œæˆã—ã¾ã™ã€‚ GitOpsãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ã†ãŸã‚ã®è¨­å®šã¯æœ¬è¨˜äº‹ã§ã¯çœç•¥ã—ã¾ã™ã€‚

```
tanzu apps workload apply hello-nodejs \
  --app hello-nodejs \
  --git-repo https://github.com/making/hello-nodejs \
  --git-branch master \
  --label apps.tanzu.vmware.com/carvel-package-workflow=true \
  --type server \
  --param gitops_branch=main \
  --param gitops_commit_message=Bump \
  --param gitops_server_address=https://github.com \
  --param gitops_repository_owner=making \
  --param gitops_repository_name=tap-gitops-manifests \
  --param gitops_user_email=makingx+bot@gmail.com \
  --param gitops_user_name=making-bot \
  --param gitops_ssh_secret=git-basic \
  -n demo
```

Workloadã®Readyã«ãªã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ãªãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

```
$ tanzu apps workload get hello-nodejs --namespace demo 
ğŸ“¡ Overview
   name:        hello-nodejs
   type:        server
   namespace:   demo

ğŸ’¾ Source
   type:       git
   url:        https://github.com/making/hello-nodejs
   branch:     master
   revision:   master@sha1:fde413c0fba0003c218a60bde69c8e254d3b15a6

ğŸ“¦ Supply Chain
   name:   source-to-url-package

   NAME               READY   HEALTHY   UPDATED   RESOURCE
   source-provider    True    True      6m25s     gitrepositories.source.toolkit.fluxcd.io/hello-nodejs
   image-provider     True    True      5m29s     images.kpack.io/hello-nodejs
   config-provider    True    True      5m22s     podintents.conventions.carto.run/hello-nodejs
   app-config         True    True      5m22s     configmaps/hello-nodejs-server
   service-bindings   True    True      5m22s     configmaps/hello-nodejs-with-claims
   api-descriptors    True    True      5m22s     configmaps/hello-nodejs-with-api-descriptors
   carvel-package     True    True      5m8s      taskruns.tekton.dev/hello-nodejs-carvel-package-j86xm
   config-writer      True    True      4m55s     runnables.carto.run/hello-nodejs-pkg-cfg-writer

ğŸšš Delivery

   Delivery resources not found.

ğŸ’¬ Messages
   No messages found.

ğŸ›¶ Pods
   NAME                                    READY   STATUS      RESTARTS   AGE
   hello-nodejs-build-1-build-pod          0/1     Completed   0          6m27s
   hello-nodejs-carvel-package-j86xm-pod   0/3     Completed   0          5m22s
   hello-nodejs-pkg-cfg-writer-jsg9x-pod   0/2     Completed   0          5m6s
```

`hello-nodejs-carvel-package-****`ã§ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’`imgpkg`ã§ãƒãƒ³ãƒ‰ãƒ«åŒ–ã—ã¦pushã—ã€`hello-nodejs-pkg-cfg-writer-****`ã§ãã®imgpkgBundleã‚’Packageãƒªã‚½ãƒ¼ã‚¹ã«å®šç¾©ã—ã€gitãƒ¬ãƒã‚¸ãƒˆãƒªã«pushã—ã¾ã™ã€‚
å®Ÿéš›ã«pushã•ã‚ŒãŸPackageãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¯ https://github.com/making/tap-gitops-manifests/blob/main/hello-nodejs.demo.tap/packages/20230811080453.0.0.yml ã§ã™ã€‚

ãƒãƒ³ãƒ‰ãƒ«åŒ–ã•ã‚ŒãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€‚(visibilityã‚’publicã«ã—ã¦ã‚ã‚‹ã®ã§å®Ÿéš›ã«å®Ÿè¡Œã—ã¦å†…å®¹ã‚’ç¢ºèªã§ãã¾ã™)

```
imgpkg pull -b ghcr.io/making/workloads/hello-nodejs-demo-bundle@sha256:b0a013325c4c089befffd72643d576fb1109bebadce87f2f7b3615aef5ed9d75 -o /tmp/hello-nodejs
```

ã§ã¯ã“ã®Gitä¸Šã«pushã•ã‚ŒãŸPackageãƒªã‚½ãƒ¼ã‚¹ã‚’applyã—ã¾ã™ã€‚multi clusterã®å ´åˆã¯Runã‚¯ãƒ©ã‚¹ã‚¿ã«applyã—ã¾ã™ã€‚
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã“ã“ã§GitOpsãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¦ãŠã‚Šã€

* [Carvelã®Appãƒªã‚½ãƒ¼ã‚¹](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.6/tap/scc-delivery-with-carvel-app.html)
* [Fluxã®GitRepositoryãƒªã‚½ãƒ¼ã‚¹](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.6/tap/scc-delivery-with-flux.html)
* [ArgoCDã®Applicationãƒªã‚½ãƒ¼ã‚¹](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.6/tap/scc-delivery-with-argo.html)

ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚å‰è€…ã®2ã¤ã¯è¿½åŠ ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãªã—ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚

ã“ã“ã§ã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’çœç•¥ã™ã‚‹ãŸã‚ã€GitOpsã‚’ä½¿ç”¨ã›ãšå˜ç´”ã«æ¬¡ã®ã‚ˆã†ã«`kubectl apply`ã§Packageãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```
kubectl apply -f https://github.com/making/tap-gitops-manifests/raw/main/hello-nodejs.demo.tap/packages/20230811080453.0.0.yml -n demo
```

æ¬¡ã®Packageãƒªã‚½ãƒ¼ã‚¹ãŒã§ãã¾ã—ãŸã€‚

```
$ kubectl get package -n demo
NAME                                                     PACKAGEMETADATA NAME    VERSION                            AGE
hello-nodejs.demo.tap.20230811080453.0.0+build.fde413c   hello-nodejs.demo.tap   20230811080453.0.0+build.fde413c   5s
```

ã“ã®Packageã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ tanzu package available get -n demo hello-nodejs.demo.tap/20230811080453.0.0+build.fde413c --values-schema

  KEY             DEFAULT                 TYPE     DESCRIPTION                                                         
  replicas        1                       integer  Number of replicas.                                                 
  workload_name   ""                      string   Required. Name of the workload, used by K8s Ingress HTTP rules.     
  cluster_issuer  tap-ingress-selfsigned  string   CertManager Issuer to use to generate certificate for K8s Ingress.  
  hostname        ""                      string   If set, K8s Ingress will be created with HTTP rules for hostname.   
  port            8080                    integer  Port number for the backend associated with K8s Ingress. 
```

Ingressã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€`workload_name`ã‚’`hostname`ã‚’è¨­å®šã—ã¾ã™ã€‚

```
cat <<EOF > hello-nodejs-values.yaml
workload_name: hello-nodejs
hostname: hello-nodejs-demo.stg.192-168-228-200.sslip.io
EOF
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚multi clusterã®å ´åˆã¯Runã‚¯ãƒ©ã‚¹ã‚¿ã§å®Ÿè¡Œã—ã¾ã™ã€‚`-v`ã«`>= 0.0.0`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€æ–°ã—ã„PackageãŒKubernetesä¸Šã«ä½œæˆã•ã‚Œã‚‹ã¨è‡ªå‹•ã§ãã®æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚Œã¾ã™ã€‚

```
tanzu package install -n demo hello-nodejs -p hello-nodejs.demo.tap -v ">= 0.0.0" --values-file hello-nodejs-values.yaml
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ãŸã‚‰ã€æ¬¡ã®ã‚ˆã†ãªãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚ŒãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
$ kubectl get pkgi,deploy,svc,ing -n demo 
NAME                                               PACKAGE NAME            PACKAGE VERSION                    DESCRIPTION           AGE
packageinstall.packaging.carvel.dev/hello-nodejs   hello-nodejs.demo.tap   20230811080453.0.0+build.fde413c   Reconcile succeeded   12s

NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/hello-nodejs   1/1     1            1           9s

NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/hello-nodejs   ClusterIP   10.96.113.106   <none>        8080/TCP   9s

NAME                                     CLASS    HOSTS                                            ADDRESS           PORTS     AGE
ingress.networking.k8s.io/hello-nodejs   <none>   hello-nodejs-demo.stg.192-168-228-200.sslip.io   192.168.228.200   80, 443   9s
```

Ingressã§å…¬é–‹ã•ã‚ŒãŸURLã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚

```
$ curl -k https://hello-nodejs-demo.stg.192-168-228-200.sslip.io 
Hello World!!
```

Carvel Package Supply Chainã®å ´åˆã€é€šå¸¸ã®Supply Chainã®`type=server`ãªWorkloadã§ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹(Deployment, Service)ã«åŠ ãˆã¦ã€IngressãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚
è¿½åŠ ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã¯overlayã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®overlayãƒ•ã‚¡ã‚¤ãƒ«ã¨å¤‰æ›´å¯èƒ½ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å®šç¾©ã¯TAP 1.6ã‹ã‚‰`tap-values.yaml`ã§ä¸Šæ›¸ãå¯èƒ½ã§ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æ¬¡ã®ã‚ˆã†ãªå®šç¾©ã«ãªã£ã¦ã„ã¾ã™ã€‚

```yaml
ootb_templates:
  carvel_package:
    parameters:
      - selector:
          matchLabels:
            apps.tanzu.vmware.com/workload-type: server
        schema: |
          #@data/values-schema
          ---
          #@schema/title "Workload name"
          #@schema/desc "Required. Name of the workload, used by K8s Ingress HTTP rules."
          #@schema/example "tanzu-java-web-app"
          #@schema/validation min_len=1
          workload_name: ""
  
          #@schema/title "Replicas"
          #@schema/desc "Number of replicas."
          replicas: 1
  
          #@schema/title "Port"
          #@schema/desc "Port number for the backend associated with K8s Ingress."
          port: 8080
  
          #@schema/title "Hostname"
          #@schema/desc "If set, K8s Ingress will be created with HTTP rules for hostname."
          #@schema/example "app.tanzu.vmware.com"
          hostname: ""
  
          #@schema/title "Cluster Issuer"
          #@schema/desc "CertManager Issuer to use to generate certificate for K8s Ingress."
          cluster_issuer: "tap-ingress-selfsigned"
        overlays: |
          #@ load("@ytt:overlay", "overlay")
          #@ load("@ytt:data", "data")
          #@overlay/match by=overlay.subset({"apiVersion":"apps/v1", "kind": "Deployment"})
          ---
          spec:
            #@overlay/match missing_ok=True
            replicas: #@ data.values.replicas
  
          #@ if data.values.hostname != "":
          ---
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: #@ data.values.workload_name
            annotations:
              cert-manager.io/cluster-issuer:  #@ data.values.cluster_issuer
              ingress.kubernetes.io/force-ssl-redirect: "true"
              kubernetes.io/ingress.class: contour
              kapp.k14s.io/change-rule: "upsert after upserting Services"
            labels:
              app.kubernetes.io/component: "run"
              carto.run/workload-name:  #@ data.values.workload_name
          spec:
            tls:
              - secretName: #@ data.values.workload_name
                hosts:
                - #@ data.values.hostname
            rules:
            - host: #@ data.values.hostname
              http:
                paths:
                - pathType: Prefix
                  path: /
                  backend:
                    service:
                      name: #@ data.values.workload_name
                      port:
                        number: #@ data.values.port
          #@ end
```

Ingressã«Contourã‚’åˆ©ç”¨ã™ã‚‹annotationãŒã¤ã„ã¦ã„ã¾ã™ã€‚å‰è¿°ã®ã‚ˆã†ã«Nginx Ingressã‚’ä½¿ã†ã‚ˆã†ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ã¿ã¾ã™ã€‚
`tap-values.yaml`ã«æ¬¡ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚


```yaml
ootb_templates:
  carvel_package:
    parameters:
    - selector:
        matchLabels:
          apps.tanzu.vmware.com/workload-type: server
      schema: |
        #@data/values-schema
        ---
        #@schema/title "Workload name"
        #@schema/desc "Required. Name of the workload, used by K8s Ingress HTTP rules."
        #@schema/example "tanzu-java-web-app"
        #@schema/validation min_len=1
        workload_name: ""

        #@schema/title "Replicas"
        #@schema/desc "Number of replicas."
        replicas: 1

        #@schema/title "Port"
        #@schema/desc "Port number for the backend associated with K8s Ingress."
        port: 8080

        #@schema/title "Hostname"
        #@schema/desc "If set, K8s Ingress will be created with HTTP rules for hostname."
        #@schema/example "app.tanzu.vmware.com"
        hostname: ""

        #@schema/title "Cluster Issuer"
        #@schema/desc "CertManager Issuer to use to generate certificate for K8s Ingress."
        cluster_issuer: "tap-ingress-selfsigned"
      overlays: |
        #@ load("@ytt:overlay", "overlay")
        #@ load("@ytt:data", "data")
        #@overlay/match by=overlay.subset({"apiVersion":"apps/v1", "kind": "Deployment"})
        ---
        spec:
          #@overlay/match missing_ok=True
          replicas: #@ data.values.replicas

        #@ if data.values.hostname != "":
        ---
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: #@ data.values.workload_name
          annotations:
            cert-manager.io/cluster-issuer:  #@ data.values.cluster_issuer
            ingress.kubernetes.io/force-ssl-redirect: "true"
            #! kubernetes.io/ingress.class: contour <----- Removed
            kapp.k14s.io/change-rule: "upsert after upserting Services"
          labels:
            app.kubernetes.io/component: "run"
            carto.run/workload-name:  #@ data.values.workload_name
        spec:
          ingressClassName: nginx #! <----- Added
          tls:
            - secretName: #@ data.values.workload_name
              hosts:
              - #@ data.values.hostname
          rules:
          - host: #@ data.values.hostname
            http:
              paths:
              - pathType: Prefix
                path: /
                backend:
                  service:
                    name: #@ data.values.workload_name
                    port:
                      number: #@ data.values.port
        #@ end
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§TAPã‚’æ›´æ–°ã—ã¾ã™ã€‚

```
tanzu package installed update -n tap-install tap --values-file tap-values.yaml 
```

Workloadã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã¨ã€`hello-nodejs-carvel-package-****`ã¨`hello-nodejs-pkg-cfg-writer-****`ãŒæ–°ãŸã«ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã¦ã€æ–°ã—ã„ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®imgpkg bundleä½œæˆã¨git pushãŒè¡Œã‚ã‚Œã¾ã—ãŸã€‚

```
$ tanzu apps workload get hello-nodejs --namespace demo 
ğŸ“¡ Overview
   name:        hello-nodejs
   type:        server
   namespace:   demo

ğŸ’¾ Source
   type:       git
   url:        https://github.com/making/hello-nodejs
   branch:     master
   revision:   master@sha1:fde413c0fba0003c218a60bde69c8e254d3b15a6

ğŸ“¦ Supply Chain
   name:   source-to-url-package

   NAME               READY     HEALTHY   UPDATED   RESOURCE
   source-provider    True      True      9m41s     gitrepositories.source.toolkit.fluxcd.io/hello-nodejs
   image-provider     True      True      8m45s     images.kpack.io/hello-nodejs
   config-provider    True      True      8m38s     podintents.conventions.carto.run/hello-nodejs
   app-config         True      True      8m38s     configmaps/hello-nodejs-server
   service-bindings   True      True      8m38s     configmaps/hello-nodejs-with-claims
   api-descriptors    True      True      8m38s     configmaps/hello-nodejs-with-api-descriptors
   carvel-package     True      True      11s       taskruns.tekton.dev/hello-nodejs-carvel-package-v7psj
   config-writer      Unknown   Unknown   4s        runnables.carto.run/hello-nodejs-pkg-cfg-writer

ğŸšš Delivery

   Delivery resources not found.

ğŸ’¬ Messages
   Workload [HealthyConditionRule]:   Not all Steps in the Task have finished executing

ğŸ›¶ Pods
   NAME                                    READY   STATUS      RESTARTS   AGE
   hello-nodejs-7455c98c94-c4zlt           1/1     Running     0          4m23s
   hello-nodejs-build-1-build-pod          0/1     Completed   0          9m44s
   hello-nodejs-carvel-package-j86xm-pod   0/3     Completed   0          8m39s
   hello-nodejs-carvel-package-v7psj-pod   0/3     Completed   0          26s
   hello-nodejs-pkg-cfg-writer-ctxfx-pod   0/2     Completed   0          13s
   hello-nodejs-pkg-cfg-writer-jsg9x-pod   0/2     Completed   0          8m23s

To see logs: "tanzu apps workload tail hello-nodejs --namespace demo --timestamp --since 1h"
```

ç”Ÿæˆã•ã‚ŒãŸPackageãƒªã‚½ãƒ¼ã‚¹ã¯ https://github.com/making/tap-gitops-manifests/blob/main/hello-nodejs.demo.tap/packages/20230811081306.0.0.yml ã§ã™ã€‚
ãƒãƒ³ãƒ‰ãƒ«åŒ–ã•ã‚ŒãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚

```
imgpkg pull -b ghcr.io/making/workloads/hello-nodejs-demo-bundle@sha256:8971d6979d6823edbe502162ddb9ab6dde665ac807857dbe4ea89857ce2db28c -o /tmp/hello-nodejs
```

æ–°ã—ã„Packageã‚’`kubectl`ã§applyã—ã¾ã™ã€‚GitOpsã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆ(æ¨å¥¨)ã¯è‡ªå‹•ã§æ–°ã—ã„PackageãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚

```
kubectl apply -f https://github.com/making/tap-gitops-manifests/raw/main/hello-nodejs.demo.tap/packages/20230811081306.0.0.yml -n demo
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§æ–°ã—ã„Packageã‚’ç¢ºèªã§ãã¾ã™ã€‚

```
$ kubectl get package -n demo  
NAME                                                     PACKAGEMETADATA NAME    VERSION                            AGE
hello-nodejs.demo.tap.20230811080453.0.0+build.fde413c   hello-nodejs.demo.tap   20230811080453.0.0+build.fde413c   5m53s
hello-nodejs.demo.tap.20230811081306.0.0+build.fde413c   hello-nodejs.demo.tap   20230811081306.0.0+build.fde413c   6s
```

PackageInstallãŒæ–°ã—ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ¤œå‡ºã—ã¦ã€è‡ªå‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã€Ingressã®nginxã®ã‚‚ã®ãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
$ kubectl get pkgi,deploy,svc,ing -n demo 
NAME                                               PACKAGE NAME            PACKAGE VERSION                    DESCRIPTION           AGE
packageinstall.packaging.carvel.dev/hello-nodejs   hello-nodejs.demo.tap   20230811081306.0.0+build.fde413c   Reconcile succeeded   5m44s

NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/hello-nodejs   1/1     1            1           5m41s

NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/hello-nodejs   ClusterIP   10.96.113.106   <none>        8080/TCP   5m41s

NAME                                     CLASS   HOSTS                                            ADDRESS           PORTS     AGE
ingress.networking.k8s.io/hello-nodejs   nginx   hello-nodejs-demo.stg.192-168-228-200.sslip.io   192.168.228.201   80, 443   5m41s
```

Nginx Ingressã‚’çµŒç”±ã—ãŸRoutingã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€æ¬¡ã®ã‚ˆã†ã«hostnameã‚’å¤‰æ›´ã—ã¾ã™ã€‚


```yaml
cat <<EOF > hello-nodejs-values.yaml
workload_name: hello-nodejs
hostname: hello-nodejs-demo.stg.192-168-228-201.sslip.io
EOF
```

æ–°ã—ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§åæ˜ ã—ã¾ã™ã€‚

```
tanzu package installed update -n demo hello-nodejs --values-file hello-nodejs-values.yaml
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Ingressã®hostnameãŒæ›´æ–°ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ kubectl get pkgi,deploy,svc,ing -n demo 
NAME                                               PACKAGE NAME            PACKAGE VERSION                    DESCRIPTION           AGE
packageinstall.packaging.carvel.dev/hello-nodejs   hello-nodejs.demo.tap   20230811081306.0.0+build.fde413c   Reconcile succeeded   6m26s

NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/hello-nodejs   1/1     1            1           6m23s

NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/hello-nodejs   ClusterIP   10.96.113.106   <none>        8080/TCP   6m23s

NAME                                     CLASS   HOSTS                                            ADDRESS           PORTS     AGE
ingress.networking.k8s.io/hello-nodejs   nginx   hello-nodejs-demo.stg.192-168-228-201.sslip.io   192.168.228.201   80, 443   6m23s
```

æ–°ã—ã„hostnameã‚’ä½¿ã£ã¦ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

```
$ curl -k https://hello-nodejs-demo.stg.192-168-228-201.sslip.io
Hello World!!
```

Carvel Package Supply Chainã‚’ä½¿ã†ã¨å®Ÿè¡Œç’°å¢ƒ(Runã‚¯ãƒ©ã‚¹ã‚¿)æ¯ã«ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰ãˆã‚‰ã‚Œã‚‹ã“ã¨ã‚’è©¦ã›ã¾ã—ãŸã€‚
TAP 1.6æ™‚ç‚¹ã§ã¯ã€å®Ÿè¡Œç’°å¢ƒã®è¨­å®šãŒå°‘ã—ç…©é›‘ã«æ„Ÿã˜ã¾ã™ã€‚

---

`type=server`ã§ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸå ´åˆã«ã€Ingressã§ã‚¢ãƒ—ãƒªã‚’å…¬é–‹ã—ãŸã„å ´åˆã®3ã¤ã®æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

* `kubectl`ã§ç›´æ¥Ingressãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹
* OOTB SupplyChainã§ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«Ingressã‚’è¿½åŠ ã™ã‚‹
* Carvel Package Supply Chainã‚’ä½¿ç”¨ã™ã‚‹

TAP 1.6æ™‚ç‚¹ã§ã¯ã€ã©ã‚Œã‚‚ä¸€é•·ä¸€çŸ­ã§ã™ã€‚Carvel Package Supply ChainãŒGAã«ãªã‚Œã°ã€ã“ã‚ŒãŒä¸€ç•ªã„ã„é¸æŠã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
ç¾æ™‚ç‚¹ã§ã¯`kubectl`ã§ç›´æ¥Ingressãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã‹ã€OOTB SupplyChainã§ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«Ingressã‚’è¿½åŠ ã™ã‚‹ã®ãŒç¾å®Ÿçš„ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚