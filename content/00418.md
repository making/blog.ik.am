---
title: ã¯ã˜ã‚ã¦ã®Spring WebFlux (ãã®1.5 - Spring Bootã‚’ä½¿ã‚ãšSpring WebFluxã‚’ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§Bootstrap)
tags: ["Reactor", "Reactor Netty", "Netty", "Spring 5", "Spring WebFlux", "Java"]
categories: ["Programming", "Java", "org", "springframework", "web", "reactive"]
---

[ã¯ã˜ã‚ã¦ã®Spring WebFlux (ãã®1 - Spring WebFluxã‚’è©¦ã™)](https://blog.ik.am/entries/417)ã§ã¯Spring Boot 2.0ã‚’ä½¿ç”¨ã—ã¦Spring WebFluxã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸãŒã€ä»Šå›ã¯ç•ªå¤–ç·¨ã¨ã—ã¦Spring WebFluxã‚’ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§Bootstrapã—ã¦ã¿ã¾ã™ã€‚
æ–¹æ³•ã¯[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](http://docs.spring.io/spring/docs/5.0.0.RC1/spring-framework-reference/web.html#web-reactive-getting-started-manual)ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®@Controllerãƒ¢ãƒ‡ãƒ«ã§ã‚‚é–¢æ•°å‹ãƒ™ãƒ¼ã‚¹ã®Router Functionsãƒ¢ãƒ‡ãƒ«ã§ã‚‚`org.springframework.http.server.reactive.HttpHandler`ã«å¤‰æ›ã™ã‚‹ã¨ã“ã‚ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚
`HttpHandler`ã«å¤‰æ›ã—ãŸå¾Œã¯å„ç¨®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®ã‚¢ãƒ€ãƒ—ã‚¿ã«æ¸¡ã—ã¦ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’å®Ÿè¡Œã™ã‚‹æµã‚Œã«ãªã‚Šã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯Router Functionsãƒ¢ãƒ‡ãƒ«ã§Reactor Nettyãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ä½¿ã†æ–¹æ³•ã®ã¿ç´¹ä»‹ã—ã¾ã™ã€‚

**ç›®æ¬¡**
<!-- toc -->


### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

Spring Bootã‚’ä½¿ã‚ãªã„ã¨è¨€ã„ã¾ã—ãŸãŒã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ã¯Spring Initializrã‹ã‚‰ä½œæˆã—ãŸæ–¹ãŒæ¥½ã§ã™ã€‚Spring Initializrã®é››å½¢ã‚¯ãƒ©ã‚¹ã‹ã‚‰ä¸è¦ãªã‚‚ã®ã‚’å‰Šé™¤ã—ã¦ã„ãã¾ã™ã€‚

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```
curl https://start.spring.io/starter.tgz \
       -d bootVersion=2.0.0.BUILD-SNAPSHOT \
       -d artifactId=manual-webflux \
       -d baseDir=manual-webflux \
       -d dependencies=webflux \
       -d applicationName=ManualWebFluxApplication | tar -xzvf -
```

ã¾ãšã¯å‰è¨˜äº‹ã¨åŒã˜ãSpring Bootã§Router Functionsã®Hello Worldã‹ã‚‰å§‹ã‚ã¾ã™ã€‚

`ManualWebFluxApplication.java`ã«æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

``` java
package com.example;

import static org.springframework.web.reactive.function.server.RequestPredicates.GET;
import static org.springframework.web.reactive.function.server.RouterFunctions.route;
import static org.springframework.web.reactive.function.server.ServerResponse.ok;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.web.reactive.function.server.RouterFunction;
import org.springframework.web.reactive.function.server.ServerResponse;

@SpringBootApplication
public class ManualWebFluxApplication {

	public static void main(String[] args) {
		SpringApplication.run(ManualWebFluxApplication.class, args);
	}

	@Bean
	RouterFunction<ServerResponse> routes() {
		return route(GET("/"), req -> ok().syncBody("Hello World!"));
	}
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã®æ„å‘³ãŒã‚ã‹ã‚‰ãªã‘ã‚Œã°[ã¯ã˜ã‚ã¦ã®Spring WebFlux (ãã®1 - Spring WebFluxã‚’è©¦ã™)](https://blog.ik.am/entries/417)ã‚’èª­ã¿ç›´ã—ã¦ãã ã•ã„ã€‚

æ¬¡ã«`RouterFunction<ServerResponse>`ã‚’`HttpHandler`ã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯`RouterFunctions.toHttpHandler`ã‚’ä½¿ãˆã°ç°¡å˜ã§ã™ã€‚

ä¸€æ—¦ã€`ManualWebFluxApplication`ã‹ã‚‰Spring Booté–¢é€£ã®ã‚³ãƒ¼ãƒ‰ã‚’å‰Šã‚Šã€`HttpHandler`ã‚’ä½œã‚‹ã¨ã“ã‚ã¾ã§æ›¸ãã¾ã™ã€‚

``` java
package com.example;

import static org.springframework.web.reactive.function.server.RequestPredicates.GET;
import static org.springframework.web.reactive.function.server.RouterFunctions.route;
import static org.springframework.web.reactive.function.server.ServerResponse.ok;

import org.springframework.http.server.reactive.HttpHandler;
import org.springframework.web.reactive.function.server.RouterFunction;
import org.springframework.web.reactive.function.server.RouterFunctions;
import org.springframework.web.reactive.function.server.ServerResponse;

public class ManualWebFluxApplication {

	public static void main(String[] args) {
		HttpHandler httpHandler = RouterFunctions.toHttpHandler(routes());
	}

	static RouterFunction<ServerResponse> routes() {
		return route(GET("/"), req -> ok().syncBody("Hello World!"));
	}
}
```

ã“ã“ã¾ã§ã¯Spring WebFluxã®ä¸–ç•Œã§ã™ã€‚

æ¬¡ã¯Reactor Nettyã®ä¸–ç•Œã«ç§»ã‚Šã¾ã™ã€‚`HttpHandler`ã‹ã‚‰Reactor Nettyã®ãƒãƒ³ãƒ‰ãƒ©ã«å¤‰æ›ã—ã¦ã€Reactor Nettyã®Webã‚µãƒ¼ãƒãƒ¼æ©Ÿèƒ½ã‚’æ‹…ã†`HttpServer`ã«æ¸¡ã—ã¾ã™ã€‚
`HttpHandler`ã‹ã‚‰Reactor Nettyã®ãƒãƒ³ãƒ‰ãƒ©ã¸ã®å¤‰æ›ã¯`org.springframework.http.server.reactive.ReactorHttpHandlerAdapter`ã‚’åš™ã¾ã™ã®ã¿ã§ã™ã€‚

``` java
package com.example;

import static org.springframework.web.reactive.function.server.RequestPredicates.GET;
import static org.springframework.web.reactive.function.server.RouterFunctions.route;
import static org.springframework.web.reactive.function.server.ServerResponse.ok;

import org.springframework.http.server.reactive.HttpHandler;
import org.springframework.http.server.reactive.ReactorHttpHandlerAdapter;
import org.springframework.web.reactive.function.server.RouterFunction;
import org.springframework.web.reactive.function.server.RouterFunctions;
import org.springframework.web.reactive.function.server.ServerResponse;

import reactor.core.publisher.Mono;
import reactor.ipc.netty.NettyContext;
import reactor.ipc.netty.http.server.HttpServer;

public class ManualWebFluxApplication {

	public static void main(String[] args) {
		HttpHandler httpHandler = RouterFunctions.toHttpHandler(routes());

		HttpServer httpServer = HttpServer.create("0.0.0.0", 8080);
		Mono<? extends NettyContext> handler = httpServer
				.newHandler(new ReactorHttpHandlerAdapter(httpHandler));
	}

	static RouterFunction<ServerResponse> routes() {
		return route(GET("/"), req -> ok().syncBody("Hello World!"));
	}
}
```

æœ€å¾Œã«Webã‚µãƒ¼ãƒãƒ¼ã®å¾…æ©Ÿã¨çµ‚äº†å¾…ã¡åˆã‚ã›ã®ãŸã‚ã«Nettyã®ä¸–ç•Œã«å…¥ã‚Šã¾ã™ã€‚


``` java
package com.example;

import static org.springframework.web.reactive.function.server.RequestPredicates.GET;
import static org.springframework.web.reactive.function.server.RouterFunctions.route;
import static org.springframework.web.reactive.function.server.ServerResponse.ok;

import org.springframework.http.server.reactive.HttpHandler;
import org.springframework.http.server.reactive.ReactorHttpHandlerAdapter;
import org.springframework.web.reactive.function.server.RouterFunction;
import org.springframework.web.reactive.function.server.RouterFunctions;
import org.springframework.web.reactive.function.server.ServerResponse;

import io.netty.channel.Channel;
import reactor.core.publisher.Mono;
import reactor.ipc.netty.NettyContext;
import reactor.ipc.netty.http.server.HttpServer;

public class ManualWebFluxApplication {

	public static void main(String[] args) throws Exception {
		HttpHandler httpHandler = RouterFunctions.toHttpHandler(routes());

		HttpServer httpServer = HttpServer.create("0.0.0.0", 8080);
		Mono<? extends NettyContext> handler = httpServer
				.newHandler(new ReactorHttpHandlerAdapter(httpHandler));

		Channel channel = handler.block().channel();
		Runtime.getRuntime().addShutdownHook(new Thread(() -> {
			try {
				channel.eventLoop().shutdownGracefully().sync();
			}
			catch (InterruptedException ignore) {
			}
		}));
		channel.closeFuture().sync();
	}

	static RouterFunction<ServerResponse> routes() {
		return route(GET("/"), req -> ok().syncBody("Hello World!"));
	}
}
```

å¾Œã¯`src/main/resource/application.properties`ã‚’å‰Šé™¤ã—ã¦ã€ãŠå¥½ã¿ã§`logback.xml`ã‚’ä½œã£ã¦ãã ã•ã„ã€‚

ã‚µãƒ³ãƒ—ãƒ«ã‚’è²¼ã£ã¦ãŠãã¾ã™ã€‚

``` xml
<configuration>
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %5p --- [%15.15t] %-40.40logger{39} : %m%n</pattern>
        </encoder>
    </appender>
    <root level="INFO">
        <appender-ref ref="STDOUT"/>
    </root>
    <logger name="reactor.ipc.netty" level="DEBUG"/>
</configuration>
```

ã“ã‚Œã§`ManualWebFluxApplication`ã‚’å†èµ·å‹•ã—ã¦ã€[http://localhost:8080](http://localhost:8080)ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚

æ¬¡ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚

```
2017-05-10 04:07:37.873 DEBUG --- [           main] r.i.n.r.DefaultLoopEpollDetector         : Default epoll support : false
2017-05-10 04:07:37.962 DEBUG --- [           main] r.i.n.channel.CloseableContextHandler    : Connecting new channel: AbstractBootstrap$PendingRegistrationPromise@61d6015a(incomplete)
2017-05-10 04:07:37.978 DEBUG --- [ctor-http-nio-1] r.ipc.netty.http.server.HttpServer       : [id: 0xa7ca25f3] REGISTERED
2017-05-10 04:07:37.980 DEBUG --- [ctor-http-nio-1] r.ipc.netty.http.server.HttpServer       : [id: 0xa7ca25f3] BIND: /0.0.0.0:8080
2017-05-10 04:07:38.036 DEBUG --- [ctor-http-nio-1] r.ipc.netty.http.server.HttpServer       : [id: 0xa7ca25f3, L:/0:0:0:0:0:0:0:0:8080] ACTIVE
2017-05-10 04:07:44.686 DEBUG --- [ctor-http-nio-1] r.ipc.netty.http.server.HttpServer       : [id: 0xa7ca25f3, L:/0:0:0:0:0:0:0:0:8080] READ: [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362]
2017-05-10 04:07:44.687 DEBUG --- [ctor-http-nio-1] r.ipc.netty.http.server.HttpServer       : [id: 0xa7ca25f3, L:/0:0:0:0:0:0:0:0:8080] READ COMPLETE
2017-05-10 04:07:44.727 DEBUG --- [ctor-http-nio-2] r.i.n.http.server.HttpServerOperations   : New http connection, requesting read
2017-05-10 04:07:44.729 DEBUG --- [ctor-http-nio-2] r.ipc.netty.channel.ContextHandler       : After pipeline DefaultChannelPipeline{(reactor.left.loggingHandler = io.netty.handler.logging.LoggingHandler), (ServerContextHandler#0 = reactor.ipc.netty.channel.ServerContextHandler), (reactor.left.httpDecoder = io.netty.handler.codec.http.HttpRequestDecoder), (reactor.left.httpEncoder = io.netty.handler.codec.http.HttpResponseEncoder), (reactor.left.httpServerHandler = reactor.ipc.netty.http.server.HttpServerHandler), (reactor.right.reactiveBridge = reactor.ipc.netty.channel.ChannelOperationsHandler)}
2017-05-10 04:07:44.729 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] REGISTERED
2017-05-10 04:07:44.729 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] ACTIVE
2017-05-10 04:07:44.740 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] READ: 78B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 47 45 54 20 2f 20 48 54 54 50 2f 31 2e 31 0d 0a |GET / HTTP/1.1..|
|00000010| 48 6f 73 74 3a 20 6c 6f 63 61 6c 68 6f 73 74 3a |Host: localhost:|
|00000020| 38 30 38 30 0d 0a 55 73 65 72 2d 41 67 65 6e 74 |8080..User-Agent|
|00000030| 3a 20 63 75 72 6c 2f 37 2e 34 33 2e 30 0d 0a 41 |: curl/7.43.0..A|
|00000040| 63 63 65 70 74 3a 20 2a 2f 2a 0d 0a 0d 0a       |ccept: */*....  |
+--------+-------------------------------------------------+----------------+
2017-05-10 04:07:44.750 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] READ COMPLETE
2017-05-10 04:07:44.751 DEBUG --- [ctor-http-nio-2] r.ipc.netty.channel.ChannelOperations    : [HttpServer] [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] handler is being applied: org.springframework.http.server.reactive.ReactorHttpHandlerAdapter@14c85872
2017-05-10 04:07:44.802 DEBUG --- [ctor-http-nio-2] r.i.n.channel.ChannelOperationsHandler   : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] Writing object DefaultHttpResponse(decodeResult: success, version: HTTP/1.1)
HTTP/1.1 200 OK
transfer-encoding: chunked
Content-Type: text/plain;charset=UTF-8
2017-05-10 04:07:44.810 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] WRITE: 87B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 48 54 54 50 2f 31 2e 31 20 32 30 30 20 4f 4b 0d |HTTP/1.1 200 OK.|
|00000010| 0a 74 72 61 6e 73 66 65 72 2d 65 6e 63 6f 64 69 |.transfer-encodi|
|00000020| 6e 67 3a 20 63 68 75 6e 6b 65 64 0d 0a 43 6f 6e |ng: chunked..Con|
|00000030| 74 65 6e 74 2d 54 79 70 65 3a 20 74 65 78 74 2f |tent-Type: text/|
|00000040| 70 6c 61 69 6e 3b 63 68 61 72 73 65 74 3d 55 54 |plain;charset=UT|
|00000050| 46 2d 38 0d 0a 0d 0a                            |F-8....         |
+--------+-------------------------------------------------+----------------+
2017-05-10 04:07:44.811 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] FLUSH
2017-05-10 04:07:44.814 DEBUG --- [ctor-http-nio-2] r.i.n.channel.ChannelOperationsHandler   : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] Writing object { "operator" : "Map" }
2017-05-10 04:07:44.817 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] WRITE: 3B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 0d 0a                                        |c..             |
+--------+-------------------------------------------------+----------------+
2017-05-10 04:07:44.818 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] WRITE: 12B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 48 65 6c 6c 6f 20 57 6f 72 6c 64 21             |Hello World!    |
+--------+-------------------------------------------------+----------------+
2017-05-10 04:07:44.819 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] WRITE: 2B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 0d 0a                                           |..              |
+--------+-------------------------------------------------+----------------+
2017-05-10 04:07:44.819 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] FLUSH
2017-05-10 04:07:44.821 DEBUG --- [ctor-http-nio-2] r.i.n.http.server.HttpServerOperations   : Last HTTP response frame
2017-05-10 04:07:44.822 DEBUG --- [ctor-http-nio-2] r.i.n.channel.ChannelOperationsHandler   : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] Writing object EmptyLastHttpContent
2017-05-10 04:07:44.822 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] WRITE: 5B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 30 0d 0a 0d 0a                                  |0....           |
+--------+-------------------------------------------------+----------------+
2017-05-10 04:07:44.822 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] FLUSH
2017-05-10 04:07:44.824 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] USER_EVENT: [Handler Terminated]
2017-05-10 04:07:44.826 DEBUG --- [ctor-http-nio-2] r.i.n.channel.ChannelOperationsHandler   : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] Disposing context reactor.ipc.netty.channel.ServerContextHandler@5286385e
2017-05-10 04:07:44.826 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:60362] READ COMPLETE
2017-05-10 04:07:44.829 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 ! R:/0:0:0:0:0:0:0:1:60362] INACTIVE
2017-05-10 04:07:44.829 DEBUG --- [ctor-http-nio-2] r.ipc.netty.http.server.HttpServer       : [id: 0x8a9527a1, L:/0:0:0:0:0:0:0:1:8080 ! R:/0:0:0:0:0:0:0:1:60362] UNREGISTERED
```

å¾Œã¯`pom.xml`ã‚’æ•´ç†ã—ã¾ã—ã‚‡ã†ã€‚åŸºæœ¬çš„ã«ã¯æ¬¡ã®`<dependency>`ã ã‘ã§ã™ã¿ã¾ã™ã€‚

``` xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.example</groupId>
    <artifactId>manual-webflux</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <packaging>jar</packaging>

    <name>demo</name>
    <description>Demo project for Spring Boot</description>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.0.0.BUILD-SNAPSHOT</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
        <java.version>1.8</java.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-context</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-webflux</artifactId>
        </dependency>
        <dependency>
            <groupId>ch.qos.logback</groupId>
            <artifactId>logback-classic</artifactId>
        </dependency>
        <dependency>
            <groupId>io.projectreactor.ipc</groupId>
            <artifactId>reactor-netty</artifactId>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

    <repositories>
        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
        <repository>
            <id>spring-milestones</id>
            <name>Spring Milestones</name>
            <url>https://repo.spring.io/milestone</url>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
    </repositories>

    <pluginRepositories>
        <pluginRepository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </pluginRepository>
        <pluginRepository>
            <id>spring-milestones</id>
            <name>Spring Milestones</name>
            <url>https://repo.spring.io/milestone</url>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </pluginRepository>
    </pluginRepositories>


</project>
```

ã“ã‚Œã§`ManualWebFluxApplication`ã‚’å†èµ·å‹•ã—ã€åŒã˜ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

ã“ã‚Œã§æœ€å°é™ã®Spring WebFluxã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç«‹ã¡ä¸ŠãŒã‚Šã¾ã—ãŸã€‚ã‹ãªã‚Šãƒ¡ãƒ¢ãƒªãƒ•ãƒƒãƒˆãƒ—ãƒªãƒ³ãƒˆã‚’å°ã•ãæŠ‘ãˆã‚‰ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

å‹˜ã®è‰¯ã„äººã¯æ°—ã¥ã„ãŸã¨æ€ã„ã¾ã™ãŒã€ã“ã“ã¾ã§Springã®DIã‚³ãƒ³ãƒ†ãƒŠã§ã‚ã‚‹`ApplicationContext`ã‚’ä½¿ã£ã¦ã„ã¾ã›ã‚“(!)ã€‚
Spring WebFlux + RouterFunctionsã®å ´åˆã¯DIã‚³ãƒ³ãƒ†ãƒŠãªã—ã§ã‚‚èµ·å‹•ã—ã¾ã™ã€‚

å‰è¨˜äº‹åŒæ§˜ã«DIã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã£ã¦`RouterFunctions`ã‚’Beanå®šç¾©ã™ã‚‹æ–¹æ³•ã‚’æ¬¡ã«è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### Annotationãƒ™ãƒ¼ã‚¹ã®Beanå®šç¾©

[ã¯ã˜ã‚ã¦ã®Spring WebFlux (ãã®1 - Spring WebFluxã‚’è©¦ã™)](https://blog.ik.am/entries/417)ã§ä½œæˆã—ãŸæ¬¡ã®`EchoHandler`ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

``` java
package com.example;

import static org.springframework.web.reactive.function.server.RequestPredicates.GET;
import static org.springframework.web.reactive.function.server.RouterFunctions.route;
import static org.springframework.web.reactive.function.server.ServerResponse.ok;

import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.server.RouterFunction;
import org.springframework.web.reactive.function.server.ServerRequest;
import org.springframework.web.reactive.function.server.ServerResponse;

import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

@Component
public class HelloHandler {

    public RouterFunction<ServerResponse> routes() {
        return route(GET("/"), this::hello);
    }

    Mono<ServerResponse> hello(ServerRequest req) {
        return ok().body(Flux.just("Hello", "World!"), String.class);
    }
}
```

ä»Šå›ã¯`ManualWebFluxApplication`ã‚¯ãƒ©ã‚¹ã‚’JavaConfigã‚¯ãƒ©ã‚¹ã¨ã—ã¦ä½¿ã„ã¾ã™ã€‚ãªã®ã§ã€`ManualWebFluxApplication`ã«`@Configuration`ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¾ã™ [1]ã€‚ã¾ãŸã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¹ã‚­ãƒ£ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã«`ManualWebFluxApplication`ã«`@ComponentScan`ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¾ã™ [2]ã€‚ã“ã‚Œã§ã€`com.example`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸é…ä¸‹ãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ã«ãªã‚Šã¾ã™ã€‚

DIã‚³ãƒ³ãƒ†ãƒŠã§ã‚ã‚‹`ApplicationContext`ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã“ã§ã¯æ±ç”¨çš„ãª`GenericApplicationContext`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãƒ«ãƒ¼ãƒˆã¨ãªã‚‹JavaConfigã¯`AnnotationConfigApplicationContext`ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«æ¸¡ã›ã°è‰¯ã„ã§ã™ [3]ã€‚

`ApplicationContext`ã‚’ä½¿ã†å ´åˆã¯ã€`HttpHandler`ã‚’`WebHttpHandlerBuilder`ã§ä½œæˆã§ãã¾ã™ [4]ã€‚ã“ã®å ´åˆã€Router Functionsã‚’ä½¿ã†ã«ã¯DIã‚³ãƒ³ãƒ†ãƒŠã«ã¯BeanåãŒ`webHandler`ã§ã‚ã‚‹`org.springframework.web.server.WebHandler`å‹ã®BeanãŒç™»éŒ²ã•ã‚Œã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`RouterFunction<ServerResponse>`ã‹ã‚‰`WebHandler`ã«å¤‰æ›ã™ã‚‹éš›ã«ã‚‚`RouterFunctions.toHttpHandler`ãŒä½¿ãˆã¾ã™ã€‚ã“ã‚Œã‚’`@Bean`ã®ã¤ã„ãŸãƒ¡ã‚½ãƒƒãƒ‰ã§å®šç¾©ã—ã¾ã™ [5]ã€‚

(å®Ÿã¯`RouterFunctions.toHttpHandler`ã¯`HttpHandler`å…¼`WebHandler`ã§ã‚ã‚‹`org.springframework.web.server.adapter.HttpWebHandlerAdapter`ã‚’è¿”ã—ã¾ã™)

``` java
package com.example;

import org.springframework.context.annotation.AnnotationConfigApplicationContext;
import org.springframework.context.support.GenericApplicationContext;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.server.reactive.HttpHandler;
import org.springframework.http.server.reactive.ReactorHttpHandlerAdapter;
import org.springframework.web.reactive.function.server.RouterFunctions;
import org.springframework.web.server.WebHandler;
import org.springframework.web.server.adapter.WebHttpHandlerBuilder;

import io.netty.channel.Channel;
import reactor.core.publisher.Mono;
import reactor.ipc.netty.NettyContext;
import reactor.ipc.netty.http.server.HttpServer;

@Configuration // [1]
@ComponentScan // [2]
public class ManualWebFluxApplication {

	public static void main(String[] args) throws Exception {

		// [3]
		GenericApplicationContext context = new AnnotationConfigApplicationContext(
				ManualWebFluxApplication.class);
		context.registerShutdownHook();

		// [4]
		HttpHandler httpHandler = WebHttpHandlerBuilder.applicationContext(context)
				.build();

		HttpServer httpServer = HttpServer.create("0.0.0.0", 8080);
		Mono<? extends NettyContext> handler = httpServer
				.newHandler(new ReactorHttpHandlerAdapter(httpHandler));

		Channel channel = handler.block().channel();
		Runtime.getRuntime().addShutdownHook(new Thread(() -> {
			try {
				channel.eventLoop().shutdownGracefully().sync();
			}
			catch (InterruptedException ignore) {
				ignore.printStackTrace();
			}
		}));
		channel.closeFuture().sync();
	}

	// [5]
	@Bean
	WebHandler webHandler(HelloHandler helloHandler) {
		return RouterFunctions.toHttpHandler(helloHandler.routes());
	}
}
```
ã“ã‚Œã§`ManualWebFluxApplication`ã‚’å†èµ·å‹•ã—ã¦ã€[http://localhost:8080](http://localhost:8080)ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°HelloWorld!ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚


ä»¥é™ã€`HelloHandler`ã®ä½œã‚Šæ–¹ã¯æ™®é€šã®Springã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨åŒã˜ã§ã™ã€‚

### FunctionalãªBeanå®šç¾©

ä»Šåº¦ã¯Spring 5ã§å°å…¥ã•ã‚ŒãŸFunctional Bean Registrationã‚’ä½¿ã„ã€ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸€åˆ‡ä½¿ã‚ãšã€Functionalãªæ–¹æ³•ã§Beanå®šç¾©ã—ã¾ã™ã€‚

ã¾ãšã¯`EchoController`ã‹ã‚‰`@Controller`ã‚’å¤–ã—ã¾ã™ã€‚

``` java
package com.example;

import static org.springframework.web.reactive.function.server.RequestPredicates.GET;
import static org.springframework.web.reactive.function.server.RouterFunctions.route;
import static org.springframework.web.reactive.function.server.ServerResponse.ok;

import org.springframework.web.reactive.function.server.RouterFunction;
import org.springframework.web.reactive.function.server.ServerRequest;
import org.springframework.web.reactive.function.server.ServerResponse;

import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

public class HelloHandler {

    public RouterFunction<ServerResponse> routes() {
        return route(GET("/"), this::hello);
    }

    Mono<ServerResponse> hello(ServerRequest req) {
        return ok().body(Flux.just("Hello", "World!"), String.class);
    }
}
```

æ¬¡ã«ã„ã‚ˆã„ã‚ˆFunctional Bean Registrationã‚’è¡Œã„ã¾ã™ã€‚`@Configuration`ã€`@ComponentScan`ã€`@Bean`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã‚‚ã†å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

Beanå®šç¾©ã¯`GenericApplicationContext#registerBean(Class<T>, Supplier<T>, org.springframework.beans.factory.config.BeanDefinitionCustomizer...)`ãƒ¡ã‚½ãƒƒãƒ‰ã§è¡Œãˆã¾ã™ã€‚

`HelloHandler`ã¨`WebHandler`ã‚’`register(Class<T>, Supplier<T>)`ã§å®šç¾©ã—ã¦ã€`GenericApplicationContext `ã‚’`refresh`ã™ã‚Œã°DIã‚³ãƒ³ãƒ†ãƒŠä½œæˆå®Œäº†ã§ã™ã€‚

``` java
package com.example;

import org.springframework.context.annotation.AnnotationConfigApplicationContext;
import org.springframework.context.support.GenericApplicationContext;
import org.springframework.http.server.reactive.HttpHandler;
import org.springframework.http.server.reactive.ReactorHttpHandlerAdapter;
import org.springframework.web.reactive.function.server.RouterFunctions;
import org.springframework.web.server.WebHandler;
import org.springframework.web.server.adapter.WebHttpHandlerBuilder;

import io.netty.channel.Channel;
import reactor.core.publisher.Mono;
import reactor.ipc.netty.NettyContext;
import reactor.ipc.netty.http.server.HttpServer;

public class ManualWebFluxApplication {

	public static void main(String[] args) throws Exception {

		GenericApplicationContext context = new AnnotationConfigApplicationContext();
		context.registerBean(HelloHandler.class, HelloHandler::new); // context.registerBean(HelloHandler.class)ã§ã‚‚OK
		context.registerBean(WebHandler.class, () -> RouterFunctions
				.toHttpHandler(context.getBean(HelloHandler.class).routes()));
		context.refresh();

		context.registerShutdownHook();

		HttpHandler httpHandler = WebHttpHandlerBuilder.applicationContext(context)
				.build();

		HttpServer httpServer = HttpServer.create("0.0.0.0", 8080);
		Mono<? extends NettyContext> handler = httpServer
				.newHandler(new ReactorHttpHandlerAdapter(httpHandler));

		Channel channel = handler.block().channel();
		Runtime.getRuntime().addShutdownHook(new Thread(() -> {
			try {
				channel.eventLoop().shutdownGracefully().sync();
			}
			catch (InterruptedException ignore) {
				ignore.printStackTrace();
			}
		}));
		channel.closeFuture().sync();
	}
}

```

ã“ã‚Œã§`ManualWebFluxApplication`ã‚’å†èµ·å‹•ã—ã¦ã€[http://localhost:8080](http://localhost:8080)ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°HelloWorld!ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
Spring Bootã‚‚ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§Springã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒä½œã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸğŸ™Œ

----

æœ¬è¨˜äº‹ã§ã¯Spring WebFluxã®ç•ªå¤–ç·¨ã¨ã—ã¦Spring Bootã‚’ä½¿ã‚ãªã„æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã—ãŸã€‚å¤šåˆ†æ•°åMBå‰å¾Œã®ãƒ’ãƒ¼ãƒ—ã§ã‚‚å‹•ä½œã™ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ã¨ã¯ã„ãˆæ™®æ®µã¯Spring Boot 2.0ã§WebFluxã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›¸ãã“ã¨ã«ãªã‚‹ã§ã—ã‚‡ã†ãŒã€
éŠã³ã§ã‚‚ã€ä¸­èº«ã‚’çŸ¥ã‚‹ä¸Šã§ã‚‚ãƒãƒ‹ãƒ¥ã‚¢ãƒ«èµ·å‹•ã®æ–¹æ³•ã‚’çŸ¥ã£ã¦ã„ãŠãã“ã¨ã¯ãŸã‚ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

æ¬¡å›ã¯æœ¬ç·šã«æˆ»ã£ã¦ã€`WebClient`ã¨ãƒ†ã‚¹ãƒˆã‚µãƒãƒ¼ãƒˆã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚
