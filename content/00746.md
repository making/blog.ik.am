---
title: Docker Desktop for Macä»£æ›¿ã®OrbStackãŒã™ã”ã„
tags: ["Docker", "OrbStack", "kind", "MetalLB"]
categories: ["Dev", "Infrastructure", "Docker", "OrbStack"]
---

OrbStackã¯è»½é‡ãƒ»é«˜é€Ÿã‚’è¬³ã†Docker Desktop for Macã®ä»£æ›¿ã§ã™ã€‚
drop-in replacementã§ã‚ã‚Šã€Docker Desktop for Macã¨åŒã˜ã`docker`ã‚³ãƒãƒ³ãƒ‰ãŒä½¿ãˆã¾ã™ã€‚

https://orbstack.dev/


* ãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»ãŒå°‘ãªã„ & èµ·å‹•ãŒé€Ÿã„
* Dockerã ã‘ã§ãªãLinux Machineã‚‚ä½¿ãˆã‚‹
* Macã®ãƒ›ã‚¹ãƒˆã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠ/Linux Machineã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹(!)


è‡ªåˆ†ã¯Docker Desktopã®CPUä½¿ç”¨ç‡ã®é«˜ã•ãŒå«Œã§ã—ãŸã€‚Docker Desktopã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ã€LaptopãŒç†±ã‹ã£ãŸã§ã™ã€‚ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã‚ãªã„ã¨ãã¯ã‚ã–ã‚ã–Docker Desktopã‚’çµ‚äº†ã—ã¦ã„ã¾ã—ãŸã€‚
ãã“ã§è»½é‡ãªOrbStackãŒæ°—ã«ãªã‚Šã€ä¹—ã‚Šæ›ãˆã¦ã¿ã¾ã—ãŸã€‚Docker Desktopã«æ¯”ã¹ã‚‹ã¨ç¢ºã‹ã«ãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»é‡ãŒå°‘ãªãã€å¿«é©ã«ä½¿ãˆã¦ã„ã¾ã™ã€‚

OrbStackã®Webã‚µã‚¤ãƒˆã§ã¯CPUä½¿ç”¨ç‡ã®æ¯”è¼ƒãŒæ¬¡ã®ã‚ˆã†ã«ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

<img width="1013" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/4b5b23fa-a010-4a31-95ca-9159695c0fa7">

å®Ÿéš›ã®OrbStackã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

<img width="831" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/d8c5735e-3b66-4afc-bba0-6f531176c07b">

Docker Desktopã¯ã‚‚ã†é–‹ããŸããªã„ã®ã§ã€æ¯”è¼ƒã¯ã—ã¦ã„ã¾ã›ã‚“ã€‚


ãã—ã¦ã€å…ˆæ—¥ã€Macãƒ›ã‚¹ãƒˆã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã®IPã«ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã¯Docker Desktop for Macã§ã¯åˆ¶ç´„ã¨ã—ã¦ã§ããªã‹ã£ãŸã“ã¨ã§ã™ã€‚

https://github.com/orbstack/orbstack/issues/33


ã“ã‚Œã¯Docker Desktopã«å¯¾ã™ã‚‹killer featureã¨è¨€ãˆã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚ã“ã®æ©Ÿèƒ½ã¯OrbStack 0.12ã§è¿½åŠ ã•ã‚Œã‚‹äºˆå®šã§ã€~è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã§ã®æœ€æ–°0.11ã§ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“~ 0.12ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸğŸ‰ã€‚
ä¸Šè¨˜ã®issueã«RCç‰ˆã®ãƒªãƒ³ã‚¯ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã®æ©Ÿèƒ½ã‚’å…ˆè¡Œã§è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚³ãƒ³ãƒ†ãƒŠã®IPã«ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã¨[Kindã§MetalLBã‚’ä½¿ã£ã¦](https://kind.sigs.k8s.io/docs/user/loadbalancer/)Type=LoadBalancerã§å…¬é–‹ã—ãŸk8sã®Serviceã«Macã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
ä»Šã¾ã§ã“ã‚ŒãŒã§ããªã‹ã£ãŸãŸã‚ã€Kindä¸Šã®ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ã€port-forwardã‚’ä½¿ã„ã€Ingressã‚’çµŒç”±ã™ã‚‹ãªã©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚
è¤‡æ•°ã®Ingress Controllerã‚’ä½¿ã„ãŸã„ã¨ã‹ã€ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã‹ã‚‰Ingressã®ãƒ›ã‚¹ãƒˆåã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨è¨€ã£ãŸã“ã¨ãŒå›°é›£ã§ã—ãŸã€‚
OrbStackã‚’ä½¿ã†ã¨ã“ã®å•é¡ŒãŒè§£æ¶ˆã•ã‚Œã¾ã™ã€‚


OrbStackã¯ç¾åœ¨Public Betaç‰ˆã¨ã„ã†ä½ç½®ä»˜ã‘ã§ã€ç„¡æ–™ã§è©¦ã›ã¾ã™ã€‚å°†æ¥çš„ã«ã¯æœ‰å„Ÿã«ãªã‚‹ã¿ãŸã„ã§ã™ã€‚
ã“ã®æ©Ÿèƒ½ã§ã‚ã‚Œã°å€‹äººçš„ã«ã¯ãŠé‡‘ã‚’æ‰•ã£ã¦ã‚‚ä½¿ã„ãŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚


### Installæ–¹æ³•

```
brew install orbstack
```


~0.12.0-rc2ã‚’ä½¿ã†å ´åˆã¯ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰dmgãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦ãã ã•ã„~ã€‚ 0.12ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸğŸ‰<br>
https://github.com/orbstack/orbstack/issues/33#issuecomment-1589159604


ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨`docker`ã‚³ãƒãƒ³ãƒ‰ã®ä»–ã«`orb`ã‚³ãƒãƒ³ãƒ‰ã‚‚ä½¿ãˆã¾ã™ã€‚ä»¥ä¸‹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§Intellç‰ˆMacã§è©¦ã—ã¦ã„ã¾ã™ã€‚

```
$ orb version
Version: 0.12.0-rc2 (119952)
Commit: 01e4342fe1a0228b3b442be9741d21f33b53213e (v0.12.0-rc2)
```

docker contextã‚’è¦‹ã‚‹ã¨ã€`desktop-linux`ã®ä»–ã«`orbstack`ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚contextã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã§Docker Desktopã«æˆ»ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```
$ docker context ls
NAME            DESCRIPTION                               DOCKER ENDPOINT                                    ERROR
default         Current DOCKER_HOST based configuration   unix:///var/run/docker.sock                        
desktop-linux                                             unix:///Users/toshiaki/.docker/run/docker.sock     
orbstack *      OrbStack                                  unix:///Users/toshiaki/.orbstack/run/docker.sock 
```

default contextã¯æ¬¡ã®ã‚ˆã†ã«OrbStackã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚

```
$ ls -l /var/run/docker.sock
lrwxr-xr-x  1 root  daemon    41B Jun  1 09:16 /var/run/docker.sock -> /Users/toshiaki/.orbstack/run/docker.sock
```


### Dockerã‚³ãƒ³ãƒ†ãƒŠã«ã‚¢ã‚¯ã‚»ã‚¹

å®šç•ªã®Nginxã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚0.12ã‹ã‚‰ã¯ã‚³ãƒ³ãƒ†ãƒŠã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã®ã§ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ãŒä¸è¦ã§ã™ã€‚

```
docker run --rm --name nginx nginx:alpine
```


```
$ docker inspect nginx -f '{{.NetworkSettings.IPAddress}}'
198.19.192.2
```

Macä¸Šã§ã“ã®IPã«å¯¾ã—ã¦ã€curlã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

```
$ curl http://198.19.192.2
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```

ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦Nginxã®Welcomeãƒšãƒ¼ã‚¸ãŒè¿”ã‚Šã¾ã—ãŸ!

Macä¸Šã§ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã›ãšã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦æ„Ÿå‹•ã§ã™ã€‚


### Linux Machineã®ç«‹ã¡ä¸Šã’

OrbStackã§ã¯Dockerã¨ã¯åˆ¥ã«Linux Machineã‚’ç«‹ã¡ä¸Šã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Windowsã®WSLã¿ãŸã„ãªä½¿ã„æ–¹ãŒã§ãã¾ã™ã€‚
è‡ªåˆ†ã¯ã“ã®ã‚ˆã†ãªç”¨é€”ã«ã“ã‚Œã¾ã§[Multipass](https://multipass.run/)ã‚’ä½¿ç”¨ã—ã¦ã„ãŸã®ã§ã™ãŒã€ã“ã‚Œã‚‚ä»£æ›¿ã§ããã†ã§ã™ã€‚


`workspace`ã¨ã„ã†åå‰ã®ubuntu (jammy)ãƒã‚·ãƒ¼ãƒ³ã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚

```
orb create ubuntu:jammy workspace
```

```
$ orb list                         
NAME       STATE    DISTRO  VERSION  ARCH
----       -----    ------  -------  ----
workspace  running  ubuntu  jammy    amd64
```

`orb shell`ã§Linuxãƒã‚·ãƒ¼ãƒ³ã®terminalã‚’æ“ä½œã§ãã¾ã™ã€‚

```
$ orb shell -m workspace
To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

toshiaki@workspace:/Users/toshiaki$ uname -a
Linux workspace 6.3.7-orbstack-00157-g1149ea9805fd #1 SMP Tue Jun 13 06:31:52 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux

toshiaki@workspace:/Users/toshiaki$ ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0@if9: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 9e:29:b3:4a:23:ca brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 198.19.249.112/24 metric 100 brd 198.19.249.255 scope global dynamic eth0
       valid_lft 172696sec preferred_lft 172696sec
    inet6 fd07:b51a:cc66:0:9c29:b3ff:fe4a:23ca/64 scope global mngtmpaddr noprefixroute 
       valid_lft forever preferred_lft forever
    inet6 fe80::9c29:b3ff:fe4a:23ca/64 scope link 
       valid_lft forever preferred_lft forever
```

OrbStack 0.12ã§ã¯Macãƒ›ã‚¹ãƒˆã‹ã‚‰ã“ã®Linuxã®IPã‚‚åˆ°é”ã—ã¾ã™ã€‚


```
$ ping 198.19.249.112
PING 198.19.249.112 (198.19.249.112): 56 data bytes
64 bytes from 198.19.249.112: icmp_seq=0 ttl=64 time=0.604 ms
64 bytes from 198.19.249.112: icmp_seq=1 ttl=64 time=0.250 ms
64 bytes from 198.19.249.112: icmp_seq=2 ttl=64 time=0.290 ms
```

GUIã‹ã‚‰ã‚‚terminalã‚’é–‹ã‘ã‚‹ã®ã§ä¾¿åˆ©ã§ã™ã€‚

<img width="534" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/d7f9469d-6d7b-499d-a7d8-aa42a511b0b0">

### Kindã§MetalLBã‚’ä½¿ç”¨ã™ã‚‹

ã“ã‚Œã¾ã§Macä¸Šã§Kindã‚’ä½¿ã†å ´åˆã€MetalLBã§å…¬é–‹ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã®IPã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

Kindã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (https://kind.sigs.k8s.io/docs/user/loadbalancer/) ã«æ¬¡ã®ã‚ˆã†ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

> On macOS and Windows, docker does not expose the docker network to the host. Because of this limitation, containers (including kind nodes) are only reachable from the host via port-forwards, however other containers/pods can reach other things running in docker including loadbalancers. You may want to check out the Ingress Guide as a cross-platform workaround. You can also expose pods and services using extra port mappings as shown in the extra port mappings section of the Configuration Guide.

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚‚Docker for Macä¸Šã§å®Ÿæ–½ã™ã‚‹ã¨ã€æœ€å¾Œã®ã‚¢ãƒ—ãƒªã«å¯¾ã™ã‚‹curlã®ã‚¢ã‚¯ã‚»ã‚¹ã§request timeoutã«ãªã‚Šã¾ã™ã€‚

OrbStack (0.12+)ã§ã‚ã‚Œã°ã€ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’Macä¸Šã§å®Œé‚ã§ãã¾ã™!


Kindã‚¯ãƒ©ã‚¹ã‚¿ä½œæˆ

```
kind create cluster
```

MetalLBã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.7/config/manifests/metallb-native.yaml
kubectl wait --namespace metallb-system \
                --for=condition=ready pod \
                --selector=app=metallb \
                --timeout=90s
```

MetalLBãŒæ‰•ã„å‡ºã™IP Rangeã®æŒ‡å®š

```
kubectl apply -f https://kind.sigs.k8s.io/examples/loadbalancer/metallb-config.yaml
```

> æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã®çµæœãŒ`172.19.0.0/16`ã§ãªã„å ´åˆã¯ã€metallb-config.yamlã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
> 
> ```
> $ docker network inspect -f '{{.IPAM.Config}}' kind
> [{172.19.0.0/16  172.19.0.1 map[]} {fc00:f853:ccd:e793::/64  fc00:f853:ccd:e793::1 map[]}]
> ```


ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤

```
kubectl apply -f https://kind.sigs.k8s.io/examples/loadbalancer/usage.yaml
```

æ‰•ã„å‡ºã•ã‚ŒãŸ`EXTERNAL-IP`ã‚’ç¢ºèªã€‚


```
$ kubectl get svc foo-service
NAME          TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)          AGE
foo-service   LoadBalancer   10.96.129.85   172.19.255.200   5678:31930/TCP   39s
```

ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹

```
LB_IP=$(kubectl get svc/foo-service -o=jsonpath='{.status.loadBalancer.ingress[0].ip}')
for _ in {1..10}; do
  curl ${LB_IP}:5678
done
```

ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™!

```
foo
bar
bar
foo
foo
bar
bar
foo
bar
foo
```

---

Docker Desktop for Macä»£æ›¿ã®OrbStackã‚’è©¦ã—ã¾ã—ãŸã€‚Macã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã¸ã®ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã¨è¨€ã†killer featureãŒè¿½åŠ ã•ã‚ŒãŸã“ã¨ã«ã‚ˆã‚Šã€Macä¸Šã§æ¤œè¨¼ã§ãã‚‹ã“ã¨ãŒå¢—ãˆãã†ã§ã™ã€‚
