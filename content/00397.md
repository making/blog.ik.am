---
title: PCF Dev(v0.20+)ã§Cloud Foundryã®TCP Routingã‚’è©¦ã™
tags: ["Cloud Foundry", "PCF Dev", "Pivotal Cloud Foundry"]
categories: ["Service", "PaaS", "CloudFoundry"]
---

PCF 1.8ã‹ã‚‰[TCP Routing](http://docs.pivotal.io/pivotalcf/1-8/devguide/deploy-apps/routes-domains.html)ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã€ã‚ˆã†ã‚„ãCloud Foundryã§HTTPä»¥å¤–ã‚‚æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
[PCF Dev](https://network.pivotal.io/products/pcfdev)ã¯v0.20ã‹ã‚‰ä½¿ç”¨å¯èƒ½ã§ã™ã€‚

> ç¾æ™‚ç‚¹ã§ã¯
> **è¤‡æ•°ãƒãƒ¼ãƒˆã¯æœªå¯¾å¿œ**ã§ã™ã€‚
> **æ°¸ç¶šã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯æœªå¯¾å¿œ**ã§ã™

### PCF Devã‚’èµ·å‹•

ã“ã®ãƒ–ãƒ­ã‚°ã«ã¯ä½•å›ã‚‚æ›¸ã„ã¦ã„ã¾ã™ãŒã€ç°¡å˜ã«ã‚‚ã†ä¸€åº¦ã€‚

ã¾ãšã¯ã˜ã‚ã«ã€ [Pivotal Network](https://network.pivotal.io/products/pcfdev)ã‹ã‚‰pcfdevãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼ˆè¦Pivotal Networkã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰ã€‚OSã”ã¨ã«æ¬¡ã®æ–¹æ³•ã§pcfdevãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

* [OSX](https://docs.pivotal.io/pcf-dev/install-osx.html#install-pcf-dev)
* [Linux](https://docs.pivotal.io/pcf-dev/install-linux.html#install-pcf-dev)
* [Windows](https://docs.pivotal.io/pcf-dev/install-windows.html#install-pcf-dev)

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚‰èµ·å‹•ã—ã¾ã™ã€‚

```
cf dev start
```

åˆå›ã¯VMãŒé™ã£ã¦ãã‚‹ã®ã§10åˆ†ãã‚‰ã„æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚

èµ·å‹•ã—ãŸã‚‰æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

```
cf login -a https://api.local.pcfdev.io --skip-ssl-validation -u admin -p admin -o pcfdev-org
```

### Echo Serverã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

TCPã‚µãƒ¼ãƒãƒ¼ã®Hello Worldã§ã‚ã‚‹Echo Serverã‚’æ›¸ã„ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

#### Echo Serverã®ä½œæˆ

```
mkdir echo-server
cd echo-server
glide init
```

`main.go`ã«ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¿°

``` go
package main

import (
	"bufio"
	"log"
	"net"
	"os"
)

func main() {
	port := os.Getenv("PORT")
	if port == "" {
		port = "8080"
	}
	log.Println("Launching echo server on port " + port)
	ln, err := net.Listen("tcp", ":"+port)
	if err != nil {
		log.Fatal("Error(Listen)! ", err)
	}
	defer ln.Close()

	for {
		c, err := ln.Accept()
		if err != nil {
			log.Fatal("Error(Accept)! ", err)
		}
		go handleConnection(c)
	}
}

func handleConnection(c net.Conn) {
	bufr := bufio.NewReader(c)
	buf := make([]byte, 1024)

	for {
		readBytes, err := bufr.Read(buf)
		if err != nil {
			c.Close()
			return
		}
		message := string(buf[:readBytes])
		log.Print("Received " + message)
		c.Write([]byte(message))
	}
}
```

ãƒ­ãƒ¼ã‚«ãƒ«ã§ç¢ºèª

```
go run main.go
```
å‹•ä½œç¢ºèª

```
$ echo Hello | nc localhost 8080
Hello
```

#### Echo Serverã‚’PCF Devã«ãƒ‡ãƒ—ãƒ­ã‚¤

TCP Routeã®ãƒãƒƒãƒ”ãƒ³ã‚°ã¯

* `cf create-route` && `cf map-route`ã§æ‰‹å‹•ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹æ–¹æ³•
* `manifest.yml`ã«`routes`ã‚’å®šç¾©ã™ã‚‹æ–¹æ³•

ã®2ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚

##### `cf create-route` && `cf map-route`ã§æ‰‹å‹•ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹æ–¹æ³•


`create-route`ã®ä½¿ã„æ–¹ã¯

```
cf create-route <space> <domain> --port <port>
```

åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ãƒˆç•ªå·ã¯Cloud Foundryã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã«è¨­å®šã—ã¾ã™ã€‚
PCF Devã®å ´åˆã¯[61001-61100](https://github.com/pivotal-cf/pcfdev/blob/v0.21.0/manifest.yml#L207)ã§ã™ã€‚
`--random-port`ã§ç©ºã„ã¦ã„ã‚‹ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ã§é¸æŠã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```
cf create-route <space> <domain> --random-port
```

```
cf push echo-server -b go_buildpack -m 8m --no-start
cf create-route pcfdev-space tcp.local.pcfdev.io --port 61001
cf map-route echo-server tcp.local.pcfdev.io --port 61001
cf start echo-server
```

`cf apps`ã®çµæœã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
$ cf apps
Getting apps in org pcfdev-org / space pcfdev-space as admin...
OK

name              requested state   instances   memory   disk   urls
echo-server       started           1/1         8M       512M   tcp.local.pcfdev.io:61001
```

å‹•ä½œç¢ºèª

```
$ echo Hello | nc tcp.local.pcfdev.io 61001
Hello
```

ğŸ™Œ


##### `manifest.yml`ã«`routes`ã‚’å®šç¾©ã™ã‚‹æ–¹æ³•

æ¬¡ã®`manifest.yml`ã‚’ä½¿ãˆã°ãƒ¯ãƒ³ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚

``` yaml
applications:
- name: echo-server
  routes:
  - route: tcp.local.pcfdev.io:61001
  buildpack: go_buildpack
  memory: 8m
```

ã‚ã¨ã¯

```
cf push
```

ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚ã“ã£ã¡ãŒã‚ªã‚¹ã‚¹ãƒ¡ã§ã™ã€‚

#### Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

PCF Devã¯Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®pushã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚Echo Serverã‚’[`making/echo-server`](https://hub.docker.com/r/making/echo-server/)ã«ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ãªã®ã§ã“ã‚Œã‚’ä½¿ãˆã°ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãªã—ã§Echo Serverã‚’PCF Devãƒ‡ãƒ—ãƒ­ã‚¤ã§ã™ã¾ã™ã€‚

`manifest.yml`ã‹ã‚‰`buildpack`ã‚’é™¤ãã¾ã™ã€‚ã™ã§ã«buildpackã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ãŸã‚‰`cf d -r -f echo-server`ã§å‰Šé™¤ã—ã¾ã™ã€‚

``` yaml
applications:
- name: echo-server
  routes:
  - route: tcp.local.pcfdev.io:61001
  memory: 8m
```

ã“ã®`manifest.yml`ã‚’ä½¿ã£ã¦`making/echo-server`ã‚’pushã—ã¾ã™ã€‚

```
cf push --docker-image making/echo-server
```

ãã®ä»–ã„ã‚ã„ã‚ãªDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Cloud Fondryã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¾ã™(ãŸã ã—ã€HTTPã®ã‚‚ã®ã¯é™¤ã)ã€‚

### Redisã®ãƒ‡ãƒ—ãƒ­ã‚¤

[`redis`](https://hub.docker.com/_/redis/)ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚

`manifest.yml`

``` yaml
applications:
- name: redis
  memory: 256M
  routes:
  - route: tcp.local.pcfdev.io:61002
```

`cf push`

```
cf push --docker-image redis
```

å‹•ä½œç¢ºèª

```
$ redis-cli -h tcp.local.pcfdev.io -p 61002
tcp.local.pcfdev.io:61002> set "foo" 100
OK
tcp.local.pcfdev.io:61002> get "foo"
"100"
```

### MySQLã®ãƒ‡ãƒ—ãƒ­ã‚¤

[`mysql`](https://hub.docker.com/_/mysql/)ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚

`manifest.yml`

``` yaml
applications:
- name: mysql
  memory: 256M
  routes:
  - route: tcp.local.pcfdev.io:61003
  env:
    MYSQL_ROOT_PASSWORD: my-secret
```

`cf push`

```
cf push --docker-image mysql
```

å‹•ä½œç¢ºèª

```
$ mysql -h tcp.local.pcfdev.io -u root -P 61003 -p
Enter password: my-secret
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 7
Server version: 5.7.16 MySQL Community Server (GPL)

Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> select now();
+---------------------+
| now()               |
+---------------------+
| 2016-10-14 18:25:48 |
+---------------------+
1 row in set (0.01 sec)
```

### PostgreSQLã®ãƒ‡ãƒ—ãƒ­ã‚¤

[`postgres`](https://hub.docker.com/_/postgres/)ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚

`manifest.yml`

``` yaml
applications:
- name: postgres
  memory: 256M
  routes:
  - route: tcp.local.pcfdev.io:61004
  env:
    POSTGRES_USER: vcap
    POSTGRES_PASSWORD: my-secret
    PGDATA: /home/vcap/postgresql/data
```

`cf push`

```
cf push --docker-image mysql
```

å‹•ä½œç¢ºèª


```
$ psql -U vcap -h tcp.local.pcfdev.io -p 61004
Password for user vcap: my-secret
psql (9.5.0, server 9.6.0)
WARNING: psql major version 9.5, server major version 9.6.
         Some psql features might not work.
Type "help" for help.

vcap=# select now();
              now              
-------------------------------
 2016-10-14 18:34:29.844692+00
(1 row)
```

### MongoDBã®ãƒ‡ãƒ—ãƒ­ã‚¤

[`mongo`](https://hub.docker.com/_/mongo/)ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚

`manifest.yml`

``` yaml
applications:
- name: mongo
  memory: 256M
  routes:
  - route: tcp.local.pcfdev.io:61005
```

`cf push`

```
cf push --docker-image mongo
```

å‹•ä½œç¢ºèª


```
$ mongo --host tcp.local.pcfdev.io --port 61005
MongoDB shell version: 3.2.6
connecting to: tcp.local.pcfdev.io:61005/test
Server has startup warnings: 
2016-10-14T18:39:09.654+0000 I CONTROL  [initandlisten] 
2016-10-14T18:39:09.654+0000 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is 'always'.
2016-10-14T18:39:09.654+0000 I CONTROL  [initandlisten] **        We suggest setting it to 'never'
2016-10-14T18:39:09.654+0000 I CONTROL  [initandlisten] 
2016-10-14T18:39:09.654+0000 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is 'always'.
2016-10-14T18:39:09.654+0000 I CONTROL  [initandlisten] **        We suggest setting it to 'never'
2016-10-14T18:39:09.654+0000 I CONTROL  [initandlisten] 
> 
```

### Mosquitto(MQTT Broker)ã®ãƒ‡ãƒ—ãƒ­ã‚¤

[`toke/mosquitto`](https://hub.docker.com/toke/mosquitto/)ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚

`manifest.yml`

``` yaml
applications:
- name: mosquitto
  memory: 256M
  routes:
  - route: tcp.local.pcfdev.io:61006
```

`cf push`

```
cf push --docker-image toke/mosquitto
```

å‹•ä½œç¢ºèª


å—ä¿¡å´

```
mosquitto_sub -h tcp.local.pcfdev.io -p 61006 -d -t test
```

é€ä¿¡å´

```
mosquitto_pub -h tcp.local.pcfdev.io -p 61006 -d -t test -m 'Hello World!'
```

### rsyslogã®ãƒ‡ãƒ—ãƒ­ã‚¤

[`helder/rsyslog`](https://hub.docker.com/helder/rsyslog/)ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚

`manifest.yml`

``` yaml
applications:
- name: rsyslog
  memory: 256M
  routes:
  - route: tcp.local.pcfdev.io:61007
```

`cf push`

```
cf push --docker-image helder/rsyslog
```

å‹•ä½œç¢ºèª


å—ä¿¡å´

```
$ cf ssh rsyslog
tail -f /var/log/messages 
```

é€ä¿¡å´

```
echo '<14>localhost Hello World' | nc tcp.local.pcfdev.io 61007
```
