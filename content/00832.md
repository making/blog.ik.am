---
title: Helm Chartã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã”ã¨Relocationã™ã‚‹ãƒ¡ãƒ¢
tags: ["Kubernetes", "Helm"]
categories: ["Dev", "CaaS", "Kubernetes", "Helm"]
---

Helm Chartã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã”ã¨Relocationã™ã‚‹ãƒ¡ãƒ¢ã§ã™ã€‚

Helmãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã‚ã‚‹"[Distribution Tooling for Helm](https://github.com/vmware-labs/distribution-tooling-for-helm)"ã‚’ä½¿ã„ã¾ã™ã€‚

æ¬¡ã®Helmãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§è©¦ã—ã¾ã—ãŸã€‚

```
$ helm version
version.BuildInfo{Version:"v3.16.3", GitCommit:"cfd07493f46efc9debd9cc1b02a0961186df7fdf", GitTreeState:"dirty", GoVersion:"go1.23.3"}
```

"Distribution Tooling for Helm"ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
helm plugin install https://github.com/vmware-labs/distribution-tooling-for-helm
```

æ¬¡ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§è©¦ã—ã¾ã—ãŸã€‚

```
$ helm dt version
Distribution Tooling for Helm v0.4.3
Built on: 2024-09-17T09:13:12Z
```

`helm dt wrap`ã‚³ãƒãƒ³ãƒ‰ã§æ—¢å­˜ã®Helm Chartã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸å«ã‚ã¦tar.gzã«æ¢±åŒ…ã§ãã¾ã™ã€‚
ã‚³ãƒãƒ³ãƒ‰å¼•æ•°ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```
helm dt wrap CHART_PATH|OCI_URI [flags]
```

ä¾‹ã¨ã—ã¦ https://github.com/bitnami/charts/tree/contour/19.3.2/bitnami/contour ã‚’GHCRã«relocateã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

> [!NOTE] ã‚¤ãƒ¡ãƒ¼ã‚¸ã®relocateã¾ã§è¡Œã†ã«ã¯`Chart.yaml`ã®`annoations`ã« https://github.com/vmware-labs/distribution-tooling-for-helm?tab=readme-ov-file#creating-an-images-lock ã®ã‚ˆã†ã«`image`ã®å®šç¾©ã‚’åˆ—æŒ™ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Bitnamiã®Helm Chartã«ã¯ã“ã®annotationsãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

ãƒãƒ¼ã‚¸ãƒ§ãƒ³19.3.2ã‚’æŒ‡å®šã—ã¦tar.gzã«åœ§ç¸®ã—ã¾ã™ã€‚

```
helm dt wrap oci://registry-1.docker.io/bitnamicharts/contour --version 19.3.2
```

æ¬¡ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```
 Â»  Wrapping Helm chart "oci://registry-1.docker.io/bitnamicharts/contour"
    âœ”  Helm chart downloaded to "/var/folders/6m/jnyp8461431g15qf217pmth40000gn/T/chart-2060331826/chart-4156122159/contour"                                                                                                                                   
    âœ”  Images.lock file written to "/var/folders/6m/jnyp8461431g15qf217pmth40000gn/T/chart-2060331826/wrap/chart/Images.lock"                                                                                                                                  
    Â»  Pulling images into "/var/folders/6m/jnyp8461431g15qf217pmth40000gn/T/chart-2060331826/wrap/images"
       âœ”  All images pulled successfully                                                                                                                                                                                                                       
    âœ”  Compressed into "/tmp/contour-19.3.2.wrap.tgz"                                                                                                                                                                                                          
    
 ğŸ‰  Helm chart wrapped into "/tmp/contour-19.3.2.wrap.tgz"
```

ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã„ã§ã™ã€‚


```
$ ls -lh contour-19.3.2.wrap.tgz
-rw-r--r--  1 toshiaki  wheel   377M 12 11 10:08 contour-19.3.2.wrap.tgz
```

æ¢±åŒ…ã•ã‚ŒãŸChartã®ä¸­èº«ã‚’`helm dt info`ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã¾ã™ã€‚

```
$ helm dt info contour-19.3.2.wrap.tgz 
 Â»  Wrap Information
       Chart: contour
       Version: 19.3.2
       App Version: 1.30.1
    Â»  Metadata
          - generatedBy: Distribution Tooling for Helm
          - generatedAt: 2024-12-11T01:08:06.006607Z
    Â»  Images
          docker.io/bitnami/contour:1.30.1-debian-12-r3 (linux/amd64, linux/arm64)
          docker.io/bitnami/envoy:1.31.3-debian-12-r1 (linux/amd64, linux/arm64)
          docker.io/bitnami/nginx:1.27.3-debian-12-r0 (linux/amd64, linux/arm64)
```

Air-gappedç’°å¢ƒã«relocateã—ãŸã„å ´åˆã¯ã€ã“ã®tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’USBãƒ¡ãƒ¢ãƒªã‹ä½•ã‹ã§ã‚³ãƒ”ãƒ¼ã—ã¦é‹ã¹ã°è‰¯ã„ã§ã™ã€‚

ã“ã‚Œã‚’GHCRã«relocateã—ã¾ã™ã€‚ã¾ãšã¯GHCRã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

```
docker login ghcr.io
```

`helm dt unwrap`ã‚³ãƒãƒ³ãƒ‰ã§relocateã—ã¾ã™ã€‚

```
helm dt unwrap contour-19.3.2.wrap.tgz ghcr.io/making/bitnamicharts --yes
```

æ¬¡ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```
 Â»  Unwrapping Helm chart "contour-19.3.2.wrap.tgz"
    âœ”  Helm chart uncompressed to "/var/folders/6m/jnyp8461431g15qf217pmth40000gn/T/chart-302831319/dt-wrap1453374076"                                                                                                                                         
    âœ”  Helm chart relocated successfully                                                                                                                                                                                                                       
    Â»  The wrap includes the following 3 images:

       ghcr.io/making/bitnamicharts/bitnami/contour:1.30.1-debian-12-r3
       ghcr.io/making/bitnamicharts/bitnami/envoy:1.31.3-debian-12-r1
       ghcr.io/making/bitnamicharts/bitnami/nginx:1.27.3-debian-12-r0
       
    Â»  Pushing Images
       âœ”  All images pushed successfully                                                                                                                                                                                                                       
       âœ”  Chart "/var/folders/6m/jnyp8461431g15qf217pmth40000gn/T/chart-302831319/dt-wrap1453374076/chart" lock is valid                                                                                                                                       
       
    âœ”  Helm chart successfully pushed                                                                                                                                                                                                                          
    
 ğŸ‰  Helm chart unwrapped successfully: You can use it now by running "helm install oci://ghcr.io/making/bitnamicharts/contour --generate-name"
```


relocateã•ã‚ŒãŸChartã‚’ä½¿ã£ã¦YAMLã‚’ç”Ÿæˆã™ã‚‹ã¨ã€`image`ãŒGHCRã«å¤‰ã‚ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
$ helm template contour oci://ghcr.io/making/bitnamicharts/contour --version 19.3.2 2>/dev/null | grep 'image: '
          image: ghcr.io/making/bitnamicharts/bitnami/contour:1.30.1-debian-12-r3
          image: ghcr.io/making/bitnamicharts/bitnami/envoy:1.31.3-debian-12-r1
          image: ghcr.io/making/bitnamicharts/bitnami/contour:1.30.1-debian-12-r3
          image: ghcr.io/making/bitnamicharts/bitnami/contour:1.30.1-debian-12-r3
          image: ghcr.io/making/bitnamicharts/bitnami/contour:1.30.1-debian-12-r3
```

ä»Šå›relocateã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å¯è¦–æ€§ã‚’publicã«å¤‰æ›´ã—ãŸã®ã§ä»¥ä¸‹ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚

https://github.com/making?tab=packages&tab=packages&q=bitnamicharts


