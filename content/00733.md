---
title: Tanzu Application Platform 1.4 (Iterate Profile) ã‚’Kindã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒ¡ãƒ¢
tags: ["Kubernetes", "Cartographer", "kind", "Tanzu", "TAP"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP"]
---


[Tanzu Application Platform 1.4](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/overview.html) ã‚’Kindã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

Intelç‰ˆã®Macã§è©¦ã—ã¦ã„ã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯TAPã‚’Installã—ã€"Hello World"ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ©Ÿèƒ½("Source to URL")ã‚’è©¦ã—ã¾ã™ã€‚

TAP 1.3ã¾ã§ã¨é•ã„ã€TAP 1.4ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§HTTPSãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚ä»¥ä¸‹ã®ã“ã‚Œã¾ã§ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ¡ãƒ¢ã¨ã¯é•ã„ã€ytt overlaysã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã¯ä¸è¦ã«ãªã‚Šã¾ã—ãŸã€‚

* [Tanzu Application Platform 1.3 (Iterate Profile) ã‚’Kindã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—HTTPSã‚’æœ‰åŠ¹ã«ã™ã‚‹ãƒ¡ãƒ¢](/entries/716)
* [Tanzu Application Platform 1.2 (Iterate Profile) ã‚’Kindã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—HTTPSã‚’æœ‰åŠ¹ã«ã™ã‚‹ãƒ¡ãƒ¢](/entries/706)
* [Tanzu Application Platform 1.1 (Iterate Profile) ã‚’Kindã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—HTTPSã‚’æœ‰åŠ¹ã«ã™ã‚‹ãƒ¡ãƒ¢](/entries/691)

---

**ç›®æ¬¡**
<!-- toc -->

### Kindã‚¯ãƒ©ã‚¹ã‚¿ã®ä½œæˆ

Dockerã«ã¯4 CPU, 4 GBãƒ¡ãƒ¢ãƒªä»¥ä¸Šã‚’å‰²ã‚Šå½“ã¦ã¦ãã ã•ã„ã€‚

```
cat <<EOF > kind-expose-port.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
 - role: control-plane
   extraPortMappings:
   - containerPort: 31443 # expose port 31443 of the node to port 80 on the host for use later by Contour ingress (envoy)
     hostPort: 443
   - containerPort: 31080 # expose port 31080 of the node to port 80 on the host for use later by Contour ingress (envoy)
     hostPort: 80
EOF
kind create cluster --config kind-expose-port.yaml --image kindest/node:v1.24.7
```

### Pivnet CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã“ã“ã§ã¯ [`pivnet`](https://github.com/pivotal-cf/pivnet-cli) CLIã‚’ä½¿ç”¨ã—ã¦å¿…è¦ãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
`pivnet` CLIã¯brewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

```
brew install pivotal/tap/pivnet-cli
```

[VMware Tanzu Network](https://network.tanzu.vmware.com/) ã®API Tokenã‚’å–å¾—ã—ã¦ã€`pivnet` CLIã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

```
pivnet login --api-token=<API Token>
```

### EULAã®æ‰¿è«¾

åˆã‚ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®EULAã‚’Acceptã—ã¦ãã ã•ã„ã€‚

* [Tanzu Application Platform](https://network.tanzu.vmware.com/products/tanzu-application-platform/)
* [Cluster Essentials for VMware Tanzu](https://network.tanzu.vmware.com/products/tanzu-cluster-essentials/)

> âš ï¸ EULAã§å®šã‚ã‚‰ã‚Œã¦ã„ã‚‹ä½¿ç”¨æœŸé–“ã¯30æ—¥é–“ã§ã™ã€‚ã¨ã¯è¨€ãˆã€ç‰¹ã«ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢çš„ã«åˆ¶é™ãŒã‹ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚


### Tanzu CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
# For Mac
pivnet download-product-files --product-slug='tanzu-application-platform' --release-version='1.4.0' --glob='tanzu-framework-darwin-amd64-*.tar'
# For Linux
pivnet download-product-files --product-slug='tanzu-application-platform' --release-version='1.4.0' --glob='tanzu-framework-linux-amd64-*.tar'
# For Windows
pivnet download-product-files --product-slug='tanzu-application-platform' --release-version='1.4.0' --glob='tanzu-framework-windows-amd64-*.zip'
```

```
tar xvf tanzu-framework-*-amd64-*.tar
install cli/core/v0.25.4/tanzu-core-*_amd64 /usr/local/bin/tanzu
export TANZU_CLI_NO_INIT=true
```

```
$ tanzu version
version: v0.25.4
buildDate: 2022-12-22
sha: 8204f5b0d-dirty
```

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
tanzu plugin install --local cli all
```

### Cluster Essentials for VMware Tanzuã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

TAPã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¿…è¦ãªKapp Controllerã¨Secretgen Controllerã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã« [Cluster Essentials for VMware Tanzu](https://network.tanzu.vmware.com/products/tanzu-cluster-essentials) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
# Mac
pivnet download-product-files --product-slug='tanzu-cluster-essentials' --release-version='1.4.0' --glob='tanzu-cluster-essentials-darwin-amd64-*'
# Linux
pivnet download-product-files --product-slug='tanzu-cluster-essentials' --release-version='1.4.0' --glob='tanzu-cluster-essentials-linux-amd64-*'
```

```yaml
TANZUNET_USERNAME=...
TANZUNET_PASSWORD=...

mkdir tanzu-cluster-essentials
tar xzvf tanzu-cluster-essentials-*-amd64-*.tgz -C tanzu-cluster-essentials

export INSTALL_BUNDLE=registry.tanzu.vmware.com/tanzu-cluster-essentials/cluster-essentials-bundle:1.3.0
export INSTALL_REGISTRY_HOSTNAME=registry.tanzu.vmware.com
export INSTALL_REGISTRY_USERNAME=${TANZUNET_USERNAME}
export INSTALL_REGISTRY_PASSWORD=${TANZUNET_PASSWORD}
cd tanzu-cluster-essentials
./install.sh --yes
cd ..
```

```
$ kubectl get pod -n kapp-controller
NAME                              READY   STATUS    RESTARTS   AGE
kapp-controller-b95b87ff9-226pb   2/2     Running   0          74s

$ kubectl get pod -n secretgen-controller
NAME                                   READY   STATUS    RESTARTS   AGE
secretgen-controller-9c7675fc5-ml9ft   1/1     Running   0          57s
```

### Tanzu Application Platformã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«


#### TAPç”¨Package Repositoryã®ç™»éŒ²

```
TANZUNET_USERNAME=...
TANZUNET_PASSWORD=...

kubectl create ns tap-install

tanzu secret registry add tap-registry \
  --username "${TANZUNET_USERNAME}" \
  --password "${TANZUNET_PASSWORD}" \
  --server registry.tanzu.vmware.com \
  --export-to-all-namespaces \
  --yes \
  --namespace tap-install

tanzu package repository add tanzu-tap-repository \
  --url registry.tanzu.vmware.com/tanzu-application-platform/tap-packages:1.4.0 \
  --namespace tap-install
```


```
$ tanzu package available list --namespace tap-install
  NAME                                                 DISPLAY-NAME                                                              SHORT-DESCRIPTION                                                                 LATEST-VERSION  
  accelerator.apps.tanzu.vmware.com                    Application Accelerator for VMware Tanzu                                  Used to create new projects and configurations.                                   1.4.0           
  api-portal.tanzu.vmware.com                          API portal                                                                A unified user interface for API discovery and exploration at scale.              1.2.6           
  apis.apps.tanzu.vmware.com                           API Auto Registration for VMware Tanzu                                    A TAP component to automatically register API exposing workloads as API entities  0.2.1           
                                                                                                                                 in TAP GUI.                                                                                       
  backend.appliveview.tanzu.vmware.com                 Application Live View for VMware Tanzu                                    App for monitoring and troubleshooting running apps                               1.4.0           
  buildservice.tanzu.vmware.com                        Tanzu Build Service                                                       Tanzu Build Service enables the building and automation of containerized          1.9.0           
                                                                                                                                 software workflows securely and at scale.                                                         
  carbonblack.scanning.apps.tanzu.vmware.com           VMware Carbon Black for Supply Chain Security Tools - Scan                Default scan templates using VMware Carbon Black                                  1.1.0-beta.1    
  cartographer.tanzu.vmware.com                        Cartographer                                                              Kubernetes native Supply Chain Choreographer.                                     0.6.2           
  cnrs.tanzu.vmware.com                                Cloud Native Runtimes                                                     Cloud Native Runtimes is a serverless runtime based on Knative                    2.1.0           
  connector.appliveview.tanzu.vmware.com               Application Live View Connector for VMware Tanzu                          App for discovering and registering running apps                                  1.4.0           
  controller.conventions.apps.tanzu.vmware.com         Convention Service for VMware Tanzu                                       Convention Service enables app operators to consistently apply desired runtime    0.8.0           
                                                                                                                                 configurations to fleets of workloads.                                                            
  controller.source.apps.tanzu.vmware.com              Tanzu Source Controller                                                   Tanzu Source Controller enables workload create/update from source code.          0.6.0           
  conventions.appliveview.tanzu.vmware.com             Application Live View Conventions for VMware Tanzu                        Application Live View convention server                                           1.4.0           
  developer-conventions.tanzu.vmware.com               Tanzu App Platform Developer Conventions                                  Developer Conventions                                                             0.9.0           
  eventing.tanzu.vmware.com                            Eventing                                                                  Eventing is an event-driven architecture platform based on Knative Eventing       2.1.1           
  external-secrets.apps.tanzu.vmware.com               External Secrets Operator                                                 External Secrets Operator is a Kubernetes operator that integrates external       0.6.1+tap.2     
                                                                                                                                 secret management systems.                                                                        
  fluxcd.source.controller.tanzu.vmware.com            Flux Source Controller                                                    The source-controller is a Kubernetes operator, specialised in artifacts          0.27.0+tap.4    
                                                                                                                                 acquisition from external sources such as Git, Helm repositories and S3 buckets.                  
  grype.scanning.apps.tanzu.vmware.com                 Grype for Supply Chain Security Tools - Scan                              Default scan templates using Anchore Grype                                        1.4.0           
  learningcenter.tanzu.vmware.com                      Learning Center for Tanzu Application Platform                            Guided technical workshops                                                        0.2.5           
  metadata-store.apps.tanzu.vmware.com                 Supply Chain Security Tools - Store                                       Post SBoMs and query for image, package, and vulnerability metadata.              1.4.2           
  namespace-provisioner.apps.tanzu.vmware.com          Namespace Provisioner                                                     Automatic Provisioning of Developer Namespaces.                                   0.1.2           
  ootb-delivery-basic.tanzu.vmware.com                 Tanzu App Platform Out of The Box Delivery Basic                          Out of The Box Delivery Basic.                                                    0.11.0          
  ootb-supply-chain-basic.tanzu.vmware.com             Tanzu App Platform Out of The Box Supply Chain Basic                      Out of The Box Supply Chain Basic.                                                0.11.0          
  ootb-supply-chain-testing-scanning.tanzu.vmware.com  Tanzu App Platform Out of The Box Supply Chain with Testing and Scanning  Out of The Box Supply Chain with Testing and Scanning.                            0.11.0          
  ootb-supply-chain-testing.tanzu.vmware.com           Tanzu App Platform Out of The Box Supply Chain with Testing               Out of The Box Supply Chain with Testing.                                         0.11.0          
  ootb-templates.tanzu.vmware.com                      Tanzu App Platform Out of The Box Templates                               Out of The Box Templates.                                                         0.11.0          
  policy.apps.tanzu.vmware.com                         Supply Chain Security Tools - Policy Controller                           Policy Controller enables defining of a policy to restrict unsigned container     1.2.0           
                                                                                                                                 images.                                                                                           
  scanning.apps.tanzu.vmware.com                       Supply Chain Security Tools - Scan                                        Scan for vulnerabilities and enforce policies directly within Kubernetes native   1.4.0           
                                                                                                                                 Supply Chains.                                                                                    
  service-bindings.labs.vmware.com                     Service Bindings for Kubernetes                                           Service Bindings for Kubernetes implements the Service Binding Specification.     0.9.0           
  services-toolkit.tanzu.vmware.com                    Services Toolkit                                                          The Services Toolkit enables the management, lifecycle, discoverability and       0.9.0           
                                                                                                                                 connectivity of Service Resources (databases, message queues, DNS records,                        
                                                                                                                                 etc.).                                                                                            
  snyk.scanning.apps.tanzu.vmware.com                  Snyk for Supply Chain Security Tools - Scan                               Default scan templates using Snyk                                                 1.0.0-beta.6    
  spring-boot-conventions.tanzu.vmware.com             Tanzu Spring Boot Conventions Server                                      Default Spring Boot convention server.                                            1.4.0           
  sso.apps.tanzu.vmware.com                            AppSSO                                                                    Application Single Sign-On for Tanzu                                              3.0.0           
  tap-auth.tanzu.vmware.com                            Default roles for Tanzu Application Platform                              Default roles for Tanzu Application Platform                                      1.1.0           
  tap-gui.tanzu.vmware.com                             Tanzu Application Platform GUI                                            web app graphical user interface for Tanzu Application Platform                   1.4.3           
  tap-telemetry.tanzu.vmware.com                       Telemetry Collector for Tanzu Application Platform                        Tanzu Application Plaform Telemetry                                               0.4.1-build.2   
  tap.tanzu.vmware.com                                 Tanzu Application Platform                                                Package to install a set of TAP components to get you started based on your use   1.4.0           
                                                                                                                                 case.                                                                                             
  tekton.tanzu.vmware.com                              Tekton Pipelines                                                          Tekton Pipelines is a framework for creating CI/CD systems.                       0.41.0+tap.4    
  workshops.learningcenter.tanzu.vmware.com            Workshop Building Tutorial                                                Workshop Building Tutorial                                                        0.2.4  
```


#### Iterate Profileã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

iterate profileã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã«ã€æ¬¡ã®`tap-values.yaml`ã‚’ä½œæˆã—ã¾ã™ã€‚
4CPUã§ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ä¸è¦ãªpackageã‚’`excluded_packages`ã«è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

```yaml
GITHUB_USERNAME=...
GITHUB_API_TOKEN=...

cat <<EOF > tap-values.yaml
shared:
  ingress_domain: 127-0-0-1.sslip.io
  image_registry:
    project_path: ghcr.io/${GITHUB_USERNAME}
    username: ${GITHUB_USERNAME}
    password: ${GITHUB_API_TOKEN}

ceip_policy_disclosed: true
profile: iterate

supply_chain: basic

contour:
  contour:
    replicas: 1
  envoy:
    service:
      type: NodePort
      nodePorts:
        http: 31080
        https: 31443
    hostPorts:
      enable: true

cnrs:
  provider: local

excluded_packages:
- policy.apps.tanzu.vmware.com
- image-policy-webhook.signing.apps.tanzu.vmware.com
- eventing.tanzu.vmware.com
- sso.apps.tanzu.vmware.com
EOF
```

> `*.127-0-0-1.sslip.io`ã¯`127.0.0.1`ã«è§£æ±ºã•ã‚Œã¾ã™ã€‚

TAPã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
tanzu package install tap \
  -p tap.tanzu.vmware.com \
  -v 1.4.0 \
  --values-file tap-values.yaml \
  -n tap-install \
  --wait=false
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®é€²æ—ã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã—ã¾ã™ã€‚

```
while [ "$(kubectl -n tap-install get app tap -o=jsonpath='{.status.friendlyDescription}')" != "Reconcile succeeded" ];do
  date
  kubectl get app -n tap-install
  echo "---------------------------------------------------------------------"
  sleep 10
done
echo "âœ… Install succeeded"
```

å…¨ã¦ã®appãŒ `Reconcile succeeded` ã«ãªã‚‹ã¾ã§å¾…ã¡ã¾ã™ã€‚10åˆ†ãã‚‰ã„ã‹ã‹ã‚Šã¾ã™ã€‚

```
$ kubectl get app -n tap-install 
NAME                       DESCRIPTION           SINCE-DEPLOY   AGE
api-auto-registration      Reconcile succeeded   8m43s          8m50s
appliveview-connector      Reconcile succeeded   8m45s          8m52s
appliveview-conventions    Reconcile succeeded   4m16s          4m23s
buildservice               Reconcile succeeded   8m44s          8m51s
cartographer               Reconcile succeeded   4m51s          4m58s
cert-manager               Reconcile succeeded   8m43s          8m51s
cnrs                       Reconcile succeeded   2m15s          2m22s
contour                    Reconcile succeeded   4m52s          4m58s
conventions-controller     Reconcile succeeded   4m51s          4m58s
developer-conventions      Reconcile succeeded   4m16s          4m23s
fluxcd-source-controller   Reconcile succeeded   8m42s          8m50s
namespace-provisioner      Reconcile succeeded   8m37s          8m50s
ootb-delivery-basic        Reconcile succeeded   3m5s           3m12s
ootb-supply-chain-basic    Reconcile succeeded   3m6s           3m12s
ootb-templates             Reconcile succeeded   3m14s          3m20s
service-bindings           Reconcile succeeded   8m45s          8m52s
services-toolkit           Reconcile succeeded   4m52s          4m58s
source-controller          Reconcile succeeded   4m53s          4m59s
spring-boot-conventions    Reconcile succeeded   4m16s          4m23s
tap                        Reconcile succeeded   8m52s          8m59s
tap-auth                   Reconcile succeeded   8m45s          8m52s
tap-telemetry              Reconcile succeeded   8m44s          8m51s
tekton-pipelines           Reconcile succeeded   8m45s          8m52s
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

````
$ tanzu package installed list -n tap-install
  NAME                      PACKAGE-NAME                                  PACKAGE-VERSION  STATUS               
  api-auto-registration     apis.apps.tanzu.vmware.com                    0.2.1            Reconcile succeeded  
  appliveview-connector     connector.appliveview.tanzu.vmware.com        1.4.0            Reconcile succeeded  
  appliveview-conventions   conventions.appliveview.tanzu.vmware.com      1.4.0            Reconcile succeeded  
  buildservice              buildservice.tanzu.vmware.com                 1.9.0            Reconcile succeeded  
  cartographer              cartographer.tanzu.vmware.com                 0.6.2            Reconcile succeeded  
  cert-manager              cert-manager.tanzu.vmware.com                 2.0.0            Reconcile succeeded  
  cnrs                      cnrs.tanzu.vmware.com                         2.1.0            Reconcile succeeded  
  contour                   contour.tanzu.vmware.com                      1.22.3+tap.2     Reconcile succeeded  
  conventions-controller    controller.conventions.apps.tanzu.vmware.com  0.8.0            Reconcile succeeded  
  developer-conventions     developer-conventions.tanzu.vmware.com        0.9.0            Reconcile succeeded  
  fluxcd-source-controller  fluxcd.source.controller.tanzu.vmware.com     0.27.0+tap.4     Reconcile succeeded  
  namespace-provisioner     namespace-provisioner.apps.tanzu.vmware.com   0.1.2            Reconcile succeeded  
  ootb-delivery-basic       ootb-delivery-basic.tanzu.vmware.com          0.11.0           Reconcile succeeded  
  ootb-supply-chain-basic   ootb-supply-chain-basic.tanzu.vmware.com      0.11.0           Reconcile succeeded  
  ootb-templates            ootb-templates.tanzu.vmware.com               0.11.0           Reconcile succeeded  
  service-bindings          service-bindings.labs.vmware.com              0.9.0            Reconcile succeeded  
  services-toolkit          services-toolkit.tanzu.vmware.com             0.9.0            Reconcile succeeded  
  source-controller         controller.source.apps.tanzu.vmware.com       0.6.0            Reconcile succeeded  
  spring-boot-conventions   spring-boot-conventions.tanzu.vmware.com      1.4.0            Reconcile succeeded  
  tap                       tap.tanzu.vmware.com                          1.4.0            Reconcile succeeded  
  tap-auth                  tap-auth.tanzu.vmware.com                     1.1.0            Reconcile succeeded  
  tap-telemetry             tap-telemetry.tanzu.vmware.com                0.4.1-build.2    Reconcile succeeded  
  tekton-pipelines          tekton.tanzu.vmware.com                       0.41.0+tap.4     Reconcile succeeded 
````

ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸPodã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

```
$ kubectl get pod -A
NAMESPACE                    NAME                                                           READY   STATUS    RESTARTS   AGE
api-auto-registration        api-auto-registration-controller-c87c7f8dd-djpnj               1/1     Running   0          8m54s
app-live-view-connector      application-live-view-connector-blpxw                          1/1     Running   0          8m58s
app-live-view-conventions    appliveview-webhook-f9b5dcc6-vzvdc                             1/1     Running   0          4m29s
build-service                build-pod-image-fetcher-7whw5                                  5/5     Running   0          8m51s
build-service                dependency-updater-controller-668c5568bd-fbf7l                 1/1     Running   0          8m51s
build-service                secret-syncer-controller-56978c9fd4-qm8wp                      1/1     Running   0          8m51s
build-service                warmer-controller-b7d4697d-d58dl                               1/1     Running   0          8m51s
cartographer-system          cartographer-controller-6b5d895476-cd99z                       1/1     Running   0          4m58s
cartographer-system          cartographer-conventions-controller-manager-6574b57bcc-6txtd   1/1     Running   0          4m58s
cert-injection-webhook       cert-injection-webhook-9fcc5884-q8rgx                          1/1     Running   0          8m51s
cert-manager                 cert-manager-6589fc4bd4-dfp89                                  1/1     Running   0          8m33s
cert-manager                 cert-manager-cainjector-5bb7fb97c5-gxc8h                       1/1     Running   0          8m33s
cert-manager                 cert-manager-webhook-7b9b65ccc7-rm2nt                          1/1     Running   0          8m33s
conventions-system           conventions-controller-manager-599f48fc6d-7kwt7                1/1     Running   0          5m
developer-conventions        webhook-758bb7f76f-8mk4b                                       1/1     Running   0          4m28s
flux-system                  fluxcd-source-controller-869f675c46-z28k9                      1/1     Running   0          8m53s
kapp-controller              kapp-controller-b95b87ff9-226pb                                2/2     Running   0          3h59m
knative-serving              activator-68b67d68c9-xxfn4                                     1/1     Running   0          2m23s
knative-serving              autoscaler-6f7ddbc75c-qw57c                                    1/1     Running   0          2m24s
knative-serving              autoscaler-hpa-7c88f7ddb8-qbts9                                1/1     Running   0          2m22s
knative-serving              controller-84cc778bd9-86vsm                                    1/1     Running   0          2m23s
knative-serving              domain-mapping-6d576cbd5d-88ghb                                1/1     Running   0          2m24s
knative-serving              domainmapping-webhook-7974ffb568-sxwdx                         1/1     Running   0          2m24s
knative-serving              net-certmanager-controller-76f677575f-2v685                    1/1     Running   0          2m24s
knative-serving              net-certmanager-webhook-6df78bf5cb-76dd8                       1/1     Running   0          2m23s
knative-serving              net-contour-controller-698bcbc897-bwcv2                        1/1     Running   0          2m22s
knative-serving              webhook-755d6bbc8f-2v2rn                                       1/1     Running   0          2m24s
kpack                        kpack-controller-779444dd66-rlfc7                              1/1     Running   0          8m51s
kpack                        kpack-webhook-668df79bcf-l4g42                                 1/1     Running   0          8m51s
kube-system                  coredns-6d4b75cb6d-c8kzt                                       1/1     Running   0          3h59m
kube-system                  coredns-6d4b75cb6d-lkwx9                                       1/1     Running   0          3h59m
kube-system                  etcd-kind-control-plane                                        1/1     Running   0          3h59m
kube-system                  kindnet-9c8q2                                                  1/1     Running   0          3h59m
kube-system                  kube-apiserver-kind-control-plane                              1/1     Running   0          3h59m
kube-system                  kube-controller-manager-kind-control-plane                     1/1     Running   0          3h59m
kube-system                  kube-proxy-8z4dg                                               1/1     Running   0          3h59m
kube-system                  kube-scheduler-kind-control-plane                              1/1     Running   0          3h59m
local-path-storage           local-path-provisioner-6b84c5c67f-7j29z                        1/1     Running   0          3h59m
secretgen-controller         secretgen-controller-9c7675fc5-ml9ft                           1/1     Running   0          3h58m
service-bindings             manager-df7db75db-7hvsz                                        1/1     Running   0          8m56s
services-toolkit             resource-claims-apiserver-65857c7c89-cjbtq                     1/1     Running   0          5m
services-toolkit             services-toolkit-controller-manager-55b678b79b-rsjq9           1/1     Running   0          5m
source-system                source-controller-manager-6c55456d9d-zt9pr                     1/1     Running   0          5m4s
spring-boot-convention       spring-boot-webhook-5498b46547-lb9t8                           1/1     Running   0          4m19s
stacks-operator-system       controller-manager-5977495d45-z7ktl                            1/1     Running   0          8m51s
tanzu-system-ingress         contour-ff5fb85cf-xfgvt                                        1/1     Running   0          5m1s
tanzu-system-ingress         envoy-h2fkh                                                    2/2     Running   0          5m1s
tap-namespace-provisioning   controller-manager-76ddf69dfd-zcdrt                            1/1     Running   0          8m49s
tap-telemetry                tap-telemetry-informer-cf79497bd-ggdv9                         1/1     Running   0          8m57s
tekton-pipelines-resolvers   tekton-pipelines-remote-resolvers-554cf9665f-92977             1/1     Running   0          8m55s
tekton-pipelines             tekton-pipelines-controller-6d757897f7-v2ldc                   1/1     Running   0          8m55s
tekton-pipelines             tekton-pipelines-webhook-58d8d4884d-nxb5z                      1/1     Running   0          8m55s
```

ClusterBuilderãŒREADYãªã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ kubectl get clusterbuilder
NAME         LATESTIMAGE                                                                                                                     READY
base         ghcr.io/making/buildservice:clusterbuilder-base@sha256:d0a5289c4a3ad54f99e1131d4aa39870d41b1c591ecf803ceb0a8055c6cef89b         True
base-jammy   ghcr.io/making/buildservice:clusterbuilder-base-jammy@sha256:656903e769390d69bf4efb1d189f0b7d21e4eebc6a3754a97e5b075aaa428567   True
default      ghcr.io/making/buildservice:clusterbuilder-default@sha256:d0a5289c4a3ad54f99e1131d4aa39870d41b1c591ecf803ceb0a8055c6cef89b      True
```

### Workloadã®ãƒ‡ãƒ—ãƒ­ã‚¤

TAP 1.4ã‹ã‚‰ã¯Namespace ProvisionerãŒå°å…¥ã•ã‚Œã€Workloadã‚’ä½œæˆã™ã‚‹ãŸã‚ã®äº‹å‰æº–å‚™ãŒè‡ªå‹•åŒ–ã•ã‚Œã¾ã—ãŸã€‚

https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/namespace-provisioner-tutorials.html#provision-a-new-developer-namespace-2

#### registry-credentialsã®ä½œæˆã¨å…¬é–‹


```
tanzu secret registry add registry-credentials \
  --server ghcr.io \
  --username ${GITHUB_USERNAME} \
  --password ${GITHUB_API_TOKEN} \
  --namespace tap-install \
  --export-to-all-namespaces \
  -y
```


1.3ã¾ã§ã¨é•ã£ã¦ã€`--export-to-all-namespaces`ã§å…¨namespaceã«å…¬é–‹ã—ã¾ã™ã€‚
namespaceå€‹åˆ¥ã§credentialsã‚’å¤‰ãˆã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€namespaceæ¯ã«`tanzu secret registry`ã‚’å®Ÿæ–½ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### Namespaceã®ä½œæˆ

Namespaceã«`apps.tanzu.vmware.com/tap-ns`ãƒ©ãƒ™ãƒ«ã‚’è¨­å®šã™ã‚‹ã¨å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

ç”Ÿæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã¯æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¾ã¨ã¾ã£ã¦ã„ã¾ã™<br>
https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/namespace-provisioner-reference.html#default-resources-mapping

```
kubectl create ns demo
kubectl label namespaces demo apps.tanzu.vmware.com/tap-ns=""
```


```
$ kubectl get secrets,serviceaccount,rolebinding,configmap -n demo
NAME                            TYPE                             DATA   AGE
secret/registries-credentials   kubernetes.io/dockerconfigjson   1      26s

NAME                     SECRETS   AGE
serviceaccount/default   1         27s

NAME                                                               ROLE                      AGE
rolebinding.rbac.authorization.k8s.io/default-permit-deliverable   ClusterRole/deliverable   26s
rolebinding.rbac.authorization.k8s.io/default-permit-workload      ClusterRole/workload      26s

NAME                         DATA   AGE
configmap/kube-root-ca.crt   1      27s
```

[`kapp`](https://github.com/vmware-tanzu/carvel-kapp/releases) CLIã‚’ä½¿ã†ã¨Namespace Provisionerã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```
$ kapp inspect -n tap-namespace-provisioning -a provisioner.app
Target cluster 'https://127.0.0.1:57671' (nodes: kind-control-plane)

Resources in app 'provisioner.app'

Namespace  Name                        Kind            Owner  Rs  Ri  Age  
demo       default                     ServiceAccount  kapp   ok  -   1h  
^          default-permit-deliverable  RoleBinding     kapp   ok  -   1h  
^          default-permit-workload     RoleBinding     kapp   ok  -   1h  
^          registries-credentials      Secret          kapp   ok  -   1h  

Rs: Reconcile state
Ri: Reconcile information

4 resources

Succeeded
```

#### Node.jsã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤

```
tanzu apps workload apply hello-nodejs \
  --app hello-nodejs \
  --git-repo https://github.com/making/hello-nodejs \
  --git-branch master \
  --type web \
  -n demo \
  -y
```

ãƒ­ã‚°ã¯[`stern`](https://github.com/stern/stern)ã‚’ä½¿ã†ã¨ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚

```
stern -n demo hello-nodejs
```

Supply Chainã®é€²æ—ã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã¾ã™ã€‚

```
$ tanzu apps workload get -n demo hello-nodejs
ğŸ“¡ Overview
   name:        hello-nodejs
   type:        web
   namespace:   demo

ğŸ’¾ Source
   type:     git
   url:      https://github.com/making/hello-nodejs
   branch:   master

ğŸ“¦ Supply Chain
   name:   source-to-url

   NAME               READY     HEALTHY   UPDATED   RESOURCE
   source-provider    True      True      15s       gitrepositories.source.toolkit.fluxcd.io/hello-nodejs
   image-provider     Unknown   Unknown   15s       images.kpack.io/hello-nodejs
   config-provider    False     Unknown   18s       not found
   app-config         False     Unknown   18s       not found
   service-bindings   False     Unknown   18s       not found
   api-descriptors    False     Unknown   18s       not found
   config-writer      False     Unknown   18s       not found

ğŸšš Delivery
   name:   delivery-basic

   NAME              READY   HEALTHY   UPDATED   RESOURCE
   source-provider   False   False     13s       imagerepositories.source.apps.tanzu.vmware.com/hello-nodejs-delivery
   deployer          False   Unknown   15s       not found

ğŸ’¬ Messages
   Workload [MissingValueAtPath]:   waiting to read value [.status.latestImage] from resource [images.kpack.io/hello-nodejs] in namespace [demo]
   Deliverable [HealthyConditionRule]:   Unable to resolve image with tag "ghcr.io/making/workloads/hello-nodejs-demo-bundle:9839ebc4-1989-4a37-9ab0-0bdea654bb5d" to a digest: GET https://ghcr.io/v2/making/workloads/hello-nodejs-demo-bundle/manifests/9839ebc4-1989-4a37-9ab0-0bdea654bb5d: MANIFEST_UNKNOWN: manifest unknown

ğŸ›¶ Pods
   NAME                             READY   STATUS     RESTARTS   AGE
   hello-nodejs-build-1-build-pod   0/1     Init:1/6   0          14s

To see logs: "tanzu apps workload tail hello-nodejs --namespace demo --timestamp --since 1h"
```

"Knative Services"ã®æ¬„ãŒå‡ºåŠ›ã•ã‚Œã€"Ready"ã«ãªã‚Œã°ã‚¢ãƒ—ãƒªã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å®Œäº†ã§ã™ã€‚

```
$ tanzu apps workload get -n demo hello-nodejs
ğŸ“¡ Overview
   name:        hello-nodejs
   type:        web
   namespace:   demo

ğŸ’¾ Source
   type:     git
   url:      https://github.com/making/hello-nodejs
   branch:   master

ğŸ“¦ Supply Chain
   name:   source-to-url

   NAME               READY   HEALTHY   UPDATED   RESOURCE
   source-provider    True    True      3m40s     gitrepositories.source.toolkit.fluxcd.io/hello-nodejs
   image-provider     True    True      2m16s     images.kpack.io/hello-nodejs
   config-provider    True    True      2m3s      podintents.conventions.carto.run/hello-nodejs
   app-config         True    True      2m3s      configmaps/hello-nodejs
   service-bindings   True    True      2m3s      configmaps/hello-nodejs-with-claims
   api-descriptors    True    True      2m3s      configmaps/hello-nodejs-with-api-descriptors
   config-writer      True    True      68s       runnables.carto.run/hello-nodejs-config-writer

ğŸšš Delivery
   name:   delivery-basic

   NAME              READY   HEALTHY   UPDATED   RESOURCE
   source-provider   True    True      34s       imagerepositories.source.apps.tanzu.vmware.com/hello-nodejs-delivery
   deployer          True    True      32s       apps.kappctrl.k14s.io/hello-nodejs

ğŸ’¬ Messages
   No messages found.

ğŸ›¶ Pods
   NAME                                             READY   STATUS      RESTARTS   AGE
   hello-nodejs-00001-deployment-7586f87fd8-qsf2q   2/2     Running     0          35s
   hello-nodejs-build-1-build-pod                   0/1     Completed   0          3m40s
   hello-nodejs-config-writer-m8tf6-pod             0/1     Completed   0          2m2s

ğŸš¢ Knative Services
   NAME           READY   URL
   hello-nodejs   Ready   https://hello-nodejs.demo.127-0-0-1.sslip.io

To see logs: "tanzu apps workload tail hello-nodejs --namespace demo --timestamp --since 1h"
```

```
$ curl -k https://hello-nodejs.demo.127-0-0-1.sslip.io
Hello World!
```

ç¢ºèªãŒçµ‚ã‚ã‚Œã°Workloadã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```
tanzu apps workload delete -n demo hello-nodejs -y
```

#### Javaã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤

```
tanzu apps workload apply spring-music \
  --app spring-music \
  --git-repo https://github.com/scottfrederick/spring-music \
  --git-branch tanzu \
  --type web \
  --annotation autoscaling.knative.dev/minScale=1 \
  -n demo \
  -y
```

ãƒ­ã‚°ã¯[`stern`](https://github.com/stern/stern)ã‚’ä½¿ã†ã¨ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚

```
stern -n demo spring-music
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€"Knative Services"ã®æ¬„ãŒå‡ºåŠ›ã•ã‚Œã€"Ready"ã«ãªã‚Œã°ã‚¢ãƒ—ãƒªã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å®Œäº†ã§ã™ã€‚

```
$ tanzu apps workload get -n demo spring-music 
ğŸ“¡ Overview
   name:        spring-music
   type:        web
   namespace:   demo

ğŸ’¾ Source
   type:     git
   url:      https://github.com/scottfrederick/spring-music
   branch:   tanzu

ğŸ“¦ Supply Chain
   name:   source-to-url

   NAME               READY   HEALTHY   UPDATED   RESOURCE
   source-provider    True    True      7m4s      gitrepositories.source.toolkit.fluxcd.io/spring-music
   image-provider     True    True      4m22s     images.kpack.io/spring-music
   config-provider    True    True      4m13s     podintents.conventions.carto.run/spring-music
   app-config         True    True      4m13s     configmaps/spring-music
   service-bindings   True    True      4m13s     configmaps/spring-music-with-claims
   api-descriptors    True    True      4m13s     configmaps/spring-music-with-api-descriptors
   config-writer      True    True      4m        runnables.carto.run/spring-music-config-writer

ğŸšš Delivery
   name:   delivery-basic

   NAME              READY   HEALTHY   UPDATED   RESOURCE
   source-provider   True    True      3m58s     imagerepositories.source.apps.tanzu.vmware.com/spring-music-delivery
   deployer          True    True      3m56s     apps.kappctrl.k14s.io/spring-music

ğŸ’¬ Messages
   No messages found.

ğŸ›¶ Pods
   NAME                                            READY   STATUS      RESTARTS   AGE
   spring-music-00001-deployment-bdf86d97f-8rqks   2/2     Running     0          3m58s
   spring-music-build-1-build-pod                  0/1     Completed   0          7m3s
   spring-music-config-writer-v495h-pod            0/1     Completed   0          4m12s

ğŸš¢ Knative Services
   NAME           READY   URL
   spring-music   Ready   https://spring-music.demo.127-0-0-1.sslip.io

To see logs: "tanzu apps workload tail spring-music --namespace demo --timestamp --since 1h"
```

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/212458384-0489f362-66fc-4042-af18-5626d47e78a6.png">

"THIS IS UNSAFE"ã‚’å…¥åŠ›

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/212458400-14b932a6-aaee-4ccc-b716-34ef7edd4c32.png">



TAP 1.4ã‹ã‚‰ã¯Spring Boot Actuatorã«é–¢ã™ã‚‹è‡ªå‹•è¨­å®šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒå¤‰ã‚ã‚Šã¾ã—ãŸã€‚Spring Boot ActuatorãŒä¾å­˜é–¢ä¿‚ã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€TAP 1.3ã¾ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç’°å¢ƒå¤‰æ•°`JAVA_TOOL_OPTIONS`ã«æ¬¡ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

* `-Dmanagement.endpoint.health.show-details="always"`
* `-Dmanagement.endpoints.web.exposure.include="*"` 
* `-Dmanagement.server.port="8081"`

TAP 1.4ã‹ã‚‰ã¯ã“ã‚ŒãŒè‡ªå‹•ã§è¨­å®šã•ã‚Œã¾ã›ã‚“ã€‚æ¬¡ã®ã‚ˆã†ã«`JAVA_TOOL_OPTIONS`ã‚’ç¢ºèªã™ã‚‹ã¨ã€ä¸Šè¨˜ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
$ kubectl get ksvc -n demo spring-music -ojsonpath='{.spec.template.spec.containers[?(@.name=="workload")].env[?(@.name=="JAVA_TOOL_OPTIONS")].value}'
-Dmanagement.endpoint.health.probes.add-additional-paths="true" -Dmanagement.health.probes.enabled="true" -Dserver.port="8080" -Dserver.shutdown.grace-period="24s"
```


TAP 1.4ã§ã‚‚TAP 1.3ä»¥å‰ã¨åŒæ§˜ã®è¨­å®šã‚’å«ã‚ãŸã„å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«Workloadãƒ¬ãƒ™ãƒ«ã§`apps.tanzu.vmware.com/auto-configure-actuators`ãƒ©ãƒ™ãƒ«ã«`"true"`ã‚’è¨­å®šã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

```
tanzu apps workload apply spring-music \
  --app spring-music \
  --git-repo https://github.com/scottfrederick/spring-music \
  --git-branch tanzu \
  --type web \
  --annotation autoscaling.knative.dev/minScale=1 \
  --label apps.tanzu.vmware.com/auto-configure-actuators=true \
  -n demo \
  -y
```

ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾Œã«è¨­å®šã•ã‚ŒãŸ`JAVA_TOOL_OPTIONS`ã‚’ç¢ºèªã™ã‚‹ã¨ã€å€¤ãŒå¤‰ã‚ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
$ kubectl get ksvc -n demo spring-music -ojsonpath='{.spec.template.spec.containers[?(@.name=="workload")].env[?(@.name=="JAVA_TOOL_OPTIONS")].value}'
-Dmanagement.endpoint.health.probes.add-additional-paths="true" -Dmanagement.endpoint.health.show-details="always" -Dmanagement.endpoints.web.base-path="/actuator" -Dmanagement.endpoints.web.exposure.include="*" -Dmanagement.health.probes.enabled="true" -Dmanagement.server.port="8081" -Dserver.port="8080" -Dserver.shutdown.grace-period="24s"
```


Platformãƒ¬ãƒ™ãƒ«ã§è¨­å®šã‚’åæ˜ ã•ã›ãŸã„å ´åˆã¯`tap-values.yaml`ã«æ¬¡ã®è¨­å®šã‚’ã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

```yaml
springboot_conventions:
  autoConfigureActuators: true
```


Spring Boot Actuatorã®è¨­å®šã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã“ã¡ã‚‰ã§ã™ã€‚
https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/spring-boot-conventions-configuring-spring-boot-actuators.html



ç¢ºèªãŒçµ‚ã‚ã‚Œã°Workloadã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```
tanzu apps workload delete -n demo spring-music -y
```

### GitOpsã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.3/tap/GUID-scc-gitops-vs-regops.html#gitops-0

ã¾ãšã€manifestã‚’ç®¡ç†ã™ã‚‹gitãƒ¬ãƒã‚¸ãƒˆãƒªã‚’GitHubã§ä½œæˆã¾ã™ã€‚READMEã®ã¿ã‚’å«ã‚€ https://github.com/making/hello-nodejs-manifests ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178646028-cf7fab55-e3bc-447b-a4ad-95fb78c57c0e.png">

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178646115-141d9c2b-6a1c-4059-bcd7-efcac9716158.png">

Gitãƒ¬ãƒã‚¸ãƒˆãƒªã«pushã™ã‚‹ãŸã‚ã®Secretã‚’ä½œæˆã—ã¾ã™ã€‚[HTTP(S) Basic-auth](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/scc-gitops-vs-regops.html#authentication-3)ã‹[SSH](https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/scc-gitops-vs-regops.html#ssh-4)ãŒé¸ã¹ã¾ã™ã€‚
ã“ã“ã§ã¯Basic-authã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

https://github.com/settings/tokens ã‹ã‚‰repoã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚‹Personal access tokensã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/178656962-6cb06cf9-4296-4b1a-80b2-d4f2f61fcee6.png">


ã“ã®Personal access tokenã®Secetã‚’ä½œæˆã—ã€Service Accountã«ã“ã®Secretã‚’å‚ç…§ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
TAP 1.3ã¾ã§ã¯ã“ã®ä½œæ¥­ã¯Namepsaceæ¯ã«æ‰‹å‹•ã¾ãŸã¯TAPä»¥å¤–ã®ä»•çµ„ã¿ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸãŒã€TAP 1.4ã‹ã‚‰ã¯Namespace Provisionerã‚’ä½¿ã£ã¦Namespaceæ¯ã«è‡ªå‹•ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¸¡æ–¹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

#### æ‰‹å‹•ã§å€‹ã€…ã«Personal access tokenã‚’è¨­å®š (TAP 1.3ã¾ã§ã¨åŒã˜)

ã¾ãšã¯æ‰‹å‹•ã®å ´åˆã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Secretã‚’ä½œæˆã—ã¾ã™ã€‚

```
GITHUB_USERNAME=making
GITHUB_API_TOKEN=ghp_******

kubectl create secret generic git-basic -n demo \
    --type kubernetes.io/basic-auth \
    --from-literal=username=${GITHUB_USERNAME} \
    --from-literal=password=${GITHUB_API_TOKEN} \
    --dry-run=client -oyaml \
 | kubectl apply -f- 
kubectl -n demo annotate secret git-basic tekton.dev/git-0=https://github.com --overwrite=true
kubectl patch -n demo serviceaccount default -p "{\"secrets\":[{\"name\":\"git-basic\"}]}"
```

#### Namespace Provisionerã‚’ä½¿ã£ã¦Personal access tokenã‚’è¨­å®š (TAP 1.4ã‹ã‚‰)


Namespace Provisionerã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ–¹æ³•ã¯æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/namespace-provisioner-how-tos.html


è¿½åŠ ã—ãŸã„ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’`tap-values.yaml`ã®`namespace_provisioner.additional_sources`ã«è¨˜è¿°ã§ãã¾ã™ã€‚ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯"GitOps"ã¨è¨€ã£ã¦Gitã‹ã‚‰ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã™ãŒã€
å®Ÿéš›ã¯kapp controllerã®App CRã§ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’fetchã—ã¦ã‚‹ã®ã§ã€[App CR spec](https://carvel.dev/kapp-controller/docs/v0.43.2/app-spec/)ã®`fetch`ã§å–å¾—ã§ãã‚‹ã‚‚ã®ã§ã‚ã‚Œã°ã€Gitã§ãªãã¦ã‚‚ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’é…ç½®ã§ãã¾ã™ã€‚
ä»Šå›ã¯`git`ã§ã¯ãªã`inline`ã‚’ä½¿ã£ã¦ã€`tap-values.yaml`ã«è¿½åŠ ã—ãŸã„ãƒªã‚½ãƒ¼ã‚¹ã‚’ç›´æ¥è¨˜è¿°ã—ã¾ã™ã€‚

æ¬¡ã®ã‚ˆã†ã«`tap-values.yaml`ã«`namespace_provisioner`ã®è¨­å®šã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```yaml
GITHUB_USERNAME=making
GITHUB_API_TOKEN=ghp_******

cat <<EOF >> tap-values.yaml

namespace_provisioner:
  additional_sources:
  - inline:
      paths:
        git-basic.yaml: |
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: git-basic
            annotations:
              tekton.dev/git-0: https://github.com
          type: kubernetes.io/basic-auth
          stringData:
            username: "${GITHUB_USERNAME}"
            password: "${GITHUB_API_TOKEN}"
    path: _ytt_lib/git-basic
  - inline:
      paths:
        add-git-basic.lib.yaml: |
          #@ load("@ytt:overlay", "overlay")

          #@ def customize():
          #@overlay/match by=overlay.subset({"kind": "ServiceAccount", "metadata": {"name": "default"}}), expects="0+"
          ---
          secrets:
          - name: git-basic
          #@ end
    path: _ytt_lib/customize
EOF
```

`path`ã¯å¿…ãš`_ytt_lib/`ã‹ã‚‰å§‹ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br>
ã¾ãŸã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½œã‚‰ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹(`default` ServiceAccount)ãªã©ã‚’ytt overlayã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã„å ´åˆã¯ã€`path`ã¯`_ytt_lib/customize`ã§å›ºå®šã§ã€ãƒ•ã‚¡ã‚¤ãƒ«åã¯`.lib.yaml`ã§çµ‚ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã€overlayã‚’è¨˜è¿°ã—ãŸé–¢æ•°`customize`ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚ã‚Šã¾ã™ã€‚<br>
ä½¿ç”¨æ¡ä»¶ã¯ https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/namespace-provisioner-how-tos.html#customizing-the-default-resources-that-get-provisioned-4 ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚<br><br>


æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§TAPã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚Œã°ã€`apps.tanzu.vmware.com/tap-ns`ãƒ©ãƒ™ãƒ«ã®ã¤ã„ãŸå…¨ã¦ã®Namespaceã«`git-basic`ã¨ã„ã†SecretãŒä½œæˆã•ã‚Œã€`default` Service Accountã®`secrets`ã«`git-basic`ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚

```
tanzu package installed update -n tap-install tap -f tap-values.yaml
```

[`kapp`](https://github.com/vmware-tanzu/carvel-kapp/releases) CLIã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã™ã‚‹ã¨

```
$ kapp inspect -n tap-namespace-provisioning -a provisioner.app
Target cluster 'https://127.0.0.1:57671' (nodes: kind-control-plane)

Resources in app 'provisioner.app'

Namespace  Name                        Kind            Owner  Rs  Ri  Age  
demo       default                     ServiceAccount  kapp   ok  -   1h  
^          default-permit-deliverable  RoleBinding     kapp   ok  -   1h  
^          default-permit-workload     RoleBinding     kapp   ok  -   1h  
^          git-basic                   Secret          kapp   ok  -   1h  
^          registries-credentials      Secret          kapp   ok  -   1h  

Rs: Reconcile state
Ri: Reconcile information

5 resources

Succeeded
```

`default` Service Accountã‚’ç¢ºèªã™ã‚‹ã¨

```
$ kubectl get sa -n demo default -oyaml
apiVersion: v1
imagePullSecrets:
- name: registries-credentials
kind: ServiceAccount
metadata:
# ...
secrets:
- name: registries-credentials
- name: git-basic
```


åæ˜ ãŒé…ã„å ´åˆã¯[`kctrl`](https://github.com/vmware-tanzu/carvel-kapp-controller/releases) CLIã§æ¬¡ã®ã‚ˆã†ã«å¼·åˆ¶çš„ã«åæ˜ ã§ãã¾ã™ã€‚ã©ã¡ã‚‰ã‹ä¸€æ–¹ã ã‘ã§è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚


```
# tap-values.yamlã®å¤‰æ›´ã‚’åæ˜ ã—ã€Namespace Provisionerã‚’æ›´æ–°
kctrl app kick -n tap-install -a namespace-provisioner -y

# Namespace Provisionerã®å¤‰æ›´ã‚’åæ˜ ã—ã€ä½œæˆã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°
kctrl app kick -n tap-namespace-provisioning -a provisioner -y
```

#### Workloadã®ãƒ‡ãƒ—ãƒ­ã‚¤


Personal access tokenã®è¨­å®šãŒçµ‚ã‚ã‚Œã°ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚

```
tanzu apps workload apply hello-nodejs \
  --app hello-nodejs \
  --git-repo https://github.com/making/hello-nodejs \
  --git-branch master \
  --type web \
  --param gitops_branch=main \
  --param gitops_commit_message=Bump \
  --param gitops_server_address=https://github.com \
  --param gitops_repository_owner=making \
  --param gitops_repository_name=tap-gitops-manifests \
  --param gitops_user_email=makingx+bot@gmail.com \
  --param gitops_user_name=making-bot \
  --param gitops_ssh_secret=git-basic \
  -n demo \
  -y
```

ãƒ­ã‚°ã¯[`stern`](https://github.com/stern/stern)ã‚’ä½¿ã†ã¨ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚

```
stern -n demo hello-nodejs
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€"Knative Services"ã®æ¬„ãŒå‡ºåŠ›ã•ã‚Œã€"Ready"ã«ãªã‚Œã°ã‚¢ãƒ—ãƒªã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å®Œäº†ã§ã™ã€‚


```
$ tanzu apps workload get hello-nodejs -n demo
```


kpackã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ãŒçµ‚ã‚ã‚‹ã¨ã€ãã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã®digestã‚’ä½¿ç”¨ã—ã¦manifestã‚’git commit & pushãŒTektonã«ã‚ˆã£ã¦è¡Œã‚ã‚Œã¾ã™ã€‚
gitãƒ¬ãƒã‚¸ãƒˆãƒªã‚’è¦‹ã‚‹ã¨æ¬¡ã®ã‚³ãƒŸãƒƒãƒˆãŒè‡ªå‹•ã§è¡Œã‚ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/204441449-11dcc7ab-c0cf-48e3-aeba-3a4658ec0ff5.png">

URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

```
$ curl -k https://hello-demo.127-0-0-1.sslip.io
Hello World!
```

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦git pushã™ã‚‹ã¨ã€æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œã€manifestã‚‚æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã®digestã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«commit & pushã•ã‚Œã¾ã™ã€‚
æ¬¡ã®ã‚ˆã†ãªã‚³ãƒŸãƒƒãƒˆã«ãªã‚Šã¾ã™ã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/204442264-ccee00b1-70ac-4f93-a072-08307fc2cfd5.png">

### GitOpsã§pull requestã‚’ä½¿ç”¨ã™ã‚‹

TAP 1.2ã‹ã‚‰ã¯manifestã®å¤‰æ›´ã‚’ç›´æ¥commit & pushã™ã‚‹ä»£ã‚ã‚Šã€pull requestã‚’é€ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/scc-gitops-vs-regops.html#pull-requests-2

`tap-values.yaml`ã®ä»¥ä¸‹ã®è¡Œã‚’è¿½åŠ ã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯`direct`ã§ã™ã€‚

```yaml
# ...
ootb_supply_chain_basic:
  gitops:
    commit_strategy: pull_request  
    pull_request:
      server_kind: github
      commit_branch: ""
      pull_request_title: "ready for review"
      pull_request_body: "generated by supply chain"
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§TAPã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¾ã™ã€‚

```
tanzu package installed update -n tap-install tap -f tap-values.yaml
```

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ã‚’åŠ ãˆã€git pushã™ã‚‹ã¨ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆå¾Œã«æ¬¡ã®ã‚ˆã†ãªPull RequestãŒä½œæˆã•ã‚Œã¾ã™ã€‚

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/204446984-75033d9e-da00-4b17-9256-cb39f283bbc4.png">

<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/204447043-ca6d18ed-fc4e-460a-ae58-b36acd3377db.png">


ã“ã®Pull Requestã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã¨ã€å¤‰æ›´çµæœãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

ç¢ºèªãŒçµ‚ã‚ã‚Œã°Workloadã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```
tanzu apps workload delete -n demo hello -y
```

### KanikoçµŒç”±ã§Dockerfileã‚’ä½¿ã†

TAP 1.2ã‹ã‚‰ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹éš›ã«Cloud Native Buildpacksã§ã¯ãªãã€Dockerfileã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚<br>
å†…éƒ¨çš„ã«ã¯kpackã§ã¯ãªãã€[kaniko](https://github.com/GoogleContainerTools/kaniko)ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚


```
tanzu apps workload apply hello-nodejs \
  --app hello-nodejs \
  --git-repo https://github.com/making/hello-nodejs \
  --git-branch master \
  --param dockerfile=./Dockerfile \
  --type web \
  -n demo \
  -y
stern -n demo hello-nodejs
```

ç¢ºèªãŒçµ‚ã‚ã‚Œã°Workloadã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```
tanzu apps workload delete -n demo hello-nodejs -y
```

---
TAPã‚’ä½¿ã†ã¨CI/CDã®ãƒ•ãƒ­ãƒ¼ã‚’`tanzu apps workload`ã ã‘ã§ä½œæˆã§ãã‚‹ã®ãŒä¾¿åˆ©ã§ã™ã­ã€‚