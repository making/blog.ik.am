---
title: SendGrid x Spring Bootã‚’Pivotal Web Services(Cloud Foundry)ã§è©¦ã™
tags: ["Cloud Foundry", "Pivotal Web Services", "SendGrid", "SMTP", "Spring Boot", "Java"]
categories: ["Service", "PaaS", "CloudFoundry"]
---

[@kikutaro_](https://twitter.com/kikutaro_)ã•ã‚“ãŒSendGriderã«ãªã‚‰ã‚ŒãŸã®ã‚’ç¥ã£ã¦(?)ã€è‡ªåˆ†ã‚‚SendGridã‚’Cloud Foundryã§ä½¿ã£ã¦ã¿ã¾ã™ã€‚

[Pivotal Web Services](https://run.pivotal.io/)ã§ã¯Marketplaceã«[SendGridã‚µãƒ¼ãƒ“ã‚¹](https://docs.run.pivotal.io/marketplace/services/sendgrid.html)ãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€SendGridã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã‚‰ãªãã¦ã‚‚`cf create-service`ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ‰•ã„å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ãŸã ã—ã€æ®‹å¿µãªã“ã¨ã«ç¾çŠ¶Send Gridã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«æƒ…å ±ã¯

* `hostname`
* `username`
* `password`

 ã§ã‚ã‚Šã€API KeyãŒæ¸¡ã£ã¦ã“ãªã„ãŸã‚ã€PWSã®SendGridã‚µãƒ¼ãƒ“ã‚¹ã§ã¯[Web API V2](https://sendgrid.com/docs/Integrate/Code_Examples/v2_Mail/index.html)ã¨[SMTP API](https://sendgrid.com/docs/Integrate/Code_Examples/SMTP_API_Header_Examples/index.html)ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚[Web API V3](https://sendgrid.com/docs/Integrate/Code_Examples/v3_Mail/index.html)ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚
(PWSã®SendGridã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã‚ãšã€æ™®é€šã«API Keyã‚’æ‰•ã„å‡ºã›ã°V3 APIã‚‚ã‚‚ã¡ã‚ã‚“ä½¿ãˆã¾ã™ã€‚)

V2 APIã‚„SMTP APIã§ã‚‚ååˆ†ãªã‚±ãƒ¼ã‚¹ã¯å¤šã„ã®ã¨æ€ã†ã®ã§ã€ãã‚Œãã‚Œã‚’Javaã‚¢ãƒ—ãƒª(ä¸»ã«Spring Boot)ã§ä½¿ã†æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

### [Web API V2](https://sendgrid.com/docs/Integrate/Code_Examples/v2_Mail/index.html)ã‚’ä½¿ã†

ã¾ãšã¯SendGridã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹ã€‚`cf marketplace`ã§`sendgrid`ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ—ãƒ©ãƒ³ã‚’ç¢ºèªã™ã‚‹ã¨ã€`free`ãƒ—ãƒ©ãƒ³ãŒç„¡å„Ÿã§ä½¿ãˆã‚‹ã“ã¨ãŒã‚ã‹ãƒªãƒã™ã€‚

```
$ cf marketplace | grep sendgrid
sendgrid         free, bronze*, silver*                                                               Email Delivery. Simplified.
```

`sendgrid`ã‚µãƒ¼ãƒ“ã‚¹ã®`free`ãƒ—ãƒ©ãƒ³ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’`demo-sendgrid`ã¨ã„ã†åå‰ã§ä½œæˆã—ã¾ã™ã€‚

```
cf create-service sendgrid free demo-sendgrid
```

å¾Œã§ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒã‚¤ãƒ³ãƒ‰ã—ã¾ã™ãŒã€ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ç’°å¢ƒå¤‰æ•°`VCAP_SERVICES`ã®ä¸­ã«

``` json
{
  "sendgrid": [
   {
    "credentials": {
     "hostname": "smtp.sendgrid.net",
     "password": "zqaT47p6zdx30890",
     "username": "e6g8xCyB29"
    },
    "label": "sendgrid",
    "name": "demo-sendgrid",
    "plan": "free",
    "provider": null,
    "syslog_drain_url": null,
    "tags": [
     "iPhone",
     "Web-based",
     "Email",
     "smtp",
     "Analytics",
     "Mac",
     "Developer Tools",
     "Retail",
     "Inventory management",
     "iPad",
     "BI \u0026 Analytics",
     "Email Delivery",
     "Communication"
    ],
    "volume_mounts": []
   }
  ]
 }
```

ã¨ã„ã†JSONå½¢å¼ã§æ¥ç¶šæƒ…å ±ãŒæ¸¡ã‚Šã¾ã™ã€‚ã“ã®JSONã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦`credentials`ã‚’å–ã‚Šã«è¡Œãã®ãŒåŸºæœ¬çš„ãªä½¿ã„æ–¹ã§ã™ã€‚

<iframe src="//www.slideshare.net/slideshow/embed_code/key/zQuFUBNeHbGyHV?startSlide=67" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe> <div style="margin-bottom:5px"> <strong> <a href="//www.slideshare.net/makingx/cloud-foundry-hackt-hacktk" title="ä»Šã™ãå§‹ã‚ã‚‹Cloud Foundry #hackt #hackt_k" target="_blank">ä»Šã™ãå§‹ã‚ã‚‹Cloud Foundry #hackt #hackt_k</a> </strong> from <strong><a target="_blank" href="//www.slideshare.net/makingx">Toshiaki Maki</a></strong> </div>

æ¬¡ã«Spring Bootã®é››å½¢ã‚’ä½œæˆã—ã¾ã™ã€‚

```
$ curl start.spring.io/starter.tgz \
       -d artifactId=hello-sendgrid \
       -d baseDir=hello-sendgrid \
       -d dependencies=web \
       -d applicationName=HelloSendgridApplication | tar -xzvf -
```

`pom.xml`ã«V2 APIç”¨ã®Javaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã—ã¾ã™ã€‚

``` xml
		<dependency>
			<groupId>com.sendgrid</groupId>
			<artifactId>sendgrid-java</artifactId>
			<version>2.2.2</version>
		</dependency>
```

`HelloSendgridApplication`ã‚¯ãƒ©ã‚¹ã«SendGridã‚’ä½¿ã†ã‚³ãƒ¼ãƒ‰ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

``` java
package com.example;

import java.io.IOException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.sendgrid.SendGrid;
import com.sendgrid.SendGridException;

@SpringBootApplication
@RestController
public class HelloSendgridApplication {

	public static void main(String[] args) {
		SpringApplication.run(HelloSendgridApplication.class, args);
	}

	@Autowired
	SendGrid sendGrid;

	@GetMapping
	SendGrid.Response send(@RequestParam String message) throws SendGridException {
		SendGrid.Email email = new SendGrid.Email()
				.addTo("makingx@example.com")
				.setFrom("other@example.com")
				.setSubject("Hello World")
				.setText(message);
		return sendGrid.send(email);
	}

	@Bean
	SendGrid sendGrid(ObjectMapper objectMapper) throws IOException {
		JsonNode credentials = objectMapper
				.readValue(System.getenv("VCAP_SERVICES"), JsonNode.class).get("sendgrid")
				.get(0).get("credentials");
		String username = credentials.get("username").asText();
		String password = credentials.get("password").asText();
		return new SendGrid(username, password);
	}

}
```


ä»Šå›ã¯Cloud Foundryç‹¬è‡ªã®æ–¹æ³•ã‚’ä½¿ã‚ãšã€ç´ ç›´ã«Jacksonã§`VCAP_SERVICES`ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã€`demo-sendgrid`ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®`username`ã¨`password`ã‚’å–å¾—ã—ã¾ã—ãŸã€‚ã“ã®æ–¹æ³•ã¯Spring Bootã ã‘ã§ãªãã©ã®Javaã‚¢ãƒ—ãƒªã§ã‚‚ä½¿ãˆã¾ã™ã€‚


ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã®`manifest.yml`ã‚’ä½œæˆã—ã¾ã™ã€‚

``` yaml
applications:
- name: hello-sendgrid
  memory: 256m
  buildpack: java_buildpack
  path: ./target/hello-sendgrid-0.0.1-SNAPSHOT.jar
  services:
  - demo-sendgrid
```

å¾Œã¯ãƒ“ãƒ«ãƒ‰ã—ã¦`cf push`

```
./mvnw clean package -DskipTests=true
cf push
```

ä½•ã‹é€ã£ã¦ã¿ã¾ã™ã€‚

```
$ curl "https://hello-sendgrid.cfapps.io?message=ğŸ’©" | jq .

{
  "code": 200,
  "message": "{\"message\":\"success\"}",
  "status": true
}
```

ã—ã°ã‚‰ãã™ã‚‹ã¨ãƒ¡ãƒ¼ãƒ«ãŒç„¡äº‹é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚ç°¡å˜ã§ã™ã­ã€‚

![image](https://qiita-image-store.s3.amazonaws.com/0/1852/5afdc77e-29ce-aa5e-c683-810937e2717e.png)

æ¬¡ã«Spring Booté™å®šã®è¨­å®šæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚Spring Bootã§ã¯è‡ªå‹•ã§ç’°å¢ƒå¤‰æ•°`VCAP_SERVICES`ã‚’ãƒ‘ãƒ¼ã‚¹ã—æ¬¡ã®ã‚ˆã†ãªãƒ•ãƒ©ãƒƒãƒˆãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ã—ã¦æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

![image](https://qiita-image-store.s3.amazonaws.com/0/1852/20a0b813-c874-d220-124b-c9d1279d3a79.png)

`demo-sendgrid`ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®`username`ã€`password`ã¯`vcap.services.demo-sendgrid.credentials.username`ã€`vcap.services.demo-sendgrid.credentials.password`ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§å–å¾—å¯èƒ½ã§ã™ã€‚

ã—ãŸãŒã£ã¦ã€`SendGrid`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆã¯æ¬¡ã®ã‚ˆã†ã«ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã¾ã™ã€‚


``` java
package com.example;

import java.io.IOException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.sendgrid.SendGrid;
import com.sendgrid.SendGridException;

@SpringBootApplication
@RestController
public class HelloSendgridApplication {

	public static void main(String[] args) {
		SpringApplication.run(HelloSendgridApplication.class, args);
	}

	@Autowired
	SendGrid sendGrid;

	@GetMapping
	SendGrid.Response send(@RequestParam String message) throws SendGridException {
		SendGrid.Email email = new SendGrid.Email()
				.addTo("makingx@example.com")
				.setFrom("other@example.com")
				.setSubject("Hello World")
				.setText(message);
		return sendGrid.send(email);
	}

	@Bean
	SendGrid sendGrid(
			@Value("${vcap.services.demo-sendgrid.credentials.username}") String username,
			@Value("${vcap.services.demo-sendgrid.credentials.password}") String password)
			throws IOException {
		return new SendGrid(username, password);
	}

}
```

å¾Œã¯ãƒ“ãƒ«ãƒ‰ã—ã¦`cf push`

```
./mvnw clean package -DskipTests=true
cf push
```

### [SMTP API](https://sendgrid.com/docs/Integrate/Code_Examples/SMTP_API_Header_Examples/index.html)ã‚’ä½¿ã†

æ¬¡ã«SMTP APIã‚’ä½¿ã£ã¦ã¿ã¾ã™ã€‚ã“ã®å ´åˆã¯SendGridã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä¸è¦ã§Java Main API(ã‚’ãƒ©ãƒƒãƒ—ã—ãŸSpringã®`MainSender`)ã‚’ä½¿ã„ã¾ã™ã€‚

`com.sendgrid:sendgrid-java:2.2.2`ã®`<dependency>`ã‚’å‰Šé™¤ã—ã¦ã€æ¬¡ã®`<dependency>`ã‚’è¿½åŠ ã—ã¾ã™ã€‚

``` xml
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-mail</artifactId>
		</dependency>
```

`MailSender`ã‚’ä½¿ã†ã‚ˆã†ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

``` java
package com.example;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.mail.MailSender;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@SpringBootApplication
@RestController
public class HelloSendgridApplication {

	public static void main(String[] args) {
		SpringApplication.run(HelloSendgridApplication.class, args);
	}

	@Autowired
	MailSender mailSender;

	@GetMapping
	void send(@RequestParam String message) {
		SimpleMailMessage email = new SimpleMailMessage();
		email.setTo("makingx@example.com");
		email.setFrom("other@example.com");
		email.setSubject("Hello World");
		email.setText(message);
		mailSender.send(email);
	}
}
```

Spring Bootã®SMTP AutoConfigureã‚’ä½¿ã†ã«ã¯æ¬¡ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å®šç¾©ã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

* `spring.mail.host`
* `spring.mail.username`
* `spring.mail.password`

`application-cloud.properties`ã«æ¬¡ã®è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

``` properties
spring.mail.host=${vcap.services.demo-sendgrid.credentials.hostname}
spring.mail.username=${vcap.services.demo-sendgrid.credentials.username}
spring.mail.password=${vcap.services.demo-sendgrid.credentials.password}
```

`VCAP_SERVICES`ã®å€¤ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚Cloud Foundryã«Spring Bootã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨`cloud`ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒé©ç”¨ã•ã‚Œã‚‹ãŸã‚ã€`application-cloud.properties`ã«æ›¸ã„ãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯Cloud Foundryã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸæ™‚ã ã‘æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§è©¦ã™æ™‚ã¯`application.properties`ã«ãƒ­ãƒ¼ã‚«ãƒ«ç”¨ã®è¨­å®šã‚’æ›¸ã„ã¦ãŠã‘ã°ç’°å¢ƒã”ã¨ã®è¨­å®šåˆ‡ã‚Šæ›¿ãˆãŒè‡ªå‹•ã§è¡Œã‚ã‚Œã¦ä¾¿åˆ©ã§ã™ã€‚

``` properties
spring.mail.host=stmp.local
spring.mail.username=test@local
spring.mail.password=test
```

å¾Œã¯ãƒ“ãƒ«ãƒ‰ã—ã¦`cf push`

```
./mvnw clean package -DskipTests=true
cf push
```

#### Spring Cloud Connectorã‚’ä½¿ã†

[Spring Cloud Connector](http://cloud.spring.io/spring-cloud-connectors/)ã‚’åˆ©ç”¨ã™ã‚‹ã¨ç’°å¢ƒå¤‰æ•°VCAP_SERVICESã‹ã‚‰æ¥ç¶šæƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å¿…è¦ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆRDBMSã®å ´åˆã¯`DataSource`ã€Redisã®å ´åˆã¯`RedisConnectionFactory`ï¼‰ã‚’ç’°å¢ƒã«ä¾å­˜ã›ãšã«ç°¡å˜ã«å®šç¾©ã§ãã¾ã™ã€‚[SMTPã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™](http://cloud.spring.io/spring-cloud-connectors/spring-cloud-spring-service-connector.html#_smtp)ã€‚

æ¬¡ã®`<dependency>`ã‚’è¿½åŠ ã—ã¾ã™ã€‚

``` xml
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-spring-service-connector</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-cloudfoundry-connector</artifactId>
		</dependency>
```

`MailSender`ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰æƒ…å ±ã‹ã‚‰è‡ªå‹•ã§ç”Ÿæˆã™ã‚‹å®šç¾©ã‚’`CloudConfig`ã‚¯ãƒ©ã‚¹ã«è¡Œã„ã¾ã™ã€‚

``` java
package com.example;

import org.springframework.cloud.config.java.AbstractCloudConfig;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;
import org.springframework.mail.MailSender;

@Profile("cloud")
@Configuration
public class CloudConfig extends AbstractCloudConfig {
    @Bean
	MailSender mailSender() {
		return connectionFactory().service(MailSender.class);
	}
}
```

`application-cloud.properties`ã¯å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚SMTPã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä¸€ã¤ã—ã‹ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã®æŒ‡å®šã¯ä¸è¦ã§ã™ã€‚
ã¡ãªã¿ã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒSMTPã‹ã©ã†ã‹ã®åˆ¤å®šã¯[`tag`ã«`smtp`ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ç­‰](http://cloud.spring.io/spring-cloud-connectors/spring-cloud-cloud-foundry-connector.html#_smtp)ã§ã™ã€‚

å¾Œã¯ãƒ“ãƒ«ãƒ‰ã—ã¦`cf push`

```
./mvnw clean package -DskipTests=true
cf push
```


### [Web API V3](https://sendgrid.com/docs/Integrate/Code_Examples/v3_Mail/index.html)ã‚’ä½¿ã†

æŠ˜è§’ãªã®ã§V3 APIã‚’ä½¿ã†æ–¹æ³•ã‚‚ç´¹ä»‹ã—ã¾ã™ã€‚ã“ã¡ã‚‰ã¯API KeyãŒå¿…è¦ãªã®ã§ã€ã‚‚ã¯ã‚„PWSã®SendGridã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ä¸è¦ã§ã™ã€‚
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚“ã‹ã‚‰ã‚¢ãƒ³ãƒã‚¤ãƒ³ãƒ‰ã—ã¾ã™ã€‚

```
cf unbind-service hello-sendgrid demo-sendgrid
```

`spring-boot-starter-mail`ã‚„`spring-cloud-*-connector`ã®`<dependency>`ã‚‚ä¸è¦ã§ã€ä»£ã‚ã‚Šã«V3 APIç”¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã—ã¾ã™ã€‚


``` xml
		<dependency>
			<groupId>com.sendgrid</groupId>
			<artifactId>sendgrid-java</artifactId>
			<version>3.1.0</version>
		</dependency>
```

V3 APIç”¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã‚ˆã†ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿®æ­£ã—ã¾ã™ã€‚API Keyã¯ç’°å¢ƒå¤‰æ•°`SENDGRID_API_KEY`ã«æ¸¡ã™ã“ã¨ã«ã—ã¾ã™ã€‚

``` java
package com.example;

import java.io.IOException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.sendgrid.*;

@SpringBootApplication
@RestController
public class HelloSendgridApplication {

	public static void main(String[] args) {
		SpringApplication.run(HelloSendgridApplication.class, args);
	}

	@Autowired
	SendGrid sendGrid;

	@GetMapping
	Response send(@RequestParam String message) throws IOException {
		Email from = new Email("other@example.com");
		String subject = "Hello World";
		Email to = new Email("makingx@example.com");
		Content content = new Content("text/plain", message);
		Mail mail = new Mail(from, subject, to, content);
		Request request = new Request();
		request.method = Method.POST;
		request.endpoint = "mail/send";
		request.body = mail.build();
		return sendGrid.api(request);
	}

	@Bean
	SendGrid sendGrid() {
		return new SendGrid(System.getenv("SENDGRID_API_KEY"));
	}
}
```

API Keyã¯[å…¬å¼ã‚µã‚¤ãƒˆ](https://sendgrid.com/)ã‹[ä»£ç†åº—ã‚µã‚¤ãƒˆ](https://sendgrid.kke.co.jp/)ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦å–å¾—ã—ã¦ãã ã•ã„ã€‚

`manifest.yml`ã‚’æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

``` yaml
applications:
- name: hello-sendgrid
  memory: 256m
  buildpack: java_buildpack
  path: ./target/hello-sendgrid-0.0.1-SNAPSHOT.jar
  env:
    SENDGRID_API_KEY: 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
```

å¾Œã¯ãƒ“ãƒ«ãƒ‰ã—ã¦`cf push`

```
./mvnw clean package -DskipTests=true
cf push
```

---

â˜ï¸ã®ã‚¢ãƒ—ãƒªã‚’ãƒ™ãƒ¼ã‚¹ã«SendGridã§è‰²ã€…éŠã‚“ã§ã¿ã¦ãã ã•ã„ã€‚

ã¾ãŸã€Cloud Foundryã‚’ã‚‚ã†å°‘ã—è§¦ã‚ŠãŸããªã£ãŸã‚‰[Workshopè³‡æ–™](https://github.com/Pivotal-Japan/cf-workshop)ã‚’è¦‹ã¦è‰²ã€…è©¦ã—ã¦ãã ã•ã„ã€‚
æ‹™è‘—ã€Œ[ã¯ã˜ã‚ã¦ã®Spring Boot [æ”¹è¨‚ç‰ˆ] ](http://bit.ly/hajiboot2)ã€ã®4ç« ã§ã‚‚å­¦ã¹ã¾ã™ã€‚

<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4777519694/ikam-22/ref=nosim/" name="amazletlink" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51MBlgJ0pTL._SL160_.jpg" alt="ã¯ã˜ã‚ã¦ã®Spring Bootâ€•ã‚¹ãƒ—ãƒªãƒ³ã‚°ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ç°¡å˜Javaã‚¢ãƒ—ãƒªé–‹ç™º (Iãƒ»O BOOKS)" style="border: none;" /></a>
